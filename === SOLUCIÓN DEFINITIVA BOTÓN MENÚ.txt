// === SOLUCI√ìN DEFINITIVA BOT√ìN MEN√ö - PEGAR AL FINAL DEL ARCHIVO ===
function replaceMenuButtonCode() {
    console.group('üéØ REEMPLAZANDO C√ìDIGO DEL BOT√ìN MEN√ö');
    
    // Buscar y eliminar cualquier c√≥digo existente del bot√≥n men√∫
    const menuBtn = document.getElementById('toggleSidebarBtn');
    if (!menuBtn) {
        console.error('‚ùå Bot√≥n men√∫ no encontrado');
        return;
    }
    
    // Reemplazar completamente el bot√≥n
    const newMenuBtn = document.createElement('button');
    newMenuBtn.id = 'toggleSidebarBtn';
    newMenuBtn.className = 'blue-btn';
    newMenuBtn.innerHTML = '‚ò∞ Men√∫';
    newMenuBtn.title = 'Mostrar/Ocultar men√∫ lateral';
    
    // Reemplazar en el DOM
    menuBtn.parentNode.replaceChild(newMenuBtn, menuBtn);
    
    // CONEXI√ìN INDESTRUCTIBLE
    const finalMenuBtn = document.getElementById('toggleSidebarBtn');
    const sidebar = document.querySelector('aside');
    
    // Listener principal con m√∫ltiples protecciones
    finalMenuBtn.addEventListener('click', function menuClickHandler() {
        console.log('üéØ Bot√≥n men√∫ clickeado - Versi√≥n indestructible');
        
        if (!sidebar) {
            console.error('‚ùå Sidebar no encontrado');
            return;
        }
        
        // 1. Alternar visibilidad
        const isHidden = sidebar.classList.contains('hidden');
        sidebar.classList.toggle('hidden');
        console.log(`üìã Sidebar ${isHidden ? 'mostrado' : 'ocultado'}`);
        
        // 2. Sincronizar elementos dependientes
        setTimeout(() => {
            // Sincronizar l√≠neas
            if (typeof syncLinesWithSidebar === 'function') {
                syncLinesWithSidebar();
            }
            
            // Re-renderizar Gantt si es necesario
            if (!ganttView.classList.contains('hidden') && typeof renderGanttChart === 'function') {
                const ganttTasks = projects[currentProjectIndex]?.tasks || [];
                renderGanttChart(ganttTasks);
            }
            
            // Forzar reflow para asegurar actualizaci√≥n
            sidebar.offsetHeight;
        }, 150);
        
        // 3. Verificar que el listener sigue activo
        setTimeout(() => {
            const currentListeners = getEventListeners(finalMenuBtn)?.click?.length || 0;
            if (currentListeners === 0) {
                console.warn('‚ö†Ô∏è Listener perdido, reconectando...');
                finalMenuBtn.addEventListener('click', menuClickHandler);
            }
        }, 500);
    });
    
    // PROTECCI√ìN EXTRA - Reconexi√≥n autom√°tica
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                // Si el bot√≥n cambia, reconectar
                setTimeout(() => {
                    if (!getEventListeners(finalMenuBtn)?.click?.length) {
                        console.log('üîÑ Reconectando bot√≥n men√∫ despu√©s de cambio...');
                        finalMenuBtn.addEventListener('click', menuClickHandler);
                    }
                }, 100);
            }
        });
    });
    
    observer.observe(finalMenuBtn, { attributes: true });
    
    console.log('‚úÖ Bot√≥n men√∫ reemplazado con protecci√≥n m√°xima');
    console.log('   - Listener principal conectado');
    console.log('   - Observer de cambios activado');
    console.log('   - Autoreparaci√≥n configurada');
    console.groupEnd();
}

// === EJECUCI√ìN AUTOM√ÅTICA AL CARGAR ===
document.addEventListener('DOMContentLoaded', function() {
    // Esperar a que todo cargue y luego activar el bot√≥n men√∫
    setTimeout(() => {
        console.log('üöÄ Activando bot√≥n men√∫ indestructible...');
        replaceMenuButtonCode();
    }, 2000);
});

// === TAMBI√âN ACTIVAR DESPU√âS DE CIERTOS EVENTOS ===
// Activar despu√©s de cambios importantes en la interfaz
['load', 'resize', 'popstate'].forEach(event => {
    window.addEventListener(event, function() {
        setTimeout(replaceMenuButtonCode, 1000);
    });
});

// Funci√≥n global para reactivar manualmente si es necesario
window.fixMenuButton = function() {
    console.log('üîß Reactivando bot√≥n men√∫ manualmente...');
    replaceMenuButtonCode();
};

// Tambi√©n puedes llamarlo desde consola en cualquier momento: fixMenuButton()