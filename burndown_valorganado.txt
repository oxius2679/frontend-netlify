// ========== GANTT EJECUTIVO COMPLETO CON TODAS LAS MEJORAS ==========
function createPremiumGanttWithYourData() {
  console.log('ğŸš€ Creando Gantt ejecutivo premium completo...');
  
  if (typeof projects === 'undefined' || !projects || projects.length === 0) {
    alert('âŒ No hay proyectos cargados. Primero crea o importa proyectos.');
    createSampleProjects();
    return;
  }
  
  createProjectSelector();
}

// ========== SELECTOR DE PROYECTOS ==========
function createProjectSelector() {
  const selectorContainer = document.createElement('div');
  selectorContainer.id = 'projectSelectorOverlay';
  selectorContainer.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 500px;
    background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
    border-radius: 24px;
    padding: 30px;
    z-index: 1000000;
    box-shadow: 0 30px 60px rgba(0,0,0,0.6);
    border: 1px solid rgba(52, 152, 219, 0.4);
    color: white;
  `;
  
  selectorContainer.innerHTML = `
    <div style="text-align: center; margin-bottom: 25px;">
      <div style="font-size: 28px; color: #2ecc71; margin-bottom: 10px;">ğŸ“Š</div>
      <h2 style="margin: 0 0 10px 0; color: white;">Seleccionar Proyecto</h2>
      <p style="color: #95a5a6; margin: 0;">Elige un proyecto para visualizar en el Gantt</p>
    </div>
    
    <div id="projectListContainer" style="
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 25px;
    ">
      ${projects.map((project, index) => `
        <div class="project-option" data-index="${index}" style="
          background: ${index === currentProjectIndex ? 'rgba(52, 152, 219, 0.2)' : 'rgba(255,255,255,0.05)'};
          border: 1px solid ${index === currentProjectIndex ? '#3498db' : 'rgba(255,255,255,0.1)'};
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 10px;
          cursor: pointer;
          transition: all 0.3s;
        ">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: bold; margin-bottom: 5px; font-size: 16px;">${project.name}</div>
              <div style="color: #95a5a6; font-size: 13px;">
                ${project.tasks ? project.tasks.length : 0} tareas â€¢ 
                ${getProjectProgress(project)}% completado
              </div>
            </div>
            <div style="
              width: 24px;
              height: 24px;
              border-radius: 50%;
              background: ${index === currentProjectIndex ? '#3498db' : 'rgba(255,255,255,0.1)'};
              display: flex;
              align-items: center;
              justify-content: center;
              color: ${index === currentProjectIndex ? 'white' : 'transparent'};
            ">
              âœ“
            </div>
          </div>
        </div>
      `).join('')}
    </div>
    
    <div style="display: flex; gap: 15px; justify-content: center;">
      <button onclick="closeProjectSelector()" style="
        padding: 12px 25px;
        background: rgba(231, 76, 60, 0.2);
        border: 1px solid #e74c3c;
        color: #e74c3c;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
      ">
        Cancelar
      </button>
      <button onclick="createGanttWithSelectedProject()" id="continueBtn" style="
        padding: 12px 25px;
        background: linear-gradient(45deg, #2ecc71, #27ae60);
        border: none;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        flex: 1;
      ">
        Continuar al Gantt
      </button>
    </div>
  `;
  
  document.body.appendChild(selectorContainer);
  
  document.querySelectorAll('.project-option').forEach(option => {
    option.addEventListener('click', function() {
      currentProjectIndex = parseInt(this.getAttribute('data-index'));
      updateProjectSelector();
    });
  });
}

function closeProjectSelector() {
  const selector = document.getElementById('projectSelectorOverlay');
  if (selector) selector.remove();
}

function createGanttWithSelectedProject() {
  closeProjectSelector();
  createCompleteGanttForCurrentProject();
}

// ========== GANTT COMPLETO CON MENÃš LATERAL ==========
function createCompleteGanttForCurrentProject() {
  if (currentProjectIndex >= projects.length) {
    alert('âŒ Proyecto no vÃ¡lido');
    return;
  }
  
  const yourProject = projects[currentProjectIndex];
  const yourTasks = yourProject.tasks || [];
  
  console.log('ğŸ“‚ Cargando proyecto:', yourProject.name);
  console.log('ğŸ“‹ Tareas del proyecto:', yourTasks);
  
  // TRANSFORMAR DATOS CON FECHA REAL - CORREGIDO EL DÃA DE HOY
  const executiveTasks = yourTasks.map((task, index) => {
    let startDay = 0;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (task.startDate) {
      try {
        const startDate = new Date(task.startDate);
        startDate.setHours(0, 0, 0, 0);
        startDay = Math.floor((startDate - today) / (1000 * 60 * 60 * 24));
      } catch (e) {
        startDay = index * 2;
      }
    } else {
      startDay = index * 2;
    }
    
    let duration = 3;
    if (task.startDate && task.deadline) {
      try {
        const start = new Date(task.startDate);
        const end = new Date(task.deadline);
        duration = Math.max(1, Math.floor((end - start) / (1000 * 60 * 60 * 24)));
      } catch (e) {
        duration = task.estimatedTime ? Math.max(1, Math.ceil(task.estimatedTime / 8)) : 3;
      }
    } else if (task.estimatedTime) {
      duration = Math.max(1, Math.ceil(task.estimatedTime / 8));
    }
    
    const statusColors = {
      'pending': '#f1c40f',
      'inProgress': '#008090', 
      'completed': '#2ecc71',
      'overdue': '#e74c3c'
    };
    
    let progress = 0;
    if (task.status === 'completed') progress = 100;
    else if (task.timeLogged && task.estimatedTime) {
      progress = Math.min(100, Math.round((task.timeLogged / task.estimatedTime) * 100));
    } else if (task.status === 'inProgress') progress = 50;
    
    const dependencies = task.dependencies || [];
    const isCritical = task.priority === 'alta' || task.status === 'overdue';
    
    // Asegurar que siempre haya un color
    const taskColor = statusColors[task.status] || '#95a5a6';
    
    return {
      id: task.id || Date.now() + index,
      name: task.name || `Tarea ${index + 1}`,
      progress: progress,
      duration: duration,
      startDay: Math.max(0, startDay),
      color: taskColor,
      critical: isCritical,
      dependencies: dependencies,
      team: task.assignee ? [task.assignee] : ['Sin asignar'],
      status: task.status || 'pending',
      priority: task.priority || 'media',
      estimatedTime: task.estimatedTime || 0,
      timeLogged: task.timeLogged || 0,
      originalTask: task,
      budget: task.estimatedTime ? `$${(task.estimatedTime * 50).toLocaleString()}` : 'No estimado'
    };
  });
  
  // CALCULAR KPIs
  const totalTasks = yourTasks.length;
  const completedTasks = executiveTasks.filter(t => t.status === 'completed').length;
  const criticalTasks = executiveTasks.filter(t => t.critical).length;
  const tasksWithDeps = executiveTasks.filter(t => t.dependencies.length > 0).length;
  const avgProgress = executiveTasks.length > 0 
    ? Math.round(executiveTasks.reduce((sum, t) => sum + t.progress, 0) / executiveTasks.length)
    : 0;
  
  // FECHA ACTUAL REAL
  const today = new Date();
  const todayFormatted = today.toLocaleDateString('es-ES', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
  
  const container = document.createElement('div');
  container.id = 'premiumExecutiveGantt';
  container.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 95vw;
    height: 90vh;
    background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
    border-radius: 24px;
    box-shadow: 0 30px 60px rgba(0,0,0,0.6);
    border: 1px solid rgba(52, 152, 219, 0.4);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    z-index: 999999;
  `;
  
  container.innerHTML = `
    <!-- HEADER CON TODOS LOS BOTONES ACTIVOS -->
    <div style="
      background: linear-gradient(90deg, #0a0a1a, #1a1a3a);
      padding: 25px 35px;
      border-bottom: 1px solid rgba(52, 152, 219, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    ">
      <div style="flex: 1;">
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 8px;">
          <div style="
            background: linear-gradient(45deg, #3498db, #2ecc71);
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
          ">
            ğŸ“Š
          </div>
          <div style="flex: 1;">
            <h2 style="margin: 0; color: white; font-size: 28px; font-weight: 300;">
              <span style="font-weight: 700; color: #2ecc71;">${yourProject.name}</span>
              <span style="color: #95a5a6; font-size: 20px; margin-left: 10px;">- GANTT EXECUTIVE</span>
            </h2>
            <p style="margin: 5px 0 0 0; color: #95a5a6; font-size: 14px;">
              <span style="color: #3498db;">ğŸ“… ${todayFormatted}</span> â€¢ 
              ğŸ”¥ ${criticalTasks} crÃ­ticas â€¢ ğŸ”— ${tasksWithDeps} dependencias â€¢ ğŸ“Š ${avgProgress}% progreso
            </p>
          </div>
        </div>
      </div>
      
      <!-- TODOS LOS BOTONES ACTIVOS -->
      <div style="display: flex; gap: 12px;">
        <button onclick="toggleMobileViewPremium()" class="premium-btn active-btn" style="
          background: linear-gradient(45deg, #9b59b6, #8e44ad);
          border: none;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          font-weight: bold;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.3s;
          font-size: 14px;
        ">
          ğŸ“± Mobile
        </button>
        
        <button onclick="showBurnDownChartPremium()" class="premium-btn active-btn" style="
          background: linear-gradient(45deg, #f39c12, #d35400);
          border: none;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          font-weight: bold;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.3s;
          font-size: 14px;
        ">
          ğŸ“‰ Burndown
        </button>
        
        <button onclick="showAIPredictorPremium()" class="premium-btn active-btn" style="
          background: linear-gradient(45deg, #3498db, #2980b9);
          border: none;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          font-weight: bold;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.3s;
          font-size: 14px;
        ">
          ğŸ¤– IA Predictor
        </button>
        
        <button onclick="switchProjectPremium()" class="premium-btn active-btn" style="
          background: linear-gradient(45deg, #1abc9c, #16a085);
          border: none;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          font-weight: bold;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.3s;
          font-size: 14px;
        ">
          ğŸ”„ Cambiar Proyecto
        </button>
        
        <button onclick="exportGanttData()" class="premium-btn active-btn" style="
          background: linear-gradient(45deg, #e74c3c, #c0392b);
          border: none;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          font-weight: bold;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.3s;
          font-size: 14px;
        ">
          ğŸ“¤ Exportar
        </button>
        
        <button onclick="this.closest('#premiumExecutiveGantt').remove()" style="
          background: rgba(231, 76, 60, 0.2);
          border: 1px solid #e74c3c;
          color: #e74c3c;
          padding: 12px 20px;
          border-radius: 8px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s;
          font-size: 14px;
        ">
          Ã— Cerrar
        </button>
      </div>
    </div>
    
    <!-- CONTENT CON MENÃš LATERAL COMPLETO Y COLUMNA FIJA -->
    <div style="flex: 1; display: flex; overflow: hidden;">
      <!-- SIDEBAR COMPLETO CON TODAS LAS FUNCIONALIDADES -->
      <div style="
        width: 320px;
        background: linear-gradient(180deg, #0a0a1a, #121230);
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        padding: 25px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 25px;
        flex-shrink: 0;
      ">
        <!-- KPIs -->
        <div>
          <h3 style="color: white; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
            <span style="color: #3498db; font-size: 20px;">ğŸ“Š</span> 
            <span>Dashboard Ejecutivo</span>
          </h3>
          
          <div class="kpi-card" style="
            background: rgba(255,255,255,0.05); 
            border-radius: 12px; 
            padding: 20px; 
            margin-bottom: 20px;
            transition: all 0.3s;
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <div style="color: #95a5a6; font-size: 14px;">Progreso General</div>
              <div style="color: #2ecc71; font-size: 24px; font-weight: bold;">${avgProgress}%</div>
            </div>
            <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
              <div style="width: ${avgProgress}%; height: 100%; background: linear-gradient(90deg, #3498db, #2ecc71); border-radius: 4px;"></div>
            </div>
          </div>
          
          <!-- DEPENDENCIAS DETALLADAS (NUEVA SECCIÃ“N) -->
          <div class="kpi-card" style="
            background: rgba(155, 89, 182, 0.1); 
            border: 1px solid rgba(155, 89, 182, 0.3); 
            border-radius: 12px; 
            padding: 18px; 
            margin-bottom: 20px;
            transition: all 0.3s;
          ">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
              <span style="color: #9b59b6; font-size: 18px;">ğŸ”—</span>
              <span style="color: white; font-weight: bold;">Dependencias</span>
            </div>
            <div style="color: #9b59b6; font-size: 12px; margin-bottom: 10px;">
              ${tasksWithDeps} tareas con dependencias
            </div>
            ${generateDependenciesList(executiveTasks)}
          </div>
          
          <!-- RUTA CRÃTICA -->
          <div class="kpi-card" style="
            background: rgba(231, 76, 60, 0.1); 
            border: 1px solid rgba(231, 76, 60, 0.3); 
            border-radius: 12px; 
            padding: 18px; 
            margin-bottom: 20px;
            transition: all 0.3s;
          ">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
              <span style="color: #e74c3c; font-size: 18px;">ğŸ”¥</span>
              <span style="color: white; font-weight: bold;">Ruta CrÃ­tica</span>
            </div>
            <div style="color: #e74c3c; font-size: 12px; margin-bottom: 10px;">
              ${criticalTasks} tareas crÃ­ticas identificadas
            </div>
            <div style="color: #95a5a6; font-size: 11px;">
              ${getCriticalTasksDetails(executiveTasks)}
            </div>
          </div>
          
          <!-- PREDICTOR IA -->
          <div class="kpi-card" style="
            background: rgba(52, 152, 219, 0.1); 
            border-radius: 12px; 
            padding: 20px;
            transition: all 0.3s;
          ">
            <div style="color: white; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
              <span style="color: #3498db;">ğŸ¤–</span> IA Predictor
            </div>
            <div style="color: #95a5a6; font-size: 13px; margin-bottom: 15px;">
              PredicciÃ³n basada en ${totalTasks} tareas
            </div>
            <div style="
              background: rgba(255,255,255,0.1);
              border-radius: 8px;
              padding: 15px;
              text-align: center;
              margin-bottom: 15px;
            ">
              <div style="color: #2ecc71; font-size: 20px; font-weight: bold;">${calculatePredictedEndDatePremium(executiveTasks)}</div>
              <div style="color: #95a5a6; font-size: 12px; margin-top: 5px;">
                Fecha estimada finalizaciÃ³n
              </div>
            </div>
            <button onclick="runAIAnalysisPremium()" class="premium-btn" style="
              width: 100%;
              background: linear-gradient(45deg, #3498db, #2980b9);
              border: none;
              color: white;
              padding: 12px;
              border-radius: 8px;
              font-weight: bold;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 10px;
              transition: all 0.3s;
            ">
              ğŸ”„ Ejecutar AnÃ¡lisis Predictivo
            </button>
          </div>
          
          <!-- RESOURCE ALLOCATION -->
          <div class="kpi-card" style="
            background: rgba(46, 204, 113, 0.1); 
            border-radius: 12px; 
            padding: 20px;
            margin-top: 20px;
            transition: all 0.3s;
          ">
            <div style="color: white; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
              <span style="color: #2ecc71;">ğŸ‘¥</span> DistribuciÃ³n de Equipo
            </div>
            <div style="color: #95a5a6; font-size: 13px; margin-bottom: 15px;">
              ${countTeamMembers(executiveTasks)} miembros asignados
            </div>
            ${generateTeamDistribution(executiveTasks)}
          </div>
        </div>
        
        <!-- FILTROS EJECUTIVOS -->
        <div>
          <h3 style="color: white; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
            <span style="color: #f1c40f; font-size: 20px;">âš¡</span> 
            <span>Filtros Ejecutivos</span>
          </h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
            <button onclick="filterCriticalTasksPremium()" class="premium-btn" style="
              background: rgba(231, 76, 60, 0.15);
              border: 1px solid #e74c3c;
              color: #e74c3c;
              padding: 12px;
              border-radius: 8px;
              cursor: pointer;
              transition: all 0.3s;
              font-size: 13px;
              display: flex;
              align-items: center;
              gap: 8px;
              justify-content: center;
            ">
              ğŸ”´ CrÃ­ticas
            </button>
            <button onclick="filterDelayedTasksPremium()" class="premium-btn" style="
              background: rgba(243, 156, 18, 0.15);
              border: 1px solid #f39c12;
              color: #f39c12;
              padding: 12px;
              border-radius: 8px;
              cursor: pointer;
              transition: all 0.3s;
              font-size: 13px;
              display: flex;
              align-items: center;
              gap: 8px;
              justify-content: center;
            ">
              âš¡ Atrasadas
            </button>
            <button onclick="filterByTeamPremium()" class="premium-btn" style="
              background: rgba(155, 89, 182, 0.15);
              border: 1px solid #9b59b6;
              color: #9b59b6;
              padding: 12px;
              border-radius: 8px;
              cursor: pointer;
              transition: all 0.3s;
              font-size: 13px;
              display: flex;
              align-items: center;
              gap: 8px;
              justify-content: center;
            ">
              ğŸ‘¥ Por Equipo
            </button>
            <button onclick="filterByBudgetPremium()" class="premium-btn" style="
              background: rgba(46, 204, 113, 0.15);
              border: 1px solid #2ecc71;
              color: #2ecc71;
              padding: 12px;
              border-radius: 8px;
              cursor: pointer;
              transition: all 0.3s;
              font-size: 13px;
              display: flex;
              align-items: center;
              gap: 8px;
              justify-content: center;
            ">
              ğŸ’° Presupuesto
            </button>
            <button onclick="showAllTasksPremium()" class="premium-btn" style="
              background: rgba(52, 152, 219, 0.15);
              border: 1px solid #3498db;
              color: #3498db;
              padding: 12px;
              border-radius: 8px;
              cursor: pointer;
              transition: all 0.3s;
              font-size: 13px;
              display: flex;
              align-items: center;
              gap: 8px;
              justify-content: center;
              grid-column: span 2;
            ">
              ğŸ“‹ Mostrar Todas
            </button>
          </div>
        </div>
        
        <!-- GESTIÃ“N DE DEPENDENCIAS (NUEVA SECCIÃ“N) -->
        <div>
          <h3 style="color: white; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
            <span style="color: #1abc9c; font-size: 20px;">ğŸ”§</span> 
            <span>GestiÃ³n de Dependencias</span>
          </h3>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <button onclick="openDependencyCreator()" class="premium-btn" style="
              background: linear-gradient(45deg, #9b59b6, #8e44ad);
              border: none;
              color: white;
              padding: 12px;
              border-radius: 8px;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 10px;
              justify-content: center;
              font-weight: bold;
            ">
              ğŸ”— Crear Dependencias
            </button>
            <button onclick="markAsCriticalPath()" class="premium-btn" style="
              background: linear-gradient(45deg, #e74c3c, #c0392b);
              border: none;
              color: white;
              padding: 12px;
              border-radius: 8px;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 10px;
              justify-content: center;
              font-weight: bold;
            ">
              ğŸ”¥ Marcar Ruta CrÃ­tica
            </button>
            <button onclick="clearAllDependencies()" class="premium-btn" style="
              background: linear-gradient(45deg, #95a5a6, #7f8c8d);
              border: none;
              color: white;
              padding: 12px;
              border-radius: 8px;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 10px;
              justify-content: center;
              font-weight: bold;
            ">
              ğŸ—‘ï¸ Limpiar Todas
            </button>
          </div>
        </div>
      </div>
      
      <!-- MAIN AREA CON SCROLL HORIZONTAL SOLO EN LAS FECHAS -->
      <div style="
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: linear-gradient(180deg, rgba(10, 10, 26, 0.9), rgba(18, 18, 48, 0.95));
      ">
        <!-- TIMELINE HEADER FIJA CON SCROLL HORIZONTAL -->
        <div style="
          display: flex;
          background: rgba(255, 255, 255, 0.05);
          border-radius: 12px 12px 0 0;
          padding: 18px 0 18px 320px;
          position: relative;
          overflow-x: auto;
          overflow-y: hidden;
          flex-shrink: 0;
          margin: 0;
        ">
          <!-- COLUMNA FIJA DE TÃTULO (OCULTA PERO MANTIENE ESPACIO) -->
          <div style="
            width: 320px;
            padding: 10px 20px;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px 0 0 0;
          ">
            <span style="color: #3498db;">ğŸ“…</span> TIMELINE
          </div>
          
          <!-- FECHAS CON SCROLL -->
          <div style="display: flex; min-width: max-content;">
            ${Array.from({length: 31}, (_, i) => {
              const date = new Date(today);
              date.setDate(today.getDate() + i);
              const dayOfWeek = date.getDay();
              const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
              const isToday = i === 0;
              const isWeekStart = i % 7 === 0;
              
              return `
                <div style="
                  flex: 0 0 45px;
                  text-align: center;
                  padding: 12px 5px;
                  border-right: 1px solid rgba(255,255,255,0.1);
                  color: ${isWeekend ? '#7f8c8d' : 'white'};
                  font-weight: ${isWeekStart ? 'bold' : 'normal'};
                  position: relative;
                  min-width: 45px;
                ">
                  ${isWeekStart ? `<div style="position: absolute; top: -18px; left: 0; right: 0; color: #3498db; font-size: 11px;">Sem ${Math.floor(i/7) + 1}</div>` : ''}
                  ${isToday ? `<div style="position: absolute; top: -25px; left: 0; right: 0; background: #2ecc71; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; z-index: 100;">HOY</div>` : ''}
                  <div style="font-size: 11px; color: ${isWeekend ? '#7f8c8d' : '#95a5a6'}; margin-bottom: 5px;">
                    ${date.toLocaleDateString('es-ES', { weekday: 'short' })}
                  </div>
                  <div style="font-size: 16px; color: ${isToday ? '#2ecc71' : (isWeekend ? '#7f8c8d' : 'white')};">
                    ${date.getDate()}
                  </div>
                  ${date.getDate() === 1 ? `<div style="position: absolute; top: -18px; left: 0; right: 0; color: #3498db; font-size: 11px;">${date.toLocaleDateString('es-ES', { month: 'short' })}</div>` : ''}
                </div>
              `;
            }).join('')}
          </div>
        </div>
        
        <!-- TASKS CONTAINER CON SCROLL HORIZONTAL SOLO EN BARRAS -->
        <div id="premiumTasksContainer" style="
          flex: 1;
          position: relative;
          overflow-x: auto;
          overflow-y: auto;
          padding-right: 0;
        ">
          <div style="position: relative; min-width: max-content; min-height: 100%;">
            ${executiveTasks.map((task, index) => `
              <!-- TAREA CON COLUMNA FIJA Y BARRAS CON SCROLL -->
              <div class="premium-task" data-task-id="${task.id}" style="



                display: flex;
                align-items: center;
                margin-bottom: 20px;
                padding: 20px 0 20px 320px;
                background: ${task.critical ? 'rgba(231, 76, 60, 0.1)' : 'rgba(255, 255, 255, 0.03)'};
                border-radius: 12px;
                transition: all 0.3s;
                border-left: 4px solid ${task.color};
                position: relative;
                overflow: visible;
                height: 60px;
                border: ${task.critical ? '1px solid rgba(231, 76, 60, 0.3)' : '1px solid rgba(255, 255, 255, 0.05)'};
                cursor: pointer;
                min-width: max-content;
              " onclick="showPremiumTaskDetails('${task.id}')">
                
                <!-- COLUMNA FIJA CON INFORMACIÃ“N DE TAREA -->
                <div style="
                  width: 320px;
                  padding: 0 20px;
                  position: absolute;
                  left: 0;
                  top: 0;
                  bottom: 0;
                  display: flex;
                  align-items: center;
                  background: ${task.critical ? 'rgba(231, 76, 60, 0.05)' : 'transparent'};
                  border-radius: 12px 0 0 12px;
                ">
                  <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                    <div style="
                      width: 36px;
                      height: 36px;
                      background: ${task.color};
                      border-radius: 10px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      color: white;
                      font-weight: bold;
                      box-shadow: 0 5px 15px ${task.color}40;
                      flex-shrink: 0;
                    ">
                      ${index + 1}
                    </div>


                    <div style="flex: 1; min-width: 0;">
                      <div style="color: white; font-weight: bold; font-size: 15px; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; overflow: hidden; text-overflow: ellipsis;">
                        ${task.name}
                        ${task.critical ? '<span style="color: #e74c3c; font-size: 12px; background: rgba(231, 76, 60, 0.2); padding: 2px 8px; border-radius: 10px; flex-shrink: 0;">CRÃTICA</span>' : ''}
                      </div>
                      <div style="color: #95a5a6; font-size: 12px; display: flex; gap: 15px; overflow: hidden;">
                        <span style="flex-shrink: 0;">ğŸ‘¤ ${task.team[0]}</span>
                        <span style="flex-shrink: 0;">ğŸ’° ${task.budget}</span>
                        ${task.dependencies.length > 0 ? `<span style="flex-shrink: 0;">ğŸ”— ${task.dependencies.length} dep</span>` : ''}
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- ÃREA DE BARRAS GANTT CON SCROLL HORIZONTAL -->
                <div style="
                  flex: 1;
                  height: 40px;
                  position: relative;
                  min-width: ${31 * 45}px;
                ">
                  <!-- BACKGROUND -->
                  <div style="
                    position: absolute;
                    left: 0;
                    right: 0;
                    height: 100%;
                    background: rgba(255,255,255,0.03);
                    border-radius: 8px;
                  "></div>
                  
                  <!-- MAIN BAR -->
                  <div style="
                    position: absolute;
                    left: ${task.startDay * 45}px;
                    width: ${task.duration * 45}px;
                    height: 100%;
                    background: linear-gradient(90deg, ${task.color}99, ${task.color});
                    border-radius: 8px;
                    box-shadow: 
                      0 4px 20px ${task.color}40,
                      inset 0 2px 4px rgba(255,255,255,0.2);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: bold;
                    font-size: 13px;
                    z-index: 10;
                  ">
                    <!-- PROGRESS OVERLAY -->
                    <div style="
                      position: absolute;
                      top: 0;
                      left: 0;
                      width: ${task.progress}%;
                      height: 100%;
                      background: linear-gradient(90deg, rgba(255,255,255,0.3), transparent);
                      border-radius: 8px;
                    "></div>
                    <div style="position: relative; z-index: 2;">
                      ${task.duration}d â€¢ ${task.progress}%
                    </div>
                  </div>
                  
                  <!-- TODAY MARKER CORREGIDO (dÃ­a 0) -->
                  <div style="
                    position: absolute;
                    left: ${0 * 45}px;
                    top: -10px;
                    bottom: -10px;
                    width: 2px;
                    background: #2ecc71;
                    z-index: 5;
                  ">
                    <div style="
                      position: absolute;
                      top: -20px;
                      left: -8px;
                      background: #2ecc71;
                      color: white;
                      padding: 2px 8px;
                      border-radius: 4px;
                      font-size: 10px;
                      font-weight: bold;
                    ">
                      HOY
                    </div>
                  </div>
                </div>
                
                <!-- ACCIONES (COLUMNA FIJA DERECHA) -->
                <div style="
                  margin-left: 20px;
                  display: flex;
                  gap: 8px;
                  position: absolute;
                  right: 20px;
                  top: 50%;
                  transform: translateY(-50%);
                  z-index: 20;
                ">
                  <button onclick="event.stopPropagation(); updatePremiumTaskProgress('${task.id}')" style="
                    width: 40px;
                    height: 40px;
                    border-radius: 10px;
                    background: rgba(46, 204, 113, 0.2);
                    border: 1px solid #2ecc71;
                    color: #2ecc71;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.3s;
                    font-size: 16px;
                  " title="Actualizar progreso">
                    ğŸ“ˆ
                  </button>
                </div>
              </div>
            `).join('')}


<!-- ğŸ”¥ AQUÃ VA EL LAYER NUEVO PARA LAS FLECHAS -->
  <div id="dependencyLayer" style="
    position: absolute;
    top: 0;
    left: 320px;
    right: 80px;
    bottom: 0;
    pointer-events: none;
    overflow: visible;
    z-index: 5;
  "></div>


          </div>
        </div>
      </div>
    </div>
    
    <!-- FOOTER -->
    <div style="
      background: rgba(255, 255, 255, 0.05);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding: 15px 35px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      color: #95a5a6;
    ">
      <div style="display: flex; gap: 30px;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 12px; height: 12px; background: #e74c3c; border-radius: 50%;"></div>
          <span>Ruta CrÃ­tica (${criticalTasks})</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 12px; height: 12px; background: #9b59b6; border-radius: 50%;"></div>
          <span>Dependencias (${tasksWithDeps})</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 12px; height: 12px; background: #2ecc71; border-radius: 50%;"></div>
          <span>Progreso: ${avgProgress}%</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 12px; height: 12px; background: #3498db; border-radius: 50%;"></div>
          <span>Tareas: ${totalTasks}</span>
        </div>
      </div>
      <div>
        <span>ğŸ”„ Actualizado: ${new Date().toLocaleTimeString()}</span>
      </div>
    </div>
  `;
  
  document.body.appendChild(container);
  window.__premiumTasks = executiveTasks;

  // Guardar tasks en dataset para acceso posterior - AHORA CON EL PROYECTO ACTUAL
  container.dataset.projectIndex = currentProjectIndex;
  container.dataset.tasks = JSON.stringify(executiveTasks);
  container.dataset.projectName = yourProject.name;
  
  console.log('ğŸ“Š Proyecto cargado:', yourProject.name);
  console.log('ğŸ“‹ Tareas procesadas:', executiveTasks.length);
  
  // DIBUJAR DEPENDENCIAS
  setTimeout(() => {
  drawPremiumDependenciesComplete(executiveTasks);
  enableTaskTooltips();
}, 200);

  
  // AGREGAR ESTILOS DE ANIMACIÃ“N
  addPremiumStyles();
}

// ========== FUNCIONES PARA DEPENDENCIAS Y RUTAS CRÃTICAS ==========

// 1. FUNCIÃ“N PARA GENERAR LISTA DE DEPENDENCIAS DETALLADAS
function generateDependenciesList(tasks) {
  const dependenciesList = [];
  
  tasks.forEach(task => {
    if (task.dependencies && task.dependencies.length > 0) {
      task.dependencies.forEach(depId => {
        const depTask = tasks.find(t => t.id.toString() === depId.toString());
        if (depTask) {
          dependenciesList.push({
            from: depTask.name,
            to: task.name,
            fromId: depTask.id,
            toId: task.id
          });
        }
      });
    }
  });
  
  if (dependenciesList.length === 0) {
    return '<div style="color: #95a5a6; font-size: 12px; font-style: italic;">No hay dependencias definidas</div>';
  }
  
  // Limitar a mostrar 3 dependencias para no saturar
  const displayList = dependenciesList.slice(0, 3);
  
  return `
    <div style="max-height: 120px; overflow-y: auto; margin-top: 10px;">
      ${displayList.map(dep => `
        <div style="
          background: rgba(255,255,255,0.05);
          border-radius: 6px;
          padding: 8px 10px;
          margin-bottom: 6px;
          border-left: 3px solid #9b59b6;
        ">
          <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
            <span style="color: #9b59b6; font-size: 10px;">â¬…</span>
            <span style="color: white; font-size: 11px; font-weight: bold;">${dep.from}</span>
          </div>
          <div style="display: flex; align-items: center; gap: 6px;">
            <span style="color: #3498db; font-size: 10px;">â¡</span>
            <span style="color: #95a5a6; font-size: 11px;">${dep.to}</span>
          </div>
        </div>
      `).join('')}
      ${dependenciesList.length > 3 ? 
        `<div style="color: #95a5a6; font-size: 11px; text-align: center; margin-top: 5px;">
          y ${dependenciesList.length - 3} dependencias mÃ¡s...
        </div>` : ''
      }
    </div>
    <button onclick="showAllDependencies()" style="
      width: 100%;
      background: rgba(155, 89, 182, 0.2);
      border: 1px solid #9b59b6;
      color: #9b59b6;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    ">
      ğŸ” Ver todas las dependencias
    </button>
  `;
}

// 2. FUNCIÃ“N PARA DIBUJAR DEPENDENCIAS CON CORRECCIÃ“N DE POSICIÃ“N
function drawPremiumDependenciesComplete(tasks) {
  const layer = document.getElementById("dependencyLayer");
  if (!layer) return;

  layer.innerHTML = "";

  const layerRect = layer.getBoundingClientRect();

  tasks.forEach(task => {
    if (!task.dependencies || task.dependencies.length === 0) return;

    task.dependencies.forEach(depId => {
      const fromTask = document.querySelector(
        `.premium-task[data-task-id="${depId}"]`
      );
      const toTask = document.querySelector(
        `.premium-task[data-task-id="${task.id}"]`
      );

      if (!fromTask || !toTask) return;

      // ğŸ‘‰ BARRA REAL
      const barA = fromTask.children[1]?.children[1]?.getBoundingClientRect();
      const barB = toTask.children[1]?.children[1]?.getBoundingClientRect();

      if (!barA || !barB) return;

      // âœ… COORDENADAS RELATIVAS AL dependencyLayer
      const sx = barA.right - layerRect.left - 45;
      const sy = barA.top + barA.height / 2 - layerRect.top;

      const ex = barB.left - layerRect.left + 45;
      const ey = barB.top + barB.height / 2 - layerRect.top;

      const cx = (sx + ex) / 2;

      const d = `
        M ${sx} ${sy}
        C ${cx} ${sy},
          ${cx} ${ey},
          ${ex} ${ey}
      `;

      layer.innerHTML += `
        <svg width="100%" height="100%" style="position:absolute; overflow:visible;">
          <path d="${d}" stroke="#9b59b6" stroke-width="3" fill="none"></path>
          <circle cx="${ex}" cy="${ey}" r="4" fill="#9b59b6"></circle>
        </svg>
      `;
    });
  });
}






// 3. FUNCIÃ“N PARA MOSTRAR TODAS LAS DEPENDENCIAS
window.showAllDependencies = function() {
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;
  
  const tasks = JSON.parse(ganttContainer.dataset.tasks || '[]');
  const allDependencies = [];
  
  tasks.forEach(task => {
    if (task.dependencies && task.dependencies.length > 0) {
      task.dependencies.forEach(depId => {
        const depTask = tasks.find(t => t.id.toString() === depId.toString());
        if (depTask) {
          allDependencies.push(`${depTask.name} â†’ ${task.name}`);
        }
      });
    }
  });
  
  if (allDependencies.length === 0) {
    alert('No hay dependencias definidas en el proyecto.');
    return;
  }
  
  const dependenciesText = allDependencies.join('\n');
  alert(`ğŸ”— TODAS LAS DEPENDENCIAS (${allDependencies.length}):\n\n${dependenciesText}`);
};

// 4. MODAL PARA CREAR DEPENDENCIAS
// ========== MODAL PARA CREAR DEPENDENCIAS - CORREGIDO ==========
window.openDependencyCreator = function() {
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;
  
  // OBTENER EL PROYECTO ACTUAL CORRECTAMENTE
  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  
  // Verificar que el proyecto existe
  if (projectIndex >= projects.length || projectIndex < 0) {
    alert('Error: Proyecto no vÃ¡lido.');
    return;
  }
  
  const currentProject = projects[projectIndex];
  const currentTasks = currentProject.tasks || [];
  
  console.log('ğŸ” Abriendo creador de dependencias para proyecto:', currentProject.name);
  console.log('ğŸ“‹ Tareas del proyecto actual:', currentTasks.length);
  
  if (currentTasks.length === 0) {
    alert('No hay tareas disponibles para crear dependencias.');
    return;
  }
  
  // Crear overlay
  const overlay = document.createElement('div');
  overlay.className = 'dependency-overlay';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(5px);
    z-index: 1000000;
  `;
  overlay.onclick = closeDependencyCreator;
  
  // Crear modal
  const modal = document.createElement('div');
  modal.className = 'dependency-modal';
  modal.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 600px;
    background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
    border-radius: 20px;
    padding: 30px;
    z-index: 1000001;
    box-shadow: 0 30px 60px rgba(0,0,0,0.8);
    border: 2px solid rgba(155, 89, 182, 0.4);
    color: white;
  `;
  
  // Transformar tareas para mostrar (igual que en el Gantt)
  const transformedTasks = currentTasks.map((task, index) => {
    const statusColors = {
      'pending': '#f1c40f',
      'inProgress': '#3498db', 
      'completed': '#2ecc71',
      'overdue': '#e74c3c'
    };
    
    const isCritical = task.priority === 'alta' || task.status === 'overdue';
    
    return {
      id: task.id || Date.now() + index,
      name: task.name || `Tarea ${index + 1}`,
      color: statusColors[task.status] || '#95a5a6',
      critical: isCritical,
      dependencies: task.dependencies || [],
      status: task.status || 'pending',
      priority: task.priority || 'media',
      originalTask: task
    };
  });
  
// CORRECCIÃ“N: ConstrucciÃ³n correcta de dependencias existentes
const existingDependencies = [];

currentTasks.forEach(task => {
  const toId = task.id;
  const deps = Array.isArray(task.dependencies) ? task.dependencies : [];

  deps.forEach(fromId => {
    const fromTask = transformedTasks.find(t => t.id.toString() === fromId.toString());
    const toTask = transformedTasks.find(t => t.id.toString() === toId.toString());

    if (fromTask && toTask) {
      existingDependencies.push({
        from: fromTask,
        to: toTask,
        fromId,
        toId
      });
    }
  });
});



// SINCRONIZAR TODAS LAS DEPENDENCIAS AL ESTADO GLOBAL
window.currentDependencies = existingDependencies.map(dep => ({
    fromId: dep.fromId,
    toId: dep.toId
}));
console.log("ğŸŒ currentDependencies cargadas:", window.currentDependencies);




  modal.innerHTML = `
    <h3 style="color: #9b59b6; margin-top: 0; margin-bottom: 20px; text-align: center;">
      ğŸ”— Gestor de Dependencias - ${currentProject.name}
    </h3>
    
    <div style="margin-bottom: 15px; color: #95a5a6; text-align: center;">
      Proyecto actual: <strong style="color: #2ecc71;">${currentProject.name}</strong>
      <br>Tareas disponibles: <strong>${transformedTasks.length}</strong>
    </div>
    
    <div style="display: flex; gap: 15px; margin-bottom: 25px; align-items: center;">
      <select id="fromTaskSelect" style="
        flex: 1;
        padding: 12px;
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(155, 89, 182, 0.3);
        border-radius: 8px;
        color: white;
        font-size: 14px;
      ">
        <option value="">Seleccionar tarea origen</option>
        ${transformedTasks.map((task, index) => `
          <option value="${task.id}">${index + 1}. ${task.name}</option>
        `).join('')}
      </select>
      
      <div style="color: #9b59b6; font-size: 18px; margin: 0 10px;">â¡</div>
      
      <select id="toTaskSelect" style="
        flex: 1;
        padding: 12px;
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(155, 89, 182, 0.3);
        border-radius: 8px;
        color: white;
        font-size: 14px;
      ">
        <option value="">Seleccionar tarea destino</option>
        ${transformedTasks.map((task, index) => `
          <option value="${task.id}">${index + 1}. ${task.name}</option>
        `).join('')}
      </select>
      
      <button onclick="addNewDependency()" style="
        background: linear-gradient(45deg, #9b59b6, #8e44ad);
        border: none;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 8px;
      ">
        â• Agregar
      </button>
    </div>
    
    <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; margin-bottom: 25px; border: 1px solid rgba(155, 89, 182, 0.2);">
      <h4 style="color: #9b59b6; margin-top: 0; margin-bottom: 15px;">Dependencias Actuales</h4>
      <div id="dependenciesList">
        ${existingDependencies.length > 0 ? 
          existingDependencies.map(dep => `
           <div class="dependency-item"
     data-from-id="${dep.fromId}"
     data-to-id="${dep.toId}"
     style="
       display: flex;
       align-items: center;
       justify-content: space-between;
       padding: 10px 15px;
       background: rgba(155, 89, 182, 0.1);
       border-radius: 8px;
       margin-bottom: 10px;
     ">

              <div style="display: flex; align-items: center; gap: 10px;">
                <div style="
                  width: 24px;
                  height: 24px;
                  background: ${dep.from.color || '#9b59b6'};
                  border-radius: 6px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  color: white;
                  font-size: 12px;
                  font-weight: bold;
                ">
                  ${transformedTasks.findIndex(t => t.id.toString() === dep.fromId.toString()) + 1}
                </div>
                <span style="font-weight: bold; color: white;">${dep.from.name}</span>
                <span style="color: #9b59b6; font-size: 18px; margin: 0 10px;">â¡</span>
                <div style="
                  width: 24px;
                  height: 24px;
                  background: ${dep.to.color || '#3498db'};
                  border-radius: 6px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  color: white;
                  font-size: 12px;
                  font-weight: bold;
                ">
                  ${transformedTasks.findIndex(t => t.id.toString() === dep.toId.toString()) + 1}
                </div>
                <span style="color: white;">${dep.to.name}</span>
              </div>
              <div style="display: flex; gap: 8px;">
                <button onclick="removeExistingDependency('${dep.fromId}', '${dep.toId}', ${projectIndex})" style="
                  width: 30px;
                  height: 30px;
                  border-radius: 6px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  cursor: pointer;
                  border: none;
                  font-size: 14px;
                  background: rgba(231, 76, 60, 0.2);
                  color: #e74c3c;
                " title="Eliminar">
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>
          `).join('') : 
          '<div style="color: #95a5a6; text-align: center; padding: 20px; font-style: italic;">No hay dependencias definidas</div>'
        }
      </div>
    </div>
    
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div style="color: #95a5a6; font-size: 13px;">
        ${existingDependencies.length} dependencia(s) definida(s)
      </div>
      <div style="display: flex; gap: 10px;">
        <button onclick="closeDependencyCreator()" style="
          background: rgba(255,255,255,0.1);
          border: 1px solid rgba(255,255,255,0.3);
          color: white;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
        ">
          Cancelar
        </button>
        <button onclick="saveDependencies(${projectIndex})" style="
          background: linear-gradient(45deg, #2ecc71, #27ae60);
          border: none;
          color: white;
          padding: 10px 30px;
          border-radius: 8px;
          cursor: pointer;
          font-weight: bold;
        ">
          ğŸ’¾ Guardar Cambios
        </button>
      </div>
    </div>
  `;
  
  // Guardar datos en el modal para uso posterior
  modal.dataset.projectIndex = projectIndex;
  modal.dataset.tasks = JSON.stringify(transformedTasks);
  modal.dataset.originalTasks = JSON.stringify(currentTasks);
  
  document.body.appendChild(overlay);
  document.body.appendChild(modal);
};

// ========== FUNCIÃ“N PARA AGREGAR NUEVA DEPENDENCIA - CORREGIDA ==========
window.addNewDependency = function() {
  const modal = document.querySelector('.dependency-modal');
  if (!modal) return;
  
  const fromSelect = document.getElementById('fromTaskSelect');
  const toSelect = document.getElementById('toTaskSelect');
  
  const fromId = fromSelect.value;
  const toId = toSelect.value;
  
  console.log('â• Intentando agregar dependencia:', { fromId, toId });
  
  if (!fromId || !toId) {
    alert('Por favor selecciona ambas tareas.');
    return;
  }
  
  if (fromId === toId) {
    alert('Una tarea no puede depender de sÃ­ misma.');
    return;
  }
  
  // Obtener tareas del modal
  const tasks = JSON.parse(modal.dataset.tasks || '[]');
  
  // Encontrar las tareas
  const fromTask = tasks.find(t => t.id.toString() === fromId.toString());
  const toTask = tasks.find(t => t.id.toString() === toId.toString());
  
  console.log('ğŸ” Tareas encontradas:', { fromTask, toTask });
  
  if (!fromTask || !toTask) {
    alert('Error: No se encontraron las tareas seleccionadas.');
    return;
  }
  
  // Verificar si la dependencia ya existe
  if (toTask.dependencies && toTask.dependencies.includes(fromId)) {
    alert('Esta dependencia ya existe.');
    return;
  }
  
  // Verificar dependencias cÃ­clicas
  if (checkCyclicDependency(tasks, toId, fromId)) {
    alert('No se puede crear esta dependencia porque crearÃ­a un ciclo.');
    return;
  }
  
  const fromIndex = tasks.findIndex(t => t.id.toString() === fromId.toString()) + 1;
  const toIndex = tasks.findIndex(t => t.id.toString() === toId.toString()) + 1;
  
  const dependencyItem = document.createElement('div');
  dependencyItem.className = 'dependency-item';
  dependencyItem.style.cssText = `
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 15px;
    background: rgba(155, 89, 182, 0.1);
    border-radius: 8px;
    margin-bottom: 10px;
  `;
  dependencyItem.innerHTML = `
    <div style="display: flex; align-items: center; gap: 10px;">
      <div style="
        width: 24px;
        height: 24px;
        background: ${fromTask.color || '#9b59b6'};
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: bold;
      ">
        ${fromIndex}
      </div>
      <span style="font-weight: bold; color: white;">${fromTask.name}</span>
      <span style="color: #9b59b6; font-size: 18px; margin: 0 10px;">â¡</span>
      <div style="
        width: 24px;
        height: 24px;
        background: ${toTask.color || '#3498db'};
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: bold;
      ">
        ${toIndex}
      </div>
      <span style="color: white;">${toTask.name}</span>
    </div>
    <div style="display: flex; gap: 8px;">
      <button onclick="removeNewDependency(this)" style="
        width: 30px;
        height: 30px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: none;
        font-size: 14px;
        background: rgba(231, 76, 60, 0.2);
        color: #e74c3c;
      " title="Eliminar">
        ğŸ—‘ï¸
      </button>
    </div>
  `;
  
  dependencyItem.dataset.fromId = fromId;
  dependencyItem.dataset.toId = toId;
  
  const dependenciesList = document.getElementById('dependenciesList');
  
  // Si no hay dependencias, limpiar el mensaje
  if (dependenciesList.firstChild && 
      dependenciesList.firstChild.style && 
      dependenciesList.firstChild.style.color === 'rgb(149, 165, 166)') {
    dependenciesList.innerHTML = '';
  }
  
  dependenciesList.appendChild(dependencyItem);
  
  console.log('âœ… Dependencia agregada visualmente');
  

// ğŸ”¥ Actualizar el estado global de dependencias
window.currentDependencies.push({ 
    fromId: fromId, 
    toId: toId 
});
console.log("ğŸŒ Estado actualizado:", window.currentDependencies);




  // Limpiar selecciones
  fromSelect.value = '';
  toSelect.value = '';
};

// ========== FUNCIÃ“N PARA GUARDAR DEPENDENCIAS - CORREGIDA ==========
window.saveDependencies = function(projectIndex) {
  const modal = document.querySelector('.dependency-modal');
  if (!modal) return;

  if (projectIndex >= projects.length || projectIndex < 0) {
    alert('Error: Proyecto no vÃ¡lido.');
    return;
  }

  const currentProject = projects[projectIndex];
  const currentTasks = currentProject.tasks || [];

  console.log('ğŸ’¾ Guardando dependencias para proyecto:', currentProject.name);

  // 1ï¸âƒ£ OBTENER TODAS LAS NUEVAS DEPENDENCIAS DEL MODAL
  const dependenciesList = document.getElementById('dependenciesList');
  const newDependencies = [];

  dependenciesList.querySelectorAll('.dependency-item').forEach(item => {
    const fromId = item.dataset.fromId;
    const toId = item.dataset.toId;

    if (fromId && toId) {
      newDependencies.push({ fromId, toId });
    }
  });

  console.log('ğŸ“‹ Dependencias a guardar:', newDependencies);

  // 2ï¸âƒ£ LIMPIAR DEPENDENCIAS CORRECTAMENTE PERO SIN PERDER ESTRUCTURA
  currentTasks.forEach(task => {
    task.dependencies = [];  // cada tarea empieza limpia
  });

  // 3ï¸âƒ£ APLICAR TODAS LAS DEPENDENCIAS CORRECTAMENTE
  newDependencies.forEach(dep => {
    const fromId = dep.fromId.toString();
    const toId = dep.toId.toString();

    // Buscar la tarea TO
    const toTask = currentTasks.find(t => t.id.toString() === toId);
    if (!toTask) return;

    if (!Array.isArray(toTask.dependencies)) {
      toTask.dependencies = [];
    }

    // Evitar duplicados
    if (!toTask.dependencies.includes(fromId)) {
      toTask.dependencies.push(fromId);
    }
  });

  console.log("ğŸ”¥ DEPENDENCIAS FINALES GUARDADAS:");
  currentTasks.forEach(t => {
    console.log(t.name, "=>", t.dependencies);
  });

  // 4ï¸âƒ£ CERRAR MODAL Y REFRESCAR GANTT
  closeDependencyCreator();
  refreshGanttView();

  alert('âœ… Dependencias guardadas correctamente.\nEl Gantt se ha actualizado.');
};

// ========== FUNCIÃ“N PARA MARCAR RUTA CRÃTICA - CORREGIDA ==========
window.markAsCriticalPath = function() {
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;
  
  // OBTENER EL PROYECTO ACTUAL CORRECTAMENTE
  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  
  // Verificar que el proyecto existe
  if (projectIndex >= projects.length || projectIndex < 0) {
    alert('Error: Proyecto no vÃ¡lido.');
    return;
  }
  
  const currentProject = projects[projectIndex];
  const currentTasks = currentProject.tasks || [];
  
  if (currentTasks.length === 0) {
    alert('No hay tareas para marcar como crÃ­ticas.');
    return;
  }
  
  const overlay = document.createElement('div');
  overlay.className = 'dependency-overlay';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(5px);
    z-index: 1000000;
  `;
  
  const modal = document.createElement('div');
  modal.className = 'dependency-modal';
  modal.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 500px;
    background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
    border-radius: 20px;
    padding: 30px;
    z-index: 1000001;
    box-shadow: 0 30px 60px rgba(0,0,0,0.8);
    border: 2px solid rgba(231, 76, 60, 0.4);
    color: white;
  `;
  
  // Determinar quÃ© tareas son crÃ­ticas actualmente
  const criticalStatus = currentTasks.map(task => ({
    id: task.id,
    name: task.name,
    isCritical: task.priority === 'alta' || task.status === 'overdue',
    currentPriority: task.priority || 'media'
  }));
  
  modal.innerHTML = `
    <h3 style="color: #e74c3c; margin-top: 0; margin-bottom: 20px; text-align: center;">
      ğŸ”¥ Marcador de Ruta CrÃ­tica
    </h3>
    
    <div style="margin-bottom: 15px; color: #95a5a6; text-align: center;">
      Proyecto: <strong style="color: #2ecc71;">${currentProject.name}</strong>
      <br>Selecciona las tareas que forman parte de la ruta crÃ­tica:
    </div>
    
    <div style="max-height: 300px; overflow-y: auto; margin-bottom: 25px;">
      ${criticalStatus.map((task, index) => `
        <div style="
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 12px 15px;
          background: rgba(255,255,255,0.05);
          border-radius: 8px;
          margin-bottom: 8px;
          border: 1px solid ${task.isCritical ? 'rgba(231, 76, 60, 0.5)' : 'rgba(255,255,255,0.1)'};
        ">
          <input 
            type="checkbox" 
            id="critical_${task.id}" 
            ${task.isCritical ? 'checked' : ''}
            style="transform: scale(1.2);"
            onchange="toggleCriticalTaskSelection('${task.id}', this.checked, ${projectIndex})"
          >
          <label for="critical_${task.id}" style="flex: 1; color: white; cursor: pointer;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <div style="
                width: 30px;
                height: 30px;
                background: ${task.isCritical ? '#e74c3c' : '#3498db'};
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                font-size: 13px;
              ">
                ${index + 1}
              </div>
              <span>${task.name}</span>
            </div>
          </label>
          ${task.isCritical ? '<span style="color: #e74c3c; font-size: 12px;">ğŸ”¥ CRÃTICA</span>' : ''}
        </div>
      `).join('')}
    </div>
    
    <div style="display: flex; justify-content: flex-end; gap: 10px;">
      <button onclick="closeCriticalModal()" style="
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
      ">
        Cancelar
      </button>
      <button onclick="saveCriticalPath(${projectIndex})" style="
        background: linear-gradient(45deg, #e74c3c, #c0392b);
        border: none;
        color: white;
        padding: 10px 30px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
      ">
        ğŸ’¾ Guardar Ruta CrÃ­tica
      </button>
    </div>
  `;
  
  // Guardar datos en el modal
  modal.dataset.projectIndex = projectIndex;
  modal.dataset.criticalStatus = JSON.stringify(criticalStatus);
  
  overlay.onclick = closeCriticalModal;
  
  document.body.appendChild(overlay);
  document.body.appendChild(modal);
};

// ========== FUNCIÃ“N PARA TOGGLE DE TAREA CRÃTICA - CORREGIDA ==========
window.toggleCriticalTaskSelection = function(taskId, isCritical, projectIndex) {
  const modal = document.querySelector('.dependency-modal');
  if (!modal) return;
  
  // Actualizar el estado en el modal
  let criticalStatus = JSON.parse(modal.dataset.criticalStatus || '[]');
  const taskIndex = criticalStatus.findIndex(t => t.id.toString() === taskId.toString());
  
  if (taskIndex !== -1) {
    criticalStatus[taskIndex].isCritical = isCritical;
    modal.dataset.criticalStatus = JSON.stringify(criticalStatus);
  }
};

// ========== FUNCIÃ“N PARA GUARDAR RUTA CRÃTICA - CORREGIDA ==========
window.saveCriticalPath = function(projectIndex) {
  const modal = document.querySelector('.dependency-modal');
  if (!modal) return;
  
  // Verificar que el proyecto existe
  if (projectIndex >= projects.length || projectIndex < 0) {
    alert('Error: Proyecto no vÃ¡lido.');
    return;
  }
  
  const currentProject = projects[projectIndex];
  const criticalStatus = JSON.parse(modal.dataset.criticalStatus || '[]');
  
  // Actualizar prioridades en las tareas del proyecto
  criticalStatus.forEach(taskStatus => {
    const task = currentProject.tasks.find(t => t.id.toString() === taskStatus.id.toString());
    if (task) {
      task.priority = taskStatus.isCritical ? 'alta' : 'media';
    }
  });
  
  console.log('âœ… Ruta crÃ­tica guardada para proyecto:', currentProject.name);
  
  // Cerrar modal
  closeCriticalModal();
  
  // Actualizar visualizaciÃ³n del Gantt
  refreshGanttView();
  
  alert('âœ… Ruta crÃ­tica guardada correctamente.\nEl Gantt se ha actualizado.');
};

// ========== FUNCIÃ“N PARA ELIMINAR DEPENDENCIA EXISTENTE - CORREGIDA ==========
window.removeExistingDependency = function(fromId, toId, projectIndex) {
  // Verificar que el proyecto existe
  if (projectIndex >= projects.length || projectIndex < 0) {
    alert('Error: Proyecto no vÃ¡lido.');
    return;
  }
  
  const currentProject = projects[projectIndex];
  const currentTasks = currentProject.tasks || [];
  
  // Encontrar la tarea destino y eliminar la dependencia
  const toTask = currentTasks.find(t => {
    return (t.id && t.id.toString() === toId.toString()) || 
           (t.originalTask && t.originalTask.id && t.originalTask.id.toString() === toId.toString());
  });
  
  if (toTask && toTask.dependencies) {
    toTask.dependencies = toTask.dependencies.filter(id => id.toString() !== fromId.toString());
    
    // Actualizar la vista del modal
    const dependenciesList = document.getElementById('dependenciesList');
    const itemToRemove = Array.from(dependenciesList.querySelectorAll('.dependency-item'))
      .find(item => item.dataset.fromId === fromId && item.dataset.toId === toId);
    
    if (itemToRemove) {
      itemToRemove.remove();
    }
    
    // Si no quedan dependencias, mostrar mensaje
    if (dependenciesList.children.length === 0) {
      dependenciesList.innerHTML = '<div style="color: #95a5a6; text-align: center; padding: 20px; font-style: italic;">No hay dependencias definidas</div>';
    }
    
    console.log('ğŸ—‘ï¸ Dependencia eliminada:', { fromId, toId });
  }
};

// ========== FUNCIÃ“N PARA LIMPIAR TODAS LAS DEPENDENCIAS - CORREGIDA ==========
window.clearAllDependencies = function() {
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;
  
  // OBTENER EL PROYECTO ACTUAL CORRECTAMENTE
  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  
  // Verificar que el proyecto existe
  if (projectIndex >= projects.length || projectIndex < 0) {
    alert('Error: Proyecto no vÃ¡lido.');
    return;
  }
  
  if (!confirm(`Â¿EstÃ¡s seguro de que quieres eliminar TODAS las dependencias del proyecto "${projects[projectIndex].name}"?\nEsta acciÃ³n no se puede deshacer.`)) {
    return;
  }
  
  const currentProject = projects[projectIndex];
  
  // Limpiar todas las dependencias del proyecto
  currentProject.tasks.forEach(task => {
    task.dependencies = [];
  });
  
  console.log('ğŸ—‘ï¸ Todas las dependencias eliminadas del proyecto:', currentProject.name);
  
  // Actualizar visualizaciÃ³n del Gantt
  refreshGanttView();
  
  alert('âœ… Todas las dependencias han sido eliminadas del proyecto actual.');
};

// ========== FUNCIÃ“N PARA REFRESCAR GANTT - CORREGIDA ==========
function refreshGanttView() {
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;
  
  // Obtener el proyecto actual del dataset
  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  
  console.log('ğŸ”„ Refrescando Gantt para proyecto Ã­ndice:', projectIndex);
  
  // Guardar temporalmente el Ã­ndice del proyecto actual
  const savedIndex = currentProjectIndex;
  
  // Establecer el proyecto correcto
  if (projectIndex >= 0 && projectIndex < projects.length) {
    currentProjectIndex = projectIndex;
  }
  
  // Eliminar el Gantt actual
  ganttContainer.remove();
  
  // Crear nuevo Gantt con el proyecto correcto
  createCompleteGanttForCurrentProject();
  
  // Restaurar el Ã­ndice original si es necesario
  currentProjectIndex = savedIndex;
}

// Busca en el cÃ³digo la funciÃ³n `checkCyclicDependency` y asegÃºrate de que estÃ© definida:
function checkCyclicDependency(tasks, startId, checkId, visited = new Set()) {
  if (startId.toString() === checkId.toString()) return true;
  if (visited.has(startId.toString())) return false;
  
  visited.add(startId.toString());
  
  const task = tasks.find(t => t.id.toString() === startId.toString());
  if (!task || !task.dependencies) return false;
  
  for (const depId of task.dependencies) {
    if (checkCyclicDependency(tasks, depId.toString(), checkId, new Set(visited))) {
      return true;
    }
  }
  
  return false;
}

// 7. FUNCIÃ“N PARA ELIMINAR DEPENDENCIA EN EL MODAL
window.removeNewDependency = function(button) {
  const dependencyItem = button.closest('.dependency-item');
  if (dependencyItem) {
    dependencyItem.remove();
  }
  
  const dependenciesList = document.getElementById('dependenciesList');
  if (dependenciesList.children.length === 0) {
    dependenciesList.innerHTML = '<div style="color: #95a5a6; text-align: center; padding: 20px; font-style: italic;">No hay dependencias definidas</div>';
  }
};

window.removeExistingDependency = function(fromId, toId) {
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  const tasks = JSON.parse(ganttContainer.dataset.tasks || '[]');
  
  const toTask = tasks.find(t => t.id.toString() === toId.toString());
  if (toTask && toTask.dependencies) {
    toTask.dependencies = toTask.dependencies.filter(id => id.toString() !== fromId.toString());
    ganttContainer.dataset.tasks = JSON.stringify(tasks);
    
    // Actualizar la vista del modal
    const dependenciesList = document.getElementById('dependenciesList');
    const itemToRemove = Array.from(dependenciesList.querySelectorAll('.dependency-item'))
      .find(item => item.dataset.fromId === fromId && item.dataset.toId === toId);
    
    if (itemToRemove) {
      itemToRemove.remove();
    }
    
    // Si no quedan dependencias, mostrar mensaje
    if (dependenciesList.children.length === 0) {
      dependenciesList.innerHTML = '<div style="color: #95a5a6; text-align: center; padding: 20px; font-style: italic;">No hay dependencias definidas</div>';
    }
  }
};

// 8. FUNCIÃ“N PARA GUARDAR DEPENDENCIAS
window.saveDependencies = function() {
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;
  
  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  const tasks = JSON.parse(ganttContainer.dataset.tasks || '[]');
  
  console.log('ğŸ’¾ Guardando dependencias para proyecto:', projects[projectIndex]?.name);
  
  // Obtener nuevas dependencias del modal
  const dependenciesList = document.getElementById('dependenciesList');
  const newDependencies = [];
  
  dependenciesList.querySelectorAll('.dependency-item').forEach(item => {
    const fromId = item.dataset.fromId;
    const toId = item.dataset.toId;
    
    if (fromId && toId) {
      newDependencies.push({ fromId, toId });
    }
  });
  
  console.log('ğŸ“‹ Nuevas dependencias a guardar:', newDependencies.length);
  
  // Actualizar dependencias en todas las tareas
  tasks.forEach(task => {
    task.dependencies = [];
  });
  
  // Aplicar nuevas dependencias
  newDependencies.forEach(({ fromId, toId }) => {
    const toTask = tasks.find(t => t.id.toString() === toId.toString());
    if (toTask) {
      if (!toTask.dependencies) toTask.dependencies = [];
      if (!toTask.dependencies.includes(fromId)) {
        toTask.dependencies.push(fromId);
      }
    }
  });
  
  // Guardar cambios en el dataset
  ganttContainer.dataset.tasks = JSON.stringify(tasks);
  
  // Actualizar el proyecto actual en la variable global projects
  if (projects[projectIndex]) {
    // Mantener las tareas originales pero actualizar dependencias
    projects[projectIndex].tasks.forEach((originalTask, index) => {
      const transformedTask = tasks[index];
      if (transformedTask && originalTask) {
        originalTask.dependencies = transformedTask.dependencies || [];
      }
    });
    
    console.log('âœ… Proyecto actualizado:', projects[projectIndex]);
  }
  
  // Actualizar visualizaciÃ³n
  refreshGanttView();
  closeDependencyCreator();
  
  alert('âœ… Dependencias guardadas correctamente.\nEl Gantt se ha actualizado.');
};

// 9. FUNCIÃ“N PARA MARCAR RUTA CRÃTICA
window.markAsCriticalPath = function() {
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;
  
  const tasks = JSON.parse(ganttContainer.dataset.tasks || '[]');
  
  if (tasks.length === 0) {
    alert('No hay tareas para marcar como crÃ­ticas.');
    return;
  }
  
  const overlay = document.createElement('div');
  overlay.className = 'dependency-overlay';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(5px);
    z-index: 1000000;
  `;
  
  const modal = document.createElement('div');
  modal.className = 'dependency-modal';
  modal.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 500px;
    background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
    border-radius: 20px;
    padding: 30px;
    z-index: 1000001;
    box-shadow: 0 30px 60px rgba(0,0,0,0.8);
    border: 2px solid rgba(231, 76, 60, 0.4);
    color: white;
  `;
  
  modal.innerHTML = `
    <h3 style="color: #e74c3c; margin-top: 0; margin-bottom: 20px; text-align: center;">ğŸ”¥ Marcador de Ruta CrÃ­tica</h3>
    
    <div style="margin-bottom: 25px; color: #95a5a6;">
      <p>Selecciona las tareas que forman parte de la ruta crÃ­tica:</p>
    </div>
    
    <div style="max-height: 300px; overflow-y: auto; margin-bottom: 25px;">
      ${tasks.map((task, index) => `
        <div style="
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 12px 15px;
          background: rgba(255,255,255,0.05);
          border-radius: 8px;
          margin-bottom: 8px;
          border: 1px solid ${task.critical ? 'rgba(231, 76, 60, 0.5)' : 'rgba(255,255,255,0.1)'};
        ">
          <input 
            type="checkbox" 
            id="critical_${task.id}" 
            ${task.critical ? 'checked' : ''}
            style="transform: scale(1.2);"
            onchange="toggleCriticalTask('${task.id}', this.checked)"
          >
          <label for="critical_${task.id}" style="flex: 1; color: white; cursor: pointer;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <div style="
                width: 30px;
                height: 30px;
                background: ${task.color || '#95a5a6'};
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                font-size: 13px;
              ">
                ${index + 1}
              </div>
              <span>${task.name}</span>
            </div>
          </label>
          ${task.critical ? '<span style="color: #e74c3c; font-size: 12px;">ğŸ”¥ CRÃTICA</span>' : ''}
        </div>
      `).join('')}
    </div>
    
    <div style="display: flex; justify-content: flex-end; gap: 10px;">
      <button onclick="closeCriticalModal()" style="
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
      ">
        Cancelar
      </button>
      <button onclick="saveCriticalPath()" style="
        background: linear-gradient(45deg, #e74c3c, #c0392b);
        border: none;
        color: white;
        padding: 10px 30px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
      ">
        ğŸ’¾ Guardar Ruta CrÃ­tica
      </button>
    </div>
  `;
  
  overlay.onclick = closeCriticalModal;
  
  document.body.appendChild(overlay);
  document.body.appendChild(modal);
};

// 10. FUNCIÃ“N PARA TOGGLE DE TAREA CRÃTICA
window.toggleCriticalTask = function(taskId, isCritical) {
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  const tasks = JSON.parse(ganttContainer.dataset.tasks || '[]');
  
  const task = tasks.find(t => t.id.toString() === taskId.toString());
  if (task) {
    task.critical = isCritical;
    ganttContainer.dataset.tasks = JSON.stringify(tasks);
  }
};

// 11. FUNCIÃ“N PARA GUARDAR RUTA CRÃTICA (VERSIÃ“N FINAL CORREGIDA)
window.saveCriticalPath = function() {
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;

  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  const tasks = JSON.parse(ganttContainer.dataset.tasks || '[]');

  if (!projects[projectIndex]) {
    console.error("Proyecto invÃ¡lido:", projectIndex);
    return;
  }

  // Mapeo seguro por ID (evita problemas de orden)
  const originalMap = {};
  projects[projectIndex].tasks.forEach(t => {
    if (t.id !== undefined && t.id !== null) {
      originalMap[t.id.toString()] = t;
    }
  });

  // Aplicar cambios a las tareas originales
  tasks.forEach(t => {
    const key = t.id?.toString();
    const original = originalMap[key];
    if (original) {
      // Guardar estado critical REAL en el proyecto
      original.critical = !!t.critical;

      // Ajustar prioridad segÃºn critical
      original.priority = t.critical ? "alta" : "media";
    } else {
      console.warn("âš ï¸ No se encontrÃ³ tarea original con ID:", t.id);
    }
  });

  // Cerrar modal y refrescar vista
  closeCriticalModal();
  refreshGanttView();

  alert("ğŸ”¥ Ruta crÃ­tica actualizada correctamente.");
};

// 12. FUNCIÃ“N PARA LIMPIAR TODAS LAS DEPENDENCIAS
window.clearAllDependencies = function() {
  if (!confirm('Â¿EstÃ¡s seguro de que quieres eliminar TODAS las dependencias?\nEsta acciÃ³n no se puede deshacer.')) {
    return;
  }
  
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;
  
  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  const tasks = JSON.parse(ganttContainer.dataset.tasks || '[]');
  
  // Limpiar todas las dependencias en las tareas transformadas
  tasks.forEach(task => {
    task.dependencies = [];
  });
  
  // Actualizar proyecto en la variable global
  if (projects[projectIndex]) {
    projects[projectIndex].tasks.forEach(task => {
      task.dependencies = [];
    });
  }
  
  // Guardar cambios
  ganttContainer.dataset.tasks = JSON.stringify(tasks);
  
  // Actualizar visualizaciÃ³n
  refreshGanttView();
  
  alert('âœ… Todas las dependencias han sido eliminadas.');
};

// 13. FUNCIONES AUXILIARES
function refreshDependenciesView() {
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;
  
  const tasks = JSON.parse(ganttContainer.dataset.tasks || '[]');
  
  // Actualizar contador de dependencias
  const tasksWithDeps = tasks.filter(t => t.dependencies && t.dependencies.length > 0).length;
  const footer = ganttContainer.querySelector('div[style*="background: rgba(255, 255, 255, 0.05)"]');
  if (footer) {
    const depsSpan = Array.from(footer.querySelectorAll('span')).find(span => 
      span.textContent.includes('Dependencias')
    );
    if (depsSpan) {
      depsSpan.textContent = `Dependencias (${tasksWithDeps})`;
    }
  }
  
  // Actualizar sidebar (dependencias)
  const dependenciesSection = ganttContainer.querySelector('.kpi-card[style*="background: rgba(155, 89, 182, 0.1)"]');
  if (dependenciesSection) {
    const depsCountSpan = dependenciesSection.querySelector('div[style*="color: #9b59b6"]');
    if (depsCountSpan) {
      depsCountSpan.textContent = `${tasksWithDeps} tareas con dependencias`;
    }
    
    // Actualizar lista de dependencias
    const depsList = dependenciesSection.querySelector('div[style*="max-height: 120px"]');
    if (depsList) {
      const newDepsHTML = generateDependenciesList(tasks);
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = newDepsHTML;
      const newContent = tempDiv.firstElementChild;
      if (newContent) {
        depsList.parentNode.replaceChild(newContent, depsList);
      }
    }
  }
  
  // Volver a dibujar las lÃ­neas de dependencia
  setTimeout(() => {
    const oldSvg = document.querySelector('#premiumTasksContainer svg');
    if (oldSvg) oldSvg.remove();
    drawPremiumDependenciesComplete(tasks);
  }, 100);
}

function refreshGanttView() {
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;
  
  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  
  // Guardar el Ã­ndice del proyecto actual
  const savedIndex = currentProjectIndex;
  currentProjectIndex = projectIndex;
  
  ganttContainer.remove();
  createCompleteGanttForCurrentProject();
  
  // Restaurar el Ã­ndice
  currentProjectIndex = savedIndex;
}

function closeDependencyCreator() {
  document.querySelector('.dependency-overlay')?.remove();
  document.querySelector('.dependency-modal')?.remove();
}

function closeCriticalModal() {
  document.querySelector('.dependency-overlay')?.remove();
  document.querySelector('.dependency-modal')?.remove();
}

// 14. FUNCIONES RESTAURADAS DEL MENÃš LATERAL
function getCriticalTasksDetails(tasks) {
  const critical = tasks.filter(t => t.critical);
  if (critical.length === 0) return 'No hay tareas crÃ­ticas';
  
  const names = critical.slice(0, 3).map(t => t.name);
  let result = names.join(', ');
  if (critical.length > 3) result += ` y ${critical.length - 3} mÃ¡s`;
  return result;
}

function calculatePredictedEndDatePremium(tasks) {
  if (tasks.length === 0) return 'No hay datos';
  
  const today = new Date();
  const maxEndDay = Math.max(...tasks.map(t => t.startDay + t.duration));
  const predictedDate = new Date(today);
  predictedDate.setDate(predictedDate.getDate() + maxEndDay);
  
  return predictedDate.toLocaleDateString('es-ES', {
    day: '2-digit',
    month: 'short',
    year: 'numeric'
  });
}

function countTeamMembers(tasks) {
  const members = new Set();
  tasks.forEach(task => {
    if (task.team && task.team.length > 0) {
      task.team.forEach(member => members.add(member));
    }
  });
  return members.size;
}

function generateTeamDistribution(tasks) {
  const memberTasks = {};
  tasks.forEach(task => {
    task.team.forEach(member => {
      if (!memberTasks[member]) memberTasks[member] = 0;
      memberTasks[member]++;
    });
  });
  
  const topMembers = Object.entries(memberTasks)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 3);
  
  if (topMembers.length === 0) return '<div style="color: #95a5a6; font-size: 12px;">Sin asignaciones</div>';
  
  return topMembers.map(([member, count]) => `
    <div style="margin-bottom: 10px;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
        <span style="color: white; font-size: 13px;">${member}</span>
        <span style="color: #3498db; font-size: 13px;">${count} tareas</span>
      </div>
      <div style="height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden;">
        <div style="width: ${(count / Math.max(...Object.values(memberTasks)) * 100)}%; height: 100%; background: #3498db; border-radius: 2px;"></div>
      </div>
    </div>
  `).join('');
}

// 15. FUNCIONES DE BOTONES DEL HEADER
window.toggleMobileViewPremium = function() {
  const gantt = document.getElementById('premiumExecutiveGantt');
  if (gantt) {
    gantt.classList.toggle('mobile-view');
    alert(gantt.classList.contains('mobile-view') ? 
      'ğŸ“± Vista mÃ³vil activada' : 'ğŸ–¥ï¸ Vista desktop activada');
  }
};

// ğŸ”¥ REEMPLAZAR ESTA FUNCIÃ“N EXISTENTE
window.showBurnDownChartPremium = function() {
  console.log('ğŸ“‰ ACTIVANDO BURNDOWN CHART PREMIUM...');
  
  // 1. Obtener datos reales del Gantt
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) {
    alert('âŒ Por favor, abre el Gantt Ejecutivo primero');
    console.error('Gantt no encontrado');
    return;
  }
  
  // 2. Extraer datos del proyecto actual
  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  const projectName = ganttContainer.dataset.projectName || 'Proyecto actual';
  const tasks = JSON.parse(ganttContainer.dataset.tasks || '[]');
  
  console.log(`ğŸ“Š Generando Burndown para: ${projectName} (${tasks.length} tareas)`);
  
  // 3. Calcular datos para burndown
  const burndownData = calculateBurndownFromTasks(tasks);
  
  // 4. Crear modal premium
  createBurndownModal(projectName, burndownData, tasks);
  
  // 5. Agregar estilos si no existen
  addExecutiveDashboardStyles();
};
window.showAIPredictorPremium = function() {
  alert('ğŸ¤– Predictor IA activado\n\nAnalizando:\nâ€¢ Tendencias de progreso\nâ€¢ Riesgos potenciales\nâ€¢ Recomendaciones de optimizaciÃ³n');
};

window.switchProjectPremium = function() {
  const gantt = document.getElementById('premiumExecutiveGantt');
  if (gantt) gantt.remove();
  createProjectSelector();
};

window.exportGanttData = function() {
  alert('ğŸ“¤ Exportando datos...\n\nFormatos disponibles:\nâ€¢ PDF\nâ€¢ Excel\nâ€¢ PNG\nâ€¢ JSON');
};

window.runAIAnalysisPremium = function() {
  alert('ğŸ§  Ejecutando anÃ¡lisis predictivo IA...\n\nAnalizando patrones histÃ³ricos y tendencias.');
};

window.filterCriticalTasksPremium = function() {
  alert('ğŸ”´ Filtrando tareas crÃ­ticas...');
};

window.filterDelayedTasksPremium = function() {
  alert('âš¡ Filtrando tareas atrasadas...');
};

window.filterByTeamPremium = function() {
  alert('ğŸ‘¥ Filtrando por equipo...');
};

window.filterByBudgetPremium = function() {
  alert('ğŸ’° Filtrando por presupuesto...');
};

window.showAllTasksPremium = function() {
  alert('ğŸ“‹ Mostrando todas las tareas...');
};

window.showPremiumTaskDetails = function(taskId) {
  const container = document.getElementById('premiumExecutiveGantt');
  const tasks = container ? JSON.parse(container.dataset.tasks || '[]') : [];
  const task = tasks.find(t => t.id.toString() === taskId.toString());
  
  if (task) {
    alert(`ğŸ“‹ ${task.name}\n\n` +
          `Progreso: ${task.progress}%\n` +
          `DuraciÃ³n: ${task.duration} dÃ­as\n` +
          `Estado: ${task.status}\n` +
          `Prioridad: ${task.priority}\n` +
          `Asignado: ${task.team[0]}\n` +
          `${task.critical ? 'ğŸ”¥ TAREA CRÃTICA' : ''}`);
  }
};

window.updatePremiumTaskProgress = function(taskId) {
  const newProgress = prompt('Ingrese nuevo progreso (0-100%):');
  if (newProgress !== null && !isNaN(newProgress)) {
    const progress = Math.min(100, Math.max(0, parseInt(newProgress)));
    alert(`Progreso actualizado a ${progress}%`);
  }
};

// 16. FUNCIONES AUXILIARES DE ESTILOS
function addPremiumStyles() {
  const styles = document.createElement('style');
  styles.textContent = `
    @keyframes premiumFadeIn {
      from {
        opacity: 0;
        transform: translate(-50%, -48%) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }
    
    .premium-task:hover {
      transform: translateY(-3px) !important;
      box-shadow: 0 15px 30px rgba(0,0,0,0.4) !important;
    }
    
    .premium-btn:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3) !important;
    }
    
    .kpi-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    }
    
    .active-btn {
      opacity: 1 !important;
      cursor: pointer !important;
    }
    
    /* Estilos para scroll horizontal */
    #premiumTasksContainer::-webkit-scrollbar {
      height: 8px;
      width: 8px;
    }
    
    #premiumTasksContainer::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
    }
    
    #premiumTasksContainer::-webkit-scrollbar-thumb {
      background: rgba(52, 152, 219, 0.5);
      border-radius: 4px;
    }
    
    #premiumTasksContainer::-webkit-scrollbar-thumb:hover {
      background: rgba(52, 152, 219, 0.7);
    }
  `;
  document.head.appendChild(styles);
}

function updateProjectSelector() {
  document.querySelectorAll('.project-option').forEach((option, index) => {
    const isSelected = index === currentProjectIndex;
    option.style.background = isSelected ? 'rgba(52, 152, 219, 0.2)' : 'rgba(255,255,255,0.05)';
    option.style.border = `1px solid ${isSelected ? '#3498db' : 'rgba(255,255,255,0.1)'}`;
    const checkmark = option.querySelector('div > div:last-child');
    checkmark.style.background = isSelected ? '#3498db' : 'rgba(255,255,255,0.1)';
    checkmark.style.color = isSelected ? 'white' : 'transparent';
  });
}

function getProjectProgress(project) {
  if (!project.tasks || project.tasks.length === 0) return 0;
  const completed = project.tasks.filter(t => t.status === 'completed').length;
  return Math.round((completed / project.tasks.length) * 100);
}

function createSampleProjects() {
  if (typeof projects === 'undefined') {
    window.projects = [];
    window.currentProjectIndex = 0;
  }
  
  const sampleProjects = [
    {
      name: "Proyecto Alpha",
      description: "Desarrollo de sistema principal",
      tasks: [
        {
          id: 1,
          name: "AnÃ¡lisis de requisitos",
          startDate: new Date().toISOString().split('T')[0],
          deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          status: "completed",
          priority: "alta",
          estimatedTime: 40,
          timeLogged: 40,
          assignee: "Ana GarcÃ­a",
          dependencies: []
        },
        {
          id: 2,
          name: "DiseÃ±o de arquitectura",
          startDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          deadline: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          status: "inProgress",
          priority: "alta",
          estimatedTime: 60,
          timeLogged: 30,
          assignee: "Carlos LÃ³pez",
          dependencies: [1]
        }
      ]
    },
    {
      name: "Proyecto Beta",
      description: "Sitio web corporativo",
      tasks: [
        {
          id: 3,
          name: "DiseÃ±o UI/UX",
          startDate: new Date().toISOString().split('T')[0],
          deadline: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          status: "inProgress",
          priority: "media",
          estimatedTime: 30,
          timeLogged: 15,
          assignee: "MarÃ­a RodrÃ­guez",
          dependencies: []
        },
        {
          id: 4,
          name: "Desarrollo Frontend",
          startDate: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          deadline: new Date(Date.now() + 12 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          status: "pending",
          priority: "alta",
          estimatedTime: 50,
          timeLogged: 0,
          assignee: "Pedro MartÃ­nez",
          dependencies: [3]
        }
      ]
    }
  ];
  
  if (projects.length === 0) {
    projects.push(...sampleProjects);
    currentProjectIndex = 0;
  }
  
  setTimeout(() => {
    createPremiumGanttWithYourData();
  }, 100);
}

// ========== INICIAR ==========
createPremiumGanttWithYourData();





// ========== FUNCIONES AUXILIARES QUE FALTAN ==========

// 1. FunciÃ³n para obtener detalles de tareas crÃ­ticas
function getCriticalTasksDetails(tasks) {
  const critical = tasks.filter(t => t.critical);
  if (critical.length === 0) return 'No hay tareas crÃ­ticas';
  
  const names = critical.slice(0, 3).map(t => t.name);
  let result = names.join(', ');
  if (critical.length > 3) result += ` y ${critical.length - 3} mÃ¡s`;
  return result;
}

// 2. FunciÃ³n para calcular fecha estimada de finalizaciÃ³n
function calculatePredictedEndDatePremium(tasks) {
  if (tasks.length === 0) return 'No hay datos';
  
  const today = new Date();
  const maxEndDay = Math.max(...tasks.map(t => t.startDay + t.duration));
  const predictedDate = new Date(today);
  predictedDate.setDate(predictedDate.getDate() + maxEndDay);
  
  return predictedDate.toLocaleDateString('es-ES', {
    day: '2-digit',
    month: 'short',
    year: 'numeric'
  });
}

// 3. FunciÃ³n para contar miembros del equipo
function countTeamMembers(tasks) {
  const members = new Set();
  tasks.forEach(task => {
    if (task.team && task.team.length > 0) {
      task.team.forEach(member => members.add(member));
    }
  });
  return members.size;
}

// 4. FunciÃ³n para generar distribuciÃ³n del equipo
function generateTeamDistribution(tasks) {
  const memberTasks = {};
  tasks.forEach(task => {
    task.team.forEach(member => {
      if (!memberTasks[member]) memberTasks[member] = 0;
      memberTasks[member]++;
    });
  });
  
  const topMembers = Object.entries(memberTasks)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 3);
  
  if (topMembers.length === 0) return '<div style="color: #95a5a6; font-size: 12px;">Sin asignaciones</div>';
  
  return topMembers.map(([member, count]) => `
    <div style="margin-bottom: 10px;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
        <span style="color: white; font-size: 13px;">${member}</span>
        <span style="color: #3498db; font-size: 13px;">${count} tareas</span>
      </div>
      <div style="height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden;">
        <div style="width: ${(count / Math.max(...Object.values(memberTasks)) * 100)}%; height: 100%; background: #3498db; border-radius: 2px;"></div>
      </div>
    </div>
  `).join('');
}








function drawDependencies() {
  const layer = document.getElementById("dependencyLayer");
  if (!layer) return;

  layer.innerHTML = ""; // limpiar

  const container = document.querySelector("#premiumTasksContainer").getBoundingClientRect();

  executiveTasks.forEach(task => {
    if (!task.dependencies || task.dependencies.length === 0) return;

    task.dependencies.forEach(depId => {
      const tA = document.querySelector(`.premium-task[data-task-id="${depId}"]`);
      const tB = document.querySelector(`.premium-task[data-task-id="${task.id}"]`);

      if (!tA || !tB) return;

      const barA = tA.children[1]?.getBoundingClientRect();
      const barB = tB.children[1]?.getBoundingClientRect();

      if (!barA || !barB) return;

      // offset EXACTO probado en consola
      const sx = (barA.right - container.left) - 45;
      const sy = (barA.top + barA.height / 2) - container.top;

      const ex = (barB.left - container.left) + 45;
      const ey = (barB.top + barB.height / 2) - container.top;

      const cx = (sx + ex) / 2;

      const d = `
        M ${sx} ${sy}
        C ${cx} ${sy},
          ${cx} ${ey},
          ${ex} ${ey}
      `;

      layer.innerHTML += `
        <svg width="100%" height="100%" style="position:absolute; overflow:visible;">
          <path d="${d}" stroke="lime" stroke-width="3" fill="none"></path>
          <circle cx="${ex}" cy="${ey}" r="5" fill="lime"></circle>
        </svg>
      `;
    });
  });
}



// ===== SOLUCIÃ“N PERMANENTE PARA REDIMENSIONAMIENTO DE CALENDARIO =====
function setupCalendarResizeSolution() {
    const sidebar = document.querySelector('aside');
    const toggleBtn = document.getElementById('toggleSidebarBtn');
    
    if (!sidebar || !toggleBtn) {
        console.log('â³ Elementos no encontrados, reintentando...');
        setTimeout(setupCalendarResizeSolution, 1000);
        return;
    }
    
    // Reemplazar el botÃ³n completamente para evitar conflictos
    const newToggleBtn = toggleBtn.cloneNode(true);
    toggleBtn.parentNode.replaceChild(newToggleBtn, toggleBtn);
    
    newToggleBtn.addEventListener('click', function() {
        console.log('ğŸ¯ BotÃ³n menÃº - Redimensionando calendario...');
        
        // 1. Toggle del sidebar
        sidebar.classList.toggle('hidden');
        
        // 2. Redimensionamiento agresivo del calendario
        setTimeout(() => {
            if (window.calendarInstance) {
                // MÃ©todo comprobado que funciona
                const currentDate = window.calendarInstance.getDate();
                const currentView = window.calendarInstance.view.type;
                
                // Render forzado
                window.calendarInstance.render();
                
                // Cambio temporal de vista (mÃ©todo que funciona)
                setTimeout(() => {
                    window.calendarInstance.changeView('timeGridWeek');
                    setTimeout(() => {
                        window.calendarInstance.changeView(currentView);
                        window.calendarInstance.gotoDate(currentDate);
                        window.calendarInstance.updateSize();
                    }, 50);
                }, 100);
                
                console.log('âœ… Calendario redimensionado correctamente');
            }
        }, 400);
        
        // Tu cÃ³digo existente para lÃ­neas y Gantt
        setTimeout(() => {
            syncLinesWithSidebar();
            if (!ganttView.classList.contains('hidden')) {
                renderGanttChart();
            }
        }, 100);
    });
    
    console.log('âœ… SoluciÃ³n permanente de calendario configurada');
}

// Inicializar cuando todo estÃ© listo
setTimeout(setupCalendarResizeSolution, 3000);



// ===== ACTUALIZACIÃ“N AUTOMÃTICA DEL CALENDARIO =====
function setupCalendarAutoRefresh() {
    // Actualizar calendario cuando cambian los datos
    const originalUpdateLocalStorage = window.updateLocalStorage;
    if (originalUpdateLocalStorage) {
        window.updateLocalStorage = function() {
            originalUpdateLocalStorage.apply(this, arguments);
            refreshCalendar();
        };
    }
    
    // Actualizar calendario cuando se crean/editan tareas
    const originalCreateNewTask = window.createNewTask;
    if (originalCreateNewTask) {
        window.createNewTask = function(e) {
            const result = originalCreateNewTask.apply(this, arguments);
            setTimeout(refreshCalendar, 500);
            return result;
        };
    }
    
    // Actualizar calendario cuando se guardan cambios de tareas
    const originalSaveTaskChanges = window.saveTaskChanges;
    if (originalSaveTaskChanges) {
        window.saveTaskChanges = function(taskId) {
            originalSaveTaskChanges.apply(this, arguments);
            setTimeout(refreshCalendar, 500);
        };
    }
    
    console.log('âœ… ActualizaciÃ³n automÃ¡tica del calendario configurada');
}

// FunciÃ³n para refrescar el calendario
function refreshCalendar() {
    if (window.calendarInstance) {
        // MÃ©todo suave para actualizar eventos
        window.calendarInstance.refetchEvents();
        console.log('ğŸ”„ Calendario actualizado automÃ¡ticamente');
    }
}

// Inicializar
setTimeout(setupCalendarAutoRefresh, 4000);






function enableTaskTooltips() {
  let tooltip = document.getElementById("premium-tooltip");

  if (!tooltip) {
    tooltip = document.createElement("div");
    tooltip.id = "premium-tooltip";
    tooltip.style.cssText = `
      position: fixed;
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 12px;
      pointer-events: none;
      z-index: 99999;
      opacity: 0;
      transition: opacity .15s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
      white-space: nowrap;
    `;
    document.body.appendChild(tooltip);
  }

  document.querySelectorAll(".premium-task").forEach(taskEl => {

    taskEl.addEventListener("mouseenter", e => {
      const name = taskEl.querySelector("div div div")?.innerText || "â€”";
      const duration = taskEl.querySelector("[style*='width:']")?.innerText || "";
      const deps = taskEl.querySelector("span")?.innerText || "";

      tooltip.innerHTML = `
        <strong>${name}</strong><br>
        â± ${duration}<br>
        ${deps}
      `;

      tooltip.style.opacity = "1";
    });

    taskEl.addEventListener("mousemove", e => {
  tooltip.style.left = e.pageX + 15 + "px";
  tooltip.style.top  = e.pageY + 15 + "px";
});


    taskEl.addEventListener("mouseleave", () => {
      tooltip.style.opacity = "0";
    });
  });

  console.log("âœ… Tooltips hover reales activados");
}



// ============================================================================
// ğŸ“ˆ DASHBOARD EJECUTIVO - BURNDOWN CHART & MÃ‰TRICAS
// ============================================================================

// ğŸ”¥ FUNCIÃ“N: Calcular datos de burndown desde tareas reales
function calculateBurndownFromTasks(tasks) {
  console.log('ğŸ§® Calculando datos de burndown...');
  
  // Si no hay tareas, crear datos de ejemplo
  if (!tasks || tasks.length === 0) {
    console.log('âš ï¸ Sin tareas, usando datos de ejemplo');
    tasks = [
      { name: 'Tarea de ejemplo', duration: 5, progress: 100, critical: false },
      { name: 'Tarea crÃ­tica', duration: 8, progress: 50, critical: true }
    ];
  }
  
  // Supongamos 10 semanas de proyecto
  const totalWeeks = 10;
  const totalStoryPoints = tasks.reduce((sum, task) => sum + (task.duration || 1), 0);
  
  // LÃ­nea ideal (burn linear)
  const idealLine = [];
  const idealBurnRate = totalStoryPoints / totalWeeks;
  
  for (let week = 0; week <= totalWeeks; week++) {
    idealLine.push(Math.max(0, totalStoryPoints - (idealBurnRate * week)));
  }
  
  // LÃ­nea real (basada en progreso)
  const realLine = [];
  const completedStoryPoints = tasks.reduce((sum, task) => 
    sum + ((task.progress || 0) / 100) * (task.duration || 1), 0
  );
  
  // Calcular velocidad real basada en progreso
  const weeksElapsed = totalWeeks * 0.6; // Asumir 60% del tiempo transcurrido
  const actualBurnRate = weeksElapsed > 0 ? completedStoryPoints / weeksElapsed : idealBurnRate * 0.7;
  const remainingPoints = totalStoryPoints - completedStoryPoints;
  
  for (let week = 0; week <= totalWeeks; week++) {
    if (week <= weeksElapsed) {
      // Ya transcurrido
      realLine.push(Math.max(0, totalStoryPoints - (actualBurnRate * week)));
    } else {
      // ProyecciÃ³n
      const projected = Math.max(0, remainingPoints - (actualBurnRate * (week - weeksElapsed)));
      realLine.push(projected);
    }
  }
  
  // Scope creep (cambios de alcance)
  const scopeCreep = [];
  const creepPerWeek = (totalStoryPoints * 0.03); // 3% de creep por semana
  for (let week = 0; week <= totalWeeks; week++) {
    scopeCreep.push(Math.min(totalStoryPoints * 1.5, creepPerWeek * week));
  }
  
  return {
    semanas: Array.from({length: totalWeeks + 1}, (_, i) => i),
    trabajoIdeal: idealLine,
    trabajoReal: realLine,
    scopeCreep: scopeCreep,
    totalStoryPoints,
    completedStoryPoints,
    remainingPoints,
    burnRateIdeal: idealBurnRate.toFixed(1),
    burnRateActual: actualBurnRate.toFixed(1),
    efficiency: ((actualBurnRate / idealBurnRate) * 100).toFixed(1),
    weeksElapsed: weeksElapsed.toFixed(1)
  };
}






// ğŸ”¥ FUNCIÃ“N: Crear modal de Burndown
function createBurndownModal(projectName, burndownData, tasks) {
  console.log('ğŸ¨ Creando modal de Burndown...');
  
  // Si ya existe, removerlo
  document.querySelector('.executive-overlay')?.remove();
  
  // Crear overlay
  const overlay = document.createElement('div');
  overlay.className = 'executive-overlay';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    z-index: 1000000;
    display: flex;
    align-items: center;
    justify-content: center;
  `;
  
  // Crear modal premium
  const modal = document.createElement('div');
  modal.className = 'executive-modal';
  modal.style.cssText = `
    width: 90vw;
    height: 85vh;
    background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
    border-radius: 24px;
    box-shadow: 0 40px 80px rgba(0,0,0,0.8);
    border: 2px solid rgba(52, 152, 219, 0.3);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    position: relative;
  `;
  
  // Header del modal
  modal.innerHTML = `
    <div style="
      padding: 25px 35px;
      background: linear-gradient(90deg, #0a0a1a, #1a1a3a);
      border-bottom: 1px solid rgba(52, 152, 219, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    ">
      <div>
        <h2 style="margin: 0 0 8px 0; color: white; font-size: 28px;">
          ğŸ“‰ <span style="color: #2ecc71;">Burndown Chart</span> - ${projectName}
        </h2>
        <p style="margin: 0; color: #95a5a6; font-size: 14px;">
          AnÃ¡lisis ejecutivo de progreso vs tiempo â€¢ Actualizado: ${new Date().toLocaleTimeString()}
        </p>
      </div>
      <button onclick="this.closest('.executive-overlay').remove()" style="
        background: rgba(231, 76, 60, 0.2);
        border: 1px solid #e74c3c;
        color: #e74c3c;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        transition: all 0.3s;
      " onmouseover="this.style.background='rgba(231, 76, 60, 0.4)'"
         onmouseout="this.style.background='rgba(231, 76, 60, 0.2)'">
        Ã— Cerrar
      </button>
    </div>
    
    <div style="flex: 1; display: flex; overflow: hidden;">
      <!-- Panel izquierdo: GrÃ¡fico -->
      <div style="flex: 2; padding: 25px; display: flex; flex-direction: column;">
        <div style="
          background: rgba(255,255,255,0.03);
          border-radius: 16px;
          padding: 20px;
          flex: 1;
          display: flex;
          flex-direction: column;
          margin-bottom: 20px;
          border: 1px solid rgba(255,255,255,0.1);
          min-height: 400px;
        ">
          <div style="color: white; font-size: 18px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
            <span style="color: #3498db;">ğŸ“Š</span> Progreso del Proyecto (Story Points)
          </div>
          <div style="flex: 1; position: relative; min-height: 300px;">
            <canvas id="burndownChartCanvas" width="800" height="400"></canvas>
          </div>
        </div>
        
        <!-- Mini KPIs debajo del grÃ¡fico -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
          <div style="
            background: rgba(46, 204, 113, 0.1);
            border: 1px solid rgba(46, 204, 113, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
          ">
            <div style="color: #2ecc71; font-size: 24px; font-weight: bold; margin-bottom: 5px;">
              ${burndownData.completedStoryPoints}/${burndownData.totalStoryPoints}
            </div>
            <div style="color: #95a5a6; font-size: 12px;">Puntos Completados</div>
          </div>
          
          <div style="
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
          ">
            <div style="color: #3498db; font-size: 24px; font-weight: bold; margin-bottom: 5px;">
              ${burndownData.burnRateActual}
            </div>
            <div style="color: #95a5a6; font-size: 12px;">Velocidad (pts/semana)</div>
          </div>
          
          <div style="
            background: rgba(243, 156, 18, 0.1);
            border: 1px solid rgba(243, 156, 18, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
          ">
            <div style="color: #f39c12; font-size: 24px; font-weight: bold; margin-bottom: 5px;">
              ${burndownData.efficiency}%
            </div>
            <div style="color: #95a5a6; font-size: 12px;">Eficiencia vs Plan</div>
          </div>
          
          <div style="
            background: rgba(155, 89, 182, 0.1);
            border: 1px solid rgba(155, 89, 182, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
          ">
            <div style="color: #9b59b6; font-size: 24px; font-weight: bold; margin-bottom: 5px;">
              ${Math.round(burndownData.remainingPoints / burndownData.burnRateActual)}w
            </div>
            <div style="color: #95a5a6; font-size: 12px;">Semanas Restantes</div>
          </div>
        </div>
      </div>
      





      <!-- Panel derecho: AnÃ¡lisis y mÃ©tricas -->
      <div style="flex: 1; padding: 25px; border-left: 1px solid rgba(255,255,255,0.1);">
        <div style="margin-bottom: 30px;">
          <h3 style="color: white; margin: 0 0 20px 0; font-size: 20px; display: flex; align-items: center; gap: 10px;">
            <span style="color: #e74c3c;">ğŸ“‹</span> AnÃ¡lisis Ejecutivo
          </h3>
          
          <div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
              <div style="
                width: 12px;
                height: 12px;
                background: ${parseFloat(burndownData.efficiency) >= 100 ? '#2ecc71' : 
                             parseFloat(burndownData.efficiency) >= 80 ? '#f1c40f' : '#e74c3c'};
                border-radius: 50%;
                margin-right: 10px;
              "></div>
              <span style="color: white; font-weight: bold;">Estado del Proyecto</span>
            </div>
            <div style="color: #95a5a6; font-size: 14px; line-height: 1.5;">
              ${getProjectStatusAnalysis(burndownData, tasks)}
            </div>
          </div>
          
          <div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 20px;">
            <div style="color: white; font-weight: bold; margin-bottom: 15px;">ğŸ“Œ Recomendaciones</div>
            <div style="color: #95a5a6; font-size: 14px;">
              <ul style="margin: 0; padding-left: 20px;">
                ${getRecommendations(burndownData, tasks).map(rec => 
                  `<li style="margin-bottom: 8px;">${rec}</li>`
                ).join('')}
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Tareas CrÃ­ticas -->
        <div>
          <h3 style="color: white; margin: 0 0 15px 0; font-size: 18px; display: flex; align-items: center; gap: 10px;">
            <span style="color: #e74c3c;">ğŸ”¥</span> Tareas CrÃ­ticas Pendientes
          </h3>
          <div style="max-height: 200px; overflow-y: auto;">
            ${tasks.filter(t => t.critical && (t.progress || 0) < 100)
              .map((task, index) => `
                <div style="
                  background: rgba(231, 76, 60, 0.1);
                  border: 1px solid rgba(231, 76, 60, 0.3);
                  border-radius: 8px;
                  padding: 12px;
                  margin-bottom: 10px;
                ">
                  <div style="color: white; font-weight: bold; margin-bottom: 5px;">
                    ${index + 1}. ${task.name}
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #95a5a6; font-size: 12px;">Progreso: ${task.progress || 0}%</span>
                    <span style="color: #f39c12; font-size: 12px;">${task.duration || 0} dÃ­as</span>
                  </div>
                </div>
              `).join('') || 
              '<div style="color: #95a5a6; text-align: center; padding: 20px; font-style: italic;">No hay tareas crÃ­ticas pendientes</div>'
            }
          </div>
        </div>
      </div>
    </div>
    







    <!-- Footer -->
    <div style="
      padding: 15px 35px;
      background: rgba(255,255,255,0.03);
      border-top: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #95a5a6;
      font-size: 13px;
    ">
      <div>
        <span>ğŸ“Š MÃ©tricas calculadas automÃ¡ticamente desde ${tasks.length} tareas</span>
      </div>
      <div style="display: flex; gap: 20px;">
        <button onclick="exportBurndownChart()" style="
          background: rgba(52, 152, 219, 0.2);
          border: 1px solid #3498db;
          color: #3498db;
          padding: 8px 15px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 12px;
        ">
          ğŸ“¥ Exportar como PNG
        </button>
        <button onclick="generateExecutiveReport()" style="
          background: rgba(46, 204, 113, 0.2);
          border: 1px solid #2ecc71;
          color: #2ecc71;
          padding: 8px 15px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 12px;
        ">
          ğŸ“„ Generar Reporte PDF
        </button>
      </div>
    </div>
  `;
  
  // Agregar al DOM
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  
  // Renderizar grÃ¡fico despuÃ©s de que el DOM estÃ© listo
  // Renderizar grÃ¡fico con mÃºltiples intentos
function renderChartWithRetry(attempt = 1) {
  if (attempt > 3) {
    console.error('âŒ FallÃ³ despuÃ©s de 3 intentos');
    return;
  }
  
  setTimeout(() => {
    console.log(`ğŸ”„ Intentando renderizar grÃ¡fico (intento ${attempt}/3)...`);
    renderBurndownChart(burndownData);
    
    // Verificar si se creÃ³ el grÃ¡fico
    setTimeout(() => {
      if (!window.burndownChartInstance) {
        console.log('âš ï¸ GrÃ¡fico no creado, reintentando...');
        renderChartWithRetry(attempt + 1);
      }
    }, 500);
  }, 200 * attempt);
}

renderChartWithRetry(1);
  
  console.log('âœ… Modal de Burndown creado exitosamente');
}











// ğŸ”¥ FUNCIÃ“N: Renderizar grÃ¡fico con Chart.js
function renderBurndownChart(burndownData) {
  console.log('ğŸ¨ Iniciando renderizado de grÃ¡fico...');
  
  const canvas = document.getElementById('burndownChartCanvas');
  if (!canvas) {
    console.error('âŒ Canvas no encontrado');
    return;
  }
  
  // FORZAR DIMENSIONES DE MANERA AGRESIVA
  const container = canvas.parentElement;
  if (container) {
    container.style.minHeight = '350px';
    container.style.height = '350px';
  }
  
  canvas.width = canvas.offsetWidth || 800;
  canvas.height = canvas.offsetHeight || 400;
  canvas.style.display = 'block';
  canvas.style.visibility = 'visible';
  
  console.log('ğŸ“ Canvas preparado:', canvas.width, 'x', canvas.height);
  
  // DESTRUIR CUALQUIER INSTANCIA PREVIA
  if (window.burndownChartInstance) {
    console.log('ğŸ—‘ï¸ Destruyendo instancia previa...');
    window.burndownChartInstance.destroy();
    window.burndownChartInstance = null;
  }
  
  // LIMPIAR CONTEXTO
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // ESPERAR UN FRAME PARA ASEGURAR QUE EL DOM ESTÃ‰ LISTO
  requestAnimationFrame(() => {
    try {
      console.log('ğŸ“Š Creando nuevo grÃ¡fico...');
      
      window.burndownChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: burndownData.semanas.map(w => `Sem ${w}`),
          datasets: [
            {
              label: 'ğŸ“ˆ LÃ­nea Ideal',
              data: burndownData.trabajoIdeal,
              borderColor: '#2ecc71',
              backgroundColor: 'transparent',
              borderWidth: 3,
              fill: false,
              tension: 0,
              pointRadius: 0,
              borderDash: [5, 5]
            },
            {
              label: 'ğŸ“Š Progreso Real',
              data: burndownData.trabajoReal,
              borderColor: '#3498db',
              backgroundColor: 'rgba(52, 152, 219, 0.15)',
              borderWidth: 4,
              fill: true,
              tension: 0.2,
              pointRadius: 5,
              pointBackgroundColor: '#3498db',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2
            },
            {
              label: 'âš ï¸ Scope Creep',
              data: burndownData.scopeCreep,
              borderColor: '#e74c3c',
              backgroundColor: 'rgba(231, 76, 60, 0.1)',
              borderWidth: 2,
              borderDash: [8, 4],
              fill: false,
              tension: 0,
              pointRadius: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 1000,
            easing: 'easeOutQuart'
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: '#95a5a6',
                font: {
                  size: 13,
                  weight: 'bold'
                },
                padding: 20,
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(10, 10, 26, 0.95)',
              titleColor: '#3498db',
              bodyColor: '#ecf0f1',
              borderColor: '#3498db',
              borderWidth: 1,
              cornerRadius: 8,
              padding: 12,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label = label.replace(/[ğŸ“ˆğŸ“Šâš ï¸]/g, '').trim() + ': ';
                  }
                  label += context.parsed.y.toFixed(1) + ' story points';
                  return label;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                color: 'rgba(255, 255, 255, 0.08)',
                drawBorder: false
              },
              ticks: {
                color: '#95a5a6',
                font: {
                  size: 12
                },
                maxRotation: 0
              },
              title: {
                display: true,
                text: 'Semanas del Proyecto',
                color: '#95a5a6',
                font: {
                  size: 13,
                  weight: 'bold'
                },
                padding: { top: 10 }
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(255, 255, 255, 0.08)',
                drawBorder: false
              },
              ticks: {
                color: '#95a5a6',
                font: {
                  size: 12
                },
                callback: function(value) {
                  return value + ' pts';
                },
                padding: 5
              },
              title: {
                display: true,
                text: 'Story Points Restantes',
                color: '#95a5a6',
                font: {
                  size: 13,
                  weight: 'bold'
                },
                padding: { bottom: 10 }
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          },
          elements: {
            line: {
              tension: 0.2
            }
          }
        }
      });
      
      console.log('âœ… GrÃ¡fico Burndown renderizado exitosamente');
      
      // FORZAR ACTUALIZACIÃ“N
      setTimeout(() => {
        if (window.burndownChartInstance) {
          window.burndownChartInstance.update();
          console.log('ğŸ”„ GrÃ¡fico actualizado forzadamente');
        }
      }, 500);
      
    } catch (error) {
      console.error('âŒ Error creando grÃ¡fico:', error);
      
      // Mostrar mensaje de error en el canvas
      ctx.fillStyle = '#e74c3c';
      ctx.font = '16px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('Error al renderizar grÃ¡fico', canvas.width / 2, canvas.height / 2);
      ctx.font = '12px Arial';
      ctx.fillText(error.message, canvas.width / 2, canvas.height / 2 + 20);
    }
  });
}










// ğŸ”¥ FUNCIONES AUXILIARES
function getProjectStatusAnalysis(burndownData, tasks) {
  const efficiency = parseFloat(burndownData.efficiency);
  const criticalPending = tasks.filter(t => t.critical && (t.progress || 0) < 100).length;
  
  if (efficiency >= 100 && criticalPending === 0) {
    return 'âœ… PROYECTO EN CAMINO - Excelente rendimiento. Todas las mÃ©tricas estÃ¡n en verde. El equipo estÃ¡ superando las expectativas y las tareas crÃ­ticas estÃ¡n bajo control.';
  } else if (efficiency >= 80) {
    return 'ğŸŸ¡ PROYECTO EN RIESGO MODERADO - El rendimiento es aceptable pero hay Ã¡reas de mejora. ' + 
           (criticalPending > 0 ? `Existen ${criticalPending} tareas crÃ­ticas pendientes que requieren atenciÃ³n.` : '');
  } else {
    return 'ğŸ”´ PROYECTO EN RIESGO ALTO - Se requiere intervenciÃ³n ejecutiva. ' +
           `La eficiencia estÃ¡ en ${efficiency}% (debajo del 80% objetivo). ` +
           (criticalPending > 0 ? `${criticalPending} tareas crÃ­ticas estÃ¡n pendientes. ` : '') +
           'Se recomienda revisar recursos y planificaciÃ³n.';
  }
}

function getRecommendations(burndownData, tasks) {
  const recommendations = [];
  const efficiency = parseFloat(burndownData.efficiency);
  const criticalPending = tasks.filter(t => t.critical && (t.progress || 0) < 100).length;
  
  if (efficiency < 80) {
    recommendations.push('Revisar asignaciÃ³n de recursos del equipo');
    recommendations.push('Considerar extensiÃ³n de plazo o reducciÃ³n de alcance');
  }
  
  if (criticalPending > 0) {
    recommendations.push(`Priorizar las ${criticalPending} tareas crÃ­ticas pendientes`);
    recommendations.push('Asignar recursos senior a tareas crÃ­ticas');
  }
  
  if (burndownData.scopeCreep[burndownData.scopeCreep.length - 1] > 0) {
    recommendations.push('Congelar cambios de alcance hasta recuperar cronograma');
  }
  
  if (recommendations.length === 0) {
    recommendations.push('Mantener el ritmo actual - El proyecto va por buen camino');
  }
  
  return recommendations;
}

// ğŸ”¥ FUNCIONES DE EXPORTACIÃ“N
window.exportBurndownChart = function() {
  if (window.burndownChart) {
    const link = document.createElement('a');
    link.download = `burndown-${new Date().toISOString().slice(0,10)}.png`;
    link.href = window.burndownChart.toBase64Image();
    link.click();
    alert('ğŸ“¥ GrÃ¡fico exportado como PNG');
  }
};

window.generateExecutiveReport = function() {
  alert('ğŸ“„ Generando reporte ejecutivo PDF...\n\nEl reporte incluirÃ¡:\nâ€¢ GrÃ¡fico Burndown\nâ€¢ AnÃ¡lisis de mÃ©tricas\nâ€¢ Recomendaciones\nâ€¢ Tareas crÃ­ticas\n\n(FunciÃ³n en desarrollo)');
};

// ğŸ”¥ FUNCIÃ“N: Agregar estilos CSS
function addExecutiveDashboardStyles() {
  // Verificar si ya existen los estilos
  if (document.getElementById('executive-dashboard-styles')) {
    return;
  }
  
  const styles = document.createElement('style');
  styles.id = 'executive-dashboard-styles';
  styles.textContent = `
    /* Animaciones para el modal ejecutivo */
    .executive-overlay {
      animation: fadeIn 0.3s ease-out;
    }
    
    .executive-modal {
      animation: slideUp 0.4s cubic-bezier(0.22, 1, 0.36, 1);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    /* Estilos para scrollbars */
    .executive-modal ::-webkit-scrollbar {
      width: 8px;
    }
    
    .executive-modal ::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
    }
    
    .executive-modal ::-webkit-scrollbar-thumb {
      background: rgba(52, 152, 219, 0.5);
      border-radius: 4px;
    }
    
    .executive-modal ::-webkit-scrollbar-thumb:hover {
      background: rgba(52, 152, 219, 0.7);
    }
    
    /* Efectos hover para elementos interactivos */
    .executive-modal button {
      transition: all 0.3s ease;
    }
    
    .executive-modal button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
  `;
  document.head.appendChild(styles);
  console.log('âœ… Estilos ejecutivos agregados');
}

// ğŸ”¥ INICIALIZAR AL CARGAR LA PÃGINA
document.addEventListener('DOMContentLoaded', function() {
  console.log('ğŸ“ˆ Dashboard Ejecutivo - MÃ³dulo Burndown cargado');
  
  // Agregar estilos automÃ¡ticamente
  setTimeout(addExecutiveDashboardStyles, 1000);
});





// ===== SISTEMA VALOR GANADO (EVM) - AL LADO DE BURNDOWN =====

// 1. FunciÃ³n principal para crear el dashboard EVM
function crearDashboardEVMCompleto() {
  console.log('ğŸš€ CREANDO DASHBOARD EVM...');
  
  // Limpiar cualquier dashboard anterior
  const dashboardsAnteriores = [
    'dashboard-evm-completo',
    'dashboard-evm-final',
    'dashboard-letra-grande',
    'nuevo-dashboard-evm',
    'dashboard-profesional-evm'
  ];
  
  dashboardsAnteriores.forEach(id => {
    const elem = document.getElementById(id);
    if (elem) elem.remove();
  });
  
  // ===== CREAR NUEVO DASHBOARD EVM COMPLETO =====
  const dashboardHTML = `
  <div id="dashboard-evm-completo" style="
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: #0a0e17 !important;
    z-index: 99999 !important;
    font-family: 'Segoe UI', Arial, sans-serif !important;
    overflow: hidden !important;
  ">
    <!-- HEADER -->
    <div style="
      background: linear-gradient(135deg, #1a1f3c 0%, #0f1429 100%);
      padding: 25px 40px;
      border-bottom: 2px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    ">
      <div>
        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 10px;">
          <div style="
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
            padding: 15px;
            border-radius: 15px;
            font-size: 24px;
          ">
            ğŸ“ˆ
          </div>
          <div>
            <h1 style="
              margin: 0;
              color: white;
              font-size: 32px;
              font-weight: 800;
              letter-spacing: 0.5px;
            ">
              EARNED VALUE MANAGEMENT (EVM)
            </h1>
            <p style="
              margin: 8px 0 0 0;
              color: #8b9cc7;
              font-size: 16px;
              display: flex;
              align-items: center;
              gap: 20px;
            ">
              <span>ğŸ“Š Sistema de Valor Ganado</span>
              <span>ğŸ“… ${new Date().toLocaleDateString()}</span>
            </p>
          </div>
        </div>
      </div>
      
      <button onclick="document.getElementById('dashboard-evm-completo').remove()" style="
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        border: 2px solid rgba(239, 68, 68, 0.4);
        padding: 12px 24px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
      " onmouseover="this.style.background='rgba(239,68,68,0.4)';"
        onmouseout="this.style.background='rgba(239,68,68,0.2)';">
        âŒ Cerrar
      </button>
    </div>
    
    <!-- CONTENIDO PRINCIPAL -->
    <div style="
      padding: 30px;
      height: calc(100vh - 120px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 30px;
    ">
      <!-- FILA 1: GRÃFICO PRINCIPAL GRANDE -->
      <div style="
        background: rgba(26, 31, 60, 0.8);
        border-radius: 20px;
        padding: 30px;
        border: 2px solid rgba(255,255,255,0.15);
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        height: 500px;
      ">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
          <div>
            <h2 style="
              margin: 0 0 10px 0;
              color: white;
              font-size: 28px;
              font-weight: 700;
            ">
              ğŸ“ˆ GRÃFICO DE VALOR GANADO
            </h2>
            <p style="margin: 0; color: #8b9cc7; font-size: 16px;">
              AnÃ¡lisis comparativo de Valor Planificado (PV), Valor Ganado (EV) y Costo Real (AC)
            </p>
          </div>
          <div style="display: flex; gap: 15px;">
            <div style="
              display: flex;
              align-items: center;
              gap: 10px;
              background: rgba(59, 130, 246, 0.2);
              padding: 10px 20px;
              border-radius: 30px;
              border: 1px solid rgba(59, 130, 246, 0.4);
            ">
              <div style="width: 14px; height: 14px; background: #3b82f6; border-radius: 50%;"></div>
              <span style="color: white; font-weight: 600;">PV</span>
            </div>
            <div style="
              display: flex;
              align-items: center;
              gap: 10px;
              background: rgba(16, 185, 129, 0.2);
              padding: 10px 20px;
              border-radius: 30px;
              border: 1px solid rgba(16, 185, 129, 0.4);
            ">
              <div style="width: 14px; height: 14px; background: #10b981; border-radius: 50%;"></div>
              <span style="color: white; font-weight: 600;">EV</span>
            </div>
            <div style="
              display: flex;
              align-items: center;
              gap: 10px;
              background: rgba(239, 68, 68, 0.2);
              padding: 10px 20px;
              border-radius: 30px;
              border: 1px solid rgba(239, 68, 68, 0.4);
            ">
              <div style="width: 14px; height: 14px; background: #ef4444; border-radius: 50%;"></div>
              <span style="color: white; font-weight: 600;">AC</span>
            </div>
          </div>
        </div>
        
        <!-- GRÃFICO GRANDE -->
        <div style="position: relative; height: 380px; width: 100%;">
          <canvas id="grafico-evm-principal-completo"></canvas>
        </div>
      </div>
      
      <!-- FILA 2: MÃ‰TRICAS CLAVE -->
      <div style="
        background: rgba(26, 31, 60, 0.8);
        border-radius: 20px;
        padding: 30px;
        border: 2px solid rgba(255,255,255,0.15);
      ">
        <h3 style="
          margin: 0 0 25px 0;
          color: white;
          font-size: 24px;
          display: flex;
          align-items: center;
          gap: 15px;
        ">
          <span style="
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 12px;
            border-radius: 12px;
            font-size: 20px;
          ">
            ğŸ“Š
          </span>
          MÃ‰TRICAS CLAVE
        </h3>
        
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
          <div style="
            background: rgba(59, 130, 246, 0.1);
            padding: 20px;
            border-radius: 15px;
            border-left: 4px solid #3b82f6;
          ">
            <div style="font-size: 14px; color: #93c5fd; margin-bottom: 8px; font-weight: 600;">PV</div>
            <div style="font-size: 28px; font-weight: 800; color: white;">$85,200</div>
            <div style="font-size: 13px; color: #93c5fd; margin-top: 8px;">
              Valor Planificado
            </div>
          </div>
          
          <div style="
            background: rgba(16, 185, 129, 0.1);
            padding: 20px;
            border-radius: 15px;
            border-left: 4px solid #10b981;
          ">
            <div style="font-size: 14px; color: #a7f3d0; margin-bottom: 8px; font-weight: 600;">EV</div>
            <div style="font-size: 28px; font-weight: 800; color: white;">$78,500</div>
            <div style="font-size: 13px; color: #a7f3d0; margin-top: 8px;">
              Valor Ganado
            </div>
          </div>
          
          <div style="
            background: rgba(239, 68, 68, 0.1);
            padding: 20px;
            border-radius: 15px;
            border-left: 4px solid #ef4444;
          ">
            <div style="font-size: 14px; color: #fca5a5; margin-bottom: 8px; font-weight: 600;">AC</div>
            <div style="font-size: 28px; font-weight: 800; color: white;">$92,300</div>
            <div style="font-size: 13px; color: #fca5a5; margin-top: 8px;">
              Costo Real
            </div>
          </div>
          
          <div style="
            background: rgba(245, 158, 11, 0.1);
            padding: 20px;
            border-radius: 15px;
            border-left: 4px solid #f59e0b;
          ">
            <div style="font-size: 14px; color: #fde68a; margin-bottom: 8px; font-weight: 600;">BAC</div>
            <div style="font-size: 28px; font-weight: 800; color: white;">$125,000</div>
            <div style="font-size: 13px; color: #fde68a; margin-top: 8px;">
              Presupuesto Total
            </div>
          </div>
        </div>
      </div>
      
      <!-- FILA 3: INDICADORES DE DESEMPEÃ‘O -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
        <div style="
          background: rgba(26, 31, 60, 0.8);
          border-radius: 20px;
          padding: 30px;
          border: 2px solid rgba(255,255,255,0.15);
        ">
          <h3 style="
            margin: 0 0 25px 0;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 15px;
          ">
            <span style="
              background: rgba(16, 185, 129, 0.3);
              padding: 12px;
              border-radius: 12px;
              font-size: 20px;
              color: #10b981;
            ">
              ğŸ“ˆ
            </span>
            DESEMPEÃ‘O
          </h3>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
            <div style="
              background: rgba(239, 68, 68, 0.1);
              padding: 25px;
              border-radius: 15px;
              border-left: 5px solid #ef4444;
            ">
              <div style="font-size: 16px; color: #fca5a5; margin-bottom: 5px; font-weight: 600;">CPI</div>
              <div style="font-size: 42px; font-weight: 800; color: white;">0.85</div>
              <div style="font-size: 15px; color: #fca5a5; margin-top: 10px; font-weight: 500;">
                âš ï¸ 15% sobre costos
              </div>
            </div>
            
            <div style="
              background: rgba(245, 158, 11, 0.1);
              padding: 25px;
              border-radius: 15px;
              border-left: 5px solid #f59e0b;
            ">
              <div style="font-size: 16px; color: #fde68a; margin-bottom: 5px; font-weight: 600;">SPI</div>
              <div style="font-size: 42px; font-weight: 800; color: white;">0.92</div>
              <div style="font-size: 15px; color: #fde68a; margin-top: 10px; font-weight: 500;">
                âš ï¸ 8% retraso
              </div>
            </div>
          </div>
        </div>
        
        <div style="
          background: rgba(26, 31, 60, 0.8);
          border-radius: 20px;
          padding: 30px;
          border: 2px solid rgba(255,255,255,0.15);
        ">
          <h3 style="
            margin: 0 0 25px 0;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 15px;
          ">
            <span style="
              background: rgba(239, 68, 68, 0.3);
              padding: 12px;
              border-radius: 12px;
              font-size: 20px;
              color: #ef4444;
            ">
              âš ï¸
            </span>
            VARIANZAS
          </h3>
          
          <div style="display: flex; flex-direction: column; gap: 20px;">
            <div>
              <div style="font-size: 16px; color: #fca5a5; margin-bottom: 5px; font-weight: 600;">CV</div>
              <div style="font-size: 32px; font-weight: 800; color: #ef4444;">-$13,800</div>
              <div style="font-size: 15px; color: #fca5a5; margin-top: 8px;">
                Varianza de Costo
              </div>
            </div>
            
            <div>
              <div style="font-size: 16px; color: #fde68a; margin-bottom: 5px; font-weight: 600;">SV</div>
              <div style="font-size: 32px; font-weight: 800; color: #f59e0b;">-$6,700</div>
              <div style="font-size: 15px; color: #fde68a; margin-top: 8px;">
                Varianza de Tiempo
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', dashboardHTML);
  
  // Cargar Chart.js y crear grÃ¡fico
  setTimeout(() => {
    cargarChartJSEVMCompleto();
  }, 100);
}

// 2. FunciÃ³n para cargar Chart.js
function cargarChartJSEVMCompleto() {
  if (window.Chart) {
    crearGraficoEVMCompleto();
    return;
  }
  
  const script = document.createElement('script');
  script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
  script.onload = crearGraficoEVMCompleto;
  script.onerror = mostrarGraficoAlternativoEVMCompleto;
  document.head.appendChild(script);
}

// 3. FunciÃ³n para crear el grÃ¡fico
function crearGraficoEVMCompleto() {
  const canvas = document.getElementById('grafico-evm-principal-completo');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  
  const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto'];
  
  const data = {
    labels: meses,
    datasets: [
      {
        label: 'PV - Valor Planificado',
        data: [15000, 35000, 60000, 85000, 110000, 135000, 160000, 185000],
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        borderWidth: 4,
        fill: true,
        tension: 0.3
      },
      {
        label: 'EV - Valor Ganado',
        data: [12000, 32000, 55000, 78000, 98000, 120000, 142000, 165000],
        borderColor: '#10b981',
        backgroundColor: 'rgba(16, 185, 129, 0.1)',
        borderWidth: 4,
        fill: true,
        tension: 0.3
      },
      {
        label: 'AC - Costo Real',
        data: [14000, 38000, 65000, 92000, 118000, 145000, 172000, 200000],
        borderColor: '#ef4444',
        backgroundColor: 'rgba(239, 68, 68, 0.1)',
        borderWidth: 4,
        fill: true,
        tension: 0.3
      }
    ]
  };
  
  const config = {
    type: 'line',
    data: data,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
          labels: {
            color: 'white',
            font: {
              size: 14
            }
          }
        }
      },
      scales: {
        x: {
          grid: {
            color: 'rgba(255, 255, 255, 0.1)'
          },
          ticks: {
            color: 'white'
          }
        },
        y: {
          grid: {
            color: 'rgba(255, 255, 255, 0.1)'
          },
          ticks: {
            color: 'white',
            callback: function(value) {
              return '$' + value.toLocaleString();
            }
          },
          beginAtZero: true
        }
      }
    }
  };
  
  try {
    new Chart(ctx, config);
  } catch (error) {
    mostrarGraficoAlternativoEVMCompleto();
  }
}

// 4. FunciÃ³n alternativa si Chart.js falla
function mostrarGraficoAlternativoEVMCompleto() {
  const canvasContainer = document.getElementById('grafico-evm-principal-completo');
  if (!canvasContainer) return;
  
  canvasContainer.parentElement.innerHTML = `
    <div style="
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      text-align: center;
    ">
      <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“Š</div>
      <div style="font-size: 20px; color: #3b82f6; font-weight: bold; margin-bottom: 30px;">
        GRÃFICO DE VALOR GANADO
      </div>
      <div style="
        width: 100%;
        height: 200px;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        gap: 40px;
      ">
        <div style="display: flex; flex-direction: column; align-items: center;">
          <div style="width: 40px; height: 160px; background: #3b82f6; border-radius: 8px 8px 0 0;"></div>
          <div style="margin-top: 10px; color: #3b82f6; font-weight: bold;">PV</div>
        </div>
        <div style="display: flex; flex-direction: column; align-items: center;">
          <div style="width: 40px; height: 140px; background: #10b981; border-radius: 8px 8px 0 0;"></div>
          <div style="margin-top: 10px; color: #10b981; font-weight: bold;">EV</div>
        </div>
        <div style="display: flex; flex-direction: column; align-items: center;">
          <div style="width: 40px; height: 180px; background: #ef4444; border-radius: 8px 8px 0 0;"></div>
          <div style="margin-top: 10px; color: #ef4444; font-weight: bold;">AC</div>
        </div>
      </div>
    </div>
  `;
}

// 5. ENCONTRAR EL BOTÃ“N DE BURNDOWN Y PONER EVM AL LADO
function crearBotonEVMAlLadoDeBurndown() {
  console.log('ğŸ” Buscando botÃ³n de Burndown...');
  
  // Buscar el botÃ³n de Burndown (usando varios mÃ©todos)
  let btnBurndown = null;
  
  // MÃ©todo 1: Buscar por texto
  const todosLosBotones = document.querySelectorAll('button');
  for (const btn of todosLosBotones) {
    const texto = btn.textContent || btn.innerText || '';
    if (texto.toLowerCase().includes('burndown') || texto.includes('ğŸ“‰')) {
      btnBurndown = btn;
      console.log('âœ… BotÃ³n Burndown encontrado por texto:', texto);
      break;
    }
  }
  
  // MÃ©todo 2: Buscar por atributos comunes
  if (!btnBurndown) {
    const selectores = [
      'button[onclick*="burndown"]',
      'button[onclick*="Burndown"]',
      '[onclick*="burndown"]',
      '[onclick*="Burndown"]',
      '.btn-burndown',
      '#btn-burndown'
    ];
    
    for (const selector of selectores) {
      try {
        const btn = document.querySelector(selector);
        if (btn) {
          btnBurndown = btn;
          console.log('âœ… BotÃ³n Burndown encontrado por selector:', selector);
          break;
        }
      } catch (e) {
        // Ignorar selectores invÃ¡lidos
      }
    }
  }
  
  // MÃ©todo 3: Buscar por posiciÃ³n (botones en la esquina superior derecha)
  if (!btnBurndown) {
    const botonesDerecha = Array.from(todosLosBotones).filter(btn => {
      const rect = btn.getBoundingClientRect();
      return rect.right > window.innerWidth - 200 && rect.top < 100;
    });
    
    if (botonesDerecha.length > 0) {
      btnBurndown = botonesDerecha[0];
      console.log('âœ… BotÃ³n Burndown encontrado por posiciÃ³n');
    }
  }
  
  // Si encontramos el botÃ³n de Burndown
  if (btnBurndown) {
    console.log('ğŸ¯ BotÃ³n Burndown encontrado, creando botÃ³n EVM al lado...');
    
    // Eliminar botÃ³n EVM anterior si existe
    const btnEVMAnterior = document.getElementById('btn-evm-al-lado');
    if (btnEVMAnterior) btnEVMAnterior.remove();
    
    // Obtener posiciÃ³n del botÃ³n Burndown
    const rect = btnBurndown.getBoundingClientRect();
    const burndownStyle = window.getComputedStyle(btnBurndown);
    
    // Crear botÃ³n EVM
    const btnEVM = document.createElement('button');
    btnEVM.id = 'btn-evm-al-lado';
    btnEVM.innerHTML = 'ğŸ“ˆ Valor Ganado';
    btnEVM.style.cssText = `
      position: fixed !important;
      top: ${rect.top}px !important;
      left: ${rect.left - 180}px !important;
      z-index: ${parseInt(burndownStyle.zIndex || 99998) + 1} !important;
      background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%) !important;
      color: white !important;
      border: none !important;
      padding: ${burndownStyle.padding || '12px 24px'} !important;
      border-radius: ${burndownStyle.borderRadius || '10px'} !important;
      font-size: ${burndownStyle.fontSize || '14px'} !important;
      font-weight: 700 !important;
      cursor: pointer !important;
      box-shadow: 0 6px 20px rgba(139, 92, 246, 0.5) !important;
      display: flex !important;
      align-items: center !important;
      gap: 8px !important;
      transition: all 0.3s !important;
      white-space: nowrap !important;
    `;
    
    // Ajustar para que no se salga de la pantalla
    if (rect.left - 180 < 10) {
      btnEVM.style.left = `${rect.right + 10}px`;
      btnEVM.style.top = `${rect.top}px`;
    }
    
    btnEVM.onmouseover = function() {
      this.style.transform = 'translateY(-2px)';
      this.style.boxShadow = '0 10px 30px rgba(139, 92, 246, 0.7)';
    };
    
    btnEVM.onmouseout = function() {
      this.style.transform = 'translateY(0)';
      this.style.boxShadow = '0 6px 20px rgba(139, 92, 246, 0.5)';
    };
    
    btnEVM.onclick = crearDashboardEVMCompleto;
    document.body.appendChild(btnEVM);
    
    console.log('âœ… BotÃ³n EVM creado al lado del botÃ³n Burndown');
    return btnEVM;
    
  } else {
    // Si no encontramos el botÃ³n de Burndown, crear ambos
    console.log('âš ï¸ No se encontrÃ³ botÃ³n Burndown, creando ambos...');
    crearAmbosBotonesJuntos();
  }
}

// 6. Crear ambos botones juntos si no se encuentra Burndown
function crearAmbosBotonesJuntos() {
  // Eliminar botones anteriores
  const btnEVMAnterior = document.getElementById('btn-evm-al-lado');
  if (btnEVMAnterior) btnEVMAnterior.remove();
  
  const btnBurndownAnterior = document.getElementById('btn-burndown-temporal');
  if (btnBurndownAnterior) btnBurndownAnterior.remove();
  
  // Crear contenedor para ambos botones
  const contenedorBotones = document.createElement('div');
  contenedorBotones.id = 'contenedor-botones-dashboard';
  contenedorBotones.style.cssText = `
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    z-index: 99997 !important;
    display: flex !important;
    gap: 15px !important;
    align-items: center !important;
  `;
  
  // BotÃ³n Burndown (temporal)
  const btnBurndown = document.createElement('button');
  btnBurndown.id = 'btn-burndown-temporal';
  btnBurndown.innerHTML = 'ğŸ“‰ Burndown';
  btnBurndown.style.cssText = `
    background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
    color: white !important;
    border: none !important;
    padding: 12px 24px !important;
    border-radius: 10px !important;
    font-size: 14px !important;
    font-weight: 700 !important;
    cursor: pointer !important;
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5) !important;
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
    transition: all 0.3s !important;
    white-space: nowrap !important;
  `;
  
  btnBurndown.onclick = function() {
    alert('Para usar Burndown Chart, utilice el botÃ³n original de su sistema.');
  };
  
  // BotÃ³n EVM
  const btnEVM = document.createElement('button');
  btnEVM.id = 'btn-evm-al-lado';
  btnEVM.innerHTML = 'ğŸ“ˆ Valor Ganado';
  btnEVM.style.cssText = `
    background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%) !important;
    color: white !important;
    border: none !important;
    padding: 12px 24px !important;
    border-radius: 10px !important;
    font-size: 14px !important;
    font-weight: 700 !important;
    cursor: pointer !important;
    box-shadow: 0 6px 20px rgba(139, 92, 246, 0.5) !important;
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
    transition: all 0.3s !important;
    white-space: nowrap !important;
  `;
  
  btnEVM.onmouseover = function() {
    this.style.transform = 'translateY(-2px)';
    this.style.boxShadow = '0 10px 30px rgba(139, 92, 246, 0.7)';
  };
  
  btnEVM.onmouseout = function() {
    this.style.transform = 'translateY(0)';
    this.style.boxShadow = '0 6px 20px rgba(139, 92, 246, 0.5)';
  };
  
  btnEVM.onclick = crearDashboardEVMCompleto;
  
  // Agregar botones al contenedor
  contenedorBotones.appendChild(btnBurndown);
  contenedorBotones.appendChild(btnEVM);
  document.body.appendChild(contenedorBotones);
  
  console.log('âœ… Ambos botones creados juntos en la esquina superior derecha');
}

// 7. INICIALIZAR SISTEMA
function inicializarSistemaEVMAlLado() {
  console.log('ğŸ¯ INICIALIZANDO SISTEMA EVM (AL LADO DE BURNDOWN)');
  
  // Crear botÃ³n EVM al lado del botÃ³n Burndown
  crearBotonEVMAlLadoDeBurndown();
  
  console.log('âœ… Sistema EVM listo');
  console.log('ğŸ“ˆ BotÃ³n MORADO "Valor Ganado" aparecerÃ¡ al lado del botÃ³n verde de Burndown');
  
  // Verificar periÃ³dicamente si el botÃ³n Burndown se mueve
  setInterval(() => {
    const btnEVM = document.getElementById('btn-evm-al-lado');
    const btnBurndown = document.querySelector('button[id*="burndown"], button:contains("Burndown"), button:contains("burndown")');
    
    if (btnEVM && btnBurndown) {
      const rect = btnBurndown.getBoundingClientRect();
      btnEVM.style.top = `${rect.top}px`;
      btnEVM.style.left = `${rect.left - 180}px`;
      
      // Ajustar si se sale de la pantalla
      if (rect.left - 180 < 10) {
        btnEVM.style.left = `${rect.right + 10}px`;
      }
    }
  }, 1000);
}

// 8. EJECUTAR AL CARGAR
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', inicializarSistemaEVMAlLado);
} else {
  // Esperar un poco para que cargue la interfaz
  setTimeout(inicializarSistemaEVMAlLado, 1000);
}

// 9. Exponer funciones globalmente
window.mostrarValorGanado = crearDashboardEVMCompleto;
window.mostrarEVM = crearDashboardEVMCompleto;
window.crearBotonEVMAlLado = crearBotonEVMAlLadoDeBurndown;

console.log('âœ… Sistema Valor Ganado listo.');
console.log('ğŸ“‹ El botÃ³n aparecerÃ¡ AL LADO del botÃ³n de Burndown.');
console.log('ğŸ“‹ Comandos disponibles:');
console.log('   - mostrarValorGanado() - Abre el dashboard EVM');
console.log('   - crearBotonEVMAlLado() - Reposiciona el botÃ³n');