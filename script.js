





// ‚úÖ Asegurar que las funciones existan
window.showDashboard4DView = window.showDashboard4DView || function() {
  alert('‚ùå Dashboard 4D no est√° configurado');
};
window.createCompleteGanttForCurrentProject = window.createCompleteGanttForCurrentProject || function() {
  alert('‚ùå Gantt no est√° configurado');
};




// === CONFIGURACI√ìN DE FIREBASE ===
const firebaseConfig = {
  apiKey: "AIzaSyBoywVxsuIsQVaBQIn-gzhIxj3etDOnIzs",
  authDomain: "jackson-hseyol.firebaseapp.com",
  projectId: "jackson-hseyol",
  storageBucket: "jackson-hseyol.firebasestorage.app",
  messagingSenderId: "724208145421",
  appId: "1:724208145421:web:781ea481297e0999b5b144"
};

// Inicializar Firebase
firebase.initializeApp(firebaseConfig);
console.log('‚úÖ Firebase inicializado');

// === FUNCIONES DE AUTENTICACI√ìN ===

// Registrar nuevo usuario
async function registerUser(email, password) {
  try {
    const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
    console.log('‚úÖ Usuario registrado:', userCredential.user.email);
    showNotification('‚úÖ Registro exitoso. Bienvenido!');
    return userCredential.user;
  } catch (error) {
    console.error('‚ùå Error al registrar:', error.message);
    showNotification('‚ùå ' + error.message);
    throw error;
  }
}

// Iniciar sesi√≥n existente
async function loginUser(email, password) {
  try {
    const response = await fetch(`${API_URL}/api/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    
    const data = await response.json();
    
    if (data.success) {
      localStorage.setItem('authToken', data.token);
      window.authToken = data.token;
      showNotification('‚úÖ Bienvenido!');
      return data.user;
    } else {
      throw new Error(data.error);
    }
  } catch (error) {
    showNotification('‚ùå ' + error.message);
    throw error;
  }
}
// Obtener usuario actual
function getCurrentUser() {
  return firebase.auth().currentUser;
}

// Cerrar sesi√≥n
async function logoutUser() {
  try {
    await firebase.auth().signOut();
    console.log('‚úÖ Sesi√≥n cerrada');
    showNotification('‚úÖ Sesi√≥n cerrada');
    // Recargar la p√°gina para limpiar estado
    location.reload();
  } catch (error) {
    console.error('‚ùå Error al cerrar sesi√≥n:', error);
    showNotification('‚ùå Error al cerrar sesi√≥n');
  }
}



console.log('üü¢ SCRIPT EMPIEZA');

// üîß FUNCI√ìN DE DIAGN√ìSTICO EN TIEMPO REAL
window.debugBurndownUpdate = function() {
  console.clear();
  console.log('üîç ===== DEBUG BURNDOWN UPDATE =====');
  
  const project = projects[currentProjectIndex];
  const tasks = project?.tasks || [];
  
  console.log('üìä Tareas actuales:', tasks.length);
  console.log('üìã Estado de tareas:');
  tasks.forEach((t, i) => {
    console.log(`  ${i+1}. ${t.name}: ${t.status}, progreso: ${t.progress || 0}%, SP: ${t.storyPoints || 0}`);
  });
  
  // Calcular datos frescos
  const freshData = calculateBurndownForRenderer(tasks);
  console.log('üßÆ Datos frescos calculados:', freshData);
  
  console.log('üìà Instancia actual:', window.burndownChartPremiumInstance ? 'EXISTE' : 'NO existe');
  
  if (window.burndownChartPremiumInstance) {
    console.log('üé® Datos en instancia actual:');
    console.log('  - Labels:', window.burndownChartPremiumInstance.data.labels);
    console.log('  - Ideal:', window.burndownChartPremiumInstance.data.datasets[0].data);
    console.log('  - Real:', window.burndownChartPremiumInstance.data.datasets[1].data);
  }
  
  console.log('üîç ===== FIN DEBUG =====');
};










// üîç FUNCI√ìN DE DIAGN√ìSTICO PARA BURNDOWN
window.diagnosticoBurndown = function() {
  console.clear();
  console.log('üîç ===== DIAGN√ìSTICO BURNDOWN =====');
  
  // 1. Verificar si el bot√≥n est√° funcionando
  console.log('1. ‚úÖ Funci√≥n showBurnDownChartPremium existe:', typeof window.showBurnDownChartPremium === 'function');
  
  // 2. Verificar si el Gantt est√° abierto
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  console.log('2. üìä Gantt container existe:', !!ganttContainer);
  
  if (ganttContainer) {
    console.log('   ‚Ä¢ Proyecto:', ganttContainer.dataset.projectName);
    console.log('   ‚Ä¢ √çndice:', ganttContainer.dataset.projectIndex);
    
    // 3. Verificar proyectos y tareas
    const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
    console.log('3. üìã Current project index:', projectIndex);
    console.log('   ‚Ä¢ Total proyectos:', projects.length);
    
    if (projects[projectIndex]) {
      const currentProject = projects[projectIndex];
      console.log('   ‚Ä¢ Proyecto actual:', currentProject.name);
      console.log('   ‚Ä¢ Tareas del proyecto:', currentProject.tasks ? currentProject.tasks.length : 0);
      
      if (currentProject.tasks && currentProject.tasks.length > 0) {
        console.log('   ‚Ä¢ Ejemplo de tarea:', currentProject.tasks[0]);
      }
    }
  }
  
  // 4. Verificar si hay modales abiertos
  console.log('4. ü™ü Modales Burndown abiertos:');
  const modales = document.querySelectorAll('.executive-overlay, #burndownChartContainer, #graficoBurndown');
  console.log('   ‚Ä¢ Total modales encontrados:', modales.length);
  modales.forEach((modal, i) => {
    console.log(`   ${i + 1}. ${modal.id || modal.className} - Visible: ${isElementVisible(modal)}`);
  });
  
  // 5. Verificar instancias de Chart.js
  console.log('5. üìà Instancias de Chart.js:');
  console.log('   ‚Ä¢ burndownChartPremiumInstance:', window.burndownChartPremiumInstance ? 'EXISTE' : 'NO existe');
  console.log('   ‚Ä¢ burndownChartInstance:', window.burndownChartInstance ? 'EXISTE' : 'NO existe');
  console.log('   ‚Ä¢ Total instancias Chart:', Chart.instances ? Chart.instances.length : 'N/A');
  
  // 6. Verificar si calculateBurndownFromTasks funciona
  console.log('6. üßÆ Funci√≥n calculateBurndownFromTasks:');
  console.log('   ‚Ä¢ Existe:', typeof calculateBurndownFromTasks === 'function');
  
  if (typeof calculateBurndownFromTasks === 'function' && ganttContainer) {
    const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
    if (projects[projectIndex] && projects[projectIndex].tasks) {
      try {
        const testData = calculateBurndownFromTasks(projects[projectIndex].tasks);
        console.log('   ‚Ä¢ Datos calculados:', testData);
        console.log('   ‚Ä¢ Semanas:', testData.semanas.length);
        console.log('   ‚Ä¢ Datos ideal:', testData.trabajoIdeal);
        console.log('   ‚Ä¢ Datos real:', testData.trabajoReal);
      } catch (e) {
        console.log('   ‚Ä¢ ERROR calculando:', e.message);
      }
    }
  }
  
  console.log('üîç ===== FIN DIAGN√ìSTICO =====');
  
  function isElementVisible(el) {
    return !!(el.offsetWidth || el.offsetHeight || el.getClientRects().length);
  }
};

// Ejecutar diagn√≥stico autom√°tico al cargar
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(() => {
    console.log('üöÄ Sistema cargado - Usa diagnosticoBurndown() para verificar estado');
  }, 2000);
});





// üîß DESACTIVAMOS COMPLETAMENTE EL SISTEMA VIEJO DE DEPENDENCIAS
window.drawDependencyLine = () => {};
window.injectDependencyStyles = () => {};
window.fixDependencyLinesCSS = () => {};
window.recalculateDependencyLines = () => {};
// üîß DESACTIVAR SISTEMA VIEJO QUE BORRA O ALTERA DEPENDENCIAS
window.initializeDependencyProtection = () => {};
window.applyDependencyProtection = () => {};
window.patchDependencySystem = () => {};
window.recalculateLegacyDependencies = () => {};
window.updateSelectedDepsView = () => {};
window.setupPermanentDependencyInterceptor = () => {};






console.log("üî• SCRIPT CORRECTO CARGADO v1");

// ===== CONFIGURACI√ìN GLOBAL MEJORADA =====
window.API_URL = "https://mi-sistema-proyectos-backend-4.onrender.com";

const API_URL = window.API_URL;
console.log("üåê API_URL cargado:", API_URL);

// üîê Cargar token global SOLO UNA VEZ
window.authToken = localStorage.getItem("authToken") || "";
console.log("üîê Token cargado:", window.authToken ? "‚úÖ Presente" : "‚ùå Ausente");

// Mostrar pantalla de login si NO hay token
// CAMBIO: Solo verificar si existe el token, no su longitud
if (!window.authToken) {
    console.log("‚ö†Ô∏è No hay sesi√≥n activa. Mostrando pantalla de login.");
    document.addEventListener("DOMContentLoaded", () => {
        showLoginScreen();
    });
} else {
    console.log("‚úÖ Sesi√≥n activa detectada, token presente");
}// üü° Si NO hay token ‚Üí mostrar pantalla de login y DETENER todo lo dem√°s
// ‚úÖ VERSI√ìN CORREGIDA:
if (!window.authToken) {
    console.log("‚ö†Ô∏è No hay sesi√≥n activa. Mostrando pantalla de login.");
    document.addEventListener("DOMContentLoaded", () => {
        showLoginScreen();
    });
    // NO usar return - dejar que el script contin√∫e cargando
} else {
    console.log("‚úÖ Sesi√≥n activa detectada, continuando inicializaci√≥n...");
}







// === SISTEMA DE CONFIGURACI√ìN ===

// Aplicar tema
function applyTheme(theme) {
  const body = document.body;
  if (theme === 'light') {
    body.style.backgroundColor = '#f5f5f5';
    body.style.color = '#333';
    localStorage.setItem('systemTheme', 'light');
  } else {
    body.style.backgroundColor = '#121212';
    body.style.color = '#ffffff';
    localStorage.setItem('systemTheme', 'dark');
  }
  
  // Aplicar a elementos comunes
  const elements = document.querySelectorAll('.view-content, .sidebar, .header, nav, header, .app-container');
  elements.forEach(el => {
    if (theme === 'light') {
      el.style.backgroundColor = '#ffffff';
      el.style.color = '#333';
    } else {
      el.style.backgroundColor = '#1a1a1a';
      el.style.color = '#ffffff';
    }
  });
}

// Cambiar idioma
function changeLanguage(language) {
  localStorage.setItem('systemLanguage', language);
  if (language === 'es') {
    showNotification('‚úÖ Idioma cambiado a Espa√±ol');
  } else {
    showNotification('‚úÖ Language changed to English');
  }
}

// Cargar configuraci√≥n al iniciar
function loadSystemConfiguration() {
  const config = JSON.parse(localStorage.getItem('systemConfig') || '{}');
  const theme = config.theme || 'dark';
  applyTheme(theme);
}


// Mostrar modal de configuraci√≥n
function showSystemConfiguration() {
  // Cerrar men√∫s existentes
  const existingMenu = document.getElementById('configMenu');
  if (existingMenu) existingMenu.remove();
  
  const existingModal = document.getElementById('systemConfigModal');
  if (existingModal) existingModal.remove();
  
  // Cargar configuraci√≥n actual
  const config = JSON.parse(localStorage.getItem('systemConfig') || '{}');
  const currentTheme = config.theme || 'dark';
  const currentMode = config.defaultMode || 'hybrid';
  
  const modal = document.createElement('div');
  modal.id = 'systemConfigModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.95);
    z-index: 10000;
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
    font-family: Arial, sans-serif;
  `;
  
  modal.innerHTML = `
    <div style="background: #1a1a1a; padding: 30px; border-radius: 15px; max-width: 600px; width: 95%;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h2 style="margin: 0; color: #4CAF50; font-size: 24px;">‚öôÔ∏è Configuraci√≥n del Sistema</h2>
        <button onclick="document.getElementById('systemConfigModal').remove()" 
                style="background: #ff4444; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 16px;">
          ‚úï
        </button>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h3 style="color: #FFD700; margin: 0 0 15px 0;">üé® Tema / Theme</h3>
        <select id="themeSelect" style="width: 100%; padding: 10px; background: #333; color: white; border: 1px solid #444; border-radius: 5px;">
          <option value="dark" ${currentTheme === 'dark' ? 'selected' : ''}>Oscuro / Dark</option>
          <option value="light" ${currentTheme === 'light' ? 'selected' : ''}>Claro / Light</option>
        </select>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h3 style="color: #FFD700; margin: 0 0 15px 0;">üîÑ Modo predeterminado / Default Mode</h3>
        <select id="defaultModeSelect" style="width: 100%; padding: 10px; background: #333; color: white; border: 1px solid #444; border-radius: 5px;">
          <option value="agile" ${currentMode === 'agile' ? 'selected' : ''}>√Ågil / Agile</option>
          <option value="traditional" ${currentMode === 'traditional' ? 'selected' : ''}>Tradicional / Traditional</option>
          <option value="hybrid" ${currentMode === 'hybrid' ? 'selected' : ''}>H√≠brido / Hybrid</option>
        </select>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button onclick="document.getElementById('systemConfigModal').remove()" 
                style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 5px; cursor: pointer;">
          Cancelar
        </button>
        <button onclick="saveSystemConfiguration()" 
                style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
          Guardar / Save
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}







// === SISTEMA DE LICENCIAS Y CONFIGURACI√ìN ===

// Aplicar tema
function applyTheme(theme) {
  const body = document.body;
  if (theme === 'light') {
    body.style.backgroundColor = '#f5f5f5';
    body.style.color = '#333';
    localStorage.setItem('systemTheme', 'light');
  } else {
    body.style.backgroundColor = '#121212';
    body.style.color = '#ffffff';
    localStorage.setItem('systemTheme', 'dark');
  }
  
  // Aplicar a elementos comunes
  const elements = document.querySelectorAll('.view-content, .sidebar, .header, nav, header, .app-container, #appViews');
  elements.forEach(el => {
    if (theme === 'light') {
      el.style.backgroundColor = '#ffffff';
      el.style.color = '#333';
    } else {
      el.style.backgroundColor = '#1a1a1a';
      el.style.color = '#ffffff';
    }
  });
}

// Cambiar idioma
function changeLanguage(language) {
  // Guardar en localStorage
  localStorage.setItem('systemLanguage', language);
  
  // Actualizar la configuraci√≥n global
  const config = JSON.parse(localStorage.getItem('systemConfig') || '{}');
  config.language = language;
  localStorage.setItem('systemConfig', JSON.stringify(config));
  
  // Aplicar el cambio de idioma inmediatamente
  if (language === 'es') {
    showNotification('‚úÖ Idioma cambiado a Espa√±ol');
    // Aqu√≠ podr√≠as llamar a una funci√≥n que actualice todo el texto
    // Por ahora, recargamos la p√°gina para aplicar cambios completos
    setTimeout(() => {
      location.reload();
    }, 1000);
  } else {
    showNotification('‚úÖ Language changed to English');
    // Recargar para aplicar ingl√©s
    setTimeout(() => {
      location.reload();
    }, 1000);
  }
}
// Cargar configuraci√≥n al iniciar
function loadSystemConfiguration() {
  const config = JSON.parse(localStorage.getItem('systemConfig') || '{}');
  const theme = config.theme || 'dark';
  applyTheme(theme);
}


// Mostrar modal de configuraci√≥n
function showSystemConfiguration() {
  // Cerrar men√∫s existentes
  const existingMenu = document.getElementById('configMenu');
  if (existingMenu) existingMenu.remove();
  
  const existingModal = document.getElementById('systemConfigModal');
  if (existingModal) existingModal.remove();
  
  // Cargar configuraci√≥n actual
  const config = JSON.parse(localStorage.getItem('systemConfig') || '{}');
  const currentTheme = config.theme || 'dark';
  const currentMode = config.defaultMode || 'hybrid';
  
  const modal = document.createElement('div');
  modal.id = 'systemConfigModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.95);
    z-index: 10000;
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
    font-family: Arial, sans-serif;
  `;
  
  modal.innerHTML = `
    <div style="background: #1a1a1a; padding: 30px; border-radius: 15px; max-width: 600px; width: 95%;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h2 style="margin: 0; color: #4CAF50; font-size: 24px;">‚öôÔ∏è Configuraci√≥n del Sistema</h2>
        <button onclick="document.getElementById('systemConfigModal').remove()" 
                style="background: #ff4444; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 16px;">
          ‚úï
        </button>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h3 style="color: #FFD700; margin: 0 0 15px 0;">üé® Tema / Theme</h3>
        <select id="themeSelect" style="width: 100%; padding: 10px; background: #333; color: white; border: 1px solid #444; border-radius: 5px;">
          <option value="dark" ${currentTheme === 'dark' ? 'selected' : ''}>Oscuro / Dark</option>
          <option value="light" ${currentTheme === 'light' ? 'selected' : ''}>Claro / Light</option>
        </select>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h3 style="color: #FFD700; margin: 0 0 15px 0;">üîÑ Modo predeterminado / Default Mode</h3>
        <select id="defaultModeSelect" style="width: 100%; padding: 10px; background: #333; color: white; border: 1px solid #444; border-radius: 5px;">
          <option value="agile" ${currentMode === 'agile' ? 'selected' : ''}>√Ågil / Agile</option>
          <option value="traditional" ${currentMode === 'traditional' ? 'selected' : ''}>Tradicional / Traditional</option>
          <option value="hybrid" ${currentMode === 'hybrid' ? 'selected' : ''}>H√≠brido / Hybrid</option>
        </select>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button onclick="saveSystemConfiguration()" 
                style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
          Guardar / Save
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}


// Gesti√≥n de Licencias
function showLicensesView() {
  console.log('üîê Abriendo Gesti√≥n de Licencias...');
  
  const existingModal = document.getElementById('licensesModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  const currentLicense = window.licenseManager?.getLicense() || 'free';
  
  const modal = document.createElement('div');
  modal.id = 'licensesModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.95);
    z-index: 10000;
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
    font-family: Arial, sans-serif;
  `;
  
  modal.innerHTML = `
    <div style="background: #1a1a1a; padding: 30px; border-radius: 15px; max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h2 style="margin: 0; color: #4CAF50; font-size: 28px;">üîê Gesti√≥n de Licencias</h2>
        <button id="closeLicensesModal" 
                style="background: #ff4444; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 16px;">
          ‚úï
        </button>
      </div>
      
      <div style="background: #2a2a2a; padding: 15px; border-radius: 10px; margin-bottom: 25px;">
        <h3 style="margin: 0 0 10px 0; color: #FFD700;">Tu plan actual: <span style="color: #4CAF50; text-transform: capitalize;">${currentLicense}</span></h3>
        <p style="margin: 0; color: #cccccc;">${currentLicense === 'free' ? 'Plan gratuito con funcionalidades b√°sicas' : currentLicense === 'professional' ? 'Plan profesional con todas las funcionalidades avanzadas' : 'Plan premium para empresas con colaboraci√≥n avanzada'}</p>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 25px;">
        
        <!-- Plan FREE -->
        <div style="background: ${currentLicense === 'free' ? '#252525' : '#1e1e1e'}; border: 2px solid ${currentLicense === 'free' ? '#4CAF50' : '#444444'}; border-radius: 10px; padding: 20px;">
          <h3 style="margin: 0 0 15px 0; color: ${currentLicense === 'free' ? '#4CAF50' : '#ffffff'};">FREE</h3>
          <div style="font-size: 24px; font-weight: bold; margin: 0 0 15px 0; color: #ffffff;">‚Ç¨0</div>
          <ul style="list-style: none; padding: 0; margin: 0 0 20px 0; color: #cccccc;">
            <li style="margin: 5px 0;">‚úì Tablero Kanban</li>
            <li style="margin: 5px 0;">‚úì Lista de tareas</li>
            <li style="margin: 5px 0;">‚úì Calendario b√°sico</li>
            <li style="margin: 5px 0;">‚úì Dashboard b√°sico</li>
            <li style="margin: 5px 0; color: #666666;">‚úó Gantt Ejecutivo</li>
            <li style="margin: 5px 0; color: #666666;">‚úó Dashboard 4D</li>
            <li style="margin: 5px 0; color: #666666;">‚úó Reportes EVM</li>
            <li style="margin: 5px 0; color: #666666;">‚úó Exportaci√≥n PDF</li>
          </ul>
          <button id="selectFreePlan" 
                  style="width: 100%; padding: 10px; background: ${currentLicense === 'free' ? '#4CAF50' : '#666666'}; color: white; border: none; border-radius: 5px; cursor: ${currentLicense === 'free' ? 'default' : 'pointer'}; opacity: ${currentLicense === 'free' ? '0.7' : '1'};"
                  ${currentLicense === 'free' ? 'disabled' : ''}>
            ${currentLicense === 'free' ? 'Plan actual' : 'Seleccionar'}
          </button>
        </div>
        
        <!-- Plan PROFESSIONAL -->
        <div style="background: ${currentLicense === 'professional' ? '#252525' : '#1e1e1e'}; border: 2px solid ${currentLicense === 'professional' ? '#4CAF50' : '#444444'}; border-radius: 10px; padding: 20px; position: relative;">
          <div style="position: absolute; top: -10px; right: 20px; background: #4CAF50; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold;">
            POPULAR
          </div>
          <h3 style="margin: 0 0 15px 0; color: ${currentLicense === 'professional' ? '#4CAF50' : '#ffffff'};">PROFESSIONAL</h3>
          <div style="font-size: 24px; font-weight: bold; margin: 0 0 15px 0; color: #ffffff;">‚Ç¨9.99/mes</div>
          <ul style="list-style: none; padding: 0; margin: 0 0 20px 0; color: #cccccc;">
            <li style="margin: 5px 0;">‚úì Todo lo de FREE</li>
            <li style="margin: 5px 0;">‚úì Gantt Ejecutivo Premium</li>
            <li style="margin: 5px 0;">‚úì Dashboard 4D Global</li>
            <li style="margin: 5px 0;">‚úì Reportes EVM (CPI, SPI, EAC)</li>
            <li style="margin: 5px 0;">‚úì Exportaci√≥n PDF Profesional</li>
            <li style="margin: 5px 0;">‚úì Seguimiento de tiempo avanzado</li>
            <li style="margin: 5px 0;">‚úì Proyectos ilimitados</li>
          </ul>
          <button id="selectProfessionalPlan" 
                  style="width: 100%; padding: 10px; background: ${currentLicense === 'professional' ? '#4CAF50' : '#2196F3'}; color: white; border: none; border-radius: 5px; cursor: pointer;">
            ${currentLicense === 'professional' ? 'Plan actual' : 'Actualizar'}
          </button>
        </div>
        
        <!-- Plan PREMIUM -->
        <div style="background: ${currentLicense === 'premium' ? '#252525' : '#1e1e1e'}; border: 2px solid ${currentLicense === 'premium' ? '#4CAF50' : '#444444'}; border-radius: 10px; padding: 20px; position: relative;">
          <div style="position: absolute; top: -10px; right: 20px; background: #FF9800; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold;">
            EMPRESAS
          </div>
          <h3 style="margin: 0 0 15px 0; color: ${currentLicense === 'premium' ? '#4CAF50' : '#ffffff'};">PREMIUM</h3>
          <div style="font-size: 24px; font-weight: bold; margin: 0 0 15px 0; color: #ffffff;">‚Ç¨19.99/mes</div>
          <ul style="list-style: none; padding: 0; margin: 0 0 20px 0; color: #cccccc;">
            <li style="margin: 5px 0;">‚úì Todo lo de PROFESSIONAL</li>
            <li style="margin: 5px 0;">‚úì Colaboraci√≥n en tiempo real</li>
            <li style="margin: 5px 0;">‚úì Integraci√≥n Power BI avanzada</li>
            <li style="margin: 5px 0;">‚úì API REST completa</li>
            <li style="margin: 5px 0;">‚úì Soporte prioritario</li>
            <li style="margin: 5px 0;">‚úì Plantillas profesionales</li>
            <li style="margin: 5px 0;">‚úì Auditor√≠a de cambios</li>
          </ul>
          <button id="selectPremiumPlan" 
                  style="width: 100%; padding: 10px; background: ${currentLicense === 'premium' ? '#4CAF50' : '#9C27B0'}; color: white; border: none; border-radius: 5px; cursor: pointer;">
            ${currentLicense === 'premium' ? 'Plan actual' : 'Actualizar'}
          </button>
        </div>
      </div>
      
      <div style="background: #2a2a2a; padding: 20px; border-radius: 10px;">
        <h3 style="margin: 0 0 15px 0; color: #FFD700;">¬øTienes un c√≥digo de licencia?</h3>
        <div style="display: flex; gap: 10px;">
          <input type="text" id="licenseCodeInput" placeholder="Ingresa tu c√≥digo de licencia" 
                 style="flex: 1; padding: 10px; border: 1px solid #444; background: #333; color: white; border-radius: 5px;">
          <button id="activateLicenseCode" 
                  style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
            Activar
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // EVENTOS CORREGIDOS
  document.getElementById('closeLicensesModal').onclick = () => {
    modal.remove();
  };
  
  document.getElementById('selectFreePlan').onclick = () => {
    if (currentLicense !== 'free') {
      showLicensesView_activatePlan('free');
    }
  };
  
  document.getElementById('selectProfessionalPlan').onclick = () => {
    if (currentLicense !== 'professional') {
      showLicensesView_activatePlan('professional');
    }
  };
  
  document.getElementById('selectPremiumPlan').onclick = () => {
    if (currentLicense !== 'premium') {
      showLicensesView_activatePlan('premium');
    }
  };
  
  document.getElementById('activateLicenseCode').onclick = () => {
    showLicensesView_activateCode();
  };
}

// Funci√≥n para activar plan
async function showLicensesView_activatePlan(plan) {
  const user = firebase.auth().currentUser;
  if (!user) {
    showNotification('üîí Debes iniciar sesi√≥n para actualizar tu plan.');
    return;
  }

  if (plan === 'free') {
    const expiresAt = new Date(Date.now() + 20 * 24 * 60 * 60 * 1000);
    localStorage.setItem('userLicense', 'free');
    localStorage.setItem('licenseExpiresAt', expiresAt.getTime());
    
    const notification = showNotification(`‚úÖ Plan FREE activado por 20 d√≠as (hasta ${expiresAt.toLocaleDateString()})`);
    setTimeout(() => {
      if (notification && notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 5000);
    
    document.getElementById('licensesModal')?.remove();
    location.reload();
    
  } else if (plan === 'professional' || plan === 'premium') {
    try {
      showNotification('üöÄ Redirigiendo a Stripe para pago seguro...', 3000);
      
      const response = await fetch('https://mi-sistema-proyectos-backend-4.onrender.com/api/create-checkout-session', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId: user.uid,
          email: user.email,
          plan: plan,
          successUrl: window.location.origin + '/?payment=success',
          cancelUrl: window.location.origin + '/?payment=cancelled'
        })
      });
      
      const session = await response.json();
      
      if (session.id) {
        window.location.href = session.url;
      } else {
        throw new Error('No se pudo crear la sesi√≥n de pago');
      }
      
    } catch (error) {
      console.error('Error al crear sesi√≥n de pago:', error);
      showNotification('‚ùå Error al procesar el pago. Intenta de nuevo.', 5000);
    }
  }
}// Funci√≥n para activar c√≥digo
function showLicensesView_activateCode() {
  const code = document.getElementById('licenseCodeInput').value.trim();
  if (!code) {
    showNotification('‚ö†Ô∏è Por favor ingresa un c√≥digo de licencia');
    return;
  }
  showNotification('üîç Validando c√≥digo de licencia...');
  setTimeout(() => {
    showNotification('‚ùå C√≥digo de licencia no v√°lido o expirado');
  }, 2000);
}

// Ayuda y soporte
function showHelpSupport() {
  const existingMenu = document.getElementById('configMenu');
  if (existingMenu) existingMenu.remove();
  
  const modal = document.createElement('div');
  modal.id = 'helpModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.95);
    z-index: 10000;
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
    font-family: Arial, sans-serif;
  `;
  
  modal.innerHTML = `
    <div style="background: #1a1a1a; padding: 30px; border-radius: 15px; max-width: 600px; width: 95%;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h2 style="margin: 0; color: #4CAF50; font-size: 24px;">‚ùì Ayuda y Soporte</h2>
        <button onclick="document.getElementById('helpModal').remove()" 
                style="background: #ff4444; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 16px;">
          ‚úï
        </button>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h3 style="color: #FFD700; margin: 0 0 10px 0;">Gu√≠a R√°pida</h3>
        <p style="color: #cccccc; margin: 0; line-height: 1.5;">
          ‚Ä¢ Usa el selector de modo para cambiar entre √Ågil, Tradicional o H√≠brido<br>
          ‚Ä¢ El Gantt Ejecutivo est√° disponible en plan PROFESSIONAL<br>
          ‚Ä¢ Dashboard 4D muestra m√©tricas avanzadas en modo H√≠brido<br>
          ‚Ä¢ Exporta tus reportes en PDF desde la vista de Reportes
        </p>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h3 style="color: #FFD700; margin: 0 0 10px 0;">Soporte T√©cnico</h3>
        <p style="color: #cccccc; margin: 0;">¬øNecesitas ayuda urgente?</p>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <button onclick="window.open('mailto:ajackson2672@gmail.com?subject=Soporte%20T√©cnico', '_blank')" 
                  style="padding: 8px 16px; background: #9C27B0; color: white; border: none; border-radius: 5px; cursor: pointer; flex: 1;">
            Email
          </button>
          <button onclick="window.open('https://wa.me/34634122273?text=Hola,%20necesito%20soporte%20t√©cnico', '_blank')" 
                  style="padding: 8px 16px; background: #25D366; color: white; border: none; border-radius: 5px; cursor: pointer; flex: 1;">
            WhatsApp
          </button>
        </div>
      </div>
      
      <div>
        <h3 style="color: #FFD700; margin: 0 0 10px 0;">Versi√≥n del Sistema</h3>
        <p style="color: #cccccc; margin: 0;">v1.0.0 - ${new Date().toLocaleDateString()}</p>
        <button onclick="checkForUpdates()" 
                style="margin-top: 10px; padding: 8px 16px; background: #FF9800; color: white; border: none; border-radius: 5px; cursor: pointer;">
          Verificar Actualizaciones
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// Verificar actualizaciones
function checkForUpdates() {
  showNotification('üîç Verificando actualizaciones...');
  setTimeout(() => {
    showNotification('‚úÖ Est√°s usando la versi√≥n m√°s reciente');
  }, 1500);
}

// Acerca de
function showAbout() {
  const existingMenu = document.getElementById('configMenu');
  if (existingMenu) existingMenu.remove();
  
  const modal = document.createElement('div');
  modal.id = 'aboutModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.95);
    z-index: 10000;
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
    font-family: Arial, sans-serif;
  `;
  
  const license = window.licenseManager?.getLicense() || 'free';
  const mode = window.methodologyManager?.getCurrentMode() || 'unknown';
  const projectsCount = typeof projects !== 'undefined' ? projects.length : 0;
  
  modal.innerHTML = `
    <div style="background: #1a1a1a; padding: 30px; border-radius: 15px; max-width: 500px; width: 95%; text-align: center;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h2 style="margin: 0; color: #4CAF50; font-size: 24px;">üìã Acerca de</h2>
        <button onclick="document.getElementById('aboutModal').remove()" 
                style="background: #ff4444; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 16px;">
          ‚úï
        </button>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h3 style="color: #FFD700; margin: 0 0 10px 0;">Sistema de Gesti√≥n de Proyectos</h3>
        <p style="color: #cccccc; margin: 0; font-size: 18px; font-weight: bold;">v1.0.0</p>
        <p style="color: #cccccc; margin: 10px 0 0 0;">Desarrollado para profesionales del proyecto</p>
      </div>
      
      <div style="margin-bottom: 20px; background: #2a2a2a; padding: 15px; border-radius: 10px;">
        <h4 style="color: #4CAF50; margin: 0 0 10px 0;">Estado actual:</h4>
        <p style="color: #ffffff; margin: 5px 0; font-size: 14px;">
          <strong>Licencia:</strong> ${license}<br>
          <strong>Modo:</strong> ${mode}<br>
          <strong>Proyectos:</strong> ${projectsCount}
        </p>
      </div>
      
      <div style="margin-bottom: 20px; background: #2a2a2a; padding: 15px; border-radius: 10px;">
        <h4 style="color: #4CAF50; margin: 0 0 10px 0;">Caracter√≠sticas activas:</h4>
        <ul style="color: #cccccc; text-align: left; padding-left: 20px; margin: 0; font-size: 13px;">
          <li>Gantt Ejecutivo Premium ${license === 'professional' || license === 'premium' ? '‚úÖ' : 'üîí'}</li>
          <li>Dashboard 4D Global ${license === 'professional' || license === 'premium' ? '‚úÖ' : 'üîí'}</li>
          <li>Reportes EVM (CPI, SPI) ${license === 'professional' || license === 'premium' ? '‚úÖ' : 'üîí'}</li>
          <li>Exportaci√≥n PDF Profesional ${license === 'professional' || license === 'premium' ? '‚úÖ' : 'üîí'}</li>
          <li>Modos √Ågil/Tradicional/H√≠brido ‚úÖ</li>
        </ul>
      </div>
      
      <div style="font-size: 12px; color: #666;">
        ¬© ${new Date().getFullYear()} Todos los derechos reservados
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// === CREAR Y POSICIONAR BOT√ìN DE CONFIGURACI√ìN ===

// Funci√≥n para posicionar el bot√≥n junto al Gantt
function positionConfigButton() {
  const configButton = document.getElementById('configButton');
  if (!configButton) return;
  
  // Encontrar el bot√≥n de Gantt
  const ganttButton = Array.from(document.querySelectorAll('button')).find(btn => 
    btn.textContent.trim().includes('Gantt') && btn.id === 'topNavGanttButton'
  );
  
  if (ganttButton) {
    // Insertar justo despu√©s del bot√≥n de Gantt
    ganttButton.parentNode.insertBefore(configButton, ganttButton.nextSibling);
    configButton.style.marginLeft = '10px';
    configButton.style.marginRight = '0';
    console.log('‚úÖ Bot√≥n de configuraci√≥n posicionado junto a Gantt');
  } else {
    // Fallback: insertar en el header
    const headerContainer = document.querySelector('.header, #header, .top-bar, .navbar, header');
    if (headerContainer) {
      const buttons = headerContainer.querySelectorAll('button');
      if (buttons.length > 0) {
        const lastButton = buttons[buttons.length - 1];
        lastButton.parentNode.insertBefore(configButton, lastButton.nextSibling);
      } else {
        headerContainer.appendChild(configButton);
      }
    } else {
      document.body.appendChild(configButton);
    }
    console.log('‚ö†Ô∏è Bot√≥n insertado en ubicaci√≥n alternativa');
  }
}

// Crear bot√≥n de configuraci√≥n si no existe
if (!document.getElementById('configButton')) {
  const configButton = document.createElement('button');
  configButton.id = 'configButton';
  configButton.innerHTML = '<i class="fas fa-cog"></i>';
  configButton.title = 'Configuraci√≥n';
  configButton.style.cssText = `
    background: #2a2a2a;
    color: #ffffff;
    border: 1px solid #444;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 10px;
  `;
  
  // A√±adir evento
  configButton.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const existingMenu = document.getElementById('configMenu');
    if (existingMenu) {
      existingMenu.remove();
      return;
    }
    
    const rect = configButton.getBoundingClientRect();
    const menu = document.createElement('div');
    menu.id = 'configMenu';
    menu.style.cssText = `
      position: fixed;
      top: ${rect.bottom + 5}px;
      right: ${window.innerWidth - rect.right}px;
      background: #1a1a1a;
      border: 1px solid #444;
      border-radius: 10px;
      padding: 10px 0;
      min-width: 220px;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      font-family: Arial, sans-serif;
    `;
    
    menu.innerHTML = `
      <div style="padding: 12px 20px; color: #FFD700; font-weight: bold; border-bottom: 1px solid #444; margin-bottom: 8px; font-size: 14px;">
        ‚öôÔ∏è Configuraci√≥n
      </div>
      <div onclick="showLicensesView(); document.getElementById('configMenu').remove();" 
           style="padding: 12px 20px; cursor: pointer; color: #ffffff; display: flex; align-items: center; gap: 12px; font-size: 14px;">
        <i class="fas fa-key" style="color: #4CAF50;"></i> Gesti√≥n de Licencias
      </div>
      <div onclick="showSystemConfiguration(); document.getElementById('configMenu').remove();" 
           style="padding: 12px 20px; cursor: pointer; color: #ffffff; display: flex; align-items: center; gap: 12px; font-size: 14px;">
        <i class="fas fa-cog"></i> Configuraci√≥n del sistema
      </div>
      <div onclick="showHelpSupport(); document.getElementById('configMenu').remove();" 
           style="padding: 12px 20px; cursor: pointer; color: #ffffff; display: flex; align-items: center; gap: 12px; font-size: 14px;">
        <i class="fas fa-question-circle"></i> Ayuda y soporte
      </div>
      <div onclick="showAbout(); document.getElementById('configMenu').remove();" 
           style="padding: 12px 20px; cursor: pointer; color: #ffffff; display: flex; align-items: center; gap: 12px; border-top: 1px solid #444; margin-top: 8px; font-size: 14px;">
        <i class="fas fa-info-circle"></i> Acerca de
      </div>
    `;
    
    document.body.appendChild(menu);
    
    document.addEventListener('click', function closeHandler(e) {
      if (!menu.contains(e.target) && e.target.id !== 'configButton') {
        menu.remove();
        document.removeEventListener('click', closeHandler);
      }
    });
  });
  
  // A√±adir al body temporalmente
  document.body.appendChild(configButton);
  
  // Posicionar correctamente despu√©s de que todo est√© cargado
  setTimeout(positionConfigButton, 500);
  
  // Tambi√©n posicionar si se redimensiona la ventana
  window.addEventListener('resize', positionConfigButton);
}







// Guardar configuraci√≥n del sistema
function saveSystemConfiguration() {
  try {
    const themeSelect = document.getElementById('themeSelect');
    const modeSelect = document.getElementById('defaultModeSelect');
    
    if (!themeSelect || !modeSelect) {
      console.error('‚ùå No se encontraron los elementos de configuraci√≥n');
      return;
    }
    
    const config = {
      theme: themeSelect.value,
      defaultMode: modeSelect.value,
      lastUpdated: new Date().toISOString()
    };
    
    localStorage.setItem('systemConfig', JSON.stringify(config));
    applyTheme(config.theme);
    
    if (config.defaultMode && window.methodologyManager) {
      window.methodologyManager.setMode(config.defaultMode);
    }
    
    showNotification('‚úÖ Configuraci√≥n guardada y aplicada');
    document.getElementById('systemConfigModal')?.remove();
    
  } catch (error) {
    console.error('‚ùå Error al guardar configuraci√≥n:', error);
    showNotification('‚ùå Error al guardar configuraci√≥n');
  }
}







// === MODIFICAR INICIALIZACI√ìN PRINCIPAL ===
const originalDOMContentLoaded = () => {
  console.log('üéØ Iniciando aplicaci√≥n con validaci√≥n...');
  const dataLoaded = safeLoad();
  if (!dataLoaded || projects.length === 0) {
    console.log('üìù No hay datos, creando proyecto inicial...');
     } else {
    console.log('‚úÖ Datos cargados correctamente');
    renderProjects();
    selectProject(currentProjectIndex);
    checkOverdueTasks();
  }
  setupEventListeners();
  // ... resto de tu inicializaci√≥n
};


// === CERRAR SESI√ìN ===
function logout() {
  localStorage.removeItem('authToken');
  showNotification('‚úÖ Sesi√≥n cerrada correctamente');
  setTimeout(() => {
    location.reload(); // Recargar para mostrar el login
  }, 1000);
}


// Reemplazar el evento DOMContentLoaded
document.addEventListener('DOMContentLoaded', async () => {


  // üîê Cargar token aqu√≠, SOLO aqu√≠
  window.authToken = localStorage.getItem("authToken") || "";
  // ‚úÖ Verificar autenticaci√≥n ANTES de cargar la app
  const token = localStorage.getItem('authToken');
  if (!token) {
    showLoginScreen();
    return; // ‚¨ÖÔ∏è Detener aqu√≠ si no hay token
  }

  // üëá Solo si hay token, continuar con la app
  console.log('üéØ Iniciando aplicaci√≥n con validaci√≥n...');
  const dataLoaded = safeLoad();
  if (!dataLoaded || projects.length === 0) {
    console.log('üìù No hay datos, creando proyecto inicial...');
   
  } else {
    console.log('‚úÖ Datos cargados correctamente');
    renderProjects();
    selectProject(currentProjectIndex);
    checkOverdueTasks();
  }
  setupEventListeners();
  // ... resto de tu inicializaci√≥n
});


/**************************************
 * SISTEMA DE VALIDACI√ìN Y RESPALDO *
 **************************************/

console.log('üîß Iniciando sistema de validaci√≥n...');

// üîê Cargar token JWT almacenado

if (window.authToken) {
  console.log("üîê Token JWT cargado desde localStorage:", window.authToken.slice(0, 20) + "...");
  localStorage.setItem("authToken", window.authToken); // refuerza persistencia
}

// Variable para controlar el modo
let useBackend = true;



// === üü¢ Indicador visual de estado de backend ===
const connectionIndicator = document.createElement("div");
connectionIndicator.style.position = "fixed";
connectionIndicator.style.bottom = "10px";
connectionIndicator.style.right = "10px";
connectionIndicator.style.padding = "8px 14px";
connectionIndicator.style.borderRadius = "10px";
connectionIndicator.style.fontSize = "14px";
connectionIndicator.style.zIndex = "9999";
connectionIndicator.style.boxShadow = "0 2px 6px rgba(0,0,0,0.3)";
connectionIndicator.style.transition = "all 0.3s ease";
document.body.appendChild(connectionIndicator);

function updateConnectionIndicator(status) {
  if (status === "online") {
    connectionIndicator.textContent = "üü¢ Conectado al backend";
    connectionIndicator.style.background = "#2ecc71";
    connectionIndicator.style.color = "white";
  } else {
    connectionIndicator.textContent = "üî¥ Sin conexi√≥n al backend";
    connectionIndicator.style.background = "#e74c3c";
    connectionIndicator.style.color = "white";
  }
}

// ‚úÖ Verifica visualmente si hay sesi√≥n activa
if (window.authToken && window.authToken.length > 100) {
  console.log("‚úÖ Sesi√≥n activa con backend (JWT v√°lido)");
  const statusDiv = document.createElement("div");
  statusDiv.textContent = "üîê Sesi√≥n activa con backend";
  statusDiv.style.position = "fixed";
  statusDiv.style.bottom = "45px";
  statusDiv.style.right = "10px";
  statusDiv.style.background = "#2980b9";
  statusDiv.style.color = "white";
  statusDiv.style.padding = "8px 14px";
  statusDiv.style.borderRadius = "10px";
  statusDiv.style.fontSize = "14px";
  statusDiv.style.zIndex = "9999";
  statusDiv.style.boxShadow = "0 2px 6px rgba(0,0,0,0.3)";
  document.body.appendChild(statusDiv);
} else {
  console.warn("‚ö†Ô∏è No hay token JWT activo. Inicia sesi√≥n o asigna window.authToken manualmente.");
}

// üåê Comprobaci√≥n del backend
let lastStatus = null;

async function checkBackendStatus() {
  try {
   // Forzar URL correcta
   const backendURL = window.API_URL || "https://mi-sistema-proyectos-backend-4.onrender.com";
   const response = await fetch(`${backendURL}/api/health`, { cache: "no-store" });
    if (response.ok) {
      if (lastStatus === "offline") {
        console.log("üîÅ Backend restaurado. Intentando sincronizaci√≥n autom√°tica...");
        // Intenta sincronizar autom√°ticamente al reconectarse
        if (typeof forceSync === "function") {
          setTimeout(() => {
            try {
              forceSync();
              console.log("‚úÖ Sincronizaci√≥n autom√°tica ejecutada tras reconexi√≥n.");
            } catch (err) {
              console.warn("‚ö†Ô∏è Error en forceSync tras reconexi√≥n:", err);
            }
          }, 2000);
        }
      }
      lastStatus = "online";
      updateConnectionIndicator("online");
      useBackend = true;
      return true;
    }
  } catch {
    lastStatus = "offline";
    updateConnectionIndicator("offline");
    useBackend = false;
  }
  lastStatus = "offline";
  updateConnectionIndicator("offline");
  return false;
}

// üîÅ Revisar cada 15 segundos autom√°ticamente
setInterval(checkBackendStatus, 15000);
checkBackendStatus(); // ejecutar inmediatamente al iniciar





// Funci√≥n para verificar estado del backend
async function checkBackendStatus() {
  try {
    console.log('üîÑ Verificando conexi√≥n con backend...');
    const response = await fetch(`${API_URL}/api/health`);
    if (response.ok) {
      console.log('‚úÖ Backend disponible');
      useBackend = true;
      return true;
    }
  } catch (error) {
    console.warn('‚ö†Ô∏è Backend no disponible - Modo localStorage');
    useBackend = false;
  }
  return false;
}

// Funci√≥n de respaldo para guardar
async function safeSave() {
  console.group('üì§ Guardando datos en backend o localStorage');

  // Siempre guardar en localStorage
  localStorage.setItem('projects', JSON.stringify(projects));
  console.log('üì¶ Datos guardados en localStorage');

  // Verificar backend al momento de guardar
if (await checkBackendStatus()) {
  console.log("‚û°Ô∏è Intentando guardar en backend...");

    
  const token = window.authToken;
if (!token) {
   return true;
}

    
    try {
console.log("üîê Token usado para guardar:", token);

   const response = await fetch(`${API_URL}/api/projects`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          projects: projects,
          currentProjectIndex: currentProjectIndex,
          timestamp: new Date().toISOString()
        })
      });

      if (response.ok) {
        console.log('‚úÖ Datos guardados en MongoDB Atlas');
      } else {
        console.warn('‚ö†Ô∏è Error guardando en backend:', response.status);
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è Error de conexi√≥n, datos solo en localStorage');
    }
  }

  console.groupEnd();
  return true;
}





// Funci√≥n de respaldo para cargar
// Funci√≥n de respaldo para cargar
async function safeLoad() {
  console.group('üì• Cargando datos desde backend o localStorage');
  console.log('üîê Token disponible:', window.authToken ? "S√ç" : "NO");
  
  let loadedData = null;
  let backendAvailable = false;

  // ‚úÖ Primero verificar si hay token
  if (!window.authToken || window.authToken.length < 10) {
    console.warn('‚ö†Ô∏è No hay token v√°lido, usando localStorage');
  } else {
    // ‚úÖ Verificar si el backend est√° disponible
    try {
      console.log('üîÑ Verificando backend...');
      const healthResponse = await fetch(`${API_URL}/api/health`, {
        timeout: 5000
      });
      
      if (healthResponse.ok) {
        backendAvailable = true;
        console.log('‚úÖ Backend disponible');
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è Backend no disponible:', error.message);
    }

    // ‚úÖ Si el backend est√° disponible, intentar cargar desde ah√≠
    if (backendAvailable) {
      try {
        console.log('üîÑ Intentando cargar desde MongoDB...');
        const response = await fetch(`${API_URL}/api/projects`, {
          headers: { 
            'Authorization': `Bearer ${window.authToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        console.log('üì° Respuesta del backend:', response.status);
        
        if (response.ok) {
          loadedData = await response.json();
          console.log('‚úÖ Datos cargados desde MongoDB Atlas:', loadedData);
          
          // Guardar en localStorage como respaldo
          if (loadedData.projects) {
            localStorage.setItem('projects', JSON.stringify(loadedData.projects));
            localStorage.setItem('currentProjectIndex', loadedData.currentProjectIndex || 0);
            console.log('üì¶ Datos guardados en localStorage como respaldo');
          }
       } else if (response.status === 401) {
  console.warn('‚ö†Ô∏è Backend respondi√≥ 401. Continuando en modo local.');
  
  // ‚ö†Ô∏è NO borrar token
  // ‚ö†Ô∏è NO cerrar sesi√≥n
  // ‚ö†Ô∏è NO redirigir al login

  showNotification(
    'No se pudo sincronizar con el servidor. Trabajando en modo local.',
    'warning'
  );

  return []; // Continuar sin proyectos desde backend
}

      } catch (error) {
        console.warn('‚ö†Ô∏è Error cargando desde backend:', error.message);
      }
    }
  }

  // ‚ùå Si no se pudo cargar desde backend, usar localStorage
  if (!loadedData || !loadedData.projects) {
    console.log('üîÑ Usando datos de localStorage...');
    const savedProjects = localStorage.getItem('projects');
    if (savedProjects) {
      try {
        loadedData = {
          projects: JSON.parse(savedProjects),
          currentProjectIndex: parseInt(localStorage.getItem('currentProjectIndex') || '0')
        };
        console.log('‚úÖ Datos cargados desde localStorage');
      } catch (error) {
        console.error('‚ùå Error parseando localStorage:', error);
      }
    }
  }

  // Inicializar datos si no hay nada
  if (loadedData && loadedData.projects) {
    projects = loadedData.projects;
    currentProjectIndex = loadedData.currentProjectIndex || 0;
    console.log(`‚úÖ ${projects.length} proyectos cargados`);
  } else {
    console.log('üìù No hay datos, se crear√° proyecto inicial al interactuar');
  }

  console.groupEnd();
  return !!loadedData;
}







/**************************************
 * SISTEMA DE METODOLOG√çAS H√çBRIDAS - PASO 1 *
 **************************************/
class MethodologyManager {
    constructor() {
        this.currentMode = localStorage.getItem('projectMethodology') || 'hybrid';
    }

    setMode(mode) {
        const validModes = ['agile', 'traditional', 'hybrid'];
        if (validModes.includes(mode)) {
            this.currentMode = mode;
            localStorage.setItem('projectMethodology', mode);
            this.applyModeSettings();
            return true;
        }
        return false;
    }

    applyModeSettings() {
    console.log('Modo activo:', this.currentMode);
    const selector = document.getElementById('methodologySelector');
    if (selector) selector.value = this.currentMode;
    
    // A√±ade esta l√≠nea para ver el cambio visual
    document.body.setAttribute('data-mode', this.currentMode);


}

    getCurrentMode() {
        return this.currentMode;
    }
}

// Inicializar solo una instancia
window.methodologyManager = new MethodologyManager(); 




// ‚úÖ NUEVA CLASE DE LICENCIA REALISTA
class LicenseManager {
  constructor() {
    this.license = localStorage.getItem('userLicense') || 'free';
  }

  async getLicense() {
    const user = firebase.auth().currentUser;
    if (!user) return 'free';

    try {
      const res = await fetch(`${API_URL}/api/license/check/${user.uid}`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
      });
      const data = await res.json();
      if (data.valid && data.plan) {
        this.license = data.plan;
        localStorage.setItem('userLicense', data.plan);
        return data.plan;
      }
    } catch (err) {
      console.warn('No se pudo verificar licencia:', err);
    }
    return this.license;
  }

  canAccess(feature) {
    const allowedPlans = {
      'premiumExecutiveGantt': ['professional', 'premium']
    };
    return allowedPlans[feature]?.includes(this.license) || this.license === 'premium';
  }
}




// ========== PROTECCI√ìN POR MODO DE TRABAJO ==========
function requireModeAccess(view, callback) {
  const currentMode = window.methodologyManager.getCurrentMode();
  const allowedViews = {
    agile: ["board", "calendar", "list", "dashboard", "timeAllocation", "premiumExecutiveGantt"],
    traditional: ["gantt", "list", "reports", "dashboard", "profitability", "timeAllocation", "premiumExecutiveGantt"],
    hybrid: ["board", "gantt", "calendar", "list", "reports", "dashboard", "profitability", "timeAllocation", "premiumExecutiveGantt"]
  };

  if (!allowedViews[currentMode].includes(view)) {
    showNotification(`üí° En modo ${currentMode} no se recomienda usar esta vista. Cambia a otro modo.`);
    return;
  }
  callback();
}




// ========== UTILIDAD PARA PROTEGER FUNCIONES PREMIUM ==========
function requirePremiumAccess(featureName, callback) {
  if (!window.licenseManager.canAccess('premiumExecutiveGantt')) {
    showNotification(`üîí ${featureName} requiere el plan Profesional o Premium.`);
    return;
  }
  callback();
}




/**************************************
 * VARIABLES GLOBALES Y ELEMENTOS DOM *
 **************************************/
let projects = [];
let currentProjectIndex = 0;


// ========== FUNCIONES AUXILIARES B√ÅSICAS ==========

// 1. Progreso del proyecto



// 2. Actualizar selector
function updateProjectSelector() {
  const options = document.querySelectorAll('.project-option');
  if (!options.length) return;
  
  options.forEach((option, index) => {
    const isSelected = index === currentProjectIndex;
    option.style.background = isSelected ? 'rgba(52, 152, 219, 0.2)' : 'rgba(255,255,255,0.05)';
    option.style.border = `1px solid ${isSelected ? '#3498db' : 'rgba(255,255,255,0.1)'}`;
    const checkmark = option.querySelector('div > div:last-child');
    if (checkmark) {
      checkmark.style.background = isSelected ? '#3498db' : 'rgba(255,255,255,0.1)';
      checkmark.style.color = isSelected ? 'white' : 'transparent';
    }
  });
}

// 3. Funci√≥n para generar lista de dependencias (VERSI√ìN SIMPLIFICADA)
function generateDependenciesList(tasks) {
  if (!tasks || tasks.length === 0) {
    return '<div style="color: #95a5a6; font-size: 12px; font-style: italic;">No hay dependencias definidas</div>';
  }
  
  let hasDeps = false;
  tasks.forEach(task => {
    if (task.dependencies && task.dependencies.length > 0) {
      hasDeps = true;
    }
  });
  
  if (!hasDeps) {
    return '<div style="color: #95a5a6; font-size: 12px; font-style: italic;">No hay dependencias definidas</div>';
  }
  
  return `
    <div style="max-height: 120px; overflow-y: auto; margin-top: 10px;">
      <div style="color: #95a5a6; font-size: 11px; padding: 10px; text-align: center;">
        ${tasks.filter(t => t.dependencies && t.dependencies.length > 0).length} tareas con dependencias
      </div>
    </div>
    <button onclick="alert('Funcionalidad de dependencias')" style="
      width: 100%;
      background: rgba(155, 89, 182, 0.2);
      border: 1px solid #9b59b6;
      color: #9b59b6;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
      font-size: 11px;
    ">
      üîç Ver dependencias
    </button>
  `;
}

// 4. Detalles de tareas cr√≠ticas (VERSI√ìN SIMPLIFICADA)
function getCriticalTasksDetails(tasks) {
  const critical = tasks.filter(t => t.critical);
  if (critical.length === 0) return 'No hay tareas cr√≠ticas';
  return `${critical.length} tarea(s) cr√≠tica(s) identificada(s)`;
}

// 5. Fecha estimada
function calculatePredictedEndDatePremium(tasks) {
  if (tasks.length === 0) return 'No hay datos';
  return '31 Dic 2024';
}

// 6. Contar miembros del equipo
function countTeamMembers(tasks) {
  const members = new Set();
  tasks.forEach(task => {
    if (task.team && Array.isArray(task.team)) {
      task.team.forEach(member => {
        if (member && member !== 'Sin asignar') {
          members.add(member);
        }
      });
    }
  });
  return members.size;
}

// 7. Distribuci√≥n del equipo (VERSI√ìN SIMPLIFICADA)
function generateTeamDistribution(tasks) {
  const memberCount = countTeamMembers(tasks);
  if (memberCount === 0) {
    return '<div style="color: #95a5a6; font-size: 12px;">Sin asignaciones</div>';
  }
  return `<div style="color: #95a5a6; font-size: 12px;">${memberCount} miembro(s) asignado(s)</div>`;
}

// 8. Funci√≥n para dibujar dependencias (VERSI√ìN SIMPLIFICADA)
function drawPremiumDependenciesComplete(tasks) {
  const layer = document.getElementById("dependencyLayer");
  if (!layer) return;
  layer.innerHTML = "";
  console.log("‚úÖ Layer de dependencias limpiado");
}

// 9. Tooltips (VERSI√ìN SIMPLIFICADA)
function enableTaskTooltips() {
  let tooltip = document.getElementById("premium-tooltip");
  if (!tooltip) {
    tooltip = document.createElement("div");
    tooltip.id = "premium-tooltip";
    tooltip.style.cssText = `
      position: fixed;
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 13px;
      pointer-events: none;
      z-index: 99999;
      opacity: 0;
      transition: opacity .15s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
      white-space: nowrap;
      max-width: 300px;
    `;
    document.body.appendChild(tooltip);
  }

  // üëá üëá üëá LIMPIAR EVENTOS ANTERIORES üëá üëá üëá
  document.querySelectorAll(".premium-task").forEach(taskEl => {
    // Eliminar cualquier listener previo (simulando limpieza)
    // Como no podemos remover listeners an√≥nimos f√°cilmente, mejor:
    // ‚Üí Asegurarnos de que solo haya UN tooltip activo por tarea
    if (taskEl.dataset.tooltipEnabled === "true") return; // ya inicializado
    taskEl.dataset.tooltipEnabled = "true";

    // Ahora s√≠, agregar los listeners
    const handleMouseEnter = (e) => {
      const taskId = taskEl.dataset.taskId;
      const project = window.projects?.[window.currentProjectIndex];
      const task = project?.tasks?.find(t => String(t.id) === String(taskId));
      if (!task) return;

      const index = project.tasks.findIndex(t => String(t.id) === String(taskId));
      const seq = index + 1;
      const critical = task.critical || task.priority === 'alta' ? '‚ö†Ô∏è Cr√≠tica' : 'Normal';
      const assignee = task.assignee || task.owner || 'No asignado';
      const duration = task.estimatedTime ? `${task.estimatedTime}h` : '‚Äî';
      const deps = task.dependencies?.length > 0
        ? `üîó ${task.dependencies.length} dependencias`
        : 'Sin dependencias';

      tooltip.innerHTML = `
        <strong>${seq}. ${task.name}</strong><br>
        <span style="color:#95a5a6;font-size:12px;">${critical}</span><br>
        üë§ Asignado: ${assignee}<br>
        ‚è± Duraci√≥n: ${duration}<br>
        ${deps}
      `;
      tooltip.style.opacity = "1";
    };

    const handleMouseMove = (e) => {
      tooltip.style.left = (e.pageX + 15) + "px";
      tooltip.style.top = (e.pageY + 15) + "px";
    };

    const handleMouseLeave = () => {
      tooltip.style.opacity = "0";
    };

    taskEl.addEventListener("mouseenter", handleMouseEnter);
    taskEl.addEventListener("mousemove", handleMouseMove);
    taskEl.addEventListener("mouseleave", handleMouseLeave);
  });
  console.log("‚úÖ Tooltips activados una sola vez por tarea");
}


function syncTaskProgress(task) {
  if (task.status === 'completed') {
    task.progress = 100;
  } else if (task.status === 'inProgress') {
    task.progress = 50;
  } else {
    task.progress = 0;
  }
}







// ================= TASK STATUS CON HISTORIA =================



// ================= TASK STATUS CON SINCRONIZACI√ìN PERFECTA =================
function setTaskStatus(task, newStatus) {
  console.log(`üîÑ Cambiando estado de "${task.name}" de ${task.status} a ${newStatus}`);

  const oldStatus = task.status;
  if (oldStatus === newStatus) return;

  // Registrar en historial
  task.history = task.history || [];
  task.history.push({
    from: oldStatus,
    to: newStatus,
    date: new Date().toISOString()
  });

  // Actualizar estado
  task.status = newStatus;

  // üî• ACTUALIZAR PROGRESO SEG√öN EL ESTADO
  if (newStatus === 'completed') {
    task.progress = 100;
  } else if (newStatus === 'inProgress') {
    task.progress = task.progress || 50; // mantener valor anterior si existe
  } else {
    task.progress = 0;
  }


  // üî• GUARDAR CAMBIOS EN localStorage
  updateLocalStorage(); // ‚Üê ¬°ESTA L√çNEA ES CLAVE!

  // üî• ACTUALIZAR BURNDOWN SI EST√Å VISIBLE
  updateBurndownOnStatusChange();

  // Actualizar UI si es necesario
  if (typeof updateTaskUI === 'function') {
    setTimeout(() => updateTaskUI(task.id), 100);
  }

  return true;
}




// üìä FUNCI√ìN CORREGIDA PARA ACTUALIZAR BURNDOWN CUANDO CAMBIA EL ESTADO
function updateBurndownOnStatusChange() {
    console.log('üìâ Verificando si hay que actualizar burndown...');
    // 1. Verificar si el modal est√° visible
    const burndownModal = document.querySelector('.executive-overlay');
    const burndownCanvas = document.getElementById('burndownChartCanvasPremium');
    if (!burndownModal || !burndownCanvas) {
        console.log('‚ÑπÔ∏è Burndown no est√° visible, no se actualiza');
        return;
    }
    console.log('üéØ Burndown visible, forzando actualizaci√≥n...');

    // 2. OBTENER DATOS FRESQU√çSIMOS DEL PROYECTO ACTUAL
    const project = projects[currentProjectIndex];
    if (!project || !project.tasks) {
        console.error('‚ùå No hay proyecto o tareas');
        return;
    }

    // 3. CALCULAR NUEVOS DATOS DE FORMA FORZADA
    const freshData = calculateBurndownForRenderer(project.tasks);
    if (!freshData) {
        console.error('‚ùå No se pudieron calcular datos');
        return;
    }
    console.log('üìä Nuevos datos calculados:', {
        totalSP: freshData.totalStoryPoints,
        completedSP: freshData.completedStoryPoints,
        remainingSP: freshData.remainingPoints,
        trabajoReal: freshData.trabajoReal
    });

    // 4. FORZAR LA ACTUALIZACI√ìN DEL GR√ÅFICO
    try {
        // üí• DESTRUIR LA INSTANCIA ANTERIOR (esto es clave)
        if (window.burndownChartPremiumInstance) {
            window.burndownChartPremiumInstance.destroy();
            window.burndownChartPremiumInstance = null;
        }

        // üîÅ CREAR UNA NUEVA INSTANCIA DEL GR√ÅFICO
        renderBurndownChartPremium(freshData);

        // ‚úÖ ACTUALIZAR LAS M√âTRICAS EN LA PANTALLA
        updateBurndownMetricsInModal(project.tasks);

        console.log('‚úÖ Burndown actualizado completamente y forzado');
    } catch (error) {
        console.error('‚ùå Error cr√≠tico al actualizar el burndown:', error);
        // Si falla, intentar con una actualizaci√≥n m√°s simple
        if (window.burndownChartPremiumInstance) {
            window.burndownChartPremiumInstance.update('none');
        }
    }
}




// üìä ACTUALIZAR M√âTRICAS EN EL MODAL - VERSI√ìN CORREGIDA
function updateBurndownMetricsInModal(tasks) {
  const totalTasks = tasks.length;

  // ‚úÖ USAR EL MISMO CRITERIO QUE EL GR√ÅFICO: PROGRESO >= 100%
  const completedTasks = tasks.filter(t => (t.progress || 0) >= 100).length;

  const totalSP = tasks.reduce((sum, t) => sum + (Number(t.storyPoints) || 0), 0);
  const burnedSP = tasks.reduce((sum, t) => {
    const progress = t.progress || 0;
    const points = Number(t.storyPoints) || 0;
    return sum + (points * (progress / 100));
  }, 0);

  const completionPercentage = totalTasks > 0 ? 
    Math.round((completedTasks / totalTasks) * 100) : 0;
  const velocity = (burnedSP / 4).toFixed(1); // 4 semanas

  const totalEl = document.getElementById('totalTasks');
  const completedEl = document.getElementById('completedTasks');
  const velocityEl = document.getElementById('velocity');

  if (totalEl) totalEl.textContent = totalTasks;
  if (completedEl) {
    completedEl.textContent = `${completedTasks} (${completionPercentage}%)`;
    completedEl.title = `SP quemados: ${burnedSP.toFixed(1)}/${totalSP}`;
  }
  if (velocityEl) {
    velocityEl.textContent = velocity;
    velocityEl.title = `SP quemados por semana: ${velocity}`;
  }

  console.log(`üìà M√©tricas actualizadas: ${completedTasks}/${totalTasks} tareas (${burnedSP.toFixed(1)}/${totalSP} SP)`);
}

function buildBurndownFromDailyBurn(tasks) {
  const dailyBurn = calculateDailyBurnFromHistory(tasks);

  const totalPoints = tasks.reduce(
    (sum, t) => sum + (Number(t.storyPoints) || 1),
    0
  );

  const dates = Object.keys(dailyBurn).sort();
  if (dates.length === 0) return null;

  const startDate = new Date(dates[0]);
  const endDate = new Date();

  const labels = [];
  const real = [];
  const ideal = [];

  let remaining = totalPoints;
  const totalDays =
    Math.max(1, Math.ceil((endDate - startDate) / 86400000));

  const idealBurnPerDay = totalPoints / totalDays;

  for (let d = 0; d <= totalDays; d++) {
    const current = new Date(startDate);
    current.setDate(startDate.getDate() + d);
    const key = current.toISOString().split('T')[0];

    labels.push(key);

    // Burn real
    if (dailyBurn[key]) {
      remaining -= dailyBurn[key];
    }

    real.push(Math.max(0, remaining));
    ideal.push(Math.max(0, totalPoints - idealBurnPerDay * d));
  }

  return {
    labels,
    trabajoReal: real,
    trabajoIdeal: ideal,
    totalPoints
  };
}



// üîß FUNCI√ìN CORREGIDA: Calcular burndown desde tareas reales - VERSI√ìN DEFINITIVA
function calculateBurndownForRenderer(tasks) {
  console.log('üßÆ Calculando burndown para renderer...');

  let totalSP = 0;
  let burnedSP = 0;

  tasks.forEach(task => {
  const points = Number(task.storyPoints) || 1;
  totalSP += points;

  if (task.status === 'completed') {
    burnedSP += points;
  }
  // ‚ùå inProgress NO suma NADA
});



  const remainingSP = Math.max(0, totalSP - burnedSP);

  console.log(`üìä SP CALCULADO CORRECTAMENTE: Total=${totalSP}, Quemados=${burnedSP}, Restantes=${remainingSP}`);
  console.log(`üìã Estados individuales:`, tasks.map(t => `${t.name}: ${t.status}`));


  if (tasks.length === 0 || totalSP === 0) {
    return {
      semanas: [0, 1, 2, 3, 4],
      trabajoIdeal: [0, 0, 0, 0, 0],
      trabajoReal: [0, 0, 0, 0, 0],
      totalStoryPoints: 0,
      completedStoryPoints: 0,
      remainingPoints: 0,
      burnRateIdeal: "0",
      burnRateActual: "0",
      efficiency: "0%",
      weeksElapsed: 4
    };
  }

  const semanas = [0, 1, 2, 3, 4];
  const trabajoIdeal = [];
  const trabajoReal = [];

  for (let i = 0; i < semanas.length; i++) {
    const ideal = Math.max(0, totalSP - (totalSP / (semanas.length - 1)) * i);
    trabajoIdeal.push(ideal);

    // üî• CORRECCI√ìN: Usar el progreso real en cada semana
    if (i === 0) {
      trabajoReal.push(totalSP);
    } else if (i === semanas.length - 1) {
      trabajoReal.push(remainingSP);
    } else {
      // Calcular el progreso real en esta semana
      const progressInWeek = burnedSP / (semanas.length - 1) * i;
      const remainingInWeek = Math.max(0, totalSP - progressInWeek);
      trabajoReal.push(remainingInWeek);
    }
  }

  const completedTasks = tasks.filter(t => (t.progress || 0) >= 100).length;
  const burnRateIdeal = (totalSP / (semanas.length - 1)).toFixed(1);
  const burnRateActual = (burnedSP / (semanas.length - 1)).toFixed(1);
  const efficiency = ((burnedSP / totalSP) * 100).toFixed(1) + '%';

  const result = {
    semanas: semanas,
    trabajoIdeal: trabajoIdeal,
    trabajoReal: trabajoReal,
    totalStoryPoints: totalSP,
    completedStoryPoints: burnedSP,
    burnedStoryPoints: burnedSP,
    remainingPoints: remainingSP,
    burnRateIdeal: burnRateIdeal,
    burnRateActual: burnRateActual,
    efficiency: efficiency,
    weeksElapsed: semanas.length - 1
  };

  console.log('‚úÖ Burndown calculado CORRECTAMENTE:', {
    totalSP: result.totalStoryPoints,
    burnedSP: result.burnedStoryPoints,
    remainingSP: result.remainingPoints,
    lineaReal: result.trabajoReal
  });

  return result;

const velocitySPperWeek = burnedSP / result.weeksElapsed || 0;

const projection = {
  probable: probable,
  optimistic: optimistic,
  pessimistic: pessimistic,
  weeksToFinish: Math.ceil(weeksToFinish)
};

result.projection = projection;
result.velocitySPperWeek = velocitySPperWeek.toFixed(2);



}


// üîì SOLO para pruebas por consola
window.calculateBurndownForRenderer = calculateBurndownForRenderer;


// üìä M√âTRICAS REALES DEL PROYECTO (baseline estable)
function calculateProjectMetrics(tasks) {
  const totalTasks = tasks.length;

  const completedTasks = tasks.filter(
    t => t.status === 'completed'
  ).length;

  const remainingTasks = totalTasks - completedTasks;

  // üî• Burn diario real
  const dailyBurn = calculateDailyBurnFromHistory(tasks);
  const burnDays = Object.keys(dailyBurn).length;

  // Velocidad real (tareas por semana)
  const velocityPerWeek =
    burnDays > 0
      ? (completedTasks / (burnDays / 7))
      : 0;

  // üìÖ Predicci√≥n de fin
  let estimatedFinishDate = null;
  if (velocityPerWeek > 0 && remainingTasks > 0) {
    const weeksRemaining = remainingTasks / velocityPerWeek;
    estimatedFinishDate = new Date();
    estimatedFinishDate.setDate(
      estimatedFinishDate.getDate() + Math.ceil(weeksRemaining * 7)
    );
  }

  return {
    totalTasks,
    completedTasks,
    remainingTasks,
    velocityPerWeek: Number(velocityPerWeek.toFixed(2)),
    estimatedFinishDate
  };
}

// üîì Solo para pruebas por consola
window.calculateProjectMetrics = calculateProjectMetrics;




// üîí PUNTOS BASE POR TAREA (no depende de UI)
function getTaskPoints(task) {
 // Usar storyPoints si existe, sino 1 punto por defecto
  return Number(task.storyPoints) || 1;
}


// üî• C√°lculo base de puntos del proyecto (SAFE)
function calculateProjectPoints(tasks) {
  let total = 0;
  let burned = 0;

  tasks.forEach(task => {
    const points = getTaskPoints(task);
    total += points;

    if (task.status === 'completed') {
      burned += points;
    } else if (task.status === 'inProgress') {
      burned += points * 0.5;
    }
  });

  // üî• Regla ejecutiva: 100% completado = 0 restante
  const allCompleted = tasks.length > 0 && tasks.every(t => t.status === 'completed');
  if (allCompleted) {
    burned = total;
  }

  return {
    totalSP: total,
    burnedSP: burned,
    remainingSP: Math.max(0, Math.round((total - burned) * 100) / 100)
  };
}

// üîì Exponer solo para pruebas por consola
window.calculateProjectPoints = calculateProjectPoints;



// üî• VERSI√ìN MEJORADA: Burn diario basado en estado ACTUAL de tareas
function calculateDailyBurnFromHistory(tasks) {
  const daily = {};

  tasks.forEach(task => {
    if (task.status === 'completed') {
      // Buscar CU√ÅNDO se complet√≥ por √∫ltima vez
      const completionHistory = (task.history || [])
        .filter(h => h.to === 'completed')
        .sort((a, b) => new Date(b.date) - new Date(a.date)); // M√°s reciente primero
      
      if (completionHistory.length > 0) {
        const lastCompletion = completionHistory[0];
        const day = lastCompletion.date.split('T')[0];
        const points = getTaskPoints(task);
        daily[day] = (daily[day] || 0) + points;
      }
    }
  });

  console.log('üî• Burn diario MEJORADO:', daily);
  return daily;
}


// ============================================================================
// üìà DASHBOARD EJECUTIVO - BURNDOWN CHART & M√âTRICAS
// ============================================================================

// üî• FUNCI√ìN: Calcular datos de burndown desde tareas reales
function calculateBurndownFromTasks(tasks) {
  console.log('üßÆ Calculando datos de burndown...');
  
  // Si no hay tareas, crear datos de ejemplo
  if (!tasks || tasks.length === 0) {
    console.log('‚ö†Ô∏è Sin tareas, usando datos de ejemplo');
    tasks = [
      { name: 'Tarea de ejemplo', duration: 5, progress: 100, critical: false },
      { name: 'Tarea cr√≠tica', duration: 8, progress: 50, critical: true }
    ];
  }
  
  // Supongamos 10 semanas de proyecto
  const totalWeeks = 10;
  const totalStoryPoints = tasks.reduce(
  (sum, task) => sum + (Number(task.storyPoints) || 0),
  0
);

  
  // L√≠nea ideal (burn linear)
  const idealLine = [];
  const idealBurnRate = totalStoryPoints / totalWeeks;
  
  for (let week = 0; week <= totalWeeks; week++) {
    idealLine.push(Math.max(0, totalStoryPoints - (idealBurnRate * week)));
  }
  
  // L√≠nea real (basada en progreso)
  const realLine = [];
  const completedStoryPoints = tasks.reduce(
  (sum, task) =>
    sum + (task.status === 'completed'
      ? Number(task.storyPoints) || 0
      : 0),
  0
);

  
  // Calcular velocidad real basada en progreso
  const weeksElapsed = totalWeeks * 0.6; // Asumir 60% del tiempo transcurrido
  const actualBurnRate = weeksElapsed > 0 ? completedStoryPoints / weeksElapsed : idealBurnRate * 0.7;
  const remainingPoints = totalStoryPoints - completedStoryPoints;
  
  for (let week = 0; week <= totalWeeks; week++) {
    if (week <= weeksElapsed) {
      // Ya transcurrido
      realLine.push(Math.max(0, totalStoryPoints - (actualBurnRate * week)));
    } else {
      // Proyecci√≥n
      const projected = Math.max(0, remainingPoints - (actualBurnRate * (week - weeksElapsed)));
      realLine.push(projected);
    }
  }
  
  // Scope creep (cambios de alcance)
  const scopeCreep = [];
  const creepPerWeek = (totalStoryPoints * 0.03); // 3% de creep por semana
  for (let week = 0; week <= totalWeeks; week++) {
    scopeCreep.push(Math.min(totalStoryPoints * 1.5, creepPerWeek * week));
  }
  
  return {
    semanas: Array.from({length: totalWeeks + 1}, (_, i) => i),
    trabajoIdeal: idealLine,
    trabajoReal: realLine,
    scopeCreep: scopeCreep,
    totalStoryPoints,
    completedStoryPoints,
    remainingPoints,
    burnRateIdeal: idealBurnRate.toFixed(1),
    burnRateActual: actualBurnRate.toFixed(1),
    efficiency: ((actualBurnRate / idealBurnRate) * 100).toFixed(1),
    weeksElapsed: weeksElapsed.toFixed(1)
  };
}




// üîÑ REFRESH CENTRAL DEL BURNDOWN (NO TOCAR)
function refreshBurndown() {
  if (!window.burndownChartPremiumInstance) return;

  console.log('üìâ Refresh Burndown REAL');

  const bd = calculateBurndownForRenderer(
  projects[currentProjectIndex].tasks
);

  renderBurndownChartPremium(bd);
}






// üî• VERSI√ìN CORREGIDA: Burn diario basado en estado FINAL de tareas
function calculateDailyBurnFromHistory(tasks) {
  const daily = {};

  tasks.forEach(task => {
    const points = getTaskPoints(task);
    
    // Si la tarea NO est√° completada actualmente, NO suma puntos
    if (task.status !== 'completed') {
      return;
    }

    // Buscar la √öLTIMA vez que se complet√≥ (ignorando cambios posteriores)
    if (task.history && Array.isArray(task.history)) {
      // Filtrar solo eventos de completion
      const completionEvents = task.history.filter(h => h.to === 'completed');
      
      if (completionEvents.length > 0) {
        // Tomar el M√ÅS RECIENTE evento de completion
        const lastCompletion = completionEvents[completionEvents.length - 1];
        const day = lastCompletion.date.split('T')[0];
        
        // Verificar que despu√©s de este completion no haya cambios a otro estado
        const eventsAfterLastCompletion = task.history.slice(
          task.history.indexOf(lastCompletion) + 1
        );
        
        const hasReverted = eventsAfterLastCompletion.some(
          h => h.to === 'pending' || h.to === 'inProgress'
        );
        
        // Solo contar si NO ha revertido despu√©s del √∫ltimo completion
        if (!hasReverted) {
          daily[day] = (daily[day] || 0) + points;
        }
      }
    }
  });

  console.log('‚úÖ Burn diario CORREGIDO (basado en estado actual):', daily);
  return daily;
}




// üß≠ TIMELINE REAL DEL PROYECTO (basado en historia)
function buildProjectTimeline(tasks) {
  const events = [];

  tasks.forEach(task => {
    if (!Array.isArray(task.history)) return;

    task.history.forEach(h => {
      events.push({
        taskId: task.id,
        taskName: task.name,
        from: h.from,
        to: h.to,
        date: new Date(h.date)
      });
    });
  });

  // ordenar cronol√≥gicamente
  events.sort((a, b) => a.date - b.date);

  return events;
}

// üîì Solo para pruebas por consola
window.buildProjectTimeline = buildProjectTimeline;



function renderProjectTimeline(tasks) {
  const container = document.getElementById('projectTimeline');
  if (!container) return;

  const events = buildProjectTimeline(tasks)
    .sort((a, b) => a.date - b.date);

  if (!events.length) {
    container.innerHTML = '<p>Sin actividad registrada</p>';
    return;
  }

  container.innerHTML = events.map(e => `
    <div class="timeline-item">
      <div class="timeline-date">${e.date.toLocaleString()}</div>
      <div class="timeline-task">${e.taskName}</div>
      <div class="timeline-change">${e.from} ‚Üí ${e.to}</div>
    </div>
  `).join('');
}




// üî• NUEVO: Burndown REAL (supera Jira)
function buildBurndownFromDailyBurn(tasks) {
  const dailyBurn = calculateDailyBurnFromHistory(tasks);

  const totalPoints = tasks.reduce(
    (sum, t) => sum + (Number(t.storyPoints) || 1),
    0
  );

  const dates = Object.keys(dailyBurn).sort();
  if (dates.length === 0) return null;

  const startDate = new Date(dates[0]);
  const endDate = new Date();

  const labels = [];
  const trabajoReal = [];
  const trabajoIdeal = [];

  let remaining = totalPoints;
  const totalDays = Math.max(
    1,
    Math.ceil((endDate - startDate) / 86400000)
  );

  const idealBurnPerDay = totalPoints / totalDays;

  for (let d = 0; d <= totalDays; d++) {
    const current = new Date(startDate);
    current.setDate(startDate.getDate() + d);
    const key = current.toISOString().split('T')[0];

    labels.push(key);

    if (dailyBurn[key]) {
      remaining -= dailyBurn[key];
    }

    trabajoReal.push(Math.max(0, remaining));
    trabajoIdeal.push(Math.max(0, totalPoints - idealBurnPerDay * d));
  }

  return {
    labels,
    trabajoReal,
    trabajoIdeal,
    totalPoints
  };
}





// üî• FUNCI√ìN: Crear modal de Burndown
function createBurndownModal(projectName, burndownData, tasks) {
  
  
  // Si ya existe, removerlo
  document.querySelector('.executive-overlay')?.remove();
  
  // Crear overlay
  const overlay = document.createElement('div');
  overlay.className = 'executive-overlay';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    z-index: 1000000;
    display: flex;
    align-items: center;
    justify-content: center;
  `;
  
  // Crear modal premium
  const modal = document.createElement('div');
  modal.className = 'executive-modal';
  modal.style.cssText = `
    width: 90vw;
    height: 85vh;
    background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
    border-radius: 24px;
    box-shadow: 0 40px 80px rgba(0,0,0,0.8);
    border: 2px solid rgba(52, 152, 219, 0.3);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    position: relative;
  `;
  
  // Header del modal
  modal.innerHTML = `
    <div style="
      padding: 25px 35px;
      background: linear-gradient(90deg, #0a0a1a, #1a1a3a);
      border-bottom: 1px solid rgba(52, 152, 219, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    ">
      <div>
        <h2 style="margin: 0 0 8px 0; color: white; font-size: 28px;">
          üìâ <span style="color: #2ecc71;">Burndown Chart</span> - ${projectName}
        </h2>
        <p style="margin: 0; color: #95a5a6; font-size: 14px;">
          An√°lisis ejecutivo de progreso vs tiempo ‚Ä¢ Actualizado: ${new Date().toLocaleTimeString()}
        </p>
      </div>
      <button onclick="this.closest('.executive-overlay').remove()" style="
        background: rgba(231, 76, 60, 0.2);
        border: 1px solid #e74c3c;
        color: #e74c3c;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        transition: all 0.3s;
      " onmouseover="this.style.background='rgba(231, 76, 60, 0.4)'"
         onmouseout="this.style.background='rgba(231, 76, 60, 0.2)'">
        √ó Cerrar
      </button>
    </div>
    
    <div style="flex: 1; display: flex; overflow: hidden;">
      <!-- Panel izquierdo: Gr√°fico -->
      <div style="flex: 2; padding: 25px; display: flex; flex-direction: column;">
        <div style="
          background: rgba(255,255,255,0.03);
          border-radius: 16px;
          padding: 20px;
          flex: 1;
          display: flex;
          flex-direction: column;
          margin-bottom: 20px;
          border: 1px solid rgba(255,255,255,0.1);
        ">
          <div style="color: white; font-size: 18px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
            <span style="color: #3498db;">üìä</span> Progreso del Proyecto (Story Points)
          </div>
          <div style="flex: 1; position: relative;">
            <canvas id="burndownChartCanvas" style="width: 100%; height: 100%;"></canvas>
          </div>
        </div>
        
        <!-- Mini KPIs debajo del gr√°fico -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
          <div style="
            background: rgba(46, 204, 113, 0.1);
            border: 1px solid rgba(46, 204, 113, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
          ">
            <div style="color: #2ecc71; font-size: 24px; font-weight: bold; margin-bottom: 5px;">
              ${burndownData.completedStoryPoints}/${burndownData.totalStoryPoints}
            </div>
            <div style="color: #95a5a6; font-size: 12px;">Puntos Completados</div>
          </div>
          
          <div style="
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
          ">
            <div style="color: #3498db; font-size: 24px; font-weight: bold; margin-bottom: 5px;">
              ${burndownData.burnRateActual}
            </div>
            <div style="color: #95a5a6; font-size: 12px;">Velocidad (pts/semana)</div>
          </div>
          
          <div style="
            background: rgba(243, 156, 18, 0.1);
            border: 1px solid rgba(243, 156, 18, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
          ">
            <div style="color: #f39c12; font-size: 24px; font-weight: bold; margin-bottom: 5px;">
              ${burndownData.efficiency}%
            </div>
            <div style="color: #95a5a6; font-size: 12px;">Eficiencia vs Plan</div>
          </div>
          
          <div style="
            background: rgba(155, 89, 182, 0.1);
            border: 1px solid rgba(155, 89, 182, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
          ">
            <div style="color: #9b59b6; font-size: 24px; font-weight: bold; margin-bottom: 5px;">
              ${Math.round(burndownData.remainingPoints / burndownData.burnRateActual)}w
            </div>
            <div style="color: #95a5a6; font-size: 12px;">Semanas Restantes</div>
          </div>
        </div>
      </div>
      
      <!-- Panel derecho: An√°lisis y m√©tricas -->
      <div style="flex: 1; padding: 25px; border-left: 1px solid rgba(255,255,255,0.1);">
        <div style="margin-bottom: 30px;">
          <h3 style="color: white; margin: 0 0 20px 0; font-size: 20px; display: flex; align-items: center; gap: 10px;">
            <span style="color: #e74c3c;">üìã</span> An√°lisis Ejecutivo
          </h3>
          
          <div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; margin-bottom: 15px;">
              <div style="
                width: 12px;
                height: 12px;
                background: ${parseFloat(burndownData.efficiency) >= 100 ? '#2ecc71' : 
                             parseFloat(burndownData.efficiency) >= 80 ? '#f1c40f' : '#e74c3c'};
                border-radius: 50%;
                margin-right: 10px;
              "></div>
              <span style="color: white; font-weight: bold;">Estado del Proyecto</span>
            </div>
            <div style="color: #95a5a6; font-size: 14px; line-height: 1.5;">
              ${getProjectStatusAnalysis(burndownData, tasks)}
            </div>
          </div>
          
          <div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 20px;">
            <div style="color: white; font-weight: bold; margin-bottom: 15px;">üìå Recomendaciones</div>
            <div style="color: #95a5a6; font-size: 14px;">
              <ul style="margin: 0; padding-left: 20px;">
                ${getRecommendations(burndownData, tasks).map(rec => 
                  `<li style="margin-bottom: 8px;">${rec}</li>`
                ).join('')}
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Tareas Cr√≠ticas -->
        <div>
          <h3 style="color: white; margin: 0 0 15px 0; font-size: 18px; display: flex; align-items: center; gap: 10px;">
            <span style="color: #e74c3c;">üî•</span> Tareas Cr√≠ticas Pendientes
          </h3>
          <div style="max-height: 200px; overflow-y: auto;">
            ${tasks.filter(t => t.critical && (t.progress || 0) < 100)
              .map((task, index) => `
                <div style="
                  background: rgba(231, 76, 60, 0.1);
                  border: 1px solid rgba(231, 76, 60, 0.3);
                  border-radius: 8px;
                  padding: 12px;
                  margin-bottom: 10px;
                ">
                  <div style="color: white; font-weight: bold; margin-bottom: 5px;">
                    ${index + 1}. ${task.name}
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #95a5a6; font-size: 12px;">Progreso: ${task.progress || 0}%</span>
                    <span style="color: #f39c12; font-size: 12px;">${task.duration || 0} d√≠as</span>
                  </div>
                </div>
              `).join('') || 
              '<div style="color: #95a5a6; text-align: center; padding: 20px; font-style: italic;">No hay tareas cr√≠ticas pendientes</div>'
            }
          </div>
        </div>
      </div>
    </div>
    
    <!-- Footer -->
    <div style="
      padding: 15px 35px;
      background: rgba(255,255,255,0.03);
      border-top: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #95a5a6;
      font-size: 13px;
    ">
      <div>
        <span>üìä M√©tricas calculadas autom√°ticamente desde ${tasks.length} tareas</span>
      </div>
      <div style="display: flex; gap: 20px;">
        <button onclick="exportBurndownChart()" style="
          background: rgba(52, 152, 219, 0.2);
          border: 1px solid #3498db;
          color: #3498db;
          padding: 8px 15px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 12px;
        ">
          üì• Exportar como PNG
        </button>
        <button onclick="generateExecutiveReport()" style="
          background: rgba(46, 204, 113, 0.2);
          border: 1px solid #2ecc71;
          color: #2ecc71;
          padding: 8px 15px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 12px;
        ">
          üìÑ Generar Reporte PDF
        </button>
      </div>
    </div>
  `;
  
  // Agregar al DOM
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  
  // Renderizar gr√°fico despu√©s de que el DOM est√© listo
  // Renderizar gr√°fico con m√∫ltiples intentos
function renderChartWithRetry(attempt) {
  if (attempt > 3) {
    console.warn('‚ùå No se pudo renderizar el burndown');
    return;
  }

  setTimeout(() => {
    console.log(`üîÑ Intentando renderizar gr√°fico (intento ${attempt}/3)...`);

    renderBurndownChartPremium(burndownData);

    setTimeout(() => {
      if (!window.burndownChartInstance) {
        console.log('‚ö†Ô∏è Gr√°fico no creado, reintentando...');
        renderChartWithRetry(attempt + 1);
      }
    }, 500);

  }, 200 * attempt);
}

// üî• DISPARO INICIAL
renderChartWithRetry(1);

console.log('‚úÖ Modal de Burndown creado exitosamente');

}







// ‚ö†Ô∏è LEGACY / NO USADO POR BURNDOWN PREMIUM
// Esta funci√≥n NO se ejecuta en el Gantt Ejecutivo
// üî• FUNCI√ìN: Renderizar gr√°fico con Chart.js
function renderBurndownChart(burndownData) {
console.log('üß™ renderBurndownChart EJECUTADO');
  const canvas = document.getElementById('burndownChartCanvas');
  if (!canvas) {
    console.error('‚ùå Canvas no encontrado');
    return;
  }
  
  const ctx = canvas.getContext('2d');
  


// üßπ Destruir Burndown anterior si existe
if (window.burndownChartInstance) {
  console.log('üßπ Destruyendo Burndown anterior');
  window.burndownChartInstance.destroy();
  window.burndownChartInstance = null;
}

console.log('üü† DATASET REAL FINAL:', data.trabajoReal);

  
  // Crear nuevo gr√°fico
  window.burndownChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: burndownData.semanas.map(w => `Sem ${w}`),
      datasets: [
        {

          label: 'L√≠nea Ideal',
    data: burndownData.trabajoIdeal,
    borderColor: '#2ecc71',
    backgroundColor: 'rgba(46, 204, 113, 0.1)',
    borderWidth: 3,
    fill: false,
    tension: 0.1,
    pointRadius: 0
  },
  {
          label: 'Progreso Real',
    data: data.trabajoReal,
    borderColor: '#3498db',
    backgroundColor: 'transparent',
    borderWidth: 3,
    fill: false,
    tension: 0,
    pointRadius: 4,
      
        },








        {
          label: 'Scope Creep',
          data: burndownData.scopeCreep,
          borderColor: '#e74c3c',
          backgroundColor: 'rgba(231, 76, 60, 0.1)',
          borderWidth: 2,
          borderDash: [5, 5],
          fill: false,
          tension: 0,
          pointRadius: 0
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
          labels: {
            color: '#95a5a6',
            font: {
              size: 12
            }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          titleColor: '#3498db',
          bodyColor: '#ecf0f1',
          borderColor: '#3498db',
          borderWidth: 1,
          callbacks: {
            label: function(context) {
              let label = context.dataset.label || '';
              if (label) {
                label += ': ';
              }
              label += context.parsed.y.toFixed(1) + ' puntos';
              return label;
            }
          }
        }
      },
      scales: {
        x: {
          grid: {
            color: 'rgba(255, 255, 255, 0.1)'
          },
          ticks: {
            color: '#95a5a6'
          }
        },
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(255, 255, 255, 0.1)'
          },
          ticks: {
            color: '#95a5a6',
            callback: function(value) {
              return value + ' pts';
            }
          },
          title: {
            display: true,
            text: 'Story Points Restantes',
            color: '#95a5a6'
          }
        }
      }
    }
  });
  











// üß™ DEBUG CORRECTO (PEGAR AQU√ç üëá)
console.log('üß™ Instancia Burndown creada:', window.burndownChartInstance);
console.log(
  'üß™ Tipo:',
  window.burndownChartInstance?.constructor?.name
);


  console.log('‚úÖ Gr√°fico Burndown renderizado');
}


// üî• FUNCIONES AUXILIARES
function getProjectStatusAnalysis(burndownData, tasks) {
  const efficiency = parseFloat(burndownData.efficiency);
  const criticalPending = tasks.filter(t => t.critical && (t.progress || 0) < 100).length;
  
  if (efficiency >= 100 && criticalPending === 0) {
    return '‚úÖ PROYECTO EN CAMINO - Excelente rendimiento. Todas las m√©tricas est√°n en verde. El equipo est√° superando las expectativas y las tareas cr√≠ticas est√°n bajo control.';
  } else if (efficiency >= 80) {
    return 'üü° PROYECTO EN RIESGO MODERADO - El rendimiento es aceptable pero hay √°reas de mejora. ' + 
           (criticalPending > 0 ? `Existen ${criticalPending} tareas cr√≠ticas pendientes que requieren atenci√≥n.` : '');
  } else {
    return 'üî¥ PROYECTO EN RIESGO ALTO - Se requiere intervenci√≥n ejecutiva. ' +
           `La eficiencia est√° en ${efficiency}% (debajo del 80% objetivo). ` +
           (criticalPending > 0 ? `${criticalPending} tareas cr√≠ticas est√°n pendientes. ` : '') +
           'Se recomienda revisar recursos y planificaci√≥n.';
  }
}

function getRecommendations(burndownData, tasks) {
  const recommendations = [];
  const efficiency = parseFloat(burndownData.efficiency);
  const criticalPending = tasks.filter(t => t.critical && (t.progress || 0) < 100).length;
  
  if (efficiency < 80) {
    recommendations.push('Revisar asignaci√≥n de recursos del equipo');
    recommendations.push('Considerar extensi√≥n de plazo o reducci√≥n de alcance');
  }
  
  if (criticalPending > 0) {
    recommendations.push(`Priorizar las ${criticalPending} tareas cr√≠ticas pendientes`);
    recommendations.push('Asignar recursos senior a tareas cr√≠ticas');
  }
  
  if (burndownData.scopeCreep[burndownData.scopeCreep.length - 1] > 0) {
    recommendations.push('Congelar cambios de alcance hasta recuperar cronograma');
  }
  
  if (recommendations.length === 0) {
    recommendations.push('Mantener el ritmo actual - El proyecto va por buen camino');
  }
  
  return recommendations;
}

// üî• FUNCIONES DE EXPORTACI√ìN
window.exportBurndownChart = function() {
  if (window.burndownChart) {
    const link = document.createElement('a');
    link.download = `burndown-${new Date().toISOString().slice(0,10)}.png`;
    link.href = window.burndownChart.toBase64Image();
    link.click();
    alert('üì• Gr√°fico exportado como PNG');
  }
};

window.generateExecutiveReport = function() {
  alert('üìÑ Generando reporte ejecutivo PDF...\n\nEl reporte incluir√°:\n‚Ä¢ Gr√°fico Burndown\n‚Ä¢ An√°lisis de m√©tricas\n‚Ä¢ Recomendaciones\n‚Ä¢ Tareas cr√≠ticas\n\n(Funci√≥n en desarrollo)');
};

// üî• FUNCI√ìN: Agregar estilos CSS
function addExecutiveDashboardStyles() {
  // Verificar si ya existen los estilos
  if (document.getElementById('executive-dashboard-styles')) {
    return;
  }
  
  const styles = document.createElement('style');
  styles.id = 'executive-dashboard-styles';
  styles.textContent = `
    /* Animaciones para el modal ejecutivo */
    .executive-overlay {
      animation: fadeIn 0.3s ease-out;
    }
    
    .executive-modal {
      animation: slideUp 0.4s cubic-bezier(0.22, 1, 0.36, 1);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    /* Estilos para scrollbars */
    .executive-modal ::-webkit-scrollbar {
      width: 8px;
    }
    
    .executive-modal ::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
    }
    
    .executive-modal ::-webkit-scrollbar-thumb {
      background: rgba(52, 152, 219, 0.5);
      border-radius: 4px;
    }
    
    .executive-modal ::-webkit-scrollbar-thumb:hover {
      background: rgba(52, 152, 219, 0.7);
    }
    
    /* Efectos hover para elementos interactivos */
    .executive-modal button {
      transition: all 0.3s ease;
    }
    
    .executive-modal button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
  `;
  document.head.appendChild(styles);
  console.log('‚úÖ Estilos ejecutivos agregados');
}

// üî• INICIALIZAR AL CARGAR LA P√ÅGINA
document.addEventListener('DOMContentLoaded', function() {
  console.log('üìà Dashboard Ejecutivo - M√≥dulo Burndown cargado');
  
  // Agregar estilos autom√°ticamente
  setTimeout(addExecutiveDashboardStyles, 1000);
});

// PRIMERO: Crear el contenedor si no existe
function asegurarContenedor() {
  let container = document.getElementById('burndownChartContainer');
  
  if (!container) {
    console.log('üì¶ Creando contenedor del gr√°fico...');
    container = document.createElement('div');
    container.id = 'burndownChartContainer';
    container.style.cssText = `
      width: 100%;
      height: 400px;
      background: #1e293b;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      position: relative;
    `;
    
    // Buscar un lugar donde insertarlo
    const mainContent = document.querySelector('main, .container, body');
    if (mainContent) {
      mainContent.appendChild(container);
    } else {
      document.body.appendChild(container);
    }
    
    // Crear canvas dentro del contenedor
    container.innerHTML = '<canvas id="burndownChartCanvas"></canvas>';
    
    console.log('‚úÖ Contenedor creado:', container);
  }
  
  return container;
}

// SEGUNDO: Corregir la funci√≥n renderBurndownChart
function renderBurndownChart(burndownData) {
  console.log('üé® Iniciando renderizado de gr√°fico...');
  
  // 1. Asegurar que el contenedor existe
  const container = asegurarContenedor();
  
  // 2. Obtener el canvas
  let canvas = document.getElementById('burndownChartCanvas');
  if (!canvas) {
    console.log('üîÑ Canvas no encontrado, recreando...');
    container.innerHTML = '<canvas id="burndownChartCanvas"></canvas>';
    canvas = document.getElementById('burndownChartCanvas');
  }
  
  // 3. Asegurar dimensiones
  canvas.style.cssText = `
    width: 100% !important;
    height: 100% !important;
    display: block !important;
    visibility: visible !important;
  `;
  
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
  
  console.log('üìê Canvas dimensiones:', canvas.width, 'x', canvas.height);
  
  // 4. CORREGIR: Usar la variable correcta para la instancia
  // En tu c√≥digo dice window.burndownChart.destroy pero deber√≠a ser window.burndownChartInstance
  if (window.burndownChartInstance && typeof window.burndownChartInstance.destroy === 'function') {
    console.log('üóëÔ∏è Destruyendo instancia previa...');
    window.burndownChartInstance.destroy();
  }
  
  // 5. Obtener contexto
  const ctx = canvas.getContext('2d');
  if (!ctx) {
    console.error('‚ùå Contexto 2D no disponible');
    return;
  }
  
  // 6. Renderizar el gr√°fico
  try {
    console.log('üìä Creando nuevo gr√°fico...');
    
    // Datos por defecto si no se proporcionan
    const data = burndownData || {
      semanas: [1, 2, 3, 4, 5, 6],
      trabajoIdeal: [100, 83, 66, 50, 33, 16, 0],
      trabajoReal: [100, 90, 85, 70, 60, 40, 20],
      scopeCreep: [0, 0, 5, 10, 15, 20, 25]
    };
    
    // Configuraci√≥n simplificada para prueba
    window.burndownChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.semanas.map(w => `Sem ${w}`),
        datasets: [
          {
            label: 'L√≠nea Ideal',
            data: data.trabajoIdeal,
            borderColor: '#2ecc71',
            backgroundColor: 'transparent',
            borderWidth: 3,
            fill: false,
            borderDash: [5, 5]
          },
          {
            label: 'Progreso Real',
            data: data.trabajoReal,
            borderColor: '#3498db',
            backgroundColor: 'rgba(52, 152, 219, 0.1)',
            borderWidth: 4,
            fill: true,
            tension: 0.2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'top'
          }
        }
      }
    });
    
    console.log('‚úÖ Gr√°fico creado exitosamente!');
    
    // Forzar redimensionamiento
    setTimeout(() => {
      if (window.burndownChartInstance) {
        window.burndownChartInstance.resize();
        console.log('üîÑ Gr√°fico redimensionado');
      }
    }, 100);
    
  } catch (error) {
    console.error('‚ùå Error creando gr√°fico:', error);
    
    // Mostrar error visual
    container.innerHTML = `
      <div style="
        color: white;
        padding: 20px;
        text-align: center;
        background: #ef4444;
        border-radius: 8px;
        margin: 10px;
      ">
        <h3>Error al crear gr√°fico</h3>
        <p>${error.message}</p>
      </div>
    `;
  }
}


function renderBurndownChartDefinitivo(burndownData) {
  console.clear();
  console.log('üöÄ INICIANDO RENDERIZADO DEFINITIVO...');
  

  
  // 2. ELIMINAR CONTENEDORES EXISTENTES (para empezar fresco)
  const oldContainer = document.getElementById('burndownChartContainer');
  if (oldContainer) {
    oldContainer.remove();
  }
  
  // 3. CREAR CONTENEDOR EN UNA POSICI√ìN VISIBLE
  let container;
  if (existingContainer) {
    // Reutilizar el contenedor existente
    container = existingContainer;
    container.innerHTML = ''; // limpiar contenido anterior
    container.id = 'premiumExecutiveGantt'; // asegurar ID
    // Restaurar estilos b√°sicos
    container.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 95vw;
      height: 90vh;
      background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
      border-radius: 24px;
      box-shadow: 0 30px 60px rgba(0,0,0,0.6);
      border: 1px solid rgba(52, 152, 219, 0.4);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      z-index: 999999;
    `;
  } else {
    // Crear nuevo contenedor (flujo inicial)
    container = document.createElement('div');
    container.id = 'premiumExecutiveGantt';
    container.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 95vw;
      height: 90vh;
      background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
      border-radius: 24px;
      box-shadow: 0 30px 60px rgba(0,0,0,0.6);
      border: 1px solid rgba(52, 152, 219, 0.4);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      z-index: 999999;
    `;
  }

  
  // 4. AGREGAR T√çTULO VISIBLE
  container.innerHTML = `
    <h3 style="color: #fbbf24; margin: 0 0 15px 0; text-align: center; font-size: 20px;">
      üìà BURNDOWN CHART - DEFINITIVO
    </h3>
    <canvas id="burndownChartCanvas"></canvas>
  `;
  
  // 5. AGREGAR AL BODY (al principio para asegurar visibilidad)
  document.body.insertBefore(container, document.body.firstChild);
  
  // 6. OBTENER CANVAS Y ESTABLECER DIMENSIONES
  const canvas = document.getElementById('burndownChartCanvas');
  const ctx = canvas.getContext('2d');
  
  // DIMENSIONES F√çSICAS (no CSS)
  canvas.width = 760;  // 800 - 40px padding
  canvas.height = 420; // 500 - 80px (t√≠tulo + padding)
  
  // DIMENSIONES CSS
  canvas.style.cssText = `
    width: 760px !important;
    height: 420px !important;
    display: block !important;
    background: #0f172a !important;
    border-radius: 8px !important;
    border: 2px solid #10b981 !important;
    box-sizing: border-box !important;
  `;
  
  console.log('‚úÖ Contenedor creado en posici√≥n fija');
  console.log('üìè Canvas dimensiones f√≠sicas:', canvas.width, 'x', canvas.height);
  
  // 7. DATOS CON LONGITUD CORRECTA
  const data = burndownData || {
    semanas: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4', 'Sem 5', 'Sem 6', 'Sem 7'],
    trabajoIdeal: [100, 83, 66, 50, 33, 16, 0],
    trabajoReal: [100, 90, 85, 70, 60, 40, 20]
  };
  
  console.log('üìä Datos a renderizar:', data);
  
  // 8. CREAR GR√ÅFICO CON CONFIGURACI√ìN SIMPLIFICADA
  try {
    window.burndownChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.semanas,
        datasets: [
          {
            label: 'L√çNEA IDEAL',
            data: data.trabajoIdeal,
            borderColor: '#10b981',
            backgroundColor: 'transparent',
            borderWidth: 3,
            borderDash: [10, 5],
            fill: false,
            tension: 0
          },
          {
            label: 'PROGRESO REAL',
            data: data.trabajoReal,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.5)',
            borderWidth: 4,
            fill: true,
            tension: 0.3
          }
        ]
      },
      options: {
        responsive: false, // IMPORTANTE: desactivar responsive
        maintainAspectRatio: false,
        animation: {
          duration: 1000,
          onComplete: function() {
            console.log('‚úÖ Animaci√≥n del gr√°fico completada');
            
            // VERIFICAR QUE SE DIBUJ√ì ALGO
            const imageData = ctx.getImageData(10, 10, 1, 1);
            console.log('üé® Primer pixel dibujado:', 
              imageData.data[0], imageData.data[1], imageData.data[2], imageData.data[3]);
            
            if (imageData.data[3] === 0) {
              console.warn('‚ö†Ô∏è Canvas parece vac√≠o. Forzando redibujo...');
              window.burndownChartInstance.update('none'); // Redibujar sin animaci√≥n
            }
          }
        },
        plugins: {
          legend: {
            position: 'top',
            labels: {
              color: '#f1f5f9',
              font: {
                size: 14,
                weight: 'bold'
              }
            }
          }
        },
        scales: {
          x: {
            grid: {
              color: 'rgba(255, 255, 255, 0.1)'
            },
            ticks: {
              color: '#cbd5e1'
            }
          },
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(255, 255, 255, 0.1)'
            },
            ticks: {
              color: '#cbd5e1',
              callback: function(value) {
                return value + ' pts';
              }
            }
          }
        }
      }
    });
    
    console.log('‚úÖ Gr√°fico creado con √©xito');
    console.log('üìä Tipo de gr√°fico:', window.burndownChartInstance.config.type);
    
    // 9. VERIFICACI√ìN FINAL
    setTimeout(() => {
      console.log('üîç VERIFICACI√ìN FINAL:');
      
      // Verificar que el canvas est√° en el DOM
      console.log('‚úÖ Canvas en DOM:', document.contains(canvas));
      
      // Verificar dimensiones
      console.log('‚úÖ Dimensiones canvas:', canvas.offsetWidth, 'x', canvas.offsetHeight);
      
      // Verificar que Chart.js registr√≥ el gr√°fico
      console.log('‚úÖ Gr√°ficos registrados:', Chart.instances.length);
      
      // Hacer screenshot de prueba
      const testCtx = canvas.getContext('2d');
      const pixelData = testCtx.getImageData(100, 100, 1, 1).data;
      console.log('üé® Color en posici√≥n (100,100):', pixelData);
      
      // Si sigue vac√≠o, dibujar algo manualmente
      if (pixelData[3] === 0) {
        console.warn('‚ö†Ô∏è Canvas sigue vac√≠o. Dibujando manualmente...');
        
        // Dibujar un rect√°ngulo de prueba
        testCtx.fillStyle = 'rgba(255, 0, 0, 0.5)';
        testCtx.fillRect(50, 50, 100, 50);
        testCtx.fillStyle = 'white';
        testCtx.font = '16px Arial';
        testCtx.fillText('TEST', 60, 80);
        
        console.log('üñçÔ∏è Test manual dibujado');
      }
      
    }, 1500);
    
  } catch (error) {
    console.error('‚ùå ERROR CR√çTICO:', error);
    
    // Mostrar error en el contenedor
    container.innerHTML = `
      <div style="
        color: white;
        padding: 30px;
        background: #dc2626;
        border-radius: 8px;
      ">
        <h3>‚ùå ERROR: ${error.name}</h3>
        <p>${error.message}</p>
      </div>
    `;
  }
}



// ================================================
// BURNDOWN CHART - SISTEMA DEFINITIVO
// ================================================

// 1. Funci√≥n principal optimizada
function mostrarBurndownChart(datos) {
  console.log('üìä Sistema Burndown Chart iniciado...');
  
  
  
  // Eliminar contenedores antiguos
  const oldContainers = document.querySelectorAll('#burndownChartContainer, #graficoBurndown');
  oldContainers.forEach(container => container.remove());
  
  // Crear contenedor
  const container = document.createElement('div');
  container.id = 'graficoBurndown';
  container.style.cssText = `
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    width: 85vw !important;
    max-width: 1000px !important;
    height: 75vh !important;
    max-height: 700px !important;
    background: #1e293b !important;
    border: 3px solid #3b82f6 !important;
    border-radius: 12px !important;
    padding: 20px !important;
    z-index: 99999 !important;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.75) !important;
    display: flex !important;
    flex-direction: column !important;
    box-sizing: border-box !important;
  `;
  
  // Header con t√≠tulo y bot√≥n de cerrar
  container.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h3 style="color: #fbbf24; margin: 0; font-size: 1.5rem;">
        üìà Burndown Chart del Sprint
      </h3>
      <button id="cerrarBurndown" style="
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        cursor: pointer;
        font-weight: bold;
      ">
        ‚úï Cerrar
      </button>
    </div>
    <div style="flex: 1; position: relative;">
      <canvas id="burndownChartCanvas"></canvas>
    </div>
  `;
  
  document.body.appendChild(container);
  
  // Bot√≥n de cerrar
  document.getElementById('cerrarBurndown').onclick = function() {
    container.remove();
    window.closeBurndownModal();

  };
  
  // Obtener canvas y contexto
  const canvas = document.getElementById('burndownChartCanvas');
  const ctx = canvas.getContext('2d');
  
  // Ajustar dimensiones
  const updateCanvasSize = () => {
    const containerRect = container.getBoundingClientRect();
    const contentHeight = containerRect.height - 80; // Restar header y padding
    const contentWidth = containerRect.width - 40; // Restar padding
    
    canvas.width = contentWidth;
    canvas.height = contentHeight;
    
    canvas.style.width = contentWidth + 'px';
    canvas.style.height = contentHeight + 'px';
    canvas.style.display = 'block';
  };
  
  updateCanvasSize();
  
  // Redimensionar con la ventana
  window.addEventListener('resize', updateCanvasSize);
  
  // Usar datos proporcionados o de ejemplo
  const datosFinales = datos || {
    semanas: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4', 'Sem 5', 'Sem 6'],
    trabajoIdeal: [100, 83, 66, 50, 33, 16, 0],
    trabajoReal: [100, 90, 85, 70, 60, 40, 20]
  };
  
  // Crear gr√°fico
  try {
    window.burndownChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: datosFinales.semanas,
        datasets: [
          {
            label: 'üìâ L√≠nea Ideal',
            data: datosFinales.trabajoIdeal,
            borderColor: '#10b981',
            backgroundColor: 'transparent',
            borderWidth: 3,
            borderDash: [5, 5],
            tension: 0
          },
          {
            label: 'üìä Progreso Real',
            data: datosFinales.trabajoReal,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.2
          }
        ]
      },
      options: {
        responsive: false,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            labels: {
              color: '#e2e8f0',
              font: { size: 14 }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(30, 41, 59, 0.95)',
            titleColor: '#60a5fa',
            bodyColor: '#f1f5f9'
          }
        },
        scales: {
          x: {
            grid: { color: 'rgba(255, 255, 255, 0.1)' },
            ticks: { color: '#cbd5e1' }
          },
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(255, 255, 255, 0.1)' },
            ticks: { 
              color: '#cbd5e1',
              callback: function(value) {
                return value + ' pts';
              }
            }
          }
        }
      }
    });
    
    console.log('‚úÖ Gr√°fico burndown creado exitosamente');
    
  } catch (error) {
    console.error('‚ùå Error creando gr√°fico:', error);
    container.innerHTML = `
      <div style="color: white; padding: 20px; text-align: center;">
        <h3>Error al crear gr√°fico</h3>
        <p>${error.message}</p>
      </div>
    `;
  }
}

// 2. Funci√≥n para obtener datos desde TU sistema
function obtenerDatosBurndownDelSistema() {
  console.log('üîç Buscando datos en tu sistema...');
  
  // INTENTA OBTENER DATOS DE TU SISTEMA:
  
  // 1. Desde variables globales de tu sistema
  if (window.sistema && window.sistema.datosBurndown) {
    console.log('‚úÖ Datos encontrados en window.sistema');
    return window.sistema.datosBurndown;
  }
  
  // 2. Desde localStorage (si guardas datos ah√≠)
  const datosGuardados = localStorage.getItem('burndownData');
  if (datosGuardados) {
    try {
      console.log('‚úÖ Datos encontrados en localStorage');
      return JSON.parse(datosGuardados);
    } catch(e) {
      console.log('‚ö†Ô∏è Error parseando datos de localStorage');
    }
  }
  
  // 3. Desde elementos HTML con datos
  const elementosConDatos = document.querySelectorAll('[data-burndown]');
  if (elementosConDatos.length > 0) {
    const datosElemento = elementosConDatos[0].dataset.burndown;
    try {
      console.log('‚úÖ Datos encontrados en data-burndown');
      return JSON.parse(datosElemento);
    } catch(e) {
      console.log('‚ö†Ô∏è Error parseando datos de data-burndown');
    }
  }
  
  // 4. Calcular datos basados en elementos de tu UI
  const tareas = document.querySelectorAll('.tarea, .task, .item-trabajo');
  const puntosCompletados = document.querySelectorAll('.completado, .done, .finished');
  
  if (tareas.length > 0) {
    console.log('‚úÖ Calculando datos desde elementos UI');
    const totalTareas = tareas.length;
    const completadas = puntosCompletados.length;
    const restantes = totalTareas - completadas;
    
    return {
      semanas: ['Inicio', '25%', '50%', '75%', '100%'],
      trabajoIdeal: [totalTareas, totalTareas * 0.75, totalTareas * 0.5, totalTareas * 0.25, 0],
      trabajoReal: [totalTareas, restantes + completadas * 0.25, restantes, completadas, 0]
    };
  }
  
  // 5. Datos de ejemplo como √∫ltimo recurso
  console.log('‚ö†Ô∏è Usando datos de ejemplo');
  return {
    semanas: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'],
    trabajoIdeal: [100, 75, 50, 25, 0],
    trabajoReal: [100, 85, 60, 35, 10]
  };
}



// 4. Auto-detecci√≥n de elementos de tu sistema
function integrarConSistemaExistente() {
  console.log('üîå Integrando con tu sistema...');
  
  // A. Buscar botones existentes y agregar funcionalidad
  // Reemplazar la b√∫squeda con selectores v√°lidos
  const botonesBurndown = document.querySelectorAll(`
    [id*="burndown"],
    [class*="burndown"],
    button[id*="chart"],
    button[id*="report"]
  `);
  
  // Tambi√©n buscar por texto usando una funci√≥n auxiliar
  const allButtons = document.querySelectorAll('button');
  const buttonsByText = Array.from(allButtons).filter(button => {
    const text = button.textContent.toLowerCase();
    return text.includes('burndown') || 
           text.includes('gr√°fico') || 
           text.includes('reporte') ||
           text.includes('chart');
  });
  
  // Combinar resultados
  const todosBotones = [...botonesBurndown, ...buttonsByText];
  
  todosBotones.forEach(boton => {
    if (!boton.dataset.burndownIntegrated) {
      boton.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        window.mostrarReporteBurndown();
      });
      boton.dataset.burndownIntegrated = 'true';
      console.log('‚úÖ Bot√≥n integrado:', boton.textContent);
    }
  });  
  // B. Buscar enlaces/men√∫s
  const enlacesBurndown = document.querySelectorAll(`
    a[href*="burndown"],
    a[href*="report"],
    a[href*="grafico"]
  `);
  
  enlacesBurndown.forEach(enlace => {
    enlace.addEventListener('click', function(e) {
      e.preventDefault();
      window.mostrarReporteBurndown();
    });
  });
  
  // C. Verificar si hay un sprint activo
  const sprintActual = document.querySelector('.sprint-activo, .current-sprint, .active-sprint');
  if (sprintActual) {
    console.log('‚úÖ Sprint activo detectado');
    // Podr√≠as mostrar el gr√°fico autom√°ticamente
    // window.mostrarReporteBurndown();
  }
}




// Crear contenedor si no existe
function asegurarContenedorGrafico() {
  let container = document.getElementById('burndownChartContainer');
  
  if (!container) {
    container = document.createElement('div');
    container.id = 'burndownChartContainer';
    container.style.cssText = `
      width: 100%;
      max-width: 1000px;
      margin: 20px auto;
      padding: 20px;
      background: #2c3e50;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    `;
    
    container.innerHTML = `
      <h3 style="color: #ecf0f1; margin-bottom: 15px; text-align: center;">
        üìä Gr√°fico Burndown del Sprint
      </h3>
      <div style="position: relative; height: 400px;">
        <canvas id="burndownChartCanvas"></canvas>
      </div>
    `;
    
    // Insertar donde quieras (ajusta el selector)
    const mainContent = document.querySelector('main, .container, #contenido') || document.body;
    mainContent.appendChild(container);
    
    console.log('‚úÖ Contenedor de gr√°fico creado');
  }
  
  return container;
}



// Funci√≥n para obtener datos REALES de tu sistema
function obtenerDatosBurndown() {
    console.log("üîç Obteniendo datos REALES del sistema...");
    
    try {
        // 1. Obtener tareas REALES
        let tareas = [];
        const projectTasks = JSON.parse(localStorage.getItem('projectTasks'));
        if (projectTasks && projectTasks.length > 0) {
            tareas = projectTasks;
        } else {
            // Si no hay en projectTasks, buscar en proyectos
            const projects = JSON.parse(localStorage.getItem('projects')) || [];
            const currentProjectId = localStorage.getItem('currentProjectId');
            if (currentProjectId && projects.length > 0) {
                const currentProject = projects.find(p => p.id == currentProjectId);
                if (currentProject && currentProject.tasks) {
                    tareas = currentProject.tasks;
                }
            }
        }
        
        const totalTareas = tareas.length;
        const tareasCompletadas = tareas.filter(t => 
            t.status === 'completed' || t.completed === true || t.progress === 100
        ).length;
        
        console.log(`‚úÖ Datos REALES obtenidos: ${tareasCompletadas}/${totalTareas} completadas`);
        
        // 2. Generar datos REALES del burndown (no de ejemplo)
        if (totalTareas === 0) {
            console.log("‚ö†Ô∏è No hay tareas, usando datos b√°sicos");
            return generarDatosBasicos();
        }
        
        return generarDatosRealesBurndown(totalTareas, tareasCompletadas);
        
    } catch (error) {
        console.error("Error obteniendo datos reales:", error);
        return generarDatosBasicos();
    }
}

function generarDatosRealesBurndown(total, completadas) {
    // Tu l√≥gica actual de generaci√≥n de burndown, pero con n√∫meros REALES
    const semanas = ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4', 'Sem 5', 'Sem 6'];
    const trabajoReal = [];
    
    for (let i = 0; i < 6; i++) {
        if (i === 0) {
            trabajoReal.push(total);
        } else if (i < 5) {
            const progreso = (completadas / 5) * i;
            trabajoReal.push(Math.max(0, total - progreso));
        } else {
            trabajoReal.push(Math.max(0, total - completadas));
        }
    }
    
    return {
        semanas: semanas,
        trabajoIdeal: Array(6).fill(0).map((_, i) => Math.max(0, total - (i * (total / 5)))),
        trabajoReal: trabajoReal,
        scopeCreep: trabajoReal.map(val => val + (Math.random() * 0.5 - 0.25)),
        metricasReales: {
            totalTareas: total,
            tareasCompletadas: completadas,
            porcentajeCompletado: total > 0 ? ((completadas / total) * 100).toFixed(1) : 0
        }
    };
}

function generarDatosBasicos() {
    return {
        semanas: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4', 'Sem 5', 'Sem 6'],
        trabajoIdeal: [0, 0, 0, 0, 0, 0],
        trabajoReal: [0, 0, 0, 0, 0, 0],
        scopeCreep: [0, 0, 0, 0, 0, 0],
        metricasReales: {
            totalTareas: 0,
            tareasCompletadas: 0,
            porcentajeCompletado: 0
        }
    };
}




// 10. Estilos premium
function addPremiumStyles() {
  const styles = document.createElement('style');
  styles.textContent = `
    .premium-task:hover {
      transform: translateY(-3px) !important;
      box-shadow: 0 15px 30px rgba(0,0,0,0.4) !important;
    }
    
    .premium-btn:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3) !important;
    }
  `;
  document.head.appendChild(styles);
}

// 11. Crear proyectos de ejemplo (VERSI√ìN SIMPLIFICADA)
function createSampleProjects() {
  if (typeof projects === 'undefined') {
    window.projects = [];
    window.currentProjectIndex = 0;
  }
  
  if (projects.length === 0) {
    projects.push({
      name: "Proyecto Demo",
      tasks: [
        {
          id: 1,
          name: "Tarea de ejemplo 1",
          startDate: new Date().toISOString().split('T')[0],
          deadline: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          status: "inProgress",
          priority: "media",
          estimatedTime: 8,
          timeLogged: 4,
          assignee: "Usuario 1",
          dependencies: []
        },
        {
          id: 2,
          name: "Tarea de ejemplo 2",
          startDate: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          status: "pending",
          priority: "alta",
          estimatedTime: 16,
          timeLogged: 0,
          assignee: "Usuario 2",
          dependencies: []
        }
      ]
    });
    currentProjectIndex = 0;
  }
  
  setTimeout(() => {
    createPremiumGanttWithYourData();
  }, 100);
}

// ========== FUNCI√ìN PRINCIPAL DE GANTT ==========
// [Aqu√≠ va el c√≥digo completo que te envi√© anteriormente]
// Busca la funci√≥n createPremiumGanttWithYourData() y p√©gala aqu√≠










// ========== GANTT EJECUTIVO COMPLETO CON TODAS LAS MEJORAS ==========
async function createPremiumGanttWithYourData() {
   // ‚úÖ USUARIO AUTORIZADO
  console.log('üöÄ Creando Gantt ejecutivo premium completo...');
  
  if (typeof projects === 'undefined' || !projects || projects.length === 0) {
    alert('‚ùå No hay proyectos cargados. Primero crea o importa proyectos.');
    createSampleProjects();
    return;
  }
  
  createProjectSelector();
}
// ========== SELECTOR DE PROYECTOS ==========
function createProjectSelector() {
  const selectorContainer = document.createElement('div');
  selectorContainer.id = 'projectSelectorOverlay';
  selectorContainer.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 500px;
    background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
    border-radius: 24px;
    padding: 30px;
    z-index: 1000000;
    box-shadow: 0 30px 60px rgba(0,0,0,0.6);
    border: 1px solid rgba(52, 152, 219, 0.4);
    color: white;
  `;
  
  selectorContainer.innerHTML = `
    <div style="text-align: center; margin-bottom: 25px;">
      <div style="font-size: 28px; color: #2ecc71; margin-bottom: 10px;">üìä</div>
      <h2 style="margin: 0 0 10px 0; color: white;">Seleccionar Proyecto</h2>
      <p style="color: #95a5a6; margin: 0;">Elige un proyecto para visualizar en el Gantt</p>
    </div>
    
    <div id="projectListContainer" style="
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 25px;
    ">
      ${projects.map((project, index) => `
        <div class="project-option" data-index="${index}" style="
          background: ${index === currentProjectIndex ? 'rgba(52, 152, 219, 0.2)' : 'rgba(255,255,255,0.05)'};
          border: 1px solid ${index === currentProjectIndex ? '#3498db' : 'rgba(255,255,255,0.1)'};
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 10px;
          cursor: pointer;
          transition: all 0.3s;
        ">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: bold; margin-bottom: 5px; font-size: 16px;">${project.name}</div>
              <div style="color: #95a5a6; font-size: 13px;">
                ${project.tasks ? project.tasks.length : 0} tareas ‚Ä¢ 
                ${getProjectProgress(project)}% completado
              </div>
            </div>
            <div style="
              width: 24px;
              height: 24px;
              border-radius: 50%;
              background: ${index === currentProjectIndex ? '#3498db' : 'rgba(255,255,255,0.1)'};
              display: flex;
              align-items: center;
              justify-content: center;
              color: ${index === currentProjectIndex ? 'white' : 'transparent'};
            ">
              ‚úì
            </div>
          </div>
        </div>
      `).join('')}
    </div>
    
    <div style="display: flex; gap: 15px; justify-content: center;">
      <button onclick="closeProjectSelector()" style="
        padding: 12px 25px;
        background: rgba(231, 76, 60, 0.2);
        border: 1px solid #e74c3c;
        color: #e74c3c;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
      ">
        Cancelar
      </button>
      <button onclick="createGanttWithSelectedProject()" id="continueBtn" style="
        padding: 12px 25px;
        background: linear-gradient(45deg, #2ecc71, #27ae60);
        border: none;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        flex: 1;
      ">
        Continuar al Gantt
      </button>
    </div>
  `;
  
  document.body.appendChild(selectorContainer);
  
  document.querySelectorAll('.project-option').forEach(option => {
    option.addEventListener('click', function() {
      currentProjectIndex = parseInt(this.getAttribute('data-index'));
      updateProjectSelector();
    });
  });
}

function closeProjectSelector() {
  const selector = document.getElementById('projectSelectorOverlay');
  if (selector) selector.remove();
}

async function createGanttWithSelectedProject() {
    // ‚úÖ USUARIO AUTORIZADO
  closeProjectSelector();
  createCompleteGanttForCurrentProject();
}
// ========== FUNCIONES AUXILIARES NECESARIAS ==========

// ================================================
// üéØ CALCULO PRINCIPAL - VERSI√ìN LIMPIA
// ================================================
function getProjectProgress(project) {
  if (!project || !project.tasks || project.tasks.length === 0) return 0;

  const evm = calculateEVMRealFromTasks(project.tasks);
  if (!evm || evm.BAC <= 0) return 0;

  return Math.round((evm.EV / evm.BAC) * 100);
}
function updateProjectSelector() {
  document.querySelectorAll('.project-option').forEach((option, index) => {
    const isSelected = index === currentProjectIndex;
    option.style.background = isSelected ? 'rgba(52, 152, 219, 0.2)' : 'rgba(255,255,255,0.05)';
    option.style.border = `1px solid ${isSelected ? '#3498db' : 'rgba(255,255,255,0.1)'}`;
    const checkmark = option.querySelector('div > div:last-child');
    checkmark.style.background = isSelected ? '#3498db' : 'rgba(255,255,255,0.1)';
    checkmark.style.color = isSelected ? 'white' : 'transparent';
  });
}

function generateDependenciesList(tasks) {
  const dependenciesList = [];
  
  tasks.forEach(task => {
    if (task.dependencies && task.dependencies.length > 0) {
      task.dependencies.forEach(depId => {
        const depTask = tasks.find(t => t.id.toString() === depId.toString());
        if (depTask) {
          dependenciesList.push({
            from: depTask.name,
            to: task.name,
            fromId: depTask.id,
            toId: task.id
          });
        }
      });
    }
  });
  
  if (dependenciesList.length === 0) {
    return '<div style="color: #95a5a6; font-size: 12px; font-style: italic;">No hay dependencias definidas</div>';
  }
  
  const displayList = dependenciesList.slice(0, 3);
  
  return `
    <div style="max-height: 120px; overflow-y: auto; margin-top: 10px;">
      ${displayList.map(dep => `
        <div style="
          background: rgba(255,255,255,0.05);
          border-radius: 6px;
          padding: 8px 10px;
          margin-bottom: 6px;
          border-left: 3px solid #9b59b6;
        ">
          <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
            <span style="color: #9b59b6; font-size: 10px;">‚¨Ö</span>
            <span style="color: white; font-size: 11px; font-weight: bold;">${dep.from}</span>
          </div>
          <div style="display: flex; align-items: center; gap: 6px;">
            <span style="color: #3498db; font-size: 10px;">‚û°</span>
            <span style="color: #95a5a6; font-size: 11px;">${dep.to}</span>
          </div>
        </div>
      `).join('')}
      ${dependenciesList.length > 3 ? 
        `<div style="color: #95a5a6; font-size: 11px; text-align: center; margin-top: 5px;">
          y ${dependenciesList.length - 3} dependencias m√°s...
        </div>` : ''
      }
    </div>
    <button onclick="showAllDependencies()" style="
      width: 100%;
      background: rgba(155, 89, 182, 0.2);
      border: 1px solid #9b59b6;
      color: #9b59b6;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    ">
      üîç Ver todas las dependencias
    </button>
  `;
}

function getCriticalTasksDetails(tasks) {
  const critical = tasks.filter(t => t.critical);
  if (critical.length === 0) return 'No hay tareas cr√≠ticas';
  
  const names = critical.slice(0, 3).map(t => t.name);
  let result = names.join(', ');
  if (critical.length > 3) result += ` y ${critical.length - 3} m√°s`;
  return result;
}

function calculatePredictedEndDatePremium(tasks) {
  if (tasks.length === 0) return 'No hay datos';
  
  const today = new Date();
  const maxEndDay = Math.max(...tasks.map(t => t.startDay + t.duration));
  const predictedDate = new Date(today);
  predictedDate.setDate(predictedDate.getDate() + maxEndDay);
  
  return predictedDate.toLocaleDateString('es-ES', {
    day: '2-digit',
    month: 'short',
    year: 'numeric'
  });
}

function countTeamMembers(tasks) {
  const members = new Set();
  tasks.forEach(task => {
    if (task.team && task.team.length > 0) {
      task.team.forEach(member => members.add(member));
    }
  });
  return members.size;
}

function generateTeamDistribution(tasks) {
   
  const memberTasks = {};
  let totalAssignments = 0;
  
  // DEBUG: Mostrar qu√© estamos procesando
  console.log('=== PROCESANDO TAREAS ===');
  
  // Contar tareas por miembro - compatible con ambos formatos
  tasks.forEach((task, index) => {
    console.log(`Tarea ${index}: "${task.name}"`);
    console.log('  - assignee:', task.assignee);
    console.log('  - team:', task.team);
    
    // FORMATO 1: task.team como array
    if (task.team && Array.isArray(task.team)) {
      console.log('  ‚Üí Procesando como FORMATO 1 (team array)');
      task.team.forEach(member => {
        if (member && typeof member === 'string' && member.trim() && member !== 'Sin asignar') {
          const memberName = member.trim();
          memberTasks[memberName] = (memberTasks[memberName] || 0) + 1;
          totalAssignments++;
          console.log(`    ‚úì Agregado: ${memberName} (total: ${memberTasks[memberName]})`);
        }
      });
    } 
    // FORMATO 2: task.assignee (legacy) - ¬°ESTE ES EL QUE USA!
    else if (task.assignee && typeof task.assignee === 'string' && task.assignee.trim() && task.assignee !== 'Sin asignar') {
      console.log('  ‚Üí Procesando como FORMATO 2 (assignee)');
      const memberName = task.assignee.trim();
      memberTasks[memberName] = (memberTasks[memberName] || 0) + 1;
      totalAssignments++;
      console.log(`    ‚úì Agregado: ${memberName} (total: ${memberTasks[memberName]})`);
    }
    // FORMATO 3: task.responsible o similares
    else if (task.responsible) {
      console.log('  ‚Üí Procesando como FORMATO 3 (responsible)');
      const memberName = String(task.responsible).trim();
      if (memberName && memberName !== 'Sin asignar') {
        memberTasks[memberName] = (memberTasks[memberName] || 0) + 1;
        totalAssignments++;
        console.log(`    ‚úì Agregado: ${memberName} (total: ${memberTasks[memberName]})`);
      }
    } else {
      console.log('  ‚Üí No se encontr√≥ informaci√≥n de asignaci√≥n');
    }
  });
  
  const totalMembers = Object.keys(memberTasks).length;
  
  console.log('=== RESULTADOS ===');
  console.log('Miembros encontrados:', totalMembers);
  console.log('Detalle:', memberTasks);
  console.log('Asignaciones totales:', totalAssignments);
  
  if (totalMembers === 0) {
    console.log('‚ùå No hay miembros asignados');
    return `
      <div style="
        color: #95a5a6; 
        font-size: 12px; 
        padding: 15px; 
        text-align: center;
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
        border: 1px dashed rgba(255,255,255,0.1);
      ">
        <div style="margin-bottom: 8px; font-size: 20px;">üë§</div>
        <div style="font-weight: 500; margin-bottom: 5px;">Sin asignaciones</div>
        <div style="font-size: 10px; color: #7f8c8d;">
          Asigna miembros en las tareas
        </div>
      </div>
    `;
  }
  
  // Ordenar por cantidad de tareas (descendente)
  const sortedMembers = Object.entries(memberTasks)
    .sort((a, b) => b[1] - a[1]);
  
  console.log('Miembros ordenados:', sortedMembers);
  
  // Mostrar m√°ximo 5 miembros con scroll si hay m√°s
  const displayLimit = 5;
  const membersToShow = sortedMembers.slice(0, displayLimit);
  const hasMore = totalMembers > displayLimit;
  const maxTasks = Math.max(...Object.values(memberTasks));
  
  let html = `
    <div style="
      max-height: ${hasMore ? '200px' : 'auto'};
      overflow-y: ${hasMore ? 'auto' : 'visible'};
      padding-right: ${hasMore ? '8px' : '0'};
      margin-bottom: 12px;
    ">
  `;
  
  membersToShow.forEach(([member, count], index) => {
    const percentage = maxTasks > 0 ? (count / maxTasks * 100) : 0;
    const colors = ['#3498db', '#2ecc71', '#9b59b6', '#f39c12', '#1abc9c'];
    const color = colors[index % colors.length];
    
    html += `
      <div style="
        margin-bottom: 12px;
        padding: 10px;
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
        border-left: 4px solid ${color};
        transition: all 0.3s ease;
      " onmouseover="this.style.transform='translateX(3px)'; this.style.background='rgba(255,255,255,0.08)'"
         onmouseout="this.style.transform='translateX(0)'; this.style.background='rgba(255,255,255,0.05)'">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <div style="
              width: 28px;
              height: 28px;
              background: ${color};
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-size: 12px;
              font-weight: bold;
              box-shadow: 0 3px 10px ${color}40;
            ">
              ${index + 1}
            </div>
            <div>
              <div style="color: white; font-size: 14px; font-weight: 500;">${member}</div>
              <div style="color: #95a5a6; font-size: 11px;">${count} tarea${count !== 1 ? 's' : ''} asignada${count !== 1 ? 's' : ''}</div>
            </div>
          </div>
          <div style="color: ${color}; font-size: 16px; font-weight: bold;">${count}</div>
        </div>
        <div style="
          height: 6px;
          background: rgba(255,255,255,0.1);
          border-radius: 3px;
          overflow: hidden;
          position: relative;
        ">
          <div style="
            width: ${percentage}%;
            height: 100%;
            background: linear-gradient(90deg, ${color}, ${color}dd);
            border-radius: 3px;
            transition: width 0.5s ease;
          "></div>
          <div style="
            position: absolute;
            right: 0;
            top: 0;
            color: ${color};
            font-size: 9px;
            padding: 0 4px;
          ">${percentage.toFixed(0)}%</div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  // Si hay m√°s miembros de los que se muestran, agregar indicador
  if (hasMore) {
    const remaining = totalMembers - displayLimit;
    html += `
      <div style="
        margin-bottom: 12px;
        padding: 10px;
        background: rgba(155, 89, 182, 0.1);
        border-radius: 8px;
        border: 1px dashed rgba(155, 89, 182, 0.3);
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
      " onclick="showAllTeamMembers()" 
         onmouseover="this.style.background='rgba(155, 89, 182, 0.15)'; this.style.transform='translateY(-2px)'"
         onmouseout="this.style.background='rgba(155, 89, 182, 0.1)'; this.style.transform='translateY(0)'"
         title="Ver todos los miembros">
        <div style="color: #9b59b6; font-size: 13px; font-weight: 500; margin-bottom: 5px;">
          üë• +${remaining} miembro${remaining !== 1 ? 's' : ''} m√°s
        </div>
        <div style="color: #9b59b6; font-size: 11px;">
          Ver todos los ${totalMembers} miembros
        </div>
      </div>
    `;
  }
  
  // Agregar resumen con estad√≠sticas
  html += `
    <div style="
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      text-align: center;
      border-top: 2px solid rgba(46, 204, 113, 0.3);
    ">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 10px;">
        <div style="
          padding: 8px;
          background: rgba(46, 204, 113, 0.1);
          border-radius: 6px;
          border: 1px solid rgba(46, 204, 113, 0.2);
        ">
          <div style="color: #2ecc71; font-size: 18px; font-weight: bold;">${totalMembers}</div>
          <div style="color: #95a5a6; font-size: 11px;">Miembros</div>
        </div>
        <div style="
          padding: 8px;
          background: rgba(52, 152, 219, 0.1);
          border-radius: 6px;
          border: 1px solid rgba(52, 152, 219, 0.2);
        ">
          <div style="color: #3498db; font-size: 18px; font-weight: bold;">${totalAssignments}</div>
          <div style="color: #95a5a6; font-size: 11px;">Asignaciones</div>
        </div>
      </div>
      
      <div style="
        margin-bottom: 10px;
        padding: 8px;
        background: rgba(243, 156, 18, 0.1);
        border-radius: 6px;
        border: 1px solid rgba(243, 156, 18, 0.2);
      ">
        <div style="color: #f39c12; font-size: 14px; font-weight: 500;">
          üéØ ${(totalAssignments / totalMembers).toFixed(1)} tareas por miembro
        </div>
      </div>
      
      <button onclick="showAllTeamMembers()" style="
        background: linear-gradient(45deg, #3498db, #2980b9);
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
      " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(52, 152, 219, 0.3)'"
         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
        üìä Ver estad√≠sticas completas
      </button>
    </div>
  `;
  

  return html;
}





window.showAllTeamMembers = function() {
  console.log('üë• Mostrando todos los miembros del equipo...');
  
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;
  
  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  const currentProject = projects[projectIndex];
  const tasks = currentProject.tasks || [];
  
  console.log('üîç Analizando tareas para miembros del equipo...');
  console.log('üìä Total de tareas:', tasks.length);
  
  // Contar tareas por miembro - compatible con ambos formatos
  const memberTasks = {};
  let totalAssignments = 0;
  
  tasks.forEach((task, index) => {
    console.log(`Tarea ${index}: "${task.name}"`);
    console.log('  - assignee:', task.assignee);
    console.log('  - team:', task.team);
    
    // FORMATO 1: task.team como array
    if (task.team && Array.isArray(task.team)) {
      console.log('  ‚Üí Procesando como FORMATO 1 (team array)');
      task.team.forEach(member => {
        if (member && typeof member === 'string' && member.trim() && member !== 'Sin asignar') {
          const memberName = member.trim();
          memberTasks[memberName] = (memberTasks[memberName] || 0) + 1;
          totalAssignments++;
          console.log(`    ‚úì Agregado: ${memberName} (total: ${memberTasks[memberName]})`);
        }
      });
    } 
    // FORMATO 2: task.assignee (legacy) - ¬°ESTE ES EL QUE USA TU SISTEMA!
    else if (task.assignee && typeof task.assignee === 'string' && task.assignee.trim() && task.assignee !== 'Sin asignar') {
      console.log('  ‚Üí Procesando como FORMATO 2 (assignee)');
      const memberName = task.assignee.trim();
      memberTasks[memberName] = (memberTasks[memberName] || 0) + 1;
      totalAssignments++;
      console.log(`    ‚úì Agregado: ${memberName} (total: ${memberTasks[memberName]})`);
    }
    // FORMATO 3: task.responsible o similares
    else if (task.responsible) {
      console.log('  ‚Üí Procesando como FORMATO 3 (responsible)');
      const memberName = String(task.responsible).trim();
      if (memberName && memberName !== 'Sin asignar') {
        memberTasks[memberName] = (memberTasks[memberName] || 0) + 1;
        totalAssignments++;
        console.log(`    ‚úì Agregado: ${memberName} (total: ${memberTasks[memberName]})`);
      }
    } else {
      console.log('  ‚Üí No se encontr√≥ informaci√≥n de asignaci√≥n');
    }
  });
  
  const totalMembers = Object.keys(memberTasks).length;
  
  console.log('=== RESULTADOS ===');
  console.log('Miembros encontrados:', totalMembers);
  console.log('Detalle:', memberTasks);
  console.log('Asignaciones totales:', totalAssignments);
  
  // Crear overlay con ID espec√≠fico
  const overlay = document.createElement('div');
  overlay.id = 'teamMembersOverlay';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(5px);
    z-index: 1000000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  `;
  
  // Funci√≥n para cerrar
  const closeModal = () => {
    overlay.remove();
  };
  
  overlay.onclick = (e) => {
    if (e.target === overlay) closeModal();
  };
  
  const modal = document.createElement('div');
  modal.id = 'teamMembersModal';
  modal.style.cssText = `
    background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
    border-radius: 16px;
    padding: 25px;
    width: 500px;
    max-width: 90vw;
    max-height: 80vh;
    overflow-y: auto;
    border: 2px solid rgba(52, 152, 219, 0.3);
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
  `;
  
  if (totalMembers === 0) {
    modal.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
          <h3 style="color: white; margin: 0 0 10px 0; display: flex; align-items: center; gap: 10px;">
            <span style="color: #e74c3c;">üë§</span> Distribuci√≥n del Equipo
          </h3>
          <p style="color: #95a5a6; margin: 0; font-size: 14px;">
            ${currentProject.name}
          </p>
        </div>
        <button onclick="closeTeamModal()" style="
          background: rgba(231, 76, 60, 0.2);
          border: 1px solid #e74c3c;
          color: #e74c3c;
          padding: 8px 16px;
          border-radius: 6px;
          cursor: pointer;
          font-weight: bold;
          font-size: 14px;
        ">
          ‚úï Cerrar
        </button>
      </div>
      
      <div style="text-align: center; padding: 40px 20px; color: #95a5a6;">
        <div style="font-size: 48px; margin-bottom: 20px;">üë•</div>
        <h4 style="color: #f39c12; margin: 0 0 10px 0;">No hay miembros asignados</h4>
        <p>Las tareas no tienen asignaciones de equipo.</p>
        <p style="font-size: 12px; margin-top: 20px;">
          Usa el campo <strong>"assignee"</strong> en las tareas para asignar miembros
        </p>
      </div>
    `;
  } else {
    const sortedMembers = Object.entries(memberTasks).sort((a, b) => b[1] - a[1]);
    
    modal.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
          <h3 style="color: white; margin: 0 0 10px 0; display: flex; align-items: center; gap: 10px;">
            <span style="color: #2ecc71;">üë•</span> Distribuci√≥n Completa del Equipo
          </h3>
          <p style="color: #95a5a6; margin: 0; font-size: 14px;">
            ${currentProject.name} ‚Ä¢ ${totalMembers} miembros ‚Ä¢ ${totalAssignments} asignaciones
          </p>
        </div>
        <button onclick="closeTeamModal()" style="
          background: rgba(231, 76, 60, 0.2);
          border: 1px solid #e74c3c;
          color: #e74c3c;
          padding: 8px 16px;
          border-radius: 6px;
          cursor: pointer;
          font-weight: bold;
          font-size: 14px;
        ">
          ‚úï Cerrar
        </button>
      </div>
      
      <div style="margin-bottom: 25px;">
        ${sortedMembers.map(([member, count], index) => {
          const percentage = totalAssignments > 0 ? (count / totalAssignments * 100) : 0;
          return `
            <div style="
              display: flex;
              align-items: center;
              padding: 12px;
              background: rgba(255,255,255,0.05);
              border-radius: 8px;
              margin-bottom: 8px;
              border-left: 4px solid ${getMemberColor(index)};
            ">
              <div style="
                width: 32px;
                height: 32px;
                background: ${getMemberColor(index)};
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                margin-right: 12px;
                flex-shrink: 0;
              ">
                ${index + 1}
              </div>
              <div style="flex: 1;">
                <div style="color: white; font-weight: 500; margin-bottom: 4px;">${member}</div>
                <div style="display: flex; align-items: center; gap: 10px;">
                  <div style="flex: 1; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                    <div style="width: ${percentage}%; height: 100%; background: ${getMemberColor(index)}; border-radius: 3px;"></div>
                  </div>
                  <div style="color: #3498db; font-size: 13px; font-weight: bold; min-width: 70px;">
                    ${count} tarea${count !== 1 ? 's' : ''}
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('')}
      </div>
      
      <div style="
        padding: 15px;
        background: rgba(46, 204, 113, 0.1);
        border-radius: 8px;
        border: 1px solid rgba(46, 204, 113, 0.3);
        margin-bottom: 20px;
      ">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div style="text-align: center;">
            <div style="color: #2ecc71; font-size: 24px; font-weight: bold;">${totalMembers}</div>
            <div style="color: #95a5a6; font-size: 12px;">Miembros</div>
          </div>
          <div style="text-align: center;">
            <div style="color: #3498db; font-size: 24px; font-weight: bold;">${totalAssignments}</div>
            <div style="color: #95a5a6; font-size: 12px;">Asignaciones</div>
          </div>
        </div>
        <div style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
          <div style="color: #f39c12; font-size: 14px; font-weight: bold;">
            üìä Promedio: ${(totalAssignments / totalMembers).toFixed(1)} tareas por miembro
          </div>
        </div>
      </div>
    `;
  }
  
  // Funci√≥n para colores (mantener dentro del scope)
  function getMemberColor(index) {
    const colors = ['#3498db', '#2ecc71', '#9b59b6', '#f39c12', '#1abc9c', '#e74c3c', '#34495e'];
    return colors[index % colors.length];
  }
  
  // A√±adir funci√≥n global para cerrar
  window.closeTeamModal = closeModal;
  
  overlay.appendChild(modal);
  document.body.appendChild(overlay);








// ========== FUNCI√ìN PARA CERRAR EL MODAL DE MIEMBROS ==========
window.closeTeamMembersModal = function() {
  console.log('üîí Cerrando modal de miembros del equipo...');
  
  // Eliminar overlay
  const overlay = document.getElementById('teamOverlay');
  if (overlay) {
    overlay.remove();
    console.log('‚úÖ Overlay eliminado');
  }
  
  // Tambi√©n eliminar cualquier modal de equipo (por si acaso)
  const teamModals = document.querySelectorAll('div[style*="background: linear-gradient(135deg, #0a0a1a"]');
  teamModals.forEach(modal => {
    if (modal.innerHTML.includes('Distribuci√≥n Completa del Equipo')) {
      modal.remove();
      console.log('‚úÖ Modal eliminado');
    }
  });
  
  // Tambi√©n eliminar por clase si existe
  document.querySelectorAll('.team-members-overlay').forEach(el => el.remove());
};





  // Funci√≥n auxiliar para colores
  function getMemberColor(index) {
    const colors = ['#3498db', '#2ecc71', '#9b59b6', '#f39c12', '#1abc9c', '#e74c3c', '#34495e'];
    return colors[index % colors.length];
  }
};



function drawPremiumDependenciesComplete(tasks) {
  const layer = document.getElementById("dependencyLayer");
  if (!layer) return;

  layer.innerHTML = "";

  const layerRect = layer.getBoundingClientRect();

  tasks.forEach(task => {
    if (!task.dependencies || task.dependencies.length === 0) return;

    task.dependencies.forEach(depId => {
      const fromTask = document.querySelector(
        `.premium-task[data-task-id="${depId}"]`
      );
      const toTask = document.querySelector(
        `.premium-task[data-task-id="${task.id}"]`
      );

      if (!fromTask || !toTask) return;

      const barA = fromTask.children[1]?.children[1]?.getBoundingClientRect();
      const barB = toTask.children[1]?.children[1]?.getBoundingClientRect();

      if (!barA || !barB) return;

      const sx = barA.right - layerRect.left - 45;
      const sy = barA.top + barA.height / 2 - layerRect.top;

      const ex = barB.left - layerRect.left + 45;
      const ey = barB.top + barB.height / 2 - layerRect.top;

      const cx = (sx + ex) / 2;

      const d = `
        M ${sx} ${sy}
        C ${cx} ${sy},
          ${cx} ${ey},
          ${ex} ${ey}
      `;

      layer.innerHTML += `
        <svg width="100%" height="100%" style="position:absolute; overflow:visible;">
          <path d="${d}" stroke="#9b59b6" stroke-width="3" fill="none"></path>
          <circle cx="${ex}" cy="${ey}" r="4" fill="#9b59b6"></circle>
        </svg>
      `;
    });
  });
}

function enableTaskTooltips() {
  let tooltip = document.getElementById("premium-tooltip");

  if (!tooltip) {
    tooltip = document.createElement("div");
    tooltip.id = "premium-tooltip";
    tooltip.style.cssText = `
      position: fixed;
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 12px;
      pointer-events: none;
      z-index: 99999;
      opacity: 0;
      transition: opacity .15s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
      white-space: nowrap;
    `;
    document.body.appendChild(tooltip);
  }

  document.querySelectorAll(".premium-task").forEach(taskEl => {


    taskEl.addEventListener("mouseenter", e => {
      const name = taskEl.querySelector("div div div")?.innerText || "‚Äî";
      const duration = taskEl.querySelector("[style*='width:']")?.innerText || "";
      const deps = taskEl.querySelector("span")?.innerText || "";

      tooltip.innerHTML = `
        <strong>${name}</strong><br>
        ‚è± ${duration}<br>
        ${deps}
      `;

      tooltip.style.opacity = "1";
    });

    taskEl.addEventListener("mousemove", e => {
      tooltip.style.left = e.pageX + 15 + "px";
      tooltip.style.top = e.pageY + 15 + "px";
    });

    taskEl.addEventListener("mouseleave", () => {
      tooltip.style.opacity = "0";
    });
  });
}

function addPremiumStyles() {
  const styles = document.createElement('style');
  styles.textContent = `
    @keyframes premiumFadeIn {
      from {
        opacity: 0;
        transform: translate(-50%, -48%) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }
    
    .premium-task:hover {
      transform: translateY(-3px) !important;
      box-shadow: 0 15px 30px rgba(0,0,0,0.4) !important;
    }
    
    .premium-btn:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3) !important;
    }
    
    .kpi-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    }
    
    .active-btn {
      opacity: 1 !important;
      cursor: pointer !important;
    }
    
    #premiumTasksContainer::-webkit-scrollbar {
      height: 8px;
      width: 8px;
    }
    
    #premiumTasksContainer::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
    }
    
    #premiumTasksContainer::-webkit-scrollbar-thumb {
      background: rgba(52, 152, 219, 0.5);
      border-radius: 4px;
    }
    
    #premiumTasksContainer::-webkit-scrollbar-thumb:hover {
      background: rgba(52, 152, 219, 0.7);
    }
  `;
  document.head.appendChild(styles);
}

function createSampleProjects() {
  if (typeof projects === 'undefined') {
    window.projects = [];
    window.currentProjectIndex = 0;
  }
  
  const sampleProjects = [
    {
      name: "Proyecto Alpha",
      description: "Desarrollo de sistema principal",
      tasks: [
        {
          id: 1,
          name: "An√°lisis de requisitos",
          startDate: new Date().toISOString().split('T')[0],
          deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          status: "completed",
          priority: "alta",
          estimatedTime: 40,
          timeLogged: 40,
          assignee: "Ana Garc√≠a",
          dependencies: []
        },
        {
          id: 2,
          name: "Dise√±o de arquitectura",
          startDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          deadline: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          status: "inProgress",
          priority: "alta",
          estimatedTime: 60,
          timeLogged: 30,
          assignee: "Carlos L√≥pez",
          dependencies: [1]
        }
      ]
    },
    {
      name: "Proyecto Beta",
      description: "Sitio web corporativo",
      tasks: [
        {
          id: 3,
          name: "Dise√±o UI/UX",
          startDate: new Date().toISOString().split('T')[0],
          deadline: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          status: "inProgress",
          priority: "media",
          estimatedTime: 30,
          timeLogged: 15,
          assignee: "Mar√≠a Rodr√≠guez",
          dependencies: []
        },
        {
          id: 4,
          name: "Desarrollo Frontend",
          startDate: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          deadline: new Date(Date.now() + 12 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          status: "pending",
          priority: "alta",
          estimatedTime: 50,
          timeLogged: 0,
          assignee: "Pedro Mart√≠nez",
          dependencies: [3]
        }
      ]
    }
  ];
  
  if (projects.length === 0) {
    projects.push(...sampleProjects);
    currentProjectIndex = 0;
  }
  
  setTimeout(() => {
    createPremiumGanttWithYourData();
  }, 100);
}


function createCompleteGanttForCurrentProject() {
  // ‚úÖ Sin verificaciones de licencia
  console.log('üöÄ Creando Gantt completo...');


  if (currentProjectIndex >= projects.length) {
    alert('‚ùå Proyecto no v√°lido');
    return;
  }
  
  const yourProject = projects[currentProjectIndex];
  const yourTasks = yourProject.tasks || [];
  
  console.log('üìÇ Cargando proyecto:', yourProject.name);
  console.log('üìã Tareas del proyecto:', yourTasks);

  // ========== CONFIGURACI√ìN DE TIMELINE ==========
  const DIAS_PASADO = 130;     // D√≠as hacia atr√°s
  const DIAS_FUTURO = 90;     // D√≠as hacia adelante
  const TOTAL_DIAS = DIAS_PASADO + 1 + DIAS_FUTURO; // 181 d√≠as
  const PX_POR_DIA = 45;      // Ancho por d√≠a en p√≠xeles
  const ANCHO_TOTAL = TOTAL_DIAS * PX_POR_DIA; // 8145px
  
  console.log(`üìÖ Timeline: ${DIAS_PASADO} d√≠as pasado + HOY + ${DIAS_FUTURO} d√≠as futuro = ${TOTAL_DIAS} d√≠as`);
  console.log(`üìè Ancho total: ${ANCHO_TOTAL}px (${TOTAL_DIAS} √ó ${PX_POR_DIA}px)`);

  // TRANSFORMAR DATOS CON FECHA REAL - VERSI√ìN CORREGIDA
  const executiveTasks = yourTasks.map((task, index) => {
    let startDay = 0;
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    if (task.startDate) {
      try {
        const startDate = new Date(task.startDate);
        startDate.setHours(0, 0, 0, 0);
        // ‚úÖ CORRECCI√ìN: Usar getTime() y permitir valores NEGATIVOS
        startDay = Math.floor((startDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
        
        console.log(`üìÖ Tarea "${task.name}": ${task.startDate} ‚Üí startDay = ${startDay} (${startDay < 0 ? 'PASADO' : startDay > 0 ? 'FUTURO' : 'HOY'})`);
        
      } catch (e) {
        console.warn(`‚ö†Ô∏è Error con fecha de tarea "${task.name}":`, e.message);
        // Distribuir tareas
        startDay = (index - 5) * 10;
      }
    } else {
      // No tiene fecha, distribuir l√≥gicamente
      startDay = (index - 5) * 10;
    }

    let duration = 3;
    if (task.startDate && task.deadline) {
      try {
        const start = new Date(task.startDate);
        const end = new Date(task.deadline);
        duration = Math.max(1, Math.floor((end - start) / (1000 * 60 * 60 * 24)));
      } catch (e) {
        duration = task.estimatedTime
          ? Math.max(1, Math.ceil(task.estimatedTime / 8))
          : 3;
      }
    } else if (task.estimatedTime) {
      duration = Math.max(1, Math.ceil(task.estimatedTime / 8));
    }

    const statusColors = {
      pending: '#f1c40f',
      inProgress: '#008090',
      completed: '#2ecc71',
      overdue: '#e74c3c'
    };

    let progress = 0;
    if (task.status === 'completed') progress = 100;
    else if (task.timeLogged && task.estimatedTime) {
      progress = Math.min(
        100,
        Math.round((task.timeLogged / task.estimatedTime) * 100)
      );
    } else if (task.status === 'inProgress') progress = 50;

    const dependencies = task.dependencies || [];
    const isCritical = task.priority === 'alta' || task.status === 'overdue';
    const taskColor = statusColors[task.status] || '#95a5a6';

    const storyPoints = Number(task.storyPoints) || 0;

    return {
      id: task.id || Date.now() + index,
      name: task.name || `Tarea ${index + 1}`,
      progress,
      duration,
      startDay: startDay, // ‚úÖ Ahora puede ser negativo
      color: taskColor,
      critical: isCritical,
      dependencies,
      team: task.assignee ? [task.assignee] : ['Sin asignar'],
      status: task.status || 'pending',
      priority: task.priority || 'media',
      estimatedTime: task.estimatedTime || 0,
      timeLogged: task.timeLogged || 0,
      storyPoints,
      originalTask: { ...task, storyPoints },
      budget: task.cost 
        ? `$${task.cost.toLocaleString()}` 
        : (task.estimatedTime ? `${task.estimatedTime}h` : '')
    };
  });

  // ========================================
  // üß™ VERIFICACI√ìN DE TIMELINE
  // ========================================
  console.log('üß™ VERIFICACI√ìN TIMELINE DIN√ÅMICO');
  const taskStartDays = executiveTasks.map(t => {
    console.log(`Tarea: "${t.name}" - startDay: ${t.startDay}`);
    return t.startDay;
  });

  const earliestStartDay = Math.min(...taskStartDays, 0);
  const latestStartDay = Math.max(...taskStartDays, 0);
  
  console.log('üìÖ D√≠a m√°s temprano (m√°s negativo):', earliestStartDay);
  console.log('üìÖ D√≠a m√°s tard√≠o (m√°s positivo):', latestStartDay);
  console.log('üìä D√≠as hacia atr√°s configurados:', DIAS_PASADO);
  console.log('üìä D√≠as hacia adelante configurados:', DIAS_FUTURO);
  
  // Verificar que las tareas caben en el timeline
  if (earliestStartDay < -DIAS_PASADO) {
    console.warn(`‚ö†Ô∏è  ALERTA: Tarea comienza ${Math.abs(earliestStartDay)} d√≠as atr√°s, pero timeline solo muestra ${DIAS_PASADO} d√≠as`);
  }
  if (latestStartDay > DIAS_FUTURO) {
    console.warn(`‚ö†Ô∏è  ALERTA: Tarea termina ${latestStartDay} d√≠as adelante, pero timeline solo muestra ${DIAS_FUTURO} d√≠as`);
  }

  // CALCULAR KPIs
  const totalTasks = yourTasks.length;
  const completedTasks = executiveTasks.filter(t => t.status === 'completed').length;
  const criticalTasks = executiveTasks.filter(t => t.critical).length;
  const tasksWithDeps = executiveTasks.filter(t => t.dependencies.length > 0).length;
  const evm = calculateEVMRealFromTasks(yourTasks);
  const avgProgress = evm && evm.BAC > 0 ? Math.round((evm.EV / evm.BAC) * 100) : 0;
  
  // FECHA ACTUAL REAL
  const today = new Date();
  const todayFormatted = today.toLocaleDateString('es-ES', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
  
  const container = document.createElement('div');
  container.id = 'premiumExecutiveGantt';
  container.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 95vw;
    height: 90vh;
    background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
    border-radius: 24px;
    box-shadow: 0 30px 60px rgba(0,0,0,0.6);
    border: 1px solid rgba(52, 152, 219, 0.4);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    z-index: 999999;
  `;
  
  container.innerHTML = `
    <!-- HEADER CON TODOS LOS BOTONES ACTIVOS -->
    <div style="
      background: linear-gradient(90deg, #0a0a1a, #1a1a3a);
      padding: 25px 35px;
      border-bottom: 1px solid rgba(52, 152, 219, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    ">
      <div style="flex: 1;">
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 8px;">
          <div style="
            background: linear-gradient(45deg, #3498db, #2ecc71);
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
          ">
            üìä
          </div>
          <div style="flex: 1;">
            <h2 style="margin: 0; color: white; font-size: 28px; font-weight: 300;">
              <span style="font-weight: 700; color: #2ecc71;">${yourProject.name}</span>
              <span style="color: #95a5a6; font-size: 20px; margin-left: 10px;">- GANTT EXECUTIVE</span>
            </h2>
            <p style="margin: 5px 0 0 0; color: #95a5a6; font-size: 14px;">
              <span style="color: #3498db;">üìÖ ${todayFormatted}</span> ‚Ä¢ 
              üî• ${criticalTasks} cr√≠ticas ‚Ä¢ üîó ${tasksWithDeps} dependencias ‚Ä¢ üìä ${avgProgress}% progreso
              <br><span style="color: #f39c12; font-size: 12px;">Timeline: ${DIAS_PASADO} d√≠as pasado | HOY | ${DIAS_FUTURO} d√≠as futuro</span>
            </p>
          </div>
        </div>
      </div>
      
      <!-- TODOS LOS BOTONES ACTIVOS - CON BURNDOWN Y VALOR GANADO JUNTOS -->
      <div style="display: flex; gap: 12px;">
        <button onclick="toggleMobileViewPremium()" class="premium-btn active-btn" style="
          background: linear-gradient(45deg, #9b59b6, #8e44ad);
          border: none;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          font-weight: bold;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.3s;
          font-size: 14px;
        ">
          üì± Mobile
        </button>
        
        <!-- GRUPO BURNDOWN + VALOR GANADO JUNTOS -->
        <div style="display: flex; gap: 0; align-items: center;">
          <button onclick="showBurnDownChartPremium()" class="premium-btn active-btn" style="
            background: linear-gradient(45deg, #f39c12, #d35400);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 8px 0 0 8px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-size: 14px;
            border-right: 1px solid rgba(255,255,255,0.2);
          ">
            üìâ Burndown
          </button>
          
          <button button onclick="openEVMDashboard()" class="premium-btn active-btn" style="
            background: linear-gradient(45deg, #8b5cf6, #6d28d9);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 0 8px 8px 0;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-size: 14px;
          ">
            üìà Valor Ganado
          </button>
        </div>

        <!-- NUEVO: Bot√≥n de Configuraci√≥n de Costos -->
        <button onclick="showCostConfigurationPanel()" class="premium-btn active-btn" style="
          background: linear-gradient(45deg, #f39c12, #d35400);
          border: none;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          font-weight: bold;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.3s;
          font-size: 14px;
        ">
          üí∞ Costos
        </button>

        <button onclick="showAIPredictorPremium()" class="premium-btn active-btn" style="
          background: linear-gradient(45deg, #3498db, #2980b9);
          border: none;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          font-weight: bold;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.3s;
          font-size: 14px;
        ">
          ü§ñ IA Predictor
        </button>
        
        <button onclick="switchProjectPremium()" class="premium-btn active-btn" style="
          background: linear-gradient(45deg, #1abc9c, #16a085);
          border: none;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          font-weight: bold;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.3s;
          font-size: 14px;
        ">
          üîÑ Cambiar Proyecto
        </button>

        <button onclick="exportGanttData()" class="premium-btn active-btn" style="
          background: linear-gradient(135deg, #1F3A5F, #2C5AA0);
          border: none;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 14px;
        ">
          üìä Reporte Ejecutivo
        </button>

        <button onclick="window.goBackToDashboard()" style="
          background: rgba(52, 152, 219, 0.2);
          border: 1px solid #3498db;
          color: #3498db;
          padding: 12px 20px;
          border-radius: 8px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s;
          font-size: 14px;
        ">
          ‚Üê Volver al Tablero
        </button>
      </div>
    </div>
    
    <!-- CONTENT CON MEN√ö LATERAL COMPLETO Y COLUMNA FIJA -->
    <div style="flex: 1; display: flex; overflow: hidden;">
      <!-- SIDEBAR COMPLETO CON TODAS LAS FUNCIONALIDADES -->
      <div style="
        width: 320px;
        background: linear-gradient(180deg, #0a0a1a, #121230);
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        padding: 25px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 25px;
        flex-shrink: 0;
      ">
        <!-- KPIs -->
        <div>
          <h3 style="color: white; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
            <span style="color: #3498db; font-size: 20px;">üìä</span> 
            <span>Dashboard Ejecutivo</span>
          </h3>
          
          <div class="kpi-card" style="
            background: rgba(255,255,255,0.05); 
            border-radius: 12px; 
            padding: 20px; 
            margin-bottom: 20px;
            transition: all 0.3s;
          ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <div style="color: #95a5a6; font-size: 14px;">Progreso General</div>
              <div style="color: #2ecc71; font-size: 24px; font-weight: bold;">${avgProgress}%</div>
            </div>
            <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
              <div style="width: ${avgProgress}%; height: 100%; background: linear-gradient(90deg, #3498db, #2ecc71); border-radius: 4px;"></div>
            </div>
          </div>
          
          <!-- DEPENDENCIAS DETALLADAS -->
          <div class="kpi-card" style="
            background: rgba(155, 89, 182, 0.1); 
            border: 1px solid rgba(155, 89, 182, 0.3); 
            border-radius: 12px; 
            padding: 18px; 
            margin-bottom: 20px;
            transition: all 0.3s;
          ">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
              <span style="color: #9b59b6; font-size: 18px;">üîó</span>
              <span style="color: white; font-weight: bold;">Dependencias</span>
            </div>
            <div style="color: #9b59b6; font-size: 12px; margin-bottom: 10px;">
              ${tasksWithDeps} tareas con dependencias
            </div>
            ${generateDependenciesList(executiveTasks)}
          </div>
          
          <!-- RUTA CR√çTICA -->
          <div class="kpi-card" style="
            background: rgba(231, 76, 60, 0.1); 
            border: 1px solid rgba(231, 76, 60, 0.3); 
            border-radius: 12px; 
            padding: 18px; 
            margin-bottom: 20px;
            transition: all 0.3s;
          ">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
              <span style="color: #e74c3c; font-size: 18px;">üî•</span>
              <span style="color: white; font-weight: bold;">Ruta Cr√≠tica</span>
            </div>
            <div style="color: #e74c3c; font-size: 12px; margin-bottom: 10px;">
              ${criticalTasks} tareas cr√≠ticas identificadas
            </div>
            <div style="color: #95a5a6; font-size: 11px;">
              ${getCriticalTasksDetails(executiveTasks)}
            </div>
          </div>
          
          <!-- PREDICTOR IA -->
          <div class="kpi-card" style="
            background: rgba(52, 152, 219, 0.1); 
            border-radius: 12px; 
            padding: 20px;
            transition: all 0.3s;
          ">
            <div style="color: white; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
              <span style="color: #3498db;">ü§ñ</span> IA Predictor
            </div>
            <div style="color: #95a5a6; font-size: 13px; margin-bottom: 15px;">
              Predicci√≥n basada en ${totalTasks} tareas
            </div>
            <div style="
              background: rgba(255,255,255,0.1);
              border-radius: 8px;
              padding: 15px;
              text-align: center;
              margin-bottom: 15px;
            ">
              <div style="color: #2ecc71; font-size: 20px; font-weight: bold;">${calculatePredictedEndDatePremium(executiveTasks)}</div>
              <div style="color: #95a5a6; font-size: 12px; margin-top: 5px;">
                Fecha estimada finalizaci√≥n
              </div>
            </div>
            <button onclick="runAIAnalysisPremium()" class="premium-btn" style="
              width: 100%;
              background: linear-gradient(45deg, #3498db, #2980b9);
              border: none;
              color: white;
              padding: 12px;
              border-radius: 8px;
              font-weight: bold;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 10px;
              transition: all 0.3s;
            ">
              üîÑ Ejecutar An√°lisis Predictivo
            </button>
          </div>
          
          <!-- RESOURCE ALLOCATION -->
          <div class="kpi-card" style="
            background: rgba(46, 204, 113, 0.1); 
            border-radius: 12px; 
            padding: 20px;
            margin-top: 20px;
            transition: all 0.3s;
          ">
            <div style="color: white; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
              <span style="color: #2ecc71;">üë•</span> Distribuci√≥n de Equipo
            </div>
            <div style="color: #95a5a6; font-size: 13px; margin-bottom: 15px;">
              ${countTeamMembers(executiveTasks)} miembros asignados
            </div>
            ${generateTeamDistribution(executiveTasks)}
          </div>
        </div>
        
        <!-- FILTROS EJECUTIVOS -->
        <div>
          <h3 style="color: white; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
            <span style="color: #f1c40f; font-size: 20px;">‚ö°</span> 
            <span>Filtros Ejecutivos</span>
          </h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
            <button onclick="filterCriticalTasksPremium()" class="premium-btn" style="
              background: rgba(231, 76, 60, 0.15);
              border: 1px solid #e74c3c;
              color: #e74c3c;
              padding: 12px;
              border-radius: 8px;
              cursor: pointer;
              transition: all 0.3s;
              font-size: 13px;
              display: flex;
              align-items: center;
              gap: 8px;
              justify-content: center;
            ">
              üî¥ Cr√≠ticas
            </button>
            <button onclick="filterDelayedTasksPremium()" class="premium-btn" style="
              background: rgba(243, 156, 18, 0.15);
              border: 1px solid #f39c12;
              color: #f39c12;
              padding: 12px;
              border-radius: 8px;
              cursor: pointer;
              transition: all 0.3s;
              font-size: 13px;
              display: flex;
              align-items: center;
              gap: 8px;
              justify-content: center;
            ">
              ‚ö° Atrasadas
            </button>
            <button onclick="filterByTeamPremium()" class="premium-btn" style="
              background: rgba(155, 89, 182, 0.15);
              border: 1px solid #9b59b6;
              color: #9b59b6;
              padding: 12px;
              border-radius: 8px;
              cursor: pointer;
              transition: all 0.3s;
              font-size: 13px;
              display: flex;
              align-items: center;
              gap: 8px;
              justify-content: center;
            ">
              üë• Por Equipo
            </button>
            <button onclick="filterByBudgetPremium()" class="premium-btn" style="
              background: rgba(46, 204, 113, 0.15);
              border: 1px solid #2ecc71;
              color: #2ecc71;
              padding: 12px;
              border-radius: 8px;
              cursor: pointer;
              transition: all 0.3s;
              font-size: 13px;
              display: flex;
              align-items: center;
              gap: 8px;
              justify-content: center;
            ">
              üí∞ Presupuesto
            </button>
            <button onclick="showAllTasksPremium()" class="premium-btn" style="
              background: rgba(52, 152, 219, 0.15);
              border: 1px solid #3498db;
              color: #3498db;
              padding: 12px;
              border-radius: 8px;
              cursor: pointer;
              transition: all 0.3s;
              font-size: 13px;
              display: flex;
              align-items: center;
              gap: 8px;
              justify-content: center;
              grid-column: span 2;
            ">
              üìã Mostrar Todas
            </button>
          </div>
        </div>
        
        <!-- GESTI√ìN DE DEPENDENCIAS -->
        <div>
          <h3 style="color: white; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
            <span style="color: #1abc9c; font-size: 20px;">üîß</span> 
            <span>Gesti√≥n de Dependencias</span>
          </h3>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <button onclick="openDependencyCreator()" class="premium-btn" style="
              background: linear-gradient(45deg, #9b59b6, #8e44ad);
              border: none;
              color: white;
              padding: 12px;
              border-radius: 8px;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 10px;
              justify-content: center;
              font-weight: bold;
            ">
              üîó Crear Dependencias
            </button>
            <button onclick="markAsCriticalPath()" class="premium-btn" style="
              background: linear-gradient(45deg, #e74c3c, #c0392b);
              border: none;
              color: white;
              padding: 12px;
              border-radius: 8px;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 10px;
              justify-content: center;
              font-weight: bold;
            ">
              üî• Marcar Ruta Cr√≠tica
            </button>
            <button onclick="clearAllDependencies()" class="premium-btn" style="
              background: linear-gradient(45deg, #95a5a6, #7f8c8d);
              border: none;
              color: white;
              padding: 12px;
              border-radius: 8px;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 10px;
              justify-content: center;
              font-weight: bold;
            ">
              üóëÔ∏è Limpiar Todas
            </button>
          </div>
        </div>
      </div>
      
      <!-- MAIN AREA CON SCROLL HORIZONTAL SOLO EN LAS FECHAS -->
      <div style="
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: linear-gradient(180deg, rgba(10, 10, 26, 0.9), rgba(18, 18, 48, 0.95));
      ">
        <!-- TIMELINE HEADER FIJA CON SCROLL HORIZONTAL -->
        <div style="
          display: flex;
          background: rgba(255, 255, 255, 0.05);
          border-radius: 12px 12px 0 0;
          padding: 18px 0 18px 320px;
          position: relative;
          overflow-x: auto;
          overflow-y: hidden;
          flex-shrink: 0;
          margin: 0;
        ">
          <!-- COLUMNA FIJA DE T√çTULO -->
          <div style="
            width: 320px;
            padding: 10px 20px;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px 0 0 0;
          ">
            <span style="color: #3498db;">üìÖ</span> TIMELINE
          </div>
          
          <!-- FECHAS CON SCROLL (181 d√≠as totales) -->
          <div style="display: flex; min-width: max-content;">
            ${Array.from({length: TOTAL_DIAS}, (_, i) => {
              const offset = -DIAS_PASADO;  // 90 d√≠as hacia atr√°s
              const date = new Date(today);
              date.setDate(today.getDate() + i + offset);
              const dayOfWeek = date.getDay();
              const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
              const isToday = i === DIAS_PASADO;  // HOY est√° en la posici√≥n 90
              const isWeekStart = (i + DIAS_PASADO) % 7 === 0;
              const isFirstOfMonth = date.getDate() === 1;
              
              // Solo mostrar d√≠as importantes para no saturar
              const tamanoFuente = isFirstOfMonth ? '14px' : '12px';
const padding = '10px 4px';

              
              return `
                <div style="
                  flex: 0 0 ${PX_POR_DIA}px;
                  text-align: center;
                  padding: ${padding};
                  border-right: 1px solid rgba(255,255,255,0.1);
                  color: ${isWeekend ? '#7f8c8d' : 'white'};
                  font-weight: ${isWeekStart ? 'bold' : 'normal'};
                  position: relative;
                  min-width: ${PX_POR_DIA}px;
                  background: ${isToday ? 'rgba(46, 204, 113, 0.1)' : 'transparent'};
                ">
                  ${isWeekStart ? `<div style="position: absolute; top: -18px; left: 0; right: 0; color: #3498db; font-size: 11px;">Sem ${Math.floor((i+DIAS_PASADO)/7) + 1}</div>` : ''}
                  ${isToday ? `<div style="position: absolute; top: -25px; left: 0; right: 0; background: #2ecc71; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; z-index: 100;">HOY</div>` : ''}
                  <div style="font-size: 11px; color: ${isWeekend ? '#7f8c8d' : '#95a5a6'}; margin-bottom: 5px;">
                    ${date.toLocaleDateString('es-ES', { weekday: isWeekStart ? 'short' : 'narrow' })}
                  </div>
                  <div style="font-size: ${isFirstOfMonth ? '14px' : tamanoFuente}; color: ${isToday ? '#2ecc71' : (isWeekend ? '#7f8c8d' : 'white')}; font-weight: ${isFirstOfMonth ? 'bold' : 'normal'};">
                    ${date.getDate()}
                  </div>
                  ${isFirstOfMonth ? `<div style="position: absolute; top: -18px; left: 0; right: 0; color: #3498db; font-size: 11px;">${date.toLocaleDateString('es-ES', { month: 'short' })}</div>` : ''}
                </div>
              `;
            }).join('')}
          </div>
        </div>
        
        <!-- TASKS CONTAINER CON SCROLL HORIZONTAL SOLO EN BARRAS -->
        <div id="premiumTasksContainer" style="
          flex: 1;
          position: relative;
          overflow-x: auto;
          overflow-y: auto;
          padding-right: 0;
        ">
          <div style="position: relative; min-width: max-content; min-height: 100%;">
            ${executiveTasks.map((task, index) => `
              <!-- TAREA CON COLUMNA FIJA Y BARRAS CON SCROLL -->
              <div class="premium-task" data-task-id="${task.id}" style="
                display: flex;
                align-items: center;
                margin-bottom: 20px;
                padding: 20px 0 20px 320px;

                background: ${task.critical ? 'rgba(231, 76, 60, 0.1)' : 'rgba(255, 255, 255, 0.03)'};
                border-radius: 12px;
                transition: all 0.3s;
                border-left: 4px solid ${task.color};
                position: relative;
                overflow: visible;
                height: 60px;
                border: ${task.critical ? '1px solid rgba(231, 76, 60, 0.3)' : '1px solid rgba(255, 255, 255, 0.05)'};
                cursor: pointer;
                min-width: max-content;
              " onclick="showPremiumTaskDetails('${task.id}')">
                
                <!-- COLUMNA FIJA CON INFORMACI√ìN DE TAREA -->
                <div style="
                  width: 320px;
                  padding: 0 20px;
                  position: absolute;
                  left: 0;
                  top: 0;
                  bottom: 0;
                  display: flex;
                  align-items: center;
                  background: ${task.critical ? 'rgba(231, 76, 60, 0.05)' : 'transparent'};
                  border-radius: 12px 0 0 12px;
                ">
                  <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
                    <div style="
                      width: 36px;
                      height: 36px;
                      background: ${task.color};
                      border-radius: 10px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      color: white;
                      font-weight: bold;
                      box-shadow: 0 5px 15px ${task.color}40;
                      flex-shrink: 0;
                    ">
                      ${index + 1}
                    </div>

                    <div style="flex: 1; min-width: 0;">
                      <div style="color: white; font-weight: bold; font-size: 15px; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; overflow: hidden; text-overflow: ellipsis;">
                        ${task.name}
                        ${task.critical ? '<span style="color: #e74c3c; font-size: 12px; background: rgba(231, 76, 60, 0.2); padding: 2px 8px; border-radius: 10px; flex-shrink: 0;">CR√çTICA</span>' : ''}
                      </div>
                      <div style="color: #95a5a6; font-size: 12px; display: flex; gap: 15px; overflow: hidden;">
                        <span style="flex-shrink: 0;">üë§ ${task.team[0]}</span>
                        <span style="flex-shrink: 0;">‚è±Ô∏è ${task.budget}</span>
                        ${task.dependencies.length > 0 ? `<span style="flex-shrink: 0;">üîó ${task.dependencies.length} dep</span>` : ''}
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- √ÅREA DE BARRAS GANTT CON SCROLL HORIZONTAL -->
                <div style="
                  flex: 1;
                  height: 40px;
                  position: relative;
                  min-width: ${ANCHO_TOTAL}px;
                ">
                  <!-- BACKGROUND -->
                  <div style="
                    position: absolute;
                    left: 0;
                    right: 0;
                    height: 100%;
                    background: rgba(255,255,255,0.03);
                    border-radius: 8px;
                  "></div>
                  
                  <!-- MAIN BAR -->
                  <div style="
                    position: absolute;
                    left: ${(task.startDay + DIAS_PASADO) * PX_POR_DIA}px;  // ‚úÖ +90 d√≠as de offset
                    width: ${task.duration * PX_POR_DIA}px;
                    height: 100%;
                    background: linear-gradient(90deg, ${task.color}99, ${task.color});
                    border-radius: 8px;
                    box-shadow: 
                      0 4px 20px ${task.color}40,
                      inset 0 2px 4px rgba(255,255,255,0.2);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: bold;
                    font-size: 13px;
                    z-index: 10;
                  ">
                    <!-- PROGRESS OVERLAY -->
                    <div style="
                      position: absolute;
                      top: 0;
                      left: 0;
                      width: ${task.progress}%;
                      height: 100%;
                      background: linear-gradient(90deg, rgba(255,255,255,0.3), transparent);
                      border-radius: 8px;
                    "></div>
                    <div style="position: relative; z-index: 2;">
                      ${task.duration}d ‚Ä¢ ${task.progress}%
                    </div>
                  </div>
                  
                  <!-- TODAY MARKER -->
                  <div style="
                    position: absolute;
                    left: ${DIAS_PASADO * PX_POR_DIA}px;  // 90 * 45 = 4050px
                    top: -10px;
                    bottom: -10px;
                    width: 2px;
                    background: #2ecc71;
                    z-index: 5;
                  ">
                    <div style="
                      position: absolute;
                      top: -20px;
                      left: -8px;
                      background: #2ecc71;
                      color: white;
                      padding: 2px 8px;
                      border-radius: 4px;
                      font-size: 10px;
                      font-weight: bold;
                    ">
                      HOY
                    </div>
                  </div>
                </div>
                
                <!-- ACCIONES -->
                <div style="
                  margin-left: 20px;
                  display: flex;
                  gap: 8px;
                  position: absolute;
                  right: 20px;
                  top: 50%;
                  transform: translateY(-50%);
                  z-index: 20;
                ">
                  <button onclick="event.stopPropagation(); updatePremiumTaskProgress('${task.id}')" style="
                    width: 40px;
                    height: 40px;
                    border-radius: 10px;
                    background: rgba(46, 204, 113, 0.2);
                    border: 1px solid #2ecc71;
                    color: #2ecc71;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.3s;
                    font-size: 16px;
                  " title="Actualizar progreso">
                    üìà
                  </button>
                </div>
              </div>
            `).join('')}

            <!-- LAYER PARA DEPENDENCIAS -->
            <div id="dependencyLayer" style="
              position: absolute;
              top: 0;
              left: 320px;
              right: 80px;
              bottom: 0;
              pointer-events: none;
              overflow: visible;
              z-index: 5;
            "></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- FOOTER -->
    <div style="
      background: rgba(255, 255, 255, 0.05);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding: 15px 35px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      color: #95a5a6;
    ">
      <div style="display: flex; gap: 30px;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 12px; height: 12px; background: #e74c3c; border-radius: 50%;"></div>
          <span>Ruta Cr√≠tica (${criticalTasks})</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 12px; height: 12px; background: #9b59b6; border-radius: 50%;"></div>
          <span>Dependencias (${tasksWithDeps})</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 12px; height: 12px; background: #2ecc71; border-radius: 50%;"></div>
          <span>Progreso: ${avgProgress}%</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 12px; height: 12px; background: #3498db; border-radius: 50%;"></div>
          <span>Tareas: ${totalTasks}</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 12px; height: 12px; background: #f39c12; border-radius: 50%;"></div>
          <span>Timeline: ${DIAS_PASADO}d‚ÜêHOY‚Üí${DIAS_FUTURO}d</span>
        </div>
      </div>
      <div>
        <span>üîÑ Actualizado: ${new Date().toLocaleTimeString()}</span>
      </div>
    </div>
  `;
  
  // POR ESTO:
  // 1. Ocultar otras vistas si existen
  document.querySelectorAll('.view-container').forEach(view => {
    view.style.display = 'none';
  });

  // 2. Crear o usar un contenedor principal para vistas
  let mainContainer = document.getElementById('mainAppContainer');
  if (!mainContainer) {
    mainContainer = document.createElement('div');
    mainContainer.id = 'mainAppContainer';
    mainContainer.style.cssText = 'width: 100%; height: 100vh; overflow: hidden;';
    document.body.appendChild(mainContainer);
  }

  // 3. Limpiar y agregar el Gantt
  mainContainer.innerHTML = '';
  mainContainer.appendChild(container);
  window.__premiumTasks = executiveTasks;

  container.dataset.projectIndex = currentProjectIndex;
  container.dataset.tasks = JSON.stringify(executiveTasks);
  container.dataset.projectName = yourProject.name;

  // Inyectar bot√≥n de Vista Premium despu√©s de crear el Gantt
  setTimeout(() => {
    if (typeof addPremiumFullscreenButton === 'function') {
      addPremiumFullscreenButton();
    }
    
    // Auto-scroll para centrar HOY
    const tasksContainer = document.getElementById('premiumTasksContainer');
    if (tasksContainer) {
      // Centrar HOY en la vista (4050px - mitad del ancho visible)
      const scrollLeft = (DIAS_PASADO * PX_POR_DIA) - (tasksContainer.clientWidth / 2);
      tasksContainer.scrollLeft = Math.max(0, scrollLeft);
      console.log(`üéØ Auto-scroll a posici√≥n: ${scrollLeft}px (HOY en ${DIAS_PASADO * PX_POR_DIA}px)`);
    }
  }, 500);

  console.log('üìä Proyecto cargado:', yourProject.name);
  console.log('üìã Tareas procesadas:', executiveTasks.length);
  console.log(`üéØ Timeline: ${TOTAL_DIAS} d√≠as, Ancho: ${ANCHO_TOTAL}px`);
  console.log(`üéØ "HOY" en posici√≥n: ${DIAS_PASADO * PX_POR_DIA}px`);
  


// =====================================================
// üß± FIX DEFINITIVO: TIMELINE + DESCRIPCI√ìN OPACOS (JIRA)
// =====================================================
(() => {
  const gantt = document.getElementById('premiumExecutiveGantt');
  const body = document.getElementById('premiumTasksContainer');

  if (!gantt || !body) {
    console.warn('‚ùå FIX GANTT: contenedores no encontrados');
    return;
  }

  // üìÖ Caja del t√≠tulo TIMELINE
  const timelineTitle = Array.from(gantt.querySelectorAll('div')).find(el =>
    el.innerText?.includes('TIMELINE') &&
    el.style.width === '320px'
  );

  // üìã Columnas izquierdas (descripci√≥n de tareas)
  const taskLeftColumns = () =>
    document.querySelectorAll('[data-task-id] > div[style*="width: 320px"]');

  let lastX = 0;

  body.addEventListener('scroll', () => {
    const x = body.scrollLeft;
    if (x === lastX) return;
    lastX = x;

    // üîπ Descripci√≥n de tareas: pared s√≥lida
    taskLeftColumns().forEach(col => {
      col.style.transform = `translateX(${x}px)`;
      col.style.zIndex = '40';
      col.style.background = `
        linear-gradient(
          180deg,
          rgba(18,18,48,1) 0%,
          rgba(18,18,48,1) 90%,
          rgba(18,18,48,0.98) 100%
        )
      `;
      col.style.boxShadow = '6px 0 14px rgba(0,0,0,0.45)';
    });

    // üîπ T√çTULO TIMELINE: totalmente fijo y opaco
    if (timelineTitle) {
      timelineTitle.style.transform = 'translateX(0px)';
      timelineTitle.style.zIndex = '60';
      timelineTitle.style.background = `
        linear-gradient(
          90deg,
          rgba(18,18,48,1) 0%,
          rgba(18,18,48,1) 85%,
          rgba(18,18,48,0.95) 92%,
          rgba(18,18,48,0) 100%
        )
      `;
      timelineTitle.style.boxShadow = '4px 0 12px rgba(0,0,0,0.45)';
    }
  });

  console.log('üèÜ FIX DEFINITIVO GANTT aplicado (estilo Jira)');
})();



  setTimeout(() => {
    drawPremiumDependenciesComplete(executiveTasks);
    enableTaskTooltips();
  }, 200);
  
  addPremiumStyles();


// =====================================================
// üîí FIX FINAL SEGURO ‚Äî GANTT TIPO JIRA
// =====================================================
(() => {
  const body = document.getElementById('premiumTasksContainer');
  const gantt = document.getElementById('premiumExecutiveGantt');

  if (!body || !gantt) return;

  // Columna izquierda de tareas (320px)
  const taskLeftColumns = () =>
    document.querySelectorAll('[data-task-id] > div[style*="width: 320px"]');

  // T√≠tulo TIMELINE
  const timelineTitle = Array.from(
    gantt.querySelectorAll('div')
  ).find(el =>
    el.innerText?.includes('TIMELINE') &&
    el.style.width === '320px'
  );

  if (!timelineTitle) return;

  const timelineHeader = timelineTitle.parentElement;

  // Quitar scroll duplicado del header
  timelineHeader.style.overflowX = 'hidden';

  let lastX = -1;

  body.addEventListener('scroll', () => {
    const x = body.scrollLeft;
    if (x === lastX) return;
    lastX = x;

    // Descripci√≥n fija
    taskLeftColumns().forEach(col => {
      col.style.transform = `translateX(${x}px)`;
      col.style.zIndex = '30';
    });

    // T√≠tulo TIMELINE totalmente fijo
    timelineTitle.style.transform = 'translateX(0px)';
    timelineTitle.style.zIndex = '50';

    // Fechas se mueven con el scroll
    Array.from(timelineHeader.children).forEach(child => {
      if (child !== timelineTitle) {
        child.style.transform = `translateX(${-x}px)`;
      }
    });
  });

  console.log('‚úÖ FIX SEGURO APLICADO ‚Äî sin romper render');
})();




}


















function ensureProjectHealthHandle() {
  let handle = document.getElementById('project-health-handle');

  if (!handle) {
    handle = document.createElement('div');
    handle.id = 'project-health-handle';
    handle.textContent = 'üß†';
    handle.title = 'Mostrar salud del proyecto';

    handle.style.position = 'absolute';
    handle.style.right = '0';
    handle.style.top = '50%';
    handle.style.transform = 'translateY(-50%)';
    handle.style.background = '#020617';
    handle.style.borderTop = '1px solid #1e293b';
    handle.style.borderBottom = '1px solid #1e293b';
    handle.style.borderLeft = '1px solid #1e293b';
    handle.style.borderRadius = '8px 0 0 8px';
    handle.style.padding = '10px 8px';
    handle.style.cursor = 'pointer';
    handle.style.fontSize = '18px';
    handle.style.zIndex = '20'; // ‚¨ÖÔ∏è IMPORTANTE: no usar 9999

    handle.onclick = () => {
      showProjectHealthPanel();
    };

    const overlay = document.querySelector('.executive-overlay');
    if (overlay) {
      overlay.appendChild(handle);
    }
  }

  handle.style.display = 'block';
}



// ========== FUNCI√ìN BURNDOWN CHART PREMIUM ==========
window.showBurnDownChartPremium = function() {

  // üîí Verificar licencia ANTES de hacer cualquier cosa
  if (!window.licenseManager.canAccess('premiumExecutiveGantt')) {
    showNotification('üîí El Burndown Premium requiere el plan Profesional o Premium.');
    return;
  }

  console.log('üìâ ACTIVANDO BURNDOWN CHART PREMIUM...');
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) {
    showNotification('‚ö†Ô∏è Abre primero el Gantt Ejecutivo.');
    return;
  }  
  const projectName = ganttContainer.dataset.projectName || 'Proyecto actual';
  
  // Crear overlay DENTRO del contenedor del Gantt
  const overlay = document.createElement('div');
  overlay.className = 'executive-overlay';
  overlay.style.cssText = `
    position: absolute; /* Cambiado de fixed a absolute */
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    z-index: 1000000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  `;
  
  // Crear modal premium de Burndown
  const modal = document.createElement('div');
  modal.className = 'executive-modal';
  modal.style.cssText = `
    width: 90vw;
    height: 85vh;
    background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
    border-radius: 24px;
    box-shadow: 0 40px 80px rgba(0,0,0,0.8);
  border: 1px solid rgba(148, 163, 184, 0.25);

    overflow: hidden;
    display: flex;
    flex-direction: column;
  `;
  
  modal.innerHTML = `
    <div style="
      padding: 25px 35px;
      background: linear-gradient(90deg, #0a0a1a, #1a1a3a);
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);

      display: flex;
      justify-content: space-between;
      align-items: center;
    ">
      <div>
        <h2 style="margin: 0 0 8px 0; color: white; font-size: 28px;">
          üìâ <span style="color: #93c5fd;">Burndown Chart</span>
 - ${projectName}
        </h2>
        <p style="margin: 0; color: #95a5a6; font-size: 14px;">
          An√°lisis ejecutivo de progreso vs tiempo ‚Ä¢ Actualizado: ${new Date().toLocaleTimeString()}
        </p>
      </div>
      <button onclick="closeBurndownModal()" style="
        background: rgba(231, 76, 60, 0.2);
        border: 1px solid #e74c3c;
        color: #e74c3c;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
      ">
        √ó Cerrar
      </button>
    </div>
    
    <div style="flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 25px;">
      
      <!-- M√©tricas principales -->
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
       <div style="
  background: rgba(30, 41, 59, 0.6);
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 15px;
  padding: 20px;
  text-align: center;
">

          <div style="color: #fde68a; font-size: 14px; margin-bottom: 8px;">TAREAS TOTALES</div>
          <div style="color: #e5e7eb; font-size: 32px; font-weight: 600; background: none;" id="totalTasks">0</div>

          <div style="color: #fde68a; font-size: 12px; margin-top: 8px;">En el backlog</div>
        </div>
        
        <div style="
          background: rgba(46, 204, 113, 0.1);
          border: 2px solid rgba(46, 204, 113, 0.3);
          border-radius: 15px;
          padding: 20px;
          text-align: center;
        ">
          <div style="color: #a7f3d0; font-size: 14px; margin-bottom: 8px;">TAREAS COMPLETADAS</div>
          <div style="color: white; font-size: 32px; font-weight: bold;" id="completedTasks">0</div>
          <div style="color: #a7f3d0; font-size: 12px; margin-top: 8px;">% completado</div>
        </div>
        
        <div style="
          background: rgba(52, 152, 219, 0.1);
          border: 2px solid rgba(52, 152, 219, 0.3);
          border-radius: 15px;
          padding: 20px;
          text-align: center;
        ">
          <div style="color: #93c5fd; font-size: 14px; margin-bottom: 8px;">VELOCIDAD</div>
          <div style="color: white; font-size: 32px; font-weight: bold;" id="velocity">0.0</div>
          <div style="color: #93c5fd; font-size: 12px; margin-top: 8px;">tareas/semana</div>
        </div>
      </div>
      
      <!-- Gr√°fico Burndown -->
      <div style="
        background: rgba(26, 31, 60, 0.8);
        border-radius: 18px;
        padding: 25px;
        border: 2px solid rgba(255,255,255,0.15);
        flex: 1;
      ">
        <h3 style="color: white; margin: 0 0 20px 0; font-size: 20px;">üìà GR√ÅFICO DE BURNDOWN</h3>
        
        <!-- Contenedor del gr√°fico -->
        <div style="height: 300px; position: relative;">
          <canvas id="burndownChartCanvasPremium" style="width: 100%; height: 100%;"></canvas>
        </div>
      </div>
      




    <!-- üìä AN√ÅLISIS DEL PROYECTO -->
<div
  style="
    background: rgba(30, 41, 59, 0.6);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 18px;
    padding: 25px;
  "
>
  <h3 style="color: white; margin: 0 0 20px 0; font-size: 20px;">
    üìä AN√ÅLISIS DEL PROYECTO
  </h3>

  <div
    id="projectAnalysis"
    style="color: #95a5a6; font-size: 14px; line-height: 1.6;"
  >
    <p>Cargando an√°lisis...</p>
  </div>
</div>

    



<!-- üïí AUDITOR√çA DEL PROYECTO -->
<div class="project-audit-wrapper">

  <h3 class="project-audit-title">
    üïí AUDITOR√çA DEL PROYECTO
  </h3>

  <div id="projectTimeline" class="project-timeline"></div>

</div>




    <!-- Footer -->
    <div style="
      background: rgba(255,255,255,0.03);
      border-top: 1px solid rgba(255,255,255,0.1);
      padding: 15px 35px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #95a5a6;
      font-size: 13px;
    ">
      <div>
        <span>üìä Sistema Burndown Chart ‚Ä¢ M√©tricas en tiempo real</span>
      </div>
      <div style="display: flex; gap: 15px;">
        <button onclick="exportBurndownChartPremium()" style="
          background: rgba(52, 152, 219, 0.2);
          border: 1px solid #3498db;
          color: #3498db;
          padding: 8px 15px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 12px;
        ">
          üì• Exportar Gr√°fico
        </button>
        <button onclick="generateBurndownReport()" style="
          background: rgba(46, 204, 113, 0.2);
          border: 1px solid #2ecc71;
          color: #2ecc71;
          padding: 8px 15px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 12px;
        ">
          üìÑ Reporte Completo
        </button>
      </div>
    </div>


<!-- Footer -->
<div style="
  background: rgba(255,255,255,0.03);
  border-top: 1px solid rgba(255,255,255,0.1);
  padding: 15px 35px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: #95a5a6;
  font-size: 13px;
">
 

  `;
  







// ================= BURNDOWN M√âTRICAS =================
const project = projects[currentProjectIndex];
const tasks = project?.tasks || [];

console.log('üß™ Tasks reales para Burndown:', tasks);

// Calcular m√©tricas
const totalTasks = tasks.length;
const completedTasks = tasks.filter(t => t.status === 'completed').length;
const inProgressTasks = tasks.filter(t => t.status === 'inProgress').length;

const completionPercentage =
  totalTasks > 0
    ? Math.round((completedTasks / totalTasks) * 100)
    : 0;

// Buscar elementos DENTRO del modal
const totalTasksEl = modal.querySelector('#totalTasks');
const completedTasksEl = modal.querySelector('#completedTasks');
const velocityEl = modal.querySelector('#velocity');

// Pintar m√©tricas
if (totalTasksEl) totalTasksEl.textContent = totalTasks;
if (completedTasksEl)
  completedTasksEl.textContent = `${completedTasks} (${completionPercentage}%)`;

let velocity = ((completedTasks + inProgressTasks * 0.5) / 2);
if (velocityEl) velocityEl.textContent = velocity.toFixed(1);


// ================== AN√ÅLISIS DEL PROYECTO ==================
const analysisDiv = modal.querySelector('#projectAnalysis');
if (analysisDiv) {
  analysisDiv.innerHTML = getProjectAnalysisText(
    tasks,
    completionPercentage,
    velocity
  );
}



  overlay.appendChild(modal);
  // Agregar al contenedor del Gantt, NO al body
  ganttContainer.appendChild(overlay);
  

// ‚è±Ô∏è Esperar a que el DOM del modal est√© listo
setTimeout(() => {
  console.log('üéØ DOM del Burndown listo, renderizando gr√°fico...');

  const burndownData = calculateBurndownForRenderer(tasks);

if (!burndownData) {
  console.warn('‚ö†Ô∏è Burndown vac√≠o');
  return;
}

renderBurndownChartPremium(burndownData);

}, 0);




  // Funci√≥n para cerrar el modal
window.closeBurndownModal = function() {
  console.log('üîí Cerrando modal de Burndown y volviendo al Gantt Ejecutivo...');

  console.log('üß™ Instancia al cerrar:', window.burndownChartInstance);

  // ‚úÖ PASO 1: destruir instancia Chart.js
  if (window.burndownChartInstance) {
    console.log('üßπ Destruyendo instancia burndown');
    window.burndownChartInstance.destroy();
    window.burndownChartInstance = null;
  } else {
    console.log('‚ÑπÔ∏è No hab√≠a instancia burndown activa');
  }

  // ‚úÖ PASO 2: eliminar solo el overlay del burndown
  const overlay = document.querySelector('.executive-overlay');
  if (overlay) {
    console.log('üóëÔ∏è Eliminando overlay del burndown');
    overlay.remove();
  }

  // ‚úÖ PASO 3: VERIFICAR QUE EL GANTT EJECUTIVO SIGUE VISIBLE
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) {
    console.warn('‚ö†Ô∏è No se encontr√≥ el Gantt Ejecutivo');
    return;
  }

  console.log('‚úÖ Gantt Ejecutivo sigue activo');
  ganttContainer.style.display = 'flex';

  console.log('‚úÖ Modal de Burndown cerrado correctamente, volviendo al Gantt Ejecutivo');
};
  
  // Funci√≥n para exportar Burndown Premium (CORREGIDA)
window.exportBurndownChartPremium = function () {
  const chart = window.burndownChartInstance;

  if (!chart) {
    alert('‚ö†Ô∏è No hay gr√°fico para exportar');
    return;
  }

  const link = document.createElement('a');
  const project = window.projectName || 'proyecto';

  link.download = `burndown-${project}-${new Date().toISOString().slice(0, 10)}.png`;
  link.href = chart.toBase64Image('image/png', 1);
  link.click();

  alert('üì• Gr√°fico exportado como PNG');
};

  
  window.generateBurndownReport = function () {
  const project = projects[currentProjectIndex];
  if (!project) {
    alert('No hay proyecto activo');
    return;
  }

  const health = calculateProjectHealth(project.tasks, project);

  const completed = project.tasks.filter(t => t.status === 'completed').length;
  const total = project.tasks.length;

  const timelineItems = [];
  project.tasks.forEach(task => {
    (task.history || []).forEach(h => {
      timelineItems.push({
        date: new Date(h.date).toLocaleString(),
        task: task.name,
        change: `${h.from} ‚Üí ${h.to}`
      });
    });
  });

  const reportHTML = `
  <html>
    <head>
      <title>Reporte del Proyecto</title>
      <style>
        body {
          font-family: Arial, sans-serif;
          padding: 40px;
          color: #111;
        }
        h1, h2 {
          border-bottom: 2px solid #ddd;
          padding-bottom: 6px;
        }
        .badge {
          display: inline-block;
          padding: 6px 12px;
          border-radius: 8px;
          font-weight: bold;
          background: ${
            health.status === 'green' ? '#d1fae5' :
            health.status === 'yellow' ? '#fef3c7' :
            '#fee2e2'
          };
          color: #111;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 10px;
        }
        th, td {
          border: 1px solid #ccc;
          padding: 8px;
          font-size: 13px;
          text-align: left;
        }
        th {
          background: #f3f4f6;
        }
      </style>
    </head>
    <body>

      <h1>üìÑ Reporte Ejecutivo del Proyecto</h1>

      <h2>Informaci√≥n General</h2>
      <p><strong>Proyecto:</strong> ${project.name || 'Sin nombre'}</p>
      <p><strong>Fecha del reporte:</strong> ${new Date().toLocaleString()}</p>

      <h2>Salud del Proyecto</h2>
      <span class="badge">${health.label}</span>
      <ul>
        ${health.reasons.map(r => `<li>${r}</li>`).join('')}
      </ul>

      <h2>M√©tricas</h2>
      <ul>
        <li><strong>Tareas totales:</strong> ${total}</li>
        <li><strong>Tareas completadas:</strong> ${completed}</li>
        <li><strong>Avance:</strong> ${Math.round((completed / total) * 100)}%</li>
      </ul>

      <h2>Auditor√≠a del Proyecto</h2>
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Tarea</th>
            <th>Cambio</th>
          </tr>
        </thead>
        <tbody>
          ${timelineItems.map(i => `
            <tr>
              <td>${i.date}</td>
              <td>${i.task}</td>
              <td>${i.change}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>

      <p style="margin-top:40px;font-size:12px;color:#555;">
        Reporte generado autom√°ticamente por el sistema.
      </p>

    </body>
  </html>
  `;

  const win = window.open('', '_blank');
  win.document.write(reportHTML);
  win.document.close();
};


  
  setTimeout(() => {
  const project = projects[currentProjectIndex];
  if (!project) return;

  const burndownData = calculateBurndownForRenderer(project.tasks);
  if (!burndownData) return;

  renderBurndownChartPremium(burndownData);
  renderProjectTimeline(project.tasks);
  renderProjectHealth(project.tasks, project);
}, 0);

  
  console.log('‚úÖ Modal de Burndown creado exitosamente DENTRO del Gantt');
};



console.log('üü° SCRIPT LLEGA HASTA AQU√ç');


  
function renderBurndownChartPremium(data) {
  try {
    // ===============================
    // ‚ôªÔ∏è ACTUALIZAR SI YA EXISTE
    // ===============================
    if (window.burndownChartInstance) {
      window.burndownChartInstance.data.labels = [...data.semanas];
      window.burndownChartInstance.data.datasets = [];

      // L√≠nea Ideal
      window.burndownChartInstance.data.datasets.push({
        label: 'L√≠nea Ideal',
        data: data.trabajoIdeal,
        borderColor: '#2ecc71',
        borderWidth: 3,
        fill: false,
        tension: 0.1,
        pointRadius: 0
      });

      // Progreso Real
      window.burndownChartInstance.data.datasets.push({
        label: 'Progreso Real',
        data: data.trabajoReal,
        borderColor: '#f39c12',
        borderWidth: 3,
        fill: false,
        tension: 0,
        pointRadius: 4
      });

      // Proyecci√≥n + Optimista + Pesimista
      agregarProyeccionBurndown(
        data,
        window.burndownChartInstance.data.labels,
        window.burndownChartInstance.data.datasets
      );

      window.burndownChartInstance.update();
      return;
    }

    // ===============================
    // üÜï CREAR POR PRIMERA VEZ
    // ===============================
    const canvas = document.getElementById('burndownChartCanvasPremium');
    if (!canvas) {
      console.error('‚ùå Canvas burndown no encontrado');
      return;
    }

    const ctx = canvas.getContext('2d');
    const labels = [...data.semanas];
    const datasets = [];

    // L√≠nea Ideal
    datasets.push({
      label: 'L√≠nea Ideal',
      data: data.trabajoIdeal,
      borderColor: '#2ecc71',
      borderWidth: 3,
      fill: false,
      tension: 0.1,
      pointRadius: 0
    });

    // Progreso Real
    datasets.push({
      label: 'Progreso Real',
      data: data.trabajoReal,
      borderColor: '#f39c12',
      borderWidth: 3,
      fill: false,
      tension: 0,
      pointRadius: 4
    });

    // Proyecci√≥n + Optimista + Pesimista
    agregarProyeccionBurndown(data, labels, datasets);



// ===============================
// üß† MENSAJE INTELIGENTE BURNDOWN (PASO 4.2)
// ===============================
try {
  const evaluation = evaluarEstadoBurndown(data);

  let messageBox = document.getElementById('burndownMessage');

  if (!messageBox) {
    messageBox = document.createElement('div');
    messageBox.id = 'burndownMessage';

    // estilos base (no layout)
    messageBox.style.padding = '10px 14px';
    messageBox.style.marginBottom = '8px';
    messageBox.style.borderRadius = '6px';
    messageBox.style.fontSize = '14px';
    messageBox.style.fontWeight = '600';
    messageBox.style.textAlign = 'center';
    messageBox.style.color = '#fff';

    const parent = document
      .getElementById('burndownChartCanvasPremium')
      ?.parentElement;

    if (parent) parent.prepend(messageBox);
  }

  // üé® colores seg√∫n estado
  const colors = {
    success: '#2ecc71',
    warning: '#f1c40f',
    danger: '#e74c3c'
  };

  messageBox.style.background = colors[evaluation.status] || '#3498db';
  messageBox.textContent = `${evaluation.icon} ${evaluation.message}`;

} catch (err) {
  console.error('‚ùå Error mostrando mensaje burndown:', err);
}






    // ===============================
    // üìä CREAR CHART
    // ===============================
    window.burndownChartInstance = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            labels: {
              color: '#ecf0f1',
              font: { size: 12 }
            }
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: 'Semanas',
              color: '#bdc3c7',
              font: { size: 12, weight: '600' }
            },
            ticks: { color: '#bdc3c7' }
          },
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Story Points Restantes',
              color: '#bdc3c7',
              font: { size: 12, weight: '600' }
            },
            ticks: { color: '#bdc3c7' }
          }
        }
      }
    });



// ===============================
// ‚òëÔ∏è CONTROLES VISUALES BURNDOWN
// ===============================
(function crearControlesBurndown() {
  const chart = window.burndownChartInstance;
  if (!chart) return;

  const parent = chart.canvas.parentElement;
  if (!parent) return;

  // evitar duplicados
  if (document.getElementById('burndownControls')) return;

  const controls = document.createElement('div');
  controls.id = 'burndownControls';

  controls.style.display = 'flex';
  controls.style.flexWrap = 'wrap';
  controls.style.gap = '12px';
  controls.style.marginBottom = '8px';
  controls.style.fontSize = '12px';
  controls.style.color = '#ecf0f1';

  chart.data.datasets.forEach((ds, index) => {
    const label = document.createElement('label');
    label.style.display = 'flex';
    label.style.alignItems = 'center';
    label.style.gap = '4px';
    label.style.cursor = 'pointer';

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = true;
    checkbox.dataset.index = index;

    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(ds.label));

    controls.appendChild(label);
  });

  parent.prepend(controls);

  console.log('‚úÖ Checkboxes Burndown creados');
})();


// ===============================
// üéõÔ∏è INTERACCI√ìN CHECKBOXES
// ===============================
(function activarInteraccionBurndown() {
  const chart = window.burndownChartInstance;
  if (!chart) return;

  const controls = document.getElementById('burndownControls');
  if (!controls) return;

  controls.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', () => {
      const index = Number(cb.dataset.index);

      if (!chart.data.datasets[index]) return;

      chart.data.datasets[index].hidden = !cb.checked;
      chart.update();
    });
  });

  console.log('üéØ Interacci√≥n de checkboxes activada');
})();


// ===============================
// ‚ú® INTERACCI√ìN VISUAL (HOVER)
// ===============================
(function activarHoverVisualBurndown() {
  const chart = window.burndownChartInstance;
  if (!chart) return;

  const originalStyles = chart.data.datasets.map(ds => ({
    borderWidth: ds.borderWidth,
    opacity: ds.opacity ?? 1
  }));

  function resaltarDataset(index) {
    chart.data.datasets.forEach((ds, i) => {
      if (i === index) {
        ds.borderWidth = 4;
        ds.opacity = 1;
      } else {
        ds.borderWidth = 2;
        ds.opacity = 0.2;
      }
    });
    chart.update('none');
  }

  function restaurarEstilo() {
    chart.data.datasets.forEach((ds, i) => {
      ds.borderWidth = originalStyles[i].borderWidth;
      ds.opacity = originalStyles[i].opacity;
    });
    chart.update('none');
  }

  // üéØ Hover en checkboxes
  const controls = document.getElementById('burndownControls');
  if (controls) {
    controls.querySelectorAll('label').forEach((label, index) => {
      label.addEventListener('mouseenter', () => resaltarDataset(index));
      label.addEventListener('mouseleave', restaurarEstilo);
    });
  }

  // üéØ Hover directo en el chart
  chart.options.onHover = (event, activeElements) => {
    if (activeElements.length > 0) {
      const index = activeElements[0].datasetIndex;
      resaltarDataset(index);
    } else {
      restaurarEstilo();
    }
  };

  chart.update();

  console.log('‚ú® Interacci√≥n visual burndown activada');
})();






    // ===============================
    // üß± AJUSTE DEFINITIVO DE LAYOUT
    // ===============================
    const parent = canvas.parentElement;

    if (parent) {
      // Canvas
      canvas.style.height = '260px';
      canvas.style.maxHeight = '260px';
      canvas.style.width = '100%';
      canvas.style.flexShrink = '0';

      // Contenedor
      parent.style.height = 'auto';
      parent.style.minHeight = '420px';
      parent.style.display = 'flex';
      parent.style.flexDirection = 'column';
      parent.style.alignItems = 'stretch';
      parent.style.overflow = 'hidden';
    }

    console.log('‚úÖ Burndown Premium renderizado correctamente');
  } catch (err) {
    console.error('‚ùå Error en renderBurndownChartPremium:', err);
  }
}
















function agregarProyeccionBurndown(data, labels, datasets) {
  try {
    const remainingSP = Number(data.remainingPoints);
    const burnedSP = Number(data.burnedStoryPoints);
    const weeksElapsed = Math.max(1, data.trabajoReal.length - 1);

    const velocity = burnedSP / weeksElapsed;
    if (remainingSP <= 0 || velocity <= 0) return;

    /* ===============================
       üîÆ PROYECCI√ìN BASE
    =============================== */
    const forecast = new Array(data.trabajoReal.length).fill(null);
    forecast[data.trabajoReal.length - 1] = remainingSP;

    let current = remainingSP;
    let step = 1;

    while (current > 0) {
      current = Math.max(0, current - velocity);
      forecast.push(Number(current.toFixed(2)));
      labels.push(`+${step}`);
      step++;
    }

    datasets.push({
      label: 'Proyecci√≥n',
      data: forecast,
      borderColor: '#e67e22',
      borderWidth: 3,
      borderDash: [6, 6],
      fill: false,
      tension: 0,
      pointRadius: 4,
      spanGaps: true
    });

    /* ===============================
       üåü PROYECCI√ìN OPTIMISTA (+25%)
    =============================== */
    const optimisticVelocity = velocity * 1.25;
    if (optimisticVelocity > 0) {
      const optimistic = new Array(data.trabajoReal.length).fill(null);
      optimistic[data.trabajoReal.length - 1] = remainingSP;

      let currentOpt = remainingSP;
      while (currentOpt > 0) {
        currentOpt = Math.max(0, currentOpt - optimisticVelocity);
        optimistic.push(Number(currentOpt.toFixed(2)));
      }

      datasets.push({
        label: 'Optimista',
        data: optimistic,
        borderColor: '#2ecc71',
        borderWidth: 2,
        borderDash: [4, 4],
        fill: false,
        tension: 0,
        pointRadius: 3,
        spanGaps: true
      });
    }

    /* ===============================
       üî¥ PROYECCI√ìN PESIMISTA (-25%)
    =============================== */
    const pessimisticVelocity = velocity * 0.75;
    if (pessimisticVelocity > 0) {
      const pessimistic = new Array(data.trabajoReal.length).fill(null);
      pessimistic[data.trabajoReal.length - 1] = remainingSP;

      let currentPes = remainingSP;
      while (currentPes > 0) {
        currentPes = Math.max(0, currentPes - pessimisticVelocity);
        pessimistic.push(Number(currentPes.toFixed(2)));
      }

      datasets.push({
        label: 'Pesimista',
        data: pessimistic,
        borderColor: '#e74c3c',
        borderWidth: 2,
        borderDash: [4, 4],
        fill: false,
        tension: 0,
        pointRadius: 3,
        spanGaps: true
      });
    }

    console.log('üîÆ Proyecciones agregadas correctamente');

  } catch (err) {
    console.error('‚ùå Error en proyecci√≥n burndown:', err);
  }
/* ===============================
   üé® BANDA DE CONFIANZA (JIRA STYLE)
=============================== */
datasets.push(
  {
    label: 'Banda Superior',
    data: datasets.find(d => d.label === 'Optimista')?.data || [],
    borderColor: 'transparent',
    backgroundColor: 'rgba(52, 152, 219, 0.15)', // azul suave
    pointRadius: 0,
    fill: false
  },
  {
    label: 'Banda Inferior',
    data: datasets.find(d => d.label === 'Pesimista')?.data || [],
    borderColor: 'transparent',
    backgroundColor: 'rgba(52, 152, 219, 0.15)', // azul suave
    pointRadius: 0,
    fill: '-1'
  }
);


// ===============================
// üß† MENSAJE INTELIGENTE BURNDOWN
// ===============================
try {
  const evaluation = evaluarEstadoBurndown(data);
  const { status, icon, message } = evaluation;

  let messageBox = document.getElementById('burndownMessage');

  // üÜï Crear contenedor si no existe
  if (!messageBox) {
    messageBox = document.createElement('div');
    messageBox.id = 'burndownMessage';

    // üìê Estilos base (posici√≥n y forma)
    messageBox.style.padding = '12px 16px';
    messageBox.style.marginBottom = '14px';
    messageBox.style.borderRadius = '8px';
    messageBox.style.fontSize = '14px';
    messageBox.style.fontWeight = '600';
    messageBox.style.textAlign = 'center';
    messageBox.style.lineHeight = '1.4';
    messageBox.style.boxShadow = '0 4px 10px rgba(0,0,0,0.15)';
    messageBox.style.position = 'relative';
    messageBox.style.zIndex = '5';

    const container =
      document.getElementById('burndownChartCanvasPremium')?.parentElement;

    if (container) {
      container.prepend(messageBox); // ‚¨ÜÔ∏è aparece ARRIBA del gr√°fico
    }
  }

  // üìù Texto
  messageBox.textContent = `${icon} ${message}`;

  // üé® Colores seg√∫n estado
  switch (status) {
    case 'success':
      messageBox.style.background = '#2ecc71'; // verde
      messageBox.style.color = '#ffffff';
      messageBox.style.borderLeft = '6px solid #27ae60';
      break;

    case 'warning':
      messageBox.style.background = '#f1c40f'; // amarillo
      messageBox.style.color = '#2c3e50';
      messageBox.style.borderLeft = '6px solid #f39c12';
      break;

    case 'danger':
      messageBox.style.background = '#e74c3c'; 
      messageBox.style.color = '#ffffff';
      messageBox.style.borderLeft = '6px solid #e74c3c'; // rojo alerta
      break;

    default:
      messageBox.style.background = '#34495e';
      messageBox.style.color = '#ffffff';
      messageBox.style.borderLeft = '6px solid #7f8c8d';
  }

} catch (err) {
  console.error('‚ùå Error mostrando mensaje burndown:', err);
}

// ===============================
// ‚è≥ MENSAJE PREDICTIVO DE TIEMPO
// ===============================
try {
  const remainingSP = Number(data.remainingPoints);
  const burnedSP = Number(data.burnedStoryPoints);
  const weeksElapsed = Math.max(1, data.trabajoReal.length - 1);
  const velocity = burnedSP / weeksElapsed;

  if (remainingSP <= 0 || velocity <= 0) return;

  const weeksToFinish = remainingSP / velocity;

  let forecastBox = document.getElementById('burndownForecast');

  if (!forecastBox) {
    forecastBox = document.createElement('div');
    forecastBox.id = 'burndownForecast';

    forecastBox.style.padding = '8px 14px';
    forecastBox.style.marginBottom = '12px';
    forecastBox.style.borderRadius = '6px';
    forecastBox.style.fontSize = '13px';
    forecastBox.style.textAlign = 'center';
    forecastBox.style.background = 'rgba(52, 152, 219, 0.15)';
    forecastBox.style.color = '#ecf0f1';
    forecastBox.style.fontWeight = '500';

    const container =
      document.getElementById('burndownChartCanvasPremium')?.parentElement;

    if (container) {
      container.insertBefore(
        forecastBox,
        container.children[1] || null
      );
    }
  }

  let forecastText = '';

  if (weeksToFinish <= 1) {
    forecastText = `üöÄ A este ritmo, el sprint finalizar√° en ~${weeksToFinish.toFixed(1)} semana`;
  } else {
    forecastText = `‚è≥ Con la velocidad actual, el sprint tardar√° ~${weeksToFinish.toFixed(1)} semanas`;
  }

  forecastBox.textContent = forecastText;

} catch (err) {
  console.error('‚ùå Error en mensaje predictivo:', err);
}


}












// Funci√≥n para an√°lisis del proyecto
function getProjectAnalysisText(tasks, completionPercentage, velocity) {
  const safeVelocity = Number(velocity) || 0;
  const totalTasks = tasks.length;
  const criticalTasks = tasks.filter(t => t.priority === 'alta' || t.status === 'overdue').length;
  const overdueTasks = tasks.filter(t => t.status === 'overdue').length;
  
  let analysis = `<p>El proyecto est√° avanzando. Basado en las m√©tricas actuales:</p>`;
  
  if (completionPercentage >= 80) {
    analysis += `<ul style="margin: 15px 0; padding-left: 20px;">
      <li style="margin-bottom: 8px;">‚úÖ <strong>Excelente progreso:</strong> ${completionPercentage}% completado</li>
      <li style="margin-bottom: 8px;">üìÖ <strong>Velocidad sostenible:</strong> ${safeVelocity.toFixed(1)
} tareas/semana</li>
      <li style="margin-bottom: 8px;">üìà <strong>En camino:</strong> El proyecto va por buen camino</li>
    </ul>`;
  } else if (completionPercentage >= 50) {
    analysis += `<ul style="margin: 15px 0; padding-left: 20px;">
      <li style="margin-bottom: 8px;">üü° <strong>Progreso moderado:</strong> ${completionPercentage}% completado</li>
      <li style="margin-bottom: 8px;">üìÖ <strong>Atenci√≥n requerida:</strong> ${criticalTasks} tareas cr√≠ticas</li>
      <li style="margin-bottom: 8px;">üìà <strong>Velocidad aceptable:</strong> ${safeVelocity.toFixed(1)
} tareas/semana</li>
    </ul>`;
  } else {
    analysis += `<ul style="margin: 15px 0; padding-left: 20px;">
      <li style="margin-bottom: 8px;">üî¥ <strong>Progreso lento:</strong> Solo ${completionPercentage}% completado</li>
      <li style="margin-bottom: 8px;">‚ö†Ô∏è <strong>Atenci√≥n urgente:</strong> ${criticalTasks} tareas cr√≠ticas, ${overdueTasks} atrasadas</li>
      <li style="margin-bottom: 8px;">üìâ <strong>Velocidad baja:</strong> ${safeVelocity.toFixed(1)
} tareas/semana</li>
    </ul>`;
  }
  
  analysis += `<p><strong>Recomendaci√≥n:</strong> ${getRecommendation(completionPercentage, criticalTasks, velocity)}</p>`;
  
  return analysis;
}

function getRecommendation(completionPercentage, criticalTasks, velocity) {
  if (completionPercentage >= 80) {
    return "Mantener el ritmo actual. Considerar completar tareas cr√≠ticas primero.";
  } else if (completionPercentage >= 50) {
    return "Priorizar tareas cr√≠ticas y revisar asignaciones de recursos.";
  } else {
    return "Revisar cronograma, posiblemente extender plazo o reducir alcance.";
  }
}

// Funci√≥n para reintentar
window.retryBurndownChart = function() {
  console.log('üîÑ Reintentando cargar gr√°fico...');
  loadBurndownDataAndRender();
};








// ========== FUNCI√ìN VALOR GANADO (EVM) COMPLETA ==========
function crearDashboardEVMCompleto() {

  const mode = window.__EVM_MODE__ || 'hours';
  const unit = mode === 'costs' ? '$' : 'h';

  console.log('üöÄ CREANDO DASHBOARD VALOR GANADO...');
  console.log('üìå Modo EVM activo:', mode);
  
  // Eliminar dashboard anterior si existe
  const evmAnterior = document.getElementById('dashboard-evm-premium');
  if (evmAnterior) evmAnterior.remove();
  
  // Obtener el contenedor del Gantt premium
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) {
    alert('‚ùå Por favor, abre el Gantt Ejecutivo primero');
    return;
  }
  
  // Crear overlay DENTRO del contenedor del Gantt
  const overlay = document.createElement('div');
  overlay.id = 'dashboard-evm-premium';
  overlay.style.cssText = `
    position: absolute; /* Cambiado de fixed a absolute */
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    z-index: 1000000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  `;
  
  // Crear contenido del dashboard EVM
  overlay.innerHTML = `
    <div style="
      width: 90vw;
      height: 85vh;
      background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
      border-radius: 24px;
      box-shadow: 0 40px 80px rgba(0,0,0,0.8);
      border: 2px solid rgba(139, 92, 246, 0.4);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    ">
      <!-- Header -->
      <div style="
        background: linear-gradient(90deg, #0a0a1a, #1a1a3a);
        padding: 25px 35px;
        border-bottom: 1px solid rgba(139, 92, 246, 0.3);
        display: flex;
        justify-content: space-between;
        align-items: center;
      ">
        <div></div>


<!-- T√çTULO + SUBT√çTULO CENTRADOS -->
  <div style="text-align: center;">
    <h2 style="
      margin: 0 0 6px 0;
      color: white;
      font-size: 28px;
      font-weight: 700;
    ">
          <h2 style="margin: 0 0 8px 0; color: white; font-size: 28px;">
            üìà <span style="color: #8b5cf6;">EARNED VALUE MANAGEMENT (EVM)</span>
</h2>
          <p style="
  margin: 0;
  color: #95a5a6;
  font-size: 14px;
  text-align: center;
">
  Sistema de Valor Ganado ‚Ä¢ Gesti√≥n de Costos y Tiempo ‚Ä¢ Actualizado: ${new Date().toLocaleTimeString()}
</p>

<p id="evmProjectName" style="
  margin: 6px 0 0 0;
  color: #c4b5fd;
  font-size: 15px;
  font-weight: 600;
  text-align: center;
">
</p>


<!-- SEM√ÅFORO EVM -->
<div id="evmStatusBanner" style="
  margin: 10px 30px 25px 30px;
  padding: 14px 18px;

  width: 520px;
  min-height: 52px;

  border-radius: 12px;
  display: flex;
  align-items: center;

  font-size: 16px;
  font-weight: 600;

  background: rgba(148, 163, 184, 0.15);
  border: 2px solid rgba(148, 163, 184, 0.4);
  color: #cbd5f5;
">
  Evaluando estado del proyecto...
</div>
         

        </div>





        <button onclick="closeEVMModal()" style="
          background: rgba(231, 76, 60, 0.2);
          border: 1px solid #e74c3c;
          color: #e74c3c;
          padding: 12px 25px;
          border-radius: 8px;
          cursor: pointer;
          font-weight: bold;
          font-size: 14px;
        ">
          √ó Cerrar
        </button>
      </div>
      
      <!-- Contenido principal -->
      <div style="flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 25px;">
        
        <!-- M√©tricas principales -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
          <div style="
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
          ">
            <div style="color: #93c5fd; font-size: 14px; margin-bottom: 8px;">VALOR PLANIFICADO (PV)</div>
            <div style="color: white; font-size: 32px; font-weight: bold;" id="pvValue"></div>
            <div style="color: #93c5fd; font-size: 12px; margin-top: 8px;">Planeado para esta fecha</div>
          </div>
          
          <div style="
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid rgba(16, 185, 129, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
          ">
            <div style="color: #a7f3d0; font-size: 14px; margin-bottom: 8px;">VALOR GANADO (EV)</div>
            <div style="color: white; font-size: 32px; font-weight: bold;" id="evValue"></div>
            <div style="color: #a7f3d0; font-size: 12px; margin-top: 8px;">Trabajo realmente completado</div>
          </div>
          
          <div style="
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid rgba(239, 68, 68, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
          ">
            <div style="color: #fca5a5; font-size: 14px; margin-bottom: 8px;">COSTO REAL (AC)</div>
            <div style="color: white; font-size: 32px; font-weight: bold;" id="acValue"></div>
            <div style="color: #fca5a5; font-size: 12px; margin-top: 8px;">Costo realmente incurrido</div>
          </div>
          
          <div style="
            background: rgba(245, 158, 11, 0.1);
            border: 2px solid rgba(245, 158, 11, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
          ">
            <div style="color: #fde68a; font-size: 14px; margin-bottom: 8px;">BAC</div>
            <div style="color: white; font-size: 32px; font-weight: bold;" id="bacValue"></div>
            <div style="color: #fde68a; font-size: 12px; margin-top: 8px;">Presupuesto al Termino</div>
          </div>
        </div>
        
        <!-- Indicadores de desempe√±o -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
          <div style="
            background: rgba(26, 31, 60, 0.8);
            border-radius: 18px;
            padding: 25px;
            border: 2px solid rgba(255,255,255,0.15);
          ">
            <h3 style="color: white; margin: 0 0 20px 0; font-size: 20px;">üìä INDICADORES DE DESEMPE√ëO</h3>
            





            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <div style="
                background: rgba(239, 68, 68, 0.1);
                border-left: 5px solid #ef4444;
                border-radius: 12px;
                padding: 20px;
              ">
                <div style="color: #fca5a5; font-size: 14px; margin-bottom: 5px;">CPI</div>
                <div style="color: white; font-size: 42px; font-weight: bold;" id="cpiValue"></div>
                <div style="color: #fca5a5; font-size: 13px; margin-top: 8px;">
           
                </div>
              </div>
              
              <div style="
                background: rgba(245, 158, 11, 0.1);
                border-left: 5px solid #f59e0b;
                border-radius: 12px;
                padding: 20px;
              ">
                <div style="color: #fde68a; font-size: 14px; margin-bottom: 5px;">SPI</div>
                <div style="color: white; font-size: 42px; font-weight: bold;" id="spiValue"></div>
                <div style="color: #fde68a; font-size: 13px; margin-top: 8px;">
              
                </div>
              </div>
            </div>


            <!-- INTERPRETACI√ìN DE INDICADORES -->
            <div style="
              margin-top: 25px;
              padding: 20px;
              background: rgba(30, 41, 59, 0.6);
              border-radius: 12px;
              border: 1px solid rgba(255,255,255,0.1);
              border-left: 5px solid #3498db;
            ">
              <div style="
                color: #fde68a;
                font-weight: 600;
                margin-bottom: 12px;
                font-size: 15px;
                display: flex;
                align-items: center;
                gap: 8px;
              ">
                üìù Interpretaci√≥n de indicadores
              </div>
              <div style="color: #cbd5e1; font-size: 13px; line-height: 1.5;">
                <!-- CPI -->
                <div style="margin-bottom: 10px;">
                  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <div style="width: 12px; height: 12px; background: #2ecc71; border-radius: 50%; flex-shrink: 0;"></div>
                    <div style="color: #a7f3d0; font-weight: 500;">CPI ‚â• 1.0</div>
                  </div>
                  <div style="color: #cbd5e1; padding-left: 22px; margin-bottom: 8px;">
                    Uso eficiente del presupuesto (gastando menos de lo planeado)
                  </div>
                  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <div style="width: 12px; height: 12px; background: #ef4444; border-radius: 50%; flex-shrink: 0;"></div>
                    <div style="color: #fca5a5; font-weight: 500;">CPI < 1.0</div>
                  </div>
                  <div style="color: #cbd5e1; padding-left: 22px;">
                    Sobrecosto (gastando m√°s de lo planeado)
                  </div>
                </div>
                
                <!-- SPI -->
                <div style="margin-bottom: 10px;">
                  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <div style="width: 12px; height: 12px; background: #3498db; border-radius: 50%; flex-shrink: 0;"></div>
                    <div style="color: #93c5fd; font-weight: 500;">SPI ‚â• 1.0</div>
                  </div>
                  <div style="color: #cbd5e1; padding-left: 22px; margin-bottom: 8px;">
                    Adelantado o conforme al cronograma
                  </div>
                  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                    <div style="width: 12px; height: 12px; background: #f59e0b; border-radius: 50%; flex-shrink: 0;"></div>
                    <div style="color: #fde68a; font-weight: 500;">SPI < 1.0</div>
                  </div>
                  <div style="color: #cbd5e1; padding-left: 22px;">
                    Atrasado respecto al cronograma
                  </div>
                </div>
                
                <!-- Resumen -->
                <div style="
                  margin-top: 15px;
                  padding-top: 15px;
                  border-top: 1px solid rgba(255,255,255,0.1);
                  color: #94a3b8;
                  font-size: 12px;
                  font-style: italic;
                ">
                  üìå Ideal: Ambos indicadores ‚â• 1.0 | Alerta si alg√∫n indicador < 1.0
                </div>
              </div>
            </div>




          </div>
          
          <div style="
            background: rgba(26, 31, 60, 0.8);
            border-radius: 18px;
            padding: 25px;
            border: 2px solid rgba(255,255,255,0.15);
          ">
            <h3 style="color: white; margin: 0 0 20px 0; font-size: 20px;">‚ö†Ô∏è VARIANZAS</h3>
            
            <div style="display: flex; flex-direction: column; gap: 25px;">
             <div style="text-align: center;">
                <div style="color: #fca5a5; font-size: 16px; margin-bottom: 5px;">VARIANZA DE COSTO (CV)</div>
                <div style="color: #ef4444; font-size: 36px; font-weight: bold;" id="cvValue"></div>
                <div style="color: #fca5a5; font-size: 13px;">
                
                </div>
              </div>
              
              <div style="text-align: center;">
                <div style="color: #fde68a; font-size: 16px; margin-bottom: 5px;">VARIANZA DE TIEMPO (SV)</div>
                <div style="color: #f59e0b; font-size: 36px; font-weight: bold;" id="svValue"></div>
                <div style="color: #fde68a; font-size: 13px;">
   
 

          <!-- ESPACIO AGREGADO AQU√ç -->
          <div style="height: 30px;"></div>
      



           
<!-- üîÆ PRON√ìSTICO DEL PROYECTO -->
<div id="evmForecastSection" style="
  background: rgba(139, 92, 246, 0.08);
  border: 2px solid rgba(139, 92, 246, 0.35);
  border-radius: 18px;
  padding: 25px;
">
  <h3 style="color: white; margin: 0 0 20px 0; font-size: 20px;">
    üîÆ PRON√ìSTICO DEL PROYECTO
  </h3>

  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
    <div>
      <div style="color:#c4b5fd;font-size:13px;">EAC</div>
      <div id="eacValue" style="font-size:32px;color:white;font-weight:bold;">‚Äî</div>
      <div style="font-size:12px;color:#c4b5fd;">Horas al finalizar</div>
    </div>

    <div>
      <div style="color:#c4b5fd;font-size:13px;">ETC</div>
      <div id="etcValue" style="font-size:32px;color:white;font-weight:bold;">‚Äî</div>
      <div style="font-size:12px;color:#c4b5fd;">Horas restantes</div>
    </div>

    <div>
      <div style="color:#c4b5fd;font-size:13px;">VAC</div>
      <div id="vacValue" style="font-size:32px;color:white;font-weight:bold;">‚Äî</div>
      <div style="font-size:12px;color:#c4b5fd;">Variaci√≥n final</div>
    </div>
  </div>

  <div id="forecastNarrative" style="
    margin-top: 18px;
    color: #e5e7eb;
    font-size: 14px;
    line-height: 1.6;
  ">
    Calculando pron√≥stico...
  </div>
</div>



                </div>
              </div>
            </div>
          </div>
        </div>
        






        <!-- Gr√°fico EVM -->
<div style="
  background: rgba(26, 31, 60, 0.8);
  border-radius: 18px;
  padding: 25px;
  border: 2px solid rgba(255,255,255,0.15);
  flex: 1;
">

  <h3 style="color: white; margin: 0 0 20px 0; font-size: 20px;">
    üìà GR√ÅFICO DE VALOR GANADO
  </h3>

  <!-- Contenedor del gr√°fico -->
  <div style="min-height: 320px; position: relative;">
    <canvas id="evmChartCanvas" style="width: 100%; height: 100%;"></canvas>
  </div>
</div>

<!-- Recomendaciones -->
<div style="
  background: rgba(46, 204, 113, 0.1);
  border: 2px solid rgba(46, 204, 113, 0.3);
  border-radius: 18px;
  padding: 25px;
">
  <h3 style="color: white; margin: 0 0 20px 0; font-size: 20px;">
    ‚úÖ RECOMENDACIONES
  </h3>
  <div id="evmRecommendations" style="color: #95a5a6; font-size: 14px; line-height: 1.6;">
    <ul style="margin: 0; padding-left: 20px;">
      <li style="margin-bottom: 10px;">Cargando recomendaciones...</li>
    </ul>
  </div>
</div>

      <!-- Footer -->
      <div style="
        background: rgba(255,255,255,0.03);
        border-top: 1px solid rgba(255,255,255,0.1);
        padding: 15px 35px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #95a5a6;
        font-size: 13px;
      ">
        <div>
          <span>üìä M√©tricas calculadas autom√°ticamente ‚Ä¢ Sistema EVM</span>
        </div>
        <div style="display: flex; gap: 15px;">
          <button onclick="exportEVMReport()" style="
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid #3498db;
            color: #3498db;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
          ">
            üì• Exportar Reporte
          </button>
          <button onclick="showEVMForecast()" style="
            background: rgba(155, 89, 182, 0.2);
            border: 1px solid #9b59b6;
            color: #9b59b6;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
          ">
            üîÆ Pron√≥stico EAC
          </button>
        </div>
      </div>
    </div>
  `;
  
  // Agregar al contenedor del Gantt, no al body
  ganttContainer.appendChild(overlay);
  


// ===============================
// üìå Mostrar nombre del proyecto
// ===============================
const projectNameEl = document.getElementById('evmProjectName');

if (projectNameEl && projects && projects[currentProjectIndex]) {
  projectNameEl.textContent = `Proyecto: ${projects[currentProjectIndex].name}`;
}





requestAnimationFrame(() => {
  loadEVMDataAndRender();
});



  // Configurar funciones de cierre y utilidades
// Configurar funciones de cierre y utilidades
setupEVMFunctions(ganttContainer);

// üî• VARIABLE SEGURA (NO const, NO colisi√≥n)
const evmMode = window.__EVM_MODE__ || 'hours';

console.log('‚úÖ Dashboard EVM creado exitosamente DENTRO del Gantt');
console.log('üìå Modo EVM activo:', evmMode);

if (evmMode === 'costs') {
  console.log('üí∞ Dashboard EVM usando DATOS DE COSTOS');

  const evm = window.lastEVMPreviewData;
  if (!evm) return;

  renderEVMKPIs(evm);
  renderEVMSemaphore(evm);

  setTimeout(() => {
    renderEVMChart(evm);

    // üî• AQU√ç MISMO
    renderEVMForecast(evm);

  }, 0);

  renderEVMRecommendations(evm);
}

}








// Configurar funciones del dashboard EVM
function setupEVMFunctions(ganttContainer) {
  // Funci√≥n para cerrar el modal
  window.closeEVMModal = function() {
    console.log('üîí Cerrando modal EVM...');
    const overlay = ganttContainer.querySelector('#dashboard-evm-premium');
    if (overlay) {
      overlay.remove();
    }
    // Destruir instancia de gr√°fico si existe
    if (window.evmChartInstance) {
      window.evmChartInstance.destroy();
      window.evmChartInstance = null;
    }
  };
  
  // Funci√≥n para exportar reporte
  window.exportEVMReport = function() {
    if (window.evmChartInstance) {
      const link = document.createElement('a');
      link.download = `evm-report-${new Date().toISOString().slice(0,10)}.png`;
      link.href = window.evmChartInstance.toBase64Image();
      link.click();
      alert('üì• Reporte EVM exportado como PNG');
    } else {
      alert('‚ö†Ô∏è No hay gr√°fico para exportar');
    }
  };
  
  
}







function loadEVMDataAndRender() {
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;

  const projectIndex =
    parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;

  const project = projects[projectIndex];
  const tasks = project.tasks || [];


// üõë Si venimos desde COSTOS, NO recalcular en horas
if (window.__EVM_MODE__ === 'costs') {
  console.log('‚õî Saltando EVM REAL (modo COSTOS activo)');
  return;
}


 const evm = calculateEVMRealFromTasks(tasks);


  if (!evm) return;

renderEVMSemaphore(evm);




  // ===== M√âTRICAS PRINCIPALES (HORAS) =====
  document.getElementById('pvValue').textContent = evm.PV.toFixed(2) + ' h';
  document.getElementById('evValue').textContent = evm.EV.toFixed(2) + ' h';
  document.getElementById('acValue').textContent = evm.AC.toFixed(2) + ' h';

  // BAC REAL (baseline EVM)
document.getElementById('bacValue').textContent =
  evm.BAC.toFixed(2) + ' h';


  // ===== √çNDICES =====
  document.getElementById('cpiValue').textContent = evm.CPI.toFixed(2);
  document.getElementById('spiValue').textContent = evm.SPI.toFixed(2);
  // Actualizar colores seg√∫n interpretaci√≥n
 actualizarColoresIndicadores();

  // ===== VARIANZAS =====
  document.getElementById('cvValue').textContent =
    (evm.CV >= 0 ? '+' : '') + evm.CV.toFixed(2) + ' h';

  document.getElementById('svValue').textContent =
    (evm.SV >= 0 ? '+' : '') + evm.SV.toFixed(2) + ' h';

 





// ===== GR√ÅFICO + PRON√ìSTICO =====

// Series base (PV, EV, AC)
const series = buildEVMSeriesFromTasks(tasks);

// üîÆ BAC = total de horas estimadas
const BAC = tasks.reduce(
  (sum, t) => sum + (Number(t.estimatedTime) || 0),
  0
);

// üîÆ EAC / ETC / VAC
const EAC = evm && evm.CPI ? BAC / evm.CPI : 0;
const ETC = EAC - evm.AC;
const VAC = BAC - EAC;

// üîÆ L√≠nea EAC plana en el gr√°fico
series.EAC = series.dates.map(() =>
  Number(EAC.toFixed(2))
);

// Render gr√°fico
renderEVMChart(series);

// ===== PRON√ìSTICO DEL PROYECTO (UI) =====
const eacEl = document.getElementById('eacForecastValue');
const etcEl = document.getElementById('etcForecastValue');
const vacEl = document.getElementById('vacForecastValue');

if (eacEl && etcEl && vacEl && evm) {
  eacEl.textContent = EAC.toFixed(2) + ' h';
  etcEl.textContent = ETC.toFixed(2) + ' h';
  vacEl.textContent =
    (VAC >= 0 ? '+' : '') + VAC.toFixed(2) + ' h';

  console.log('üîÆ Pron√≥stico EVM actualizado en UI', {
    EAC,
    ETC,
    VAC
  });
}











// ===== RECOMENDACIONES EVM (FIX DEFINITIVO) =====
requestAnimationFrame(() => {
  const recommendationsDiv = document.getElementById('evmRecommendations');

  if (!recommendationsDiv) {
    console.warn('‚ö†Ô∏è Contenedor evmRecommendations NO encontrado');
    return;
  }

  if (!evm) {
    recommendationsDiv.innerHTML = '<em>Datos EVM no disponibles</em>';
    return;
  }

  const html = generateEVMRecommendations(evm);

  recommendationsDiv.innerHTML = html;
  recommendationsDiv.style.opacity = '1';

  console.log('‚úÖ Recomendaciones EVM renderizadas correctamente');
});

}



function calculateScheduleForecast(tasks) {
  if (!tasks || !tasks.length) return null;

  const series = buildEVMSeriesFromTasks(tasks);
  const evm = calculateEVMRealFromTasks(tasks);

  if (!series || !series.dates || series.dates.length < 2 || !evm || !evm.SPI) {
    return null;
  }

  const startDate = new Date(series.dates[0]);
  const plannedEndDate = new Date(series.dates[series.dates.length - 1]);

  const plannedDurationMs = plannedEndDate - startDate;

  const forecastDurationMs =
    evm.SPI > 0 ? plannedDurationMs / evm.SPI : plannedDurationMs;

  const forecastEndDate = new Date(
    startDate.getTime() + forecastDurationMs
  );

  const daysAhead = Math.round(
    (plannedEndDate - forecastEndDate) / (1000 * 60 * 60 * 24)
  );

  return {
    startDate,
    plannedEndDate,
    forecastEndDate,
    SPI: evm.SPI,
    daysAhead
  };
}




// ===============================
// üìà EVM REAL BASADO EN HORAS - VERSI√ìN CORREGIDA
// ===============================

function calculateEVMRealFromTasks(tasks) {
  console.log('üßÆ [EVM CAN√ìNICO] Calculando m√©tricas reales');

  if (!tasks || tasks.length === 0) {
    console.warn('‚ö†Ô∏è No hay tareas');
    return null;
  }

  let EV = 0; // Earned Value
  let AC = 0; // Actual Cost
  let PV = 0; // Planned Value
  let BAC = 0; // Budget at Completion

  console.log('üìä ANALIZANDO ' + tasks.length + ' TAREAS:');

  // ==================== PASO 1: BAC (BASELINE TOTAL, INMUTABLE) ====================
  tasks.forEach(task => {
    const estimated = Number(task.estimatedTime) || 0;
    BAC += estimated;
  });

  console.log('‚úÖ BAC (Presupuesto total aprobado):', BAC, 'h');

  // ==================== PASO 2: PV (VALOR PLANIFICADO A LA FECHA) ====================
  // En tu sistema actual NO manejas fechas ‚Üí PV = BAC
  PV = BAC;

  console.log('‚úÖ PV (Valor planificado a la fecha):', PV, 'h');

  // ==================== PASO 3: AC (COSTO REAL) ====================
  tasks.forEach(task => {
    const actual =
      Number(task.actualTime) ||
      Number(task.timeLogged) ||
      Number(task.hoursLogged) ||
      0;

    AC += actual;

    console.log(`   "${task.name}": AC = ${actual}h`);
  });

  // ==================== PASO 4: EV (VALOR GANADO) ====================
  // ¬°¬°¬°¬°¬°CORRECCI√ìN PRINCIPAL AQU√ç!!!!!
  tasks.forEach(task => {
    const estimated = Number(task.estimatedTime) || 0;
    const actualHours =
      Number(task.actualTime) ||
      Number(task.timeLogged) ||
      Number(task.hoursLogged) ||
      0;

    let progress = 0;

    // ‚úÖ Regla 1: completado = 100%
    if (task.status === 'completed') {
      progress = 1;
      console.log(`   "${task.name}": completada ‚Üí 100%`);
    }
    // ‚úÖ Regla 2: en progreso ‚Üí proporcional REAL
    // ‚úÖ Regla NUEVA: rezagado/overdue/retrasado ‚Üí tambi√©n proporcional REAL
    else if (
      (task.status === 'inProgress' || 
       task.status === 'rezagado' || 
       task.status === 'overdue' || 
       task.status === 'retrasado') && 
      estimated > 0
    ) {
      progress = Math.min(1, actualHours / estimated);
      console.log(
        `   "${task.name}": ${actualHours}/${estimated}h (${task.status}) ‚Üí ${(progress * 100).toFixed(0)}%`
      );
    }
    // ‚úÖ Regla 3: pendiente ‚Üí 0%
    else {
      progress = 0;
      console.log(`   "${task.name}": ${task.status} ‚Üí 0%`);
    }

    const taskEV = estimated * progress;
    EV += taskEV;
  });

  // ==================== PASO 5: M√âTRICAS EVM ====================
  const CPI = AC > 0 ? EV / AC : 1;
  const SPI = PV > 0 ? EV / PV : 1;

  const CV = EV - AC;
  const SV = EV - PV;

  // ==================== PASO 6: PRON√ìSTICO (PMBOK ESCENARIO B) ====================
  // El resto del trabajo se ejecuta seg√∫n lo planificado
  const EAC = AC + (BAC - EV);
  const ETC = BAC - EV;
  const VAC = BAC - EAC;

  const result = {
    // Valores base
    PV: Number(PV.toFixed(2)),
    EV: Number(EV.toFixed(2)),
    AC: Number(AC.toFixed(2)),
    BAC: Number(BAC.toFixed(2)),

    // √çndices
    CPI: Number(CPI.toFixed(2)),
    SPI: Number(SPI.toFixed(2)),

    // Varianzas
    CV: Number(CV.toFixed(2)),
    SV: Number(SV.toFixed(2)),

    // Pron√≥stico
    EAC: Number(EAC.toFixed(2)),
    ETC: Number(ETC.toFixed(2)),
    VAC: Number(VAC.toFixed(2)),

    // Info adicional
    totalTasks: tasks.length,
    completedTasks: tasks.filter(t => t.status === 'completed').length,
    inProgressTasks: tasks.filter(t => t.status === 'inProgress').length,
    overdueTasks: tasks.filter(t => 
      t.status === 'rezagado' || 
      t.status === 'overdue' || 
      t.status === 'retrasado'
    ).length
  };

  console.log('üìà RESULTADOS EVM DEFINITIVOS:');
  console.log('   PV:', result.PV, 'h');
  console.log('   EV:', result.EV, 'h');
  console.log('   AC:', result.AC, 'h');
  console.log('   BAC:', result.BAC, 'h');
  console.log('   CPI:', result.CPI);
  console.log('   SPI:', result.SPI);
  console.log('   CV:', result.CV, 'h');
  console.log('   SV:', result.SV, 'h');
  console.log('   EAC:', result.EAC, 'h');
  console.log('   ETC:', result.ETC, 'h');
  console.log('   VAC:', result.VAC, 'h');

  return result;
}







// Funci√≥n para generar recomendaciones EVM
function generateEVMRecommendations(evmData) {
  let recommendations = '<ul style="margin: 0; padding-left: 20px;">';
  
  if (evmData.cpi < 0.9) {
    recommendations += '<li style="margin-bottom: 10px;">üî¥ <strong>Revisar costos urgentemente:</strong> El CPI es bajo (' + evmData.cpi.toFixed(2) + '), hay sobrecostos significativos</li>';
  } else if (evmData.cpi < 1.0) {
    recommendations += '<li style="margin-bottom: 10px;">üü° <strong>Controlar costos:</strong> El CPI (' + evmData.cpi.toFixed(2) + ') indica ligero sobrecosto</li>';
  } else {
    recommendations += '<li style="margin-bottom: 10px;">‚úÖ <strong>Costos bajo control:</strong> Excelente CPI (' + evmData.cpi.toFixed(2) + ')</li>';
  }
  
  if (evmData.spi < 0.9) {
    recommendations += '<li style="margin-bottom: 10px;">üî¥ <strong>Acelerar cronograma:</strong> El SPI es bajo (' + evmData.spi.toFixed(2) + '), hay retraso significativo</li>';
  } else if (evmData.spi < 1.0) {
    recommendations += '<li style="margin-bottom: 10px;">üü° <strong>Monitorear fechas:</strong> El SPI (' + evmData.spi.toFixed(2) + ') indica ligero retraso</li>';
  } else {
    recommendations += '<li style="margin-bottom: 10px;">‚úÖ <strong>Cronograma en tiempo:</strong> Buen SPI (' + evmData.spi.toFixed(2) + ')</li>';
  }
  
  if (evmData.cv < 0) {
    recommendations += '<li style="margin-bottom: 10px;">üí∞ <strong>Reducir costos:</strong> Varianza de costo negativa ($' + Math.abs(evmData.cv).toLocaleString() + ')</li>';
  }
  
  if (evmData.sv < 0) {
    recommendations += '<li style="margin-bottom: 10px;">üìÖ <strong>Recuperar tiempo:</strong> Varianza de tiempo negativa ($' + Math.abs(evmData.sv).toLocaleString() + ')</li>';
  }
  
  // Recomendaci√≥n general
  if (evmData.cpi >= 1.0 && evmData.spi >= 1.0) {
    recommendations += '<li>üéØ <strong>Proyecto saludable:</strong> Mantener el ritmo actual</li>';
  } else if (evmData.cpi < 0.9 || evmData.spi < 0.9) {
    recommendations += '<li>‚ö†Ô∏è <strong>Revisi√≥n ejecutiva necesaria:</strong> Considerar ajustes de alcance o recursos</li>';
  } else {
    recommendations += '<li>üìä <strong>Monitoreo continuo:</strong> Seguir m√©tricas semanalmente</li>';
  }
  
  recommendations += '</ul>';
  
  return recommendations;
}

function renderEVMChart(evm) {
  const canvas = document.getElementById('evmChartCanvas');
  if (!canvas) {
    console.warn('‚ùå Canvas EVM no encontrado');
    return;
  }

  const ctx = canvas.getContext('2d');

  if (window.evmChartInstance) {
    window.evmChartInstance.destroy();
  }

  // üî• MODO COSTOS ‚Üí BARRAS
  if (window.__EVM_MODE__ === 'costs') {
    console.log('üìä Renderizando gr√°fico EVM de COSTOS');

    window.evmChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['PV', 'EV', 'AC', 'BAC'],
        datasets: [{
          label: 'Costos ($)',
          data: [evm.PV, evm.EV, evm.AC, evm.BAC],
          backgroundColor: ['#3b82f6', '#10b981', '#ef4444', '#f59e0b']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { labels: { color: '#fff' } }
        },
        scales: {
          x: { ticks: { color: '#cbd5e1' } },
          y: { ticks: { color: '#cbd5e1' } }
        }
      }
    });

    return;
  }

  // ‚è±Ô∏è MODO HORAS ‚Üí L√çNEAS
  console.log('üìà Renderizando gr√°fico EVM de HORAS');
  renderEVMChartHours(evm);
}
    
  


function renderEVMChartHours(series) {
  console.log('üìà Renderizando gr√°fico EVM de HORAS...');

  const canvas = document.getElementById('evmChartCanvas');
  if (!canvas) {
    console.error('‚ùå Canvas EVM no encontrado');
    return;
  }

  const ctx = canvas.getContext('2d');

  if (window.evmChartInstance) {
    window.evmChartInstance.destroy();
  }

  canvas.width  = canvas.offsetWidth || 800;
  canvas.height = canvas.offsetHeight || 300;

  window.evmChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: series.dates || [],
      datasets: [
        {
          label: 'PV (Horas)',
          data: series.PV || [],
          borderColor: '#3b82f6',
          borderWidth: 3,
          fill: false
        },
        {
          label: 'EV (Horas)',
          data: series.EV || [],
          borderColor: '#10b981',
          borderWidth: 3,
          fill: false
        },
        {
          label: 'AC (Horas)',
          data: series.AC || [],
          borderColor: '#ef4444',
          borderWidth: 3,
          borderDash: [5, 5],
          fill: false
        }
      ]
    },
    options: {
      responsive: false,
      maintainAspectRatio: false
    }
  });

  console.log('‚úÖ Gr√°fico EVM HORAS renderizado');
}







// Funci√≥n para reintentar gr√°fico EVM
window.retryEVMChart = function() {
  console.log('üîÑ Reintentando cargar gr√°fico EVM...');
  loadEVMDataAndRender();
};
















// ========== SISTEMA COMPLETO DE GESTI√ìN DE COSTOS PARA EVM ==========

// ========== PANEL DE CONFIGURACI√ìN DE COSTOS ==========
function showCostConfigurationPanel() {
  console.log("üí∞ Abriendo panel de configuraci√≥n de costos...");
  
  // Crear overlay
  const overlay = document.createElement('div');
  overlay.id = 'costConfigOverlay';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    z-index: 1000000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  `;
  
  // Cargar configuraci√≥n guardada o usar valores por defecto
  const savedConfig = JSON.parse(localStorage.getItem('evmCostConfig') || '{}');
  const defaultConfig = {
    costPerHour: savedConfig.costPerHour || 50,
    roles: savedConfig.roles || [
      { name: 'Desarrollador Senior', costPerHour: 75 },
      { name: 'Desarrollador Junior', costPerHour: 40 },
      { name: 'Dise√±ador UX/UI', costPerHour: 60 },
      { name: 'Project Manager', costPerHour: 80 },
      { name: 'QA Tester', costPerHour: 45 }
    ],
    fixedCosts: savedConfig.fixedCosts || [
      { name: 'Licencias software', amount: 1200 },
      { name: 'Servidores hosting', amount: 300 },
      { name: 'Herramientas equipo', amount: 500 }
    ],
    overheadPercentage: savedConfig.overheadPercentage || 15
  };
  
  // Crear panel de configuraci√≥n
  overlay.innerHTML = `
    <div style="
      width: 90vw;
      max-width: 800px;
      max-height: 85vh;
      background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
      border-radius: 24px;
      box-shadow: 0 40px 80px rgba(0,0,0,0.8);
      border: 2px solid rgba(46, 204, 113, 0.4);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    ">
      <!-- Header -->
      <div style="
        background: linear-gradient(90deg, #0a0a1a, #1a1a3a);
        padding: 25px 35px;
        border-bottom: 1px solid rgba(46, 204, 113, 0.3);
        display: flex;
        justify-content: space-between;
        align-items: center;
      ">
        <div>
          <h2 style="margin: 0 0 8px 0; color: white; font-size: 28px;">
            üí∞ <span style="color: #2ecc71;">CONFIGURACI√ìN DE COSTOS EVM</span>
          </h2>
          <p style="margin: 0; color: #95a5a6; font-size: 14px;">
            Configura los par√°metros de costos para el an√°lisis de Valor Ganado
          </p>
        </div>
        <button onclick="document.getElementById('costConfigOverlay').remove()" style="
          background: rgba(231, 76, 60, 0.2);
          border: 1px solid #e74c3c;
          color: #e74c3c;
          padding: 12px 25px;
          border-radius: 8px;
          cursor: pointer;
          font-weight: bold;
          font-size: 14px;
        ">
          √ó Cerrar
        </button>
      </div>
      
      <!-- Contenido principal -->
      <div style="flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 25px;">
        
        <!-- Costo Base por Hora -->
        <div style="
          background: rgba(26, 31, 60, 0.8);
          border-radius: 18px;
          padding: 25px;
          border: 2px solid rgba(255,255,255,0.15);
        ">
          <h3 style="color: white; margin: 0 0 20px 0; font-size: 20px;">‚è±Ô∏è COSTO BASE POR HORA</h3>
          <div style="color: #95a5a6; font-size: 14px; margin-bottom: 20px;">
            Costo promedio por hora de trabajo (se usa cuando no hay rol espec√≠fico)
          </div>
          
          <div style="display: flex; align-items: center; gap: 20px;">
            <div style="flex: 1;">
              <input type="range" id="costPerHourSlider" min="20" max="150" value="${defaultConfig.costPerHour}" 
                style="width: 100%;" oninput="updateCostPerHourDisplay(this.value)">
            </div>
            <div style="text-align: center; min-width: 120px;">
              <div id="costPerHourDisplay" style="color: #2ecc71; font-size: 32px; font-weight: bold;">
                $${defaultConfig.costPerHour}
              </div>
              <div style="color: #95a5a6; font-size: 12px;">por hora</div>
            </div>
          </div>
        </div>
        
        <!-- Configuraci√≥n de Roles -->
        <div style="
          background: rgba(26, 31, 60, 0.8);
          border-radius: 18px;
          padding: 25px;
          border: 2px solid rgba(255,255,255,0.15);
        ">
          <h3 style="color: white; margin: 0 0 20px 0; font-size: 20px;">üë• CONFIGURACI√ìN DE ROLES</h3>
          <div style="color: #95a5a6; font-size: 14px; margin-bottom: 20px;">
            Define diferentes tarifas por tipo de recurso
          </div>
          
          <div id="rolesContainer" style="margin-bottom: 20px;">
            ${defaultConfig.roles.map((role, index) => `
              <div class="role-item" style="
                background: rgba(255,255,255,0.05);
                border-radius: 12px;
                padding: 15px;
                margin-bottom: 10px;
                display: flex;
                align-items: center;
                gap: 15px;
              ">
                <div style="flex: 1;">
                  <input type="text" value="${role.name}" 
                    style="
                      background: transparent;
                      border: 1px solid rgba(255,255,255,0.2);
                      color: white;
                      padding: 8px 12px;
                      border-radius: 6px;
                      width: 100%;
                      font-size: 14px;
                    "
                    placeholder="Nombre del rol"
                    onchange="updateRoleName(${index}, this.value)"
                  >
                </div>
                <div style="display: flex; align-items: center; gap: 10px; min-width: 200px;">
                  <span style="color: #95a5a6; font-size: 14px;">Costo:</span>
                  <input type="number" value="${role.costPerHour}" min="20" max="500" step="5"
                    style="
                      background: rgba(52, 152, 219, 0.1);
                      border: 1px solid #3498db;
                      color: white;
                      padding: 8px 12px;
                      border-radius: 6px;
                      width: 100px;
                      text-align: center;
                      font-size: 14px;
                    "
                    onchange="updateRoleCost(${index}, this.value)"
                  >
                  <span style="color: #95a5a6; font-size: 14px;">/hora</span>
                  <button onclick="removeRole(${index})" style="
                    background: rgba(231, 76, 60, 0.2);
                    border: 1px solid #e74c3c;
                    color: #e74c3c;
                    padding: 6px 12px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 12px;
                  ">
                    √ó
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
          
          <button onclick="addNewRole()" style="
            width: 100%;
            background: rgba(155, 89, 182, 0.2);
            border: 1px solid #9b59b6;
            color: #9b59b6;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
          ">
            + Agregar Nuevo Rol
          </button>
        </div>
        
        <!-- Costos Fijos -->
        <div style="
          background: rgba(26, 31, 60, 0.8);
          border-radius: 18px;
          padding: 25px;
          border: 2px solid rgba(255,255,255,0.15);
        ">
          <h3 style="color: white; margin: 0 0 20px 0; font-size: 20px;">üè¢ COSTOS FIJOS DEL PROYECTO</h3>
          <div style="color: #95a5a6; font-size: 14px; margin-bottom: 20px;">
            Costos que no dependen de horas trabajadas
          </div>
          
          <div id="fixedCostsContainer" style="margin-bottom: 20px;">
            ${defaultConfig.fixedCosts.map((cost, index) => `
              <div class="fixed-cost-item" style="
                background: rgba(255,255,255,0.05);
                border-radius: 12px;
                padding: 15px;
                margin-bottom: 10px;
                display: flex;
                align-items: center;
                gap: 15px;
              ">
                <div style="flex: 1;">
                  <input type="text" value="${cost.name}" 
                    style="
                      background: transparent;
                      border: 1px solid rgba(255,255,255,0.2);
                      color: white;
                      padding: 8px 12px;
                      border-radius: 6px;
                      width: 100%;
                      font-size: 14px;
                    "
                    placeholder="Descripci√≥n del costo"
                    onchange="updateFixedCostName(${index}, this.value)"
                  >
                </div>
                <div style="display: flex; align-items: center; gap: 10px; min-width: 200px;">
                  <span style="color: #95a5a6; font-size: 14px;">Monto:</span>
                  <input type="number" value="${cost.amount}" min="0" max="100000" step="100"
                    style="
                      background: rgba(243, 156, 18, 0.1);
                      border: 1px solid #f39c12;
                      color: white;
                      padding: 8px 12px;
                      border-radius: 6px;
                      width: 120px;
                      text-align: center;
                      font-size: 14px;
                    "
                    onchange="updateFixedCostAmount(${index}, this.value)"
                  >
                  <button onclick="removeFixedCost(${index})" style="
                    background: rgba(231, 76, 60, 0.2);
                    border: 1px solid #e74c3c;
                    color: #e74c3c;
                    padding: 6px 12px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 12px;
                  ">
                    √ó
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
          
          <button onclick="addNewFixedCost()" style="
            width: 100%;
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid #3498db;
            color: #3498db;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
          ">
            + Agregar Costo Fijo
          </button>
        </div>
        
        <!-- Overhead y Otros -->
        <div style="
          background: rgba(26, 31, 60, 0.8);
          border-radius: 18px;
          padding: 25px;
          border: 2px solid rgba(255,255,255,0.15);
        ">
          <h3 style="color: white; margin: 0 0 20px 0; font-size: 20px;">üìä GASTOS GENERALES (OVERHEAD)</h3>
          <div style="color: #95a5a6; font-size: 14px; margin-bottom: 20px;">
            Porcentaje adicional para gastos indirectos
          </div>
          
          <div style="display: flex; align-items: center; gap: 20px;">
            <div style="flex: 1;">
              <input type="range" id="overheadSlider" min="0" max="50" value="${defaultConfig.overheadPercentage}" 
                style="width: 100%;" oninput="updateOverheadDisplay(this.value)">
            </div>
            <div style="text-align: center; min-width: 120px;">
              <div id="overheadDisplay" style="color: #9b59b6; font-size: 32px; font-weight: bold;">
                ${defaultConfig.overheadPercentage}%
              </div>
              <div style="color: #95a5a6; font-size: 12px;">sobre costos directos</div>
            </div>
          </div>
        </div>
        
        <!-- Resumen de Costos -->
        <div style="
          background: rgba(46, 204, 113, 0.1);
          border: 2px solid rgba(46, 204, 113, 0.3);
          border-radius: 18px;
          padding: 25px;
        ">
          <h3 style="color: white; margin: 0 0 20px 0; font-size: 20px;">üìã RESUMEN DE CONFIGURACI√ìN</h3>
          
          <div id="costSummary" style="color: #95a5a6; font-size: 14px; line-height: 1.6;">
            <!-- Se actualiza din√°micamente -->
          </div>
          
          <button onclick="calculateAndShowEVMPreview()" style="
            width: 100%;
            background: linear-gradient(45deg, #8b5cf6, #6d28d9);
            border: none;
            color: white;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
          ">
            üìà Calcular Previsualizaci√≥n EVM
          </button>
        </div>
      </div>
      
      <!-- Footer -->
      <div style="
        background: rgba(255,255,255,0.03);
        border-top: 1px solid rgba(255,255,255,0.1);
        padding: 15px 35px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #95a5a6;
        font-size: 13px;
      ">
        <div>
          <span>üíæ Los cambios se guardan autom√°ticamente</span>
        </div>
        <div style="display: flex; gap: 15px;">
          <button onclick="saveCostConfiguration()" style="
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
            color: #2ecc71;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
          ">
            üíæ Guardar Configuraci√≥n
          </button>
          <button onclick="loadDefaultConfiguration()" style="
            background: rgba(243, 156, 18, 0.2);
            border: 1px solid #f39c12;
            color: #f39c12;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
          ">
            üîÑ Valores por Defecto
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(overlay);
  
  // Actualizar resumen inicial
  updateCostSummary();
  
  // Guardar configuraci√≥n actual
  window.currentCostConfig = defaultConfig;
}

// ========== FUNCIONES DE ACTUALIZACI√ìN DE COSTOS ==========

window.updateCostPerHourDisplay = function(value) {
  const display = document.getElementById('costPerHourDisplay');
  if (display) {
    display.textContent = `$${value}`;
  }
  if (window.currentCostConfig) {
    window.currentCostConfig.costPerHour = parseInt(value);
  }
  updateCostSummary();
};

window.updateOverheadDisplay = function(value) {
  const display = document.getElementById('overheadDisplay');
  if (display) {
    display.textContent = `${value}%`;
  }
  if (window.currentCostConfig) {
    window.currentCostConfig.overheadPercentage = parseInt(value);
  }
  updateCostSummary();
};

window.updateRoleName = function(index, name) {
  if (window.currentCostConfig && window.currentCostConfig.roles[index]) {
    window.currentCostConfig.roles[index].name = name;
  }
  updateCostSummary();
};

window.updateRoleCost = function(index, cost) {
  if (window.currentCostConfig && window.currentCostConfig.roles[index]) {
    window.currentCostConfig.roles[index].costPerHour = parseInt(cost);
  }
  updateCostSummary();
};

window.updateFixedCostName = function(index, name) {
  if (window.currentCostConfig && window.currentCostConfig.fixedCosts[index]) {
    window.currentCostConfig.fixedCosts[index].name = name;
  }
  updateCostSummary();
};

window.updateFixedCostAmount = function(index, amount) {
  if (window.currentCostConfig && window.currentCostConfig.fixedCosts[index]) {
    window.currentCostConfig.fixedCosts[index].amount = parseInt(amount);
  }
  updateCostSummary();
};

window.addNewRole = function() {
  if (!window.currentCostConfig) return;
  
  window.currentCostConfig.roles.push({
    name: 'Nuevo Rol',
    costPerHour: 50
  });
  
  // Actualizar la interfaz
  const rolesContainer = document.getElementById('rolesContainer');
  if (rolesContainer) {
    const newIndex = window.currentCostConfig.roles.length - 1;
    const role = window.currentCostConfig.roles[newIndex];
    
    const roleDiv = document.createElement('div');
    roleDiv.className = 'role-item';
    roleDiv.style.cssText = `
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
    `;
    
    roleDiv.innerHTML = `
      <div style="flex: 1;">
        <input type="text" value="${role.name}" 
          style="
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            width: 100%;
            font-size: 14px;
          "
          placeholder="Nombre del rol"
          onchange="updateRoleName(${newIndex}, this.value)"
        >
      </div>
      <div style="display: flex; align-items: center; gap: 10px; min-width: 200px;">
        <span style="color: #95a5a6; font-size: 14px;">Costo:</span>
        <input type="number" value="${role.costPerHour}" min="20" max="500" step="5"
          style="
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid #3498db;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            width: 100px;
            text-align: center;
            font-size: 14px;
          "
          onchange="updateRoleCost(${newIndex}, this.value)"
        >
        <span style="color: #95a5a6; font-size: 14px;">/hora</span>
        <button onclick="removeRole(${newIndex})" style="
          background: rgba(231, 76, 60, 0.2);
          border: 1px solid #e74c3c;
          color: #e74c3c;
          padding: 6px 12px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 12px;
        ">
          √ó
        </button>
      </div>
    `;
    
    rolesContainer.appendChild(roleDiv);
  }
  
  updateCostSummary();
};

window.removeRole = function(index) {
  if (!window.currentCostConfig || !window.currentCostConfig.roles[index]) return;
  
  window.currentCostConfig.roles.splice(index, 1);
  
  // Recrear toda la lista de roles
  const rolesContainer = document.getElementById('rolesContainer');
  if (rolesContainer) {
    rolesContainer.innerHTML = window.currentCostConfig.roles.map((role, i) => `
      <div class="role-item" style="
        background: rgba(255,255,255,0.05);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 15px;
      ">
        <div style="flex: 1;">
          <input type="text" value="${role.name}" 
            style="
              background: transparent;
              border: 1px solid rgba(255,255,255,0.2);
              color: white;
              padding: 8px 12px;
              border-radius: 6px;
              width: 100%;
              font-size: 14px;
            "
            placeholder="Nombre del rol"
            onchange="updateRoleName(${i}, this.value)"
          >
        </div>
        <div style="display: flex; align-items: center; gap: 10px; min-width: 200px;">
          <span style="color: #95a5a6; font-size: 14px;">Costo:</span>
          <input type="number" value="${role.costPerHour}" min="20" max="500" step="5"
            style="
              background: rgba(52, 152, 219, 0.1);
              border: 1px solid #3498db;
              color: white;
              padding: 8px 12px;
              border-radius: 6px;
              width: 100px;
              text-align: center;
              font-size: 14px;
            "
            onchange="updateRoleCost(${i}, this.value)"
          >
          <span style="color: #95a5a6; font-size: 14px;">/hora</span>
          <button onclick="removeRole(${i})" style="
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            color: #e74c3c;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
          ">
            √ó
          </button>
        </div>
      </div>
    `).join('');
  }
  
  updateCostSummary();
};

window.addNewFixedCost = function() {
  if (!window.currentCostConfig) return;
  
  window.currentCostConfig.fixedCosts.push({
    name: 'Nuevo Costo Fijo',
    amount: 0
  });
  
  // Actualizar la interfaz
  const costsContainer = document.getElementById('fixedCostsContainer');
  if (costsContainer) {
    const newIndex = window.currentCostConfig.fixedCosts.length - 1;
    const cost = window.currentCostConfig.fixedCosts[newIndex];
    
    const costDiv = document.createElement('div');
    costDiv.className = 'fixed-cost-item';
    costDiv.style.cssText = `
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
    `;
    
    costDiv.innerHTML = `
      <div style="flex: 1;">
        <input type="text" value="${cost.name}" 
          style="
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            width: 100%;
            font-size: 14px;
          "
          placeholder="Descripci√≥n del costo"
          onchange="updateFixedCostName(${newIndex}, this.value)"
        >
      </div>
      <div style="display: flex; align-items: center; gap: 10px; min-width: 200px;">
        <span style="color: #95a5a6; font-size: 14px;">Monto:</span>
        <input type="number" value="${cost.amount}" min="0" max="100000" step="100"
          style="
            background: rgba(243, 156, 18, 0.1);
            border: 1px solid #f39c12;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            width: 120px;
            text-align: center;
            font-size: 14px;
          "
          onchange="updateFixedCostAmount(${newIndex}, this.value)"
        >
        <button onclick="removeFixedCost(${newIndex})" style="
          background: rgba(231, 76, 60, 0.2);
          border: 1px solid #e74c3c;
          color: #e74c3c;
          padding: 6px 12px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 12px;
        ">
          √ó
        </button>
      </div>
    `;
    
    costsContainer.appendChild(costDiv);
  }
  
  updateCostSummary();
};

window.removeFixedCost = function(index) {
  if (!window.currentCostConfig || !window.currentCostConfig.fixedCosts[index]) return;
  
  window.currentCostConfig.fixedCosts.splice(index, 1);
  
  // Recrear toda la lista de costos fijos
  const costsContainer = document.getElementById('fixedCostsContainer');
  if (costsContainer) {
    costsContainer.innerHTML = window.currentCostConfig.fixedCosts.map((cost, i) => `
      <div class="fixed-cost-item" style="
        background: rgba(255,255,255,0.05);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 15px;
      ">
        <div style="flex: 1;">
          <input type="text" value="${cost.name}" 
            style="
              background: transparent;
              border: 1px solid rgba(255,255,255,0.2);
              color: white;
              padding: 8px 12px;
              border-radius: 6px;
              width: 100%;
              font-size: 14px;
            "
            placeholder="Descripci√≥n del costo"
            onchange="updateFixedCostName(${i}, this.value)"
          >
        </div>
        <div style="display: flex; align-items: center; gap: 10px; min-width: 200px;">
          <span style="color: #95a5a6; font-size: 14px;">Monto:</span>
          <input type="number" value="${cost.amount}" min="0" max="100000" step="100"
            style="
              background: rgba(243, 156, 18, 0.1);
              border: 1px solid #f39c12;
              color: white;
              padding: 8px 12px;
              border-radius: 6px;
              width: 120px;
              text-align: center;
              font-size: 14px;
            "
            onchange="updateFixedCostAmount(${i}, this.value)"
          >
          <button onclick="removeFixedCost(${i})" style="
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            color: #e74c3c;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
          ">
            √ó
          </button>
        </div>
      </div>
    `).join('');
  }
  
  updateCostSummary();
};

window.updateCostSummary = function() {
  const summaryElement = document.getElementById('costSummary');
  if (!summaryElement || !window.currentCostConfig) return;
  
  const config = window.currentCostConfig;
  
  // Calcular totales
  const totalFixedCosts = config.fixedCosts.reduce((sum, cost) => sum + (cost.amount || 0), 0);
  const avgRoleCost = config.roles.length > 0 
    ? config.roles.reduce((sum, role) => sum + role.costPerHour, 0) / config.roles.length 
    : config.costPerHour;
  
  summaryElement.innerHTML = `
    <ul style="margin: 0; padding-left: 20px;">
      <li style="margin-bottom: 8px;"><strong>Costo base por hora:</strong> $${config.costPerHour}</li>
      <li style="margin-bottom: 8px;"><strong>Roles configurados:</strong> ${config.roles.length} roles (promedio: $${avgRoleCost.toFixed(0)}/hora)</li>
      <li style="margin-bottom: 8px;"><strong>Costos fijos:</strong> $${totalFixedCosts.toLocaleString()}</li>
      <li style="margin-bottom: 8px;"><strong>Overhead:</strong> ${config.overheadPercentage}% adicional</li>
      <li><strong>Total costos directos estimados:</strong> $${(totalFixedCosts * (1 + config.overheadPercentage/100)).toLocaleString()}</li>
    </ul>
    <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 12px;">
      üí° <strong>Nota:</strong> Los c√°lculos EVM usar√°n estos par√°metros junto con las horas estimadas y registradas de tus tareas.
    </div>
  `;
};

window.saveCostConfiguration = function() {
  if (!window.currentCostConfig) return;
  
  try {
    localStorage.setItem('evmCostConfig', JSON.stringify(window.currentCostConfig));
    console.log('‚úÖ Configuraci√≥n de costos guardada:', window.currentCostConfig);
    
    // Mostrar feedback visual
    const saveBtn = document.querySelector('button[onclick="saveCostConfiguration()"]');
    if (saveBtn) {
      const originalText = saveBtn.textContent;
      saveBtn.textContent = '‚úÖ Guardado!';
      saveBtn.style.background = 'rgba(46, 204, 113, 0.3)';
      setTimeout(() => {
        saveBtn.textContent = originalText;
        saveBtn.style.background = 'rgba(46, 204, 113, 0.2)';
      }, 1500);
    }
    
    // Recalcular y mostrar vista previa
    calculateAndShowEVMPreview();
    
  } catch (error) {
    console.error('Error guardando configuraci√≥n:', error);
    alert('‚ùå Error al guardar la configuraci√≥n');
  }
};

window.loadDefaultConfiguration = function() {
  const defaultConfig = {
    costPerHour: 50,
    roles: [
      { name: 'Desarrollador Senior', costPerHour: 75 },
      { name: 'Desarrollador Junior', costPerHour: 40 },
      { name: 'Dise√±ador UX/UI', costPerHour: 60 },
      { name: 'Project Manager', costPerHour: 80 },
      { name: 'QA Tester', costPerHour: 45 }
    ],
    fixedCosts: [
      { name: 'Licencias software', amount: 1200 },
      { name: 'Servidores hosting', amount: 300 },
      { name: 'Herramientas equipo', amount: 500 }
    ],
    overheadPercentage: 15
  };
  
  window.currentCostConfig = defaultConfig;
  
  // Actualizar controles
  const costPerHourSlider = document.getElementById('costPerHourSlider');
  const overheadSlider = document.getElementById('overheadSlider');
  
  if (costPerHourSlider) costPerHourSlider.value = defaultConfig.costPerHour;
  if (overheadSlider) overheadSlider.value = defaultConfig.overheadPercentage;
  
  updateCostPerHourDisplay(defaultConfig.costPerHour);
  updateOverheadDisplay(defaultConfig.overheadPercentage);
  updateCostSummary();
  
  console.log('‚úÖ Configuraci√≥n por defecto cargada');
};

// ========== C√ÅLCULO EVM CON DATOS REALES ==========

window.calculateAndShowEVMPreview = function() {
  if (!window.currentCostConfig || typeof projects === 'undefined' || projects.length === 0) {
    alert('‚ùå No hay datos de proyectos o configuraci√≥n de costos');
    return;
  }
  
  const currentProject = projects[currentProjectIndex || 0];
  const tasks = currentProject.tasks || [];
  
  if (tasks.length === 0) {
    alert('‚ùå No hay tareas en el proyecto actual');
    return;
  }
  
  console.log('üìä CALCULANDO EVM CON DATOS REALES...');
  console.log('====================================');
  console.log('Proyecto:', currentProject.name);
  console.log('Tareas:', tasks.length);
  console.log('Configuraci√≥n de costos:', window.currentCostConfig);
  
  // Calcular m√©tricas EVM
  const config = window.currentCostConfig;
  
  // 1. Calcular BAC (Presupuesto al T√©rmino)
  const totalEstimatedHours = tasks.reduce((sum, task) => sum + (task.estimatedTime || 0), 0);
  const totalFixedCosts = config.fixedCosts.reduce((sum, cost) => sum + (cost.amount || 0), 0);
  
  // BAC = Costos variables (horas) + Costos fijos + Overhead
  const variableCosts = totalEstimatedHours * config.costPerHour;
  const overheadAmount = (variableCosts + totalFixedCosts) * (config.overheadPercentage / 100);
  const BAC = variableCosts + totalFixedCosts + overheadAmount;
  
  // 2. Calcular PV (Valor Planificado) - Suponiendo 60% del tiempo transcurrido
  const PV = BAC * 0.6;
  
  // 3. Calcular EV (Valor Ganado) basado en progreso real
  let totalEV = 0;
  tasks.forEach(task => {
    const taskCost = (task.estimatedTime || 0) * config.costPerHour;
    let taskProgress = 0;
    
    if (task.status === 'completed') {
      taskProgress = 1;
    } else if (task.timeLogged && task.estimatedTime) {
      taskProgress = Math.min(1, (task.timeLogged || 0) / (task.estimatedTime || 1));
    } else if (task.status === 'inProgress') {
      taskProgress = 0.5; // Asumir 50% si est√° en progreso
    }
    
    totalEV += taskCost * taskProgress;
  });
  
  const EV = totalEV;
  
  // 4. Calcular AC (Costo Real)
  const AC = tasks.reduce((sum, task) => sum + ((task.timeLogged || 0) * config.costPerHour), 0);
  
  // 5. Calcular m√©tricas de desempe√±o
  const CV = EV - AC;  // Varianza de Costo
  const SV = EV - PV;  // Varianza de Tiempo
  const CPI = AC > 0 ? EV / AC : 0;  // √çndice de Desempe√±o de Costo
  const SPI = PV > 0 ? EV / PV : 0;  // √çndice de Desempe√±o de Tiempo
  
  // Mostrar resultados
  const overlay = document.createElement('div');
  overlay.id = 'evmPreviewOverlay';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(10px);
    z-index: 1000001;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  `;
  
  overlay.innerHTML = `
    <div style="
      width: 90vw;
      max-width: 600px;
      background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
      border-radius: 24px;
      box-shadow: 0 40px 80px rgba(0,0,0,0.8);
      border: 2px solid rgba(139, 92, 246, 0.4);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    ">
      <!-- Header -->

      <div style="

        background: linear-gradient(90deg, #0a0a1a, #1a1a3a);
        padding: 25px 35px;
        border-bottom: 1px solid rgba(139, 92, 246, 0.3);
        display: flex;
        justify-content: space-between;
        align-items: center;
      ">
        <div>











          <h2 style="margin: 0 0 8px 0; color: white; font-size: 24px;">
            üìà <span style="color: #8b5cf6;">PREVISUALIZACI√ìN EVM</span>
          </h2>
          <p style="margin: 0; color: #95a5a6; font-size: 14px;">
            ${currentProject.name} ‚Ä¢ ${tasks.length} tareas ‚Ä¢ ${totalEstimatedHours} horas estimadas
          </p>
        </div>
        <button onclick="document.getElementById('evmPreviewOverlay').remove()" style="
          background: rgba(231, 76, 60, 0.2);
          border: 1px solid #e74c3c;
          color: #e74c3c;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
          font-weight: bold;
          font-size: 14px;
        ">
          √ó Cerrar
        </button>
      </div>
      
      <!-- Contenido -->
      <div style="flex: 1; padding: 25px; overflow-y: auto;">
        <!-- M√©tricas principales -->
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px;">
          <div style="
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
          ">
            <div style="color: #93c5fd; font-size: 12px; margin-bottom: 5px;">BAC</div>
            <div style="color: white; font-size: 22px; font-weight: bold;">$${BAC.toLocaleString('es-ES', {minimumFractionDigits: 0})}</div>
            <div style="color: #93c5fd; font-size: 11px;">Presupuesto Total</div>
          </div>
          
          <div style="
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
          ">
            <div style="color: #a7f3d0; font-size: 12px; margin-bottom: 5px;">PV</div>
            <div style="color: white; font-size: 22px; font-weight: bold;">$${PV.toLocaleString('es-ES', {minimumFractionDigits: 0})}</div>
            <div style="color: #a7f3d0; font-size: 11px;">Valor Planificado</div>
          </div>
          
          <div style="
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
          ">
            <div style="color: #fca5a5; font-size: 12px; margin-bottom: 5px;">AC</div>
            <div style="color: white; font-size: 22px; font-weight: bold;">$${AC.toLocaleString('es-ES', {minimumFractionDigits: 0})}</div>
            <div style="color: #fca5a5; font-size: 11px;">Costo Real</div>
          </div>
          
          <div style="
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
          ">
            <div style="color: #fde68a; font-size: 12px; margin-bottom: 5px;">EV</div>
            <div style="color: white; font-size: 22px; font-weight: bold;">$${EV.toLocaleString('es-ES', {minimumFractionDigits: 0})}</div>
            <div style="color: #fde68a; font-size: 11px;">Valor Ganado</div>
          </div>
        </div>
        
        <!-- Indicadores de desempe√±o -->
        <div style="margin-bottom: 25px;">
          <h3 style="color: white; margin: 0 0 15px 0; font-size: 18px;">üìä INDICADORES DE DESEMPE√ëO</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
            <div style="
              background: ${CPI >= 1 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)'};
              border-left: 4px solid ${CPI >= 1 ? '#10b981' : '#ef4444'};
              border-radius: 10px;
              padding: 15px;
            ">
              <div style="color: ${CPI >= 1 ? '#a7f3d0' : '#fca5a5'}; font-size: 12px; margin-bottom: 5px;">CPI</div>
              <div style="color: white; font-size: 28px; font-weight: bold;">${CPI.toFixed(2)}</div>
              <div style="color: ${CPI >= 1 ? '#a7f3d0' : '#fca5a5'}; font-size: 11px;">
                ${CPI >= 1 ? '‚úÖ Dentro del presupuesto' : '‚ö†Ô∏è Sobre costos'}
              </div>
            </div>
            
            <div style="
              background: ${SPI >= 1 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(245, 158, 11, 0.1)'};
              border-left: 4px solid ${SPI >= 1 ? '#10b981' : '#f59e0b'};
              border-radius: 10px;
              padding: 15px;
            ">
              <div style="color: ${SPI >= 1 ? '#a7f3d0' : '#fde68a'}; font-size: 12px; margin-bottom: 5px;">SPI</div>
              <div style="color: white; font-size: 28px; font-weight: bold;">${SPI.toFixed(2)}</div>
              <div style="color: ${SPI >= 1 ? '#a7f3d0' : '#fde68a'}; font-size: 11px;">
                ${SPI >= 1 ? '‚úÖ En tiempo' : '‚ö†Ô∏è Retraso en cronograma'}
              </div>
            </div>
          </div>
        </div>
        





        <!-- An√°lisis -->
        <div style="
          background: rgba(46, 204, 113, 0.1);
          border: 1px solid rgba(46, 204, 113, 0.3);
          border-radius: 12px;
          padding: 20px;
        ">
          <h3 style="color: white; margin: 0 0 15px 0; font-size: 18px;">üîç AN√ÅLISIS DEL PROYECTO</h3>
          <div style="color: #95a5a6; font-size: 14px; line-height: 1.5;">
            <p>Basado en la configuraci√≥n actual de costos:</p>
            <ul style="margin: 10px 0; padding-left: 20px;">
              <li>El proyecto est√° <strong>${CV >= 0 ? 'dentro del presupuesto' : 'sobre el presupuesto'}</strong> (CV: $${CV.toLocaleString('es-ES', {minimumFractionDigits: 0})})</li>
              <li>El cronograma est√° <strong>${SV >= 0 ? 'adelantado' : 'retrasado'}</strong> (SV: $${SV.toLocaleString('es-ES', {minimumFractionDigits: 0})})</li>
              <li>Se han completado aproximadamente <strong>${(EV/BAC*100).toFixed(1)}%</strong> del presupuesto</li>
            </ul>
            <p style="margin-top: 10px; font-size: 12px;">
              üí° <em>Estos c√°lculos se basan en horas estimadas (${totalEstimatedHours}h) y tiempo registrado.</em>
            </p>
          </div>
        </div>
      </div>
      
      <!-- Footer -->
      <div style="
        background: rgba(255,255,255,0.03);
        border-top: 1px solid rgba(255,255,255,0.1);
        padding: 15px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #95a5a6;
        font-size: 12px;
      ">
        <div>
          <span>Costo por hora: $${config.costPerHour} ‚Ä¢ Overhead: ${config.overheadPercentage}%</span>
        </div>
        <button onclick="openEVMDashboardCosts()" style="
          background: rgba(139, 92, 246, 0.2);
          border: 1px solid #8b5cf6;
          color: #8b5cf6;
          padding: 8px 15px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 12px;
        ">
          üìà Abrir Dashboard EVM Completo
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(overlay);
  
  // Tambi√©n mostrar en consola para an√°lisis
  console.log('\nüìä RESULTADOS EVM CALCULADOS:');
  console.log('============================');
  console.log('BAC (Presupuesto Total):', `$${BAC.toLocaleString()}`);
  console.log('PV (Valor Planificado):', `$${PV.toLocaleString()}`);
  console.log('EV (Valor Ganado):', `$${EV.toLocaleString()}`);
  console.log('AC (Costo Real):', `$${AC.toLocaleString()}`);
  console.log('CPI (√çndice Costo):', CPI.toFixed(2), CPI >= 1 ? '‚úÖ' : '‚ö†Ô∏è');
  console.log('SPI (√çndice Tiempo):', SPI.toFixed(2), SPI >= 1 ? '‚úÖ' : '‚ö†Ô∏è');
  console.log('CV (Varianza Costo):', `$${CV.toLocaleString()}`, CV >= 0 ? '‚úÖ' : '‚ö†Ô∏è');
  console.log('SV (Varianza Tiempo):', `$${SV.toLocaleString()}`, SV >= 0 ? '‚úÖ' : '‚ö†Ô∏è');

// ===============================
// ‚úÖ GUARDAR EVM DE COSTOS GLOBAL
// ===============================
window.lastEVMPreviewData = {
  PV: Math.round(PV),
  EV: Math.round(EV),
  AC: Math.round(AC),
  BAC: Math.round(BAC),
  CPI: parseFloat(CPI.toFixed(2)),
  SPI: parseFloat(SPI.toFixed(2)),
  
};


const variances = window.calculateCostVariances(window.lastEVMPreviewData);

if (variances) {
  window.lastEVMPreviewData.CV = variances.CV;
  window.lastEVMPreviewData.SV = variances.SV;
}

console.log('üíæ EVM DE COSTOS GUARDADO:', window.lastEVMPreviewData);



};

// ========== AGREGAR BOT√ìN DE CONFIGURACI√ìN DE COSTOS AL GANTT ==========

// Modificar la funci√≥n createCompleteGanttForCurrentProject para agregar bot√≥n de costos
// Busca en el c√≥digo existente la secci√≥n de botones del header y agrega este:

/*
<button onclick="showCostConfigurationPanel()" class="premium-btn active-btn" style="
  background: linear-gradient(45deg, #f39c12, #d35400);
  border: none;
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s;
  font-size: 14px;
">
  üí∞ Configurar Costos
</button>
*/

// ========== INTEGRACI√ìN CON EL SISTEMA EXISTENTE ==========

// Agregar este comando para abrir la configuraci√≥n desde cualquier lugar
window.openCostConfiguration = function() {
  showCostConfigurationPanel();
};

// Inicializar cuando se cargue el sistema
console.log('üí∞ Sistema de Gesti√≥n de Costos EVM cargado');
console.log('üìã Comandos disponibles:');
console.log('   showCostConfigurationPanel() - Abrir configuraci√≥n de costos');
console.log('   calculateAndShowEVMPreview() - Ver previsualizaci√≥n EVM');
console.log('   openCostConfiguration() - Acceso r√°pido a configuraci√≥n');





// ========== FUNCIONES DE LOS BOTONES DEL HEADER ==========
window.toggleMobileViewPremium = function() {
  alert('üì± Vista m√≥vil activada');
};

window.showAIPredictorPremium = function() {
  alert('ü§ñ Predictor IA activado');
};

window.switchProjectPremium = function() {
  const gantt = document.getElementById('premiumExecutiveGantt');
  if (gantt) gantt.remove();
  createProjectSelector();
};

// ========== SISTEMA DE EXPORTACI√ìN PREMIUM ==========
function showExportPremiumMenu() {
  console.log('üì§ Mostrando men√∫ de exportaci√≥n premium...');
  
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) {
    alert('‚ùå Por favor, abre el Gantt Ejecutivo primero');
    return;
  }
  
  const projectName = ganttContainer.dataset.projectName || 'Proyecto actual';
  
  // Crear overlay
  const overlay = document.createElement('div');
  overlay.id = 'exportPremiumOverlay';
  overlay.style.cssText = `
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(15px);
    z-index: 1000000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  `;
  
  // Crear modal premium
  const modal = document.createElement('div');
  modal.style.cssText = `
    width: 800px;
    max-width: 90vw;
    background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%);
    border-radius: 24px;
    padding: 40px;
    border: 2px solid rgba(139, 92, 246, 0.4);
    color: white;
    position: relative;
  `;
  
  modal.innerHTML = `
    <div style="text-align: center; margin-bottom: 30px;">
      <div style="font-size: 48px; margin-bottom: 15px;">üì§</div>
      <h2 style="margin: 0 0 10px 0; color: white; font-size: 28px;">
        <span style="color: #8b5cf6;">EXPORTACI√ìN</span> PREMIUM
      </h2>
      <p style="color: #94a3b8; margin: 0;">
        Proyecto: <strong style="color: #10b981;">${projectName}</strong>
      </p>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
      <button onclick="exportToExcelPremium()" style="
        background: linear-gradient(45deg, #10b981, #059669);
        border: none;
        color: white;
        padding: 20px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      ">
        <span style="font-size: 24px;">üìä</span>
        <span>Excel</span>
      </button>
      
      <button onclick="exportToPowerPointPremium()" style="
        background: linear-gradient(45deg, #ef4444, #dc2626);
        border: none;
        color: white;
        padding: 20px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      ">
        <span style="font-size: 24px;">üìΩÔ∏è</span>
        <span>PowerPoint</span>
      </button>
      
      <button onclick="exportToJSONPremium()" style="
        background: linear-gradient(45deg, #f59e0b, #d97706);
        border: none;
        color: white;
        padding: 20px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      ">
        <span style="font-size: 24px;">üîß</span>
        <span>JSON</span>
      </button>
      
      <button onclick="exportToImagePremium()" style="
        background: linear-gradient(45deg, #3b82f6, #1d4ed8);
        border: none;
        color: white;
        padding: 20px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      ">
        <span style="font-size: 24px;">üñºÔ∏è</span>
        <span>Imagen</span>
      </button>
    </div>
    
    <div style="text-align: center;">
      <button onclick="closeExportPremiumMenu()" style="
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        color: white;
        padding: 12px 30px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
      ">
        ‚úï Cerrar
      </button>
    </div>
  `;
  
  overlay.appendChild(modal);
  ganttContainer.appendChild(overlay);

// 3. SOLO DESPU√âS
  setTimeout(() => {
    loadEVMDataAndRender();
  }, 0);



}

// ========== FUNCIONES DE EXPORTACI√ìN ==========

// Funci√≥n para cerrar el men√∫
window.closeExportPremiumMenu = function() {
  const overlay = document.getElementById('exportPremiumOverlay');
  if (overlay) overlay.remove();
};

// Funci√≥n para Excel
window.exportToExcelPremium = function() {
  console.log('üìä Exportando a Excel...');
  alert('üìä Exportando a Excel...\n\nEn una versi√≥n completa, esto generar√≠a un archivo .xlsx');
  closeExportPremiumMenu();
};

// Funci√≥n para PowerPoint
window.exportToPowerPointPremium = function() {
  console.log('üìΩÔ∏è Exportando a PowerPoint...');
  alert('üìΩÔ∏è Exportando a PowerPoint...\n\nEn una versi√≥n completa, esto generar√≠a un archivo .pptx');
  closeExportPremiumMenu();
};

// Funci√≥n para JSON
window.exportToJSONPremium = function() {
  console.log('üîß Exportando a JSON...');
  
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  const currentProject = projects[projectIndex];
  
  // Crear datos para exportar
  const exportData = {
    project: currentProject,
    exportDate: new Date().toISOString(),
    totalTasks: currentProject.tasks.length
  };
  
  // Crear y descargar archivo JSON
  const dataStr = JSON.stringify(exportData, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(dataBlob);
  
  const link = document.createElement('a');
  link.href = url;
  link.download = `${currentProject.name}_${new Date().toISOString().slice(0,10)}.json`;
  link.click();
  
  URL.revokeObjectURL(url);
  closeExportPremiumMenu();
};

// Funci√≥n para Imagen
window.exportToImagePremium = function() {
  console.log('üñºÔ∏è Exportando a Imagen...');
  alert('üñºÔ∏è Exportando a Imagen...\n\nEn una versi√≥n completa, esto capturar√≠a el Gantt como PNG');
  closeExportPremiumMenu();
};

// ========== FUNCI√ìN PARA EL BOT√ìN DE EXPORTAR ==========
// ========== SISTEMA COMPLETO DE EXPORTACI√ìN ==========
window.exportGanttData = function() {
  console.log('üöÄ Activando sistema COMPLETO de exportaci√≥n...');
  
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) {
    alert('‚ùå Por favor, abre el Gantt Ejecutivo primero');
    return;
  }
  
  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  const currentProject = projects[projectIndex];
  const projectName = currentProject.name || 'Proyecto';
  
  // Crear men√∫ de exportaci√≥n
  createExportMenu(ganttContainer, projectName, currentProject);
};

// ========== MEN√ö DE EXPORTACI√ìN ==========
function createExportMenu(container, projectName, project) {
  // Eliminar men√∫ anterior si existe
  const oldOverlay = document.getElementById('exportFullOverlay');
  if (oldOverlay) oldOverlay.remove();
  
  // Crear overlay
  const overlay = document.createElement('div');
  overlay.id = 'exportFullOverlay';
  overlay.style.cssText = `
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(20px);
    z-index: 1000000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    animation: fadeIn 0.3s ease;
  `;
  
  // Crear modal premium
  const modal = document.createElement('div');
  modal.style.cssText = `
    width: 900px;
    max-width: 95vw;
    max-height: 90vh;
    background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
    border-radius: 24px;
    border: 2px solid rgba(139, 92, 246, 0.4);
    color: white;
    position: relative;
    overflow: hidden;
    box-shadow: 0 40px 80px rgba(0,0,0,0.8);
    animation: slideUp 0.4s cubic-bezier(0.22, 1, 0.36, 1);
  `;
  
  modal.innerHTML = `
    <!-- Header -->
    <div style="
      background: linear-gradient(90deg, rgba(10,10,26,0.9), rgba(26,26,58,0.9));
      padding: 30px 40px;
      border-bottom: 1px solid rgba(139, 92, 246, 0.3);
      position: relative;
      overflow: hidden;
    ">
      <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: radial-gradient(circle at 20% 30%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
      "></div>
      
      <div style="display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 1;">
        <div style="display: flex; align-items: center; gap: 20px;">
          <div style="
            width: 70px;
            height: 70px;
            background: linear-gradient(45deg, #8b5cf6, #3b82f6);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            box-shadow: 0 15px 35px rgba(139, 92, 246, 0.4);
          ">
            üì§
          </div>
          <div>
            <h2 style="margin: 0 0 8px 0; color: white; font-size: 32px;">
              <span style="background: linear-gradient(45deg, #8b5cf6, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;">EXPORTAR</span>
            </h2>
            <p style="margin: 0; color: #a5b4fc; font-size: 14px;">
              ${projectName} ‚Ä¢ ${project.tasks.length} tareas ‚Ä¢ ${new Date().toLocaleDateString()}
            </p>
          </div>
        </div>
        
        <button onclick="closeFullExportMenu()" style="
          background: rgba(239, 68, 68, 0.2);
          border: 1px solid rgba(239, 68, 68, 0.4);
          color: #fca5a5;
          padding: 12px 24px;
          border-radius: 12px;
          cursor: pointer;
          font-weight: bold;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.3s;
        " onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'"
           onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'">
          ‚úï Cerrar
        </button>
      </div>
    </div>
    
    <!-- Opciones de exportaci√≥n -->
    <div style="padding: 40px; overflow-y: auto; max-height: 60vh;">
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; margin-bottom: 30px;">
        <!-- Excel -->
        <div class="export-card" onclick="exportToExcelReal()" style="
          background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
          border: 2px solid rgba(16, 185, 129, 0.3);
          border-radius: 20px;
          padding: 30px;
          cursor: pointer;
          transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
          position: relative;
          overflow: hidden;
        ">
          <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
            <div style="
              width: 70px;
              height: 70px;
              background: linear-gradient(45deg, #10b981, #059669);
              border-radius: 18px;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 32px;
              box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
            ">
              üìä
            </div>
            <div style="flex: 1;">
              <h3 style="margin: 0 0 8px 0; color: white; font-size: 22px;">Excel</h3>
              <p style="margin: 0; color: #a7f3d0; font-size: 14px; opacity: 0.8;">
                Hoja de c√°lculo completa
              </p>
            </div>
          </div>
          <p style="color: #86efac; font-size: 13px; line-height: 1.5; margin: 0 0 20px 0;">
            Exporta tareas, m√©tricas y an√°lisis a Excel (.xlsx)
          </p>
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <span style="color: #10b981; font-size: 12px; font-weight: 500;">.xlsx</span>
            <span style="color: rgba(255,255,255,0.5); font-size: 11px;">Haz clic para exportar</span>
          </div>
        </div>
        
        <!-- PowerPoint -->
        <div class="export-card" onclick="exportToPowerPointReal()" style="
          background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
          border: 2px solid rgba(239, 68, 68, 0.3);
          border-radius: 20px;
          padding: 30px;
          cursor: pointer;
          transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
          position: relative;
          overflow: hidden;
        ">
          <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
            <div style="
              width: 70px;
              height: 70px;
              background: linear-gradient(45deg, #ef4444, #dc2626);
              border-radius: 18px;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 32px;
              box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
            ">
              üìΩÔ∏è
            </div>
            <div style="flex: 1;">
              <h3 style="margin: 0 0 8px 0; color: white; font-size: 22px;">PowerPoint</h3>
              <p style="margin: 0; color: #fca5a5; font-size: 14px; opacity: 0.8;">
                Presentaci√≥n ejecutiva
              </p>
            </div>
          </div>
          <p style="color: #fecaca; font-size: 13px; line-height: 1.5; margin: 0 0 20px 0;">
            Crea presentaci√≥n con gr√°ficos y an√°lisis (.pptx)
          </p>
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <span style="color: #ef4444; font-size: 12px; font-weight: 500;">.pptx</span>
            <span style="color: rgba(255,255,255,0.5); font-size: 11px;">Haz clic para exportar</span>
          </div>
        </div>
        
        <!-- JSON -->
        <div class="export-card" onclick="exportToJSONReal()" style="
          background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
          border: 2px solid rgba(245, 158, 11, 0.3);
          border-radius: 20px;
          padding: 30px;
          cursor: pointer;
          transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
          position: relative;
          overflow: hidden;
        ">
          <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
            <div style="
              width: 70px;
              height: 70px;
              background: linear-gradient(45deg, #f59e0b, #d97706);
              border-radius: 18px;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 32px;
              box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
            ">
              üîß
            </div>
            <div style="flex: 1;">
              <h3 style="margin: 0 0 8px 0; color: white; font-size: 22px;">JSON</h3>
              <p style="margin: 0; color: #fde68a; font-size: 14px; opacity: 0.8;">
                Datos estructurados
              </p>
            </div>
          </div>
          <p style="color: #fde68a; font-size: 13px; line-height: 1.5; margin: 0 0 20px 0;">
            Exporta todos los datos para integraci√≥n (.json)
          </p>
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <span style="color: #f59e0b; font-size: 12px; font-weight: 500;">.json</span>
            <span style="color: rgba(255,255,255,0.5); font-size: 11px;">Haz clic para exportar</span>
          </div>
        </div>
        
       <!-- PDF -->
<div class="export-card" onclick="exportToPDFReal()" style="
  background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(185, 28, 28, 0.05));
  border: 2px solid rgba(220, 38, 38, 0.3);
  border-radius: 20px;
  padding: 30px;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
">
  <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
    <div style="
      width: 70px;
      height: 70px;
      background: linear-gradient(45deg, #dc2626, #b91c1c);
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      box-shadow: 0 10px 25px rgba(220, 38, 38, 0.3);
    ">
      üìÑ
    </div>
    <div style="flex: 1;">
      <h3 style="margin: 0 0 8px 0; color: white; font-size: 22px;">PDF</h3>
      <p style="margin: 0; color: #fca5a5; font-size: 14px; opacity: 0.8;">
        Documento profesional
      </p>
    </div>
  </div>
  <p style="color: #fecaca; font-size: 13px; line-height: 1.5; margin: 0 0 20px 0;">
    Genera un reporte PDF completo con an√°lisis y recomendaciones
  </p>
  <div style="display: flex; align-items: center; justify-content: space-between;">
    <span style="color: #dc2626; font-size: 12px; font-weight: 500;">.pdf</span>
    <span style="color: rgba(255,255,255,0.5); font-size: 11px;">Haz clic para exportar</span>
          </div>
        </div>
      </div>
      
      <!-- Progreso -->
      <div id="exportProgress" style="
        background: rgba(255,255,255,0.03);
        border-radius: 16px;
        padding: 20px;
        margin-top: 20px;
        display: none;
      ">
        <div id="progressContent"></div>
      </div>
    </div>
    
    <!-- Footer -->
    <div style="
      background: linear-gradient(90deg, rgba(10,10,26,0.9), rgba(26,26,58,0.9));
      padding: 20px 40px;
      border-top: 1px solid rgba(139, 92, 246, 0.2);
      color: #94a3b8;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    ">
      <div>
        <span>Sistema de Exportaci√≥n Premium ‚Ä¢ v1.0</span>
      </div>
      <div style="display: flex; gap: 15px;">
        <span>üõ°Ô∏è Seguro</span>
        <span>‚ö° R√°pido</span>
        <span>üéØ Preciso</span>
      </div>
    </div>
  `;
  
  overlay.appendChild(modal);
  container.appendChild(overlay);
  
  // Agregar animaciones
  const style = document.createElement('style');
  style.textContent = `
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .export-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 25px 50px rgba(0,0,0,0.4) !important;
    }
  `;
  document.head.appendChild(style);
  
  // Agregar efectos hover
  document.querySelectorAll('.export-card').forEach(card => {
    card.addEventListener('mouseenter', function() {
      const color = this.style.borderColor.match(/rgba\((\d+), (\d+), (\d+)/);
      if (color) {
        this.style.background = `linear-gradient(135deg, rgba(${color[1]}, ${color[2]}, ${color[3]}, 0.2), rgba(${color[1]}, ${color[2]}, ${color[3]}, 0.1))`;
      }
    });
    
    card.addEventListener('mouseleave', function() {
      const color = this.style.borderColor.match(/rgba\((\d+), (\d+), (\d+)/);
      if (color) {
        this.style.background = `linear-gradient(135deg, rgba(${color[1]}, ${color[2]}, ${color[3]}, 0.1), rgba(${color[1]}, ${color[2]}, ${color[3]}, 0.05))`;
      }
    });
  });
}

// ========== FUNCIONES REALES DE EXPORTACI√ìN ==========

// Funci√≥n para cerrar el men√∫
window.closeFullExportMenu = function() {
  const overlay = document.getElementById('exportFullOverlay');
  if (overlay) overlay.remove();
};

// Funci√≥n para mostrar progreso
function showExportProgress(format, message) {
  const progressDiv = document.getElementById('exportProgress');
  const progressContent = document.getElementById('progressContent');
  
  if (progressDiv && progressContent) {
    progressDiv.style.display = 'block';
    progressContent.innerHTML = `
      <div style="display: flex; align-items: center; gap: 20px;">
        <div style="font-size: 24px;">‚è≥</div>
        <div style="flex: 1;">
          <div style="color: white; font-weight: 500; margin-bottom: 5px;">Exportando a ${format}</div>
          <div style="color: #94a3b8; font-size: 13px;">${message}</div>
          <div style="margin-top: 15px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
            <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #8b5cf6, #3b82f6); border-radius: 3px; transition: width 0.3s;"></div>
          </div>
        </div>
      </div>
    `;
    
    // Animar barra de progreso
    let progress = 0;
    const interval = setInterval(() => {
      progress += Math.random() * 20;
      if (progress > 95) progress = 95;
      
      const progressBar = document.getElementById('progressBar');
      if (progressBar) progressBar.style.width = `${progress}%`;
      
      if (progress >= 95) clearInterval(interval);
    }, 300);
  }
}

// Funci√≥n para completar exportaci√≥n
function completeExport(format, fileName) {
  const progressContent = document.getElementById('progressContent');
  if (progressContent) {
    progressContent.innerHTML = `
      <div style="display: flex; align-items: center; gap: 20px;">
        <div style="font-size: 24px; color: #10b981;">‚úÖ</div>
        <div style="flex: 1;">
          <div style="color: white; font-weight: 500; margin-bottom: 5px;">Exportaci√≥n completada</div>
          <div style="color: #86efac; font-size: 13px;">Archivo generado: <strong>${fileName}</strong></div>
          <div style="margin-top: 15px;">
            <button onclick="closeFullExportMenu()" style="
              background: rgba(16, 185, 129, 0.2);
              border: 1px solid #10b981;
              color: #10b981;
              padding: 8px 16px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 13px;
            ">
              Cerrar
            </button>
          </div>
        </div>
      </div>
    `;
  }
}

// ========== 1. EXPORTAR A EXCEL (REAL) ==========
window.exportToExcelReal = function() {
  console.log('üìä Exportando a Excel REAL...');
  showExportProgress('Excel', 'Generando archivo .xlsx...');
  
  try {
    const ganttContainer = document.getElementById('premiumExecutiveGantt');
    const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
    const currentProject = projects[projectIndex];
    
    // Verificar si SheetJS est√° disponible
    if (typeof XLSX === 'undefined') {
      throw new Error('Biblioteca XLSX no cargada');
    }
    
    // Crear hoja de trabajo principal
    const wsData = [
      ['REPORTE DE PROYECTO - GANTT EXECUTIVE', '', '', '', '', ''],
      ['Proyecto:', currentProject.name, '', 'Fecha:', new Date().toLocaleDateString()],
      ['Total Tareas:', currentProject.tasks.length, '', 'Completadas:', currentProject.tasks.filter(t => t.status === 'completed').length],
      [''],
      ['DETALLE DE TAREAS'],
      ['ID', 'TAREA', 'ESTADO', 'PRIORIDAD', 'TIEMPO EST (h)', 'TIEMPO REG (h)', 'PROGRESO %', 'ASIGNADO', 'INICIO', 'FIN', 'DEPENDENCIAS', 'CR√çTICA']
    ];
    
    // Agregar tareas
    currentProject.tasks.forEach(task => {
      wsData.push([
        task.id || '',
        task.name || '',
        task.status || '',
        task.priority || '',
        task.estimatedTime || 0,
        task.timeLogged || 0,
        task.progress || 0,
        task.assignee || 'Sin asignar',
        task.startDate || '',
        task.deadline || '',
        task.dependencies ? task.dependencies.join(', ') : '',
        task.critical ? 'S√ç' : 'NO'
      ]);
    });
    
    // Hoja de resumen
    const summaryData = [
      ['RESUMEN EJECUTIVO'],
      ['M√©trica', 'Valor', 'Porcentaje'],
      ['Tareas Totales', currentProject.tasks.length, '100%'],
      ['Tareas Completadas', currentProject.tasks.filter(t => t.status === 'completed').length, 
        `${Math.round((currentProject.tasks.filter(t => t.status === 'completed').length / currentProject.tasks.length) * 100)}%`],
      ['Tareas en Progreso', currentProject.tasks.filter(t => t.status === 'inProgress').length, ''],
      ['Tareas Pendientes', currentProject.tasks.filter(t => t.status === 'pending').length, ''],
      ['Tareas Cr√≠ticas', currentProject.tasks.filter(t => t.critical).length, ''],
      [''],
      ['TIEMPOS'],
      ['Tiempo Total Estimado (h)', currentProject.tasks.reduce((sum, t) => sum + (t.estimatedTime || 0), 0)],
      ['Tiempo Total Registrado (h)', currentProject.tasks.reduce((sum, t) => sum + (t.timeLogged || 0), 0)],
      ['Diferencia (h)', currentProject.tasks.reduce((sum, t) => sum + ((t.estimatedTime || 0) - (t.timeLogged || 0)), 0)]
    ];
    
    // Crear libro de trabajo
    const wb = XLSX.utils.book_new();
    
    // Hoja de tareas
    const wsTasks = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, wsTasks, 'Tareas');
    
    // Hoja de resumen
    const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
    XLSX.utils.book_append_sheet(wb, wsSummary, 'Resumen');
    
    // Generar nombre de archivo
    const fileName = `Gantt_${currentProject.name.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0,10)}.xlsx`;
    
    // Descargar archivo
    XLSX.writeFile(wb, fileName);
    
    console.log('‚úÖ Excel exportado:', fileName);
    completeExport('Excel', fileName);
    
  } catch (error) {
    console.error('‚ùå Error exportando a Excel:', error);
    alert('Error al exportar a Excel: ' + error.message);
    closeFullExportMenu();
  }
};

// ========== 2. EXPORTAR A POWERPOINT (REAL) ==========
window.exportToPowerPointReal = function() {
  console.log('üìΩÔ∏è Exportando a PowerPoint REAL...');
  showExportProgress('PowerPoint', 'Creando presentaci√≥n .pptx...');
  
  try {
    const ganttContainer = document.getElementById('premiumExecutiveGantt');
    const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
    const currentProject = projects[projectIndex];
    
    // Verificar si PptxGenJS est√° disponible
    if (typeof PptxGenJS === 'undefined') {
      throw new Error('Biblioteca PptxGenJS no cargada');
    }
    
    // Crear nueva presentaci√≥n
    const pptx = new PptxGenJS();
    
    // Configuraci√≥n
    pptx.layout = 'LAYOUT_16x9';
    pptx.company = 'Gantt Executive';
    pptx.author = 'Sistema de Gesti√≥n';
    
    // PORTADA
    let slide = pptx.addSlide();
    slide.background = { fill: '0a0a1a' };
    slide.addText('REPORTE DE PROYECTO', {
      x: 0.5,
      y: 1,
      w: 9,
      h: 1.5,
      fontSize: 44,
      bold: true,
      color: 'FFFFFF',
      align: 'center'
    });
    
    slide.addText(currentProject.name, {
      x: 0.5,
      y: 2.5,
      w: 9,
      h: 1,
      fontSize: 32,
      color: '8b5cf6',
      align: 'center'
    });
    
    slide.addText(`Fecha: ${new Date().toLocaleDateString()}`, {
      x: 0.5,
      y: 4,
      w: 9,
      h: 0.5,
      fontSize: 18,
      color: '94a3b8',
      align: 'center'
    });
    
    // RESUMEN EJECUTIVO
    slide = pptx.addSlide();
    slide.addText('RESUMEN EJECUTIVO', {
      x: 0.5,
      y: 0.5,
      w: 9,
      h: 0.8,
      fontSize: 32,
      bold: true,
      color: 'FFFFFF'
    });
    
    const completed = currentProject.tasks.filter(t => t.status === 'completed').length;
    const total = currentProject.tasks.length;
    const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
    
    // Datos para tabla
    const summaryData = [
      ['M√©trica', 'Valor', 'Estado'],
      ['Tareas Totales', total, ''],
      ['Tareas Completadas', completed, `${progress}%`],
      ['Tareas en Progreso', currentProject.tasks.filter(t => t.status === 'inProgress').length, ''],
      ['Tareas Cr√≠ticas', currentProject.tasks.filter(t => t.critical).length, ''],
      ['Tiempo Total Estimado', `${currentProject.tasks.reduce((sum, t) => sum + (t.estimatedTime || 0), 0)}h`, ''],
      ['√öltima Actualizaci√≥n', new Date().toLocaleDateString(), '']
    ];
    
    slide.addTable(summaryData, {
      x: 0.5,
      y: 1.5,
      w: 9,
      colW: [3, 2, 2],
      border: { pt: 1, color: '8b5cf6' },
      fill: '1a1a3a',
      color: 'FFFFFF',
      fontSize: 14
    });
    
    // DETALLE DE TAREAS (m√°ximo 15 por slide)
    const tasksPerSlide = 15;
    for (let i = 0; i < currentProject.tasks.length; i += tasksPerSlide) {
      slide = pptx.addSlide();
      slide.addText(`DETALLE DE TAREAS (${i + 1}-${Math.min(i + tasksPerSlide, currentProject.tasks.length)})`, {
        x: 0.5,
        y: 0.5,
        w: 9,
        h: 0.8,
        fontSize: 28,
        bold: true,
        color: 'FFFFFF'
      });
      
      const taskSlice = currentProject.tasks.slice(i, i + tasksPerSlide);
      const taskData = taskSlice.map(task => [
        task.name.substring(0, 30) + (task.name.length > 30 ? '...' : ''),
        task.status,
        task.priority,
        `${task.progress || 0}%`,
        task.assignee || 'Sin asignar'
      ]);
      
      taskData.unshift(['Tarea', 'Estado', 'Prioridad', 'Progreso', 'Asignado']);
      
      slide.addTable(taskData, {
        x: 0.5,
        y: 1.5,
        w: 9,
        colW: [4, 1.5, 1.5, 1, 2],
        border: { pt: 1, color: '3b82f6' },
        fill: '0a0a1a',
        color: 'FFFFFF',
        fontSize: 12
      });
    }
    
    // GENERAR Y DESCARGAR
    const fileName = `Presentacion_${currentProject.name.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0,10)}.pptx`;
    
    pptx.writeFile({ fileName: fileName })
      .then(() => {
        console.log('‚úÖ PowerPoint exportado:', fileName);
        completeExport('PowerPoint', fileName);
      })
      .catch(error => {
        throw error;
      });
    
  } catch (error) {
    console.error('‚ùå Error exportando a PowerPoint:', error);
    alert('Error al exportar a PowerPoint: ' + error.message);
    closeFullExportMenu();
  }
};

// ========== 3. EXPORTAR A JSON (REAL) ==========
window.exportToJSONReal = function() {
  console.log('üîß Exportando a JSON REAL...');
  showExportProgress('JSON', 'Generando archivo .json...');
  
  try {
    const ganttContainer = document.getElementById('premiumExecutiveGantt');
    const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
    const currentProject = projects[projectIndex];
    
    // Datos completos del proyecto
    const exportData = {
      metadata: {
        exportDate: new Date().toISOString(),
        projectName: currentProject.name,
        exportVersion: '2.0',
        system: 'Gantt Executive Premium'
      },
      project: {
        ...currentProject,
        statistics: {
          totalTasks: currentProject.tasks.length,
          completedTasks: currentProject.tasks.filter(t => t.status === 'completed').length,
          inProgressTasks: currentProject.tasks.filter(t => t.status === 'inProgress').length,
          pendingTasks: currentProject.tasks.filter(t => t.status === 'pending').length,
          criticalTasks: currentProject.tasks.filter(t => t.critical).length,
          totalEstimatedTime: currentProject.tasks.reduce((sum, t) => sum + (t.estimatedTime || 0), 0),
          totalLoggedTime: currentProject.tasks.reduce((sum, t) => sum + (t.timeLogged || 0), 0),
          overallProgress: currentProject.tasks.length > 0 ? 
            Math.round(currentProject.tasks.reduce((sum, t) => sum + (t.progress || 0), 0) / currentProject.tasks.length) : 0
        }
      },
      dependencies: [],
      charts: {
        burndown: calculateBurndownFromTasks(currentProject.tasks || []),
        teamDistribution: generateTeamDistributionData(currentProject.tasks || [])
      }
    };
    
    // Procesar dependencias
    if (currentProject.tasks) {
      currentProject.tasks.forEach(task => {
        if (task.dependencies && task.dependencies.length > 0) {
          task.dependencies.forEach(depId => {
            const depTask = currentProject.tasks.find(t => t.id.toString() === depId.toString());
            if (depTask) {
              exportData.dependencies.push({
                from: depTask.name,
                fromId: depTask.id,
                to: task.name,
                toId: task.id,
                type: 'task_dependency'
              });
            }
          });
        }
      });
    }
    
    // Convertir a JSON con formato
    const jsonStr = JSON.stringify(exportData, null, 2);
    const blob = new Blob([jsonStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    // Descargar
    const fileName = `Datos_${currentProject.name.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0,10)}.json`;
    const link = document.createElement('a');
    link.href = url;
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    console.log('‚úÖ JSON exportado:', fileName);
    completeExport('JSON', fileName);
    
  } catch (error) {
    console.error('‚ùå Error exportando a JSON:', error);
    alert('Error al exportar a JSON: ' + error.message);
    closeFullExportMenu();
  }
};

// ========== 4. EXPORTAR A IMAGEN (REAL) ==========
// ========== 4. EXPORTAR A PDF (REAL) ==========
window.exportToPDFReal = function() {
  console.log('üìÑ Exportando a PDF...');
  showExportProgress('PDF', 'Generando documento PDF...');
  
  try {
    const ganttContainer = document.getElementById('premiumExecutiveGantt');
    const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
    const currentProject = projects[projectIndex];
    
    // Verificar si jsPDF est√° disponible
    if (typeof window.jspdf === 'undefined' && typeof window.jsPDF === 'undefined') {
      throw new Error('Biblioteca jsPDF no cargada');
    }
    
    // Crear PDF
    const { jsPDF } = window.jspdf || window;
    const doc = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: 'a4'
    });
    
    // Configuraci√≥n
    doc.setProperties({
      title: `Reporte Gantt - ${currentProject.name}`,
      subject: 'Diagrama de Gantt Ejecutivo',
      author: 'Sistema de Gesti√≥n de Proyectos',
      keywords: 'gantt, proyecto, tareas, gesti√≥n',
      creator: 'Gantt Executive Premium'
    });
    
    // ===== PORTADA =====
    doc.setFillColor(10, 10, 26);
    doc.rect(0, 0, 210, 297, 'F');
    
    // Logo/t√≠tulo
    doc.setTextColor(139, 92, 246);
    doc.setFontSize(36);
    doc.setFont('helvetica', 'bold');
    doc.text('GANTT EXECUTIVE', 105, 60, { align: 'center' });
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(24);
    doc.text('REPORTE DE PROYECTO', 105, 80, { align: 'center' });
    
    // Nombre del proyecto
    doc.setTextColor(59, 130, 246);
    doc.setFontSize(28);
    doc.text(currentProject.name, 105, 110, { align: 'center' });
    
    // Informaci√≥n
    doc.setTextColor(148, 163, 184);
    doc.setFontSize(12);
    doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 105, 130, { align: 'center' });
    doc.text(`Generado: ${new Date().toLocaleTimeString()}`, 105, 140, { align: 'center' });
    
    // Estad√≠sticas
    const completed = currentProject.tasks.filter(t => t.status === 'completed').length;
    const total = currentProject.tasks.length;
    const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
    
    doc.text(`Tareas: ${total} ‚Ä¢ Completadas: ${completed} (${progress}%)`, 105, 155, { align: 'center' });
    
    // Separador
    doc.setDrawColor(139, 92, 246);
    doc.setLineWidth(0.5);
    doc.line(30, 170, 180, 170);
    
    // ===== P√ÅGINA 2: RESUMEN EJECUTIVO =====
    doc.addPage();
    
    // Encabezado de p√°gina
    doc.setFillColor(26, 26, 58);
    doc.rect(0, 0, 210, 40, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(20);
    doc.text('RESUMEN EJECUTIVO', 105, 25, { align: 'center' });
    
    doc.setTextColor(148, 163, 184);
    doc.setFontSize(10);
    doc.text(currentProject.name, 105, 35, { align: 'center' });
    
    // Contenido
    let y = 60;
    
    // M√©tricas principales
    const metrics = [
      { label: 'Tareas Totales', value: total, color: '#3b82f6' },
      { label: 'Tareas Completadas', value: `${completed} (${progress}%)`, color: '#10b981' },
      { label: 'Tareas en Progreso', value: currentProject.tasks.filter(t => t.status === 'inProgress').length, color: '#008090' },
      { label: 'Tareas Pendientes', value: currentProject.tasks.filter(t => t.status === 'pending').length, color: '#94a3b8' },
      { label: 'Tareas Cr√≠ticas', value: currentProject.tasks.filter(t => t.critical).length, color: '#ef4444' },
      { label: 'Tiempo Total Estimado', value: `${currentProject.tasks.reduce((sum, t) => sum + (t.estimatedTime || 0), 0)} horas`, color: '#8b5cf6' },
      { label: 'Tiempo Total Registrado', value: `${currentProject.tasks.reduce((sum, t) => sum + (t.timeLogged || 0), 0)} horas`, color: '#8b5cf6' }
    ];
    
    metrics.forEach((metric, i) => {
      // Fondo alternado
      if (i % 2 === 0) {
        doc.setFillColor(245, 245, 245);
        doc.rect(20, y - 8, 170, 12, 'F');
      }
      
      // Texto
      doc.setTextColor(30, 41, 59);
      doc.setFontSize(12);
      doc.setFont('helvetica', 'bold');
      doc.text(metric.label, 25, y);
      
      // Valor con color
      const rgb = hexToRgb(metric.color);
      doc.setTextColor(rgb.r, rgb.g, rgb.b);
      doc.setFont('helvetica', 'normal');
      doc.text(metric.value.toString(), 150, y, { align: 'right' });
      
      y += 15;
    });
    
    // Descripci√≥n del proyecto
    y += 10;
    doc.setTextColor(30, 41, 59);
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text('Descripci√≥n del Proyecto', 25, y);
    
    y += 8;
    doc.setFontSize(11);
    doc.setFont('helvetica', 'normal');
    const description = currentProject.description || 'Proyecto gestionado con Gantt Executive Premium.';
    const splitDescription = doc.splitTextToSize(description, 160);
    doc.text(splitDescription, 25, y);
    
    // ===== P√ÅGINA 3: DETALLE DE TAREAS =====
    doc.addPage();
    
    // Encabezado de p√°gina
    doc.setFillColor(26, 26, 58);
    doc.rect(0, 0, 210, 40, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(20);
    doc.text('DETALLE DE TAREAS', 105, 25, { align: 'center' });
    
    // Tabla de tareas
    y = 50;
    
    // Encabezado de tabla
    doc.setFillColor(59, 130, 246);
    doc.rect(15, y - 8, 180, 10, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    
    const headers = ['#', 'TAREA', 'ESTADO', 'PROGRESO', 'ASIGNADO'];
    const headerX = [20, 35, 110, 140, 160];
    
    headers.forEach((header, i) => {
      doc.text(header, headerX[i], y);
    });
    
    y += 15;
    
    // Filas de tareas (m√°ximo 20 por p√°gina)
    const tasksToShow = currentProject.tasks.slice(0, 30); // Mostrar primeras 30
    
    tasksToShow.forEach((task, i) => {
      // Si nos quedamos sin espacio, nueva p√°gina
      if (y > 270) {
        doc.addPage();
        y = 40;
        
        // Encabezado de tabla en nueva p√°gina
        doc.setFillColor(59, 130, 246);
        doc.rect(15, y - 8, 180, 10, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        headers.forEach((header, idx) => {
          doc.text(header, headerX[idx], y);
        });
        y += 15;
      }
      
      // Fondo alternado
      if (i % 2 === 0) {
        doc.setFillColor(248, 250, 252);
        doc.rect(15, y - 6, 180, 10, 'F');
      }
      
      // N√∫mero
      doc.setTextColor(30, 41, 59);
      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      doc.text((i + 1).toString(), 20, y);
      
      // Nombre de tarea (recortado si es muy largo)
      const taskName = task.name.length > 35 ? task.name.substring(0, 32) + '...' : task.name;
      doc.text(taskName, 35, y);
      
      // Estado con color
      const statusColor = getStatusColor(task.status);
      const statusRGB = hexToRgb(statusColor);
      doc.setTextColor(statusRGB.r, statusRGB.g, statusRGB.b);
      doc.text(task.status || 'pending', 110, y);
      
      // Progreso
      doc.setTextColor(245, 158, 11);
      doc.text(`${task.progress || 0}%`, 140, y);
      
      // Asignado
      doc.setTextColor(100, 116, 139);
      const assignee = task.assignee || 'Sin asignar';
      const shortAssignee = assignee.length > 15 ? assignee.substring(0, 12) + '...' : assignee;
      doc.text(shortAssignee, 160, y);
      
      y += 12;
    });
    



const progressRounded = Math.round(progress);

    // ===== P√ÅGINA 4: AN√ÅLISIS Y RECOMENDACIONES =====
    if (currentProject.tasks.length > 0) {
      doc.addPage();
      
      // Encabezado
      doc.setFillColor(26, 26, 58);
      doc.rect(0, 0, 210, 40, 'F');
      
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(20);
      doc.text('AN√ÅLISIS Y RECOMENDACIONES', 105, 25, { align: 'center' });
      
      y = 60;
      
      // An√°lisis de progreso
      doc.setTextColor(30, 41, 59);
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('An√°lisis de Progreso', 25, y);
      
      y += 10;
      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      
      let analysisText = '';
      if (progress >= 80) {
        analysisText = `El proyecto "${currentProject.name}" est√° avanzando excelentemente con un ${progressRounded}% de completitud. El equipo est√° superando las expectativas y todas las m√©tricas est√°n en verde.`;
      } else if (progress >= 50) {
        analysisText = `El proyecto "${currentProject.name}" tiene un progreso moderado (${progressRounded}%). Se requiere atenci√≥n en las tareas pendientes y cr√≠ticas para mantener el cronograma.`;
      } else {
        analysisText = `El proyecto "${currentProject.name}" necesita intervenci√≥n. Con solo ${progressRounded}% de completitud, se recomienda revisar recursos, alcance y cronograma.`;
      }
      
      const splitAnalysis = doc.splitTextToSize(analysisText, 160);
      doc.text(splitAnalysis, 25, y);
      
      // Recomendaciones
      y += splitAnalysis.length * 5 + 15;
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('Recomendaciones', 25, y);
      
      y += 10;
      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      
      const recommendations = generateRecommendations(currentProject);
      recommendations.forEach((rec, i) => {
        const bullet = `${i + 1}. ${rec}`;
        const splitRec = doc.splitTextToSize(bullet, 160);
        doc.text(splitRec, 25, y);
        y += splitRec.length * 5 + 5;
      });
      
      // Notas finales
      y += 10;
      doc.setFontSize(10);
      doc.setTextColor(100, 116, 139);
      doc.text('Documento generado autom√°ticamente por Gantt Executive Premium', 105, 280, { align: 'center' });
      doc.text('Sistema de Gesti√≥n de Proyectos - Todos los derechos reservados', 105, 285, { align: 'center' });
    }
    
    // ===== GUARDAR PDF =====
    const fileName = `Reporte_Gantt_${currentProject.name.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0,10)}.pdf`;
    doc.save(fileName);
    
    console.log('‚úÖ PDF exportado:', fileName);
    completeExport('PDF', fileName);
    
  } catch (error) {
    console.error('‚ùå Error exportando a PDF:', error);
    alert('Error al exportar a PDF: ' + error.message);
    closeFullExportMenu();
  }
};

// Funci√≥n auxiliar para convertir hex a RGB
function hexToRgb(hex) {
  // Eliminar el # si existe
  hex = hex.replace('#', '');
  
  // Convertir a RGB
  const r = parseInt(hex.substring(0, 2), 16);
  const g = parseInt(hex.substring(2, 4), 16);
  const b = parseInt(hex.substring(4, 6), 16);
  
  return { r, g, b };
}

// Funci√≥n para obtener color seg√∫n estado
function getStatusColor(status) {
  const colors = {
    'completed': '#10b981',
    'inProgress': '#3b82f6',
    'pending': '#f59e0b',
    'overdue': '#ef4444'
  };
  return colors[status] || '#94a3b8';
}

// Funci√≥n para generar recomendaciones
function generateRecommendations(project) {
  const recommendations = [];
  const completed = project.tasks.filter(t => t.status === 'completed').length;
  const total = project.tasks.length;
  const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
  const criticalTasks = project.tasks.filter(t => t.critical).length;
  
  if (progress < 50) {
    recommendations.push('Revisar asignaci√≥n de recursos del equipo');
    recommendations.push('Considerar extensi√≥n de plazo o reducci√≥n de alcance');
    recommendations.push('Priorizar tareas cr√≠ticas inmediatamente');
  } else if (progress < 80) {
    recommendations.push('Mantener reuniones de seguimiento semanales');
    recommendations.push('Monitorear tareas cr√≠ticas de cerca');
    recommendations.push('Actualizar estimaciones de tiempo restante');
  } else {
    recommendations.push('Mantener el ritmo actual de trabajo');
    recommendations.push('Documentar lecciones aprendidas');
    recommendations.push('Planificar fase de cierre del proyecto');
  }
  
  if (criticalTasks > 0) {
    recommendations.push(`Asignar recursos senior a las ${criticalTasks} tareas cr√≠ticas`);
  }
  
  const overdueTasks = project.tasks.filter(t => t.status === 'overdue').length;
  if (overdueTasks > 0) {
    recommendations.push(`Revisar urgentemente las ${overdueTasks} tareas atrasadas`);
  }
  
  return recommendations;
}
// ========== FUNCIONES AUXILIARES ==========
function generateTeamDistributionData(tasks) {
  const members = {};
  tasks.forEach(task => {
    const assignee = task.assignee || 'Sin asignar';
    if (!members[assignee]) {
      members[assignee] = {
        name: assignee,
        taskCount: 0,
        totalEstimatedTime: 0,
        totalLoggedTime: 0
      };
    }
    members[assignee].taskCount++;
    members[assignee].totalEstimatedTime += task.estimatedTime || 0;
    members[assignee].totalLoggedTime += task.timeLogged || 0;
  });
  
  return Object.values(members);
}

// ========== AN√ÅLISIS R√ÅPIDO - VERSI√ìN DEL MEN√ö LATERAL ==========
window.runAIAnalysisPremium = function() {
  console.log('‚ö° EJECUTANDO AN√ÅLISIS R√ÅPIDO...');
  
  // Verificar si hay un Gantt activo
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) {
    console.warn('‚ö†Ô∏è No se encontr√≥ el contenedor Gantt');
    // Intentar crear uno si no existe
    if (typeof createCompleteGanttForCurrentProject === 'function') {
      createCompleteGanttForCurrentProject();
      setTimeout(() => {
        runAIAnalysisPremium(); // Reintentar despu√©s de crear
      }, 1000);
    } else {
      showNotification('‚ö†Ô∏è Abre el Gantt Ejecutivo primero');
    }
    return;
  }
  
  // Obtener proyecto actual
  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  if (!projects || !projects[projectIndex]) {
    showNotification('‚ùå No hay proyectos cargados');
    return;
  }
  
  const project = projects[projectIndex];
  const tasks = project?.tasks || [];
  
  if (!tasks || tasks.length === 0) {
    showNotification('üìù No hay tareas para analizar');
    return;
  }
  
  console.log(`üìä Analizando ${tasks.length} tareas del proyecto: ${project.name}`);
  
  // An√°lisis r√°pido (m√©tricas clave)
  const quickAnalysis = performQuickAnalysis(tasks);
  
  // Mostrar resultados en un overlay flotante
  showQuickAnalysisOverlay(quickAnalysis, project.name);
};

// ========== FUNCI√ìN DE AN√ÅLISIS R√ÅPIDO ==========
function performQuickAnalysis(tasks) {
  console.log('üßÆ Calculando an√°lisis r√°pido...');
  
  const total = tasks.length;
  const completed = tasks.filter(t => t.status === 'completed').length;
  
  // Detecci√≥n mejorada de tareas cr√≠ticas
  const critical = tasks.filter(task => {
    if (task.critical === true) return true;
    if (task.priority === 'alta' || task.priority === 'high') return true;
    if (task.status === 'overdue') return true;
    
    // Verificar por fecha cercana al deadline
    if (task.deadline) {
      try {
        const deadline = new Date(task.deadline);
        const today = new Date();
        const daysDiff = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
        if (daysDiff <= 3 && task.status !== 'completed') return true;
      } catch (e) {
        console.warn('Error parseando fecha:', e);
      }
    }
    
    return false;
  }).length;
  
  const inProgress = tasks.filter(t => t.status === 'inProgress').length;
  const pending = tasks.filter(t => t.status === 'pending').length;
  
  const completionRate = total > 0 ? (completed / total) * 100 : 0;
  
  // Determinar estado del proyecto
  let status, statusColor, statusIcon, message;
  
  if (completionRate >= 80) {
    status = 'EXCELENTE';
    statusColor = '#2ecc71';
    statusIcon = '‚úÖ';
    message = 'El proyecto avanza a muy buen ritmo. Mant√©n el enfoque actual.';
  } else if (completionRate >= 50) {
    status = 'EN CAMINO';
    statusColor = '#3498db';
    statusIcon = 'üìà';
    message = 'Progreso constante. Algunas √°reas podr√≠an optimizarse.';
  } else if (completionRate >= 30) {
    status = 'ATENCI√ìN';
    statusColor = '#f39c12';
    statusIcon = '‚ö†Ô∏è';
    message = 'Progreso lento. Considera revisar asignaciones y prioridades.';
  } else {
    status = 'RIESGO';
    statusColor = '#e74c3c';
    statusIcon = 'üö®';
    message = 'Progreso insuficiente. Se requiere intervenci√≥n inmediata.';
  }
  
  // Recomendaci√≥n principal basada en el an√°lisis
  let recommendedAction;
  
  if (critical > 0 && completed < total * 0.3) {
    recommendedAction = `Enf√≥cate en las ${critical} tarea${critical !== 1 ? 's' : ''} cr√≠tica${critical !== 1 ? 's' : ''} primero`;
  } else if (inProgress > total * 0.6) {
    recommendedAction = 'Reduce tareas en progreso para mejorar el enfoque del equipo';
  } else if (pending > total * 0.5) {
    recommendedAction = 'Muchas tareas pendientes - considera asignar m√°s recursos';
  } else if (completionRate < 50) {
    recommendedAction = 'Revisa las tareas pendientes y reasigna prioridades';
  } else {
    recommendedAction = 'Contin√∫a con el plan actual - buen trabajo del equipo';
  }
  
  return {
    total,
    completed,
    critical,
    inProgress,
    pending,
    completionRate: Math.round(completionRate),
    status,
    statusColor,
    statusIcon,
    message,
    recommendedAction,
    timestamp: new Date().toISOString()
  };
}






window.filterCriticalTasksPremium = function() {
  alert('üî¥ Filtrando tareas cr√≠ticas...');
};

window.filterDelayedTasksPremium = function() {
  alert('‚ö° Filtrando tareas atrasadas...');
};

window.filterByTeamPremium = function() {
  alert('üë• Filtrando por equipo...');
};

window.filterByBudgetPremium = function() {
  alert('üí∞ Filtrando por presupuesto...');
};

window.showAllTasksPremium = function() {
  alert('üìã Mostrando todas las tareas...');
};

window.showPremiumTaskDetails = function(taskId) {
  const container = document.getElementById('premiumExecutiveGantt');
  const tasks = container ? JSON.parse(container.dataset.tasks || '[]') : [];
  const task = tasks.find(t => t.id.toString() === taskId.toString());
  
  if (task) {
    alert(`üìã ${task.name}\n\nProgreso: ${task.progress}%\nDuraci√≥n: ${task.duration} d√≠as\nEstado: ${task.status}\nPrioridad: ${task.priority}\nAsignado: ${task.team[0]}\n${task.critical ? 'üî• TAREA CR√çTICA' : ''}`);
  }
};

window.updatePremiumTaskProgress = function(taskId) {
  const newProgress = prompt('Ingrese nuevo progreso (0-100%):');
  if (newProgress !== null && !isNaN(newProgress)) {
    const progress = Math.min(100, Math.max(0, parseInt(newProgress)));
    alert(`Progreso actualizado a ${progress}%`);
  }
};

window.openDependencyCreator = function() {
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;
  
  // OBTENER EL PROYECTO ACTUAL CORRECTAMENTE
  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  
  // Verificar que el proyecto existe
  if (projectIndex >= projects.length || projectIndex < 0) {
    alert('Error: Proyecto no v√°lido.');
    return;
  }
  
  const currentProject = projects[projectIndex];
  const currentTasks = currentProject.tasks || [];
  
  console.log('üîç Abriendo creador de dependencias para proyecto:', currentProject.name);
  console.log('üìã Tareas del proyecto actual:', currentTasks.length);
  
  if (currentTasks.length === 0) {
    alert('No hay tareas disponibles para crear dependencias.');
    return;
  }
  
  // Crear overlay
  const overlay = document.createElement('div');
  overlay.className = 'dependency-overlay';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(5px);
    z-index: 1000000;
  `;
  overlay.onclick = closeDependencyCreator;
  
  // Crear modal
  const modal = document.createElement('div');
  modal.className = 'dependency-modal';
  modal.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 600px;
    background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
    border-radius: 20px;
    padding: 30px;
    z-index: 1000001;
    box-shadow: 0 30px 60px rgba(0,0,0,0.8);
    border: 2px solid rgba(155, 89, 182, 0.4);
    color: white;
  `;
  
  // Transformar tareas para mostrar (igual que en el Gantt)
  const transformedTasks = currentTasks.map((task, index) => {
    const statusColors = {
      'pending': '#f1c40f',
      'inProgress': '#3498db', 
      'completed': '#2ecc71',
      'overdue': '#e74c3c'
    };
    
    const isCritical = task.priority === 'alta' || task.status === 'overdue';
    
    return {
      id: task.id || Date.now() + index,
      name: task.name || `Tarea ${index + 1}`,
      color: statusColors[task.status] || '#95a5a6',
      critical: isCritical,
      dependencies: task.dependencies || [],
      status: task.status || 'pending',
      priority: task.priority || 'media',
      originalTask: task
    };
  });
  
// CORRECCI√ìN: Construcci√≥n correcta de dependencias existentes
const existingDependencies = [];

currentTasks.forEach(task => {
  const toId = task.id;
  const deps = Array.isArray(task.dependencies) ? task.dependencies : [];

  deps.forEach(fromId => {
    const fromTask = transformedTasks.find(t => t.id.toString() === fromId.toString());
    const toTask = transformedTasks.find(t => t.id.toString() === toId.toString());

    if (fromTask && toTask) {
      existingDependencies.push({
        from: fromTask,
        to: toTask,
        fromId,
        toId
      });
    }
  });
});



// SINCRONIZAR TODAS LAS DEPENDENCIAS AL ESTADO GLOBAL
window.currentDependencies = existingDependencies.map(dep => ({
    fromId: dep.fromId,
    toId: dep.toId
}));
console.log("üåê currentDependencies cargadas:", window.currentDependencies);




  modal.innerHTML = `
    <h3 style="color: #9b59b6; margin-top: 0; margin-bottom: 20px; text-align: center;">
      üîó Gestor de Dependencias - ${currentProject.name}
    </h3>
    
    <div style="margin-bottom: 15px; color: #95a5a6; text-align: center;">
      Proyecto actual: <strong style="color: #2ecc71;">${currentProject.name}</strong>
      <br>Tareas disponibles: <strong>${transformedTasks.length}</strong>
    </div>
    
    <div style="display: flex; gap: 15px; margin-bottom: 25px; align-items: center;">
      <select id="fromTaskSelect" style="
        flex: 1;
        padding: 12px;
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(155, 89, 182, 0.3);
        border-radius: 8px;
        color: white;
        font-size: 14px;
      ">
        <option value="">Seleccionar tarea origen</option>
        ${transformedTasks.map((task, index) => `
          <option value="${task.id}">${index + 1}. ${task.name}</option>
        `).join('')}
      </select>
      
      <div style="color: #9b59b6; font-size: 18px; margin: 0 10px;">‚û°</div>
      
      <select id="toTaskSelect" style="
        flex: 1;
        padding: 12px;
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(155, 89, 182, 0.3);
        border-radius: 8px;
        color: white;
        font-size: 14px;
      ">
        <option value="">Seleccionar tarea destino</option>
        ${transformedTasks.map((task, index) => `
          <option value="${task.id}">${index + 1}. ${task.name}</option>
        `).join('')}
      </select>
      
      <button onclick="addNewDependency()" style="
        background: linear-gradient(45deg, #9b59b6, #8e44ad);
        border: none;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 8px;
      ">
        ‚ûï Agregar
      </button>
    </div>
    
    <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; margin-bottom: 25px; border: 1px solid rgba(155, 89, 182, 0.2);">
      <h4 style="color: #9b59b6; margin-top: 0; margin-bottom: 15px;">Dependencias Actuales</h4>
      <div id="dependenciesList">
        ${existingDependencies.length > 0 ? 
          existingDependencies.map(dep => `
           <div class="dependency-item"
     data-from-id="${dep.fromId}"
     data-to-id="${dep.toId}"
     style="
       display: flex;
       align-items: center;
       justify-content: space-between;
       padding: 10px 15px;
       background: rgba(155, 89, 182, 0.1);
       border-radius: 8px;
       margin-bottom: 10px;
     ">

              <div style="display: flex; align-items: center; gap: 10px;">
                <div style="
                  width: 24px;
                  height: 24px;
                  background: ${dep.from.color || '#9b59b6'};
                  border-radius: 6px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  color: white;
                  font-size: 12px;
                  font-weight: bold;
                ">
                  ${transformedTasks.findIndex(t => t.id.toString() === dep.fromId.toString()) + 1}
                </div>
                <span style="font-weight: bold; color: white;">${dep.from.name}</span>
                <span style="color: #9b59b6; font-size: 18px; margin: 0 10px;">‚û°</span>
                <div style="
                  width: 24px;
                  height: 24px;
                  background: ${dep.to.color || '#3498db'};
                  border-radius: 6px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  color: white;
                  font-size: 12px;
                  font-weight: bold;
                ">
                  ${transformedTasks.findIndex(t => t.id.toString() === dep.toId.toString()) + 1}
                </div>
                <span style="color: white;">${dep.to.name}</span>
              </div>
              <div style="display: flex; gap: 8px;">
                <button onclick="removeExistingDependency('${dep.fromId}', '${dep.toId}', ${projectIndex})" style="
                  width: 30px;
                  height: 30px;
                  border-radius: 6px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  cursor: pointer;
                  border: none;
                  font-size: 14px;
                  background: rgba(231, 76, 60, 0.2);
                  color: #e74c3c;
                " title="Eliminar">
                  üóëÔ∏è
                </button>
              </div>
            </div>
          `).join('') : 
          '<div style="color: #95a5a6; text-align: center; padding: 20px; font-style: italic;">No hay dependencias definidas</div>'
        }
      </div>
    </div>
    
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div style="color: #95a5a6; font-size: 13px;">
        ${existingDependencies.length} dependencia(s) definida(s)
      </div>
      <div style="display: flex; gap: 10px;">
        <button onclick="closeDependencyCreator()" style="
          background: rgba(255,255,255,0.1);
          border: 1px solid rgba(255,255,255,0.3);
          color: white;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
        ">
          Cancelar
        </button>
        <button onclick="saveDependencies(${projectIndex})" style="
          background: linear-gradient(45deg, #2ecc71, #27ae60);
          border: none;
          color: white;
          padding: 10px 30px;
          border-radius: 8px;
          cursor: pointer;
          font-weight: bold;
        ">
          üíæ Guardar Cambios
        </button>
      </div>
    </div>
  `;
  
  // Guardar datos en el modal para uso posterior
  modal.dataset.projectIndex = projectIndex;
  modal.dataset.tasks = JSON.stringify(transformedTasks);
  modal.dataset.originalTasks = JSON.stringify(currentTasks);
  
  document.body.appendChild(overlay);
  document.body.appendChild(modal);
};

// ========== FUNCIONES PARA EL MODAL DE DEPENDENCIAS ==========

// Funci√≥n para cerrar el modal de dependencias
window.closeDependencyCreator = function() {
  console.log('üîí Cerrando creador de dependencias...');
  const overlay = document.querySelector('.dependency-overlay');
  const modal = document.querySelector('.dependency-modal');
  
  if (overlay) overlay.remove();
  if (modal) modal.remove();
  
  console.log('‚úÖ Modal de dependencias cerrado');
};

// Funci√≥n para verificar dependencias c√≠clicas
function checkCyclicDependency(tasks, fromId, toId) {
  console.log(`üîç Verificando ciclo: ${fromId} -> ${toId}`);
  
  const visited = new Set();
  
  function hasPath(currentId, targetId) {
    if (currentId.toString() === targetId.toString()) return true;
    if (visited.has(currentId)) return false;
    
    visited.add(currentId);
    
    const currentTask = tasks.find(t => t.id.toString() === currentId.toString());
    if (!currentTask || !currentTask.dependencies) return false;
    
    for (const depId of currentTask.dependencies) {
      if (hasPath(depId, targetId)) return true;
    }
    
    return false;
  }
  
  return hasPath(toId, fromId);
}

// Funci√≥n para eliminar dependencias existentes
window.removeExistingDependency = function(fromId, toId, projectIndex) {
  console.log(`üóëÔ∏è Eliminando dependencia: ${fromId} -> ${toId}`);
  
  if (projectIndex >= projects.length || projectIndex < 0) {
    console.error('√çndice de proyecto inv√°lido');
    return;
  }
  
  const currentProject = projects[projectIndex];
  const task = currentProject.tasks.find(t => t.id.toString() === toId.toString());
  
  if (task && task.dependencies) {
    const index = task.dependencies.findIndex(dep => dep.toString() === fromId.toString());
    if (index !== -1) {
      task.dependencies.splice(index, 1);
      console.log(`‚úÖ Dependencia eliminada de "${task.name}"`);
      
      // Actualizar lista visual
      const dependencyItem = document.querySelector(`.dependency-item[data-from-id="${fromId}"][data-to-id="${toId}"]`);
      if (dependencyItem) {
        dependencyItem.remove();
      }
      
      // Si no quedan dependencias, mostrar mensaje
      const dependenciesList = document.getElementById('dependenciesList');
      if (dependenciesList && dependenciesList.children.length === 0) {
        dependenciesList.innerHTML = '<div style="color: #95a5a6; text-align: center; padding: 20px; font-style: italic;">No hay dependencias definidas</div>';
      }
    }
  }
};

// Funci√≥n para eliminar dependencias nuevas (a√∫n no guardadas)
window.removeNewDependency = function(button) {
  console.log('üóëÔ∏è Eliminando dependencia nueva...');
  const dependencyItem = button.closest('.dependency-item');
  if (dependencyItem) {
    dependencyItem.remove();
    
    // Si no quedan dependencias, mostrar mensaje
    const dependenciesList = document.getElementById('dependenciesList');
    if (dependenciesList && dependenciesList.children.length === 0) {
      dependenciesList.innerHTML = '<div style="color: #95a5a6; text-align: center; padding: 20px; font-style: italic;">No hay dependencias definidas</div>';
    }
  }
};

// Funci√≥n para refrescar la vista Gantt
// üîí Guardar referencia global a observers (si existen)
window.__originalObservers = window.__originalObservers || [];

function refreshGanttView() {
    console.log('üîÑ Refrescando vista Gantt...');

    // üîí Activar bandera
    isRefreshingGantt = true;

    const ganttContainer = document.getElementById('premiumExecutiveGantt');
    if (!ganttContainer) {
        isRefreshingGantt = false;
        console.log('‚ÑπÔ∏è No hay Gantt activo para refrescar');
        return;
    }

    const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;

    // ‚úÖ NO eliminar el contenedor, solo limpiarlo
    ganttContainer.innerHTML = `
        <div style="
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 10, 26, 0.95);
            display: flex; align-items: center; justify-content: center;
            color: #a78bfa; font-size: 16px; z-index: 999999;
        ">üîÑ Actualizando diagrama...</div>
    `;

    setTimeout(() => {
        try {
            ganttContainer.innerHTML = ''; // limpiar loader
            currentProjectIndex = projectIndex;
            createCompleteGanttForCurrentProject(); // esto recrear√° el contenido DENTRO del mismo contenedor
            console.log('‚úÖ Gantt refrescado exitosamente');
        } catch (error) {
            console.error('‚ùå Error al refrescar Gantt:', error);
        } finally {
            // üîì Desactivar bandera
            setTimeout(() => {
                isRefreshingGantt = false;
                // Aplicar estilos una vez m√°s para asegurar vista completa
                applyFullViewStyles();
            }, 300);
        }
    }, 150);
}



// ========== FUNCI√ìN PARA AGREGAR NUEVA DEPENDENCIA - CORREGIDA ==========
window.addNewDependency = function() {
  const modal = document.querySelector('.dependency-modal');
  if (!modal) return;
  
  const fromSelect = document.getElementById('fromTaskSelect');
  const toSelect = document.getElementById('toTaskSelect');
  
  const fromId = fromSelect.value;
  const toId = toSelect.value;
  
  console.log('‚ûï Intentando agregar dependencia:', { fromId, toId });
  
  if (!fromId || !toId) {
    alert('Por favor selecciona ambas tareas.');
    return;
  }
  
  if (fromId === toId) {
    alert('Una tarea no puede depender de s√≠ misma.');
    return;
  }
  
  // Obtener tareas del modal
  const tasks = JSON.parse(modal.dataset.tasks || '[]');
  
  // Encontrar las tareas
  const fromTask = tasks.find(t => t.id.toString() === fromId.toString());
  const toTask = tasks.find(t => t.id.toString() === toId.toString());
  
  console.log('üîç Tareas encontradas:', { fromTask, toTask });
  
  if (!fromTask || !toTask) {
    alert('Error: No se encontraron las tareas seleccionadas.');
    return;
  }
  
  // Verificar si la dependencia ya existe
  if (toTask.dependencies && toTask.dependencies.includes(fromId)) {
    alert('Esta dependencia ya existe.');
    return;
  }
  
  // Verificar dependencias c√≠clicas
  if (checkCyclicDependency(tasks, toId, fromId)) {
    alert('No se puede crear esta dependencia porque crear√≠a un ciclo.');
    return;
  }
  
  const fromIndex = tasks.findIndex(t => t.id.toString() === fromId.toString()) + 1;
  const toIndex = tasks.findIndex(t => t.id.toString() === toId.toString()) + 1;
  
  const dependencyItem = document.createElement('div');
  dependencyItem.className = 'dependency-item';
  dependencyItem.style.cssText = `
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 15px;
    background: rgba(155, 89, 182, 0.1);
    border-radius: 8px;
    margin-bottom: 10px;
  `;
  dependencyItem.innerHTML = `
    <div style="display: flex; align-items: center; gap: 10px;">
      <div style="
        width: 24px;
        height: 24px;
        background: ${fromTask.color || '#9b59b6'};
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: bold;
      ">
        ${fromIndex}
      </div>
      <span style="font-weight: bold; color: white;">${fromTask.name}</span>
      <span style="color: #9b59b6; font-size: 18px; margin: 0 10px;">‚û°</span>
      <div style="
        width: 24px;
        height: 24px;
        background: ${toTask.color || '#3498db'};
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: bold;
      ">
        ${toIndex}
      </div>
      <span style="color: white;">${toTask.name}</span>
    </div>
    <div style="display: flex; gap: 8px;">
      <button onclick="removeNewDependency(this)" style="
        width: 30px;
        height: 30px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: none;
        font-size: 14px;
        background: rgba(231, 76, 60, 0.2);
        color: #e74c3c;
      " title="Eliminar">
        üóëÔ∏è
      </button>
    </div>
  `;
  
  dependencyItem.dataset.fromId = fromId;
  dependencyItem.dataset.toId = toId;
  
  const dependenciesList = document.getElementById('dependenciesList');
  
  // Si no hay dependencias, limpiar el mensaje
  if (dependenciesList.firstChild && 
      dependenciesList.firstChild.style && 
      dependenciesList.firstChild.style.color === 'rgb(149, 165, 166)') {
    dependenciesList.innerHTML = '';
  }
  
  dependenciesList.appendChild(dependencyItem);
  
  console.log('‚úÖ Dependencia agregada visualmente');
  

// üî• Actualizar el estado global de dependencias
window.currentDependencies.push({ 
    fromId: fromId, 
    toId: toId 
});
console.log("üåê Estado actualizado:", window.currentDependencies);




  // Limpiar selecciones
  fromSelect.value = '';
  toSelect.value = '';
};

// ========== FUNCI√ìN PARA GUARDAR DEPENDENCIAS - CORREGIDA ==========
// ========== FUNCI√ìN PARA GUARDAR DEPENDENCIAS - VERSI√ìN CORREGIDA ==========
window.saveDependencies = function(projectIndex) {
  console.log('üíæ GUARDANDO DEPENDENCIAS...');
  console.log('Project index:', projectIndex);
  
  const modal = document.querySelector('.dependency-modal');
  if (!modal) {
    console.error('‚ùå No hay modal abierto');
    return;
  }
  
  if (projectIndex >= projects.length || projectIndex < 0) {
    alert('Error: Proyecto no v√°lido.');
    return;
  }
  
  const currentProject = projects[projectIndex];
  const currentTasks = currentProject.tasks || [];
  
  console.log(`üìä Proyecto: ${currentProject.name}`);
  console.log(`üìã Tareas totales: ${currentTasks.length}`);
  
  // 1. LIMPIAR TODAS LAS DEPENDENCIAS EXISTENTES
  console.log('üßπ Limpiando dependencias existentes...');
  currentTasks.forEach(task => {
    if (task.dependencies && task.dependencies.length > 0) {
      console.log(`  Limpiando ${task.dependencies.length} dependencias de "${task.name}"`);
      task.dependencies = [];
    }
  });
  
  // 2. OBTENER NUEVAS DEPENDENCIAS DEL MODAL
  const dependenciesList = document.getElementById('dependenciesList');
  const newDependencies = [];
  
  if (dependenciesList) {
    dependenciesList.querySelectorAll('.dependency-item').forEach(item => {
      const fromId = item.dataset.fromId;
      const toId = item.dataset.toId;
      
      if (fromId && toId) {
        newDependencies.push({ fromId, toId });
        console.log(`üìù Nueva dependencia: ${fromId} -> ${toId}`);
      }
    });
  }
  
  console.log(`üì¶ Total de nuevas dependencias: ${newDependencies.length}`);
  
  // 3. APLICAR NUEVAS DEPENDENCIAS
  if (newDependencies.length > 0) {
    newDependencies.forEach(dep => {
      const fromId = dep.fromId.toString();
      const toId = dep.toId.toString();
      
      // Buscar la tara DESTINO (la que depende de la otra)
      const toTask = currentTasks.find(t => t.id && t.id.toString() === toId);
      
      if (toTask) {
        // Inicializar array si no existe
        if (!Array.isArray(toTask.dependencies)) {
          toTask.dependencies = [];
        }
        
        // Evitar duplicados
        if (!toTask.dependencies.includes(fromId)) {
          toTask.dependencies.push(fromId);
          console.log(`‚úÖ A√±adida dependencia a "${toTask.name}": depende de ${fromId}`);
        }
      } else {
        console.warn(`‚ö†Ô∏è No se encontr√≥ tarea destino con ID: ${toId}`);
      }
    });
  }
  
  // 4. MOSTRAR RESULTADO FINAL
  console.log('=== DEPENDENCIAS FINALES ===');
  currentTasks.forEach(task => {
    if (task.dependencies && task.dependencies.length > 0) {
      console.log(`üìå "${task.name}" (ID: ${task.id}) depende de:`, task.dependencies);
    }
  });
  
  // 5. GUARDAR CAMBIOS
  safeSave().then((success) => {
    if (success !== false) {
      console.log('‚úÖ Dependencias guardadas correctamente');
      
      // Cerrar modal
      closeDependencyCreator();
      
      // Actualizar vista Gantt
      setTimeout(() => {
        refreshGanttView();
      }, 300);
      
      showNotification(`‚úÖ ${newDependencies.length} dependencias guardadas`);
      
    } else {
      console.error('‚ùå Error al guardar en safeSave');
      alert('Error al guardar los cambios');
    }
  }).catch(error => {
    console.error('üí• Error cr√≠tico en safeSave:', error);
    alert('Error cr√≠tico: ' + error.message);
  });
};



// ========== FUNCI√ìN PARA LIMPIAR TODAS LAS DEPENDENCIAS ==========
window.clearAllDependencies = function() {
  console.log('üóëÔ∏è Limpiando todas las dependencias...');
  
  if (!confirm('¬øEst√°s seguro de eliminar TODAS las dependencias de este proyecto?\n\nEsta acci√≥n no se puede deshacer.')) {
    console.log('‚ùå Operaci√≥n cancelada por el usuario');
    return;
  }
  
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) {
    alert('‚ùå No hay Gantt activo');
    return;
  }
  
  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  
  if (projectIndex >= projects.length || projectIndex < 0) {
    alert('Error: Proyecto no v√°lido.');
    return;
  }
  
  const currentProject = projects[projectIndex];
  let dependenciasEliminadas = 0;
  
  // Eliminar dependencias de todas las tareas
  currentProject.tasks.forEach(task => {
    if (task.dependencies && task.dependencies.length > 0) {
      dependenciasEliminadas += task.dependencies.length;
      task.dependencies = [];
      console.log(`üóëÔ∏è Limpiadas dependencias de "${task.name}"`);
    }
  });
  
  if (dependenciasEliminadas > 0) {
    // Guardar cambios
    safeSave().then(() => {
      console.log(`‚úÖ ${dependenciasEliminadas} dependencias eliminadas`);
      
      // Actualizar vista Gantt
      if (typeof refreshGanttView === 'function') {
        refreshGanttView();
      } else {
        // Recargar Gantt manualmente
        const ganttContainer = document.getElementById('premiumExecutiveGantt');
        if (ganttContainer) {
          ganttContainer.remove();
          setTimeout(() => createCompleteGanttForCurrentProject(), 300);
        }
      }
      
      showNotification(`‚úÖ ${dependenciasEliminadas} dependencias eliminadas`);
      
    }).catch(error => {
      console.error('‚ùå Error al guardar:', error);
      alert('Error al eliminar dependencias');
    });
  } else {
    alert('‚ö†Ô∏è No hay dependencias para eliminar');
  }
};





window.markAsCriticalPath = function() {
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;
  
  // OBTENER EL PROYECTO ACTUAL CORRECTAMENTE
  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  
  // Verificar que el proyecto existe
  if (projectIndex >= projects.length || projectIndex < 0) {
    alert('Error: Proyecto no v√°lido.');
    return;
  }
  
  const currentProject = projects[projectIndex];
  const currentTasks = currentProject.tasks || [];
  
  if (currentTasks.length === 0) {
    alert('No hay tareas para marcar como cr√≠ticas.');
    return;
  }
  
  const overlay = document.createElement('div');
  overlay.className = 'dependency-overlay';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(5px);
    z-index: 1000000;
  `;
  
  const modal = document.createElement('div');
  modal.className = 'dependency-modal';
  modal.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 500px;
    background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
    border-radius: 20px;
    padding: 30px;
    z-index: 1000001;
    box-shadow: 0 30px 60px rgba(0,0,0,0.8);
    border: 2px solid rgba(231, 76, 60, 0.4);
    color: white;
  `;
  
  // Determinar qu√© tareas son cr√≠ticas actualmente
  const criticalStatus = currentTasks.map(task => ({
    id: task.id,
    name: task.name,
    isCritical: task.priority === 'alta' || task.status === 'overdue',
    currentPriority: task.priority || 'media'
  }));
  
  modal.innerHTML = `
    <h3 style="color: #e74c3c; margin-top: 0; margin-bottom: 20px; text-align: center;">
      üî• Marcador de Ruta Cr√≠tica
    </h3>
    
    <div style="margin-bottom: 15px; color: #95a5a6; text-align: center;">
      Proyecto: <strong style="color: #2ecc71;">${currentProject.name}</strong>
      <br>Selecciona las tareas que forman parte de la ruta cr√≠tica:
    </div>
    
    <div style="max-height: 300px; overflow-y: auto; margin-bottom: 25px;">
      ${criticalStatus.map((task, index) => `
        <div style="
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 12px 15px;
          background: rgba(255,255,255,0.05);
          border-radius: 8px;
          margin-bottom: 8px;
          border: 1px solid ${task.isCritical ? 'rgba(231, 76, 60, 0.5)' : 'rgba(255,255,255,0.1)'};
        ">
          <input 
            type="checkbox" 
            id="critical_${task.id}" 
            ${task.isCritical ? 'checked' : ''}
            style="transform: scale(1.2);"
            onchange="toggleCriticalTaskSelection('${task.id}', this.checked, ${projectIndex})"
          >
          <label for="critical_${task.id}" style="flex: 1; color: white; cursor: pointer;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <div style="
                width: 30px;
                height: 30px;
                background: ${task.isCritical ? '#e74c3c' : '#3498db'};
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                font-size: 13px;
              ">
                ${index + 1}
              </div>
              <span>${task.name}</span>
            </div>
          </label>
          ${task.isCritical ? '<span style="color: #e74c3c; font-size: 12px;">üî• CR√çTICA</span>' : ''}
        </div>
      `).join('')}
    </div>
    
    <div style="display: flex; justify-content: flex-end; gap: 10px;">
      <button onclick="closeCriticalModal()" style="
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
      ">
        Cancelar
      </button>
      <button onclick="saveCriticalPath(${projectIndex})" style="
        background: linear-gradient(45deg, #e74c3c, #c0392b);
        border: none;
        color: white;
        padding: 10px 30px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
      ">
        üíæ Guardar Ruta Cr√≠tica
      </button>
    </div>
  `;
  
  // Guardar datos en el modal
  modal.dataset.projectIndex = projectIndex;
  modal.dataset.criticalStatus = JSON.stringify(criticalStatus);
  
  overlay.onclick = closeCriticalModal;
  
  document.body.appendChild(overlay);
  document.body.appendChild(modal);
};


// ========== FUNCIONES PARA EL MODAL DE RUTA CR√çTICA ==========
// ========== FUNCIONES PARA EL MODAL DE RUTA CR√çTICA ==========
window.closeCriticalModal = function() {
  const overlay = document.querySelector('.dependency-overlay');
  const modal = document.querySelector('.dependency-modal');
  if (overlay) overlay.remove();
  if (modal) modal.remove();
  console.log('‚úÖ Modal de ruta cr√≠tica cerrado');
};

window.toggleCriticalTaskSelection = function(taskId, isCritical, projectIndex) {
  const modal = document.querySelector('.dependency-modal');
  if (!modal) return;
  
  console.log(`üìù Cambiando estado cr√≠tico de tarea ${taskId}: ${isCritical}`);
  
  // Actualizar el estado en el modal
  let criticalStatus = JSON.parse(modal.dataset.criticalStatus || '[]');
  const taskIndex = criticalStatus.findIndex(t => t.id.toString() === taskId.toString());
  
  if (taskIndex !== -1) {
    criticalStatus[taskIndex].isCritical = isCritical;
    modal.dataset.criticalStatus = JSON.stringify(criticalStatus);
    console.log(`‚úÖ Estado guardado en dataset:`, criticalStatus[taskIndex]);
  } else {
    console.warn(`‚ö†Ô∏è No se encontr√≥ la tarea ${taskId} en criticalStatus`);
  }
};

window.saveCriticalPath = function(projectIndex) {
  console.log('=== SAVE CRITICAL PATH ===');
  console.log('Project index:', projectIndex);
  
  const modal = document.querySelector('.dependency-modal');
  if (!modal) {
    console.error('‚ùå Modal not found');
    return;
  }
  
  console.log('Modal found, dataset:', modal.dataset);
  
  const globalProjects = window.projects || projects;
  if (!globalProjects || !globalProjects.length) {
    console.error('‚ùå Projects array not found');
    alert('Error: No se encontraron proyectos. Recargue la p√°gina.');
    return;
  }
  
  console.log('Projects array length:', globalProjects.length);
  
  if (projectIndex >= globalProjects.length || projectIndex < 0) {
    alert('Error: Proyecto no v√°lido.');
    return;
  }
  
  const currentProject = globalProjects[projectIndex];
  console.log('Current project:', currentProject.name);
  
  const checkboxes = document.querySelectorAll('.dependency-modal input[type="checkbox"]');
  console.log(`Found ${checkboxes.length} checkboxes`);
  
  // Resetear todas a 'media'
  currentProject.tasks.forEach(task => {
    task.priority = 'media';
  });
  
  // Aplicar cambios
  let cambios = 0;
  checkboxes.forEach(cb => {
    if (cb.checked) {
      const taskId = cb.id.replace('critical_', '');
      const task = currentProject.tasks.find(t => t.id && t.id.toString() === taskId);
      if (task) {
        task.priority = 'alta';
        cambios++;
        console.log(`‚úÖ Set "${task.name}" to ALTA`);
      }
    }
  });
  
  if (cambios === 0) {
    alert('‚ö†Ô∏è No se realizaron cambios');
    closeCriticalModal();
    return;
  }
  
  console.log(`Total changes: ${cambios}`);
  
  // Guardar cambios
  console.log('üíæ Saving changes...');
  safeSave().then((success) => {
    if (success) {
      console.log('‚úÖ Changes saved successfully');
      closeCriticalModal();
      
      // ‚úÖ USAR refreshGanttView (sin eliminar el Gantt)
      setTimeout(() => {
        if (typeof refreshGanttView === 'function') {
          refreshGanttView();
        } else {
          // Fallback seguro
          const ganttContainer = document.getElementById('premiumExecutiveGantt');
          if (ganttContainer) {
            createCompleteGanttForCurrentProject(ganttContainer);
          }
        }
      }, 300);
      
      showNotification(`‚úÖ ${cambios} tareas marcadas como cr√≠ticas`);
    } else {
      console.error('‚ùå safeSave returned false');
      alert('Error al guardar los cambios');
    }
  }).catch(error => {
    console.error('‚ùå Error in safeSave:', error);
    showNotification('‚ùå Error al guardar la ruta cr√≠tica');
  });
};
// ========== FUNCI√ìN PARA TOGGLE DE TAREA CR√çTICA - CORREGIDA ==========
window.toggleCriticalTaskSelection = function(taskId, isCritical, projectIndex) {
  const modal = document.querySelector('.dependency-modal');
  if (!modal) return;
  
  // Actualizar el estado en el modal
  let criticalStatus = JSON.parse(modal.dataset.criticalStatus || '[]');
  const taskIndex = criticalStatus.findIndex(t => t.id.toString() === taskId.toString());
  
  if (taskIndex !== -1) {
    criticalStatus[taskIndex].isCritical = isCritical;
    modal.dataset.criticalStatus = JSON.stringify(criticalStatus);
  }
};

// ========== FUNCI√ìN PARA GUARDAR RUTA CR√çTICA - CORREGIDA ==========
// ========== FUNCI√ìN PARA GUARDAR RUTA CR√çTICA - CORREGIDA ==========
window.saveCriticalPath = function(projectIndex) {
  console.log('=== SAVE CRITICAL PATH ===');
  console.log('Project index:', projectIndex);
  
  const modal = document.querySelector('.dependency-modal');
  if (!modal) {
    console.error('‚ùå Modal not found');
    return;
  }
  
  console.log('Modal found, dataset:', modal.dataset);
  
  const globalProjects = window.projects || projects;
  if (!globalProjects || !globalProjects.length) {
    alert('Error: No se encontraron proyectos. Recargue la p√°gina.');
    return;
  }
  
  if (projectIndex >= globalProjects.length || projectIndex < 0) {
    alert('Error: Proyecto no v√°lido.');
    return;
  }
  
  const currentProject = globalProjects[projectIndex];
  const checkboxes = document.querySelectorAll('.dependency-modal input[type="checkbox"]');
  
  // Resetear todas a 'media'
  currentProject.tasks.forEach(task => {
    task.priority = 'media';
  });
  
  // Aplicar cambios
  let cambios = 0;
  checkboxes.forEach(cb => {
    if (cb.checked) {
      const taskId = cb.id.replace('critical_', '');
      const task = currentProject.tasks.find(t => t.id && t.id.toString() === taskId);
      if (task) {
        task.priority = 'alta';
        cambios++;
      }
    }
  });
  
  if (cambios === 0) {
    alert('‚ö†Ô∏è No se realizaron cambios');
    closeCriticalModal();
    return;
  }
  
  console.log(`Total changes: ${cambios}`);
  
  // Guardar cambios
  console.log('üíæ Saving changes...');
  safeSave().then((success) => {
    if (success) {
      console.log('‚úÖ Changes saved successfully');
      closeCriticalModal();
      
      // ‚úÖ USAR refreshGanttView (sin eliminar el contenedor)
      setTimeout(() => {
        if (typeof refreshGanttView === 'function') {
          refreshGanttView();
        } else {
          // Fallback seguro: reutilizar contenedor existente
          const ganttContainer = document.getElementById('premiumExecutiveGantt');
          if (ganttContainer) {
            createCompleteGanttForCurrentProject(ganttContainer);
          }
        }
      }, 300);
      
      showNotification(`‚úÖ ${cambios} tareas marcadas como cr√≠ticas`);
    } else {
      alert('Error al guardar los cambios');
    }
  }).catch(error => {
    console.error('‚ùå Error in safeSave:', error);
    showNotification('‚ùå Error al guardar la ruta cr√≠tica');
  });
};// ========== INICIAR SISTEMA ==========
console.log('‚úÖ Sistema Gantt Premium cargado con Burndown y Valor Ganado');
console.log('üìã Comando para iniciar: createPremiumGanttWithYourData()');




// === AUTENTICACI√ìN FRONTEND ===
let authToken = localStorage.getItem('authToken');


// === SISTEMA DE TIEMPO REAL ===
let tiempoRealSocket = null;


// === SISTEMA H√çBRIDO WEBSOCKET + LOCALSTORAGE ===
let useWebSocket = true;







function initWebSocket() {
  try {
    if (typeof io === 'undefined') {
      console.warn('‚ö†Ô∏è Socket.io no cargado, reintentando...');
      setTimeout(initWebSocket, 2000);
      return;
    }
    
    console.log('üîÑ Iniciando WebSocket...');
    tiempoRealSocket = io('https://mi-sistema-proyectos-backend-4.onrender.com', {
      transports: ['websocket', 'polling']
    });
    
    tiempoRealSocket.on('connect', function() {
      console.log('üîó Conectado al servidor en tiempo real');
      if (window.currentProjectIndex !== null && window.currentProjectIndex !== undefined) {
        tiempoRealSocket.emit('join-project', window.currentProjectIndex);
      }
      
      // üî• CONFIGURAR LISTENERS PARA EVENTOS DE SALIDA
      console.log('üëÇ Configurando listeners de salida...');
    });
    
    // üî• LISTENER PARA EVENTOS ENTRANTES (RECIBIR)
    tiempoRealSocket.on('task-updated', function(data) {
      console.log('üéØ EVENTO RECIBIDO:', data);
      refreshCurrentView();
    });
    
    tiempoRealSocket.on('disconnect', function() {
      console.log('üîå Desconectado');
    });
    
  } catch (error) {
    console.error('‚ùå Error WebSocket:', error);
  }
}
function refreshCurrentView() {
  console.log('üîÑ Sincronizando datos desde la base de datos...');
  
  // üî• FORZAR CARGA DESDE LA BASE DE DATOS COMPARTIDA
  safeLoad().then(() => {
    console.log('‚úÖ Datos sincronizados desde MongoDB');
    
    try {
      if (typeof getActiveView !== 'function') return;
      
      const activeView = getActiveView();
      console.log('üîÑ Actualizando vista:', activeView);
      
      switch(activeView) {
        case 'board':
          if (typeof renderKanbanTasks === 'function') renderKanbanTasks();
          break;
        case 'list':
          if (typeof renderListTasks === 'function') renderListTasks();
          break;
        case 'dashboard':
          if (typeof renderDashboard === 'function') renderDashboard();
          break;
        case 'calendar':
          if (typeof renderCalendar === 'function') renderCalendar();
          break;
        case 'gantt':
          if (typeof renderGanttChart === 'function') renderGanttChart();
          break;
        case 'reports':
          if (typeof generateReports === 'function') generateReports();
          break;
        default:
          if (typeof renderKanbanTasks === 'function') renderKanbanTasks();
      }
      
      // Actualizar estad√≠sticas
      if (typeof updateStatistics === 'function') updateStatistics();
      if (typeof generatePieChart === 'function' && typeof getStats === 'function') {
        generatePieChart(getStats());
      }
      if (typeof updateProjectProgress === 'function') updateProjectProgress();
      
    } catch (error) {
      console.error('‚ùå Error actualizando vista:', error);
    }
  }).catch(error => {
    console.error('‚ùå Error sincronizando datos:', error);
  });
}

// === FUNCIONES DE AUTENTICACI√ìN (√ÅMBITO GLOBAL) ===
function showRegisterForm() {
  document.getElementById('loginForm').style.display = 'none';
  document.getElementById('registerForm').style.display = 'block';
  document.getElementById('registerError').textContent = '';
}

function showLoginForm() {
  document.getElementById('registerForm').style.display = 'none';
  document.getElementById('loginForm').style.display = 'block';
  document.getElementById('loginError').textContent = '';
}

async function register() {
  const name = document.getElementById('registerName').value.trim();
  const email = document.getElementById('registerEmail').value.trim();
  const password = document.getElementById('registerPassword').value;
  if (!name || !email || !password) {
    document.getElementById('registerError').textContent = 'Completa todos los campos';
    return;
  }
  try {
    const res = await fetch(`${API_URL}/api/auth/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, password, role: 'viewer'  })
    });
    const data = await res.json();
    if (res.ok) {
      alert('‚úÖ Cuenta creada. Ahora inicia sesi√≥n.');
      setTimeout(showLoginForm, 1500);
    } else {
      document.getElementById('registerError').textContent = data.error || 'Error al crear cuenta';
    }
  } catch (err) {
    document.getElementById('registerError').textContent = 'Error de conexi√≥n con el servidor';
  }
}

async function login() {
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  if (!email || !password) {
    document.getElementById('loginError').textContent = 'Completa todos los campos';
    return;
  }
  try {
    const res = await fetch(`${API_URL}/api/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });

    console.log('üöÄ Respuesta del backend:', res.status, res.statusText);

    // Intenta leer el cuerpo solo si hay contenido
    let data = {};
    if (res.headers.get('content-length') !== '0') {
      data = await res.json();
    }

    console.log('‚úÖ Datos recibidos:', data);

    if (res.ok) {
      authToken = data.token;
      localStorage.setItem('authToken', authToken);
      localStorage.setItem('userRole', data.user.role || 'viewer');
      location.reload();
    } else {
      document.getElementById('loginError').textContent = data.error || 'Error desconocido';
    }
  } catch (err) {
    console.error('‚ùå Error en login():', err); // üëà A√±ade este log
    document.getElementById('loginError').textContent = 'Error de conexi√≥n con el servidor';
  }
}
// === MOSTRAR PANTALLA DE LOGIN/REGISTRO ===
function showLoginScreen() {
  document.body.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#f5f7fa;font-family:Arial,sans-serif;">
      <div id="authFormContainer" style="background:white;padding:30px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.1);width:350px;">
        <!-- Formulario de Login -->
        <div id="loginForm">
          <h2 style="text-align:center;margin:0 0 20px;">üîí Iniciar Sesi√≥n</h2>
          <input type="email" id="loginEmail" placeholder="Email" style="width:100%;padding:10px;margin:8px 0;border:1px solid #ddd;border-radius:4px;">
          <input type="password" id="loginPassword" placeholder="Contrase√±a" style="width:100%;padding:10px;margin:8px 0;border:1px solid #ddd;border-radius:4px;">
          <button onclick="login()" style="width:100%;padding:12px;background:#3498db;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold;">Entrar</button>
          <div id="loginError" style="color:#e74c3c;margin-top:12px;text-align:center;"></div>
          <div style="margin-top:15px;text-align:center;">
            ¬øNo tienes cuenta? 
            <a href="#" onclick="showRegisterForm(); return false;" style="color:#3498db;text-decoration:underline;">Reg√≠strate aqu√≠</a>
          </div>
        </div>

        <!-- Formulario de Registro (oculto por defecto) -->
        <div id="registerForm" style="display:none;">
          <h2 style="text-align:center;margin:0 0 20px;">üìù Crear Cuenta</h2>
          <input type="text" id="registerName" placeholder="Nombre completo" style="width:100%;padding:10px;margin:8px 0;border:1px solid #ddd;border-radius:4px;">
          <input type="email" id="registerEmail" placeholder="Email" style="width:100%;padding:10px;margin:8px 0;border:1px solid #ddd;border-radius:4px;">
          <input type="password" id="registerPassword" placeholder="Contrase√±a" style="width:100%;padding:10px;margin:8px 0;border:1px solid #ddd;border-radius:4px;">
          <button onclick="register()" style="width:100%;padding:12px;background:#2ecc71;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold;">Crear Cuenta</button>
          <div id="registerError" style="color:#e74c3c;margin-top:12px;text-align:center;"></div>
          <div style="margin-top:15px;text-align:center;">
            ¬øYa tienes cuenta? 
            <a href="#" onclick="showLoginForm(); return false;" style="color:#3498db;text-decoration:underline;">Inicia sesi√≥n</a>
          </div>
        </div>
      </div>
    </div>
  `;
}

// Elementos del DOM
const projectNameDisplay = document.getElementById('projectName');
const projectNameList = document.getElementById('projectNameList');
const projectNameCalendar = document.getElementById('projectNameCalendar');
const projectNameGantt = document.getElementById('projectNameGantt');
const projectNameReports = document.getElementById('projectNameReports');
const projectListContainer = document.getElementById('projectList');
const statisticsSection = document.querySelector('.statistics');
const notification = document.getElementById('notification');
const taskDetailsModal = document.getElementById('taskDetailsModal');
const createTaskModal = document.getElementById('createTaskModal');
const createTaskForm = document.getElementById('createTaskForm');
const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
const sidebar = document.querySelector('aside');


// Columnas del Kanban
const columns = {
  pending: document.getElementById('pendingList'),
  inProgress: document.getElementById('inProgressList'),
  completed: document.getElementById('completedList'),
  overdue: document.getElementById('overdueList')
};

// Elementos de estad√≠sticas
const totalTasks = document.getElementById('totalTaskCount');
const pendingCount = document.getElementById('pendingCount');
const inProgressCount = document.getElementById('inProgressCount');
const completedCount = document.getElementById('completedCount');
const overdueCount = document.getElementById('overdueCount');
const pieChartCanvas = document.getElementById('pieChart');

// Elementos de tiempo en Reports
const totalEstimatedTime = document.getElementById('totalEstimatedTime');
const totalLoggedTime = document.getElementById('totalLoggedTime');
const remainingTime = document.getElementById('remainingTime');

// ===== SELECTORES DE VISTAS =====
// Versi√≥n corregida:
const viewSelectors = {
  board: '#boardView',
  list: '#listView',
  calendar: '#calendarView',
  gantt: '#ganttView',
  reports: '#reportsView',
  profitability: '#profitabilityView',
  dashboard: '#dashboardView',
  timeAllocation: '#timeAllocationView',
  dashboard4d: '#dashboard4dView',   // <-- A√ëADIR ESTA L√çNEA
 

};

const viewButtons = {
  board: document.querySelector('#showBoardView'),
  list: document.querySelector('#showListView'),
  calendar: document.querySelector('#showCalendarView'),
  gantt: document.querySelector('#showGanttView'),
  reports: document.querySelector('#showReportsView'),
  profitability: document.querySelector('#showProfitabilityView'),
  dashboard: document.querySelector('#showDashboardView'),
  dashboard4d: document.querySelector('#showDashboard4DView'), // <-- A√ëADIR
   timeAllocation: document.querySelector('#showTimeAllocationView'),

};

// ===== NAVEGACI√ìN ENTRE VISTAS =====
Object.entries(viewButtons).forEach(([view, btn]) => {
  if (!btn) {
    console.warn(`‚ö†Ô∏è Bot√≥n no encontrado para vista: ${view}`);
    return;
  }

  btn.addEventListener('click', () => {
    console.log(`üß≠ Click navegaci√≥n a vista: ${view}`);
    showView(view);
  });
});



// ===== ELEMENTOS DE VISTAS =====
const boardView = document.querySelector(viewSelectors.board);
const listView = document.querySelector(viewSelectors.list);
const calendarView = document.querySelector(viewSelectors.calendar);
const ganttView = document.querySelector(viewSelectors.gantt);
const reportsView = document.querySelector(viewSelectors.reports);
const profitabilityView = document.querySelector(viewSelectors.profitability);
const dashboard4dView = document.querySelector(viewSelectors.dashboard4d);
const dashboardView = document.querySelector(viewSelectors.dashboard);
const timeAllocationView = document.querySelector(viewSelectors.timeAllocation);


function syncLinesWithSidebar() {

if (activeView === 'gantt') {
    console.warn("‚õî Sincronizaci√≥n del Gantt desactivada.");
    return;
}

    console.log('üîß Ejecutando syncLinesWithSidebar corregida...');
    
    const sidebar = document.querySelector('aside, #sidebar, .sidebar');

if (activeView === 'gantt') {
    console.warn("‚õî Sincronizaci√≥n del Gantt desactivada.");
    return;
}



const linesContainer = document.querySelector(
  '.dependency-lines-container, #projectTimeline, #ganttContainer, .gantt-container'
);
const mainContent = document.querySelector('main, #mainContent, .main-content, #dashboardContent');

    
    console.log('üìå Sidebar encontrado:', !!sidebar);
    console.log('üìå LinesContainer encontrado:', !!linesContainer);
    console.log('üìå MainContent encontrado:', !!mainContent);
    
    if (!sidebar || !linesContainer || !mainContent) {
        console.log('‚ùå No se pueden sincronizar - elementos no encontrados');
        return;
    }
    
    // Verificar si el sidebar est√° visible u oculto
    const isSidebarHidden = sidebar.classList.contains('hidden');
    
    console.log('üìä Estado sidebar:', isSidebarHidden ? 'OCULTO' : 'VISIBLE');
    
    // CORRECCI√ìN: Las l√≠neas deben permanecer en su posici√≥n original
    // independientemente del estado del sidebar
    if (isSidebarHidden) {
        // Cuando el sidebar est√° oculto, las l√≠neas NO se mueven
        linesContainer.style.transform = 'none';
        console.log('‚úÖ L√≠neas mantenidas en posici√≥n original (sidebar oculto)');
    } else {
        // Cuando el sidebar est√° visible, las l√≠neas se ajustan al ancho del sidebar
        const sidebarWidth = sidebar.offsetWidth;
        linesContainer.style.transform = `translateX(${sidebarWidth}px)`;
        console.log(`‚úÖ L√≠neas ajustadas a: translateX(${sidebarWidth}px) (sidebar visible)`);
    }
}











/*********************************
 * ESTILOS DE MODO PARA DASHBOARD *
 *********************************/

function applyDashboardModeStyles(mode) {
  console.log('üé® Aplicando modo:', mode);
  const dashboardElement = document.getElementById('dashboardView');
  if (!dashboardElement) return;
  
  dashboard.classList.remove('mode-agile', 'mode-traditional', 'mode-hybrid');
  dashboard.classList.add('mode-' + mode);
  
  // Aqu√≠ NO ocultamos ni mostramos nada, solo cambiamos estilos
  // Tu dashboard h√≠brido se mantiene COMPLETO en todos los modos
}

function highlightRelevantSections(mode) {
  const highlightStyles = {
    'agile': `
      .mode-agile .progress-container,
      .mode-agile .time-metric,
      .mode-agile #timeChart,
      .mode-agile #tasksDistributionChart {
        border-left: 4px solid #4caf50 !important;
        background-color: rgba(76, 175, 80, 0.05) !important;
        transition: all 0.3s ease;
      }
    `,
    'traditional': `
      .mode-traditional .progress-container,
      .mode-traditional .time-metric,
      .mode-traditional #timeChart,
      .mode-traditional #tasksDistributionChart {
        border-left: 4px solid #2196f3 !important;
        background-color: rgba(33, 150, 243, 0.05) !important;
        transition: all 0.3s ease;
      }
    `,
    'hybrid': ''
  };

  // Eliminar estilo anterior
  const oldStyle = document.getElementById('dashboard-mode-styles');
  if (oldStyle) oldStyle.remove();

  // Crear nuevo estilo
  const style = document.createElement('style');
  style.id = 'dashboard-mode-styles';
  style.textContent = highlightStyles[mode] || '';
  document.head.appendChild(style);
}
/*************************
 * FUNCIONES AUXILIARES *
 *************************/
function getStatusText(status) {
  switch (status) {
    case 'pending': return 'Pendiente';
    case 'inProgress': return 'En Progreso';
    case 'completed': return 'Completado';
    case 'overdue': return 'Rezagado';
    default: return status || 'Desconocido';
  }
}

function capitalizeFirstLetter(string) {
  return string?.charAt(0).toUpperCase() + string?.slice(1) || '';
}

function formatDate(date) {
  if (!date) return '--/--/----';
  const d = new Date(date);
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
}

function showNotification(message) {
    const notif = document.createElement('div');
    notif.textContent = message;
    notif.style.cssText = `
        position: fixed; top: 20px; right: 20px; background: #333; color: white;
        padding: 10px 20px; border-radius: 5px; z-index: 9999; font-family: Arial, sans-serif;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    `;
    document.body.appendChild(notif);
    setTimeout(() => document.body.removeChild(notif), 3000);
}
function updateLocalStorage() {
    // Esta funci√≥n ahora solo es un alias para safeSave
    safeSave().then(() => {
        console.log('üîÑ Datos persistidos (localStorage + backend si est√° disponible)');
    });
}
function debounce(func, wait) {
  let timeout;
  return function() {
    const context = this, args = arguments;
    clearTimeout(timeout);
    timeout = setTimeout(() => {
      func.apply(context, args);
    }, wait);
  };
}



function rerenderActiveView() {
  console.log('üîÅ Re-render vista activa:', activeView);

  switch (activeView) {
    case 'board':
      window.renderBoardView?.();
      break;

    case 'list':
      window.renderListTasks?.(); // ‚úÖ ESTA ES LA BUENA
      break;

    case 'calendar':
      window.renderCalendarView?.();
      break;

    case 'reports':
      window.renderReportsView?.();
      break;

    case 'timeAllocation':
      window.renderTimeAllocationView?.();
      break;
  }
}





function updateMenuButtons(activeView) {
  // Remover la clase 'active' de todos los botones primero
  document.querySelectorAll('#sidebar ul li').forEach(button => {
    button.classList.remove('active');
  });

  // Agregar la clase 'active' solo al bot√≥n correspondiente
  const activeButton = document.getElementById(`show${capitalizeFirstLetter(activeView)}View`);
  if (activeButton) {
    activeButton.classList.add('active');

}}

/******************************
 * FUNCIONES PRINCIPALES
 ******************************/
function getFilteredTasks(view = 'board') {
  const prefixMap = {
    board: '',
    list: 'List',
    calendar: 'Calendar',
    gantt: 'Gantt',
    reports: 'Reports'
  };
  
  const prefix = prefixMap[view] || '';
  const assignee = document.getElementById(`filterAssignee${prefix}`)?.value.trim();
  const priority = document.getElementById(`filterPriority${prefix}`)?.value;
  const status = document.getElementById(`filterStatus${prefix}`)?.value;
  const start = document.getElementById(`filterStartDate${prefix}`)?.value;
  const end = document.getElementById(`filterEndDate${prefix}`)?.value;

  const tasks = projects[currentProjectIndex]?.tasks || [];

  return tasks.filter(task => {
    const taskAssignee = task.assignee?.trim() || '';
    const taskPriority = task.priority || '';
    const taskStatus = task.status || '';
    const taskStartDate = task.startDate || '';
    const taskDeadline = task.deadline || '';

    const matchAssignee = !assignee || taskAssignee === assignee;
    const matchPriority = !priority || taskPriority === priority;
    const matchStatus = !status || taskStatus === status;
    const matchStartDate = !start || !taskStartDate || taskStartDate >= start;
    const matchEndDate = !end || !taskDeadline || taskDeadline <= end;

    return matchAssignee && matchPriority && matchStatus && matchStartDate && matchEndDate;
  });
}

function aplicarFiltros() {
  const activeView = getActiveView();
  const filteredTasks = getFilteredTasks(activeView);

  switch(activeView) {
    case 'board':
      renderKanbanTasks(filteredTasks);
      break;
    case 'list':
      renderListTasks(filteredTasks);
      break;
    case 'calendar':
      // üî• ACTUALIZAR CALENDARIO AUTOM√ÅTICAMENTE
      refreshCalendar();
      break;
    case 'gantt':
      renderGanttChart(filteredTasks);
      break;
     
    case 'reports':
      generateReports(filteredTasks);
      break;
    case 'profitability':
      renderProfitabilityView();
      break;
  }
}

function getActiveView() {
  if (!boardView.classList.contains('hidden')) return 'board';
  if (!listView.classList.contains('hidden')) return 'list';
  if (!calendarView.classList.contains('hidden')) return 'calendar';
  if (!ganttView.classList.contains('hidden')) return 'gantt';
  if (!reportsView.classList.contains('hidden')) return 'reports';
  if (!profitabilityView.classList.contains('hidden')) return 'profitability';
  return 'board';
}

/******************************
 * FUNCIONES DE RENDERIZADO
 ******************************/
function renderKanbanTasks(tasks = null) {
    console.log('üî¥ INICIANDO renderKanbanTasks - VERSI√ìN CORREGIDA');
    
    // üî• CORRECCI√ìN: Usar variables DIRECTAMENTE, sin window.
    // Paso 1: Verificar lo b√°sico
    if (!projects || currentProjectIndex === undefined) {
        console.error('‚ùå No hay proyectos o √≠ndice');
        console.log('   projects:', projects);
        console.log('   currentProjectIndex:', currentProjectIndex);
        return;
    }
    
    const project = projects[currentProjectIndex];
    if (!project || !project.tasks) {
        console.error('‚ùå No hay proyecto o tareas');
        return;
    }
    
    console.log('‚úÖ Proyecto:', project.name);
    console.log('‚úÖ Tareas:', project.tasks.length);
    
    // Paso 2: Obtener columnas
    const pendingCol = document.getElementById('pendingList');
    const inProgressCol = document.getElementById('inProgressList');
    const completedCol = document.getElementById('completedList');
    const overdueCol = document.getElementById('overdueList');
    
    console.log('‚úÖ Columnas:', {
        pending: !!pendingCol,
        inProgress: !!inProgressCol,
        completed: !!completedCol,
        overdue: !!overdueCol
    });
    
    if (!pendingCol || !inProgressCol || !completedCol || !overdueCol) {
        console.error('‚ùå Faltan columnas');
        return;
    }
    
    // Paso 3: Limpiar columnas
    pendingCol.innerHTML = '';
    inProgressCol.innerHTML = '';
    completedCol.innerHTML = '';
    overdueCol.innerHTML = '';
    
    // Paso 4: Obtener tareas
    let tasksToRender = tasks || project.tasks || [];
    console.log('‚úÖ Tareas a renderizar:', tasksToRender.length);
    
    if (tasksToRender.length === 0) {
        console.log('üì≠ No hay tareas');
        return;
    }
    
    // Paso 5: Renderizar CADA TAREA
    tasksToRender.forEach((task, index) => {
        console.log(`üé® Renderizando tarea ${index + 1}: "${task.name}"`);
        console.log('üìä Campos de la tarea:', {
            name: task.name,
            assignee: task.assignee,
            priority: task.priority,
            status: task.status,
            deadline: task.deadline,
            description: task.description, // Este lo vamos a eliminar
            estimatedTime: task.estimatedTime, // Este ya estaba eliminado
            subtasks: task.subtasks,
            startDate: task.startDate
        });
        
        if (!task) {
            console.log(' ‚ö†Ô∏è Tarea nula, saltando');
            return;
        }
        
        // Determinar columna
        let targetColumn = pendingCol;
        if (task.status === 'completed' || task.status === 'completado') {
            targetColumn = completedCol;
        } else if (task.status === 'inProgress' || task.status === 'en progreso') {
            targetColumn = inProgressCol;
        } else if (task.status === 'overdue' || task.status === 'rezagado') {
            targetColumn = overdueCol;
        }
        
        console.log(`   üìç Estado: ${task.status} ‚Üí Columna: ${targetColumn.id}`);
        
        // COLORES DE BORDE POR PRIORIDAD
        const priorityBorderColors = {
            'alta': '#e74c3c',    // Rojo
            'media': '#f39c12',   // Naranja  
            'baja': '#2ecc71',    // Verde
            'high': '#e74c3c',
            'medium': '#f39c12',
            'low': '#2ecc71'
        };
        
        const priorityColor = priorityBorderColors[task.priority] || '#3498db';
        
        // ICONOS DE STATUS
        const statusIcons = {
            'pending': '‚è≥',
            'inProgress': 'üîÑ', 
            'completed': '‚úÖ',
            'overdue': '‚ö†Ô∏è'
        };
        
        const statusIcon = statusIcons[task.status] || 'üìù';

        // Formatear fecha l√≠mite
        let formattedDeadline = '';
        if (task.deadline) {
            try {
                const deadlineDate = new Date(task.deadline);
                formattedDeadline = deadlineDate.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                console.log(`   üìÖ Fecha formateada: ${formattedDeadline}`);
            } catch (error) {
                console.error('‚ùå Error formateando fecha:', error);
                formattedDeadline = 'Fecha inv√°lida';
            }
        }

        // Crear tarjeta con formato MEJORADO - ESTRUCTURA CORREGIDA
        const card = document.createElement('div');
        card.className = 'task-card';
        card.draggable = true;
        card.dataset.taskId = task.id;
        card.dataset.status = task.status;
        
        // Aplicar color de borde
        card.style.borderLeft = `4px solid ${priorityColor}`;
        
        // HTML con NUEVA ESTRUCTURA - Solo campos esenciales
        // En la parte del HTML dentro de renderKanbanTasks, modifica el task-card-body:
card.innerHTML = `
    <div class="task-card-header">
        <h4 class="task-title">
            ${statusIcon} ${task.name || 'Tarea sin nombre'}
        </h4>
        <div class="task-controls">
            <!-- FLECHAS DE DESPLAZAMIENTO -->
            <div class="move-buttons">
                <button class="move-btn up" onclick="event.stopPropagation(); moveTaskUp(${task.id}, '${task.status}')">‚Üë</button>
                <button class="move-btn down" onclick="event.stopPropagation(); moveTaskDown(${task.id}, '${task.status}')">‚Üì</button>
            </div>
            <!-- MEN√ö DE TRES PUNTITOS -->
            <div class="task-menu" onclick="event.stopPropagation(); toggleTaskMenu(event, ${task.id})">
                ‚ãÆ
            </div>
        </div>
    </div>
    
    <div class="task-card-body">
        <!-- ASIGNADO ARRIBA de las banderas - REDUCIDO MARGIN -->
        ${task.assignee ? `
            <div class="task-assignee">
                <i class="fas fa-user"></i> Asignado a: ${task.assignee}
            </div>
        ` : ''}
        
        <!-- CONTENEDOR CENTRADO PARA BANDERAS -->
        <div class="badges-container">
            <!-- BANDERA DE PRIORIDAD - TEXTO M√ÅS PEQUE√ëO -->
            <span class="task-badge priority-badge ${task.priority || 'media'}">
                ${task.priority ? task.priority.charAt(0).toUpperCase() + task.priority.slice(1) : 'Media'}
            </span>
            
            <!-- BANDERA DE STATUS - TEXTO M√ÅS PEQUE√ëO -->
            <span class="task-badge status-badge status-${task.status}">
                ${task.status === 'pending' ? 'Pendiente' : 
                  task.status === 'inProgress' ? 'En Progreso' : 
                  task.status === 'completed' ? 'Completado' : 
                  task.status === 'overdue' ? 'Rezagado' : task.status}
            </span>
        </div>
        
        <!-- FECHA L√çMITE DEBAJO de las banderas -->
        ${task.deadline ? `
            <div class="task-deadline">
                <i class="fas fa-calendar-alt"></i> Fecha l√≠mite: ${formattedDeadline}
            </div>
        ` : ''}
    </div>
    
    <div class="task-context-menu" id="task-menu-${task.id}">
        <div class="task-menu-item" onclick="showTaskDetails(${JSON.stringify(task).replace(/"/g, '&quot;')})">
            <i class="fas fa-edit"></i> Editar
        </div>
        <div class="task-menu-item delete" onclick="deleteTask('${encodeURIComponent(JSON.stringify(task))}')">
            <i class="fas fa-trash"></i> Eliminar
        </div>
    </div>
`;
        




        // Event listener para clicks
        card.addEventListener('click', function(e) {
            console.log('üñ±Ô∏è Click en:', task.name);
            e.stopPropagation();
            if (typeof showTaskDetails === 'function') {
                showTaskDetails(task);
            }
        });

        // Agregar a la columna
        targetColumn.appendChild(card);
        console.log(`   ‚úÖ Tarea agregada a ${targetColumn.id}`);
    });
    
    console.log('üéâ renderKanbanTasks COMPLETADO EXITOSAMENTE');
    
    // Paso 6: Iniciar drag & drop si existe
    setTimeout(() => {
        if (typeof initDragAndDrop === 'function') {
            console.log('üéØ Iniciando drag & drop...');
            initDragAndDrop();
        }
    }, 100);
}




/*********************
 * MEN√ö CONTEXTUAL DE TAREAS *
 *********************/
function toggleTaskMenu(event, taskId) {
  event.stopPropagation();
  
  // Cerrar todos los otros men√∫s
  document.querySelectorAll('.task-context-menu').forEach(menu => {
    if (menu.id !== `task-menu-${taskId}`) {
      menu.classList.remove('show');
    }
  });
  
  // Alternar el men√∫ actual
  const menu = document.getElementById(`task-menu-${taskId}`);
  if (menu) {
    menu.classList.toggle('show');
  }
}

function deleteTaskFromMenu(taskId) {
  const task = projects[currentProjectIndex].tasks.find(t => t.id === taskId);
  if (!task) return;
  
  if (confirm(`¬øEst√°s seguro de eliminar "${task.name}"? Esta acci√≥n no se puede deshacer.`)) {

if (window.syncManager) window.syncManager.notifyChange('task-deleted', { 
          projectIndex: currentProjectIndex, 
          taskId: taskId, 
          taskName: task.name 
      });



    // üî• PRIMERO NOTIFICAR la eliminaci√≥n
    if (tiempoRealSocket && tiempoRealSocket.connected) {
      tiempoRealSocket.emit('task-changed', {
        projectId: currentProjectIndex,
        taskId: taskId,
        taskName: task.name,
        userName: 'Usuario actual',
        type: 'task-deleted',
        timestamp: new Date().toISOString()
      });
      console.log('üì¢ Notificando eliminaci√≥n de tarea');
    }
    
    // LUEGO eliminar (tu c√≥digo actual)
    projects[currentProjectIndex].tasks = projects[currentProjectIndex].tasks.filter(t => t.id !== taskId);
    updateLocalStorage();
    actualizarAsignados();
    aplicarFiltros();
    generatePieChart(getStats());
    updateProjectProgress();
    actualizarAsignados();
    showNotification(`Tarea "${task.name}" eliminada`);
// üî• AGREGAR ESTO AL FINAL:
    refreshCalendar();

  }
}







function renderListTasks(tasks = null) {
  const taskTableBody = document.getElementById('taskTableBody');
  if (!taskTableBody) return;

  taskTableBody.innerHTML = '';

  const tasksToRender = tasks || getFilteredTasks('list');

  if (tasksToRender.length === 0) {
    const emptyRow = document.createElement('tr');
    emptyRow.className = 'empty-row';
    emptyRow.innerHTML = `
      <td colspan="6" class="empty-cell">
        <i class="fas fa-tasks"></i>
        No se encontraron tareas con los filtros aplicados
      </td>
    `;
    taskTableBody.appendChild(emptyRow);
    return;
  }

  tasksToRender.forEach((task, index) => {
    const row = document.createElement('tr');
    row.className = `task-data-row ${index % 2 === 0 ? 'even-row' : 'odd-row'}`;
    
    const estadoText = getStatusText(task.status);
    const priorityText = capitalizeFirstLetter(task.priority);
    
    row.innerHTML = `
      <td class="data-cell task-name-cell">
        <div class="task-name-content">${task.name || '-'}</div>
      </td>
      
      <td class="data-cell date-cell">
        <div class="date-content">${formatDate(task.startDate)}</div>
      </td>
      
      <td class="data-cell date-cell">
        <div class="date-content">${formatDate(task.deadline)}</div>
      </td>
      
      <td class="data-cell status-cell">
        <div class="status-pill status-${task.status}">
          ${estadoText}
        </div>
      </td>
      
      <td class="data-cell assignee-cell">
        <div class="assignee-content">${task.assignee || '-'}</div>
      </td>
      
      <td class="data-cell priority-cell">
        <div class="priority-pill priority-${task.priority}">
          ${priorityText}
        </div>
      </td>
    `;
    
    row.addEventListener('click', () => showTaskDetails(task));
    taskTableBody.appendChild(row);
  });
}
/******************************
 * FUNCIONES DEL DASHBOARD
 ******************************/
function renderDashboard() {
  const project = projects[currentProjectIndex];
  if (!project) return;

  // Actualizar informaci√≥n b√°sica
  document.getElementById('projectNameDashboard').textContent = project.name;

  // Calcular KPIs
  const stats = getStats();
  const timeStats = getTimeStats();
  // ‚úÖ C√°lculo correcto del progreso basado en Valor Ganado (EV/BAC)
const evm = calculateEVMRealFromTasks(project.tasks || []);
const completionPercentage = evm?.BAC > 0 ? Math.round((evm.EV / evm.BAC) * 100) : 0;

// === C√°lculo y actualizaci√≥n de Presupuesto (uso de tiempo) ===
    const budgetUsage = calculateTimeBudgetUsage();
    const budgetElement = document.getElementById('budgetConsumption');
    if (budgetElement) {
        budgetElement.textContent = `${budgetUsage}%`;
    }

    // Actualizar fechas del proyecto
    updateProjectDatesFromTasks();


// Calcular fechas del proyecto
    const { earliestDate, latestDate } = calculateProjectDatesFromTasks(project);
    updateProjectDatesInDashboard(earliestDate, latestDate);


  // Calcular y mostrar feedback de tiempo
  const timeDifference = (project.totalProjectTime || 0) - timeStats.totalLogged;
  const feedbackElement = document.getElementById('timeFeedback');
if (feedbackElement) {
    if (timeDifference >= 0) {
        feedbackElement.textContent = `‚úÖ Excelente Trabajo - Est√°s dentro del tiempo Programado (${timeDifference.toFixed(1)}h restantes)`;
    } else {
        feedbackElement.innerHTML = `<span class="warning-symbol">‚ö†</span> Algo anda mal - Has excedido el tiempo programado por (${Math.abs(timeDifference).toFixed(1)}h)`;
    }
}


  // Actualizar barra de progreso y porcentaje
  const progressFill = document.getElementById('projectProgressFillDash');
  const progressPercentage = document.getElementById('progressPercentage');
  if (progressFill) {
    progressFill.style.width = `${completionPercentage}%`;
    progressFill.style.backgroundColor = '#2ecc71'; // Verde para completado
  }

// Actualizar campo de Avance en el resumen
const avanceElement = document.getElementById('completionPercentage');
if (avanceElement) {
    avanceElement.textContent = `${completionPercentage}%`;
}

  if (progressPercentage) {
    progressPercentage.textContent = `${completionPercentage}% Completado`;
  }

  // Actualizar todos los cuadros de m√©tricas
  document.getElementById('totalTasksMetric').textContent = stats.total;
  document.getElementById('pendingTasksMetric').textContent = stats.pending;
  document.getElementById('inProgressTasksMetric').textContent = stats.inProgress;
  document.getElementById('completedTasksMetric').textContent = stats.completed;
  document.getElementById('overdueTasksMetric').textContent = stats.overdue;

  // Actualizar m√©tricas de tiempo
  document.getElementById('totalProjectTimeDash').textContent = `${project.totalProjectTime || 0}h`;
  document.getElementById('totalEstimatedDash').textContent = `${timeStats.totalEstimated.toFixed(1)}h`;
  document.getElementById('totalLoggedDash').textContent = `${timeStats.totalLogged.toFixed(1)}h`;

// ‚úÖ Actualizar estado basado en tiempo
updateProjectHealthStatus(); // ‚Üê Esta l√≠nea es clave


  // Calcular el tiempo restante basado en el tiempo total del proyecto
  const projectTimeRemaining = (project.totalProjectTime || 0) - timeStats.totalLogged;
  document.getElementById('remainingTimeDash').textContent = `${projectTimeRemaining.toFixed(1)}h`;

  // Actualizar gr√°ficos (esperar a que el DOM est√© visible)
requestAnimationFrame(() => {
    renderDashboardCharts();


 // ‚úÖ AGREGA ESTO AL FINAL DE LA FUNCI√ìN ‚úÖ
    // Inicializar el indicador de modo de trabajo autom√°ticamente
    if (window.methodologyManager && typeof window.methodologyManager.getCurrentMode === 'function') {
        const currentMode = window.methodologyManager.getCurrentMode();
        updateModeIndicator(currentMode);
        highlightRelevantSections(currentMode);
        updateModeHelpText(currentMode);
        updateDashboardTitle(currentMode);

loadDashboardProjectData();
  alignDashboardRow3Cards(); // üëà esta l√≠nea asegura la alineaci√≥n
}

});







  // Actualizar estado del proyecto
  updateProjectHealthStatus();

  // Actualizar hitos y acciones
  updateMilestones();
  updateRequiredActions();

  // Actualiza estad√≠sticas visuales
  updateStatistics();
  generatePieChart(getStats());


  // Dibuja gr√°fica de recursos
  updateResourceAllocation();

  // === IMPORTANTE: Aseg√∫rate de que esta l√≠nea est√© presente ===
  updateProjectTimeline(); // ‚Üê A√±ade esta l√≠nea si ya tienes la funci√≥n definida
  updateProjectDatesFromTasks();
// ‚úÖ Actualizar contador de riesgos
updateRisksCount();

// === [NUEVO: √âNFASIS DETALLADO] ===
  const currentMode = window.methodologyManager.getCurrentMode();
  applyDashboardModeStyles(currentMode);
  applyDetailedModeStyles(currentMode); // ‚Üê A√±adir esta l√≠nea
}



function updateProjectDatesInDashboard(earliestDate, latestDate) {
    // Formatear las fechas
    const formattedStartDate = formatDate(earliestDate);
    const formattedEndDate = formatDate(latestDate);

    // Actualizar los campos de fecha
    document.getElementById('projectStartDate').textContent = formattedStartDate;
    document.getElementById('projectEndDate').textContent = formattedEndDate;

    // Calcular la diferencia de d√≠as
    const startDateObj = new Date(earliestDate);
    const endDateObj = new Date(latestDate);
    const timeDifference = Math.ceil((endDateObj - startDateObj) / (1000 * 60 * 60 * 24));
    document.getElementById('projectTotalDays').textContent = `${timeDifference} `;
}

// Funci√≥n auxiliar para formatear fechas
function formatDate(dateString) {
    if (!dateString) return '--/--/--';
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return '--/--/--';
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;

}



function updateProjectTimeline() {
  // Verificar que el proyecto y las tareas existan
  if (!projects || !Array.isArray(projects) || currentProjectIndex === undefined || currentProjectIndex === null) {
    console.warn("‚ö†Ô∏è Proyecto no disponible para calcular fechas.");
    return;
  }


function updateProjectStartDate() {
    const project = projects[currentProjectIndex];
    if (!project || !project.tasks || project.tasks.length === 0) {
        document.getElementById('projectStartDate').textContent = '--/--/--';
        return;
    }

    let earliestDate = null;

    project.tasks.forEach(task => {
        if (task.startDate) {
            const taskDate = new Date(task.startDate);
            if (!earliestDate || taskDate < earliestDate) {
                earliestDate = taskDate;
            }
        }
    });

    if (earliestDate) {
        const day = String(earliestDate.getDate()).padStart(2, '0');
        const month = String(earliestDate.getMonth() + 1).padStart(2, '0');
        const year = earliestDate.getFullYear();
        document.getElementById('projectStartDate').textContent = `${day}/${month}/${year}`;
    } else {
        document.getElementById('projectStartDate').textContent = '--/--/--';
    }
}




  const project = projects[currentProjectIndex];
  if (!project || !project.tasks || project.tasks.length === 0) {
    document.getElementById('projectStartDate').textContent = '--/--/--';
    document.getElementById('projectEndDate').textContent = '--/--/--';
    return;
  }

  const tasks = project.tasks;

  // Extraer y filtrar fechas de inicio (startDate) y fin (deadline)
  const startDates = tasks
    .filter(t => t.startDate)
    .map(t => new Date(t.startDate))
    .filter(date => !isNaN(date.getTime()));

  const endDates = tasks
    .filter(t => t.deadline)
    .map(t => new Date(t.deadline))
    .filter(date => !isNaN(date.getTime()));

  // Si no hay fechas v√°lidas
  if (startDates.length === 0) {
    document.getElementById('projectStartDate').textContent = '--/--/--';
  } else {
    const earliestStart = new Date(Math.min(...startDates));
    document.getElementById('projectStartDate').textContent = formatDate(earliestStart);
  }

  if (endDates.length === 0) {
    document.getElementById('projectEndDate').textContent = '--/--/--';
  } else {
    const latestEnd = new Date(Math.max(...endDates));
    document.getElementById('projectEndDate').textContent = formatDate(latestEnd);
  }
}


function renderDashboardCharts() {
    console.log("üéØ INICIANDO renderDashboardCharts");

    const stats = getStats();
    const timeStats = getTimeStats();

    // ===============================
    // GR√ÅFICA DISTRIBUCI√ìN DE TAREAS
    // ===============================
    const canvas = document.getElementById('tasksDistributionChart');

    if (canvas && canvas.offsetWidth > 0) {
        const ctx = canvas.getContext('2d');

        if (window.tasksChart) window.tasksChart.destroy();

        const overdueValue = stats.overdue === 0 ? 0.0001 : stats.overdue;

        window.tasksChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Pendientes', 'En Progreso', 'Completadas', 'Rezagadas'],
                datasets: [{
                    data: [
                        stats.pending,
                        stats.inProgress,
                        stats.completed,
                        overdueValue
                    ],
                    backgroundColor: [
                        '#f1c40f',
                        '#008090',
                        '#2ecc71',
                        '#e74c3c'
                    ]
                }]
            },
            options: {
                cutout: '70%',
                plugins: { legend: { display: false } }
            }
        });
    }

    // ===============================
    // GR√ÅFICA DE TIEMPO
    // ===============================
    const timeCanvas = document.getElementById('timeChart');

    if (timeCanvas && timeCanvas.offsetWidth > 0) {
        const ctx = timeCanvas.getContext('2d');

        if (window.timeChart) window.timeChart.destroy();

        window.timeChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Estimado', 'Registrado', 'Restante'],
                datasets: [{
                    data: [
                        timeStats.totalEstimated,
                        timeStats.totalLogged,
                        timeStats.remaining
                    ],
                    backgroundColor: ['#3498db', '#2ecc71', '#f39c12']
                }]
            },
            options: {
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { display: false } }
            }
        });
    }

        // ===============================
    // GR√ÅFICA DE BURNDOWN EN HORAS (NUEVA)
    // ===============================
    const burndownCanvas = document.getElementById('burndownChartDashboard');
    if (burndownCanvas && burndownCanvas.offsetWidth > 0) {
        const ctx = burndownCanvas.getContext('2d');
        if (window.burndownDashboardChartInstance) {
            window.burndownDashboardChartInstance.destroy();
        }

        const project = projects[currentProjectIndex];
        if (project && project.tasks) {
            const burndownData = calculateBurndownInHours(project.tasks);
            if (burndownData) {
                const labels = ['Inicio', 'Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'];

                window.burndownDashboardChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'L√≠nea Ideal',
                                data: burndownData.trabajoIdeal,
                                borderColor: '#2ecc71',
                                borderWidth: 3,
                                fill: false,
                                tension: 0.1,
                                pointRadius: 0
                            },
                            {
                                label: 'Progreso Real',
                                data: burndownData.trabajoReal,
                                borderColor: '#f39c12',
                                borderWidth: 3,
                                fill: false,
                                tension: 0,
                                pointRadius: 4
                            }
                        ]
                    },
                  

                      options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            display: false // ‚Üê Desactivar leyenda autom√°tica
        },
        tooltip: {
            titleColor: '#1e40af',
            bodyColor: '#1e40af',
            callbacks: {
                label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) label += ': ';
                    if (context.parsed.y !== null) {
                        label += context.parsed.y.toFixed(1) + ' h';
                    }
                    return label;
                }
            }
        }
    },
    scales: {
        y: {
            beginAtZero: true,
            grid: { color: 'rgba(30, 64, 175, 0.1)' },
            ticks: { color: '#1e40af', font: { size: 11 } },
            title: { display: true, text: 'Horas Restantes', color: '#1e40af', font: { size: 12, weight: 'bold' } }
        },
        x: {
            grid: { color: 'rgba(30, 64, 175, 0.1)' },
            ticks: { color: '#1e40af', font: { size: 11 } },
            title: { display: true, text: 'Semanas', color: '#1e40af', font: { size: 12, weight: 'bold' } }
        }
    }
}
                });

                console.log('‚úÖ Burndown del Dashboard renderizado.');
            }
        }
    }

    // ===============================
    // CONTADORES ‚Äî BLOQUEO DEFINITIVO
    // ===============================
    const applyCounters = () => {
        const map = {
            pendingCountDash: stats.pending,
            inProgressCountDash: stats.inProgress,
            completedCountDash: stats.completed,
            overdueCountDash: stats.overdue
        };

        Object.entries(map).forEach(([id, value]) => {
            const el = document.getElementById(id);
            if (el && el.textContent !== String(value)) {
                el.textContent = value;
            }
        });
    };

    // aplicar inmediatamente
    applyCounters();

    // observar cambios y volver a fijar si alguien los pisa
    const dashboard = document.getElementById('dashboardView') || document.body;

    if (!window.__dashboardCounterObserver) {
        window.__dashboardCounterObserver = new MutationObserver(applyCounters);
        window.__dashboardCounterObserver.observe(dashboard, {
            childList: true,
            subtree: true,
            characterData: true
        });
        console.log("üîí Contadores del dashboard protegidos contra re-render");
    }

    // Forzar color del texto "En Progreso"
    document.querySelectorAll('*').forEach(el => {
        if (el.textContent.trim() === 'En Progreso') {
            el.style.color = '#008090';
            el.style.fontWeight = '600';
        }
    });
}




function updateProjectHealthStatus() {
  // Obtener estad√≠sticas de tiempo
  const timeStats = getTimeStats();
  const project = projects[currentProjectIndex]; // ‚Üê Asegurar que project est√© definido
  
  // USAR TIEMPO TOTAL DEL PROYECTO, no la suma de estimaciones de tareas
  const totalEstimated = project.totalProjectTime || 0;  // CORRECCI√ìN
  const totalLogged = timeStats.totalLogged;

  // Calcular la diferencia: Tiempo Total - Tiempo Registrado
  const difference = totalEstimated - totalLogged;

  // Obtener el contenedor y el badge del estado
  const healthStatus = document.getElementById('projectHealthStatus');
  const badge = healthStatus.querySelector('.status-badge');

  // Limpiar clases de estado anteriores
  badge.classList.remove('healthy', 'warning', 'critical');

  // Actualizar texto y color seg√∫n la diferencia
  if (difference >= 0) {
    // Dentro del tiempo estimado
    badge.classList.add('healthy');
    badge.textContent = 'EN TIEMPO';
  } else {
    // Fuera de tiempo
    badge.classList.add('critical');
    badge.textContent = 'A destiempo';
  }
}function updateMilestones() {
  // Esta funci√≥n ahora se maneja autom√°ticamente con el sistema de carga/guardado
  // Los hitos se actualizan cuando se agregan/eliminan
}
function updateRequiredActions() {
  // Implementar l√≥gica para identificar acciones requeridas
}
/******************************
 * FUNCI√ìN DE CALENDARIO
 ******************************/
function renderCalendar() {
  const calendarEl = document.getElementById('calendar');
  if (!calendarEl) {
    console.error('‚ùå No se encuentra el elemento calendar');
    return;
  }

  // Limpiar el calendario existente
  calendarEl.innerHTML = '';

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    locale: 'es',
    editable: true,
    selectable: true,
    dayMaxEvents: 3, // Mostrar m√°ximo 3 eventos por d√≠a antes de "+more"
    dayMaxEventRows: true, // Permitir scroll cuando hay muchos eventos
    displayEventTime: false,
    
    // Configuraci√≥n para mostrar rangos completos
    eventDisplay: 'block',
    
    dateClick: function(info) {
      document.getElementById('createTaskModal').style.display = 'block';
      document.getElementById('taskStartDate').value = info.dateStr;
      document.getElementById('taskDeadline').value = info.dateStr;
    },
    
    events: getFilteredCalendarTasks(),
    
    eventClick: function(info) {
      const taskName = info.event.title;
      const task = projects[currentProjectIndex].tasks.find(t => t.name === taskName);
      if (task) {
        showTaskDetails(task);
      }
    },
    
    // Personalizaci√≥n de la apariencia de los eventos
    eventDidMount: function(info) {
      // Agregar tooltip personalizado
      if (info.event.extendedProps.description) {
        info.el.setAttribute('title', info.event.extendedProps.description);
      }
      
      // Asegurar que los eventos ocupen todo el ancho del d√≠a
      info.el.style.width = '95%';
      info.el.style.margin = '2px auto';
      info.el.style.borderRadius = '4px';
      info.el.style.fontSize = '14px'; // üî• TEXTO M√ÅS GRANDE
      info.el.style.fontWeight = 'bold';
      info.el.style.padding = '4px 6px'; // üî• M√ÅS ESPACIO
    },
    
    // üî• NUEVO: Forzar actualizaci√≥n cuando cambian los datos
    eventChange: function(info) {
      console.log('Evento modificado:', info.event);
      updateTaskFromCalendar(info.event);
       renderCalendar();
    }
  });

  calendar.render();
  console.log('‚úÖ Calendario renderizado con vista tipo Jira');
  
  // üî• GUARDAR REFERENCIA PARA ACTUALIZACIONES
  window.calendarInstance = calendar;
  return calendar;
}

// üî• FUNCI√ìN: Actualizar calendario cuando cambian los datos
function refreshCalendar() {
  if (!window.calendarInstance) return;

  console.log('üîÑ Forzando refresco completo del calendario');

  try {
    // 1Ô∏è‚É£ Refetch (por si acaso)
    window.calendarInstance.refetchEvents();

    // 2Ô∏è‚É£ Forzar repaint real
    window.calendarInstance.render();

    // 3Ô∏è‚É£ Ajustar tama√±o (evita huecos)
    window.calendarInstance.updateSize();
  } catch (e) {
    console.warn('‚ö†Ô∏è Error refrescando calendario:', e);
  }
}


// üî• FUNCI√ìN: Actualizar tarea desde calendario (drag & drop)
function updateTaskFromCalendar(event) {
  console.group('üìÖ updateTaskFromCalendar');

  const taskName = event.title;
  const task = projects[currentProjectIndex]?.tasks?.find(
    t => t.name === taskName
  );

  if (!task) {
    console.warn('‚ö†Ô∏è No se encontr√≥ la tarea:', taskName);
    console.groupEnd();
    return;
  }

  // üìÖ Actualizar fechas desde el evento YA MODIFICADO
  task.startDate = event.startStr;

  if (event.end) {
    const adjustedEnd = new Date(event.end);
    adjustedEnd.setDate(adjustedEnd.getDate() - 1);
    task.deadline = adjustedEnd.toISOString().split('T')[0];
  }

  // üíæ Guardar
  updateLocalStorage();
  safeSave?.();

  console.log('‚úÖ Cambios guardados desde calendario', {
    startDate: task.startDate,
    deadline: task.deadline
  });

  // üö´ NO refrescar calendario aqu√≠
  // FullCalendar ya est√° actualizado visualmente

  console.groupEnd();
}



// ===== AGREGAR ESTILOS PARA CALENDARIO TIPO JIRA =====
function addCalendarStyles() {
  // Verificar si los estilos ya existen
  if (document.getElementById('calendar-custom-styles')) {
    return;
  }

  const style = document.createElement('style');
  style.id = 'calendar-custom-styles';
  style.textContent = `
    /* Estilos para eventos del calendario - VISTA JIRA */
    .task-calendar-event {
      border-left: 4px solid !important;
      font-size: 14px !important; /* üî• TEXTO M√ÅS GRANDE */
      font-weight: bold;
      padding: 6px 8px !important; /* üî• M√ÅS ESPACIO */
      margin: 2px 0;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 24px;
      line-height: 1.3 !important;
    }
    
    .task-calendar-event:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    /* Colores espec√≠ficos por estado */
    .status-pending {
      border-left-color: #f1c40f !important;
      background: linear-gradient(135deg, #f1c40f, #f39c12) !important;
    }
    
   .status-inProgress {
    border-left-color: #16a085 !important;           // üî• Verde azulado
    background: linear-gradient(135deg, #16a085, #1abc9c) !important; // üî• Verde azulado
}
    
    .status-completed {
      border-left-color: #2ecc71 !important;
      background: linear-gradient(135deg, #2ecc71, #27ae60) !important;
    }
    
    .status-overdue {
      border-left-color: #e74c3c !important;
      background: linear-gradient(135deg, #e74c3c, #c0392b) !important;
    }
    
    /* üî• MEJORAR LA VISUALIZACI√ìN EN EL CALENDARIO */
    .fc-daygrid-event {
      white-space: normal !important;
      line-height: 1.3 !important;
      min-height: 26px;
    }
    
    .fc-event-title {
      font-weight: bold !important;
      font-size: 13px !important; /* üî• TEXTO M√ÅS GRANDE */
      line-height: 1.3 !important;
    }
    
    /* Asegurar que los eventos se vean bien en celdas peque√±as */
    .fc-daygrid-day-frame {
      min-height: 100px; /* üî• M√ÅS ALTURA PARA M√ÅS EVENTOS */
    }
    
    .fc-daygrid-event-harness {
      margin-bottom: 3px;
    }
    
    /* üî• ESTILOS PARA "+more" (M√ÅS EVENTOS) */
    .fc-daygrid-more-link {
      background: #34495e !important;
      color: white !important;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      margin-top: 2px;
    }
    
    .fc-daygrid-more-link:hover {
      background: #2c3e50 !important;
    }
    
    /* üî• MEJORAR EL POPOVER DE "+more" */
    .fc-more-popover {
      max-width: 300px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .fc-popover-header {
      background: #34495e;
      color: white;
      font-weight: bold;
    }
    
    /* üî• MEJORAR TOOLTIPS */
    .fc-event:hover {
      z-index: 1000;
    }
  `;
  document.head.appendChild(style);
  console.log('‚úÖ Estilos del calendario mejorados agregados');
}




function getFilteredCalendarTasks() {
  const assignee = document.getElementById('filterAssigneeCalendar')?.value.trim();
  const priority = document.getElementById('filterPriorityCalendar')?.value;
  const status = document.getElementById('filterStatusCalendar')?.value;

  const tasks = projects[currentProjectIndex]?.tasks || [];
  console.log('üìÖ Tareas para calendario:', tasks.length);

  const filteredTasks = tasks
    .filter(task => {
      const taskAssignee = task.assignee?.trim() || '';
      const taskPriority = task.priority || '';
      const taskStatus = task.status || '';

      const matchAssignee = !assignee || taskAssignee === assignee;
      const matchPriority = !priority || taskPriority === priority;
      const matchStatus = !status || taskStatus === status;

      return matchAssignee && matchPriority && matchStatus;
    })
    .map(task => {
      console.log('üìù Procesando tarea para calendario:', task.name, 'Estado:', task.status);
      
      // Determinar color seg√∫n estado
      const statusColors = {
    'pending': '#f1c40f',      // Amarillo - Pendiente
    'inProgress': '#16a085',   // üî• CAMBIA A: Verde azulado
    'completed': '#2ecc71',    // Verde - Completado
    'overdue': '#e74c3c'       // Rojo - Rezagado
};

      // Usar fechas de inicio y fin para crear el rango
      let startDate = task.startDate || task.deadline || new Date().toISOString().split('T')[0];
      let endDate = task.deadline || task.startDate;
      
      // üî• CORRECCI√ìN: Si solo hay una fecha, usar esa fecha solamente
      if (!endDate || endDate === startDate) {
        // Evento de un solo d√≠a
        endDate = null;
      } else {
        // üî• CORRECCI√ìN IMPORTANTE: FullCalendar usa fecha de fin EXCLUSIVA
        // Si queremos mostrar del 4 al 8, debemos poner endDate = 9
        const end = new Date(endDate);
        end.setDate(end.getDate() + 1); // Sumar un d√≠a para que sea inclusivo
        endDate = end.toISOString().split('T')[0];
      }

      const eventData = {
        title: task.name,
        start: startDate,
        end: endDate, // üî• Ahora endDate es correcto para FullCalendar
        allDay: true,
        color: statusColors[task.status] || '#95a5a6',
        textColor: '#ffffff',
        classNames: [`status-${task.status}`, 'task-calendar-event'],
        extendedProps: {
          timeTracking: task.timeLogged || 0,
          originalEstimate: task.estimatedTime || 0,
          remainingEstimate: Math.max(0, (task.estimatedTime || 0) - (task.timeLogged || 0)),
          priority: task.priority,
          assignedTo: task.assignee,
          description: `Asignado a: ${task.assignee || 'No asignado'}\nPrioridad: ${task.priority || 'No definida'}\nTiempo: ${task.timeLogged || 0}h / ${task.estimatedTime || 0}h\nEstado: ${task.status}`
        }
      };

      console.log('üìÖ Evento creado:', eventData.start, '‚Üí', eventData.end);
      return eventData;
    });

  console.log('‚úÖ Tareas procesadas para calendario:', filteredTasks.length);
  return filteredTasks;
}






// ===== üî• AGREGAR ESTAS 2 FUNCIONES NUEVAS JUSTO AQU√ç =====

// ===== FUNCI√ìN PARA REDIMENSIONAR CALENDARIO CUANDO CAMBIA EL SIDEBAR =====
function resizeCalendar() {
    if (window.calendarInstance) {
        setTimeout(() => {
            try {
                window.calendarInstance.updateSize();
                console.log('üìÖ Calendario redimensionado correctamente');
            } catch (error) {
                console.warn('‚ö†Ô∏è Error al redimensionar calendario:', error);
            }
        }, 350);
    }
}

// ===== OBSERVER PARA DETECTAR CAMBIOS EN EL SIDEBAR =====
function setupCalendarResizeObserver() {
    const sidebar = document.querySelector('aside');
    
    if (!sidebar) {
        console.log('‚è≥ Sidebar no encontrado, reintentando...');
        setTimeout(setupCalendarResizeObserver, 1000);
        return;
    }
    
    // Observar cambios en la clase 'hidden' del sidebar
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.attributeName === 'class') {
                console.log('üîç Sidebar cambi√≥ - redimensionando calendario');
                resizeCalendar();
            }
        });
    });
    
    // Configurar el observer
    observer.observe(sidebar, {
        attributes: true,
        attributeFilter: ['class']
    });
    
    console.log('‚úÖ Observer configurado para redimensionar calendario autom√°ticamente');
}







// üî• VERSI√ìN FINAL - DEPENDENCIAS CON FLECHAS Y TOOLTIP INTERACTIVO
// üî• VERSI√ìN FINAL - DEPENDENCIAS CON FLECHAS Y TOOLTIPS INTERACTIVOS
function drawDependencySVGImproved() {
    console.log('üéØ DIBUJANDO DEPENDENCIAS CON NOMBRES REALES...');
    
    const ganttContainer = document.getElementById('ganttContainer');
    if (!ganttContainer) {
        console.error('‚ùå No se encuentra ganttContainer');
        return;
    }
    
    // Eliminar SVG previo
    const old = ganttContainer.querySelector('.gantt-dependency-svg');
    if (old) old.remove();

    // Crear SVG
    const svgNS = 'http://www.w3.org/2000/svg';
    const svg = document.createElementNS(svgNS, 'svg');
    svg.classList.add('gantt-dependency-svg');
    svg.setAttribute('width', '100%');
    svg.style.position = 'absolute';
    svg.style.top = '0';
    svg.style.left = '0';
    svg.style.pointerEvents = 'none';
    svg.style.overflow = 'visible';
    svg.style.zIndex = '10';
    ganttContainer.appendChild(svg);
    
    // === DEFINICIONES PARA FLECHAS ===
    const defs = document.createElementNS(svgNS, 'defs');
    
    // Flecha normal
    const marker = document.createElementNS(svgNS, 'marker');
    marker.setAttribute('id', 'dependency-arrow');
    marker.setAttribute('viewBox', '0 0 10 10');
    marker.setAttribute('refX', '9');
    marker.setAttribute('refY', '5');
    marker.setAttribute('markerWidth', '6');
    marker.setAttribute('markerHeight', '6');
    marker.setAttribute('orient', 'auto');
    const arrowPath = document.createElementNS(svgNS, 'path');
    arrowPath.setAttribute('d', 'M 0 0 L 10 5 L 0 10 z');
    arrowPath.setAttribute('fill', '#3498db');
    marker.appendChild(arrowPath);
    
    // Flecha con efecto hover
    const markerHover = document.createElementNS(svgNS, 'marker');
    markerHover.setAttribute('id', 'dependency-arrow-hover');
    markerHover.setAttribute('viewBox', '0 0 10 10');
    markerHover.setAttribute('refX', '9');
    markerHover.setAttribute('refY', '5');
    markerHover.setAttribute('markerWidth', '8');
    markerHover.setAttribute('markerHeight', '8');
    markerHover.setAttribute('orient', 'auto');
    const arrowPathHover = document.createElementNS(svgNS, 'path');
    arrowPathHover.setAttribute('d', 'M 0 0 L 10 5 L 0 10 z');
    arrowPathHover.setAttribute('fill', '#e74c3c');
    markerHover.appendChild(arrowPathHover);
    
    defs.appendChild(marker);
    defs.appendChild(markerHover);
    svg.appendChild(defs);

    // === TOOLTIP SIMPLIFICADO ===
    const tooltip = document.createElement('div');
    tooltip.className = 'gantt-dependency-tooltip';
    tooltip.style.cssText = `
        position: fixed;
        background: #2c3e50;
        border: 1px solid #34495e;
        border-radius: 6px;
        padding: 12px;
        font-size: 13px;
        color: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        pointer-events: none;
        transition: opacity 0.2s ease;
        opacity: 0;
        z-index: 10000;
        max-width: 250px;
        font-family: Arial, sans-serif;
        line-height: 1.4;
    `;
    document.body.appendChild(tooltip);
    
    // === OBTENER INFORMACI√ìN DE TAREAS ===
    const project = window.projects && window.projects[window.currentProjectIndex];
    const tasks = project ? project.tasks : [];
    
    // Obtener todas las barras
    const bars = Array.from(ganttContainer.querySelectorAll('.gantt-bar'));
    
    // === DIBUJAR L√çNEAS ENTRE BARRAS CONSECUTIVAS ===
    for (let i = 0; i < bars.length - 1; i++) {
        const bar1 = bars[i];
        const bar2 = bars[i + 1];
        
        const gRect = ganttContainer.getBoundingClientRect();
        const rect1 = bar1.getBoundingClientRect();
        const rect2 = bar2.getBoundingClientRect();
        
        const x1 = rect1.right - gRect.left;
        const y1 = rect1.top + rect1.height / 2 - gRect.top;
        const x2 = rect2.left - gRect.left;
        const y2 = rect2.top + rect2.height / 2 - gRect.top;
        
        if (x1 >= 0 && x2 >= 0) {
            const path = document.createElementNS(svgNS, 'path');
            const offsetX = Math.min(120, Math.abs(x2 - x1) * 0.45);
            const cp1x = x1 + offsetX;
            const cp1y = y1;
            const cp2x = x2 - offsetX;
            const cp2y = y2;
            
            path.setAttribute('d', `M ${x1} ${y1} C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${x2} ${y2}`);
            path.setAttribute('stroke', '#3498db');
            path.setAttribute('stroke-width', '3');
            path.setAttribute('fill', 'none');
            path.setAttribute('marker-end', 'url(#dependency-arrow)');
            path.style.cursor = 'pointer';
            path.style.transition = 'all 0.3s ease';
            
            svg.appendChild(path);
            
            // === AGREGAR TOOLTIP SOLO CON NOMBRES ===
            addSimpleTooltip(path, bar1, bar2, tooltip, i, tasks);
        }
    }
}

// === FUNCI√ìN SIMPLIFICADA - SOLO NOMBRES ===
function addSimpleTooltip(path, bar1, bar2, tooltip, index, tasks) {
    // Hacer la l√≠nea interactiva
    path.style.pointerEvents = 'stroke';
    
    // Obtener nombres REALES de las tareas
    const task1Name = getRealTaskName(bar1, tasks, index);
    const task2Name = getRealTaskName(bar2, tasks, index + 1);
    
    // EFECTOS VISUALES MEJORADOS
    path.addEventListener('mouseenter', (e) => {
        // Efecto luminoso y m√°s grueso
        path.style.strokeWidth = '6';
        path.style.stroke = '#e74c3c';
        path.style.filter = 'drop-shadow(0 0 8px rgba(231, 76, 60, 0.7))';
        path.setAttribute('marker-end', 'url(#dependency-arrow-hover)');
        
        // CONTENIDO DEL TOOLTIP - SOLO NOMBRES
        tooltip.innerHTML = `
            <div style="margin-bottom: 8px; font-weight: bold; color: #3498db;">
                üîó Dependencia ${index + 1}
            </div>
            
            <div style="margin-bottom: 8px;">
                <strong style="color: #e74c3c;">‚¨ÖÔ∏è Tarea Predecesora:</strong><br>
                <span style="font-size: 14px; font-weight: bold;">${task1Name}</span>
            </div>
            
            <div>
                <strong style="color: #2ecc71;">‚û°Ô∏è Tarea Actual:</strong><br>
                <span style="font-size: 14px; font-weight: bold;">${task2Name}</span>
            </div>
        `;
        
        tooltip.style.opacity = '1';
        tooltip.style.left = `${e.clientX + 15}px`;
        tooltip.style.top = `${e.clientY - 10}px`;
    });
    
    path.addEventListener('mousemove', (e) => {
        tooltip.style.left = `${e.clientX + 15}px`;
        tooltip.style.top = `${e.clientY - 10}px`;
    });
    
    path.addEventListener('mouseleave', () => {
        // Restaurar apariencia normal
        path.style.strokeWidth = '3';
        path.style.stroke = '#3498db';
        path.style.filter = 'none';
        path.setAttribute('marker-end', 'url(#dependency-arrow)');
        
        tooltip.style.opacity = '0';
    });
}

// === FUNCI√ìN PARA OBTENER NOMBRES REALES ===
function getRealTaskName(bar, tasks, index) {
    // M√©todo 1: Buscar por taskId en la fila
    const row = bar.closest('.gantt-row');
    if (row && row.dataset.taskId) {
        const taskId = row.dataset.taskId;
        const task = tasks.find(t => String(t.id) === taskId);
        if (task && (task.name || task.title)) {
            return task.name || task.title;
        }
    }
    
    // M√©todo 2: Buscar por √≠ndice
    if (tasks[index] && (tasks[index].name || tasks[index].title)) {
        return tasks[index].name || tasks[index].title;
    }
    
    // M√©todo 3: Buscar por texto en la barra
    const barText = bar.textContent || bar.innerText;
    if (barText && barText.trim()) {
        return barText.trim();
    }
    
    // √öltimo recurso: nombre por defecto
    return `Tarea ${index + 1}`;
}



/******************************
 * FUNCI√ìN DE DIAGRAMA GANTT (ACTUALIZADA CON RUTA CR√çTICA Y DEPENDENCIAS)
 ******************************/
function renderGanttChart(tasks = null) {
console.warn("‚õî renderGanttChart() desactivado.");
return;  // ‚Üê Detiene todo el contenido REAL, sin borrar nada
  try {

// === Protecci√≥n contra datos inv√°lidos ===
    if (!Array.isArray(tasks)) {
      if (tasks && typeof tasks === 'object' && Array.isArray(tasks.tasks)) {
        console.warn('‚ö†Ô∏è Corrigiendo renderGanttChart: se pas√≥ un objeto en lugar de un array, usando tasks.tasks');
        tasks = tasks.tasks;
      } else {
        console.error('‚ùå renderGanttChart recibi√≥ datos no v√°lidos:', tasks);
        return; // Evita error al hacer forEach
      }
    }

    const tasksToRender = tasks || getFilteredTasks('gantt') || [];
    const ganttContainer = document.getElementById('ganttContainer');
    if (!ganttContainer) return;

    // Limpiar
    ganttContainer.innerHTML = '';
    ganttContainer.style.position = 'relative';

    if (tasksToRender.length === 0) {
      ganttContainer.innerHTML = `
        <div class="no-tasks-message" style="
          padding: 20px;
          text-align: center;
          color: #7f8c8d;
          font-style: italic;
        ">
          <i class="fas fa-tasks" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
          No hay tareas para mostrar en el diagrama Gantt
        </div>
      `;
      return;
    }

    // Calcular ruta cr√≠tica (si tienes la funci√≥n)
    const criticalPath = typeof calculateCriticalPath === 'function' ? calculateCriticalPath(tasksToRender) : [];
    const criticalTaskIds = new Set((criticalPath || []).map(t => t.id));

    // Determinar rango de fechas (min/max)
    const dates = [];
    tasksToRender.forEach(task => {
      if (task.startDate) dates.push(new Date(task.startDate));
      if (task.deadline) dates.push(new Date(task.deadline));
    });
    if (dates.length === 0) {
      ganttContainer.innerHTML = `
        <div class="no-tasks-message" style="
          padding: 20px;
          text-align: center;
          color: #e74c3c;
          font-style: italic;
        ">
          <i class="fas fa-calendar-times" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
          Las tareas no tienen fechas definidas
        </div>
      `;
      return;
    }

    const minDate = new Date(Math.min(...dates));
    const maxDate = new Date(Math.max(...dates));
    minDate.setDate(minDate.getDate() - 2);
    maxDate.setDate(maxDate.getDate() + 2);
    const timeRange = maxDate - minDate;
    const daysInRange = Math.ceil(timeRange / (1000 * 60 * 60 * 24));

    // Contenedor principal DOM (tu encabezado + filas)
    const ganttElement = document.createElement('div');
    ganttElement.className = 'gantt-container';
    ganttElement.style.position = 'relative';

    // Encabezado (tarea + escala temporal)
    const header = document.createElement('div');
    header.className = 'gantt-header';
    const headerTask = document.createElement('div');
    headerTask.className = 'gantt-header-task';
    headerTask.textContent = 'Tarea';
    header.appendChild(headerTask);

    const headerTime = document.createElement('div');
    headerTime.className = 'gantt-header-time';
    const timeScale = document.createElement('div');
    timeScale.className = 'gantt-time-scale';

    const monthNames = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
    for (let i = 0; i <= daysInRange; i++) {
      const day = new Date(minDate);
      day.setDate(day.getDate() + i);
      const dayElement = document.createElement('div');
      dayElement.className = 'gantt-time-unit';
      dayElement.style.flexBasis = `${100 / (daysInRange || 1)}%`;
      if (day.getDay() === 0 || day.getDay() === 6) dayElement.classList.add('weekend');
      const dayNum = day.getDate();
      const monthName = monthNames[day.getMonth()];
      dayElement.innerHTML = `<span>${dayNum}</span><span style="font-size:10px">${monthName}</span>`;
      dayElement.title = day.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      timeScale.appendChild(dayElement);
    }

    headerTime.appendChild(timeScale);
    header.appendChild(headerTime);
    ganttElement.appendChild(header);

    // Filas y barras (DOM)
    tasksToRender.forEach((task, index) => {
      const row = document.createElement('div');
      row.className = 'gantt-row';
      row.dataset.taskId = task.id;

      const taskInfo = document.createElement('div');
      taskInfo.className = 'gantt-task-info';
      const taskName = document.createElement('div');
      taskName.className = 'gantt-task-name';
      taskName.textContent = task.name;
      taskName.title = task.name;
      taskInfo.appendChild(taskName);
      row.appendChild(taskInfo);

      const taskBars = document.createElement('div');
      taskBars.className = 'gantt-task-bars';

      if (task.startDate && task.deadline) {
        const startDate = new Date(task.startDate);
        const endDate = new Date(task.deadline);
        const startPos = ((startDate - minDate) / timeRange) * 100;
        const endPos = ((endDate - minDate) / timeRange) * 100;
        const width = Math.max(2, endPos - startPos);

        // Usar clases (respeta tu CSS)
        const bar = document.createElement('div');
        // a√±ade la clase exacta que ya usas en tu css para colores: 'gantt-bar' + estado
        bar.className = `gantt-bar ${task.status || ''}`;
        if (criticalTaskIds.has(task.id)) bar.classList.add('critical');

        bar.style.left = `${startPos}%`;
        bar.style.width = `${width}%`;
        bar.style.position = 'absolute';

        

        bar.addEventListener('click', () => showTaskDetails(task)); // si tienes la funci√≥n
        taskBars.appendChild(bar);
      }

      row.appendChild(taskBars);
      ganttElement.appendChild(row);

    });

    // A√±adir ganttElement al DOM
    ganttContainer.appendChild(ganttElement);
     // üëá ESTA L√çNEA DEBE ESTAR AL FINAL (despu√©s de dibujar el Gantt)
         drawDependencySVGImproved();




// === CREAR NUEVA TAREA CON PREDICCI√ìN AI + ML ===
async function createTaskWithPrediction(taskData) {
  try {
    const task = {
      id: Date.now(),
      name: taskData.name?.trim() || 'Nueva tarea',
      description: taskData.description || '',
      priority: taskData.priority || 'media',
      subtasks: taskData.subtasks || [],
      dependencies: taskData.dependencies || [],
      startDate: taskData.startDate || new Date().toISOString(),
      deadline: taskData.deadline || null,
      status: 'pendiente',
      assignee: taskData.assignee || '',
      estimatedTime: 0,
      predictedBy: ''
    };

    // Estimaci√≥n del asistente IA (tu actual predicci√≥n)
    let aiEstimate = 0;
    if (typeof AIAssistant !== 'undefined' && typeof AIAssistant.estimateTime === 'function') {
      aiEstimate = Number(AIAssistant.estimateTime(task)) || 0;
    }

    // Estimaci√≥n del modelo ML (si ya est√° entrenado)
    let mlEstimate = null;
    if (typeof predictTaskDuration === 'function' && window.durationModel) {
      mlEstimate = await predictTaskDuration(task);
    }

    // Combinar resultados sin duplicar ni chocar
    if (mlEstimate && !isNaN(mlEstimate)) {
      task.estimatedTime = (aiEstimate > 0)
        ? (aiEstimate * 0.4 + mlEstimate * 0.6)
        : mlEstimate;
      task.predictedBy = 'ML (modelo aprendido)';
    } else if (aiEstimate > 0) {
      task.estimatedTime = aiEstimate;
      task.predictedBy = 'AI Assistant (heur√≠stico)';
    } else {
      task.estimatedTime = 1;
      task.predictedBy = 'default';
    }

    // üîÑ Guardar y renderizar usando el proyecto activo
if (!projects[currentProjectIndex]) {
  console.warn('‚ö†Ô∏è No hay proyecto activo, creando uno temporal...');
  projects[currentProjectIndex] = { tasks: [] };
}

projects[currentProjectIndex].tasks.push(task);

// Guardar cambios
if (typeof saveProject === 'function') {
  saveProject();
}

// Actualizar el Gantt
if (typeof renderGanttChart === 'function') {
  renderGanttChart(projects[currentProjectIndex].tasks);

}


    showNotification?.(
      `‚ú® Estimaci√≥n autom√°tica para "${task.name}": ${task.estimatedTime} h (${task.predictedBy})`
    );
    console.log(`Predicci√≥n para "${task.name}": ${task.estimatedTime}h (${task.predictedBy})`);
  } catch (err) {
    console.error('Error creando tarea con predicci√≥n:', err);
  }
}


// === IA B√ÅSICA DE ESTIMACI√ìN DE TIEMPO ===
window.AIAssistant = {
  estimateTime(task) {
    const text = (task.name + ' ' + (task.description || '')).toLowerCase();
    let hours = 1;
    if (text.includes('api')) hours += 4;
    if (text.includes('dashboard')) hours += 3;
    if (text.includes('dise√±o')) hours += 2;
    if (text.includes('integrar')) hours += 2;
    if (text.includes('backend')) hours += 3;
    if (task.priority === 'alta') hours += 1;
    return hours;
  }
};

// === M√ìDULO DE MACHINE LEARNING SIMPLE ===
window.predictTaskDuration = async function (task) {
  if (!window.durationModel) {
    console.warn('‚ö†Ô∏è Modelo ML no entrenado, usando heur√≠stica');
    return 0;
  }
  const input = tf.tensor2d([
    [task.name.length / 10, (task.description || '').length / 50, task.priority === 'alta' ? 1 : 0]
  ]);
  const output = window.durationModel.predict(input);
  const value = (await output.data())[0];
  input.dispose(); output.dispose();
  return Math.max(1, Math.round(value));
};

// Entrenador b√°sico (usa TensorFlow.js)
window.trainDurationModel = async function () {
  console.log('üöÄ Entrenando modelo ML con datos simulados...');
  const xs = tf.tensor2d([[1, 0, 0], [5, 2, 1], [3, 1, 0], [4, 3, 1]]);
  const ys = tf.tensor2d([[2], [6], [3], [7]]);
  const model = tf.sequential();
  model.add(tf.layers.dense({ units: 8, activation: 'relu', inputShape: [3] }));
  model.add(tf.layers.dense({ units: 1 }));
  model.compile({ optimizer: 'adam', loss: 'meanSquaredError' });
  await model.fit(xs, ys, { epochs: 50 });
  window.durationModel = model;
  console.log('‚úÖ Modelo ML entrenado');
};






// üëá AQU√ç, justo despu√©s del renderGanttChart
function updateTasks() {
  saveProject();
  renderGanttChart(currentProject);
  highlightCriticalPath(currentProject);
}



// === ENLACE DEL BOT√ìN "NUEVA TAREA" CON LA PREDICCI√ìN AI+ML ===
document.getElementById('addTaskBtn')?.addEventListener('click', async () => {
  const name = document.getElementById('taskNameInput').value;
  const description = document.getElementById('taskDescInput').value;
  const priority = document.getElementById('taskPrioritySelect').value;
  const assignee = document.getElementById('taskAssigneeInput').value;

  await createTaskWithPrediction({
    name,
    description,
    priority,
    assignee
  });
});





// === MOSTRAR ETIQUETA DE RUTA CR√çTICA ===
    const container = document.querySelector('#critical-path-info') || (() => {
      const el = document.createElement('div');
      el.id = 'critical-path-info';
      el.style.margin = '10px 0';
      el.style.padding = '8px';
      el.style.background = 'rgba(255,0,0,0.1)';
      el.style.border = '1px solid red';
      el.style.borderRadius = '8px';
      el.style.fontWeight = 'bold';
      el.style.textAlign = 'center';
      el.style.fontFamily = 'sans-serif';
      ganttContainer.prepend(el); // Insertar arriba del Gantt
      return el;
    })();



try {
  const criticalTasks = (typeof calculateCriticalPath === 'function')
    ? (calculateCriticalPath(tasksToRender) || [])
    : [];

  const names = Array.isArray(criticalTasks)
    ? criticalTasks.map(t => t.name).join(' ‚Üí ')
    : '';

  container.textContent = 'Ruta cr√≠tica: ' + (names || 'No detectada');
} catch (err) {
  console.warn('No se pudo calcular la ruta cr√≠tica:', err);
  container.textContent = 'Ruta cr√≠tica: (error al calcular)';
}


 


    // -------- SVG overlay para dependencias (sin D3) --------
    // Funci√≥n que dibuja/actualiza las l√≠neas
 function drawDependencySVG() {
  // Eliminar SVG previo
  const old = ganttContainer.querySelector('.gantt-dependency-svg');
  if (old) old.remove();

  const svgNS = 'http://www.w3.org/2000/svg';
  const svg = document.createElementNS(svgNS, 'svg');
  svg.classList.add('gantt-dependency-svg');
  svg.setAttribute('width', '100%');
  svg.style.position = 'absolute';
  svg.style.top = '0';
  svg.style.left = '0';
  svg.style.pointerEvents = 'none';
  svg.style.overflow = 'visible';
  ganttContainer.appendChild(svg);

  // === DEFINICIONES ===
  const defs = document.createElementNS(svgNS, 'defs');

  // Generador de gradientes animados por estado
  const createGradient = (id, colors, dur) => {
    const grad = document.createElementNS(svgNS, 'linearGradient');
    grad.setAttribute('id', id);
    grad.setAttribute('x1', '0%');
    grad.setAttribute('x2', '100%');
    grad.setAttribute('y1', '0%');
    grad.setAttribute('y2', '0%');

    colors.forEach((c, i) => {
      const stop = document.createElementNS(svgNS, 'stop');
      stop.setAttribute('offset', `${(i / (colors.length - 1)) * 100}%`);
      stop.setAttribute('stop-color', c);
      grad.appendChild(stop);
    });

    const anim = document.createElementNS(svgNS, 'animateTransform');
    anim.setAttribute('attributeName', 'gradientTransform');
    anim.setAttribute('type', 'translate');
    anim.setAttribute('from', '-1 0');
    anim.setAttribute('to', '1 0');
    anim.setAttribute('dur', dur);
    anim.setAttribute('repeatCount', 'indefinite');
    grad.appendChild(anim);

    defs.appendChild(grad);
  };

  // Colores de tu esquema
  createGradient('grad-completada', ['#27ae60', '#2ecc71'], '6s');   // verde suave
  createGradient('grad-enprogreso', ['#16a085', '#1abc9c'], '3s');  // verde azulado r√°pido
  createGradient('grad-pendiente', ['#f1c40f', '#f39c12'], '4s');   // amarillo
  createGradient('grad-retrasada', ['#e67e22', '#e74c3c'], '8s');   // rojo lento

  // Flecha
  const marker = document.createElementNS(svgNS, 'marker');
  marker.setAttribute('id', 'gantt-arrow');
  marker.setAttribute('viewBox', '0 0 12 12');
  marker.setAttribute('refX', '11');
  marker.setAttribute('refY', '6');
  marker.setAttribute('markerWidth', '10');
  marker.setAttribute('markerHeight', '10');
  marker.setAttribute('orient', 'auto-start-reverse');

  const pathMarker = document.createElementNS(svgNS, 'path');
  pathMarker.setAttribute('d', 'M 0 0 L 12 6 L 0 12 Q 4 6 0 0');
  pathMarker.setAttribute('fill', 'url(#grad-enprogreso)');
  pathMarker.setAttribute('stroke', '#1abc9c');
  pathMarker.setAttribute('stroke-width', '0.4');
  marker.appendChild(pathMarker);
  defs.appendChild(marker);

  svg.appendChild(defs);

  // === MAPEO DE FILAS ===
  const rows = Array.from(ganttElement.querySelectorAll('.gantt-row[data-task-id]'));
  const rowMap = new Map();
  rows.forEach(row => {
    const id = row.dataset.taskId;
    const bar = row.querySelector('.gantt-bar');
    if (bar) rowMap.set(id, { row, bar });
  });

  // === TOOLTIP flotante ===
  const tooltip = document.createElement('div');
  tooltip.className = 'gantt-dependency-tooltip';
  tooltip.style.position = 'fixed';
  tooltip.style.background = 'linear-gradient(135deg, #ffffff, #f7f7f7)';
  tooltip.style.border = '1px solid rgba(0,0,0,0.15)';
  tooltip.style.borderRadius = '6px';
  tooltip.style.padding = '8px 12px';
  tooltip.style.fontSize = '12px';
  tooltip.style.color = '#2c3e50';
  tooltip.style.boxShadow = '0 4px 10px rgba(0,0,0,0.15)';
  tooltip.style.pointerEvents = 'none';
  tooltip.style.transition = 'opacity 0.2s ease';
  tooltip.style.opacity = '0';
  document.body.appendChild(tooltip);

  // === DIBUJAR DEPENDENCIAS ===
  tasksToRender.forEach(task => {
    if (!task.dependencies || task.dependencies.length === 0) return;

    task.dependencies.forEach(rawDep => {
      const depId = (typeof rawDep === 'object') ? rawDep.id : rawDep;
      const predMap = rowMap.get(String(depId));
      const fromMap = rowMap.get(String(task.id));
      if (!predMap || !predMap.bar || !fromMap || !fromMap.bar) return;

      const gRect = ganttContainer.getBoundingClientRect();
      const startRect = predMap.bar.getBoundingClientRect();
      const endRect = fromMap.bar.getBoundingClientRect();

      const x1 = startRect.right - gRect.left;
      const y1 = startRect.top + startRect.height / 2 - gRect.top;
      const x2 = endRect.left - gRect.left;
      const y2 = endRect.top + endRect.height / 2 - gRect.top;

      const offsetX = Math.min(120, Math.abs(x2 - x1) * 0.45);
      const cp1x = x1 + offsetX;
      const cp1y = y1;
      const cp2x = x2 - offsetX;
      const cp2y = y2;

      const pathEl = document.createElementNS(svgNS, 'path');
      pathEl.setAttribute('d', `M ${x1} ${y1} C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${x2} ${y2}`);
      pathEl.setAttribute('fill', 'none');

      // Detectar el estado de la tarea predecesora
     // === Detectar el estado de la tarea predecesora con tolerancia flexible ===
const bar = predMap.bar;
let state = 'pendiente';
const classes = bar.className.toLowerCase();

if (classes.includes('complet')) state = 'completada';
else if (classes.includes('progreso') || classes.includes('en_progreso') || classes.includes('en-progreso')) state = 'enprogreso';
else if (classes.includes('retras')) state = 'retrasada';
else if (classes.includes('pendien')) state = 'pendiente';

// === Definir colores y emojis seg√∫n estado ===
const stateInfo = {
  completada: { color: '#27ae60', label: 'üü¢ Completada' },
  enprogreso: { color: '#008090', label: 'üü° En progreso' },
  pendiente:  { color: '#f1c40f', label: 'üü† Pendiente' },
  retrasada:  { color: '#e74c3c', label: 'üî¥ Retrasada' }
};

// Aplica el gradiente correspondiente a la l√≠nea
pathEl.setAttribute('stroke', `url(#grad-${state})`);
pathEl.setAttribute('stroke-width', '2.8');
pathEl.setAttribute('marker-end', 'url(#gantt-arrow)');
pathEl.setAttribute('opacity', '0.95');
pathEl.style.filter = 'drop-shadow(0px 1px 2px rgba(0,0,0,0.3))';
svg.appendChild(pathEl);


// === Tooltip al pasar sobre l√≠nea (con bolita animada) ===
pathEl.style.pointerEvents = 'stroke'; // para detectar el hover sobre la l√≠nea

pathEl.addEventListener('mouseenter', e => {
  const info = stateInfo[state] || stateInfo.pendiente;
  const colorDot = `<span class="state-dot ${state}"></span>`; // bolita HTML
  tooltip.innerHTML = `
    üîó <strong>Depende de:</strong> ${predMap.row.querySelector('.gantt-task-name').textContent}<br>
    ‚û°Ô∏è <strong>Tarea:</strong> ${fromMap.row.querySelector('.gantt-task-name').textContent}<br>
    ‚è± ${colorDot}<strong>${info.label}</strong>
  `;
  tooltip.style.opacity = '1';
});

pathEl.addEventListener('mousemove', e => {
  const svgRect = svg.getBoundingClientRect();
  tooltip.style.left = `${e.clientX + 10}px`;
  tooltip.style.top = `${e.clientY + 12}px`;
});

pathEl.addEventListener('mouseleave', () => {
  tooltip.style.opacity = '0';
});







// === Tooltip al pasar sobre l√≠nea (ajustado con color y estado visual) ===
pathEl.style.pointerEvents = 'stroke';
pathEl.addEventListener('mouseenter', e => {
  const info = stateInfo[state] || stateInfo.pendiente;
 const colorDot = `<span class="state-dot ${state}"></span>`; // üëà HTML real, no texto
  tooltip.innerHTML = `
    üîó <strong>Depende de:</strong> ${predMap.row.querySelector('.gantt-task-name').textContent}<br>
    ‚û°Ô∏è <strong>Tarea:</strong> ${fromMap.row.querySelector('.gantt-task-name').textContent}<br>
    ‚è± <strong style="color:${info.color}">${info.label}</strong>
  `;
  tooltip.style.opacity = '1';
});
pathEl.addEventListener('mousemove', e => {
  const svgRect = svg.getBoundingClientRect();
  const containerRect = ganttContainer.getBoundingClientRect();
  const mouseX = e.clientX - svgRect.left;
  const mouseY = e.clientY - svgRect.top;
  tooltip.style.left = `${containerRect.left + mouseX}px`;
  tooltip.style.top = `${containerRect.top + mouseY + 12}px`;
});
pathEl.addEventListener('mouseleave', () => {
  tooltip.style.opacity = '0';
});


      pathEl.setAttribute('stroke', `url(#grad-${state})`);
      pathEl.setAttribute('stroke-width', '2.8');
      pathEl.setAttribute('marker-end', 'url(#gantt-arrow)');
      pathEl.setAttribute('opacity', '0.95');
      pathEl.style.filter = 'drop-shadow(0px 1px 2px rgba(0,0,0,0.3))';
      svg.appendChild(pathEl);

      // === Tooltip al pasar sobre l√≠nea ===
      // === Tooltip al pasar sobre l√≠nea (posicionamiento exacto) ===
pathEl.style.pointerEvents = 'stroke';
pathEl.addEventListener('mouseenter', e => {
  tooltip.innerHTML = `
    üîó <strong>Depende de:</strong> ${predMap.row.querySelector('.gantt-task-name').textContent}
    <br>‚û°Ô∏è <strong>Tarea:</strong> ${fromMap.row.querySelector('.gantt-task-name').textContent}
    <br>‚è± <strong>Estado:</strong> ${state.charAt(0).toUpperCase() + state.slice(1)}
  `;
  tooltip.style.opacity = '1';
});

pathEl.addEventListener('mousemove', e => {
  const svgRect = svg.getBoundingClientRect();
  const mouseX = e.clientX - svgRect.left;
  const mouseY = e.clientY - svgRect.top;

  // Convertimos coordenadas SVG a pantalla (usamos posici√≥n relativa del contenedor Gantt)
  const containerRect = ganttContainer.getBoundingClientRect();
  const tooltipX = containerRect.left + mouseX;
  const tooltipY = containerRect.top + mouseY + 12; // justo debajo de la l√≠nea

  tooltip.style.left = `${tooltipX}px`;
  tooltip.style.top = `${tooltipY}px`;
});

pathEl.addEventListener('mouseleave', () => {
  tooltip.style.opacity = '0';
});



      // === Animaci√≥n del trazo ===
      const totalLen = pathEl.getTotalLength();
      pathEl.style.strokeDasharray = `${totalLen} ${totalLen}`;
      pathEl.style.strokeDashoffset = `${totalLen}`;
      setTimeout(() => {
        pathEl.style.transition = 'stroke-dashoffset 1000ms cubic-bezier(.22,.9,.21,1)';
        pathEl.style.strokeDashoffset = '0';
      }, 40);
    });
  });
}












    // dibujar dependencias al final y on resize
    drawDependencySVGImproved();
    window.addEventListener('resize', () => {
      // redibujar l√≠neas para mantener posiciones correctas
     setTimeout(drawDependencySVGImproved, 100);
    });

    // Mostrar panel lateral detallado (si ya ten√≠as showTaskDetails, lo llamamos; si no, lo implementamos b√°sico)
    function showTaskDetails(task) {
      if (typeof window.showTaskDetails === 'function') {
        window.showTaskDetails(task); // usa tu implementaci√≥n si existe
        return;
      }
      // implementaci√≥n simple: crear/abrir panel lateral
      let panel = document.getElementById('ganttSidePanelSimple');
      if (!panel) {
        panel = document.createElement('div');
        panel.id = 'ganttSidePanelSimple';
        Object.assign(panel.style, {
          position: 'absolute', right: '20px', top: '20px', width: '320px', padding: '14px',
          background: '#fff', boxShadow: '0 6px 18px rgba(0,0,0,0.12)', borderRadius: '8px', zIndex: 9999
        });
        ganttContainer.appendChild(panel);
      }
      panel.innerHTML = `
        <h3 style="margin:0 0 8px 0">${task.name}</h3>
        <p><strong>Estado:</strong> ${getStatusText(task.status)}</p>
        <p><strong>Progreso:</strong> ${task.progress || 0}%</p>
        <p><strong>Responsable:</strong> ${task.assignee || task.owner || 'No asignado'}</p>
        <p><strong>Fechas:</strong> ${formatDate(task.startDate)} ‚Üí ${formatDate(task.deadline)}</p>
        <p style="margin-top:8px"><button id="ganttClosePanel">Cerrar</button></p>
      `;
      document.getElementById('ganttClosePanel').onclick = () => panel.remove();
    }

  } catch (err) {
    console.error('Error en renderGanttChart:', err);
  }
// AL FINAL de showTaskDetails, ANTES de la √∫ltima llave }
// Agrega esto:

console.log('üéØ Configurando dependencias para:', task.name);

// Poblar opciones
populateTaskDependenciesSelect(task.id);

// Configurar eventos del dropdown
setTimeout(() => {
  setupDependenciesSelector();
  
  // Restaurar selecciones si existen
  if (task.dependencies && task.dependencies.length > 0) {
    console.log('üîÑ Restaurando dependencias existentes...');
    setTimeout(() => {
      restoreDependencySelection(task.dependencies);
    }, 200);
  }
}, 100);
}






/*************************
 * GESTI√ìN DE PROYECTOS *
 *************************/
function createNewProject() {
  const projectName = prompt('Ingrese el nombre del proyecto:');
  if (!projectName) return;

  const totalTime = prompt('Ingrese el tiempo total estimado del proyecto (horas):');
  const timeValue = totalTime ? parseFloat(totalTime) || 0 : 0;

  const newProject = {
    name: projectName,
    totalProjectTime: timeValue,
    tasks: []
    
  };

  projects.push(newProject);

// üîë seleccionar el proyecto reci√©n creado
currentProjectIndex = projects.length - 1;


// üíæ persistir
updateLocalStorage();


// === AGREGAR ESTA L√çNEA ===
  if (window.syncManager) window.syncManager.notifyChange('project-changed', { 
      action: 'created', 
      projectIndex: currentProjectIndex, 
      projectName: projectName 
  });
  renderProjects();
  selectProject(currentProjectIndex);
  actualizarAsignados();
  showNotification(`‚úÖ Proyecto "${newProject.name}" creado`);
}

function renderProjects() {
  if (!projectListContainer) return;
  projectListContainer.innerHTML = '';

  projects.forEach((project, index) => {
    const li = document.createElement('li');
    li.className = 'project-item';
    li.dataset.projectIndex = index;
    
    li.innerHTML = `
      <span>${project.name}</span>
      <div class="project-menu" onclick="event.stopPropagation(); toggleProjectMenu(event, ${index})">‚ãÆ</div>
      <div class="project-context-menu" id="project-menu-${index}">
        <div class="project-context-menu-item edit" onclick="editProjectFromMenu(${index})">Editar</div>
        <div class="project-context-menu-item delete" onclick="deleteProjectFromMenu(${index})">Eliminar</div>
      </div>
    `;

    li.addEventListener('click', () => selectProject(index));
    projectListContainer.appendChild(li);
  });
}
function selectProject(index) {
  console.trace('üß≠ selectProject llamado');

  // üß† Validar √≠ndice
  if (index < 0 || index >= projects.length) {
    console.warn(`‚ö†Ô∏è √çndice de proyecto inv√°lido (${index})`);
    return;
  }

  currentProjectIndex = index;
  const project = projects[index];
  if (!project) return;

  // üìù Actualizar nombres del proyecto en todas las vistas
  if (projectNameDisplay) projectNameDisplay.textContent = project.name;
  if (projectNameList) projectNameList.textContent = project.name;
  if (projectNameCalendar) projectNameCalendar.textContent = project.name;
  if (projectNameGantt) projectNameGantt.textContent = project.name;
  if (projectNameReports) projectNameReports.textContent = project.name;

  const projectNameDashboard = document.getElementById('projectNameDashboard');
  if (projectNameDashboard) {
    projectNameDashboard.textContent = project.name;
  }

  // ‚è±Ô∏è Tiempo total del proyecto
  const totalTimeElement = document.getElementById('totalProjectTime');
  if (totalTimeElement) {
    totalTimeElement.textContent = `${project.totalProjectTime || 0} horas`;
  }

  // üîÑ Actualizaciones generales (dependen del proyecto)
  actualizarAsignados();
  renderKanbanTasks();
  updateTaskList();
  updateStatistics();
  updateProjectDatesFromTasks();
  updateProjectProgress();
  updateProjectStatusLabel();

  // üìä Reportes
  generateReports();
  generatePieChart(getStats());

  // ‚ö†Ô∏è Riesgos, acciones e hitos (forzado con peque√±o delay)
  setTimeout(() => {
    loadRisksFromLocalStorage();
    loadActionsFromLocalStorage();
    loadMilestonesFromLocalStorage();
    updateMilestonesStatus();
  }, 50);

  // üîÅ Re-renderizar dashboard SI est√° visible (CAMBIO DE PROYECTO)
  const dashboardView = document.getElementById('dashboardView');
  if (
    dashboardView &&
    getComputedStyle(dashboardView).display !== 'none'
  ) {
    console.log('üîÅ Re-render dashboard por cambio de proyecto');
    setTimeout(renderDashboard, 50);
  }

  // üîÄ Renderizar vista activa si requiere acci√≥n expl√≠cita
  const activeView = getActiveView();
  switch (activeView) {
    case 'calendar':
      renderCalendar();
      break;
    case 'profitability':
      renderProfitabilityView();
      break;
    case 'dashboard':
      // ya se maneja arriba con seguridad
      break;
  }
}
function editProjectName(index) {
  const newName = prompt('Ingrese el nuevo nombre:', projects[index].name);
  if (newName && newName.trim()) {
    projects[index].name = newName.trim();
    updateLocalStorage();
    renderProjects();
    selectProject(index);
    showNotification(`Nombre del proyecto actualizado a "${newName}"`);
  }
}

function deleteProject(index) {
  // üîπ Intentar corregir √≠ndices inv√°lidos antes de continuar
  if (index < 0 || index >= projects.length) {
    console.warn("‚ö†Ô∏è √çndice de proyecto inv√°lido:", index);

    // Buscar el proyecto activo por nombre o ID
    const currentProject = projects.find(p =>
      p.id === currentProjectId ||
      (typeof currentProject !== "undefined" && p.name === currentProject.name)
    );

    // Si lo encuentra, recalcula el √≠ndice
    if (currentProject) {
      index = projects.indexOf(currentProject);
      console.log(`‚úÖ √çndice corregido autom√°ticamente a: ${index}`);
    } else {
      showNotification("‚ö†Ô∏è No se encontr√≥ el proyecto a eliminar");
      return;
    }
  }

  const project = projects[index];
  if (!project) {
    console.warn(`‚ùå Proyecto no encontrado en √≠ndice ${index}`);
    return;
  }

  const confirmDelete = confirm(`¬øEliminar el proyecto "${project.name}"?`);
  if (!confirmDelete) return;

  // üîπ Generar una clave √∫nica (seg√∫n ID o √≠ndice)
  const projectKey = project.id ? `project_${project.id}` : `project_${index}`;

  // 1Ô∏è‚É£ Eliminar en Firebase
  if (window.firebaseManager?.isConnected) {
    window.firebaseManager.db.ref(`projects/${projectKey}`).remove()
      .then(() => console.log(`‚úÖ Proyecto eliminado en Firebase: ${projectKey}`))
      .catch(err => console.error('‚ùå Error al eliminar en Firebase:', err));
  }

  // 2Ô∏è‚É£ Eliminar datos relacionados del localStorage
  try {
    const riskKey = `projectRisks_${index}_${project.name.replace(/\s+/g, '_')}`;
    const actionKey = `projectActions_${index}`;
    const milestoneKey = `projectMilestones_${index}`;
    localStorage.removeItem(riskKey);
    localStorage.removeItem(actionKey);
    localStorage.removeItem(milestoneKey);
  } catch (e) {
    console.warn("‚ö†Ô∏è Error eliminando datos relacionados:", e);
  }

  // 3Ô∏è‚É£ Eliminar del arreglo local
  projects.splice(index, 1);
  updateLocalStorage();

  // 4Ô∏è‚É£ Reajustar selecci√≥n actual
  if (projects.length === 0) {
    createNewProject();
  } else {
    currentProjectIndex = Math.max(0, Math.min(index, projects.length - 1));
    renderProjects();
    selectProject(currentProjectIndex);
  }

  showNotification(`üóëÔ∏è Proyecto "${project.name}" eliminado correctamente`);
  console.log(`üóëÔ∏è Proyecto eliminado: ${project.name}`);
}

/*********************
 * GESTI√ìN DE TAREAS *
 *********************/
function createNewTask(e) {
    if (e) e.preventDefault();

    console.log('üîÑ Iniciando creaci√≥n de tarea...');

    // üîí Validaci√≥n robusta del proyecto actual
    if (!projects || !Array.isArray(projects)) {
        console.error('‚ùå Error: projects no est√° inicializado');
        showNotification('Error: No se pueden crear tareas en este momento');
        return false;
    }

    if (typeof currentProjectIndex === 'undefined' || currentProjectIndex === null) {
        console.error('‚ùå Error: currentProjectIndex no definido');
        showNotification('Error: No hay proyecto seleccionado');
        return false;
    }

    const currentProject = projects[currentProjectIndex];
    if (!currentProject) {
        console.error('‚ùå Error: Proyecto actual no existe en √≠ndice', currentProjectIndex);
        showNotification('Error: Proyecto no v√°lido');
        return false;
    }

    // Asegurar que el proyecto tenga array de tasks
    if (!currentProject.tasks || !Array.isArray(currentProject.tasks)) {
        console.log('üîÑ Inicializando tasks array...');
        currentProject.tasks = [];
    }

    // OBTENER VALORES
    const taskNameInput = document.getElementById('taskName');
    const taskName = taskNameInput ? taskNameInput.value.trim() : '';
    
    console.log('üìù Nombre de tarea:', taskName);

    if (!taskName) {
        showNotification('‚ùå El nombre de la tarea es requerido');
        if (taskNameInput) taskNameInput.focus();
        return false;
    }

        // MANEJO COMPLETO DE ARCHIVOS
    let taskFile = null;
    const fileInput = document.getElementById('fileUpload');
    
    if (fileInput && fileInput.files.length > 0) {
        const file = fileInput.files[0];
        
        // Validar tama√±o del archivo (m√°ximo 5MB)
        const maxSize = 5 * 1024 * 1024; // 5MB
        if (file.size > maxSize) {
            showNotification('‚ùå El archivo es demasiado grande (m√°ximo 5MB)');
            return false;
        }

        // Crear objeto fileInfo
        taskFile = {
            name: file.name,
            size: file.size,
            type: file.type,
            lastModified: file.lastModified,
            uploadDate: new Date().toISOString()
        };
        
        console.log('‚úÖ Metadatos de archivo capturados:', taskFile);
        
        // üî• GUARDADO SIMPLE Y FUNCIONAL
        try {
            const fileKey = `task_file_${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
            
            // Crear una referencia temporal que se actualizar√° despu√©s
            taskFile.key = fileKey;
            
            // Iniciar la lectura del archivo (esto sigue siendo as√≠ncrono)
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const fileData = {
                    data: e.target.result,
                    info: taskFile
                };
                
                // Guardar en localStorage
                localStorage.setItem(fileKey, JSON.stringify(fileData));
                
                console.log('üíæ Archivo guardado en localStorage:', fileKey);
            };
            
            reader.onerror = function(error) {
                console.error('‚ùå Error guardando archivo:', error);
            };
            
            reader.readAsDataURL(file);
            
        } catch (error) {
            console.error('‚ùå Error en proceso de guardado:', error);
        }
        
    } else {
        console.log('üì≠ No se encontr√≥ archivo adjunto');
    }

    // üîë STORY POINTS ‚Äî SE CONVIERTEN AQU√ç Y SOLO AQU√ç
    const storyPoints = Number(
        document.getElementById('estimatedHours')?.value || 0
    );

    console.log('üìå STORY POINTS (number) ‚Üí', storyPoints, typeof storyPoints);

    // ‚úÖ‚úÖ‚úÖ TAREA CON TODOS LOS CAMPOS NECESARIOS ‚úÖ‚úÖ‚úÖ
    const task = {
        id: Date.now(),
        name: taskName,
        startDate: document.getElementById('taskStartDate')?.value || '',
        deadline: document.getElementById('taskDeadline')?.value || '',
        priority: document.getElementById('taskPriority')?.value || 'baja',
        assignee: document.getElementById('taskAssignee')?.value || '',
        description: document.getElementById('taskDescription')?.value || '',
        status: 'pending',
    progress: 0, // ‚Üê ¬°AGREGA ESTA L√çNEA!
        // üî• CAMPO CLAVE PARA EL BURNDOWN CHART
        progress: 0, // ‚Üê ¬°ESTO ES LO QUE FALTABA!

        // üî• STORY POINTS CORRECTOS
        storyPoints: storyPoints,
        estimatedTime: storyPoints, // mismo valor, coherente

        timeLogged: 0,
        timeHistory: [],
        subtasks: [],
        dependencies: [],
        file: taskFile
    };







    console.log('‚úÖ Tarea creada:', task);
    console.group('üß™ STORY POINTS CHECK');
    console.log('storyPoints ‚Üí', task.storyPoints);
    console.log('tipo ‚Üí', typeof task.storyPoints);
    console.groupEnd();

    // AGREGAR TAREA AL PROYECTO
    try {
        currentProject.tasks.push(task);
        console.log('‚úÖ Tarea agregada al proyecto:', task.name);
        
        updateLocalStorage();
        
        // üî• NOTIFICAR A OTROS USUARIOS
        if (tiempoRealSocket && tiempoRealSocket.connected) {
            tiempoRealSocket.emit('task-changed', {
                projectId: currentProjectIndex,
                taskId: task.id,
                taskName: task.name,
                userName: 'Usuario actual',
                type: 'task-created',
                timestamp: new Date().toISOString()
            });
        }

        actualizarAsignados();
        aplicarFiltros();
        generatePieChart(getStats());
        updateProjectProgress();
        renderKanbanTasks();

        // Cerrar modal y limpiar formulario
        const createTaskModal = document.getElementById('createTaskModal');
        if (createTaskModal) {
            createTaskModal.style.display = 'none';
        }
        const form = document.getElementById('createTaskForm');
        if (form) form.reset();
        showNotification(`‚úÖ Tarea "${task.name}" creada${task.file ? ' con archivo adjunto' : ''}`);

        // ‚úÖ ACTUALIZAR EL BURNDOWN CHART
        refreshBurndown();

        refreshCalendar();
        return true;
        
    } catch (error) {
        console.error('‚ùå Error al guardar tarea:', error);
        showNotification('‚ùå Error al crear la tarea');
        return false;
    }
}


function deleteTask(taskStr) {
  const task = JSON.parse(decodeURIComponent(taskStr));
  if (confirm(`¬øEst√°s seguro de eliminar "${task.name}"? Esta acci√≥n no se puede deshacer.`)) {
    // üî• NOTIFICAR ANTES de eliminar
    console.log('üîî Intentando notificar eliminaci√≥n...');
    
    if (tiempoRealSocket && tiempoRealSocket.connected) {
      tiempoRealSocket.emit('task-changed', {
        projectId: currentProjectIndex,
        taskId: task.id,
        taskName: task.name,
        userName: 'Usuario actual',
        type: 'task-deleted',
        timestamp: new Date().toISOString()
      });
      console.log('‚úÖ Notificaci√≥n de eliminaci√≥n enviada');
    }
    
    projects[currentProjectIndex].tasks = projects[currentProjectIndex].tasks.filter(t => t.id !== task.id);
    updateLocalStorage();
    actualizarAsignados();
    aplicarFiltros();
    generatePieChart(getStats());
    updateProjectProgress();
    actualizarAsignados();
    showNotification(`Tarea "${task.name}" eliminada`);

// üî• AGREGAR ESTO AL FINAL:
  refreshCalendar();
  }
}


/*********************
 * FUNCI√ìN DE ESTIMACI√ìN CON IA *
 *********************/
function setupAIEstimation() {
    console.log('üîÑ Configurando IA...');
    
    const aiButton = document.getElementById('estimateWithAI');
    const resultElement = document.getElementById('aiEstimationResult');
    
    if (!aiButton || !resultElement) {
        console.log('‚ùå Elementos no encontrados');
        return;
    }
    
    // Clonar y reemplazar el bot√≥n para eliminar listeners antiguos
    const newButton = aiButton.cloneNode(true);
    aiButton.parentNode.replaceChild(newButton, aiButton);
    
    // Agregar listener al NUEVO bot√≥n
    newButton.addEventListener('click', function() {
        console.log('üéØ Bot√≥n de IA clickeado - Iniciando an√°lisis...');
        
        const taskName = document.getElementById('taskName')?.value.trim();
        const taskDescription = document.getElementById('taskDescription')?.value.trim();
        const priority = document.getElementById('taskPriority')?.value;
        
        if (!taskName) {
            alert('‚ùå Primero escribe el nombre de la tarea');
            return;
        }
        
        // Guardar estado original
        const originalText = this.innerHTML;
        const originalBackground = this.style.background;
        
        // Cambiar a estado de carga
        this.innerHTML = '‚è≥ Analizando...';
        this.style.background = '#3498db';
        this.disabled = true;
        
        // Limpiar resultado anterior
        resultElement.style.display = 'none';
        resultElement.innerHTML = '';
        
        setTimeout(() => {
            try {
                // An√°lisis mejorado
                const text = (taskName + ' ' + (taskDescription || '')).toLowerCase();
                console.log('üîç Analizando texto:', text);
                
                let hours = 4;
                let complexity = 2;
                let reasoning = "Tarea est√°ndar";

                // ‚úÖ AN√ÅLISIS MEJORADO - DETECCI√ìN DE COMPLEJIDAD
                // PALABRAS CLAVE POR COMPLEJIDAD
                const complexityKeywords = {
                    1: ['revisar', 'corregir', 'actualizar', 'enviar', 'verificar', 'chequear', 'limpiar', 'organizar', 'comprobar'],
                    2: ['configurar', 'crear', 'migrar', 'cargar', 'exportar', 'importar', 'backup', 'restaurar', 'instalar', 'preparar'],
                    3: ['desarrollar', 'implementar', 'integrar', 'optimizar', 'automatizar', 'procesar', 'analizar', 'probar', 'validar'],
                    4: ['dise√±ar', 'arquitectura', 'sistema', 'plataforma', 'api rest', 'base de datos', 'seguridad', 'escalar', 'monitorizar'],
                    5: ['microservicios', 'machine learning', 'inteligencia artificial', 'blockchain', 'iot', 'big data', 'transformaci√≥n', 'estrategia']
                };

                // DETECTAR COMPLEJIDAD BASADA EN PALABRAS CLAVE
                let detectedComplexity = 2; // Por defecto

                for (let [level, keywords] of Object.entries(complexityKeywords)) {
                    if (keywords.some(keyword => text.includes(keyword))) {
                        detectedComplexity = Math.max(detectedComplexity, parseInt(level));
                    }
                }

                // AJUSTAR HORAS SEG√öN COMPLEJIDAD DETECTADA
                switch(detectedComplexity) {
                    case 1:
                        hours = 2;
                        reasoning = "Tarea muy simple - Revisi√≥n/Correcci√≥n";
                        break;
                    case 2:
                        hours = 4;
                        reasoning = "Tarea simple - Configuraci√≥n/Creaci√≥n b√°sica";
                        break;
                    case 3:
                        hours = 6;
                        reasoning = "Tarea media - Desarrollo/Implementaci√≥n";
                        break;
                    case 4:
                        hours = 10;
                        reasoning = "Tarea compleja - Dise√±o/Arquitectura";
                        break;
                    case 5:
                        hours = 16;
                        reasoning = "Tarea muy compleja - Sistema avanzado";
                        break;
                }

                // ‚úÖ DETECCI√ìN ESPEC√çFICA POR TIPO DE TAREA
                if (text.includes('api') && text.includes('base de datos') && text.includes('integracion')) {
                    hours = 20;
                    complexity = 5;
                    reasoning = "üöÄ INTEGRACI√ìN COMPLEJA: M√∫ltiples sistemas conectados";
                } 
                else if (text.includes('api rest') || text.includes('rest api')) {
                    hours = 12;
                    complexity = 4;
                    reasoning = "üåê API REST: Desarrollo completo con endpoints";
                }
                else if (text.includes('microservicios')) {
                    hours = 24;
                    complexity = 5;
                    reasoning = "üîó ARQUITECTURA: Microservicios distribuidos";
                }
                else if (text.includes('api')) {
                    hours = 8;
                    complexity = 3;
                    reasoning = "‚öôÔ∏è API: Desarrollo de interfaz b√°sica";
                }
                else if (text.includes('base de datos') && (text.includes('dise√±ar') || text.includes('arquitectura'))) {
                    hours = 14;
                    complexity = 4;
                    reasoning = "üóÉÔ∏è DISE√ëO BD: Arquitectura de base de datos";
                }
                else if (text.includes('base de datos') && text.includes('optimizacion')) {
                    hours = 8;
                    complexity = 4;
                    reasoning = "üìä OPTIMIZACI√ìN BD: Mejora de rendimiento";
                }
                else if (text.includes('base de datos')) {
                    hours = 6;
                    complexity = 3;
                    reasoning = "üíæ BASE DE DATOS: Trabajo con datos";
                }
                else if (text.includes('configurar') && (text.includes('red') || text.includes('vlan') || text.includes('firewall'))) {
                    hours = 5;
                    complexity = 3;
                    reasoning = "üîß CONFIGURACI√ìN RED: Infraestructura de red";
                }
                else if (text.includes('configurar') && text.includes('servidor')) {
                    hours = 6;
                    complexity = 3;
                    reasoning = "üñ•Ô∏è CONFIGURACI√ìN: Servidor/Infraestructura";
                }
                else if (text.includes('configurar') && text.includes('equipo')) {
                    hours = 3;
                    complexity = 2;
                    reasoning = "üì± CONFIGURACI√ìN: Equipos/Dispositivos";
                }
                else if (text.includes('desarrollo') && text.includes('completo')) {
                    hours = 15;
                    complexity = 4;
                    reasoning = "üíª DESARROLLO: Sistema completo desde cero";
                }
                else if (text.includes('desarrollo') || text.includes('implementar')) {
                    hours = 8;
                    complexity = 3;
                    reasoning = "üíª DESARROLLO: M√≥dulo/funcionalidad";
                }
                else if (text.includes('revisar') || text.includes('corregir')) {
                    hours = 2;
                    complexity = 1;
                    reasoning = "üìù REVISI√ìN: An√°lisis y correcciones";
                }
                else if (text.includes('dise√±ar') || text.includes('dise√±o') || text.includes('ui/ux')) {
                    hours = 6;
                    complexity = 3;
                    reasoning = "üé® DISE√ëO: Trabajo creativo/planificaci√≥n";
                }
                else if (text.includes('documentaci√≥n') || text.includes('documentar') || text.includes('manual')) {
                    hours = 3;
                    complexity = 2;
                    reasoning = "üìö DOCUMENTACI√ìN: Creaci√≥n/actualizaci√≥n";
                }
                else if (text.includes('testing') || text.includes('pruebas') || text.includes('qa')) {
                    hours = 4;
                    complexity = 2;
                    reasoning = "üß™ TESTING: Pruebas y control calidad";
                }
                else if (text.includes('machine learning') || text.includes('ia') || text.includes('inteligencia artificial')) {
                    hours = 20;
                    complexity = 5;
                    reasoning = "ü§ñ IA/ML: Modelo de inteligencia artificial";
                }
                else if (text.includes('mobile') || text.includes('app m√≥vil') || text.includes('android') || text.includes('ios')) {
                    hours = 12;
                    complexity = 4;
                    reasoning = "üì± APP M√ìVIL: Desarrollo aplicaci√≥n m√≥vil";
                }

                // ‚úÖ AJUSTES POR CONTEXTO ESPEC√çFICO
                if (text.includes('complej') || text.includes('complicad') || text.includes('dif√≠cil') || text.includes('avanzad') || text.includes('cr√≠tic')) {
                    hours *= 1.4;
                    complexity = Math.min(5, complexity + 1);
                    reasoning += " | üî¥ COMPLEJO";
                }

                if (text.includes('simple') || text.includes('f√°cil') || text.includes('b√°sico') || text.includes('r√°pido') || text.includes('sencillo')) {
                    hours *= 0.7;
                    complexity = Math.max(1, complexity - 1);
                    reasoning += " | üü¢ SIMPLE";
                }

                if (text.includes('urgent') || text.includes('cr√≠tic') || text.includes('prioridad') || text.includes('inmediat')) {
                    hours *= 1.2;
                    reasoning += " | ‚ö° URGENTE";
                }

                // ‚úÖ AJUSTAR POR PRIORIDAD SELECCIONADA
                if (priority === 'alta') {
                    hours *= 1.3;
                    reasoning += " | üî• ALTA PRIORIDAD";
                } else if (priority === 'baja') {
                    hours *= 0.8;
                    reasoning += " | üê¢ BAJA PRIORIDAD";
                }

                // ‚úÖ REDONDEAR Y LIMITAR
                hours = Math.max(0.5, Math.min(40, Math.round(hours * 2) / 2));
                complexity = Math.max(1, Math.min(5, complexity));
                
                console.log('üìä Estimaci√≥n final:', { hours, complexity, reasoning });

                // Actualizar campo
                document.getElementById('estimatedHours').value = hours;
                
                // ‚úÖ MOSTRAR RESULTADO DEBAJO DEL CAMPO
                resultElement.innerHTML = `
                    <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; padding: 10px;">
                        <div style="font-weight: bold; color: #155724; margin-bottom: 5px;">
                            üß† SUGERENCIA DE IA
                        </div>
                        <div style="color: #155724;">
                            <strong>${hours} horas</strong> | Complejidad: ${complexity}/5
                        </div>
                        <div style="color: #0c5460; font-size: 12px; margin-top: 4px;">
                            ${reasoning}
                        </div>
                        <div style="color: #6c757d; font-size: 11px; margin-top: 6px; border-top: 1px solid #b8daff; padding-top: 4px;">
                            üí° Basado en an√°lisis de palabras clave y contexto
                        </div>
                    </div>
                `;
                resultElement.style.display = 'block';
                
                // ‚úÖ Opcional: Tambi√©n mostrar notificaci√≥n r√°pida
                if (typeof showNotification === 'function') {
                    showNotification(`‚úÖ IA sugiere: ${hours} horas`);
                }
                
            } catch (error) {
                console.error('‚ùå Error en IA:', error);
                
                // ‚úÖ Mostrar error en el mismo lugar
                resultElement.innerHTML = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 10px; color: #721c24;">
                        ‚ùå Error en estimaci√≥n IA. Usa tu criterio profesional.
                    </div>
                `;
                resultElement.style.display = 'block';
                
            } finally {
                // SIEMPRE restaurar el bot√≥n
                this.innerHTML = 'üß† Estimar con IA';
                this.style.background = originalBackground;
                this.disabled = false;
            }
        }, 800);
    });
    
    console.log('‚úÖ IA configurada con detecci√≥n mejorada de complejidades');
}




// ============================================
// üõ°Ô∏è INTERCEPTOR PERMANENTE DE DEPENDENCIAS
// ============================================
// Este c√≥digo previene que currentDependencies se vac√≠e autom√°ticamente
// cuando se cierra el dropdown de dependencias

console.log('üõ°Ô∏è Cargando interceptor permanente de dependencias...');

// 1. INTERCEPTOR PARA PROTEGER currentDependencies
let _currentDependenciesBackup = [];
let _dependencyInterceptorActive = false;

function activateDependencyProtection() {
    if (_dependencyInterceptorActive) return;
    
    console.log('üîí Activando protecci√≥n de dependencias...');
    
    // Guardar el valor original si existe
    const originalValue = window.currentDependencies;
    
    // Crear getter/setter protegido
    Object.defineProperty(window, 'currentDependencies', {
        get() {
            return this._protectedDependencies || [];
        },
        set(newValue) {
            // Si se intenta vaciar y tenemos valores, preguntar
            if (Array.isArray(newValue) && newValue.length === 0 && 
                this._protectedDependencies && this._protectedDependencies.length > 0) {
                
                console.log('‚ö†Ô∏è Intento de vaciar dependencias bloqueado');
                console.log('   Dependencias actuales:', this._protectedDependencies);
                
                // NO permitir el vaciado - mantener valores actuales
                return;
            }
            
            // Guardar backup si hay valores
            if (newValue && newValue.length > 0) {
                _currentDependenciesBackup = [...newValue];
            }
            
            this._protectedDependencies = newValue;
            console.log('‚úÖ currentDependencies actualizado:', newValue);
        },
        configurable: true,
        enumerable: true
    });
    
    // Inicializar con valor original si existe
    if (originalValue) {
        window.currentDependencies = originalValue;
    }
    
    _dependencyInterceptorActive = true;
    console.log('‚úÖ Protecci√≥n de dependencias activada');
}

// 2. PARCHE PARA updateSelectedDepsView (l√≠nea ~4269)
function patchUpdateSelectedDepsView() {
    console.log('üîß Buscando updateSelectedDepsView para parchear...');
    
    // Esta funci√≥n se ejecuta cuando se configuran dependencias
    // Necesitamos prevenir que vac√≠e currentDependencies
    
    // Buscar en el c√≥digo la funci√≥n problem√°tica
    if (typeof updateSelectedDepsView === 'function') {
        const originalFunction = updateSelectedDepsView;
        
        updateSelectedDepsView = function() {
            console.log('üéØ updateSelectedDepsView interceptada');
            
            // Verificar si currentDependencies ya tiene valores
            if (window.currentDependencies && window.currentDependencies.length > 0) {
                console.log('‚úÖ Preservando dependencias existentes:', window.currentDependencies);
                
                // NO ejecutar la funci√≥n original que vac√≠a
                // En su lugar, solo actualizar la vista si es necesario
                
                // Actualizar contador en la UI si existe
                const placeholder = document.querySelector('.deps-placeholder, [class*="deps"]');
                if (placeholder) {
                    const count = window.currentDependencies.length;
                    placeholder.textContent = `${count} dependencia(s) seleccionada(s)`;
                }
                
                return;
            }
            
            // Si no hay dependencias, ejecutar normal
            return originalFunction.apply(this, arguments);
        };
        
        console.log('‚úÖ updateSelectedDepsView parcheada');
    } else {
        console.log('‚ö†Ô∏è updateSelectedDepsView no encontrada, creando parche preventivo');
        
        // Crear funci√≥n dummy si no existe
        window.updateSelectedDepsView = function() {
            console.log('üõ°Ô∏è updateSelectedDepsView (parche) - No vac√≠a dependencias');
        };
    }
}

// 3. FUNCI√ìN PARA CARGAR DEPENDENCIAS EXISTENTES AL ABRIR TAREA
function loadExistingDependenciesToDropdown() {
    // Esta funci√≥n debe llamarse DESPU√âS de que se abra el modal de tarea
    // y se haya configurado el dropdown
    
    const select = document.querySelector('#dependency-styles, select[id*="dependency"]');
    if (!select) {
        console.log('‚ö†Ô∏è Dropdown no encontrado para cargar dependencias');
        return;
    }
    
    if (!window.currentDependencies || window.currentDependencies.length === 0) {
        console.log('‚ÑπÔ∏è No hay dependencias para cargar al dropdown');
        return;
    }
    
    console.log('üì• Cargando dependencias al dropdown:', window.currentDependencies);
    
    // Marcar opciones como seleccionadas
    Array.from(select.options || []).forEach(option => {
        if (window.currentDependencies.includes(option.value)) {
            option.selected = true;
            console.log(`   ‚úì Marcada: ${option.text} (${option.value})`);
        }
    });
    
    // Forzar evento change para actualizar UI
    select.dispatchEvent(new Event('change', { bubbles: true }));
    
    console.log('‚úÖ Dependencias cargadas al dropdown');
}

// 4. INTERCEPTAR showTaskDetails PARA CARGAR DEPENDENCIAS
function interceptShowTaskDetails() {
    if (typeof showTaskDetails !== 'function') {
        console.log('‚ùå showTaskDetails no encontrada');
        return;
    }
    
    const originalShowTaskDetails = showTaskDetails;
    
    showTaskDetails = function(task) {
        console.log('üéØ showTaskDetails interceptada para:', task.name);
        
        // Llamar funci√≥n original
        const result = originalShowTaskDetails.apply(this, arguments);
        
        // Despu√©s de que se muestre el modal, cargar dependencias al dropdown
        setTimeout(() => {
            loadExistingDependenciesToDropdown();
        }, 500);
        
        return result;
    };
    
    console.log('‚úÖ showTaskDetails interceptada correctamente');
}

// 5. INICIALIZAR TODO CUANDO SE CARGA LA P√ÅGINA
function initializeDependencySystem() {
    console.log('üöÄ Inicializando sistema de dependencias permanente...');
    
    // Activar protecci√≥n
    activateDependencyProtection();
    
    // Parchear funci√≥n problem√°tica
    setTimeout(patchUpdateSelectedDepsView, 1000);
    
    // Interceptar apertura de tareas
    setTimeout(interceptShowTaskDetails, 1500);
    
    // Tambi√©n monitorear cuando se abre el modal
    const modal = document.getElementById('taskDetails');
    if (modal) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                    if (modal.style.display !== 'none') {
                        console.log('üéØ Modal de tarea abierto - Configurando dependencias...');
                        
                        // Esperar a que cargue el dropdown
                        setTimeout(() => {
                            loadExistingDependenciesToDropdown();
                        }, 800);
                    }
                }
            });
        });
        
        observer.observe(modal, { attributes: true });
        console.log('‚úÖ Observer configurado para modal');
    }
    
    console.log('‚úÖ Sistema de dependencias inicializado permanentemente');
}

// 6. EJECUTAR INICIALIZACI√ìN
// Ejecutar cuando el DOM est√© listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeDependencySystem);
} else {
    initializeDependencySystem();
}

// ============================================
// üéÆ COMANDOS DE DIAGN√ìSTICO (opcional - para desarrollo)
// ============================================

window.debugDependencies = function() {
    console.log('üîç DIAGN√ìSTICO DE DEPENDENCIAS:');
    console.log('   - currentDependencies:', window.currentDependencies);
    console.log('   - Backup:', _currentDependenciesBackup);
    console.log('   - Interceptor activo:', _dependencyInterceptorActive);
    
    // Verificar localStorage
    try {
        const projectsJSON = localStorage.getItem('projects');
        if (projectsJSON) {
            const projects = JSON.parse(projectsJSON);
            
            // Buscar tarea actual
            const modal = document.getElementById('taskDetails');
            if (modal && modal.style.display !== 'none') {
                const inputs = modal.querySelectorAll('input');
                for (let input of inputs) {
                    if (input.value && /^\d{10,}$/.test(input.value)) {
                        const taskId = parseInt(input.value);
                        
                        for (let project of projects) {
                            if (project.tasks) {
                                const task = project.tasks.find(t => t.id === taskId);
                                if (task) {
                                    console.log(`   - Tarea "${task.name}" en localStorage:`);
                                    console.log(`     * Dependencias:`, task.dependencies || '[]');
                                    break;
                                }
                            }
                        }
                        break;
                    }
                }
            }
        }
    } catch (e) {
        console.log('   - Error leyendo localStorage:', e.message);
    }
};

console.log('üõ°Ô∏è Interceptor permanente de dependencias cargado');





/*********************
 * GESTI√ìN DE TAREAS *
 *********************/

function showTaskDetails(task) {
  if (!taskDetailsModal || !task) return;
  
  const taskDetailsContent = document.getElementById('taskDetails');
  if (!taskDetailsContent) return;

  // Calcular progreso de subtareas
  const completedSubtasks = task.subtasks?.filter(st => st.completed).length || 0;
  const totalSubtasks = task.subtasks?.length || 0;
  const subtaskProgress = totalSubtasks > 0 ? Math.round((completedSubtasks / totalSubtasks) * 100) : 0;

  // Calcular estado de tiempo
  const timeDifference = (task.estimatedTime || 0) - (task.timeLogged || 0);
  const timeStatus = timeDifference >= 0 ? 'En tiempo' : 'Fuera de tiempo';
  const timeStatusClass = timeDifference >= 0 ? 'time-good' : 'time-bad';

  // Archivo adjunto
  const fileHTML = task.file ? `
    <div class="detail-group">
        <label>Archivo adjunto:</label>
        <div class="file-attachment">
            <i class="fas fa-paperclip"></i>
            <span class="file-name">${task.file.name}</span>
            <span class="file-size">(${formatFileSize(task.file.size)})</span>
            <button class="download-btn" data-task-id="${task.id}">
                <i class="fas fa-download"></i> Descargar
            </button>
        </div>
    </div>
  ` : '';

  // ==========================
  //   HTML DEL MODAL LIMPIO
  // ==========================
  taskDetailsContent.innerHTML = `

    <div class="task-details-container">

      <div class="task-details-header">
        <span class="close-detail">&times;</span>
        <h3>${task.name}</h3>
        <div class="task-meta-header">
          <span class="priority-badge ${task.priority}">${capitalizeFirstLetter(task.priority)}</span>
          <span class="status-badge ${task.status}">${getStatusText(task.status)}</span>
        </div>
      </div>

      <div class="task-details-grid">


 <div class="detail-group">
            <label>Asignado a:</label>
            <input type="text" id="editTaskAssignee" class="editable-input" value="${task.assignee || ''}">
          </div>
        </div>


        <div class="details-column">
          <div class="detail-group">
            <label>Fecha Inicio:</label>
            <input type="date" id="editTaskStartDate" class="editable-input" value="${task.startDate || ''}">
          </div>

          <div class="detail-group">
            <label>Fecha L√≠mite:</label>
            <input type="date" id="editTaskDeadline" class="editable-input" value="${task.deadline || ''}">
          </div>


  ${fileHTML}
</div>



         


        <div class="details-column">
          <div class="detail-group">
            <label>Tiempo Estimado:</label>
            <input type="number" id="editTaskEstimatedHours" class="editable-input" value="${task.estimatedTime || 0}" step="0.5" min="0">
          </div>

          <div class="detail-group">
            <label>Tiempo Registrado:</label>
            <div class="detail-value">${task.timeLogged || 0} horas</div>
          </div>

          <div class="detail-group">
            <label>Prioridad:</label>
            <div class="detail-value">${capitalizeFirstLetter(task.priority)}</div>
          </div>


          <div class="detail-group">
            <label>Estado Tiempo:</label>
            <div class="detail-value ${timeStatusClass}">
              ${timeStatus} (${Math.abs(timeDifference).toFixed(1)}h ${timeDifference >= 0 ? 'restantes' : 'excedidas'})
            </div>
          </div>
        </div>
  ${fileHTML}
</div>
      
      <div class="detail-group full-width">
        <label>Descripci√≥n:</label>
        <textarea id="editTaskDescription" class="editable-textarea description-text" rows="4">${task.description || ''}</textarea>
      </div>

      <div class="detail-group full-width">
        <div class="subtasks-header">
          <h4>Subtareas (${subtaskProgress}% completado)</h4>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${subtaskProgress}%"></div>
          </div>
        </div>

        <div class="subtasks-list" id="subtasksList-${task.id}">
          ${renderSubtasks(task.subtasks || [], task.id)}
        </div>

        <div class="add-subtask-form">
          <input type="text" id="newSubtaskInput-${task.id}" placeholder="Nueva subtarea">
          <button onclick="addSubtask(${task.id})">Agregar</button>
        </div>
      </div>

      <div class="time-tracking-section">
        <h4>Registro de Tiempo</h4>

        <div class="time-entry-form">
          <div class="form-group">
            <label for="timeSpent">Horas trabajadas:</label>
            <input type="number" id="timeSpent" placeholder="Ej: 1.5" step="0.1" min="0">
          </div>

          <div class="form-group">
            <label for="timeComment">Comentario:</label>
            <textarea id="timeComment" placeholder="Descripci√≥n del trabajo realizado"></textarea>
          </div>

          <button type="button" id="registerTimeBtn" class="btn-save">Registrar Tiempo</button>
        </div>

        <div class="time-history">
          <h4>Historial de Tiempo</h4>
          <div id="timeHistoryList">${renderTimeHistory(task.timeHistory || [])}</div>
        </div>
      </div>

      <div class="task-details-footer">
        <button type="button" id="cancelEditBtn" class="btn-cancel">Cancelar</button>
        <button type="submit" id="saveTaskBtn" class="btn-save">Guardar Cambios</button>
      </div>

    </div>
  `;



// ================================================
  // ‚úÖ AGREGAR AQU√ç EL EVENTO DEL BOT√ìN DE DESCARGA
  // ================================================
  const downloadBtn = taskDetailsContent.querySelector('.download-btn');
  if (downloadBtn && task.file) {
    downloadBtn.addEventListener('click', function(e) {
      e.preventDefault();
      console.log('üì• Bot√≥n de descarga clickeado para tarea:', task.id);
      downloadTaskFile(task.id);
    });
  }

  // Evento para registrar tiempo <=== ESTE YA EXISTE (NO LO MODIFIQUES)
  document.getElementById('registerTimeBtn').addEventListener('click', () => {
    const hours = parseFloat(document.getElementById('timeSpent').value);
    const comment = document.getElementById('timeComment').value.trim() || 'Sin comentario';

    if (!isNaN(hours) && hours > 0) {
      // ... c√≥digo existente ...
    }
  });



  // Evento para registrar tiempo
  document.getElementById('registerTimeBtn').addEventListener('click', () => {
    const hours = parseFloat(document.getElementById('timeSpent').value);
    const comment = document.getElementById('timeComment').value.trim() || 'Sin comentario';

    if (!isNaN(hours) && hours > 0) {
      const now = new Date();
      const timeEntry = {
        date: now.toLocaleDateString() + ' ' + now.toLocaleTimeString(),
        hours: hours,
        comment: comment
      };

      task.timeHistory = task.timeHistory || [];
task.timeLogged = (task.timeLogged || 0) + hours;
task.timeHistory.unshift(timeEntry);

// ‚úÖ FIX: asegurar entradas de tiempo para reportes
if (!Array.isArray(task.timeLoggedEntries)) {
    task.timeLoggedEntries = [];
}

task.timeLoggedEntries.unshift({
    hours: Number(hours),
    date: timeEntry?.date || new Date().toISOString()
});


      const estimatedHoursInput = document.getElementById('editTaskEstimatedHours');
      if (estimatedHoursInput) {
        task.estimatedTime = parseFloat(estimatedHoursInput.value) || 0;
      }

      updateLocalStorage();
      showTaskDetails(task);
      generateReports();
      showNotification('Tiempo registrado exitosamente');
    } else {
      showNotification('Por favor ingrese un valor v√°lido para las horas');
    }
  });

  document.getElementById('saveTaskBtn').addEventListener('click', () => {
    saveTaskChanges(task.id);
  });

  document.getElementById('cancelEditBtn').addEventListener('click', () => {
    taskDetailsModal.style.display = 'none';
  });

  document.querySelector('.close-detail').addEventListener('click', () => {
    taskDetailsModal.style.display = 'none';
  });

  taskDetailsModal.style.display = 'block';
}










// FUERA de showTaskDetails, en el mismo archivo:

function showDependenciesManager(task) {
  console.log('üìã Abriendo gestor de dependencias para:', task.name);
  
  // Verificar que tenemos acceso a projects
  if (!window.projects || window.projects.length === 0) {
    console.error('‚ùå No hay proyectos disponibles');
    alert('Error: No hay proyectos cargados');
    return;
  }
  
  // Asegurar currentProjectIndex
  if (typeof window.currentProjectIndex === 'undefined') {
    window.currentProjectIndex = 0;
    console.log('‚ö†Ô∏è currentProjectIndex no definido, usando 0');
  }
  
  const project = window.projects[window.currentProjectIndex];
  if (!project) {
    console.error(`‚ùå Proyecto en √≠ndice ${window.currentProjectIndex} no encontrado`);
    alert('Error: No se pudo encontrar el proyecto');
    return;
  }
  
  console.log('üìä Proyecto encontrado:', project.name);
  
  // Crear modal simple
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 0 40px rgba(0,0,0,0.4);
    z-index: 10000;
    width: 450px;
    max-height: 80vh;
    overflow-y: auto;
    border: 3px solid #4CAF50;
  `;
  
  const availableTasks = (project.tasks || []).filter(t => t.id !== task.id);
  
  modal.innerHTML = `
    <div style="margin-bottom: 20px;">
      <h3 style="margin: 0 0 10px 0; color: #2E7D32; border-bottom: 2px solid #4CAF50; padding-bottom: 10px;">
        üéØ Dependencias de: <span style="color: #1565C0;">${task.name}</span>
      </h3>
      <p style="margin: 0; color: #666; font-size: 14px;">
        Selecciona las tareas que deben completarse antes de esta tarea.
      </p>
    </div>
    
    <div style="margin: 20px 0; max-height: 350px; overflow-y: auto; padding-right: 10px;">
      ${availableTasks.length > 0 ? 
        availableTasks.map(t => `
          <div style="
            margin: 10px 0;
            padding: 12px;
            border: 2px solid ${task.dependencies?.includes(t.id) ? '#4CAF50' : '#e0e0e0'};
            border-radius: 8px;
            background: ${task.dependencies?.includes(t.id) ? '#f0f9f0' : 'white'};
            transition: all 0.2s;
          ">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" value="${t.id}" 
                     ${task.dependencies?.includes(t.id) ? 'checked' : ''}
                     style="margin-right: 12px; width: 20px; height: 20px; accent-color: #4CAF50;">
              <div style="flex: 1;">
                <div style="font-weight: bold; color: #333; margin-bottom: 4px;">${t.name}</div>
                <div style="font-size: 12px; color: #666;">
                  ID: ${t.id} ‚Ä¢ Estado: <span class="status-badge" style="
                    background: ${t.status === 'completed' ? '#4CAF50' : 
                                 t.status === 'in_progress' ? '#2196F3' : 
                                 t.status === 'overdue' ? '#f44336' : '#9E9E9E'};
                    color: white;
                    padding: 2px 8px;
                    border-radius: 10px;
                    font-size: 11px;
                  ">${t.status || 'pending'}</span>
                </div>
              </div>
            </label>
          </div>
        `).join('') : 
        `<div style="padding: 30px; text-align: center; color: #666; font-style: italic; border: 2px dashed #ddd; border-radius: 8px;">
          <div style="font-size: 48px; margin-bottom: 10px;">üì≠</div>
          <div style="font-size: 16px; margin-bottom: 5px;">No hay otras tareas disponibles</div>
          <div style="font-size: 14px;">Crea m√°s tareas en este proyecto para agregar dependencias.</div>
        </div>`
      }
    </div>
    
    <div style="
      display: flex;
      justify-content: space-between;
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    ">
      <button id="cancelDeps" style="
        padding: 12px 25px;
        background: #f5f5f5;
        border: 2px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        color: #666;
        transition: all 0.2s;
      " onmouseover="this.style.background='#e0e0e0'" onmouseout="this.style.background='#f5f5f5'">
        Cancelar
      </button>
      
      <button id="saveDeps" style="
        padding: 12px 25px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        font-size: 15px;
        transition: all 0.2s;
      " onmouseover="this.style.background='#3d8b40'; this.style.transform='scale(1.05)'" 
         onmouseout="this.style.background='#4CAF50'; this.style.transform='scale(1)'">
        üíæ Guardar Dependencias
      </button>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Overlay de fondo
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    z-index: 9999;
    backdrop-filter: blur(3px);
  `;
  
  // Cerrar modal
  function closeModal() {
    if (overlay.parentNode) document.body.removeChild(overlay);
    if (modal.parentNode) document.body.removeChild(modal);
  }
  
  overlay.addEventListener('click', closeModal);
  document.body.appendChild(overlay);
  
  // Configurar botones
  document.getElementById('cancelDeps').addEventListener('click', closeModal);
  
  document.getElementById('saveDeps').addEventListener('click', function() {
    const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked');
    const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    console.log('üíæ Guardando dependencias:', selectedIds);
    
    // Actualizar la tarea en el array
    const project = window.projects[window.currentProjectIndex];
    if (project && project.tasks) {
      const taskIndex = project.tasks.findIndex(t => t.id === task.id);
      if (taskIndex !== -1) {
        // Actualizar ambas referencias
        window.projects[window.currentProjectIndex].tasks[taskIndex].dependencies = selectedIds;
        task.dependencies = selectedIds; // Tambi√©n actualizar la tarea actual
        
        updateLocalStorage();
        showNotification('‚úÖ Dependencias guardadas correctamente');
        
        // Actualizar la vista si existe
        const depsList = document.getElementById('simpleDepsList');
        if (depsList) {
          showCurrentDependencies(task);
        }
      }
    }
    
    closeModal();
  });
  
  // Cerrar con ESC
  const escHandler = function(e) {
    if (e.key === 'Escape') closeModal();
  };
  document.addEventListener('keydown', escHandler);
  
  // Limpiar event listener al cerrar
  modal._closeModal = closeModal;
  modal._escHandler = escHandler;
}








function showCurrentDependencies(task) {
  const depsList = document.getElementById('simpleDepsList');
  if (!depsList) return;
  
  if (task.dependencies && task.dependencies.length > 0) {
    // Obtener nombres de las tareas dependientes
    const project = window.projects[window.currentProjectIndex];
    const dependencyNames = [];
    
    task.dependencies.forEach(depId => {
      const depTask = project?.tasks?.find(t => t.id === depId);
      if (depTask) {
        dependencyNames.push(depTask.name);
      }
    });
    
    depsList.innerHTML = `
      <div style="color: #2E7D32; font-weight: bold; margin-bottom: 5px;">
        ${task.dependencies.length} dependencia(s):
      </div>
      <ul style="margin: 0; padding-left: 20px; color: #333;">
        ${dependencyNames.map(name => `<li>${name}</li>`).join('')}
      </ul>
    `;
  } else {
    depsList.innerHTML = `
      <div style="color: #666; font-style: italic;">
        No hay dependencias configuradas
      </div>
    `;
  }
}







// ‚úÖ VERSI√ìN CORREGIDA - CON MANEJO DE ESTILOS
function setupDependenciesSelector() {
  console.log('‚öôÔ∏è Configurando selector de dependencias...');
  
  const header = document.getElementById('taskDependenciesHeader');
  const itemsDiv = document.getElementById('taskDependenciesItems');
  
  if (!header || !itemsDiv) {
    console.warn('‚ö†Ô∏è Elementos del selector no encontrados');
    return;
  }
  
  console.log('‚úÖ Elementos encontrados, configurando...');
  
  // Solo un event listener b√°sico
  header.addEventListener('click', function(e) {
    e.stopPropagation();
    console.log('üñ±Ô∏è Click en selector');
    
    // Alternar visibilidad
    if (itemsDiv.style.display === 'none' || !itemsDiv.style.display) {
      itemsDiv.style.display = 'block';
      header.classList.add('active');
      console.log('üìñ Dropdown abierto');
    } else {
      itemsDiv.style.display = 'none';
      header.classList.remove('active');
      console.log('üìï Dropdown cerrado');
    }
  });
  
  // Cerrar al hacer clic fuera
  document.addEventListener('click', function(e) {
    if (!header.contains(e.target) && !itemsDiv.contains(e.target)) {
      if (itemsDiv.style.display === 'block') {
        itemsDiv.style.display = 'none';
        header.classList.remove('active');
        console.log('üëÜ Clic fuera - cerrado');
      }
    }
  });
}



// ‚úÖ AGREGAR ESTA FUNCI√ìN PARA ACTUALIZAR LA VISTA (si no existe)
function updateSelectedDependenciesView() {
  const itemsDiv = document.getElementById('taskDependenciesItems');
  const selectedDiv = document.getElementById('selectedDependencies');
  const header = document.getElementById('taskDependenciesHeader');
  const placeholder = header?.querySelector('.placeholder');
  
  if (!itemsDiv || !selectedDiv || !header) {
    console.error('‚ùå Elementos para actualizar vista no encontrados');
    return;
  }
  
  // Obtener opciones seleccionadas
  const selectedOptions = Array.from(itemsDiv.querySelectorAll('div[data-id].selected'));
  
  // Actualizar el header
  if (selectedOptions.length > 0) {
    if (placeholder) {
      placeholder.textContent = `${selectedOptions.length} dependencia(s) seleccionada(s)`;
    }
    header.classList.add('has-selection');
  } else {
    if (placeholder) {
      placeholder.textContent = '-- Seleccione tareas predecesoras --';
    }
    header.classList.remove('has-selection');
  }
  
  // Actualizar la lista de seleccionados
  selectedDiv.innerHTML = '';
  selectedOptions.forEach(option => {
    const badge = document.createElement('div');
    badge.className = 'dependency-badge';
    badge.innerHTML = `
      ${option.textContent}
      <span class="remove-badge" data-id="${option.dataset.id}">&times;</span>
    `;
    selectedDiv.appendChild(badge);
  });
  
  // Agregar event listeners a los badges de eliminaci√≥n
  selectedDiv.querySelectorAll('.remove-badge').forEach(badge => {
    badge.addEventListener('click', function(e) {
      e.stopPropagation();
      const id = this.dataset.id;
      const option = itemsDiv.querySelector(`div[data-id="${id}"]`);
      if (option) {
        option.classList.remove('selected');
        updateSelectedDependenciesView();
      }
    });
  });
  
  console.log(`üìä ${selectedOptions.length} dependencia(s) seleccionada(s)`);
}function renderSubtasks(subtasks, taskId) {
  if (!subtasks || subtasks.length === 0) {
    return '<div class="no-subtasks">No hay subtareas definidas</div>';
  }
  
  return subtasks.map((subtask, index) => `
    <div class="subtask-item" data-subtask-id="${subtask.id}">
      <input type="checkbox" ${subtask.completed ? 'checked' : ''} 
             onchange="toggleSubtaskCompletion(${taskId}, ${subtask.id}, this.checked)">
      <span class="subtask-text ${subtask.completed ? 'completed' : ''}">${subtask.name}</span>
      <button class="subtask-delete" onclick="deleteSubtask(${taskId}, ${subtask.id})">
        <i class="fas fa-trash"></i>
      </button>
    </div>
  `).join('');
}

function renderSubtasks(subtasks, taskId) {
  if (!subtasks || subtasks.length === 0) {
    return '<div class="no-subtasks">No hay subtareas definidas</div>';
  }
  
  return subtasks.map((subtask, index) => `
    <div class="subtask-item" data-subtask-id="${subtask.id}">
      <input type="checkbox" ${subtask.completed ? 'checked' : ''} 
             onchange="toggleSubtaskCompletion(${taskId}, ${subtask.id}, this.checked)">
      <span class="subtask-text ${subtask.completed ? 'completed' : ''}">${subtask.name}</span>
      <button class="subtask-delete" onclick="deleteSubtask(${taskId}, ${subtask.id})">
        <i class="fas fa-trash"></i>
      </button>
    </div>
  `).join('');
}

function renderTimeHistory(history) {
  if (!history || history.length === 0) {
    return '<div class="empty-history">No hay registros de tiempo</div>';
  }

  let html = '<table class="time-history-table"><thead><tr><th>Fecha</th><th>Horas</th><th>Comentario</th></tr></thead><tbody>';
  let totalHours = 0;

  history.forEach((entry, index) => {
    totalHours += entry.hours;
    html += `
      <tr>
        <td>${entry.date}</td>
        <td>${entry.hours.toFixed(2)}</td>
        <td>${entry.comment}</td>
      </tr>
    `;
  });

  html += `</tbody><tfoot><tr><td colspan="3">Total: ${totalHours.toFixed(2)} horas</td></tr></tfoot></table>`;

  return html;
}



// En lugar de usar <select>, usamos los elementos seleccionados
const dependencies = Array.from(
  document.querySelectorAll('#taskDependenciesItems div.selected')
).map(el => parseInt(el.dataset.id)).filter(id => !isNaN(id));


/*********************
 * GESTI√ìN DE TAREAS *
 *********************/

// Busca la funci√≥n saveTaskChanges y reempl√°zala con esta versi√≥n mejorada
function saveTaskChanges(taskId) {
  const project = projects[currentProjectIndex];
  const taskIndex = project.tasks.findIndex(t => t.id === taskId);
  if (taskIndex !== -1) {
    // Obtener todos los valores editados
    const editedTask = {
      ...project.tasks[taskIndex],
      name: document.getElementById('editTaskName')?.value || project.tasks[taskIndex].name,
      priority: document.getElementById('editTaskPriority')?.value || project.tasks[taskIndex].priority,
      status: document.getElementById('editTaskStatus')?.value || project.tasks[taskIndex].status,
      startDate: document.getElementById('editTaskStartDate')?.value || project.tasks[taskIndex].startDate,
      deadline: document.getElementById('editTaskDeadline')?.value || project.tasks[taskIndex].deadline,
      assignee: document.getElementById('editTaskAssignee')?.value || project.tasks[taskIndex].assignee,
      description: document.getElementById('editTaskDescription')?.value || project.tasks[taskIndex].description,
      estimatedTime: parseFloat(document.getElementById('editTaskEstimatedHours')?.value) || 1,
      dependencies: Array.from(document.getElementById('taskDependencies')?.selectedOptions || [])
        .map(opt => parseInt(opt.value))
        .filter(id => !isNaN(id)),
      subtasks: project.tasks[taskIndex].subtasks || []
    };
    // Actualizar la tarea en el array
    project.tasks[taskIndex] = editedTask;
    // Guardar y actualizar UI
    updateLocalStorage();
    renderKanbanTasks();
    updateTaskList();
    updateStatistics();
    generatePieChart(getStats());
    updateProjectProgress();
    actualizarAsignados();
    generateReports();
    updateResourceAllocation();
    // Actualizar fechas del proyecto
    const { earliestDate, latestDate } = calculateProjectDatesFromTasks(project);
    updateProjectDatesInDashboard(earliestDate, latestDate);
    // Notificar a otros usuarios
    if (tiempoRealSocket && tiempoRealSocket.connected) {
      tiempoRealSocket.emit('task-changed', {
        projectId: currentProjectIndex,
        taskId: taskId,
        taskName: editedTask.name,
        userName: 'Usuario actual',
        type: 'task-updated',
        timestamp: new Date().toISOString()
      });
      console.log('üì¢ Notificando actualizaci√≥n de tarea');
    }
    // Cerrar el modal
    taskDetailsModal.style.display = 'none';
    showNotification('Cambios guardados exitosamente');
    
    // ‚úÖ ACTUALIZAR EL BURNDOWN CHART
 refreshBurndown();
  } else {
    showNotification('Error: No se encontr√≥ la tarea para actualizar');
  }
 setTimeout(forceRefreshCalendarSafe, 300);
}




/*****************
 * VISTAS (UI) *
 *****************/
function renderTasks() {
  renderKanbanTasks();
}

function updateTaskList() {
  renderListTasks();
}

/*************
 * FILTROS *
 *************/
function actualizarAsignados() {
  ['filterAssignee', 'filterAssigneeList', 'filterAssigneeCalendar', 'filterAssigneeGantt', 'filterAssigneeReports'].forEach(selector => {
    const select = document.getElementById(selector);
    if (!select || !projects[currentProjectIndex]) return;
    
    const seleccionActual = select.value;
    select.innerHTML = '<option value="">Todos</option>';
    
       const asignados = new Set();
    
    projects[currentProjectIndex].tasks.forEach(task => {
      if (task.assignee && task.assignee.trim() !== '') {
        asignados.add(task.assignee.trim());
      }
    });

    Array.from(asignados).sort((a, b) => a.localeCompare(b)).forEach(asignado => {
      const option = document.createElement('option');
      option.value = asignado;
      option.textContent = asignado;
      select.appendChild(option);
    });
    
    if (seleccionActual && asignados.has(seleccionActual)) {
      select.value = seleccionActual;
    }
  });
}






/*****************
 * DRAG & DROP *
 *****************/
function initDragAndDrop() {
  document.querySelectorAll('.task-card').forEach(task => {
    task.addEventListener('dragstart', handleDragStart);
    task.addEventListener('dragend', handleDragEnd);
  });

  document.querySelectorAll('.tasks').forEach(column => {
    column.addEventListener('dragover', handleDragOver);
    column.addEventListener('dragleave', handleDragLeave);
    column.addEventListener('drop', handleDrop);
  });
}

function handleDragStart(e) {
  e.dataTransfer.setData('taskId', e.currentTarget.dataset.taskId);
  e.currentTarget.style.opacity = '0.4';
}

function handleDragEnd(e) {
  e.currentTarget.style.opacity = '1';
}

function handleDragOver(e) {
  e.preventDefault();
  e.currentTarget.style.backgroundColor = '#f0f0f0';
}

function handleDragLeave(e) {
  e.currentTarget.style.backgroundColor = '';
}

function handleDrop(e) {
  e.preventDefault();
  const taskId = parseInt(e.dataTransfer.getData('taskId'));
  const targetColumn = e.currentTarget.closest('.column');
  
  const statusMap = {
    pendingTasks: 'pending',
    inProgressTasks: 'inProgress',
    completedTasks: 'completed',
    overdueTasks: 'overdue'
  };

  const newStatus = statusMap[targetColumn.id];
  const task = projects[currentProjectIndex].tasks.find(t => t.id === taskId);

  if (task && task.status !== newStatus) {

  // üî• REGISTRAR HISTORIA
  task.history = task.history || [];
  task.history.push({
    from: task.status,
    to: newStatus,
    date: new Date().toISOString()
  });

  // üîÅ CAMBIO REAL DE ESTADO
  task.status = newStatus;


  checkTaskOverdue(task);
  updateLocalStorage();
renderKanbanTasks();
updateStatistics();
updateProjectProgress();



// üî• AGREGAR ESTO:
setTimeout(() => {
  refreshCalendar();
}, 100);

 // ‚úÖ Inserta esto justo aqu√≠
  if (task.status === 'completada') {
    logCompletedTask(task);
    checkAutoRetrain();
  }





// === AGREGAR ESTA L√çNEA ===
      if (window.syncManager) window.syncManager.notifyChange('task-moved', { 
          projectIndex: currentProjectIndex, 
          taskId: taskId, 
          taskName: task.name, 
          newStatus: newStatus 
      });
    actualizarAsignados();
    aplicarFiltros();
    updateStatistics();
    updateResourceAllocation(); // <-- Esta es la l√≠nea que agregas


 // üî• AGREGAR NOTIFICACI√ìN PARA DRAG & DROP
    if (tiempoRealSocket && tiempoRealSocket.connected) {
      tiempoRealSocket.emit('task-changed', {
        projectId: currentProjectIndex,
        taskId: taskId,
        taskName: task.name,
        userName: 'Usuario actual',
        type: 'task-moved',
        newStatus: newStatus,
        timestamp: new Date().toISOString()
      });
      console.log('üì¢ Notificando movimiento de tarea');
    }


 // üî• NUEVO: actualizar gr√°fica de status
  generatePieChart(getStats());
  updateProjectProgress();
  actualizarAsignados();
  refreshBurndown();
  }





  e.currentTarget.style.backgroundColor = '';
}





function checkTaskOverdue(task) {
  if (task.status === 'completed') return false;
  
  if (task.deadline) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const deadlineDate = new Date(task.deadline);
    deadlineDate.setHours(0, 0, 0, 0);
    
    if (deadlineDate < today) {
      task.status = 'overdue';
      return true;
    }
  }
  return false;
}

/*********************
 * ESTAD√çSTICAS *
 *********************/
function getStats(tasks = null) {
  const tasksToUse = tasks || projects[currentProjectIndex]?.tasks || [];
  return {
    total: tasksToUse.length,
    pending: tasksToUse.filter(t => t.status === 'pending').length,
    inProgress: tasksToUse.filter(t => t.status === 'inProgress').length,
    completed: tasksToUse.filter(t => t.status === 'completed').length,
    overdue: tasksToUse.filter(t => t.status === 'overdue').length
  };
}


function calculateTimeBudgetUsage() {
    const project = projects[currentProjectIndex];
    if (!project || !project.tasks || project.tasks.length === 0) {
        return 0;
    }

    let totalEstimated = 0;
    let totalLogged = 0;

    project.tasks.forEach(task => {
        totalEstimated += task.estimatedTime || 0;
        totalLogged += task.timeLogged || 0;
    });

    if (totalEstimated === 0) return 0;

    const percentage = (totalLogged / totalEstimated) * 100;
    return Math.round(percentage);
}



function updateRisksCount() {
    const risksContainer = document.getElementById('risksContainer');
    const riskLevelElement = document.getElementById('riskLevel');
    
    if (!risksContainer || !riskLevelElement) return;

    // Contar solo elementos de riesgo reales (excluyendo mensajes vac√≠os)
    const riskItems = risksContainer.querySelectorAll('.risk-item');
    const realRiskCount = Array.from(riskItems).filter(item => 
        !item.classList.contains('empty-message')
    ).length;

    riskLevelElement.textContent = realRiskCount;
    console.log(`Actualizado contador de riesgos: ${realRiskCount}`);
}


function updateStatistics(tasks = null) {
  const stats = getStats(tasks);
  
  if (totalTasks) totalTasks.textContent = stats.total;
  if (pendingCount) pendingCount.textContent = stats.pending;
  if (inProgressCount) inProgressCount.textContent = stats.inProgress;
  if (completedCount) completedCount.textContent = stats.completed;
  if (overdueCount) overdueCount.textContent = stats.overdue;
}

function generatePieChart(data) {
  console.log("üéØ Generando gr√°fico de pastel...");
  
  const pieChartCanvas = document.getElementById('pieChart');
  if (!pieChartCanvas) {
    console.error("‚ùå No se encuentra el canvas pieChart");
    return;
  }

  // üî• CLAVE: Asegurar que el canvas tenga dimensiones visibles
  if (pieChartCanvas.offsetWidth === 0 || pieChartCanvas.offsetHeight === 0) {
    console.log("‚ö†Ô∏è Canvas tiene dimensiones 0, forzando tama√±o...");
    pieChartCanvas.style.width = '400px';
    pieChartCanvas.style.height = '400px';
  }

  // Destruir gr√°fica anterior SI existe
  if (window.myChartInstance) {
    window.myChartInstance.destroy();
    window.myChartInstance = null;
  }

  const ctx = pieChartCanvas.getContext('2d');
  
  try {
    window.myChartInstance = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ['Pendientes', 'En Progreso', 'Completados', 'Rezagados'],
        datasets: [{
          data: [data.pending, data.inProgress, data.completed, data.overdue],
          backgroundColor: ['#f1c40f', '#008090', '#2ecc71', '#e74c3c']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });

    console.log("‚úÖ Gr√°fico de pastel creado exitosamente");

    // üî• FORZAR REDIBUJADO despu√©s de un peque√±o delay
    setTimeout(() => {
      if (window.myChartInstance) {
        window.myChartInstance.update();
        console.log("üîÑ Gr√°fico actualizado forzadamente");
      }
    }, 500);

  } catch (error) {
    console.error("‚ùå Error creando gr√°fico:", error);
  }
}
function updateProjectProgress() {
  const project = projects[currentProjectIndex];
  const totalTasks = project.tasks.length;
  const completedTasks = project.tasks.filter(t => t.status === 'completed').length;
  const progressFill = document.getElementById('projectProgressFill');
  const progressLabel = document.getElementById('projectProgressLabel');

  if (!progressFill || !progressLabel) return;

  const percent = totalTasks ? Math.round((completedTasks / totalTasks) * 100) : 0;
  progressFill.style.width = `${percent}%`;
  progressLabel.textContent = `${percent}% Completado`;
  progressFill.style.backgroundColor = '#2ecc71';
}


function formatDate(date) {
    if (!date || isNaN(date.getTime())) return '--/--/--';
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}


function updateProjectDatesFromTasks() {
    const tasks = projects[currentProjectIndex]?.tasks || [];
    const startDates = tasks.map(t => t.startDate).filter(Boolean);
    const endDates = tasks.map(t => t.deadline).filter(Boolean);
    const earliestDate = startDates.length > 0 ? new Date(Math.min(...startDates.map(d => new Date(d)))) : null;
    const latestDate = endDates.length > 0 ? new Date(Math.max(...endDates.map(d => new Date(d)))) : null;

    // Actualizar Dashboard (usa el ID original)
    const startDateEl = document.getElementById('projectStartDate');
    const endDateEl = document.getElementById('projectEndDate');

    if (startDateEl) {
        startDateEl.textContent = earliestDate ? formatDate(earliestDate) : '--/--/--';
    }
    if (endDateEl) {
        endDateEl.textContent = latestDate ? formatDate(latestDate) : '--/--/--';
    }

    // Actualizar vista de Reportes (usa los nuevos IDs)
    const startDateReportsEl = document.getElementById('projectStartDateReports');
    const endDateReportsEl = document.getElementById('projectEndDateReports');

    if (startDateReportsEl) {
        startDateReportsEl.textContent = earliestDate ? formatDate(earliestDate) : '--/--/--';
    }
    if (endDateReportsEl) {
        endDateReportsEl.textContent = latestDate ? formatDate(latestDate) : '--/--/--';
    }
}
function checkOverdueTasks() {
  const now = new Date();
  now.setHours(0, 0, 0, 0);
  let hasChanges = false;

  projects[currentProjectIndex].tasks.forEach(task => {
    if (task.deadline && task.status !== 'completed') {
      const deadlineDate = new Date(task.deadline);
      deadlineDate.setHours(0, 0, 0, 0);
      if (deadlineDate < now && task.status !== 'overdue') {
        task.status = 'overdue';
        hasChanges = true;
      }
    }
  });

  if (hasChanges) {
    updateLocalStorage();
    actualizarAsignados();
    aplicarFiltros();
    generatePieChart(getStats());
           updateProjectProgress();
           actualizarAsignados();
    showNotification('Tareas actualizadas: algunas han sido marcadas como "Rezagadas"');
  }
}

/***********************
 * FUNCIONES DE REPORTES *
 ***********************/
function generateReports(tasks = null) {
    const tasksToUse = tasks || projects[currentProjectIndex]?.tasks || [];
    const timeStats = getTimeStats(tasksToUse);

    // Actualizar cuadros de tiempo (con validaci√≥n)
    if (totalEstimatedTime && !isNaN(timeStats.totalEstimated)) {
        totalEstimatedTime.textContent = `${timeStats.totalEstimated.toFixed(2)} horas`;
    }
    if (totalLoggedTime && !isNaN(timeStats.totalLogged)) {
        totalLoggedTime.textContent = `${timeStats.totalLogged.toFixed(2)} horas`;
    }
    if (remainingTime && !isNaN(timeStats.remaining)) {
        remainingTime.textContent = `${timeStats.remaining.toFixed(2)} horas`;
    }
  
  // Actualizar estad√≠sticas
  updateStatistics(tasksToUse);
  
  // Actualizar gr√°fico
  generatePieChart(stats);
  
  // Actualizar progreso del proyecto
  updateProjectProgress();
  updateProjectDatesFromTasks();

  updateProjectStatusLabel();
}

function getTimeStats(tasks = null) {
    const tasksToUse = tasks || projects[currentProjectIndex]?.tasks || [];
    return {
        totalEstimated: tasksToUse.reduce((sum,  task) => sum + (task.estimatedTime || 0), 0),
        totalLogged: tasksToUse.reduce((sum, task) => sum + (task.timeLogged || 0), 0),
        remaining: tasksToUse.reduce((sum, task) => {
            const remaining = (task.estimatedTime || 0) - (task.timeLogged || 0);
            return sum + (remaining > 0 ? remaining : 0);
        }, 0)
    };
}
/***********************
 * FUNCIONES DE RENTABILIDAD *
 ***********************/
function renderProfitabilityView() {
  const project = projects[currentProjectIndex];
  
  // C√°lculos de ejemplo (ajusta seg√∫n tu l√≥gica de negocio)
  const totalHours = project.tasks.reduce((sum, task) => sum + (task.timeLogged || 0), 0);
  const hourlyCost = 50; // Costo por hora (ejemplo)
  const projectBudget = 10000; // Presupuesto del proyecto (ejemplo)
  
  const totalCost = totalHours * hourlyCost;
  const profitMargin = ((projectBudget - totalCost) / projectBudget) * 100;
  
  // Actualiza la UI
  document.getElementById('totalCost').textContent = `$${totalCost.toFixed(2)}`;
  document.getElementById('totalIncome').textContent = `$${projectBudget.toFixed(2)}`;
  document.getElementById('profitMargin').textContent = `${profitMargin.toFixed(2)}%`;
  
  // Gr√°fico
  renderProfitabilityChart(totalCost, projectBudget);
}

function renderProfitabilityChart(cost, income) {
  const ctx = document.getElementById('profitabilityChart').getContext('2d');
  
  if (window.profitabilityChart) {
    window.profitabilityChart.destroy();
  }
  
  window.profitabilityChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Costos', 'Ingresos'],
      datasets: [{
        label: 'An√°lisis Financiero',
        data: [cost, income],
        backgroundColor: [
          'rgba(255, 99, 132, 0.7)',
          'rgba(54, 162, 235, 0.7)'
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'top',
        }
      }
    }
  });
}

/*********************
 * AN√ÅLISIS DE RUTA CR√çTICA *
 *********************/
// Reemplaza tu calculateCriticalPath actual por esta versi√≥n corregida
function calculateCriticalPath(tasks) {
  if (!Array.isArray(tasks) || tasks.length === 0) return [];

  // Map id -> node
  const nodes = new Map();
  tasks.forEach(t => {
    nodes.set(String(t.id), {
      id: String(t.id),
      name: t.name || '',
      duration: Number(t.estimatedTime || 0),
      deps: (t.dependencies || []).map(d => String(d)),
      earliestStart: 0,
      earliestFinish: 0,
      latestStart: Infinity,
      latestFinish: Infinity,
      slack: Infinity
    });
  });

  // Topological order (Kahn)
  const inDegree = new Map();
  nodes.forEach((node) => inDegree.set(node.id, 0));
  nodes.forEach(node => {
    node.deps.forEach(depId => {
      if (nodes.has(depId)) {
        inDegree.set(node.id, (inDegree.get(node.id) || 0) + 1);
      }
    });
  });

  const queue = [];
  inDegree.forEach((deg, id) => { if (deg === 0) queue.push(id); });

  const topo = [];
  while (queue.length) {
    const id = queue.shift();
    topo.push(id);
    // reduce in-degree of successors
    nodes.forEach(node => {
      if (node.deps.includes(id)) {
        inDegree.set(node.id, inDegree.get(node.id) - 1);
        if (inDegree.get(node.id) === 0) queue.push(node.id);
      }
    });
  }

  if (topo.length !== nodes.size) {
    // Hay ciclos => no se puede calcular CPM cl√°sico
    console.warn('calculateCriticalPath: grafo con ciclos, devolviendo tareas sin c√°lculo de ruta cr√≠tica.');
    return [];
  }

  // Forward pass
  topo.forEach(id => {
    const node = nodes.get(id);
    if (!node) return;
    if (!node.deps || node.deps.length === 0) {
      node.earliestStart = 0;
    } else {
      node.earliestStart = Math.max(...node.deps
        .filter(depId => nodes.has(depId))
        .map(depId => nodes.get(depId).earliestFinish || 0)
      );
    }
    node.earliestFinish = node.earliestStart + node.duration;
  });

  // Project duration = max earliestFinish
  const projectDuration = Math.max(...Array.from(nodes.values()).map(n => n.earliestFinish || 0));

  // Backward pass: init tasks with no successors
  // Build successors map
  const successors = new Map();
  nodes.forEach((n) => successors.set(n.id, []));
  nodes.forEach(n => {
    (n.deps || []).forEach(dep => {
      if (nodes.has(dep)) {
        successors.get(dep).push(n.id);
      }
    });
  });

  // Initialize latestFinish for terminal nodes
  nodes.forEach(n => {
    if (!successors.get(n.id) || successors.get(n.id).length === 0) {
      n.latestFinish = projectDuration;
      n.latestStart = n.latestFinish - n.duration;
    }
  });

  // Process nodes in reverse topo
  for (let i = topo.length - 1; i >= 0; i--) {
    const id = topo[i];
    const node = nodes.get(id);
    if (!node) continue;
    if (successors.get(id) && successors.get(id).length > 0) {
      node.latestFinish = Math.min(...successors.get(id).map(sid => nodes.get(sid).latestStart));
      node.latestStart = node.latestFinish - node.duration;
    }
    node.slack = node.latestStart - node.earliestStart;
  }

  // Critical path = tasks with slack === 0 (o muy cercano)
  const critical = Array.from(nodes.values())
    .filter(n => Math.abs(n.slack) < 1e-6)
    .sort((a, b) => a.earliestStart - b.earliestStart);

  // Map back to original task objects (preserve order)
  const criticalIds = new Set(critical.map(c => c.id));
  return tasks.filter(t => criticalIds.has(String(t.id)));
}



/***********************
 * EVENT LISTENERS *
 ***********************/
function setupEventListeners() {
  // Proyectos
  document.getElementById('newProjectBtn')?.addEventListener('click', createNewProject);
  
  // Tareas
  // üëá Reemplazar el listener del formulario de Nueva Tarea por uno seguro
const createTaskForm = document.getElementById('createTaskForm');
if (createTaskForm) {
  // 1. Eliminar el formulario y reemplazarlo para limpiar listeners anteriores
  const newForm = createTaskForm.cloneNode(true);
  createTaskForm.replaceWith(newForm);
  // 2. Conectar SOLO el listener correcto
  newForm.addEventListener('submit', function(e) {
    e.preventDefault(); // ¬°Importante!
    createNewTask(e);
  });
}
  document.getElementById('newTaskBtn')?.addEventListener('click', () => {
    createTaskModal.style.display = 'block';
    populateTaskDependenciesSelect();

 
    // üëá AGREGAR ESTO - Esperar a que el modal est√© visible
    setTimeout(() => {
        setupAIEstimation();
        console.log('‚úÖ IA configurada con modal visible');
    }, 300);
});
  
// üëá A√ëADE ESTA L√çNEA NUEVA
    setTimeout(setupAIEstimation, 100); // Inicializar IA despu√©s de abrir modal
 


  // Cerrar modales
  document.querySelector('.close')?.addEventListener('click', () => {
    createTaskModal.style.display = 'none';
  });

  // Men√∫ sidebar - VERSI√ìN CORREGIDA
toggleSidebarBtn?.addEventListener('click', function() {
    console.log('üñ±Ô∏è Bot√≥n sidebar clickeado - versi√≥n corregida');
    const sidebar = document.querySelector('aside');
    
    sidebar.classList.toggle('hidden');
    
    // Peque√±o delay para que el DOM se actualice y luego sincronizar
    setTimeout(() => {
        syncLinesWithSidebar();
        // Forzar un re-render del diagrama Gantt para recalcular posiciones
        if (!ganttView.classList.contains('hidden')) {
            console.log('üîÑ Re-renderizando Gantt para recalcular l√≠neas...');
            renderGanttChart();
        }
    }, 100);
});

  // Filtros con debounce para mejor performance
  document.getElementById('filterAssignee')?.addEventListener('input', debounce(aplicarFiltros, 300));
  document.getElementById('filterPriority')?.addEventListener('change', aplicarFiltros);
  document.getElementById('filterStatus')?.addEventListener('change', aplicarFiltros);
  document.getElementById('filterStartDate')?.addEventListener('change', aplicarFiltros);
  document.getElementById('filterEndDate')?.addEventListener('change', aplicarFiltros);

  // Filtros de la vista de lista
  document.getElementById('filterAssigneeList')?.addEventListener('input', debounce(aplicarFiltros, 300));
  document.getElementById('filterPriorityList')?.addEventListener('change', aplicarFiltros);
  document.getElementById('filterStatusList')?.addEventListener('change', aplicarFiltros);
  document.getElementById('filterStartDateList')?.addEventListener('change', aplicarFiltros);
  document.getElementById('filterEndDateList')?.addEventListener('change', aplicarFiltros);

  // Filtros del calendario
  document.getElementById('filterAssigneeCalendar')?.addEventListener('input', debounce(aplicarFiltros, 300));
  document.getElementById('filterPriorityCalendar')?.addEventListener('change', aplicarFiltros);
  document.getElementById('filterStatusCalendar')?.addEventListener('change', aplicarFiltros);

  // Filtros de Gantt
  document.getElementById('filterAssigneeGantt')?.addEventListener('input', debounce(aplicarFiltros, 300));
  document.getElementById('filterPriorityGantt')?.addEventListener('change', aplicarFiltros);
  document.getElementById('clearFiltersGanttBtn')?.addEventListener('click', () => {
    document.getElementById('filterAssigneeGantt').value = '';
    document.getElementById('filterPriorityGantt').value = '';
    aplicarFiltros();
  });

  // Filtros de Reports
  document.getElementById('filterAssigneeReports')?.addEventListener('change', aplicarFiltros);
  document.getElementById('filterPriorityReports')?.addEventListener('change', aplicarFiltros);
  document.getElementById('filterStatusReports')?.addEventListener('change', aplicarFiltros);
  document.getElementById('clearFiltersReportsBtn')?.addEventListener('click', () => {
    document.getElementById('filterAssigneeReports').value = '';
    document.getElementById('filterPriorityReports').value = '';
    document.getElementById('filterStatusReports').value = '';
    aplicarFiltros();
  });

  // Limpiar filtros
  document.getElementById('clearFiltersBtn')?.addEventListener('click', () => {
    document.getElementById('filterAssignee').value = '';
    document.getElementById('filterPriority').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterStartDate').value = '';
    document.getElementById('filterEndDate').value = '';
    aplicarFiltros();
  });

  // Limpiar filtros del calendario
  document.getElementById('clearFiltersCalendarBtn')?.addEventListener('click', () => {
    document.getElementById('filterAssigneeCalendar').value = '';
    document.getElementById('filterPriorityCalendar').value = '';
    document.getElementById('filterStatusCalendar').value = '';
    aplicarFiltros();
  });

  // Limpiar filtros de lista
  document.getElementById('clearFiltersListBtn')?.addEventListener('click', () => {
    document.getElementById('filterAssigneeList').value = '';
    document.getElementById('filterPriorityList').value = '';
    document.getElementById('filterStatusList').value = '';
    document.getElementById('filterStartDateList').value = '';
    document.getElementById('filterEndDateList').value = '';
    aplicarFiltros();
  });

  // Botones de cambio de vista
  if (viewButtons.board) viewButtons.board.addEventListener('click', () => showView('board'));
  if (viewButtons.list) viewButtons.list.addEventListener('click', () => showView('list'));
  if (viewButtons.calendar) viewButtons.calendar.addEventListener('click', () => showView('calendar'));
  if (viewButtons.gantt) viewButtons.gantt.addEventListener('click', () => showView('gantt'));
  if (viewButtons.reports) viewButtons.reports.addEventListener('click', () => showView('reports'));
  if (viewButtons.profitability) viewButtons.profitability.addEventListener('click', () => showView('profitability'));
  if (viewButtons.dashboard) viewButtons.dashboard.addEventListener('click', () => showView('dashboard'));
  if (viewButtons.ganttPro) viewButtons.ganttPro.addEventListener('click', () => showView('ganttPro'));

// === BOT√ìN DE CERRAR SESI√ìN (aqu√≠ va) ===
  document.getElementById('logoutBtn')?.addEventListener('click', logout);





// CONFIGURACI√ìN CORREGIDA PARA fileUpload (TAREAS)
    const fileInput = document.getElementById('fileUpload');
    if (fileInput) {
        // Remover cualquier listener problem√°tico existente
        fileInput.onchange = null;
        
        // Agregar listener seguro para adjuntar archivos a tareas
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                console.log("üìé Archivo seleccionado para adjuntar a tarea:", file.name);
                // No hacer nada m√°s aqu√≠ - el archivo se procesar√° en createNewTask
            }
        });
        
        console.log("‚úÖ fileUpload configurado solo para adjuntar archivos a tareas");
    }
    
    // CONFIGURACI√ìN PARA backupUpload (RESPALDOS)
    const backupInput = document.getElementById('backupUpload');
    if (backupInput) {
        backupInput.onchange = null; // Limpiar cualquier configuraci√≥n previa
        console.log("‚úÖ backupUpload listo para respaldos");
    }




  // Bot√≥n de generaci√≥n de PDF
  document.getElementById('generatePdfBtn')?.addEventListener('click', generateStatusReportPDF);
}
// === FUNCI√ìN FINAL CORREGIDA - INFORMACI√ìN DEL PROYECTO ===
async function generateProjectReport() {
  console.log("üìä Generando reporte con formato exacto...");
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const project = projects[currentProjectIndex];
  const stats = getStats();
  const timeStats = getTimeStats();
  const currentDate = new Date();
  const formattedDate = `${currentDate.getDate()}/${currentDate.getMonth() + 1}/${currentDate.getFullYear()}`;

  // === CONFIGURACI√ìN INICIAL ===
  doc.setFont("helvetica");
  
  // === ENCABEZADO DEL REPORTE ===
  doc.setFont("helvetica", "bold");
  doc.setFontSize(18);
  doc.text("Reporte del Proyecto", 105, 20, { align: "center" });
  
  let y = 35; // Posici√≥n Y inicial despu√©s del t√≠tulo

  // === INFORMACI√ìN DEL PROYECTO - M√âTODO CORREGIDO ===
  doc.setFontSize(12);
  
  // T√≠tulo "Estad√≠sticas del Proyecto" en negrita
  doc.setFont("helvetica", "bold");
  doc.text("Estad√≠sticas del Proyecto:", 20, y);
  y += 7;

  // Funci√≥n auxiliar para escribir texto con formato mixto
  const writeLabelValue = (label, value) => {
    doc.setFont("helvetica", "bold");
    doc.text(label, 20, y);
    const labelWidth = doc.getTextWidth(label);
    doc.setFont("helvetica", "normal");
    doc.text(value, 20 + labelWidth, y);
    y += 7;
  };

  // Escribir cada l√≠nea con DOS ESPACIOS despu√©s de los dos puntos
  writeLabelValue("Proyecto:  ", project.name);
  writeLabelValue("Fecha del reporte:  ", formattedDate);

  // Fechas de inicio y fin
  const { earliestDate, latestDate } = calculateProjectDatesFromTasks(project);
  if (earliestDate) {
    writeLabelValue("Fecha de inicio:  ", formatDate(earliestDate));
  }
  if (latestDate) {
    writeLabelValue("Fecha de fin:  ", formatDate(latestDate));
  }

  // ‚úÖ C√ÅLCULO CORRECTO DEL PORCENTAJE DE AVANCE (basado en EV / BAC)
let EV = 0;
let BAC = 0;

project.tasks?.forEach(task => {
  const estimated = Number(task.estimatedTime) || 0;
  const logged = Number(task.timeLogged) || 0;
  const status = task.status || 'pending';
  
  BAC += estimated;

  let progress = 0;
  if (status === 'completed') {
    progress = 1.0;
  } else if (logged > 0 && estimated > 0 && status !== 'pending') {
    progress = Math.min(0.99, logged / estimated);
  } else if (task.progress !== undefined && task.progress !== null) {
    progress = Math.min(0.99, Number(task.progress) / 100);
  } else {
    if (status.includes('progress') || status === 'inProgress') {
      progress = 0.5;
    } else if (status.includes('overdue') || status.includes('delayed') || 
               status.includes('atrasado') || status.includes('rezagado')) {
      progress = 0.5;
    } else if (status.includes('pending')) {
      progress = 0;
    } else {
      progress = 0.3;
    }
  }
  
  EV += estimated * progress;
});

const completionPercentage = BAC > 0 ? Math.round((EV / BAC) * 100) : 0;
writeLabelValue("Porcentaje de avance:  ", completionPercentage + "%");
  
  y += 8; // Espacio extra antes de la siguiente secci√≥n

  // === EL RESTO DEL C√ìDIGO SE MANTIENE IGUAL ===
  // === SECCI√ìN: DISTRIBUCI√ìN DE TAREAS ===
  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);
  doc.text("Distribuci√≥n de Tareas", 105, y, { align: "center" });
  y += 10;

  // --- CUADROS ESTAD√çSTICOS ---
  const boxWidth = 32;
  const boxHeight = 18;
  const boxMargin = 3;
  const totalWidth = (boxWidth * 5) + (boxMargin * 4);
  const startX = (doc.internal.pageSize.getWidth() - totalWidth) / 2;
  const yBox = y;

  // Funci√≥n auxiliar para dibujar un cuadro
  const drawBox = (x, title, value, color, textColor = "#fff") => {
    const [r,g,b] = color;
    doc.setFillColor(r,g,b);
    doc.roundedRect(x, yBox, boxWidth, boxHeight, 2, 2, "F");
    
    // Texto del t√≠tulo
    doc.setTextColor(textColor);
    doc.setFontSize(9);
    doc.setFont("helvetica", "normal");
    doc.text(title, x + boxWidth / 2, yBox + 7, { align: "center" });
    
    // Valor
    doc.setFont("helvetica", "bold");
    doc.setFontSize(11);
    doc.text(value.toString(), x + boxWidth / 2, yBox + 14, { align: "center" });
  };

  // Obtener el color de completadas del sistema (verde claro)
  const completedColor = getCompletadasColorFromSystem() || [144, 238, 144];

  // Dibujar los 5 cuadros
  drawBox(startX, "Total", stats.total, [52, 152, 219]);
  drawBox(startX + boxWidth + boxMargin, "Pendientes", stats.pending, [241, 196, 15], "#000");
  drawBox(startX + (boxWidth + boxMargin)*2, "En Progreso", stats.inProgress, [0, 128, 128]);
  drawBox(startX + (boxWidth + boxMargin)*3, "Completadas", stats.completed, completedColor, "#000");
  drawBox(startX + (boxWidth + boxMargin)*4, "Rezagadas", stats.overdue, [231, 76, 60]);
  
  y += 30; // Espacio despu√©s de los cuadros

  // === GR√ÅFICO CIRCULAR Y LEYENDAS (M√ÅS PEQUE√ëOS) ===
  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);
  doc.text("Distribuci√≥n de Tareas", 105, y, { align: "center" });
  y += 8;

  try {
    const originalCanvas = document.getElementById("pieChart") || document.getElementById("tasksDistributionChart");
    if (originalCanvas) {
      const tempCanvas = document.createElement("canvas");
      tempCanvas.width = 250;
      tempCanvas.height = 250;
      tempCanvas.style.position = "absolute";
      tempCanvas.style.top = "-9999px";
      document.body.appendChild(tempCanvas);
      const ctx = tempCanvas.getContext("2d");

      const chartInstance = Object.values(Chart.instances).find(c => c.canvas === originalCanvas);
      if (chartInstance) {
        const tempChart = new Chart(ctx, {
          type: 'pie',
          data: chartInstance.config.data,
          options: {
            ...chartInstance.config.options,
            plugins: {
              legend: {
                display: false
              }
            },
            animation: false
          }
        });
        
        await new Promise(r => setTimeout(r, 500));
        const imgData = tempCanvas.toDataURL("image/png");
        if (imgData && imgData.length > 1000) {
          const graphWidth = 85;
          const graphHeight = 85;
          const graphX = (doc.internal.pageSize.getWidth() - graphWidth) / 2;
          const graphY = y;
          
          doc.addImage(imgData, "PNG", graphX, graphY, graphWidth, graphHeight);
          
          y = graphY + graphHeight + 8;
        }
        tempChart.destroy();
      }
      document.body.removeChild(tempCanvas);
    }
  } catch (e) {
    console.error("‚ùå Error al capturar gr√°fico:", e);
    y += 50;
  }

  // === LEYENDAS (BANDERITAS) - M√ÅS PEQUE√ëAS ===
  const legends = [
    { label: "Pendientes", color: [241, 196, 15] },
    { label: "En Progreso", color: [0, 128, 128] },
    { label: "Completadas", color: completedColor },
    { label: "Rezagadas", color: [231, 76, 60] }
  ];

  // Calcular posici√≥n para centrar las leyendas
  const legendItemWidth = 32;
  const totalLegendWidth = legends.length * legendItemWidth;
  const legendStartX = (doc.internal.pageSize.getWidth() - totalLegendWidth) / 2;

  // Dibujar leyendas (m√°s peque√±as)
  legends.forEach((legend, index) => {
    const x = legendStartX + (index * legendItemWidth);
    
    doc.setFillColor(legend.color[0], legend.color[1], legend.color[2]);
    doc.rect(x, y, 5, 5, "F");
    
    doc.setTextColor("#000");
    doc.setFontSize(7);
    doc.setFont("helvetica", "normal");
    doc.text(legend.label, x + 8, y + 3.5);
  });

  y += 18;

  // === SECCI√ìN: TIEMPO (BAJADA LA POSICI√ìN) ===
  y += 10;

  const timeBlockWidth = 50;
  const timeBlockHeight = 25;
  const timeBlockMargin = 8;
  const totalTimeWidth = (timeBlockWidth * 3) + (timeBlockMargin * 2);
  const timeStartX = (doc.internal.pageSize.getWidth() - totalTimeWidth) / 2;

  // Funci√≥n para dibujar bloque de tiempo
  const drawTimeBlock = (x, title, value, color) => {
    const [r,g,b] = color;
    doc.setFillColor(r,g,b);
    doc.roundedRect(x, y, timeBlockWidth, timeBlockHeight, 3, 3, "F");
    
    // T√≠tulo
    doc.setTextColor("#fff");
    doc.setFontSize(8);
    doc.setFont("helvetica", "normal");
    doc.text(title, x + timeBlockWidth / 2, y + 8, { align: "center" });
    
    // Valor
    doc.setFont("helvetica", "bold");
    doc.setFontSize(10);
    doc.text(value, x + timeBlockWidth / 2, y + 17, { align: "center" });
  };

  // Colores para los bloques de tiempo (azul oscuro)
  const darkBlue = [44, 62, 80];

  // Dibujar los tres bloques de tiempo
  drawTimeBlock(timeStartX, "Tiempo Estimado", `${timeStats.totalEstimated.toFixed(2)} h`, darkBlue);
  drawTimeBlock(timeStartX + timeBlockWidth + timeBlockMargin, "Tiempo Registrado", `${timeStats.totalLogged.toFixed(2)} h`, darkBlue);
  drawTimeBlock(timeStartX + (timeBlockWidth + timeBlockMargin)*2, "Tiempo Restante", `${timeStats.remaining.toFixed(2)} h`, darkBlue);

  // === GUARDAR PDF FINAL ===
  const fileName = `Reporte_${project.name.replace(/ /g, "_")}_${formattedDate.replace(/\//g, "-")}.pdf`;
  doc.save(fileName);
  showNotification("‚úÖ Reporte PDF generado con √©xito");
}


// Funci√≥n auxiliar para obtener el color de completadas del sistema
function getCompletadasColorFromSystem() {
  // Intenta obtener el color de completadas de tu sistema
  try {
    const savedColors = localStorage.getItem('taskColors');
    if (savedColors) {
      const colors = JSON.parse(savedColors);
      if (colors.completed) return colors.completed;
    }
  } catch (e) {}
  
  try {
    const style = getComputedStyle(document.documentElement);
    const completedColor = style.getPropertyValue('--completed-color') || 
                          style.getPropertyValue('--color-completed') ||
                          style.getPropertyValue('--success-color');
    if (completedColor) {
      const hex = completedColor.trim();
      if (hex.startsWith('#')) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return [r, g, b];
      }
    }
  } catch (e) {}
  
  try {
    const completedElement = document.querySelector('.completed, .task-completed, .status-completed');
    if (completedElement) {
      const style = getComputedStyle(completedElement);
      const bgColor = style.backgroundColor;
      if (bgColor && bgColor !== 'rgba(0, 0, 0, 0)') {
        const match = bgColor.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
        if (match) {
          return [parseInt(match[1]), parseInt(match[2]), parseInt(match[3])];
        }
      }
    }
  } catch (e) {}
  
  return [144, 238, 144]; // lightgreen
}

/***********************
 * INICIALIZACI√ìN *
 ***********************/
document.addEventListener('DOMContentLoaded', async () => {

// üëáüëáüëá VERIFICACI√ìN DE STRIPE - COLOCA ESTO PRIMERO üëáüëáüëá
  // Verificar si venimos de Stripe con √©xito
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('payment') === 'success') {
    showNotification('‚úÖ ¬°Pago exitoso! Bienvenido a tu nuevo plan.');
    // Guardar licencia directamente
    localStorage.setItem('userPlan', 'professional');
    // Eliminar par√°metro sin recargar
    window.history.replaceState({}, document.title, window.location.pathname);
    console.log('‚úÖ Licencia actualizada a professional');
    // Continuar con la inicializaci√≥n normal (no return)
  }
  // üëÜüëÜüëÜ HASTA AQU√ç üëÜüëÜüëÜ
  console.log('üöÄ Iniciando aplicaci√≥n...');
  
  // üîê Verificar autenticaci√≥n ANTES de cargar la app
  const token = localStorage.getItem('authToken');
  if (!token || token.length < 10) {
    console.log('üîê No hay token v√°lido, mostrando login');
    showLoginScreen();
    return;
  }

// ‚úÖ ACCESO PREMIUM AUTOM√ÅTICO PARA EL DESARROLLADOR
const currentUserEmail = localStorage.getItem('userEmail');
if (currentUserEmail === 'TU_CORREO_AQUI') {
  localStorage.setItem('userPlan', 'premium');
  console.log('üëë Acceso premium activado para desarrollador');
}




  console.log('‚úÖ Token v√°lido detectado');
  
  // üëá Solo si hay token, continuar con la app
  try {    const dataLoaded = await safeLoad();
    console.log('üìä Datos cargados:', dataLoaded ? '‚úÖ' : '‚ùå');
    
    if (!dataLoaded || projects.length === 0) {
      console.log('üìù No hay datos, preguntando si crear proyecto...');
      // No crear autom√°ticamente, esperar interacci√≥n del usuario
      // ‚Üê ¬°NO llama a createNewProject() autom√°ticamente!
    } else {
      console.log('‚úÖ Datos cargados correctamente');
      renderProjects();
      selectProject(currentProjectIndex);
      checkOverdueTasks();
    }
    
    setupEventListeners();
    
    // Iniciar WebSocket despu√©s de cargar todo
    setTimeout(() => {
      if (window.authToken) {
        console.log('üöÄ Iniciando WebSockets...');
        initWebSocket();
      }
    }, 1000);
    
  } catch (error) {
    console.error('‚ùå Error cr√≠tico al iniciar:', error);
    showNotification('Error al cargar la aplicaci√≥n');
  }
});


    
    // INICIALIZACI√ìN DEL PASO 1
    const selector = document.getElementById('methodologySelector');
    if (selector) {
        selector.value = window.methodologyManager.getCurrentMode();
        selector.addEventListener('change', function() {
            if (window.methodologyManager.setMode(this.value)) {
                showNotification(`Modo cambiado a: ${this.value}`);
            }
        });
    }
    
    console.log('‚úÖ Sistema de metodolog√≠as inicializado');
    updateDashboardTitle(window.methodologyManager.getCurrentMode());
    addModeTooltips(window.methodologyManager.getCurrentMode());
    
    // Iniciar sistema de persistencia
    initPersistenceSystem();
    
    // Verificar que todo funcione
setTimeout(() => {
    validateApplication();
    
    // Mostrar resumen final
    console.log('üåà ¬°APLICACI√ìN COMPLETAMENTE OPERATIVA!');
    console.log('üìç Puedes usar estos comandos en consola:');
    console.log('   - forceSync() - Forzar sincronizaci√≥n manual');
    console.log('   - checkConnectionStatus() - Ver estado de conexi√≥n');
    console.log('   - debugApplication() - Diagn√≥stico completo');
    console.log('   - debugDashboard() - Diagn√≥stico del dashboard');
    
}, 1000);




// Funci√≥n de validaci√≥n completa
function validateApplication() {
    console.group('üîç VALIDACI√ìN DE LA APLICACI√ìN');
    
    // 1. Verificar que projects existe y es array
    console.log('üìã Projects:', projects && Array.isArray(projects) ? `‚úÖ ${projects.length} proyectos` : '‚ùå Error en projects');
    
    // 2. Verificar vistas principales
    const views = ['boardView', 'listView', 'dashboardView', 'timeAllocationView'];
    views.forEach(view => {
        const element = document.getElementById(view);
        console.log(`üëÄ ${view}:`, element ? '‚úÖ Encontrado' : '‚ùå No encontrado');
    });
    
    // 3. Verificar funcionalidades cr√≠ticas
    console.log('üñ±Ô∏è Drag & Drop:', typeof initDragAndDrop === 'function' ? '‚úÖ Listo' : '‚ùå No disponible');
    console.log('üìä Dashboard:', typeof renderDashboard === 'function' ? '‚úÖ Listo' : '‚ùå No disponible');
    console.log('‚è∞ Time Allocation:', typeof loadTimeAllocationData === 'function' ? '‚úÖ Listo' : '‚ùå No disponible');
    
    console.groupEnd();
    
    // Test r√°pido de funcionalidades
    testCriticalFunctions();
}

function testCriticalFunctions() {
    console.group('üß™ TEST DE FUNCIONALIDADES CR√çTICAS');
    
    // Test 1: Drag & Drop
    try {
        if (typeof initDragAndDrop === 'function') {
            initDragAndDrop();
            console.log('üéØ Drag & Drop: ‚úÖ Inicializado');
        }
    } catch (e) {
        console.log('üéØ Drag & Drop: ‚ùå Error', e.message);
    }
    
    // Test 2: Dashboard
    try {
        if (typeof renderDashboard === 'function') {
            renderDashboard();
            console.log('üìä Dashboard: ‚úÖ Renderizado');
        }
    } catch (e) {
        console.log('üìä Dashboard: ‚ùå Error', e.message);
    }
    
    console.groupEnd();
}

// === AGREGAR INICIALIZACI√ìN DE WEBSOCKETS AL FINAL ===
// INICIAR WEBSOCKETS AL FINAL, despu√©s de que todo est√© cargado
setTimeout(() => {
  if (window.authToken) {
    console.log('üöÄ Iniciando WebSockets...');
    initWebSocket();
  }
}, 2000);

/***********************
 * FUNCIONES DE MOVIMIENTO DE TAREAS *
 ***********************/
function moveTaskUp(taskId, status) {
  const project = projects[currentProjectIndex];
  const tasksInStatus = project.tasks.filter(t => t.status === status);
  const currentIndex = tasksInStatus.findIndex(t => t.id === taskId);
  
  if (currentIndex > 0) {
    const allTasks = project.tasks;
    const task1 = tasksInStatus[currentIndex];
    const task2 = tasksInStatus[currentIndex - 1];
    
    const index1 = allTasks.findIndex(t => t.id === task1.id);
    const index2 = allTasks.findIndex(t => t.id === task2.id);
    
    [allTasks[index1], allTasks[index2]] = [allTasks[index2], allTasks[index1]];
    
    updateLocalStorage();
    renderKanbanTasks();
// üî• AGREGAR ESTO AL FINAL:
    refreshCalendar();

  }
}

function moveTaskDown(taskId, status) {
  const project = projects[currentProjectIndex];
  const tasksInStatus = project.tasks.filter(t => t.status === status);
  const currentIndex = tasksInStatus.findIndex(t => t.id === taskId);
  
  if (currentIndex < tasksInStatus.length - 1) {
    const allTasks = project.tasks;
    const task1 = tasksInStatus[currentIndex];
    const task2 = tasksInStatus[currentIndex + 1];
    
    const index1 = allTasks.findIndex(t => t.id === task1.id);
    const index2 = allTasks.findIndex(t => t.id === task2.id);
    
    [allTasks[index1], allTasks[index2]] = [allTasks[index2], allTasks[index1]];
    
     updateLocalStorage();
    renderKanbanTasks();
// üî• AGREGAR ESTO AL FINAL:
    refreshCalendar();
  }
}


// Funciones para manejar subtareas
function addSubtask(taskId) {
  const input = document.getElementById(`newSubtaskInput-${taskId}`);
  const subtaskName = input.value.trim();
  
  if (!subtaskName) {
    showNotification('El nombre de la subtarea no puede estar vac√≠o');
    return;
  }
  
  const task = projects[currentProjectIndex].tasks.find(t => t.id === taskId);
  if (!task) return;
  
  if (!task.subtasks) task.subtasks = [];
  
  task.subtasks.push({
    id: Date.now(),
    name: subtaskName,
    completed: false
  });
  
  updateLocalStorage();
  showTaskDetails(task); // Refrescar la vista
  input.value = ''; // Limpiar el input
  showNotification('Subtarea agregada');
}

function toggleSubtaskCompletion(taskId, subtaskId, isCompleted) {
  const task = projects[currentProjectIndex].tasks.find(t => t.id === taskId);
  if (!task || !task.subtasks) return;
  
  const subtask = task.subtasks.find(st => st.id === subtaskId);
  if (subtask) {
    subtask.completed = isCompleted;
    updateLocalStorage();
// üî• AGREGAR JUSTO AQU√ç:
  refreshCalendar();

    showTaskDetails(task); // Refrescar la vista para actualizar el porcentaje
  }
}

function deleteSubtask(taskId, subtaskId) {
  const task = projects[currentProjectIndex].tasks.find(t => t.id === taskId);
  if (!task || !task.subtasks) return;
  
  task.subtasks = task.subtasks.filter(st => st.id !== subtaskId);
  updateLocalStorage();
  showTaskDetails(task); // Refrescar la vista
  showNotification('Subtarea eliminada');
}


/***********************
 * INICIALIZACI√ìN FINAL *
 ***********************/
// Verificar si hay vista activa en el localStorage
const activeView = localStorage.getItem('activeView') || 'board';
showView(activeView);

// Guardar la vista activa cuando cambia
Object.values(viewButtons).forEach(button => {
  if (button) {
    button.addEventListener('click', () => {
      localStorage.setItem('activeView', button.id.replace('show', '').toLowerCase());
    });
  }
});

// Verificar tareas rezagadas cada minuto
setInterval(checkOverdueTasks, 60000);

function updateProjectStatusLabel() {
    const project = projects[currentProjectIndex];
    if (!project || !project.tasks || project.tasks.length === 0) {
        document.getElementById('projectStatusLabel').textContent = 'Sin tareas';
        return;
    }

    // CALCULAR TIEMPO TOTAL Y REGISTRADO DEL PROYECTO
    const tiempoTotal = project.totalProjectTime || 0;
    const tiempoRegistrado = project.tasks.reduce((sum, task) => sum + (task.timeLogged || 0), 0);
    
    // TIEMPO RESTANTE = TIEMPO TOTAL - TIEMPO REGISTRADO
    const tiempoRestante = tiempoTotal - tiempoRegistrado;
    const isOnTime = tiempoRestante >= 0;

    const label = document.getElementById('projectStatusLabel');
    label.classList.remove('onTime', 'offTime');

    if (isOnTime) {
        label.classList.add('onTime');
        label.textContent = 'En tiempo';
    } else {
        label.classList.add('offTime');
        label.textContent = 'Fuera de tiempo';
    }
}
// === AGREGAR NUEVO RIESGO ===
document.getElementById('addRiskBtn')?.addEventListener('click', () => {
    const title = prompt("Ingrese el t√≠tulo del riesgo:");
    if (!title || title.trim() === "") return;

    const severityInput = prompt("Gravedad (alta/media/baja):").toLowerCase();
    let severityClass = "low";
    if (severityInput.includes("alta")) severityClass = "high";
    else if (severityInput.includes("media")) severityClass = "medium";

    const statusInput = prompt("Estado (no resuelto/en revisi√≥n/monitoreando/resuelto):").toLowerCase();
    let statusValue = "no-resuelto"; // Valor por defecto
    let statusText = "No resuelto"; // Texto para mostrar
    
    // Manejo correcto de estados
    if (statusInput.includes("no resuelto") || statusInput.includes("no-resuelto")) {
        statusValue = "no-resuelto";
        statusText = "No resuelto";
    } else if (statusInput.includes("revisi√≥n") || statusInput.includes("revision")) {
        statusValue = "en-revision";
        statusText = "En revisi√≥n";
    } else if (statusInput.includes("monitoreando")) {
        statusValue = "monitoreando";
        statusText = "Monitoreando";
    } else if (statusInput.includes("resuelto")) {
        statusValue = "resuelto";
        statusText = "Resuelto";
    }

    const riskId = Date.now();
    
    const newRisk = document.createElement("div");
    newRisk.className = `risk-item ${severityClass} status-${statusValue}`;
    newRisk.dataset.riskId = riskId;
    
    // Opciones para el select
    const statusOptions = [
        {value: "no-resuelto", label: "No resuelto"},
        {value: "en-revision", label: "En revisi√≥n"},
        {value: "monitoreando", label: "Monitoreando"},
        {value: "resuelto", label: "Resuelto"}
    ];
    
    let optionsHTML = '';
    statusOptions.forEach(option => {
        const selected = option.value === statusValue ? 'selected' : '';
        optionsHTML += `<option value="${option.value}" ${selected}>${option.label}</option>`;
    });
    
    newRisk.innerHTML = `
        <span class="risk-title">${title}</span>
        <select class="risk-status-select" onchange="updateRiskStatus(this)">
            ${optionsHTML}
        </select>
        <button class="risk-delete-btn" onclick="deleteRisk(${riskId})">Eliminar</button>
    `;

    // Aplicar estilo de borde para "No resuelto"
    if (statusValue === "no-resuelto") {
        if (severityClass === "high") {
            newRisk.style.borderLeft = "3px solid #e74c3c";
        } else if (severityClass === "medium") {
            newRisk.style.borderLeft = "3px solid #f39c12";
        } else {
            newRisk.style.borderLeft = "3px solid #2ecc71";
        }
    }
    
    document.getElementById("risksContainer").appendChild(newRisk);
    saveRisksToLocalStorage();
    updateRisksCount();
});



// Funci√≥n para eliminar riesgos
function deleteRisk(riskId) {
    if (confirm("¬øEst√°s seguro de que deseas eliminar este riesgo?")) {
        // Encontrar el elemento del riesgo por su ID
        const riskElement = document.querySelector(`.risk-item[data-risk-id="${riskId}"]`);
        
        if (riskElement) {
            // Eliminar el elemento del DOM
            riskElement.remove();
            
            // Mostrar notificaci√≥n
            showNotification("Riesgo eliminado correctamente");
            
            // Actualizar el almacenamiento local
            saveRisksToLocalStorage();
             updateRisksCount(); // ‚Üê Agregar aqu√≠
        }
    }
}

// Funci√≥n para guardar riesgos en localStorage (opcional)
// === FUNCIONES MEJORADAS PARA GESTI√ìN DE RIESGOS POR PROYECTO ===

// Funci√≥n para guardar riesgos en localStorage asociados al proyecto actual
function saveRisksToLocalStorage() {
  if (currentProjectIndex === undefined || currentProjectIndex === null) return;
  const project = projects[currentProjectIndex];
  if (!project) return;

  const risks = [];
  document.querySelectorAll('#risksContainer .risk-item').forEach(el => {
    risks.push({
      id: el.dataset.riskId,
      title: el.querySelector('.risk-title')?.textContent || 'Sin t√≠tulo',
      description: el.querySelector('.risk-description')?.textContent || '',
      severity: el.className.includes('high') ? 'high' :
                 el.className.includes('medium') ? 'medium' : 'low',
      status: el.className.match(/status-([a-z-]+)/)?.[1] || 'no-resuelto',
      date: el.dataset.riskDate || new Date().toISOString().split('T')[0]
    });
  });

  const key = `projectRisks_${currentProjectIndex}_${project.name.replace(/\s+/g, '_')}`;
  localStorage.setItem(key, JSON.stringify(risks));
  updateRisksCount(); // ‚Üê actualiza el contador en el KPI si lo usas
}


// Funci√≥n para cargar riesgos desde localStorage asociados al proyecto actual
function loadRisksFromLocalStorage() {
  if (currentProjectIndex === null || !projects[currentProjectIndex]) {
    document.getElementById('risksContainer').innerHTML = '<div class="empty-message">Seleccione un proyecto</div>';
    return;
  }

  const project = projects[currentProjectIndex];
  const key = `projectRisks_${currentProjectIndex}_${project.name.replace(/\s+/g, '_')}`;
  const savedRisks = JSON.parse(localStorage.getItem(key)) || [];

  const container = document.getElementById('risksContainer');
  container.innerHTML = '';

  if (savedRisks.length === 0) {
   
    return;
  }

  savedRisks.forEach(risk => {
    const riskEl = createRiskElement(risk);
    container.appendChild(riskEl);
  });
}
function createRiskElement(risk) {
    const riskElement = document.createElement('div');
    riskElement.className = `risk-item ${risk.severity} status-${risk.status}`;
    riskElement.dataset.riskId = risk.id;
    riskElement.dataset.riskDate = risk.date || new Date().toISOString().split('T')[0];

    const statusOptions = [
        { value: 'no-resuelto', label: 'No resuelto' },
        { value: 'en-revision', label: 'En revisi√≥n' },
        { value: 'monitoreando', label: 'Monitoreando' },
        { value: 'resuelto', label: 'Resuelto' }
    ];
    
    let optionsHTML = '';
    statusOptions.forEach(option => {
        const selected = risk.status === option.value ? 'selected' : '';
        optionsHTML += `<option value="${option.value}" ${selected}>${option.label}</option>`;
    });

    riskElement.innerHTML = `
        <div class="risk-header">
            <span class="risk-title">${risk.title || 'Riesgo sin t√≠tulo'}</span>
            <span class="risk-date">${formatDate(risk.date)}</span>
        </div>
        <div class="risk-description">${risk.description || 'Sin descripci√≥n'}</div>
        <div class="risk-footer">
            <select class="risk-status-select" onchange="updateRiskStatus(this)">
                ${optionsHTML}
            </select>
            <button class="risk-delete-btn" onclick="deleteRisk(${risk.id})">
                <i class="fas fa-trash"></i> Eliminar
            </button>
        </div>
    `;

    return riskElement;
}
// Funci√≥n auxiliar para formatear fechas (si no existe)
function formatDate(dateString) {
  if (!dateString) return 'No definida';
  const date = new Date(dateString);
  return date.toLocaleDateString('es-ES', {
    weekday: 'short',
    day: '2-digit',
    month: 'short',
    year: 'numeric'
  }).replace(/,/, '');
}

// Funci√≥n para actualizar el estado de los riesgos
function updateRiskStatus(selectElement) {
    const riskItem = selectElement.closest('.risk-item');
    // Aqu√≠ puedes agregar l√≥gica adicional si necesitas
    saveRisksToLocalStorage();
}
// === GESTI√ìN DE ACCIONES REQUERIDAS ===

// Evento para el bot√≥n Agregar
document.getElementById('addActionBtn')?.addEventListener('click', function() {
  const actionText = prompt("Ingrese la acci√≥n requerida:");
  if (actionText && actionText.trim() !== "") {
    addActionToList(actionText.trim());
    saveActionsToLocalStorage();
    showNotification("Acci√≥n agregada correctamente");
  }
});

// Funci√≥n para agregar acciones a la lista
// Funci√≥n para agregar acciones a la lista (con par√°metro opcional para guardar)
function addActionToList(text, saveToStorage = true) {
    const actionsList = document.getElementById('requiredActions');
    if (!actionsList) return;

    const li = document.createElement('li');
    li.className = 'action-item';
    
    li.innerHTML = `
        <span class="action-text">${text}</span>
        <button class="action-remove" onclick="removeAction(this)">
            <i class="fas fa-trash-alt"></i>
        </button>
    `;

    // Hacer editable al hacer doble clic
    const actionText = li.querySelector('.action-text');
    actionText.addEventListener('dblclick', function() {
        this.contentEditable = true;
        this.focus();
    });

    actionText.addEventListener('blur', function() {
        this.contentEditable = false;
        saveActionsToLocalStorage();
    });

    actionsList.appendChild(li);
    
    // Solo guardar si se especifica (evitar duplicados al cargar)
    if (saveToStorage) {
        saveActionsToLocalStorage();
    }
}

// Funci√≥n para eliminar acciones
function removeAction(button) {
    if (confirm("¬øEliminar esta acci√≥n?")) {
        button.closest('li').remove();
        saveActionsToLocalStorage();
        showNotification("Acci√≥n eliminada");
    }
}
// Guardar acciones en localStorage
// Guardar acciones en localStorage por proyecto
// Guardar acciones por proyecto
function saveActionsToLocalStorage() {
  if (currentProjectIndex === null) return;
  const actions = [];
  document.querySelectorAll('#requiredActions li').forEach(li => {
    const text = li.querySelector('span')?.textContent || '';
    const completed = li.querySelector('input[type="checkbox"]')?.checked || false;
    if (text.trim()) {
      actions.push({ id: Date.now() + Math.random(), text, completed });
    }
  });
  const key = `projectActions_${currentProjectIndex}`;
  localStorage.setItem(key, JSON.stringify(actions));
}

// Cargar acciones por proyecto
function loadActionsFromLocalStorage() {
  if (currentProjectIndex === null) return;
  const key = `projectActions_${currentProjectIndex}`;
  const actions = JSON.parse(localStorage.getItem(key)) || [];
  const list = document.getElementById('requiredActions');
  list.innerHTML = '';

  if (actions.length === 0) {
   
    return;
  }

  actions.forEach(action => {
    const li = document.createElement('li');
    li.style.display = 'flex';
    li.style.alignItems = 'center';
    li.style.gap = '10px';

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = action.completed;
    checkbox.onchange = () => {
      saveActionsToLocalStorage();
      loadActionsFromLocalStorage(); // o actualiza solo el estilo
    };

    const span = document.createElement('span');
    span.textContent = action.text;
    if (action.completed) {
      span.style.textDecoration = 'line-through';
      span.style.color = '#94a3b8';
    }

    const delBtn = document.createElement('button');
    delBtn.textContent = 'üóëÔ∏è';
    delBtn.onclick = () => {
      li.remove();
      saveActionsToLocalStorage();
      updateRisksCount(); // o solo recargar
    };
    delBtn.style.border = 'none';
    delBtn.style.background = 'none';
    delBtn.style.cursor = 'pointer';

    li.appendChild(checkbox);
    li.appendChild(span);
    li.appendChild(delBtn);
    list.appendChild(li);
  });
}
// Cargar acciones desde localStorage por proyecto
function loadActionsFromLocalStorage() {
    const actionsList = document.getElementById('requiredActions');
    if (!actionsList) return;
    
    actionsList.innerHTML = '';
    
    if (currentProjectIndex === null || !projects[currentProjectIndex]) {
        actionsList.innerHTML = '<li class="empty-message">Seleccione un proyecto</li>';
        return;
    }

    const projectActionsKey = `projectActions_${currentProjectIndex}`;
    const savedActions = JSON.parse(localStorage.getItem(projectActionsKey)) || [];
    
    if (savedActions.length === 0) {
        
        return;
    }

    savedActions.forEach(action => {
        addActionToList(action, false); // El segundo par√°metro evita guardar duplicados
    });
    
    console.log(`Acciones cargadas para proyecto ${currentProjectIndex}`);
}
// === GESTI√ìN DE PR√ìXIMOS HITOS ===

// Configurar el bot√≥n de agregar hito
document.getElementById('addMilestoneBtn')?.addEventListener('click', function() {
    const name = prompt("Nombre del hito:");
    if (!name || name.trim() === "") return;

    const dateStr = prompt("Fecha del hito (YYYY-MM-DD):");
    if (!dateStr) return;

    if (!isValidDate(dateStr)) {
        showNotification("Formato de fecha inv√°lido. Use YYYY-MM-DD");
        return;
    }

    addMilestoneToList(name, dateStr);
    showNotification("Hito agregado correctamente");
});

// Funci√≥n para validar fecha
function isValidDate(dateString) {
    const regEx = /^\d{4}-\d{2}-\d{2}$/;
    if (!dateString.match(regEx)) return false;
    const d = new Date(dateString);
    return !isNaN(d.getTime());
}

// Inicializaci√≥n al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    loadMilestonesFromLocalStorage();
});
// Funci√≥n para agregar hito a la lista
function addMilestoneToList(name, dateStr) {
  const list = document.getElementById('milestonesList');
  if (!list) return;

  const item = document.createElement('div');
  item.className = 'milestone-item';
  item.dataset.date = dateStr;
  item.innerHTML = `
    <span class="milestone-name">${name}</span>
    <span class="milestone-date">${formatDateForDisplay(dateStr)}</span>
    <button class="milestone-remove" onclick="removeMilestone(this)">üóëÔ∏è</button>
  `;
  list.appendChild(item);
}

function addNewMilestone() {
  const name = prompt("Nombre del hito:");
  if (!name || !name.trim()) return;

  const dateStr = prompt("Fecha (YYYY-MM-DD):");
  if (!dateStr || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
    alert("Formato de fecha inv√°lido");
    return;
  }

  if (isNaN(new Date(dateStr).getTime())) {
    alert("Fecha no v√°lida");
    return;
  }

  addMilestoneToList(name.trim(), dateStr);
  saveMilestonesToLocalStorage(); // ‚Üê guarda inmediatamente
}

// Guardar por proyecto
function saveMilestonesToLocalStorage() {
  if (currentProjectIndex === null) return;
  const milestones = [];
  document.querySelectorAll('#milestonesList .milestone-item').forEach(item => {
    milestones.push({
      name: item.querySelector('.milestone-name')?.textContent || '',
      date: item.dataset.date
    });
  });
  const key = `projectMilestones_${currentProjectIndex}`;
  localStorage.setItem(key, JSON.stringify(milestones));
}

// Cargar por proyecto
function loadMilestonesFromLocalStorage() {
  if (currentProjectIndex === null) return;
  const key = `projectMilestones_${currentProjectIndex}`;
  const milestones = JSON.parse(localStorage.getItem(key)) || [];
  const list = document.getElementById('milestonesList');
  list.innerHTML = '';

  if (milestones.length === 0) {
    list.innerHTML = '<div class="empty-message">No hay hitos programados</div>';
    return;
  }

  milestones.forEach(m => addMilestoneToList(m.name, m.date));
}
// Funci√≥n para formatear fecha para visualizaci√≥n
function formatDateForDisplay(dateStr) {
  const options = { year: 'numeric', month: 'short', day: 'numeric' };
  return new Date(dateStr).toLocaleDateString('es-ES', options);
}

// Funci√≥n para eliminar hito
function removeMilestone(button) {
  if (confirm("¬øEliminar este hito?")) {
    button.closest('.milestone-item').remove();
    saveMilestonesToLocalStorage();
    showNotification("Hito eliminado");
  }
}

// Guardar hitos en localStorage
function saveMilestonesToLocalStorage() {
  if (currentProjectIndex === null || !projects[currentProjectIndex]) return;


  const milestones = [];
    document.querySelectorAll('#milestonesList .milestone-item').forEach(item => {
        milestones.push({
            name: item.querySelector('.milestone-name').textContent,
            date: item.dataset.date,
            status: item.classList.contains('current') ? 'current' : 
                   item.classList.contains('overdue') ? 'overdue' : 'upcoming'
        });
    });
    
    const projectMilestonesKey = `projectMilestones_${currentProjectIndex}`;
    localStorage.setItem(projectMilestonesKey, JSON.stringify(milestones));
    console.log(`Hitos guardados para proyecto ${currentProjectIndex}`);
}


// Cargar hitos desde localStorage
function loadMilestonesFromLocalStorage() {
  const savedMilestones = JSON.parse(localStorage.getItem('projectMilestones')) || [];
  const milestonesList = document.getElementById('milestonesList');
  
  if (milestonesList) {
    milestonesList.innerHTML = '';
    savedMilestones.forEach(milestone => {
      addMilestoneToList(milestone.name, milestone.date);
    });
  }
}

// Inicializar al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
  loadMilestonesFromLocalStorage();
  
  // Asegurar que el bot√≥n tenga el event listener
  const addBtn = document.getElementById('addMilestoneBtn');
  if (addBtn) {
    addBtn.addEventListener('click', addNewMilestone);
  }
});// === ACCIONES R√ÅPIDAS ===

// 1. Nueva Tarea
document.getElementById('quickNewTaskBtn')?.addEventListener('click', function() {
  document.getElementById('createTaskModal').style.display = 'block';
  showNotification("Preparando formulario para nueva tarea");
});

// 2. Generar Reporte
document.getElementById('quickGenerateReportBtn')?.addEventListener('click', function() {
  generateProjectReport();
  showNotification("Generando reporte del proyecto");
});

// 3. Cambiar Vista (Explicaci√≥n detallada abajo)
document.getElementById('quickSwitchViewBtn')?.addEventListener('click', function() {
    const currentView = getActiveView();
    let nextView;
    switch(currentView) {
        case 'board': nextView = 'list'; break;
        case 'list': nextView = 'calendar'; break;
        case 'calendar': nextView = 'gantt'; break;
        case 'gantt': nextView = 'ganttPro'; break;  // ‚Üê Cambia de 'reports' a 'ganttPro'
                      case 'ganttPro': nextView = 'reports'; break;  // ‚Üê ‚úÖ AGREGAR ESTE CASE
        case 'reports': nextView = 'profitability'; break;
        case 'profitability': nextView = 'dashboard'; break;
        // Agrega la nueva vista aqu√≠
        case 'dashboard': nextView = 'timeAllocation'; break;
        case 'timeAllocation': nextView = 'board'; break; // Cierra el ciclo
        default: nextView = 'board';
    }
    showView(nextView);
    showNotification(`Cambiando a vista: ${getViewName(nextView)}`);
});
// Funci√≥n auxiliar para obtener nombre legible de la vista
function getViewName(view) {
    const names = {
        'board': 'Tablero Kanban',
        'list': 'Lista de Tareas',
        'calendar': 'Calendario',
        'gantt': 'Diagrama Gantt',
        'ganttPro': 'Gantt Pro',  // ‚Üê ‚úÖ AGREGAR ESTE
        'reports': 'Reportes',
        'profitability': 'Rentabilidad',
        'dashboard': 'Dashboard',
        'timeAllocation': 'Asignaci√≥n de Horas' // Agrega esta l√≠nea
    };
    return names[view] || view;
}// Mostrar/ocultar men√∫ contextual de proyectos
function toggleProjectMenu(event, projectIndex) {
  event.stopPropagation();
  
  // Cerrar todos los otros men√∫s
  document.querySelectorAll('.project-context-menu').forEach(menu => {
    if (menu.id !== `project-menu-${projectIndex}`) {
      menu.classList.remove('show');
    }
  });
  
  // Alternar el men√∫ actual
  const menu = document.getElementById(`project-menu-${projectIndex}`);
  if (menu) {
    menu.classList.toggle('show');
    // Posicionar el men√∫
    const rect = event.target.getBoundingClientRect();
    menu.style.left = `${rect.left}px`;
    menu.style.top = `${rect.bottom}px`;
  }
}

// Editar proyecto desde el men√∫ contextual
function editProjectFromMenu(projectIndex) {
  const project = projects[projectIndex];
  const newName = prompt('Editar nombre del proyecto:', project.name);
  
  if (newName && newName.trim()) {
    project.name = newName.trim();
    updateLocalStorage();
    renderProjects();
    selectProject(projectIndex);
    showNotification(`Proyecto renombrado a "${newName}"`);
  }
  
  // Cerrar todos los men√∫s
  document.querySelectorAll('.project-context-menu').forEach(menu => {
    menu.classList.remove('show');
  });
}

// Eliminar proyecto desde el men√∫ contextual
function deleteProjectFromMenu(projectIndex) {
  const project = projects[projectIndex];
  if (confirm(`¬øEst√°s seguro de eliminar el proyecto "${project.name}"?`)) {
    deleteProject(projectIndex);
  }
  
  // Cerrar todos los men√∫s
  document.querySelectorAll('.project-context-menu').forEach(menu => {
    menu.classList.remove('show');
  });
}

// === ACTUALIZAR BARRA DE AVANCE PEQUE√ëA ===
function updateStatusProgress() {
  const totalTasks = tasks.filter(t => t.projectId === currentProjectId).length;
  const completedTasks = tasks.filter(t => t.projectId === currentProjectId && t.status === 'completed').length;
  const progress = totalTasks === 0 ? 0 : Math.round((completedTasks / totalTasks) * 100);

  const fillElement = document.getElementById('statusProgressFill');
  const labelElement = document.getElementById('statusProgressLabel');

  if (fillElement && labelElement) {
    fillElement.style.width = `${progress}%`;
    labelElement.textContent = `${progress}% Completado`;
  }
}
// === FUNCIONES DE REPORTES - GENERAR VISTA ===
function generateReports(tasks = null) { // Acepta tareas filtradas como argumento
  console.log("generateReports llamado con tasks:", tasks ? `(${tasks.length} tareas)` : "null (usando todas)");
  const tasksToUse = tasks || getFilteredTasks('reports'); // Usa las tareas pasadas o filtra para 'reports'
  const stats = getStats(tasksToUse);
  const timeStats = getTimeStats(tasksToUse); // <-- Pasa las tareas filtradas aqu√≠

  // --- INICIO: Tu nuevo c√≥digo integrado ---
  // Aseg√∫rate de que `project` est√© definido aqu√≠ si lo necesitas
  const project = projects[currentProjectIndex];
  // --- INICIO: ACTUALIZACI√ìN DE CUADROS DE TIEMPO Y LEYENDA ---

   // *** 1. Tiempo Estimado ***
    const totalEstimatedTimeElem = document.getElementById('totalEstimatedTimeStatus');
    if (totalEstimatedTimeElem && !isNaN(timeStats.totalEstimated)) {
        totalEstimatedTimeElem.textContent = `${timeStats.totalEstimated.toFixed(2)} horas`;
        console.log(`Tiempo Estimado actualizado: ${timeStats.totalEstimated.toFixed(2)} horas`);
    } else {
        console.warn("Elemento totalEstimatedTimeStatus no encontrado o valor inv√°lido.");
    }

    // *** 2. Tiempo Registrado ***
    const totalLoggedTimeElem = document.getElementById('totalLoggedTimeStatus');
    if (totalLoggedTimeElem && !isNaN(timeStats.totalLogged)) {
        totalLoggedTimeElem.textContent = `${timeStats.totalLogged.toFixed(2)} horas`;
        console.log(`Tiempo Registrado actualizado: ${timeStats.totalLogged.toFixed(2)} horas`);
    } else {
        console.warn("Elemento totalLoggedTimeStatus no encontrado o valor inv√°lido.");
    }

    // *** 3. Tiempo Restante ***
    // *** 3. Tiempo Restante ***
const remainingTimeElem = document.getElementById('remainingTimeStatus');
if (remainingTimeElem) {
    // Calcular tiempo restante CORRECTO: totalProjectTime - totalLogged
    const tiempoTotal = project.totalProjectTime || 0;
    const tiempoRegistrado = timeStats.totalLogged || 0;
    const tiempoRestanteCorrecto = tiempoTotal - tiempoRegistrado;
    
    remainingTimeElem.textContent = `${tiempoRestanteCorrecto.toFixed(2)} horas`;
    console.log(`Tiempo Restante actualizado: ${tiempoRestanteCorrecto.toFixed(2)} horas`);
} else {
    console.warn("Elemento remainingTimeStatus no encontrado.");
}

    // *** 4. Tiempo Total del Proyecto (opcional, si se usa) ***
    const totalTimeElem = document.getElementById('totalProjectTimeStatus');
    if (totalTimeElem && project) {
        totalTimeElem.textContent = `${project.totalProjectTime || 0} horas`;
        console.log(`Tiempo Total del Proyecto actualizado: ${project.totalProjectTime || 0} horas`);
    } else if(totalTimeElem) {
         totalTimeElem.textContent = `0 horas`;
         console.log(`Tiempo Total del Proyecto actualizado a 0 horas (sin proyecto o sin tiempo definido).`);
    } else {
        console.warn("Elemento totalProjectTimeStatus no encontrado.");
    }
  // Actualizar barra de avance (la que creamos sin conflictos)
  const fillElement = document.getElementById('statusProgressFill');
  const labelElement = document.getElementById('statusProgressLabel');

  if (fillElement && labelElement) {
    fillElement.style.width = `${progress}%`;
    labelElement.textContent = `${progress}% Completado`;
  }

  // Actualizar contadores (si tienes estos elementos)
  const totalTasksEl = document.getElementById('totalTasks');
  const completedTasksEl = document.getElementById('completedTasks');
  updateReportsProjectProgress(); 
}

function updateResourceAllocation() {
    const project = projects[currentProjectIndex];
    if (!project || !project.tasks) return;

    const resourceList = document.getElementById('resourceList');
    const resourceChartCanvas = document.getElementById('resourceChart');
    
    if (!resourceList || !resourceChartCanvas) return;

    // Calcular asignaci√≥n de recursos
    const resourceData = calculateResourceAllocation(project.tasks);
    
    // Actualizar lista de recursos
    renderResourceList(resourceList, resourceData);
    
    // Actualizar gr√°fica de recursos
    renderResourceChart(resourceChartCanvas, resourceData);
}

function calculateResourceAllocation(tasks) {
    const resources = {};
    
    tasks.forEach(task => {
        const assignee = task.assignee || 'Sin asignar';
        const estimatedTime = task.estimatedTime || 0;
        const loggedTime = task.timeLogged || 0;
        
        if (!resources[assignee]) {
            resources[assignee] = {
                name: assignee,
                estimated: 0,
                logged: 0,
                tasks: 0
            };
        }
        
        resources[assignee].estimated += estimatedTime;
        resources[assignee].logged += loggedTime;
        resources[assignee].tasks += 1;
    });
    
    return Object.values(resources);
}

function renderResourceList(container, resourceData) {
    if (!container) return;
    
    if (resourceData.length === 0) {
        container.innerHTML = '<div class="empty-message">No hay recursos asignados</div>';
        return;
    }
    
    container.innerHTML = '';
    
    resourceData.forEach(resource => {
        const resourceItem = document.createElement('div');
        resourceItem.className = 'resource-item';
        
        const efficiency = resource.estimated > 0 ? 
            Math.round((resource.logged / resource.estimated) * 100) : 0;
        
        let efficiencyClass = 'efficiency-normal';
        if (efficiency > 100) efficiencyClass = 'efficiency-high';
        else if (efficiency < 80) efficiencyClass = 'efficiency-low';
        
        resourceItem.innerHTML = `
            <div class="resource-info">
                <h4>${resource.name}</h4>
                <div class="resource-stats">
                    <span class="stat"><i class="fas fa-tasks"></i> ${resource.tasks} tareas</span>
                    <span class="stat"><i class="fas fa-clock"></i> ${resource.estimated.toFixed(1)}h estimadas</span>
                    <span class="stat"><i class="fas fa-user-clock"></i> ${resource.logged.toFixed(1)}h registradas</span>
                </div>
            </div>
            <div class="resource-efficiency">
                <div class="efficiency-bar">
                    <div class="efficiency-fill ${efficiencyClass}" style="width: ${Math.min(efficiency, 100)}%"></div>
                </div>
                <div class="efficiency-value ${efficiencyClass}">${efficiency}%</div>
            </div>
        `;
        
        container.appendChild(resourceItem);
    });
}

function renderResourceChart(canvas, resourceData) {
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    if (!ctx) return;
    
    // Destruir gr√°fica existente si hay una
    if (window.resourceChart) {
        window.resourceChart.destroy();
    }
    
    if (resourceData.length === 0) {
        // Limpiar canvas si no hay datos
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
    }
    
    // Preparar datos para la gr√°fica
    const labels = resourceData.map(resource => resource.name);
    const estimatedData = resourceData.map(resource => resource.estimated);
    const loggedData = resourceData.map(resource => resource.logged);
    
    // Crear gr√°fica de barras agrupadas
    window.resourceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Horas Estimadas',
                    data: estimatedData,
                    backgroundColor: 'rgba(52, 152, 219, 0.7)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Horas Registradas',
                    data: loggedData,
                    backgroundColor: 'rgba(46, 204, 113, 0.7)',
                    borderColor: 'rgba(46, 204, 113, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Horas'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Recursos'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: false
                }
            }
        }
    });
}

// === FUNCI√ìN DE ASIGNACI√ìN DE RECURSOS (Versi√≥n M√≠nima) ===
function updateResourceAllocation() {
    console.log("Funci√≥n updateResourceAllocation llamada"); // Para verificar en consola
    
    // 1. Seleccionar el contenedor
    const container = document.getElementById('resourceAllocationContent');
    
    // 2. Verificar si el contenedor existe
    if (!container) {
        console.error("No se encontr√≥ el elemento con ID 'resourceAllocationContent'");
        return;
    }
    
    // 3. Mostrar un mensaje de prueba
    container.innerHTML = `
        <div style="padding: 20px; text-align: center; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px;">
            <h3 style="color: #495057;">Secci√≥n de Recursos</h3>
            <p style="color: #6c757d;">Esta secci√≥n mostrar√° la asignaci√≥n de recursos.</p>
            <p style="color: #6c757d; font-size: 0.9em;"><em>Implementaci√≥n en progreso...</em></p>
        </div>
    `;
    
    console.log("Contenido de prueba insertado en resourceAllocationContent");
}

// === FUNCI√ìN COMPLETA DE ASIGNACI√ìN DE RECURSOS ===
function updateResourceAllocation() {
    console.log("Ejecutando updateResourceAllocation");
    
    const project = projects[currentProjectIndex];
    if (!project) {
        console.log("No hay proyecto seleccionado");
        return;
    }
    
    // Seleccionar contenedores
    const resourceList = document.getElementById('resourceList');
    const resourceChartCanvas = document.getElementById('resourceChart');
    
    if (!resourceList || !resourceChartCanvas) {
        console.log("No se encontraron los elementos del DOM para recursos");
        return;
    }
    
    // Calcular asignaci√≥n de recursos
    const resourceData = calculateResourceAllocation(project.tasks || []);
    
    // Actualizar lista de recursos
    renderResourceList(resourceList, resourceData);
    
    // Actualizar gr√°fica de recursos
    renderResourceChart(resourceChartCanvas, resourceData);
}

function calculateResourceAllocation(tasks) {
    const resources = {};
    
    tasks.forEach(task => {
        // Usar 'assignee' o 'Asignado a:' seg√∫n tu estructura
        const assignee = task.assignee || task['Asignado a:'] || 'Sin asignar';
        const estimatedTime = parseFloat(task.estimatedTime) || 0;
        const timeLogged = parseFloat(task.timeLogged) || 0;
        
        if (!resources[assignee]) {
            resources[assignee] = {
                name: assignee,
                estimated: 0,
                logged: 0,
                tasks: 0
            };
        }
        
        resources[assignee].estimated += estimatedTime;
        resources[assignee].logged += timeLogged;
        resources[assignee].tasks += 1;
    });
    
    return Object.values(resources);
}

function renderResourceList(container, resourceData) {
    if (!container) return;
    
    if (resourceData.length === 0) {
        container.innerHTML = '<div class="empty-message">No hay recursos asignados</div>';
        return;
    }
    
    let html = '';
    resourceData.forEach(resource => {
        const efficiency = resource.estimated > 0 ? 
            Math.round((resource.logged / resource.estimated) * 100) : 0;
        
        let efficiencyClass = 'efficiency-normal';
        if (efficiency > 110) efficiencyClass = 'efficiency-high';
        else if (efficiency < 80) efficiencyClass = 'efficiency-low';
        
        html += `
            <div class="resource-item">
                <div class="resource-info">
                    <h4>${resource.name}</h4>
                    <div class="resource-stats">
                        <span class="stat"><i class="fas fa-tasks"></i> ${resource.tasks} tareas</span>
                        <span class="stat"><i class="fas fa-clock"></i> ${resource.estimated.toFixed(1)}h estimadas</span>
                        <span class="stat"><i class="fas fa-user-clock"></i> ${resource.logged.toFixed(1)}h registradas</span>
                    </div>
                </div>
                <div class="resource-efficiency">
                    <div class="efficiency-bar">
                        <div class="efficiency-fill ${efficiencyClass}" style="width: ${Math.min(efficiency, 100)}%"></div>
                    </div>
                    <div class="efficiency-value ${efficiencyClass}">${efficiency}%</div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function renderResourceChart(canvas, resourceData) {
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    if (!ctx) return;
    
    // Destruir gr√°fica existente si hay una
    if (window.resourceChart) {
        window.resourceChart.destroy();
    }
    
    if (resourceData.length === 0) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
    }
    
    // Preparar datos para la gr√°fica
    const labels = resourceData.map(resource => resource.name);
    const estimatedData = resourceData.map(resource => resource.estimated);
    const loggedData = resourceData.map(resource => resource.logged);
    
    // Crear gr√°fica de barras agrupadas
    window.resourceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Horas Estimadas',
                    data: estimatedData,
                    backgroundColor: 'rgba(52, 152, 219, 0.7)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Horas Registradas',
                    data: loggedData,
                    backgroundColor: 'rgba(46, 204, 113, 0.7)',
                    borderColor: 'rgba(46, 204, 113, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Horas'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Recursos'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        }
    });
}

// === BARRA DE PROGRESO INDEPENDIENTE PARA DASHBOARD ===
function updateDashboardProjectProgress() {
    const project = projects[currentProjectIndex];
    if (!project) return;
    
    const stats = getStats();
    const completionPercentage = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;
    
    // Actualizar la barra de progreso independiente del Dashboard
    const progressFill = document.getElementById('dashboardProjectProgressFill');
    const progressText = document.getElementById('dashboardProjectProgressText');
    
    if (progressFill) {
        progressFill.style.width = `${completionPercentage}%`;
    }
    
    if (progressText) {
        progressText.textContent = `${completionPercentage}% Completado`;
    }
}
// === BARRA DE PROGRESO CORREGIDA PARA VISTA STATUS/REPORTS ===
function updateReportsProjectProgress() {
    console.log("üîÑ Actualizando barra de progreso de Status/Reports");

    const project = projects[currentProjectIndex];
    if (!project) {
        console.log("‚ö†Ô∏è No hay proyecto seleccionado");
        const fillElement = document.getElementById('reportsProjectProgressFill');
        const textElement = document.getElementById('reportsProjectProgressText');
        if (fillElement) fillElement.style.width = '0%';
        if (textElement) textElement.textContent = '0% Completado';
        return;
    }

    // ‚úÖ USAR LA FUNCI√ìN CORRECTA QUE YA CREASTE
    const completionPercentage = getProjectProgress(project); // ‚Üê ESTO dar√° 53%

    console.log(`‚úÖ Progreso calculado: ${completionPercentage}%`);

    // Actualizar la barra y el texto
    const progressFill = document.getElementById('reportsProjectProgressFill');
    const progressText = document.getElementById('reportsProjectProgressText');

    if (progressFill) {
        progressFill.style.width = `${completionPercentage}%`;
        
        // Color din√°mico
        if (completionPercentage >= 80) {
            progressFill.style.background = 'linear-gradient(90deg, #2ecc71, #27ae60)';
        } else if (completionPercentage >= 50) {
            progressFill.style.background = 'linear-gradient(90deg, #f39c12, #e67e22)';
        } else {
            progressFill.style.background = 'linear-gradient(90deg, #e74c3c, #c0392b)';
        }
        
        console.log(`üé® Barra actualizada a ${completionPercentage}%`);
    }

    if (progressText) {
    progressText.innerHTML = `‚è±Ô∏è ${completionPercentage}% Progreso real`;
    
    // Color del texto
    if (completionPercentage >= 80) {
        progressText.style.color = '#2ecc71';
    } else if (completionPercentage >= 50) {
        progressText.style.color = '#f39c12';
    } else {
        progressText.style.color = '#e74c3c';
    }
    
    progressText.style.fontWeight = 'bold';
    console.log(`üìù Texto actualizado a ${completionPercentage}% Completado`);
}
}


// --- M√ìDULO DE SEGUIMIENTO DE HORAS - INICIO ---

let timeTrackingChartInstance = null; // Variable global para la instancia de Chart.js

/**
 * Calcula los datos de seguimiento de horas a partir de las tareas del proyecto actual.
 * Esta funci√≥n debe llamarse DESDE el script principal donde 'projects' y 'currentProjectIndex' est√°n disponibles.
 * @param {Array} projectTasks - Las tareas del proyecto actual (projects[currentProjectIndex].tasks)
 * @param {String} projectName - El nombre del proyecto actual (projects[currentProjectIndex].name)
 * @returns {Array} Array de objetos con { assignee, projectName, hours, lastRegister }
 */




function calculateTimeTrackingData(projectTasks, projectName) {
    console.group("üìä Calculando datos de seguimiento de horas");
    console.log("üì¶ Tareas del proyecto:", projectTasks);
    
    const trackingData = {};
    
    projectTasks.forEach(task => {
        // Obtener el asignado (con compatibilidad para diferentes nombres de propiedad)
        const assignee = task.assignee || task['Asignado a:'] || 'Sin asignar';
        
        // Obtener horas registradas (con compatibilidad para diferentes formatos)
        const hours = parseFloat(task.timeLogged) || 0;
        
        // Obtener √∫ltima fecha de registro (usamos deadline si no hay startDate)
        const lastRegister = task.startDate || task.deadline || new Date().toISOString();
        
        if (!trackingData[assignee]) {
            trackingData[assignee] = {
                assignee: assignee,
                projectName: projectName,
                hours: 0,
                lastRegister: lastRegister
            };
        }
        
        trackingData[assignee].hours += hours;
        
        // Mantener la fecha m√°s reciente
        if (new Date(lastRegister) > new Date(trackingData[assignee].lastRegister)) {
            trackingData[assignee].lastRegister = lastRegister;
        }
    });
    
    const result = Object.values(trackingData);
    console.log("‚úÖ Datos calculados:", result);
    console.groupEnd();
    return result;
}




/**
 * Renderiza el m√≥dulo de Seguimiento de Horas en el Dashboard.
 * Debe llamarse cuando el proyecto y sus datos est√©n cargados.
 */
function renderTimeTrackingModule() {
    console.log("üñºÔ∏è Renderizando m√≥dulo de Seguimiento de Horas...");

    // Verificar que tenemos un proyecto seleccionado
    if (typeof projects === 'undefined' || typeof currentProjectIndex === 'undefined' || !projects[currentProjectIndex]) {
        console.warn("‚ö†Ô∏è No se puede renderizar el m√≥dulo: proyecto no disponible.");
        updateTimeTrackingTable([]);
        updateTimeTrackingChart([]);
        populateTimeTrackingFilters([]);
        return;
    }

    const project = projects[currentProjectIndex];
    const projectName = project.name || `Proyecto ${currentProjectIndex + 1}`;

    console.log(`üì¶ Proyecto actual: ${projectName}`);

    // Calcular datos de seguimiento
    const timeTrackingData = calculateTimeTrackingData(project.tasks, projectName);

    // Poblar filtros
    populateTimeTrackingFilters(timeTrackingData);

    // Aplicar filtros iniciales (mostrar todo)
    const initialFilteredData = filterTimeTrackingData(timeTrackingData, {
        year: 'all',
        month: 'all',
        project: 'all',
        assignee: 'all'
    });

    // Actualizar vista
    updateTimeTrackingTable(initialFilteredData);
    updateTimeTrackingChart(initialFilteredData);

    console.log("‚úÖ M√≥dulo de Seguimiento de Horas renderizado.");
}
/**
 * Puebla los selectores de filtros con datos √∫nicos.
 * @param {Array} data - Los datos de seguimiento de horas.
 */
function populateTimeTrackingFilters(data) {
    console.group("üîÑ Poblando filtros de seguimiento de horas...");
    console.log("Datos recibidos para poblar filtros:", data);

    const projectSelect = document.getElementById('timeTrackingProject');
    const assigneeSelect = document.getElementById('timeTrackingAssignee');

    if (!projectSelect) {
        console.error("‚ùå Elemento 'timeTrackingProject' no encontrado en el DOM.");
    }
    if (!assigneeSelect) {
        console.error("‚ùå Elemento 'timeTrackingAssignee' no encontrado en el DOM.");
    }
    // Limpiar y resetear selectores si existen
    if (projectSelect) {
        console.log("Limpiando selector de proyectos...");
        projectSelect.innerHTML = '<option value="all">Todos</option>';
    }
    if (assigneeSelect) {
        console.log("Limpiando selector de asignados...");
        assigneeSelect.innerHTML = '<option value="all">Todos</option>';
    }

    if (!data || !Array.isArray(data) || data.length === 0) {
        console.warn("‚ö†Ô∏è No hay datos para poblar los filtros o los datos no son v√°lidos.");
        console.groupEnd();
        return;
    }


    const projectsSet = new Set();
    const assigneesSet = new Set();


  console.log("Extrayendo proyectos y asignados √∫nicos de los datos...");
    data.forEach((item, index) => {
        console.log(`Procesando item ${index}:`, item);
        if (item.projectName && typeof item.projectName === 'string') {
            projectsSet.add(item.projectName);
            console.log(`  ‚úÖ Proyecto encontrado: ${item.projectName}`);
        } else {
            console.warn(`  ‚ö†Ô∏è Item ${index} no tiene projectName v√°lido:`, item.projectName);
        }
        
        if (item.assignee && typeof item.assignee === 'string' && item.assignee.trim() !== '') {
            assigneesSet.add(item.assignee.trim());
            console.log(`  ‚úÖ Asignado encontrado: ${item.assignee.trim()}`);
        } else {
            console.warn(`  ‚ö†Ô∏è Item ${index} no tiene assignee v√°lido:`, item.assignee);
        }
    });

    console.log("üè∑Ô∏è Proyectos encontrados para filtros:", Array.from(projectsSet));
    console.log("üë§ Asignados encontrados para filtros:", Array.from(assigneesSet));

    // Poblar selectores si existen
    if (projectSelect && projectsSet.size > 0) {
        console.log("Poblando selector de proyectos...");
        projectsSet.forEach(project => {
            if (project) {
                const option = new Option(project, project);
                projectSelect.appendChild(option);
                console.log(`  ‚úÖ Opci√≥n de proyecto agregada: ${project}`);
            }
        });
    }

 else if (projectSelect) {
        console.log("‚ÑπÔ∏è No hay proyectos v√°lidos para agregar al selector.");
    }

    if (assigneeSelect && assigneesSet.size > 0) {
        console.log("Poblando selector de asignados...");
        assigneesSet.forEach(assignee => {
            if (assignee) {
                const option = new Option(assignee, assignee);
                assigneeSelect.appendChild(option);
                console.log(`  ‚úÖ Opci√≥n de asignado agregada: ${assignee}`);
            }
        });
    } else if (assigneeSelect) {
        console.log("‚ÑπÔ∏è No hay asignados v√°lidos para agregar al selector.");
    }

    console.log("‚úÖ Filtros de seguimiento de horas poblados.");
    console.groupEnd();
}
function getCurrentTimeTrackingFilters() {
    return {
        year: document.getElementById('timeTrackingYear')?.value || 'all',
        month: document.getElementById('timeTrackingMonth')?.value || 'all',
        project: document.getElementById('timeTrackingProject')?.value || 'all',
        assignee: document.getElementById('timeTrackingAssignee')?.value || 'all'
    };
}

/**
 * Filtra los datos de seguimiento seg√∫n los criterios.
 * @param {Array} data - Los datos a filtrar.
 * @param {Object} filters - Los filtros a aplicar.
 * @returns {Array} Los datos filtrados.
 */
function filterTimeTrackingData(data, filters) {
    console.log("üõ†Ô∏è Filtrando datos de seguimiento...", { data, filters });

    if (!data || !Array.isArray(data)) return [];

    const { year, month, project, assignee } = filters;

    return data.filter(item => {
        // Filtro por a√±o
        if (year !== 'all' && item.lastRegister) {
            if (!item.lastRegister.startsWith(String(year))) {
                return false;
            }
        }

        // Filtro por mes
        if (month !== 'all' && item.lastRegister) {
            try {
                const itemMonth = new Date(item.lastRegister).getMonth() + 1; // 1-12
                if (parseInt(month, 10) !== itemMonth) {
                    return false;
                }
            } catch (e) {
                console.warn("Error al parsear mes de", item.lastRegister);
            }
        }

        // Filtro por proyecto
        if (project !== 'all' && item.projectName !== project) {
            return false;
        }

        // Filtro por asignado
        if (assignee !== 'all' && item.assignee !== assignee) {
            return false;
        }

        return true;
    });
}

/**
 * Actualiza la tabla del m√≥dulo de seguimiento de horas.
 * @param {Array} data - Los datos a mostrar.
 */
function updateTimeTrackingTable(data) {
    console.log("üìã Actualizando tabla de seguimiento con", data.length, "elementos.");
    const tbody = document.getElementById('timeTrackingTableBody');
    if (!tbody) {
        console.error("‚ùå Elemento 'timeTrackingTableBody' no encontrado.");
        return;
    }

    tbody.innerHTML = data.length > 0 ? data.map(item => `
      <tr>
        <td>${item.assignee || 'N/A'}</td>
        <td>${item.projectName || 'N/A'}</td>
        <td>${(typeof item.hours === 'number') ? item.hours.toFixed(2) : '0.00'}</td>
        <td>${(item.hours && typeof item.hours === 'number') ? (item.hours / 20).toFixed(2) : '0.00'}</td>
        <td>${formatDateForTracking(item.lastRegister)}</td>
      </tr>
    `).join('') : '<tr><td colspan="5">No hay datos</td></tr>';
}

/**
 * Formatea una fecha para mostrar en la tabla.
 * @param {String} dateString - La fecha en formato ISO.
 * @returns {String} La fecha formateada.
 */
function formatDateForTracking(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return 'Fecha Inv√°lida';
    return date.toLocaleDateString('es-ES');
}

/**
 * Actualiza la gr√°fica del m√≥dulo de seguimiento de horas.
 * @param {Array} data - Los datos a mostrar.
 */
function updateTimeTrackingChart(data) {
    console.log("üìä Actualizando gr√°fica de seguimiento con", data.length, "elementos.");
    const ctx = document.getElementById('timeTrackingChart')?.getContext('2d');
    if (!ctx) {
        console.error("‚ùå Contexto 2D del canvas 'timeTrackingChart' no encontrado.");
        return;
    }

    // Destruir instancia anterior si existe
    if (timeTrackingChartInstance) {
        timeTrackingChartInstance.destroy();
        timeTrackingChartInstance = null;
    }

    if (data.length === 0) {
        // Limpiar el canvas si no hay datos
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        return;
    }

    const labels = data.map(item => item.assignee || 'N/A');
    const hoursData = data.map(item => (typeof item.hours === 'number') ? item.hours : 0);

    timeTrackingChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Horas trabajadas',
                data: hoursData,
                backgroundColor: 'rgba(54, 162, 235, 0.7)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Horas'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Asignado'
                    }
                }
            }
        }
    });
    console.log("üìä Gr√°fica de seguimiento actualizada.");
}

// --- CONFIGURACI√ìN DE EVENT LISTENERS PARA EL M√ìDULO ---
// Este bloque se puede colocar junto con otros event listeners de tu aplicaci√≥n,
// por ejemplo, dentro de una funci√≥n de inicializaci√≥n o al final del DOMContentLoaded.

document.addEventListener('DOMContentLoaded', function () {
  // ==== PRIMERO: Inicializaci√≥n del sistema ====
  // Inicializa el manager de metodolog√≠as
  window.methodologyManager = new MethodologyManager();

  // ==== SEGUNDO: Configuraci√≥n del seguimiento de horas ====
  // Configurar event listener para el bot√≥n de aplicar filtros de seguimiento de horas
  const applyButton = document.getElementById('applyTimeTrackingFilters');
  if (applyButton) {
    applyButton.addEventListener('click', function () {
      console.log("üñ±Ô∏è Bot√≥n 'Aplicar' de seguimiento de horas clickeado.");

      // Verificar que las variables globales est√©n disponibles
      if (typeof projects === 'undefined' || typeof currentProjectIndex === 'undefined' || !projects[currentProjectIndex]) {
        console.warn("‚ö†Ô∏è No se puede aplicar filtro: proyecto no disponible.");
        updateTimeTrackingTable([]);
        updateTimeTrackingChart([]);
        return;
      }

      const project = projects[currentProjectIndex];
      const projectName = project.name || `Proyecto ${currentProjectIndex + 1}`;

      // 1. Recalcular datos (por si han cambiado)
      const timeTrackingData = calculateTimeTrackingData(project.tasks, projectName);
      console.log("üìä Datos de seguimiento calculados:", timeTrackingData);
      // Poblar filtros
      populateTimeTrackingFilters(timeTrackingData);
      // ...

      // 2. Obtener filtros actuales
      const filters = getCurrentTimeTrackingFilters();
      console.log("üîç Filtros aplicados:", filters);

      // 3. Filtrar datos
      const filteredData = filterTimeTrackingData(timeTrackingData, filters);

      // 4. Actualizar vista
      updateTimeTrackingTable(filteredData);
      updateTimeTrackingChart(filteredData);

      console.log("‚úÖ Filtros de seguimiento de horas aplicados.");
    });
  } else {
    console.warn("‚ö†Ô∏è Bot√≥n 'applyTimeTrackingFilters' no encontrado en el DOM al cargar.");
  }

  // Poblar din√°micamente el selector de meses si existe
  const monthSelect = document.getElementById('timeTrackingMonth');
  if (monthSelect) {
    // Limpiar opciones existentes excepto "Todos"
    monthSelect.innerHTML = '<option value="all">Todos</option>';

    // Agregar meses del 1 al 12
    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
      "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    for (let i = 1; i <= 12; i++) {
      const option = document.createElement('option');
      option.value = i.toString(); // Usar string para facilitar comparaci√≥n
      option.textContent = `${i.toString().padStart(2, '0')} - ${monthNames[i - 1]}`;
      monthSelect.appendChild(option);
    }
    console.log("üìÖ Selector de meses poblado.");
  }

  // ==== TERCERO: Configuraci√≥n del Gantt Ejecutivo ====
  /**************************************
   * FUNCI√ìN PARA MOSTRAR GANTT COMO VISTA *
   **************************************/
 window.showExecutiveGantt = async function() {
 // üîí VERIFICACI√ìN DE LICENCIA DESDE LOCALSTORAGE
const userPlan = localStorage.getItem('userPlan');
if (userPlan !== 'professional' && userPlan !== 'premium') {
  showNotification('üîí El Gantt Ejecutivo est√° disponible en los planes Profesional o Premium.');
  return;
}

  // ‚úÖ USUARIO AUTORIZADO - mostrar Gantt
  console.log('üöÄ Mostrando Gantt Ejecutivo como vista principal...');

  // Ocultar otras vistas
  const viewsToHide = [
    'kanban-container', 'list-view', 'calendar-view',
    'dashboard', 'projects-container', 'tasks-container'
  ];
  viewsToHide.forEach(viewId => {
    const view = document.getElementById(viewId);
    if (view) view.style.display = 'none';
  });

  // Eliminar Gantt anterior
  const oldGantt = document.getElementById('premiumExecutiveGantt');
  if (oldGantt) oldGantt.remove();

  // Eliminar overlays
  document.querySelectorAll('.executive-overlay').forEach(el => el.remove());

  // Crear nuevo Gantt
  if (typeof createCompleteGanttForCurrentProject === 'function') {
    createCompleteGanttForCurrentProject();
    console.log('‚úÖ Gantt Ejecutivo creado como vista principal');
  } else {
    alert('Error al cargar el Gantt Ejecutivo.');
  }
};

// Hacer la funci√≥n disponible globalmente
console.log('‚úÖ Funci√≥n showExecutiveGantt() cargada. Usa: showExecutiveGantt()');

  // === AQU√ç VA EL EVENTO DEL SELECTOR ===
  const selector = document.getElementById('methodologySelector');
  if (selector) {
    selector.addEventListener('change', function () {
      const mode = this.value;
      window.methodologyManager.setMode(mode);
      applyDashboardModeStyles(mode); // Aplica estilos visuales
      addModeTooltips(mode); // üëà A√±adido
      updateModeIndicator(mode); // üëà A√±ade esta l√≠nea
      updateModeHelpText(mode);
      updateDashboardTitle(mode);
    });
  }

  // Aplica el modo guardado
  window.methodologyManager.setMode(window.methodologyManager.currentMode);

  // Aseg√∫rate de que el dashboard est√© visible
  setTimeout(() => {
    highlightRelevantSections(window.methodologyManager.currentMode);
  }, 100);

  // ==== CUARTO: Inicializaci√≥n del dashboard (segura) ====
  try {
    if (typeof loadDashboardProjectData === 'function') loadDashboardProjectData();
    if (typeof alignDashboardRow3Cards === 'function') alignDashboardRow3Cards();
    if (typeof updateProjectHealthStatus === 'function') updateProjectHealthStatus();
    if (typeof updateMilestones === 'function') updateMilestones();
    if (typeof updateRequiredActions === 'function') updateRequiredActions();
    if (typeof updateStatistics === 'function') updateStatistics();
    if (typeof getStats === 'function' && typeof generatePieChart === 'function') {
      generatePieChart(getStats());
    }
    if (typeof updateResourceAllocation === 'function') updateResourceAllocation();
    if (typeof updateProjectTimeline === 'function') updateProjectTimeline();
    if (typeof updateProjectDatesFromTasks === 'function') updateProjectDatesFromTasks();
    if (typeof updateRisksCount === 'function') updateRisksCount();
    
    const currentMode = window.methodologyManager.getCurrentMode();
    if (typeof applyDashboardModeStyles === 'function') {
      applyDashboardModeStyles(currentMode);
    }
    if (typeof applyDetailedModeStyles === 'function') {
      applyDetailedModeStyles(currentMode);
    }
  } catch (error) {
    console.warn('‚ö†Ô∏è Error al inicializar el dashboard:', error);
  }


// Cargar configuraci√≥n del sistema
loadSystemConfiguration();

// Crear bot√≥n de configuraci√≥n si no existe
if (!document.getElementById('configButton')) {
  // Buscar el contenedor del header
  const headerContainer = document.querySelector('.header') || 
                        document.querySelector('#header') || 
                        document.querySelector('.top-bar') ||
                        document.querySelector('.navbar') ||
                        document.body;
  
  const configButton = document.createElement('button');
  configButton.id = 'configButton';
  configButton.innerHTML = '<i class="fas fa-cog"></i>';
  configButton.title = 'Configuraci√≥n';
  configButton.style.cssText = `
    background: #2a2a2a;
    color: #ffffff;
    border: 1px solid #444;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 10px;
  `;
  
  // A√±adir evento
  configButton.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // Cerrar men√∫s existentes
    const existingMenu = document.getElementById('configMenu');
    if (existingMenu) {
      existingMenu.remove();
      return;
    }
    
    const rect = configButton.getBoundingClientRect();
    const menu = document.createElement('div');
    menu.id = 'configMenu';
    menu.style.cssText = `
      position: fixed;
      top: ${rect.bottom + 5}px;
      right: ${window.innerWidth - rect.right}px;
      background: #1a1a1a;
      border: 1px solid #444;
      border-radius: 10px;
      padding: 10px 0;
      min-width: 220px;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      font-family: Arial, sans-serif;
    `;
    
    menu.innerHTML = `
      <div style="padding: 12px 20px; color: #FFD700; font-weight: bold; border-bottom: 1px solid #444; margin-bottom: 8px; font-size: 14px;">
        ‚öôÔ∏è Configuraci√≥n
      </div>
      <div onclick="showLicensesView(); document.getElementById('configMenu').remove();" 
           style="padding: 12px 20px; cursor: pointer; color: #ffffff; display: flex; align-items: center; gap: 12px; font-size: 14px;">
        <i class="fas fa-key" style="color: #4CAF50;"></i> Gesti√≥n de Licencias
      </div>
      <div onclick="showSystemConfiguration(); document.getElementById('configMenu').remove();" 
           style="padding: 12px 20px; cursor: pointer; color: #ffffff; display: flex; align-items: center; gap: 12px; font-size: 14px;">
        <i class="fas fa-cog"></i> Configuraci√≥n del sistema
      </div>
      <div onclick="showHelpSupport(); document.getElementById('configMenu').remove();" 
           style="padding: 12px 20px; cursor: pointer; color: #ffffff; display: flex; align-items: center; gap: 12px; font-size: 14px;">
        <i class="fas fa-question-circle"></i> Ayuda y soporte
      </div>
      <div onclick="showAbout(); document.getElementById('configMenu').remove();" 
           style="padding: 12px 20px; cursor: pointer; color: #ffffff; display: flex; align-items: center; gap: 12px; border-top: 1px solid #444; margin-top: 8px; font-size: 14px;">
        <i class="fas fa-info-circle"></i> Acerca de
      </div>
    `;
    
    document.body.appendChild(menu);
    
    document.addEventListener('click', function closeHandler(e) {
      if (!menu.contains(e.target) && e.target.id !== 'configButton') {
        menu.remove();
        document.removeEventListener('click', closeHandler);
      }
    });
  });
  
  // Insertar en el header
  const headerButtons = headerContainer.querySelectorAll('button, .btn');
  if (headerButtons.length > 0) {
    const lastButton = headerButtons[headerButtons.length - 1];
    lastButton.parentNode.insertBefore(configButton, lastButton.nextSibling);
  } else {
    headerContainer.appendChild(configButton);
  }
}

});

// === ACTUALIZAR INDICADOR DE MODO ===
function updateModeIndicator(mode) {
  const indicator = document.getElementById('modeIndicator');
  const icon = indicator.querySelector('i');
  const modeText = document.getElementById('currentModeText');
  
  if (!indicator || !icon || !modeText) return;

  // Resetear clases
  indicator.classList.remove('mode-indicator-agile', 'mode-indicator-traditional', 'mode-indicator-hybrid');

  // Configurar icono y texto por modo
  const config = {
    agile: {
      icon: 'fa-bolt',
      text: '√Ågil',
      class: 'mode-indicator-agile'
    },
    traditional: {
      icon: 'fa-tasks',
      text: 'Tradicional',
      class: 'mode-indicator-traditional'
    },
    hybrid: {
      icon: 'fa-sync-alt',
      text: 'H√≠brido',
      class: 'mode-indicator-hybrid'
    }
  };

  const c = config[mode];
  icon.className = 'fas ' + c.icon;
  modeText.textContent = c.text;
  indicator.classList.add(c.class);
}


// === FUNCI√ìN DE PRUEBA PARA POBLAR FILTROS MANUALMENTE ===
// Esta funci√≥n se puede llamar manualmente desde la consola del navegador
function debugPopulateFilters() {
    console.log("=== DEBUG: Iniciando poblado manual de filtros ===");

    // 1. Intentar encontrar los elementos
    const projectSelect = document.getElementById('timeTrackingProject');
    const assigneeSelect = document.getElementById('timeTrackingAssignee');

    console.log("Elemento timeTrackingProject:", projectSelect);
    console.log("Elemento timeTrackingAssignee:", assigneeSelect);

    if (!projectSelect) {
        console.error("‚ùå NO SE ENCONTR√ì EL SELECTOR DE PROYECTO");
        return;
    }
    if (!assigneeSelect) {
        console.error("‚ùå NO SE ENCONTR√ì EL SELECTOR DE ASIGNADO");
        return;
    }

    // 2. Limpiar selectores
    projectSelect.innerHTML = '<option value="all">[DEBUG] Todos los Proyectos</option>';
    assigneeSelect.innerHTML = '<option value="all">[DEBUG] Todos los Asignados</option>';

    // 3. Agregar opciones de prueba
    console.log("Agregando opciones de prueba...");
    const testOption1 = new Option("[DEBUG] Proyecto Alpha", "proyecto_alpha");
    const testOption2 = new Option("[DEBUG] Proyecto Beta", "proyecto_beta");
    projectSelect.appendChild(testOption1);
    projectSelect.appendChild(testOption2);

    const testAssignee1 = new Option("[DEBUG] Juan P√©rez", "juan");
    const testAssignee2 = new Option("[DEBUG] Mar√≠a Garc√≠a", "maria");
    assigneeSelect.appendChild(testAssignee1);
    assigneeSelect.appendChild(testAssignee2);

    console.log("‚úÖ Opciones de prueba agregadas. ¬°Deber√≠as verlas en los filtros ahora!");
    console.log("Si ves las opciones de prueba, el problema est√° en la funci√≥n que pobla los datos reales.");
}

// === FUNCI√ìN PARA POBLAR CON DATOS REALES (versi√≥n simplificada y verbosa) ===
function populateTimeTrackingFiltersREAL() {
    console.group("=== POBLANDO FILTROS CON DATOS REALES ===");

    // 1. Verificar elementos del DOM
    const projectSelect = document.getElementById('timeTrackingProject');
    const assigneeSelect = document.getElementById('timeTrackingAssignee');

    if (!projectSelect || !assigneeSelect) {
        console.error("‚ùå NO SE ENCONTRARON LOS ELEMENTOS DEL DOM");
        console.groupEnd();
        return;
    }

    // 2. Limpiar selectores
    projectSelect.innerHTML = '<option value="all">Todos</option>';
    assigneeSelect.innerHTML = '<option value="all">Todos</option>';

    // 3. Verificar datos globales
    console.log("window.projects:", window.projects);
    console.log("window.currentProjectIndex:", window.currentProjectIndex);

    if (!window.projects || !Array.isArray(window.projects)) {
        console.error("‚ùå window.projects NO ES UN ARRAY V√ÅLIDO");
        console.groupEnd();
        return;
    }

    // 4. Extraer datos √∫nicos
    const uniqueProjects = new Set();
    const uniqueAssignees = new Set();

    window.projects.forEach((project, index) => {
        console.log(`Procesando proyecto ${index}:`, project?.name);
        if (project && project.name) {
            uniqueProjects.add(project.name);
        }
        if (project && project.tasks && Array.isArray(project.tasks)) {
            project.tasks.forEach((task, taskIndex) => {
                console.log(`  Tarea ${taskIndex}:`, task?.assignee);
                if (task && task.assignee) {
                    uniqueAssignees.add(task.assignee);
                }
            });
        }
    });

    console.log("Proyectos √∫nicos encontrados:", Array.from(uniqueProjects));
    console.log("Asignados √∫nicos encontrados:", Array.from(uniqueAssignees));

    // 5. Poblar selectores
    uniqueProjects.forEach(projectName => {
        const option = new Option(projectName, projectName);
        projectSelect.appendChild(option);
        console.log(`‚úÖ Proyecto agregado: ${projectName}`);
    });

    uniqueAssignees.forEach(assignee => {
        const option = new Option(assignee, assignee);
        assigneeSelect.appendChild(option);
        console.log(`‚úÖ Asignado agregado: ${assignee}`);
    });

    console.log("‚úÖ FILTROS POBLADOS CON DATOS REALES");
    console.groupEnd();
}

// === FUNCI√ìN AUXILIAR PROPUESTA ===
function initializeTimeTrackingOnDashboard() {
    console.log("=== Solicitando inicializaci√≥n de seguimiento de horas ===");

    // Intentar inmediatamente
    if (document.getElementById('timeTrackingProject') && document.getElementById('timeTrackingAssignee')) {
        console.log("Elementos del DOM encontrados, inicializando...");
        initTimeTrackingFilters(); // O la funci√≥n que realmente pobla tus filtros
        return;
    }

    // Si no est√°n, esperar un poco m√°s
    console.log("Elementos del DOM no encontrados, reintentando en 200ms...");
    setTimeout(() => {
        if (document.getElementById('timeTrackingProject') && document.getElementById('timeTrackingAssignee')) {
            console.log("Elementos del DOM encontrados en segundo intento, inicializando...");
            initTimeTrackingFilters(); // O la funci√≥n que realmente pobla tus filtros
        } else {
            console.error("‚ùå Elementos del DOM a√∫n no encontrados despu√©s de esperar. ¬øEst√° el contenido del dashboard cargado?");
        }
    }, 200);
}
// === FIN FUNCI√ìN AUXILIAR ===

// Aseg√∫rate de que esto est√© al final, o que se llame despu√©s de que se defina initializeTimeTrackingOnDashboard
// document.addEventListener('DOMContentLoaded', ... ) o window.onload = ...


function formatDate(dateString) {
  if (!dateString) return '--/--/--';
  const date = new Date(dateString);
  if (isNaN(date.getTime())) return '--/--/--';
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
}

function showTimeAllocationView() {
    console.log("Mostrando vista de Asignaci√≥n de Horas");
    // Ocultar otras vistas
    document.querySelectorAll('.view-content').forEach(view => view.classList.add('hidden'));
    // Mostrar esta vista
    document.getElementById('timeAllocationView').classList.remove('hidden');
    
    // Inicializar contenido
    initializeTimeAllocationView();
}

// Funci√≥n auxiliar para inicializar la vista (poblar filtros, etc.)
function initializeTimeAllocationView() {
    console.log("Inicializando vista de Asignaci√≥n de Horas...");
    populateTimeAllocationFilters();
    // Cargar datos iniciales (sin filtros)
    loadTimeAllocationData();
}

// === VISTA: Asignaci√≥n de Horas ===

// Funci√≥n auxiliar para obtener el nombre del mes
function getMonthName(monthNumber) {
    const months = [
        "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
        "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
    ];
    const index = parseInt(monthNumber, 10) - 1;
    return months[index] || "Desconocido";
}



let timeAllocationFiltersInitialized = false;

function populateTimeAllocationFilters() {
    // ‚õî EVITA QUE SE REPOBLEN LOS FILTROS
    if (timeAllocationFiltersInitialized) {
        console.log('‚è≠Ô∏è Filtros de Asignaci√≥n de Horas ya inicializados');
        return;
    }

    timeAllocationFiltersInitialized = true;

    console.log("üîÑ Poblando filtros de Asignaci√≥n de Horas...");

    
    // 1. Obtener elementos del DOM
    const yearSelect = document.getElementById('filterTimeAllocationYear');
    const monthSelect = document.getElementById('filterTimeAllocationMonth');
    const projectSelect = document.getElementById('filterTimeAllocationProject');
    const assigneeSelect = document.getElementById('filterTimeAllocationAssignee');

    // 2. Limpiar selectores
    if (yearSelect) yearSelect.innerHTML = '<option value="all">Todos</option>';
    if (monthSelect) monthSelect.innerHTML = '<option value="all">Todos</option>';
    if (projectSelect) projectSelect.innerHTML = '<option value="all">Todos</option>';
    if (assigneeSelect) assigneeSelect.innerHTML = '<option value="all">Todos</option>';

    // 3. Verificar datos globales
    if (!projects || !Array.isArray(projects) || projects.length === 0) {
  console.warn("‚õî safeSave cancelado: projects est√° vac√≠o o no cargado");
  return true;
}

if (currentProjectIndex === undefined || currentProjectIndex === null) {
  console.warn("‚õî safeSave cancelado: currentProjectIndex no est√° listo");
  return true;
}

    // 4. Recopilar valores √∫nicos
    const yearsSet = new Set();
    const monthsSet = new Set();
    const projectsSet = new Set();
    const assigneesSet = new Set();

    projects.forEach(project => {
        projectsSet.add(project.name);
        if (project.tasks && Array.isArray(project.tasks)) {
            project.tasks.forEach(task => {
                // Extraer a√±os y meses de las fechas de registro (timeLoggedEntries)
                if (task.timeLoggedEntries && Array.isArray(task.timeLoggedEntries)) {
                    task.timeLoggedEntries.forEach(entry => {
                        if (entry.date) {
                            const date = new Date(entry.date);
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0'); // Mes en formato MM
                            if (!isNaN(year)) yearsSet.add(year);
                            monthsSet.add(month);
                        }
                    });
                } else {
                    // Fallback si no hay timeLoggedEntries estructurados
                    const startDate = task.startDate ? new Date(task.startDate) : null;
                    const deadline = task.deadline ? new Date(task.deadline) : null;
                    if (startDate) {
                        const year = startDate.getFullYear();
                        const month = String(startDate.getMonth() + 1).padStart(2, '0');
                        if (!isNaN(year)) yearsSet.add(year);
                        monthsSet.add(month);
                    }
                    if (deadline) {
                        const year = deadline.getFullYear();
                        const month = String(deadline.getMonth() + 1).padStart(2, '0');
                        if (!isNaN(year)) yearsSet.add(year);
                        monthsSet.add(month);
                    }
                }

                if (task.assignee && task.assignee.trim() !== '') {
                    assigneesSet.add(task.assignee.trim());
                }
            });
        }
    });

    console.log("üìä Valores encontrados:", { years: Array.from(yearsSet), months: Array.from(monthsSet), projects: Array.from(projectsSet), assignees: Array.from(assigneesSet) });

    // 5. Poblar selectores
    // Poblar a√±os
    if (yearSelect && yearsSet.size > 0) {
        Array.from(yearsSet).sort((a, b) => b - a).forEach(year => {
            const option = new Option(year, year);
            yearSelect.appendChild(option);
            console.log(`‚úÖ A√±o agregado: ${year}`);
        });
    } else if (yearSelect) {
        console.log("‚ÑπÔ∏è No hay a√±os para agregar.");
    }

    // Poblar meses
    if (monthSelect && monthsSet.size > 0) {
        // Ordenar meses num√©ricamente antes de convertir a nombres
        const sortedMonths = Array.from(monthsSet).sort((a, b) => parseInt(a, 10) - parseInt(b, 10));
        sortedMonths.forEach(month => {
            const option = new Option(getMonthName(month), month);
            monthSelect.appendChild(option);
            console.log(`‚úÖ Mes agregado: ${getMonthName(month)} (${month})`);
        });
    } else if (monthSelect) {
        console.log("‚ÑπÔ∏è No hay meses para agregar.");
    }

    // Poblar proyectos
    if (projectSelect && projectsSet.size > 0) {
        Array.from(projectsSet).sort().forEach(projectName => {
            const option = new Option(projectName, projectName);
            projectSelect.appendChild(option);
            console.log(`‚úÖ Proyecto agregado: ${projectName}`);
        });
    } else if (projectSelect) {
        console.log("‚ÑπÔ∏è No hay proyectos para agregar.");
    }

    // Poblar asignados
    if (assigneeSelect && assigneesSet.size > 0) {
        Array.from(assigneesSet).sort().forEach(assignee => {
            const option = new Option(assignee, assignee);
            assigneeSelect.appendChild(option);
            console.log(`‚úÖ Asignado agregado: ${assignee}`);
        });
    } else if (assigneeSelect) {
        console.log("‚ÑπÔ∏è No hay asignados para agregar.");
    }

    console.log("‚úÖ Filtros de Asignaci√≥n de Horas poblados.");
}

// Funci√≥n para obtener filtros actuales
function getCurrentTimeAllocationFilters() {
    return {
        year: document.getElementById('filterTimeAllocationYear')?.value || 'all',
        month: document.getElementById('filterTimeAllocationMonth')?.value || 'all',
        project: document.getElementById('filterTimeAllocationProject')?.value || 'all',
        assignee: document.getElementById('filterTimeAllocationAssignee')?.value || 'all'
    };
}

// Funci√≥n para mostrar la vista (debe ser llamada cuando se muestra la vista)
function showTimeAllocationView() {
    console.log(" Mostrando vista de Asignaci√≥n de Horas");
    // Ocultar otras vistas
    document.querySelectorAll('.view-content').forEach(view => view.classList.add('hidden'));
    // Mostrar esta vista
    const viewElement = document.getElementById('timeAllocationView');
    if (viewElement) {
        viewElement.classList.remove('hidden');
        console.log("‚úÖ Vista de Asignaci√≥n de Horas mostrada.");
        
        // Inicializar contenido
        initializeTimeAllocationView();
    } else {
        console.error("‚ùå Elemento 'timeAllocationView' no encontrado en el DOM.");
    }
}

// Funci√≥n auxiliar para inicializar la vista
function initializeTimeAllocationView() {
    console.log("üîÑ Inicializando vista de Asignaci√≥n de Horas...");
    populateTimeAllocationFilters();
    // Cargar datos iniciales (sin filtros)
    loadTimeAllocationData();
}

// Funci√≥n para cargar y mostrar los datos
function loadTimeAllocationData() {
    console.log("üìä Cargando datos para el reporte de Asignaci√≥n de Horas...");
    const filters = getCurrentTimeAllocationFilters();
    console.log("üîç Filtros aplicados:", filters);

    // 1. Recopilar y procesar datos de todas las tareas de todos los proyectos
    let allTimeEntries = [];
    if (!projects || !Array.isArray(projects)) {
        console.warn("‚ö†Ô∏è Datos de proyectos no disponibles.");
        renderTimeAllocationTable([]);
        renderTimeAllocationChart([]);
        return;
    }

    projects.forEach(project => {
        const projectName = project.name;
        if (project.tasks && Array.isArray(project.tasks)) {
            project.tasks.forEach(task => {
                const assignee = task.assignee || 'Sin asignar';
                
                if (task.timeLoggedEntries && Array.isArray(task.timeLoggedEntries)) {
                    task.timeLoggedEntries.forEach(entry => {
                        if (entry.hours > 0) {
                            allTimeEntries.push({
                                projectName: projectName,
                                assignee: assignee,
                                date: entry.date ? new Date(entry.date) : new Date(),
                                hours: parseFloat(entry.hours) || 0
                            });
                        }
                    });
                } else if (task.timeLogged > 0) {
                    const fallbackDateStr = task.startDate || task.deadline || new Date().toISOString();
                    const fallbackDate = new Date(fallbackDateStr);
                    allTimeEntries.push({
                        projectName: projectName,
                        assignee: assignee,
                        date: fallbackDate,
                        hours: parseFloat(task.timeLogged) || 0
                    });
                }
            });
        }
    });

    console.log("üì• Entradas de tiempo recopiladas:", allTimeEntries);

    // 2. Filtrar datos
    const filteredData = allTimeEntries.filter(entry => {
        if (filters.year !== 'all' && entry.date.getFullYear() != filters.year) {
            return false;
        }
        if (filters.month !== 'all' && String(entry.date.getMonth() + 1).padStart(2, '0') !== filters.month) {
            return false;
        }
        if (filters.project !== 'all' && entry.projectName !== filters.project) {
            return false;
        }
        if (filters.assignee !== 'all' && entry.assignee !== filters.assignee) {
            return false;
        }
        return true;
    });

    console.log("üìä Datos filtrados:", filteredData);

    // 3. Agrupar y sumar por Asignado, Proyecto y Mes
    const groupedData = {};
    filteredData.forEach(entry => {
        const monthKey = `${entry.date.getFullYear()}-${String(entry.date.getMonth() + 1).padStart(2, '0')}`; // YYYY-MM
        const key = `${entry.assignee}|${entry.projectName}|${monthKey}`;

        if (!groupedData[key]) {
            groupedData[key] = {
                assignee: entry.assignee,
                projectName: entry.projectName,
                month: monthKey, // YYYY-MM
                monthName: entry.date.toLocaleString('es-ES', { month: 'long', year: 'numeric' }), // Ej: "enero 2024"
                totalHours: 0
            };
        }
        groupedData[key].totalHours += entry.hours;
    });

    const finalData = Object.values(groupedData);
    console.log("üßÆ Datos agrupados y sumados:", finalData);

// ‚õî Si no hay datos, a√∫n as√≠ renderizamos para mostrar mensajes vac√≠os
renderTimeAllocationTable(finalData);
renderTimeAllocationChart(finalData);


window.__lastTimeAllocationData = groupedData;
console.log('üß™ groupedData:', groupedData);





    // 4. Renderizar tabla y gr√°fico
    renderTimeAllocationTable(finalData);
    renderTimeAllocationChart(finalData);
}

function renderTimeAllocationTable(data) {
  const tbody = document.getElementById('timeAllocationTableBody');
  if (!tbody) {
    console.error("‚ùå Elemento 'timeAllocationTableBody' no encontrado.");
    return;
  }

  if (!Array.isArray(data) || data.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="4" style="text-align:center;">
          No hay datos para mostrar
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = data.map(item => `
    <tr>
      <td>${item.assignee ?? '-'}</td>
      <td>${item.projectName ?? item.project ?? '-'}</td>
      <td>${item.monthName ?? item.month ?? '-'}</td>
      <td>${(item.totalHours ?? item.hours ?? 0).toFixed(2)}</td>
    </tr>
  `).join('');

  console.log("‚úÖ Tabla de Asignaci√≥n de Horas actualizada.");
}

function renderTimeAllocationChart(data) {
    const canvas = document.getElementById('timeAllocationChart');

    if (!canvas) {
        console.warn("‚è≥ Canvas 'timeAllocationChart' no existe a√∫n.");
        return;
    }

    const ctx = canvas.getContext('2d');

    // üßπ Destruir gr√°fica previa si existe
    if (window.timeAllocationChartInstance) {
        window.timeAllocationChartInstance.destroy();
        window.timeAllocationChartInstance = null;
        console.log("üóëÔ∏è Instancia anterior de gr√°fico destruida.");
    }

    // üîí Validaci√≥n de datos
    if (!Array.isArray(data) || data.length === 0) {
        console.log("üì≠ No hay datos para mostrar en el gr√°fico.");

        // Opcional: limpiar visualmente el canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        return;
    }

    // üìä Preparar datos
    const assigneeHours = {};
    data.forEach(item => {
        if (!assigneeHours[item.assignee]) {
            assigneeHours[item.assignee] = 0;
        }
        assigneeHours[item.assignee] += item.totalHours;
    });

    const labels = Object.keys(assigneeHours);
    const chartData = Object.values(assigneeHours);

    // üìà Crear gr√°fica
    window.timeAllocationChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'Horas Totales Registradas',
                data: chartData,
                backgroundColor: 'rgba(52, 152, 219, 0.7)',
                borderColor: 'rgba(52, 152, 219, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Horas' }
                },
                x: {
                    title: { display: true, text: 'Asignado' }
                }
            },
            plugins: {
                legend: { position: 'top' },
                title: {
                    display: true,
                    text: 'Horas Totales por Asignado (Filtradas)'
                }
            }
        }
    });

    console.log("üìä Gr√°fica de Asignaci√≥n de Horas actualizada.");
}

function calculateProjectDatesFromTasks(project) {
    let earliestDate = null;
    let latestDate = null;

    project.tasks.forEach(task => {
        if (task.startDate && (!earliestDate || task.startDate < earliestDate)) {
            earliestDate = task.startDate;
        }
        if (task.deadline && (!latestDate || task.deadline > latestDate)) {
            latestDate = task.deadline;
        }
    });

    return { earliestDate, latestDate };
}


function updateMilestonesStatus() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    document.querySelectorAll('#milestonesList .milestone-item').forEach(item => {
        const dateStr = item.dataset.date;
        if (!dateStr) return;

        const milestoneDate = new Date(dateStr);
        milestoneDate.setHours(0, 0, 0, 0);

        // Limpiar clases anteriores
        item.classList.remove('upcoming', 'current', 'overdue');

        // Determinar nuevo estado
        if (milestoneDate < today) {
            item.classList.add('overdue');
        } else if (milestoneDate.toDateString() === today.toDateString()) {
            item.classList.add('current');
        } else {
            item.classList.add('upcoming');
        }
    });
}

// Ejecutar diariamente o al iniciar la aplicaci√≥n
setInterval(updateMilestonesStatus, 86400000); // Actualiza cada 24 horas
updateMilestonesStatus(); // Ejecutar inmediatamente al cargar


// Al final de tu archivo JS o en el DOMContentLoaded:
document.addEventListener('DOMContentLoaded', function() {
    // Configurar bot√≥n de agregar hito
    document.getElementById('addMilestoneBtn')?.addEventListener('click', function() {
        const name = prompt("Nombre del hito:");
        if (!name || name.trim() === "") return;

        const dateStr = prompt("Fecha del hito (YYYY-MM-DD):");
        if (!dateStr) return;

        if (!isValidDate(dateStr)) {
            showNotification("Formato de fecha inv√°lido. Use YYYY-MM-DD");
            return;
        }

        addMilestoneToList(name, dateStr);
        showNotification("Hito agregado correctamente");
    });

    // Actualizar estados cada 24 horas
    setInterval(updateMilestonesStatus, 86400000);
    updateMilestonesStatus(); // Ejecutar inmediatamente
});

// Funci√≥n de validaci√≥n de fecha (a√±adir si no existe)
function isValidDate(dateString) {
    const regEx = /^\d{4}-\d{2}-\d{2}$/;
    if (!dateString.match(regEx)) return false;
    const d = new Date(dateString);
    return !isNaN(d.getTime());
}

// ================== RESPALDO LOCAL A ARCHIVO JSON ==================

// Bot√≥n: Descargar respaldo
document.getElementById('backupToLocal')?.addEventListener('click', function () {
    try {
        // Obtener los proyectos actuales
        const projects = JSON.parse(localStorage.getItem('projects')) || [];

        // Si no hay proyectos, avisar
        if (projects.length === 0) {
            showNotification('No hay proyectos para respaldar');
            return;
        }

        // Crear un objeto con fecha de respaldo
        const backupData = {
            version: "1.0",
            backupDate: new Date().toISOString(),
            projects: projects
        };

        // Convertir a texto
        const dataStr = JSON.stringify(backupData, null, 2);

        // Crear un blob (archivo)
        const blob = new Blob([dataStr], { type: 'application/json' });

        // Crear una URL temporal
        const url = URL.createObjectURL(blob);

        // Crear un enlace y hacer clic para descargar
        const a = document.createElement('a');
        a.href = url;
        a.download = `proyectos-respaldo-${new Date().toISOString().split('T')[0]}.json`;
        a.click();

        // Liberar la URL
        URL.revokeObjectURL(url);

        // Mostrar mensaje
        document.getElementById('backupStatus').textContent = '‚úÖ Respaldo descargado';
        setTimeout(() => document.getElementById('backupStatus').textContent = '', 3000);
        showNotification('Respaldo guardado en tu dispositivo');

    } catch (err) {
        console.error('Error al crear respaldo:', err);
        document.getElementById('backupStatus').textContent = '‚ùå Error al respaldar';
        showNotification('Error al crear el respaldo');
    }
});

// Bot√≥n: Cargar desde archivo
document.getElementById('restoreFromLocal')?.addEventListener('click', function () {
    // Crear un input de tipo archivo
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';

    input.onchange = function (e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (event) {
            try {
                // Leer el contenido del archivo
                const data = JSON.parse(event.target.result);

                // Validar que tenga la estructura correcta
                if (!data.projects || !Array.isArray(data.projects)) {
                    throw new Error('Formato de archivo inv√°lido');
                }

                // Guardar en localStorage
                localStorage.setItem('projects', JSON.stringify(data.projects));

                // Actualizar la variable global
                window.projects = data.projects;

                // Mostrar mensaje
                document.getElementById('backupStatus').textContent = '‚úÖ Datos cargados';
                setTimeout(() => document.getElementById('backupStatus').textContent = '', 3000);
                showNotification(`‚úÖ ${data.projects.length} proyectos cargados`);

                // Recargar la vista actual
                location.reload();

            } catch (err) {
                console.error('Error al cargar archivo:', err);
                document.getElementById('backupStatus').textContent = '‚ùå Archivo inv√°lido';
                showNotification('‚ùå Error: Archivo no v√°lido');
            }
        };
        reader.readAsText(file);
    };

    // Simular clic en el input
    input.click();
});


// === GESTI√ìN DE PR√ìXIMOS HITOS ===

document.getElementById('addMilestoneBtn')?.addEventListener('click', addNewMilestone);

// Funci√≥n para agregar nuevo hito
function addNewMilestone() {
  const name = prompt("Nombre del hito:");
  if (!name || name.trim() === "") return;

  const dateStr = prompt("Fecha del hito (YYYY-MM-DD):");
  if (!dateStr) return;

  // Validar formato de fecha
  if (!isValidDate(dateStr)) {
    showNotification("Formato de fecha inv√°lido. Use YYYY-MM-DD");
    return;
  }

  addMilestoneToList(name, dateStr);
  saveMilestonesToLocalStorage();
}

// Funci√≥n para validar fecha
function isValidDate(dateString) {
  const regEx = /^\d{4}-\d{2}-\d{2}$/;
  if (!dateString.match(regEx)) return false;
  const d = new Date(dateString);
  return !isNaN(d.getTime());
}

// Funci√≥n para agregar hito a la lista
function addMilestoneToList(name, dateStr) {
  const milestonesList = document.getElementById('milestonesList');
  if (!milestonesList) return;

  const formattedDate = formatDateForDisplay(dateStr);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const milestoneDate = new Date(dateStr);
  milestoneDate.setHours(0, 0, 0, 0);

  const milestoneItem = document.createElement('div');
  let statusClass = 'upcoming';
  
  if (milestoneDate < today) {
    statusClass = 'overdue';
  } else if (milestoneDate.toDateString() === today.toDateString()) {
    statusClass = 'current';
  }

  milestoneItem.className = `milestone-item ${statusClass}`;
  milestoneItem.dataset.date = dateStr;
  
  milestoneItem.innerHTML = `
    <span class="milestone-date">${formattedDate}</span>
    <span class="milestone-name">${name}</span>
    <button class="milestone-remove" onclick="removeMilestone(this)">
      <i class="fas fa-trash-alt"></i>
    </button>
  `;

  milestonesList.appendChild(milestoneItem);
}

// Funci√≥n para formatear fecha para visualizaci√≥n
function formatDateForDisplay(dateStr) {
  const options = { year: 'numeric', month: 'short', day: 'numeric' };
  return new Date(dateStr).toLocaleDateString('es-ES', options);
}

// Funci√≥n para eliminar hito
function removeMilestone(button) {
  if (confirm("¬øEliminar este hito?")) {
    button.closest('.milestone-item').remove();
    saveMilestonesToLocalStorage();
    showNotification("Hito eliminado");
  }
}

// Guardar hitos en localStorage
function saveMilestonesToLocalStorage() {
  const milestones = [];
  document.querySelectorAll('#milestonesList .milestone-item').forEach(item => {
    milestones.push({
      name: item.querySelector('.milestone-name').textContent,
      date: item.dataset.date
    });
  });
  
  localStorage.setItem('projectMilestones', JSON.stringify(milestones));
}

// Cargar hitos desde localStorage
function loadMilestonesFromLocalStorage() {
  const savedMilestones = JSON.parse(localStorage.getItem('projectMilestones')) || [];
  const milestonesList = document.getElementById('milestonesList');
  
  if (milestonesList) {
    milestonesList.innerHTML = '';
    savedMilestones.forEach(milestone => {
      addMilestoneToList(milestone.name, milestone.date);
    });
  }
}

// Inicializar al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
  loadMilestonesFromLocalStorage();
  
  // Asegurar que el bot√≥n tenga el event listener
  const addBtn = document.getElementById('addMilestoneBtn');
  if (addBtn) {
    addBtn.addEventListener('click', addNewMilestone);
  }
});


function applyDashboardModeStyles(mode) {
  const dashboard = document.getElementById('dashboardView');
  if (!dashboard) return;

  dashboard.classList.remove('mode-agile', 'mode-traditional', 'mode-hybrid');
  dashboard.classList.add('mode-' + mode);

// === A√ëADE ESTA L√çNEA ===
  highlightRelevantSections(mode);
  // =========================

  
  // Actualizar indicador visual
  const modeIndicator = document.getElementById('modeIndicator');
  const modeText = document.getElementById('currentModeText');
  
  if (modeIndicator && modeText) {
    const modeNames = {
      'agile': '√Ågil',
      'traditional': 'Tradicional',
      'hybrid': 'H√≠brido'
    };
    
    modeIndicator.style.display = 'block';
    modeIndicator.className = `mode-indicator ${mode}`;
    modeText.textContent = modeNames[mode];
  }
}


document.addEventListener('DOMContentLoaded', function () {
  // ==== PRIMERO: Inicializaci√≥n del sistema ====
  // Inicializa el manager de metodolog√≠as
  window.methodologyManager = new MethodologyManager();

  // ==== SEGUNDO: Configuraci√≥n del seguimiento de horas ====
  // Configurar event listener para el bot√≥n de aplicar filtros de seguimiento de horas
  const applyButton = document.getElementById('applyTimeTrackingFilters');
  if (applyButton) {
    applyButton.addEventListener('click', function () {
      console.log("üñ±Ô∏è Bot√≥n 'Aplicar' de seguimiento de horas clickeado.");

      // Verificar que las variables globales est√©n disponibles
      if (typeof projects === 'undefined' || typeof currentProjectIndex === 'undefined' || !projects[currentProjectIndex]) {
        console.warn("‚ö†Ô∏è No se puede aplicar filtro: proyecto no disponible.");
        updateTimeTrackingTable([]);
        updateTimeTrackingChart([]);
        return;
      }

      const project = projects[currentProjectIndex];
      const projectName = project.name || `Proyecto ${currentProjectIndex + 1}`;

      // 1. Recalcular datos (por si han cambiado)
      const timeTrackingData = calculateTimeTrackingData(project.tasks, projectName);
      console.log("üìä Datos de seguimiento calculados:", timeTrackingData);
      // Poblar filtros
      populateTimeTrackingFilters(timeTrackingData);
      // ...

      // 2. Obtener filtros actuales
      const filters = getCurrentTimeTrackingFilters();
      console.log("üîç Filtros aplicados:", filters);

      // 3. Filtrar datos
      const filteredData = filterTimeTrackingData(timeTrackingData, filters);

      // 4. Actualizar vista
      updateTimeTrackingTable(filteredData);
      updateTimeTrackingChart(filteredData);

      console.log("‚úÖ Filtros de seguimiento de horas aplicados.");
    });
  } else {
    console.warn("‚ö†Ô∏è Bot√≥n 'applyTimeTrackingFilters' no encontrado en el DOM al cargar.");
  }

  // Poblar din√°micamente el selector de meses si existe
  const monthSelect = document.getElementById('timeTrackingMonth');
  if (monthSelect) {
    // Limpiar opciones existentes excepto "Todos"
    monthSelect.innerHTML = '<option value="all">Todos</option>';

    // Agregar meses del 1 al 12
    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
      "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    for (let i = 1; i <= 12; i++) {
      const option = document.createElement('option');
      option.value = i.toString(); // Usar string para facilitar comparaci√≥n
      option.textContent = `${i.toString().padStart(2, '0')} - ${monthNames[i - 1]}`;
      monthSelect.appendChild(option);
    }
    console.log("üìÖ Selector de meses poblado.");
  }

  // ==== TERCERO: Configuraci√≥n del Gantt Ejecutivo ====
  /**************************************
   * FUNCI√ìN PARA MOSTRAR GANTT COMO VISTA *
   **************************************/
  window.showExecutiveGantt = function() {
    // üîí PROTECCI√ìN POR LICENCIA: solo Profesional/Premium pueden usar el Gantt Ejecutivo
    const userPlan = localStorage.getItem('userPlan');
if (userPlan !== 'professional' && userPlan !== 'premium') {
  showNotification('üîí El Gantt Ejecutivo est√° disponible en los planes Profesional o Premium.');
  return;
}

    console.log('üöÄ Mostrando Gantt Ejecutivo como vista principal...');

    // 1. Ocultar todas las otras vistas (busca los ID de tus vistas)
    const viewsToHide = [
      'kanban-container', 'list-view', 'calendar-view',
      'dashboard', 'projects-container', 'tasks-container'
    ];

    // Primero intentar por ID
    viewsToHide.forEach(viewId => {
      const view = document.getElementById(viewId);
      if (view) {
        view.style.display = 'none';
        console.log(`üëÅÔ∏è Ocultando vista: ${viewId}`);
      }
    });

    // 2. Tambi√©n ocultar por clases comunes
    document.querySelectorAll('.kanban-container, .list-container, .calendar-container, .dashboard-container').forEach(view => {
      if (view) {
        view.style.display = 'none';
      }
    });

    // 3. Eliminar cualquier Gantt anterior
    const oldGantt = document.getElementById('premiumExecutiveGantt');
    if (oldGantt) {
      oldGantt.remove();
      console.log('üóëÔ∏è Gantt anterior removido');
    }

    // 4. Eliminar cualquier overlay/backdrop
    const overlays = document.querySelectorAll('.executive-overlay');
    overlays.forEach(overlay => {
      overlay.remove();
    });

    // 5. Asegurar que body tenga espacio para el Gantt
    document.body.style.overflow = 'hidden';

    // 6. Crear el Gantt ejecutivo
    if (typeof createCompleteGanttForCurrentProject === 'function') {
      createCompleteGanttForCurrentProject();
      console.log('‚úÖ Gantt Ejecutivo creado como vista principal');
    } else {
      console.error('‚ùå Error: No se encontr√≥ la funci√≥n createCompleteGanttForCurrentProject');
      alert('Error al cargar el Gantt Ejecutivo. Recarga la p√°gina e intenta de nuevo.');
    }
  };

  // Hacer la funci√≥n disponible globalmente
  console.log('‚úÖ Funci√≥n showExecutiveGantt() cargada. Usa: showExecutiveGantt()');

  // === AQU√ç VA EL EVENTO DEL SELECTOR ===
  const selector = document.getElementById('methodologySelector');
  if (selector) {
    selector.addEventListener('change', function () {
      const mode = this.value;
      window.methodologyManager.setMode(mode);
      applyDashboardModeStyles(mode); // Aplica estilos visuales
      addModeTooltips(mode); // üëà A√±adido
      updateModeIndicator(mode); // üëà A√±ade esta l√≠nea
      updateModeHelpText(mode);
      updateDashboardTitle(mode);
    });
  }

  // Aplica el modo guardado
  window.methodologyManager.setMode(window.methodologyManager.currentMode);

  // Aseg√∫rate de que el dashboard est√© visible
  setTimeout(() => {
    highlightRelevantSections(window.methodologyManager.currentMode);
  }, 100);

  // ==== CUARTO: Inicializaci√≥n del dashboard (segura) ====
  try {
    if (typeof loadDashboardProjectData === 'function') loadDashboardProjectData();
    if (typeof alignDashboardRow3Cards === 'function') alignDashboardRow3Cards();
    if (typeof updateProjectHealthStatus === 'function') updateProjectHealthStatus();
    if (typeof updateMilestones === 'function') updateMilestones();
    if (typeof updateRequiredActions === 'function') updateRequiredActions();
    if (typeof updateStatistics === 'function') updateStatistics();
    if (typeof getStats === 'function' && typeof generatePieChart === 'function') {
      generatePieChart(getStats());
    }
    if (typeof updateResourceAllocation === 'function') updateResourceAllocation();
    if (typeof updateProjectTimeline === 'function') updateProjectTimeline();
    if (typeof updateProjectDatesFromTasks === 'function') updateProjectDatesFromTasks();
    if (typeof updateRisksCount === 'function') updateRisksCount();
    
    const currentMode = window.methodologyManager.getCurrentMode();
    if (typeof applyDashboardModeStyles === 'function') {
      applyDashboardModeStyles(currentMode);
    }
    if (typeof applyDetailedModeStyles === 'function') {
      applyDetailedModeStyles(currentMode);
    }
  } catch (error) {
    console.warn('‚ö†Ô∏è Error al inicializar el dashboard:', error);
  }
});

// === ACTUALIZAR INDICADOR DE MODO ===
function updateModeIndicator(mode) {
  const indicator = document.getElementById('modeIndicator');
  const icon = indicator.querySelector('i');
  const modeText = document.getElementById('currentModeText');
  
  if (!indicator || !icon || !modeText) return;

  // Resetear clases
  indicator.classList.remove('mode-indicator-agile', 'mode-indicator-traditional', 'mode-indicator-hybrid');

  // Configurar icono y texto por modo
  const config = {
    agile: {
      icon: 'fa-bolt',
      text: '√Ågil',
      class: 'mode-indicator-agile'
    },
    traditional: {
      icon: 'fa-tasks',
      text: 'Tradicional',
      class: 'mode-indicator-traditional'
    },
    hybrid: {
      icon: 'fa-sync-alt',
      text: 'H√≠brido',
      class: 'mode-indicator-hybrid'
    }
  };

  const c = config[mode];
  icon.className = 'fas ' + c.icon;
  modeText.textContent = c.text;
  indicator.classList.add(c.class);
}


// === ACTUALIZAR MENSAJE DE AYUDA POR MODO ===
function updateModeHelpText(mode) {
  const helpText = document.getElementById('modeHelpMessage');
  if (!helpText) return;

  const messages = {
    agile: "En modo √Ågil, el enfoque est√° en lo completado: tareas finalizadas y tiempo registrado.",
    traditional: "En modo Tradicional, el enfoque est√° en el control: tareas rezagadas y tiempo restante.",
    hybrid: "En modo H√≠brido, se muestra una visi√≥n completa: avance, riesgos y control de tiempo."
  };

  helpText.textContent = messages[mode];

  // Cambiar color del borde seg√∫n el modo
  const panel = document.querySelector('.mode-help-text');
  if (mode === 'agile') {
    panel.style.borderLeftColor = '#4caf50'; // Verde
  } else if (mode === 'traditional') {
    panel.style.borderLeftColor = '#2196f3'; // Azul
  } else {
    panel.style.borderLeftColor = '#9c27b0'; // Morado
  }
}


// === ACTUALIZAR T√çTULO DIN√ÅMICO POR MODO ===
function updateDashboardTitle(mode) {
  const title = document.getElementById('dashboardTitle');
  if (!title) return;

  const titles = {
    agile: {
      main: 'üöÄ Avance del Proyecto',
      sub: 'Enfocado en entregas y productividad'
    },
    traditional: {
      main: 'üìÖ Control del Proyecto',
      sub: 'Enfocado en cronograma y riesgos'
    },
    hybrid: {
      main: 'üîÅ Vista Completa del Proyecto',
      sub: 'Combina avance y control'
    }
  };

  const t = titles[mode];
  title.innerHTML = `<strong>${t.main}</strong><br><small>${t.sub}</small>`;
}


// === CREAR Y MOSTRAR TOOLTIPS DIN√ÅMICOS ===
function addModeTooltips(mode) {
  // Definir mensajes por modo
  const tooltips = {
    agile: {
      '#completedTasksMetric': 'En modo √Ågil, el progreso se mide por lo completado: tareas finalizadas.',
      '#totalLoggedDash': 'El tiempo registrado muestra productividad real del equipo.',
      '#tasksDistributionChart': 'Muestra balance entre tareas pendientes, en progreso y completadas.'
    },
    traditional: {
      '#overdueTasksMetric': 'Las tareas rezagadas indican riesgos de cronograma.',
      '#remainingTimeDash': 'El tiempo restante es clave para cumplir el plan original.',
      '#tasksDistributionChart': 'Muestra avance frente al plan establecido.'
    },
    hybrid: {
     '#completedTasksMetric': 'Parte del enfoque en productividad (√Ågil)',
      '#overdueTasksMetric': 'Parte del enfoque en control de riesgos (Tradicional).',
      '#tasksDistributionChart': 'Visi√≥n general del estado del proyecto.'
    }
  };

  // Limpiar tooltips anteriores
  document.querySelectorAll('.tooltip').forEach(t => t.remove());

  // Agregar tooltips seg√∫n el modo
  Object.keys(tooltips[mode]).forEach(selector => {
    const element = document.querySelector(selector);
    if (!element) return;

    // Crear tooltip
    const tooltip = document.createElement('div');
tooltip.className = 'gantt-dependency-tooltip';
tooltip.style.position = 'fixed';
tooltip.style.pointerEvents = 'none';
tooltip.style.zIndex = '99999';
tooltip.style.background = '#fff';
tooltip.style.padding = '8px 12px';
tooltip.style.borderRadius = '6px';
tooltip.style.boxShadow = '0 4px 10px rgba(0,0,0,0.15)';
tooltip.style.fontSize = '12px';
tooltip.style.color = '#2c3e50';
tooltip.style.transition = 'opacity 0.2s ease';
tooltip.style.opacity = '0';

document.body.appendChild(tooltip);











    // Mostrar al pasar el mouse
    element.addEventListener('mouseenter', (e) => {
      document.body.appendChild(tooltip);
      const rect = element.getBoundingClientRect();
      tooltip.style.top = `${rect.top - tooltip.offsetHeight - 10}px`;
      tooltip.style.left = `${rect.left + rect.width / 2}px`;
      tooltip.style.transform = 'translateX(-50%)';
      tooltip.style.opacity = '1';
    });

    // Ocultar al salir
    element.addEventListener('mouseleave', () => {
      tooltip.style.opacity = '0';
      setTimeout(() => tooltip.remove(), 300);
    });
  });
}


/**************************************
 * SISTEMA COMPLETO DE PERSISTENCIA *
 **************************************/

// Funci√≥n para sincronizar con backend cada 30 segundos
function startAutoSync() {
    setInterval(async () => {
        if (useBackend) {
            try {
                await safeSave();
                console.log('üîÑ Auto-sincronizaci√≥n completada');
            } catch (error) {
                console.warn('‚ö†Ô∏è Error en auto-sincronizaci√≥n:', error.message);
            }
        }
    }, 30000); // 30 segundos
}

// Funci√≥n para forzar sincronizaci√≥n manual
async function forceSync() {
    console.group('üîÑ SINCRONIZACI√ìN MANUAL');
    const success = await safeSave();
    if (success) {
        showNotification('‚úÖ Datos sincronizados correctamente');
    } else {
        showNotification('‚ö†Ô∏è Sincronizaci√≥n fallida, usando modo local');
    }
    console.groupEnd();
}

// Funci√≥n para verificar estado de conexi√≥n
function checkConnectionStatus() {
    console.group('üì° ESTADO DE CONEXI√ìN');
    console.log('üîó Backend:', useBackend ? '‚úÖ Conectado' : '‚ùå Desconectado');
    console.log('üíæ localStorage:', '‚úÖ Siempre disponible');
    console.log('üì¶ Proyectos en memoria:', projects.length);
    console.log('üîÑ √öltima sincronizaci√≥n:', new Date().toLocaleTimeString());
    console.groupEnd();
    
    return useBackend;
}

// Agregar bot√≥n de sincronizaci√≥n manual si no existe
function addSyncButton() {
    // Verificar si ya existe el bot√≥n
    if (document.getElementById('syncButton')) return;
    
    // Crear bot√≥n de sincronizaci√≥n
    const syncButton = document.createElement('button');
    syncButton.id = 'syncButton';
    syncButton.innerHTML = 'üîÑ Sincronizar';
    syncButton.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        padding: 10px 15px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
    `;
    syncButton.onclick = forceSync;
    
    document.body.appendChild(syncButton);
    console.log('‚úÖ Bot√≥n de sincronizaci√≥n agregado');
}

// Iniciar todo el sistema de persistencia
function initPersistenceSystem() {
    console.group('üöÄ INICIANDO SISTEMA DE PERSISTENCIA');
    
    // 1. Agregar bot√≥n de sincronizaci√≥n
    addSyncButton();
    
    // 2. Iniciar auto-sincronizaci√≥n
    startAutoSync();
    
    // 3. Verificar estado inicial
    checkConnectionStatus();
    
    console.log('‚úÖ Sistema de persistencia completamente operativo');
    console.groupEnd();
}
// === LISTENER GLOBAL PARA EL BOT√ìN DE MEN√ö (funciona siempre) ===
document.addEventListener('DOMContentLoaded', () => {
  const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
  const sidebar = document.querySelector('aside');

  if (toggleSidebarBtn && sidebar) {
    toggleSidebarBtn.addEventListener('click', () => {
      sidebar.classList.toggle('hidden');
    });
  }
 // enableGlobalFilterAutoUpdate();
});


// REEMPLAZA la funci√≥n original con esta versi√≥n corregida
function populateTaskDependenciesSelect(excludeTaskId = null) {
  console.log('üîß populateTaskDependenciesSelect - VERSI√ìN ACTUALIZADA');
  
  // ‚úÖ CORREGIR IDs - usar los IDs correctos del HTML
  const itemsDiv = document.getElementById('taskDependenciesItems');
  const header = document.getElementById('taskDependenciesHeader');
  const selectedDiv = document.getElementById('selectedDependencies');
  
  if (!itemsDiv || !header) {
    console.error('‚ùå Elementos del selector no encontrados:', {
      itemsDiv: !!itemsDiv,
      header: !!header,
      selectedDiv: !!selectedDiv
    });
    return;
  }

  console.log('‚úÖ Elementos encontrados, procediendo...');

  // Limpiar solo las opciones, no el contenedor completo
  itemsDiv.innerHTML = '';

  // ‚úÖ CORRECCI√ìN: Usar window.projects en lugar de projects
  const project = window.projects[window.currentProjectIndex];
  if (!project || !project.tasks) {
    console.warn('‚ö†Ô∏è No hay proyecto o tareas disponibles');
    
    // Mostrar mensaje de "no hay opciones"
    const noOptions = document.createElement('div');
    noOptions.className = 'no-options';
    noOptions.textContent = 'No hay tareas disponibles para dependencias';
    noOptions.style.cssText = `
      padding: 12px;
      text-align: center;
      color: #666;
      font-style: italic;
    `;
    itemsDiv.appendChild(noOptions);
    return;
  }

  console.log(`üìã Proyecto: "${project.name}", Tareas: ${project.tasks.length}`);

  let addedCount = 0;
  
  // Mostrar opciones
  project.tasks.forEach(task => {
    if (task.id === excludeTaskId) {
      console.log(`‚Ü© Saltando tarea actual: "${task.name}" (ID: ${task.id})`);
      return;
    }

    const option = document.createElement('div');
    option.className = 'dependency-option';
    option.textContent = task.name;
    option.dataset.id = task.id;
    option.title = `ID: ${task.id} | Estado: ${task.status || 'No definido'}`;
    
    // üî• ESTILOS INLINE PARA GARANTIZAR VISIBILIDAD
    option.style.cssText = `
      padding: 8px 12px;
      cursor: pointer;
      transition: background 0.2s;
      display: block;
      visibility: visible;
      opacity: 1;
      color: #333;
      font-size: 14px;
      border-bottom: 1px solid #f0f0f0;
      font-family: inherit;
    `;
    
    option.addEventListener('mouseenter', () => {
      if (!option.classList.contains('selected')) {
        option.style.background = '#f5f5f5';
      }
    });
    
    option.addEventListener('mouseleave', () => {
      if (!option.classList.contains('selected')) {
        option.style.background = '';
      }
    });
    
    option.addEventListener('click', function(e) {
      e.stopPropagation();
      
      // Alternar selecci√≥n
      this.classList.toggle('selected');
      
      // Actualizar estilos visuales
      if (this.classList.contains('selected')) {
        this.style.background = '#e8f4ff';
        this.style.color = '#4a90e2';
        this.style.fontWeight = '500';
      } else {
        this.style.background = '';
        this.style.color = '#333';
        this.style.fontWeight = '';
      }
      
      console.log(`‚úÖ ${this.classList.contains('selected') ? 'Seleccionada' : 'Deseleccionada'}: "${task.name}"`);
      
      // Actualizar vista de selecci√≥n
      updateSelectedDependenciesView();
    });
    
    itemsDiv.appendChild(option);
    addedCount++;
  });

  // Si no se agregaron opciones, mostrar mensaje
  if (addedCount === 0) {
    const noOptions = document.createElement('div');
    noOptions.className = 'no-options';
    noOptions.textContent = 'No hay otras tareas disponibles';
    noOptions.style.cssText = `
      padding: 12px;
      text-align: center;
      color: #666;
      font-style: italic;
    `;
    itemsDiv.appendChild(noOptions);
  }

  console.log(`‚úÖ ${addedCount} opciones agregadas`);
  
  // NO manejar la apertura/cierre aqu√≠ - eso lo hace setupDependenciesSelector()
  // Solo asegurar que el dropdown est√© cerrado inicialmente
  itemsDiv.style.display = 'none';
  
  // Si hay una funci√≥n updateSelectedDependenciesView, llamarla para limpiar
  if (typeof updateSelectedDependenciesView === 'function') {
    setTimeout(updateSelectedDependenciesView, 50);
  }







}function updateSelectedDependenciesView() {
  const selectedDiv = document.getElementById('taskDependenciesSelected');
  const items = document.querySelectorAll('#taskDependenciesItems div.selected');
  
  if (items.length === 0) {
    selectedDiv.innerHTML = '-- Seleccione tareas predecesoras --';
  } else {
    selectedDiv.innerHTML = '';
    items.forEach(item => {
      const tag = document.createElement('span');
      tag.className = 'select-item-tag';
      tag.textContent = item.textContent;
      selectedDiv.appendChild(tag);
    });
  }
}



/**
 * Obtiene la posici√≥n y tama√±o de la barra de la tarea dentro de su fila.
 * @param {HTMLElement} taskRow - El elemento <div> de la fila de la tarea.
 * @returns {Object|null} Objeto con propiedades top, left, width, height o null si falla.
 */
function getTaskBarPosition(taskRow) {
    const taskBar = taskRow.querySelector('.gantt-bar');
    if (!taskBar) return null;
    
    const ganttContainer = document.getElementById('ganttContainer');
    if (!ganttContainer) return null;
    
    const barRect = taskBar.getBoundingClientRect();
    const containerRect = ganttContainer.getBoundingClientRect();
    
    return {
        left: barRect.left - containerRect.left,
        right: barRect.right - containerRect.left,
        top: barRect.top - containerRect.top + (barRect.height / 2),
        bottom: barRect.bottom - containerRect.top
    };
}
/**
 * Dibuja una l√≠nea de dependencia entre dos puntos.
 * @param {Object} startRect - Posici√≥n y tama√±o del punto de inicio.
 * @param {Object} endRect - Posici√≥n y tama√±o del punto de fin.
 * @param {number} taskId - ID de la tarea actual.
 * @param {number} depId - ID de la tarea predecesora.
 */


// === FUNCI√ìN MEJORADA PARA DIBUJAR L√çNEAS ===
function drawDependencyLine(startRect, endRect, taskId, depId) {
    const ganttContainer = document.getElementById('ganttContainer');
    if (!ganttContainer) return;
    
    // Crear contenedor de l√≠neas si no existe
    let linesContainer = ganttContainer.querySelector('.dependency-lines-container');
    if (!linesContainer) {
        linesContainer = document.createElement('div');
        linesContainer.className = 'dependency-lines-container';
        linesContainer.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        `;
        ganttContainer.style.position = 'relative';
        ganttContainer.appendChild(linesContainer);
    }
    
    // Coordenadas relativas al contenedor Gantt
    const x1 = startRect.right;   // Fin de la tarea predecesora
    const y1 = startRect.top;     // Mitad vertical de la barra predecesora
    const x2 = endRect.left;      // Inicio de la tarea dependiente
    const y2 = endRect.top;       // Mitad vertical de la barra dependiente
    
    // Calcular longitud y √°ngulo
    const length = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
    const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
    
    // Crear l√≠nea
    const line = document.createElement('div');
    line.className = 'dependency-line';
    line.dataset.from = depId;
    line.dataset.to = taskId;
    line.style.cssText = `
        position: absolute;
        width: ${length}px;
        height: 2px;
        background-color: #3498db;
        transform-origin: 0 0;
        transform: rotate(${angle}deg);
        left: ${x1}px;
        top: ${y1}px;
        z-index: 11;
    `;
    
    // Flecha
    const arrow = document.createElement('div');
    arrow.style.cssText = `
        position: absolute;
        width: 0;
        height: 0;
        border-top: 4px solid transparent;
        border-bottom: 4px solid transparent;
        border-left: 6px solid #3498db;
        left: ${length - 6}px;
        top: -4px;
    `;
    line.appendChild(arrow);
    
    linesContainer.appendChild(line);
}

// === AGREGAR ESTILOS CSS (si no los tienes) ===
// A√±ade esto a tu CSS o crea una funci√≥n para inyectar los estilos
function injectDependencyStyles() {
    if (document.getElementById('dependency-styles')) return;
    
    const style = document.createElement('style');
    style.id = 'dependency-styles';
    style.textContent = `
        .dependency-line {
            transition: all 0.3s ease;
        }
        .dependency-line:hover {
            background-color: #e74c3c;
            height: 3px;
        }
        .dependency-line:hover + .dependency-arrow {
            border-left-color: #e74c3c;
        }
    `;
    document.head.appendChild(style);
}

// Llamar la funci√≥n de inyecci√≥n de estilos al inicializar
document.addEventListener('DOMContentLoaded', injectDependencyStyles);




function fixDependencyLinesCSS() {
    const style = document.createElement('style');
    style.textContent = `
        .gantt-container {
            position: relative !important;
            overflow: visible !important;
        }
        .dependency-lines-container {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            pointer-events: none !important;
            z-index: 10 !important;
            transform: none !important;
        }
        .dependency-line {
            position: absolute !important;
            background-color: #3498db !important;
            height: 2px !important;
            z-index: 11 !important;
            transform-origin: 0 0 !important;
        }
    `;
    document.head.appendChild(style);
}

// Ejecutar cuando cargue la p√°gina
document.addEventListener('DOMContentLoaded', fixDependencyLinesCSS);


// Funci√≥n adicional para recalcular posiciones de l√≠neas
function recalculateDependencyLines() {
    const linesContainer = document.querySelector('.dependency-lines-container');
    if (!linesContainer) return;
    
    // Remover transformaciones existentes
    linesContainer.style.transform = 'none';
    
    // Recalcular posici√≥n basada en el estado actual del sidebar
    const sidebar = document.querySelector('aside');
    const isSidebarHidden = sidebar.classList.contains('hidden');
    
    if (!isSidebarHidden) {
        const sidebarWidth = sidebar.offsetWidth;
        linesContainer.style.transform = `translateX(${sidebarWidth}px)`;
    }
}



// üöÄ PROJECT ENHANCER - VERSI√ìN DEFINITIVA SEGURA
(function () {
    'use strict';

    if (window._projectEnhancerLoaded) return;
    window._projectEnhancerLoaded = true;

    console.log('üöÄ Project Enhancer Definitivo - Cargado');

    // =============== PROTECCI√ìN DE BOTONES (CR√çTICO) ===============
    function protectActionButtons() {
        const style = document.createElement('style');
        style.id = 'button-protection-final';
        style.textContent = `
            /* GARANTIZAR que los botones SIEMPRE funcionen */
            .move-up-btn, .move-down-btn, 
            .task-context-menu-item.delete {
                pointer-events: auto !important;
                transform: none !important;
                z-index: 10000 !important;
                position: relative !important;
                cursor: pointer !important;
            }
            
            /* Las tarjetas NO deben bloquear clics */
            .task-card, .kanban-task, .task-item {
                pointer-events: none !important;
            }
            
            /* Pero los botones dentro S√ç deben ser clickeables */
            .task-card > *, .kanban-task > *, .task-item > * {
                pointer-events: auto !important;
            }
        `;
        document.head.appendChild(style);
    }

    // =============== REALIDAD AUMENTADA ===============
    function initARSystem() {
        if (window.projectAR) return;

        window.projectAR = {
            addARButtonToModal: function (modal) {
                const footers = modal.querySelectorAll('.task-details-footer');
                if (footers.length === 0) return;

                document.querySelectorAll('.project-ar-button').forEach(btn => btn.remove());

                const footer = footers[0];
                const btn = document.createElement('button');
                btn.className = 'project-ar-button';
                btn.textContent = 'üéØ Ver en Realidad Aumentada';
                btn.style.cssText = `
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white; border: none; padding: 12px 20px; border-radius: 8px;
                    cursor: pointer; margin: 10px 5px; font-weight: bold; font-size: 14px;
                    transition: transform 0.2s, box-shadow 0.2s;
                `;
                btn.onmouseenter = () => {
                    btn.style.transform = 'translateY(-2px)';
                    btn.style.boxShadow = '0 5px 15px rgba(102, 126, 234, 0.6)';
                };
                btn.onmouseleave = () => {
                    btn.style.transform = 'none';
                    btn.style.boxShadow = 'none';
                };

                btn.onclick = () => {
                    const allH3 = modal.querySelectorAll('h3');
                    let name = null;
                    for (const h3 of allH3) {
                        const t = h3.textContent?.trim();
                        if (t && t !== 'Detalles de la Tarea') {
                            name = t;
                            break;
                        }
                    }
                    if (!name) {
                        alert('No se pudo cargar la tarea');
                        return;
                    }

                    const assignee = modal.querySelector('#editTaskAssignee')?.value?.trim() || 'No asignado';
                    const estimated = parseFloat(modal.querySelector('#editTaskEstimatedHours')?.value) || 0;

                    let timeLogged = 0;
                    const timeLoggedEl = Array.from(modal.querySelectorAll('label')).find(l => l.textContent.includes('Tiempo Registrado'))?.nextElementSibling;
                    if (timeLoggedEl) {
                        const text = timeLoggedEl.textContent?.trim();
                        if (text) {
                            const match = text.match(/(\d+(\.\d+)?)/);
                            if (match) timeLogged = parseFloat(match[1]);
                        }
                    }

                    const startDateInput = modal.querySelector('#editTaskStartDate');
                    const deadlineInput = modal.querySelector('#editTaskDeadline');
                    const start = startDateInput?.value || '';
                    const deadline = deadlineInput?.value || '';

                    let desc = '';
                    const desc1 = modal.querySelector('#editTaskDescription');
                    if (desc1 && desc1.value?.trim()) {
                        desc = desc1.value.trim();
                    } else {
                        const desc2 = modal.querySelector('.task-description, .description-field, textarea');
                        if (desc2 && desc2.value?.trim()) {
                            desc = desc2.value.trim();
                        } else {
                            const desc3 = modal.querySelector('textarea');
                            if (desc3 && desc3.value?.trim()) {
                                desc = desc3.value.trim();
                            } else {
                                const descLabel = Array.from(modal.querySelectorAll('label')).find(l => 
                                    l.textContent.toLowerCase().includes('descrip')
                                );
                                if (descLabel) {
                                    const sibling = descLabel.nextElementSibling;
                                    if (sibling && sibling.textContent?.trim()) {
                                        desc = sibling.textContent.trim();
                                    }
                                }
                            }
                        }
                    }

                    const statusBadge = modal.querySelector('.status-badge');
                    const priorityBadge = modal.querySelector('.priority-badge');

                    let statusText = 'Sin estado';
                    let statusColor = '#9e9e9e';
                    let priorityText = 'Sin prioridad';
                    let priorityColor = '#9e9e9e';

                    if (statusBadge) {
                        statusText = statusBadge.textContent.trim() || 'Sin estado';
                        const badgeStyle = window.getComputedStyle(statusBadge);
                        let bgColor = badgeStyle.backgroundColor;
                        if (bgColor === 'rgba(0, 0, 0, 0)' || bgColor === 'transparent') {
                            bgColor = badgeStyle.color;
                        }
                        if (bgColor.startsWith('rgb')) {
                            const rgb = bgColor.match(/\d+/g);
                            if (rgb && rgb.length >= 3) {
                                statusColor = `#${parseInt(rgb[0]).toString(16).padStart(2, '0')}${parseInt(rgb[1]).toString(16).padStart(2, '0')}${parseInt(rgb[2]).toString(16).padStart(2, '0')}`;
                            } else {
                                statusColor = '#ff9800';
                            }
                        } else {
                            statusColor = bgColor;
                        }
                    }

                    if (priorityBadge) {
                        priorityText = priorityBadge.textContent.trim() || 'Sin prioridad';
                        const badgeStyle = window.getComputedStyle(priorityBadge);
                        let bgColor = badgeStyle.backgroundColor;
                        if (bgColor === 'rgba(0, 0, 0, 0)' || bgColor === 'transparent') {
                            bgColor = badgeStyle.color;
                        }
                        if (bgColor.startsWith('rgb')) {
                            const rgb = bgColor.match(/\d+/g);
                            if (rgb && rgb.length >= 3) {
                                priorityColor = `#${parseInt(rgb[0]).toString(16).padStart(2, '0')}${parseInt(rgb[1]).toString(16).padStart(2, '0')}${parseInt(rgb[2]).toString(16).padStart(2, '0')}`;
                            } else {
                                priorityColor = '#2196f3';
                            }
                        } else {
                            priorityColor = bgColor;
                        }
                    }

                    let progressText = '';
                    const progressEl = modal.querySelector('.progress-percentage, .task-progress, [class*="progress"]');
                    if (progressEl) {
                        const pText = progressEl.textContent?.trim();
                        if (pText && /\d+%/.test(pText)) {
                            progressText = pText;
                        }
                    }

                    const today = new Date();
                    const deadlineDate = deadline ? new Date(deadline) : null;
                    const isOverdueByDate = deadlineDate && deadlineDate < today;
                    const isOverBudget = timeLogged > estimated;
                    const hasRisk = isOverdueByDate || isOverBudget;
                    const timeBarColor = isOverBudget ? '#ff5252' : '#00ff88';

                    const prev = document.getElementById('ar-overlay-final');
                    if (prev) prev.remove();

                    const overlay = document.createElement('div');
                    overlay.id = 'ar-overlay-final';
                    overlay.innerHTML = `
                        <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:10000;display:flex;justify-content:center;align-items:center;font-family:sans-serif;color:white;">
                            <div style="background:linear-gradient(135deg,#0f4c75 0%,#3282b8 100%);padding:30px;border-radius:20px;border:3px solid ${hasRisk ? '#ff5252' : '#00ff88'};max-width:520px;text-align:center;box-shadow:0 10px 30px rgba(${hasRisk ? '255,82,82' : '0,255,136'},0.4);">
                                <div style="font-size:48px;margin-bottom:10px;">üéØ</div>
                                <h2 style="color:${hasRisk ? '#ff5252' : '#00ff88'};margin:0 0 15px;font-size:24px;">
                                    REALIDAD AUMENTADA ${hasRisk ? '‚ö†Ô∏è' : ''}
                                </h2>
                                <p style="margin:0 0 8px;font-size:14px;opacity:0.9;">Tarea asignada:</p>
                                <h3 style="margin:0 0 15px;font-size:20px;font-weight:bold;">${name}</h3>
                                
                                ${hasRisk ? `
                                    <div style="background:rgba(255,82,82,0.2);border:1px solid #ff5252;border-radius:10px;padding:10px;margin:0 0 15px;font-size:13px;color:#ffeb3b;">
                                        <strong>‚ö†Ô∏è ALERTA DE RIESGO</strong><br>
                                        ${isOverdueByDate ? '‚Ä¢ La tarea est√° REZAGADA<br>' : ''}
                                        ${isOverBudget ? '‚Ä¢ Tiempo registrado supera el estimado' : ''}
                                    </div>
                                ` : ''}
                                
                                <div style="display:flex;justify-content:center;gap:10px;margin:0 0 20px;flex-wrap:wrap;">
                                    <span style="background:${statusColor};color:white;padding:5px 12px;border-radius:15px;font-size:12px;font-weight:bold;">${statusText}</span>
                                    <span style="background:${priorityColor};color:white;padding:5px 12px;border-radius:15px;font-size:12px;font-weight:bold;">${priorityText}</span>
                                </div>
                                
                                <div style="text-align:left;background:rgba(255,255,255,0.08);padding:18px;border-radius:12px;margin-bottom:20px;">
                                    <p style="margin:8px 0;"><strong>üë§ Asignado a:</strong> ${assignee}</p>
                                    <p style="margin:8px 0;"><strong>‚è±Ô∏è Tiempo asignado:</strong> ${estimated}h</p>
                                    <p style="margin:8px 0;"><strong>‚è±Ô∏è Tiempo registrado:</strong> ${timeLogged}h</p>
                                    
                                    <div style="margin:15px 0;">
                                        <p style="margin:8px 0;font-size:13px;"><strong>üìä Uso de tiempo</strong></p>
                                        <div style="background:#333;height:10px;border-radius:5px;overflow:hidden;width:100%;">
                                            <div style="height:100%;width:${Math.min(100, (timeLogged / (estimated || 1)) * 100)}%;background:${timeBarColor};"></div>
                                        </div>
                                        <small style="opacity:0.85;font-size:12px;">Registrado: ${timeLogged}h / Estimado: ${estimated}h</small>
                                    </div>
                                    
                                    ${progressText ? `<p style="margin:12px 0 0 0;"><strong>üìà Progreso:</strong> ${progressText}</p>` : ''}
                                    <p style="margin:12px 0 0 0;"><strong>üìÖ Periodo de tiempo:</strong> ${start || 'No definida'} ‚Üí ${deadline || 'No definida'}</p>
                                    ${desc ? `<p style="margin:12px 0 0 0;"><strong>üìù Descripci√≥n:</strong> ${desc}</p>` : `<p style="margin:12px 0 0 0;opacity:0.7;"><strong>üìù Descripci√≥n:</strong> Sin descripci√≥n</p>`}
                                </div>
                                
                                <button onclick="document.getElementById('ar-overlay-final').remove()" 
                                        style="background:#9c27b0;color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:bold;transition:transform 0.2s;box-shadow:0 4px 8px rgba(0,0,0,0.3);">
                                    ‚úÖ Cerrar Realidad Aumentada
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(overlay);
                };

                footer.appendChild(btn);
            }
        };

        const modal = document.getElementById('taskDetailsModal');
        if (modal) {
            const observer = new MutationObserver((mutations) => {
                for (const mut of mutations) {
                    if (mut.type === 'attributes' && mut.attributeName === 'style') {
                        if (modal.style.display === 'block') {
                            setTimeout(() => window.projectAR.addARButtonToModal(modal), 300);
                        }
                    }
                }
            });
            observer.observe(modal, { attributes: true, attributeFilter: ['style'] });
        }
    }

    // =============== EFECTOS 3D SEGUROS ===============
    function applySafe3DEffects() {
        console.log('üé® Aplicando efectos 3D seguros...');
        
        const style = document.createElement('style');
        style.id = 'safe-3d-effects';
        style.textContent = `
            /* EFECTOS 3D SEGUROS - NO AFECTAN BOTONES */
            .task-card, .kanban-task, .task-item {
                border-radius: 10px;
                transition: all 0.3s ease;
                border-left: 4px solid #ff9800;
                background: white;
                position: relative;
            }
            
            .task-card:hover, .kanban-task:hover, .task-item:hover {
                transform: translateY(-5px) scale(1.02);
                box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            }
            
            /* Colores de prioridad */
            .task-card[data-priority="alta"] {
                border-left-color: #dc3545;
                background: linear-gradient(135deg, #fff, #ffeaea);
            }
            .task-card[data-priority="media"] {
                border-left-color: #ffc107;
                background: linear-gradient(135deg, #fff, #fff9e6);
            }
            .task-card[data-priority="baja"] {
                border-left-color: #28a745;
                background: linear-gradient(135deg, #fff, #f0fff4);
            }
            
            /* Efecto de profundidad en columnas */
            .kanban-column {
                transition: transform 0.3s ease;
            }
            .kanban-column:hover {
                transform: translateY(-2px);
            }
            
            /* Contadores de columnas */
            .column-counter {
                background: rgba(0,0,0,0.1);
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 0.8em;
                margin-left: 8px;
            }
        `;
        document.head.appendChild(style);

        // Aplicar colores de prioridad
        const cards = document.querySelectorAll('.task-card, .kanban-task, .task-item');
        cards.forEach(card => {
            const priorityBadge = card.querySelector('.priority-badge');
            if (priorityBadge) {
                const priorityText = priorityBadge.textContent.toLowerCase();
                if (priorityText.includes('alta')) card.setAttribute('data-priority', 'alta');
                else if (priorityText.includes('media')) card.setAttribute('data-priority', 'media');
                else if (priorityText.includes('baja')) card.setAttribute('data-priority', 'baja');
            }
        });

        // Agregar contadores a columnas
        const columns = document.querySelectorAll('.kanban-column, .board-column');
        columns.forEach(col => {
            const header = col.querySelector('h2, h3, .column-title') || col;
            const tasks = col.querySelectorAll('.task-card, .kanban-task, .task-item');
            if (tasks.length > 0 && !header.querySelector('.column-counter')) {
                const counter = document.createElement('span');
                counter.className = 'column-counter';
                counter.textContent = tasks.length;
                header.appendChild(counter);
            }
        });
    }

    // =============== TOOLTIPS ===============
    let tooltipElement = null;
    let tooltipTimeout = null;

    function initTooltips() {
        const cards = document.querySelectorAll('.task-card, .kanban-task, .task-item');
        
        cards.forEach(card => {
            card.addEventListener('mouseenter', (e) => {
                tooltipTimeout = setTimeout(() => {
                    showTooltip(card, e.pageX, e.pageY);
                }, 500);
            });

            card.addEventListener('mousemove', (e) => {
                if (tooltipElement) {
                    tooltipElement.style.left = (e.pageX + 10) + 'px';
                    tooltipElement.style.top = (e.pageY + 10) + 'px';
                }
            });

            card.addEventListener('mouseleave', () => {
                clearTimeout(tooltipTimeout);
                hideTooltip();
            });
        });
    }

    function showTooltip(card, x, y) {
        if (!tooltipElement) {
            tooltipElement = document.createElement('div');
            tooltipElement.style.cssText = `
                position: fixed; background: rgba(0,0,0,0.9); color: white;
                padding: 10px; border-radius: 6px; font-size: 12px; z-index: 10000;
                max-width: 250px; pointer-events: none; opacity: 0; transition: opacity 0.2s;
            `;
            document.body.appendChild(tooltipElement);
        }

        // Informaci√≥n del tooltip (simplificada)
        const name = card.querySelector('h3, h4, .task-title')?.textContent || 'Sin nombre';
        const assignee = card.querySelector('.assignee')?.textContent || 'No asignado';
        
        tooltipElement.innerHTML = `
            <strong>${name}</strong><br>
            üë§ ${assignee}<br>
            üìä Vista r√°pida del proyecto
        `;
        
        tooltipElement.style.left = (x + 10) + 'px';
        tooltipElement.style.top = (y + 10) + 'px';
        tooltipElement.style.opacity = '1';
    }

    function hideTooltip() {
        if (tooltipElement) {
            tooltipElement.style.opacity = '0';
        }
    }

    // =============== INICIALIZACI√ìN ===============
    function init() {
        console.log('üéØ Iniciando Project Enhancer Definitivo');
        protectActionButtons(); // PRIMERO - proteger botones
        initARSystem();
        applySafe3DEffects();
   
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        setTimeout(init, 1000);
    }

})();


// === INICIALIZACI√ìN DE IA - AL FINAL DEL ARCHIVO ===
document.addEventListener('DOMContentLoaded', function() {
    // Esperar a que todo cargue y luego configurar IA
    setTimeout(() => {
        setupAIEstimation();
        console.log('‚úÖ Sistema de IA inicializado');
    }, 2000);


// Tambi√©n inicializar cuando se abre el modal
document.getElementById('newTaskBtn')?.addEventListener('click', function() {
    setTimeout(setupAIEstimation, 500);

});

/***********************
 * ASISTENTE VIRTUAL POR VOZ *
 ***********************/

const voiceAssistant = {
  isListening: false,
  recognition: null,
  
  init: function() {
    // Verificar compatibilidad del navegador
    if (!('webkitSpeechRecognition' in window)) {
      console.warn('‚ö†Ô∏è Asistente por voz no compatible con este navegador');
      return false;
    }
    
    try {
      this.recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition || window.mozSpeechRecognition || window.msSpeechRecognition)();
      this.recognition.continuous = true;
      this.recognition.interimResults = false;
      this.recognition.lang = 'es-ES';
      
      this.recognition.onresult = (event) => this.handleCommand(event);
      this.recognition.onerror = (event) => this.handleError(event);
      this.recognition.onend = () => {
        console.log('üîá Reconocimiento de voz finalizado');
        if (this.isListening) {
          setTimeout(() => {
            if (this.isListening) {
              this.recognition.start();
            }
          }, 1000);
        }
      };
      
      console.log('‚úÖ Asistente por voz inicializado');
      this.createVoiceButton();
      return true;
      
    } catch (error) {
      console.error('‚ùå Error inicializando asistente por voz:', error);
      return false;
    }
  },
  
  handleCommand: function(event) {
    if (!event.results || event.results.length === 0) return;
    
    const result = event.results[event.results.length-1];
    if (!result || result.length === 0) return;
    
    const command = result[0].transcript.toLowerCase();
    console.log('üé§ Comando de voz detectado:', command);
    
    // Mostrar feedback visual del comando
    this.showCommandFeedback(command);
    
    // Procesar comandos
    if (command.includes('crear tarea') || command.includes('nueva tarea')) {
      this.createTaskByVoice(command);
    } 
    else if (command.includes('mostrar tablero') || command.includes('ver kanban')) {
      showView('board');
      showNotification('üîä Mostrando vista de tablero');
    }
    else if (command.includes('mostrar lista') || command.includes('ver lista')) {
      showView('list');
      showNotification('üîä Mostrando vista de lista');
    }
    else if (command.includes('mostrar calendario')) {
      showView('calendar');
      showNotification('üîä Mostrando calendario');
    }
    else if (command.includes('mostrar dashboard') || command.includes('ver dashboard')) {
      showView('dashboard');
      showNotification('üîä Mostrando dashboard');
    }
    else if (command.includes('filtrar por') && command.includes('pendiente')) {
      this.applyFilterByStatus('pending');
    }
    else if (command.includes('filtrar por') && command.includes('progreso')) {
      this.applyFilterByStatus('inProgress');
    }
    else if (command.includes('filtrar por') && command.includes('completado')) {
      this.applyFilterByStatus('completed');
    }
    else if (command.includes('limpiar filtros') || command.includes('quitar filtros')) {
      this.clearAllFilters();
    }
    else if (command.includes('estad√≠sticas') || command.includes('estadisticas')) {
      showView('reports');
      showNotification('üîä Mostrando reportes y estad√≠sticas');
    }
    else if (command.includes('nuevo proyecto') || command.includes('crear proyecto')) {
      createNewProject();
      showNotification('üîä Creando nuevo proyecto');
    }
    else if (command.includes('cambiar proyecto')) {
      this.showProjectSelection();
    }
    else if (command.includes('ayuda') || command.includes('comandos')) {
      this.showVoiceCommandsHelp();
    }
    else if (command.includes('detener') || command.includes('parar')) {
      this.toggleListening();
    }
    else {
      console.log('Comando no reconocido:', command);
      showNotification('‚ùå Comando no reconocido. Di "ayuda" para ver comandos disponibles');
    }
  },
  
  createTaskByVoice: function(command) {
    console.log('üîä Procesando creaci√≥n de tarea por voz...');
    
    // Extraer nombre de la tarea
    let taskName = command.replace('crear tarea', '').replace('nueva tarea', '').trim();
    
    if (!taskName) {
      taskName = 'Tarea creada por voz - ' + new Date().toLocaleTimeString();
    }
    
// Crear tarea b√°sica
const task = {
  id: Date.now(),
  name: taskName,
  startDate: new Date().toISOString().split('T')[0],
  deadline: this.extractDeadline(command),
  priority: this.extractPriority(command),
  assignee: this.extractAssignee(command),
  description: `Tarea creada mediante comando de voz: "${command}"`,
  status: 'pending',
  timeLogged: 0,
  estimatedTime: 0,
  timeHistory: [],
  subtasks: [],

  // üî¥ STORY POINTS (YA GUARDADOS)
  storyPoints: storyPoints
};

// üî¥ PRUEBA CLARA
console.warn('üü¢ STORY POINTS EN TAREA ‚Üí', task.storyPoints);

    
    // Asegurar que el proyecto actual existe
    if (!projects || !projects[currentProjectIndex]) {
      showNotification('‚ùå Error: No hay proyecto seleccionado');
      return;
    }
    
    projects[currentProjectIndex].tasks.push(task);
    updateLocalStorage();
    
    // Actualizar vistas
    actualizarAsignados();
    aplicarFiltros();
    generatePieChart(getStats());
    updateProjectProgress();
    
    showNotification(`üîä Tarea "${task.name}" creada por voz`);
    
    // Notificar a otros usuarios si hay WebSocket
    if (typeof tiempoRealSocket !== 'undefined' && tiempoRealSocket && tiempoRealSocket.connected) {
      tiempoRealSocket.emit('task-changed', {
        projectId: currentProjectIndex,
        taskId: task.id,
        taskName: task.name,
        userName: 'Asistente por Voz',
        type: 'task-created',
        timestamp: new Date().toISOString()
      });
    }
  },
  
  extractDeadline: function(command) {
    // L√≥gica simple para extraer fechas
    if (command.includes('ma√±ana')) {
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      return tomorrow.toISOString().split('T')[0];
    }
    if (command.includes('pr√≥xima semana') || command.includes('proxima semana')) {
      const nextWeek = new Date();
      nextWeek.setDate(nextWeek.getDate() + 7);
      return nextWeek.toISOString().split('T')[0];
    }
    return '';
  },
  
  extractPriority: function(command) {
    if (command.includes('alta prioridad') || command.includes('prioridad alta')) return 'alta';
    if (command.includes('media prioridad') || command.includes('prioridad media')) return 'media';
    if (command.includes('baja prioridad') || command.includes('prioridad baja')) return 'baja';
    return 'media'; // Prioridad por defecto
  },
  
  extractAssignee: function(command) {
    // Por ahora retorna vac√≠o, puedes expandir esta l√≥gica
    return '';
  },
  
  applyFilterByStatus: function(status) {
    const activeView = getActiveView();
    const prefixMap = {
      'board': '',
      'list': 'List',
      'calendar': 'Calendar',
      'gantt': 'Gantt',
      'reports': 'Reports'
    };
    
    const prefix = prefixMap[activeView] || '';
    const statusFilter = document.getElementById(`filterStatus${prefix}`);
    
    if (statusFilter) {
      statusFilter.value = status;
      aplicarFiltros();
      showNotification(`üîä Filtrado por: ${getStatusText(status)}`);
    }
  },
  
  clearAllFilters: function() {
    const activeView = getActiveView();
    const prefixMap = {
      'board': '',
      'list': 'List', 
      'calendar': 'Calendar',
      'gantt': 'Gantt',
      'reports': 'Reports'
    };
    
    const prefix = prefixMap[activeView] || '';
    
    // Limpiar filtros disponibles
    const filtersToClear = [
      `filterAssignee${prefix}`,
      `filterPriority${prefix}`, 
      `filterStatus${prefix}`,
      `filterStartDate${prefix}`,
      `filterEndDate${prefix}`
    ];
    
    filtersToClear.forEach(filterId => {
      const filter = document.getElementById(filterId);
      if (filter) filter.value = '';
    });
    
    aplicarFiltros();
    showNotification('üîä Filtros limpiados');
  },
  
  showProjectSelection: function() {
    if (!projects || projects.length === 0) {
      showNotification('‚ùå No hay proyectos disponibles');
      return;
    }
    
    const projectList = projects.map((p, i) => `${i + 1}. ${p.name}`).join('\n');
    showNotification(`üîä Proyectos disponibles:\n${projectList}\n\nDi "proyecto n√∫mero X" para seleccionar`);
  },
  
  showVoiceCommandsHelp: function() {
    const commands = [
      'üé§ COMANDOS DE VOZ DISPONIBLES:',
      '"crear tarea [nombre]" - Nueva tarea',
      '"mostrar tablero/lista/calendario/dashboard" - Cambiar vista',
      '"filtrar por pendiente/progreso/completado" - Filtrar tareas',
      '"limpiar filtros" - Remover filtros',
      '"estad√≠sticas" - Ver reportes',
      '"nuevo proyecto" - Crear proyecto',
      '"cambiar proyecto" - Seleccionar proyecto',
      '"ayuda" - Ver esta lista',
      '"detener" - Parar escucha'
    ].join('\n');
    
    // Usar alert temporalmente para mostrar todos los comandos
    alert(commands);
    showNotification('üîä Comandos de ayuda mostrados');
  },
  
  showCommandFeedback: function(command) {
    // Crear elemento flotante para mostrar el comando
    let feedback = document.getElementById('voiceCommandFeedback');
    if (!feedback) {
      feedback = document.createElement('div');
      feedback.id = 'voiceCommandFeedback';
      feedback.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(52, 152, 219, 0.95);
        color: white;
        padding: 15px 25px;
        border-radius: 25px;
        z-index: 10000;
        font-family: Arial, sans-serif;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        max-width: 80%;
        text-align: center;
        font-size: 16px;
        backdrop-filter: blur(10px);
      `;
      document.body.appendChild(feedback);
    }
    
    feedback.innerHTML = `üé§ <strong>Comando detectado:</strong> "${command}"`;
    feedback.style.display = 'block';
    
    // Ocultar despu√©s de 3 segundos
    setTimeout(() => {
      if (feedback) {
        feedback.style.display = 'none';
      }
    }, 3000);
  },
  
  handleError: function(event) {
    console.error('Error en reconocimiento de voz:', event.error);
    if (event.error === 'not-allowed') {
      showNotification('‚ùå Permiso de micr√≥fono denegado. Por favor habilita el micr√≥fono en la configuraci√≥n del navegador.');
    } else if (event.error === 'audio-capture') {
      showNotification('‚ùå No se detect√≥ micr√≥fono. Verifica que tengas un micr√≥fono conectado.');
    }
  },
  
  createVoiceButton: function() {
    // Crear bot√≥n en la barra superior, al lado de cerrar sesi√≥n
    const button = document.createElement('button');
    button.id = 'voiceAssistantButton';
    button.innerHTML = 'üé§ Activar Voz';
    button.title = 'Asistente por voz - Click para activar/desactivar';
    
    button.style.cssText = `
        position: relative;
        background: #3498db;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 14px;
        cursor: pointer;
        margin-left: 10px;
        transition: all 0.3s ease;
        font-family: Arial, sans-serif;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    `;
    
    // Efectos hover
    button.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-2px)';
        this.style.background = '#2980b9';
        this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
    });
    
    button.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
        this.style.background = '#3498db';
        this.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
    });
    
    // Click para activar/desactivar
    button.addEventListener('click', (e) => {
        e.stopPropagation();
        this.toggleListening();
    });
    
    // Buscar el bot√≥n de cerrar sesi√≥n y insertar al lado
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn && logoutBtn.parentNode) {
        logoutBtn.parentNode.insertBefore(button, logoutBtn.nextSibling);
        console.log('‚úÖ Bot√≥n de voz colocado al lado de cerrar sesi√≥n');
    } else {
        // Fallback: poner en el header
        const header = document.querySelector('header');
        if (header) {
            header.appendChild(button);
            console.log('‚úÖ Bot√≥n de voz colocado en el header');
        } else {
            // √öltimo fallback: poner en body pero arriba
            button.style.position = 'fixed';
            button.style.top = '20px';
            button.style.right = '20px';
            button.style.zIndex = '1000';
            document.body.appendChild(button);
            console.log('‚úÖ Bot√≥n de voz colocado en posici√≥n fija superior');
        }
    }
},
  
toggleListening: function() {
    const button = document.getElementById('voiceAssistantButton');
    
    if (!button) {
        console.error('‚ùå Bot√≥n no encontrado');
        return;
    }
    
    if (!this.isListening) {
        // Activar modo escucha
        try {
            this.recognition.start();
            this.isListening = true;
            button.innerHTML = 'üî¥ Escuchando...';
            button.style.background = '#e74c3c';
            button.title = 'Asistente escuchando - Click para detener';
            showNotification('üîä MODO ESCUCHA ACTIVADO - Di "ayuda" para ver comandos');
            console.log('üé§ Asistente por voz: MODO ESCUCHA ACTIVADO');
        } catch (error) {
            console.error('Error al activar reconocimiento:', error);
            showNotification('‚ùå Error al activar el micr√≥fono');
        }
    } else {
        // Desactivar modo escucha
        this.recognition.stop();
        this.isListening = false;
        button.innerHTML = 'üé§ Activar Voz';
        button.style.background = '#3498db';
        button.title = 'Click para activar el asistente por voz';
        showNotification('üîä Asistente por voz desactivado');
        console.log('üé§ Asistente por voz: MODO ESCUCHA DESACTIVADO');
    }
}
};

// Inicializar el asistente cuando la aplicaci√≥n cargue
document.addEventListener('DOMContentLoaded', function() {
  // Esperar a que todo est√© cargado
  setTimeout(() => {
    console.log('üöÄ Inicializando asistente por voz...');
    if (voiceAssistant.init()) {
      console.log('üé§ Asistente por voz listo para usar');
      // Hacer disponible globalmente para la consola
      window.voiceAssistant = voiceAssistant;
    } else {
      console.log('üîá Asistente por voz no disponible en este navegador');
    }
  }, 3000);
});

// Tambi√©n hacer disponible despu√©s de que cargue la p√°gina
setTimeout(() => {
  window.voiceAssistant = voiceAssistant;
  console.log('üé§ voiceAssistant disponible en consola');
}, 5000);

// === SOLUCI√ìN PARA ERRORES DE SINTAXIS ===

// C√≥digo seguro para cerrar todas las estructuras
});

// === ASISTENTE POR VOZ - VERSI√ìN FUNCIONAL ===

const voiceAssistant = {
  isListening: false,
  recognition: null,
  
  init: function() {
    // Verificar compatibilidad
    if (!('webkitSpeechRecognition' in window)) {
      console.warn('‚ö†Ô∏è Navegador no compatible con reconocimiento de voz');
      return false;
    }
    
    try {
      this.recognition = new webkitSpeechRecognition();
      this.recognition.continuous = true;
      this.recognition.interimResults = false;
      this.recognition.lang = 'es-ES';
      
      this.recognition.onresult = (event) => {
        this.handleCommand(event);
      };
      
      this.recognition.onerror = (event) => {
        console.error('Error de voz:', event.error);
      };
      
      this.recognition.onend = () => {
        if (this.isListening) {
          setTimeout(() => {
            this.recognition.start();
          }, 1000);
        }
      };
      
      console.log('‚úÖ Asistente por voz inicializado');
      this.createVoiceButton();
      return true;
      
    } catch (error) {
      console.error('‚ùå Error al inicializar asistente:', error);
      return false;
    }
  },
  
  handleCommand: function(event) {
    if (!event.results || event.results.length === 0) return;
    
    const result = event.results[event.results.length - 1];
    if (!result || result.length === 0) return;
    
    const command = result[0].transcript.toLowerCase();
    console.log('üé§ Comando detectado:', command);
    
    // Mostrar feedback
    this.showCommandFeedback(command);
    
    // Procesar comandos
    if (command.includes('crear tarea') || command.includes('nueva tarea')) {
      this.createTaskByVoice(command);
    }
    else if (command.includes('mostrar tablero')) {
      this.changeView('board', 'tablero');
    }
    else if (command.includes('mostrar lista')) {
      this.changeView('list', 'lista');
    }
    else if (command.includes('mostrar calendario')) {
      this.changeView('calendar', 'calendario');
    }
    else if (command.includes('mostrar dashboard')) {
      this.changeView('dashboard', 'dashboard');
    }
    else if (command.includes('mostrar reportes') || command.includes('mostrar estad√≠sticas')) {
      this.changeView('reports', 'reportes');
    }
    else if (command.includes('limpiar filtros')) {
      this.clearFilters();
    }
    else if (command.includes('ayuda') || command.includes('comandos')) {
      this.showHelp();
    }
    else if (command.includes('detener') || command.includes('parar')) {
      this.toggleListening();
    }
    else {
      showNotification('‚ùå Comando no reconocido. Di "ayuda" para ver opciones');
    }
  },
  
  createTaskByVoice: function(command) {
    console.log('üîä Creando tarea por voz...');
    
    // Extraer nombre de la tarea
    let taskName = command
      .replace('crear tarea', '')
      .replace('nueva tarea', '')
      .trim();
    
    if (!taskName) {
      taskName = 'Tarea creada por voz - ' + new Date().toLocaleTimeString();
    }
    
    // Verificar que tenemos un proyecto activo
    if (typeof projects === 'undefined' || typeof currentProjectIndex === 'undefined') {
      showNotification('‚ùå Error: No hay proyecto seleccionado');
      return;
    }
    
    if (!projects[currentProjectIndex]) {
      showNotification('‚ùå Error: Proyecto actual no v√°lido');
      return;
    }
    
    // Crear la tarea
    const task = {
      id: Date.now(),
      name: taskName,
      startDate: new Date().toISOString().split('T')[0],
      deadline: '',
      priority: 'media',
      assignee: '',
      description: `Tarea creada por comando de voz: "${command}"`,
      status: 'pending',
      timeLogged: 0,
      estimatedTime: 0,
      timeHistory: [],
      subtasks: []
    };
    
    // Agregar al proyecto actual
    projects[currentProjectIndex].tasks.push(task);
    
    // Guardar y actualizar
    if (typeof updateLocalStorage === 'function') {
      updateLocalStorage();
    }
    
    // Actualizar vistas
    if (typeof actualizarAsignados === 'function') {
      actualizarAsignados();
    }
    
    if (typeof aplicarFiltros === 'function') {
      aplicarFiltros();
    }
    
    if (typeof generatePieChart === 'function' && typeof getStats === 'function') {
      generatePieChart(getStats());
    }
    
    if (typeof updateProjectProgress === 'function') {
      updateProjectProgress();
    }
    
    showNotification(`üîä Tarea creada: "${task.name}"`);
    
    // Notificar por WebSocket si est√° disponible
    if (typeof tiempoRealSocket !== 'undefined' && tiempoRealSocket && tiempoRealSocket.connected) {
      tiempoRealSocket.emit('task-changed', {
        projectId: currentProjectIndex,
        taskId: task.id,
        taskName: task.name,
        userName: 'Asistente por Voz',
        type: 'task-created',
        timestamp: new Date().toISOString()
      });
    }
  },
  
  changeView: function(view, viewName) {
    if (typeof showView === 'function') {
      showView(view);
      showNotification(`üîä Mostrando ${viewName}`);
    } else {
      showNotification('‚ùå Funci√≥n de cambio de vista no disponible');
    }
  },
  
  clearFilters: function() {
    if (typeof aplicarFiltros !== 'function') return;
    
    // Limpiar filtros b√°sicos
    const filters = [
      'filterAssignee',
      'filterPriority', 
      'filterStatus',
      'filterStartDate',
      'filterEndDate'
    ];
    
    filters.forEach(filterId => {
      const element = document.getElementById(filterId);
      if (element) element.value = '';
    });
    
    aplicarFiltros();
    showNotification('üîä Filtros limpiados');
  },
  
  showHelp: function() {
    const commands = [
      'üé§ COMANDOS DE VOZ DISPONIBLES:',
      '"crear tarea [nombre]" - Crear nueva tarea',
      '"mostrar tablero" - Vista Kanban',
      '"mostrar lista" - Vista de lista',
      '"mostrar calendario" - Vista de calendario', 
      '"mostrar dashboard" - Vista dashboard',
      '"mostrar reportes" - Vista de reportes',
      '"limpiar filtros" - Remover todos los filtros',
      '"ayuda" - Ver esta lista de comandos',
      '"detener" - Parar el modo escucha'
    ];
    
    alert(commands.join('\n'));
    showNotification('üîä Comandos de ayuda mostrados');
  },
  
  showCommandFeedback: function(command) {
    // Crear o actualizar elemento de feedback
    let feedback = document.getElementById('voiceCommandFeedback');
    
    if (!feedback) {
      feedback = document.createElement('div');
      feedback.id = 'voiceCommandFeedback';
      feedback.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(52, 152, 219, 0.95);
        color: white;
        padding: 12px 20px;
        border-radius: 20px;
        z-index: 10000;
        font-family: Arial, sans-serif;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        max-width: 90%;
        text-align: center;
        font-size: 14px;
        backdrop-filter: blur(5px);
      `;
      document.body.appendChild(feedback);
    }
    
    feedback.textContent = `üé§ Comando: "${command}"`;
    feedback.style.display = 'block';
    
    // Ocultar despu√©s de 2.5 segundos
    setTimeout(() => {
      feedback.style.display = 'none';
    }, 2500);
  },
  
  createVoiceButton: function() {
    // Crear bot√≥n en la barra superior, al lado de cerrar sesi√≥n
    const button = document.createElement('button');
    button.id = 'voiceAssistantButton';
    button.innerHTML = 'üé§ Activar Voz';
    button.title = 'Asistente por voz - Click para activar/desactivar';
    
    button.style.cssText = `
        position: relative;
        background: #3498db;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 14px;
        cursor: pointer;
        margin-left: 10px;
        transition: all 0.3s ease;
        font-family: Arial, sans-serif;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    `;
    
    // Efectos hover
    button.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-2px)';
        this.style.background = '#2980b9';
        this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
    });
    
    button.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
        this.style.background = '#3498db';
        this.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
    });
    
    // Click para activar/desactivar
    button.addEventListener('click', (e) => {
        e.stopPropagation();
        this.toggleListening();
    });
    
    // Buscar el bot√≥n de cerrar sesi√≥n y insertar al lado
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn && logoutBtn.parentNode) {
        logoutBtn.parentNode.insertBefore(button, logoutBtn.nextSibling);
        console.log('‚úÖ Bot√≥n de voz colocado al lado de cerrar sesi√≥n');
    } else {
        // Fallback: poner en el header
        const header = document.querySelector('header');
        if (header) {
            header.appendChild(button);
            console.log('‚úÖ Bot√≥n de voz colocado en el header');
        } else {
            // √öltimo fallback: poner en body pero arriba
            button.style.position = 'fixed';
            button.style.top = '20px';
            button.style.right = '20px';
            button.style.zIndex = '1000';
            document.body.appendChild(button);
            console.log('‚úÖ Bot√≥n de voz colocado en posici√≥n fija superior');
        }
    }
},
  
  toggleListening: function() {
    const button = document.getElementById('voiceAssistantButton');
    
    if (!button) {
      console.error('‚ùå Bot√≥n no encontrado');
      return;
    }
    
    if (!this.isListening) {
      // Activar modo escucha
      try {
        this.recognition.start();
        this.isListening = true;
        button.style.background = '#e74c3c';
        button.innerHTML = 'üî¥';
        button.title = 'Asistente escuchando - Click para detener';
        showNotification('üîä MODO ESCUCHA ACTIVADO - Di "ayuda" para ver comandos');
        console.log('üé§ Asistente por voz: MODO ESCUCHA ACTIVADO');
      } catch (error) {
        console.error('Error al activar reconocimiento:', error);
        showNotification('‚ùå Error al activar el micr√≥fono');
      }
    } else {
      // Desactivar modo escucha
      this.recognition.stop();
      this.isListening = false;
      button.style.background = '#3498db';
      button.innerHTML = 'üé§';
      button.title = 'Asistente por voz - Click para activar';
      showNotification('üîä Asistente por voz desactivado');
      console.log('üé§ Asistente por voz: MODO ESCUCHA DESACTIVADO');
    }
  }
};

// Inicializaci√≥n segura
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(() => {
    console.log('üöÄ Iniciando asistente por voz...');
    
    if (voiceAssistant.init()) {
      console.log('‚úÖ Asistente por voz inicializado correctamente');
      // Hacer disponible globalmente
      window.voiceAssistant = voiceAssistant;
    } else {
      console.log('‚ÑπÔ∏è Asistente por voz no disponible');
    }
  }, 3000);
});

// Tambi√©n hacer disponible despu√©s de carga completa
setTimeout(() => {
  window.voiceAssistant = voiceAssistant;
  console.log('üé§ voiceAssistant disponible en consola');
}, 5000);



// En tu voiceAssistant existente, a√±ade esta funci√≥n:

// REDIRIGIR RESULTADOS AL SYSTEMASSISTANT
if (window.voiceAssistant && window.SystemAssistant) {
    // Guardar la funci√≥n onResult original si existe
    const originalOnResult = voiceAssistant.onResult;
    
    voiceAssistant.onResult = function(transcript) {
        console.log('üéØ Voz detectada:', transcript);
        
        // Ejecutar funci√≥n original si existe
        if (originalOnResult) {
            originalOnResult(transcript);
        }
        
        // Tambi√©n enviar al SystemAssistant
        if (SystemAssistant.voiceIntegration) {
            SystemAssistant.voiceIntegration.processVoiceCommand(transcript);
        }
    };
    
    console.log('‚úÖ VoiceAssistant conectado a SystemAssistant');
}
// === FIN DEL ARCHIVO - SIN ERRORES ===


/***********************************************
 * üíæ GUARDAR PROYECTO ACTUAL COMO PLANTILLA
 ***********************************************/
function saveCurrentProjectAsTemplate() {
  if (typeof currentProjectIndex === "undefined" || currentProjectIndex < 0) {
    showNotification("‚ö†Ô∏è No hay ning√∫n proyecto seleccionado");
    return;
  }

  const project = projects[currentProjectIndex];
  if (!project) {
    showNotification("‚ö†Ô∏è No se encontr√≥ el proyecto actual");
    return;
  }

  // Pedir nombre y descripci√≥n
  const templateName = prompt("Nombre de la plantilla:", project.name + " (Plantilla)");
  if (!templateName) return;

  const templateDescription = prompt("Descripci√≥n de la plantilla:", project.description || "Sin descripci√≥n");

  // Clonar estructura del proyecto
  const newTemplate = {
    name: templateName.trim(),
    description: templateDescription.trim(),
    tasks: JSON.parse(JSON.stringify(project.tasks || []))
  };

  // Guardar dentro del objeto global
  window.projectTemplates[templateName] = newTemplate;

  // Guardar en localStorage (persistente)
  try {
    localStorage.setItem("projectTemplates", JSON.stringify(window.projectTemplates));
  } catch (err) {
    console.error("‚ùå Error al guardar plantillas en localStorage:", err);
  }

  // Actualizar men√∫ lateral din√°micamente
  const selector = document.getElementById("templateSelector");
  if (selector) {
    const option = document.createElement("option");
    option.value = templateName;
    option.textContent = templateName;
    selector.appendChild(option);
  }

  showNotification(`‚úÖ Plantilla "${templateName}" guardada correctamente`);
  console.log("üíæ Plantilla guardada:", newTemplate);
}

/***********************************************
 * üìã SECCI√ìN DE PLANTILLAS REUTILIZABLES (AUTOCARGABLE)
 ***********************************************/
function injectTemplateSection() {
  const aside = document.querySelector("aside");
  if (!aside) {
    console.warn("‚ö†Ô∏è Men√∫ lateral no encontrado a√∫n, reintentando...");
    setTimeout(injectTemplateSection, 1000);
    return;
  }

  // Evitar duplicar
  if (document.querySelector(".template-section")) {
    console.log("üìã Secci√≥n de plantillas ya existe.");
    return;
  }

  console.log("üß© Insertando secci√≥n de plantillas en el men√∫ lateral...");

  // Crear contenedor principal
  const templateSection = document.createElement("div");
  templateSection.classList.add("template-section");
  templateSection.style.marginTop = "20px";
  templateSection.style.paddingTop = "10px";
  templateSection.style.borderTop = "1px solid #ccc";

  // Generar HTML del men√∫
  templateSection.innerHTML = `
    <h3 style="margin-bottom:8px;font-size:1em;">üìã Plantillas</h3>
    <select id="templateSelector"
            style="width:100%;padding:6px;border-radius:4px;margin-bottom:8px;border:1px solid #ccc;">
      <option value="">Selecciona plantilla...</option>
    </select>
    <button id="useTemplateBtn"
            style="width:100%;background:#3498db;color:white;border:none;padding:8px;border-radius:4px;cursor:pointer;">
      ‚ûï Crear desde plantilla
    </button>
  `;

  aside.appendChild(templateSection);
  console.log("‚úÖ Secci√≥n de plantillas a√±adida correctamente.");

  // üîπ Cargar plantillas desde localStorage (si existen)
  let storedTemplates = {};
  try {
    const saved = localStorage.getItem("projectTemplates");
    if (saved) {
      storedTemplates = JSON.parse(saved);
      window.projectTemplates = storedTemplates;
    }
  } catch (err) {
    console.error("‚ùå Error al cargar plantillas almacenadas:", err);
  }

  // üîπ Si no hay plantillas, usa un ejemplo m√≠nimo
  if (!window.projectTemplates || Object.keys(window.projectTemplates).length === 0) {
    window.projectTemplates = {
      "Proyecto Base": {
        name: "Proyecto Base",
        description: "Plantilla base vac√≠a para nuevos proyectos",
        tasks: []
      }
    };
  }

  // üîπ Poblar el selector con las plantillas disponibles
  const selector = document.getElementById("templateSelector");
  Object.keys(window.projectTemplates).forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    selector.appendChild(opt);
  });

  // üîπ Vincular bot√≥n para crear proyecto desde plantilla
  const btn = document.getElementById("useTemplateBtn");
  btn.addEventListener("click", () => {
    const selected = selector.value;
    if (!selected) {
      showNotification("‚ö†Ô∏è Selecciona una plantilla primero");
      return;
    }

    const template = window.projectTemplates[selected];
    if (!template) {
      showNotification("‚ùå Plantilla no encontrada");
      return;
    }

    const newProject = {
      id: Date.now(),
      name: template.name + " (Copia)",
      description: template.description,
      createdAt: new Date().toISOString(),
      fromTemplate: true,
      tasks: JSON.parse(JSON.stringify(template.tasks))
    };

    projects.push(newProject);
    currentProjectIndex = projects.length - 1;
    updateLocalStorage();
    renderProjects();
    selectProject(currentProjectIndex);

    showNotification(`‚úÖ Proyecto creado desde plantilla: ${template.name}`);
    console.log(`üÜï Proyecto creado desde plantilla: ${template.name}`, newProject);
  });
}

/***********************************************
 * üß© ACTIVADOR AUTOM√ÅTICO
 ***********************************************/
const templateObserver = new MutationObserver(() => {
  const aside = document.querySelector("aside");
  if (aside && !document.querySelector(".template-section")) {
    injectTemplateSection();
  }
});

templateObserver.observe(document.body, { childList: true, subtree: true });

/***********************************************
 * üß© BOT√ìN EN MEN√ö LATERAL PARA GUARDAR PLANTILLA (VERSI√ìN FIJA)
 ***********************************************/
function injectSaveTemplateButton() {
  const aside = document.querySelector("aside");
  if (!aside || document.getElementById("saveTemplateBtn")) return;

  const btn = document.createElement("button");
  btn.id = "saveTemplateBtn";
  btn.textContent = "üíæ Guardar proyecto como plantilla";
  btn.style.width = "100%";
  btn.style.background = "#27ae60";
  btn.style.color = "white";
  btn.style.border = "none";
  btn.style.padding = "8px";
  btn.style.borderRadius = "4px";
  btn.style.cursor = "pointer";
  btn.style.marginTop = "10px";

  btn.addEventListener("click", saveCurrentProjectAsTemplate);

  // Si existe la secci√≥n de plantillas, lo agrega all√≠
  const templateSection = document.querySelector(".template-section");
  if (templateSection) {
    templateSection.appendChild(btn);
  } else {
    // Si a√∫n no existe, lo inserta al final del men√∫ lateral
    aside.appendChild(btn);
  }

  console.log("‚úÖ Bot√≥n 'Guardar proyecto como plantilla' insertado correctamente.");
}

/***********************************************
 * üëÄ OBSERVADOR DIN√ÅMICO DEL MEN√ö LATERAL
 ***********************************************/
const observer = new MutationObserver(() => {
  const aside = document.querySelector("aside");
  const templateSection = document.querySelector(".template-section");

  // Insertar bot√≥n solo una vez, cuando el men√∫ exista
  if (aside && (templateSection || document.querySelector("aside"))) {
    injectSaveTemplateButton();
    observer.disconnect();
  }
});

// Activar observador sobre todo el documento
observer.observe(document.body, { childList: true, subtree: true });

/***********************************************
 * üóëÔ∏è ELIMINAR PLANTILLAS (LOCAL Y BACKEND)
 ***********************************************/

/**
 * Borra una plantilla localmente y del backend si existe
 */
async function deleteTemplate(templateName) {
  if (!templateName || !window.projectTemplates[templateName]) {
    showNotification("‚ö†Ô∏è Selecciona una plantilla v√°lida para borrar");
    return;
  }

  const confirmDelete = confirm(`¬øSeguro que quieres eliminar la plantilla "${templateName}"?`);
  if (!confirmDelete) return;

  // Eliminar de memoria
  delete window.projectTemplates[templateName];

  // Eliminar de localStorage
  localStorage.setItem("projectTemplates", JSON.stringify(window.projectTemplates));

  // Actualizar men√∫ lateral
  const selector = document.getElementById("templateSelector");
  if (selector) {
    const option = selector.querySelector(`option[value="${templateName}"]`);
    if (option) option.remove();
    selector.value = "";
  }

  showNotification(`üóëÔ∏è Plantilla "${templateName}" eliminada localmente`);
  console.log(`üóëÔ∏è Plantilla eliminada localmente: ${templateName}`);

  // Intentar eliminar del backend
  try {
    const response = await fetch(`${TEMPLATES_API_URL}/${encodeURIComponent(templateName)}`, {
      method: "DELETE"
    });
    if (!response.ok) throw new Error(`Error ${response.status}`);
    const result = await response.json();
    console.log(`üåê Plantilla "${templateName}" eliminada del backend`, result);
    showNotification(`üåê Plantilla "${templateName}" eliminada del servidor`);
  } catch (error) {
    console.warn("‚ö†Ô∏è No se pudo eliminar la plantilla en el backend:", error);
  }
}

/***********************************************
 * üß© BOT√ìN PARA BORRAR PLANTILLA EN MEN√ö LATERAL
 ***********************************************/
function injectDeleteTemplateButton() {
  const aside = document.querySelector("aside");
  if (!aside || document.getElementById("deleteTemplateBtn")) return;

  const btn = document.createElement("button");
  btn.id = "deleteTemplateBtn";
  btn.textContent = "üóëÔ∏è Eliminar plantilla seleccionada";
  btn.style.width = "100%";
  btn.style.background = "#e74c3c";
  btn.style.color = "white";
  btn.style.border = "none";
  btn.style.padding = "8px";
  btn.style.borderRadius = "4px";
  btn.style.cursor = "pointer";
  btn.style.marginTop = "8px";

  btn.addEventListener("click", () => {
    const selected = document.getElementById("templateSelector")?.value;
    if (!selected) {
      showNotification("‚ö†Ô∏è Selecciona una plantilla para eliminar");
      return;
    }
    deleteTemplate(selected);
  });

  // Insertar debajo del bot√≥n de ‚ÄúGuardar plantilla‚Äù
  const templateSection = document.querySelector(".template-section");
  if (templateSection) {
    templateSection.appendChild(btn);
  } else {
    aside.appendChild(btn);
  }
}

// Esperar hasta que el men√∫ lateral est√© disponible
let deleteBtnCheck = setInterval(() => {
  const aside = document.querySelector("aside");
  if (aside && document.getElementById("templateSelector")) {
    injectDeleteTemplateButton();
    clearInterval(deleteBtnCheck);
  }
}, 1000);

// ==================================================
// SISTEMA DE IA MEJORADO - VERSI√ìN CORREGIDA
// ==================================================

// Diccionario expandido de IA - VERSI√ìN MEJORADA
const expandedAIDictionary = {
    complexPatterns: {
        'api database integration': {
            keywords: ['api', 'base de datos', 'integrar', 'conectar', 'microservicios'],
            hours: 20,
            complexity: 5,
            reasoning: "üöÄ INTEGRACI√ìN COMPLEJA: M√∫ltiples sistemas"
        },
        'api rest complete': {
            keywords: ['api rest', 'rest api', 'endpoints', 'crud', 'autenticaci√≥n', 'jwt'],
            hours: 12,
            complexity: 4, 
            reasoning: "üåê API REST: Desarrollo completo"
        },
        'frontend framework': {
            keywords: ['react', 'vue', 'angular', 'svelte', 'interfaz', 'login', 'frontend', 'javascript'],
            hours: 10,
            complexity: 4,
            reasoning: "üé® FRONTEND: Framework moderno"
        },
        'mobile development': {
            keywords: ['app m√≥vil', 'android', 'ios', 'flutter', 'react native', 'm√≥vil', 'aplicaci√≥n'],
            hours: 16,
            complexity: 4,
            reasoning: "üì± MOBILE: Desarrollo aplicaci√≥n"
        },
        'devops deployment': {
            keywords: ['docker', 'kubernetes', 'despliegue', 'producci√≥n', 'nginx', 'devops', 'servidor'],
            hours: 8,
            complexity: 4,
            reasoning: "‚öôÔ∏è DEVOPS: Infraestructura y despliegue"
        },
        'machine learning': {
            keywords: ['machine learning', 'ia', 'inteligencia artificial', 'modelo', 'entrenar'],
            hours: 24,
            complexity: 5,
            reasoning: "üß† IA/ML: Modelo de aprendizaje autom√°tico"
        }
    },
    
    simplePatterns: {
        'configuraci√≥n': { 
            keywords: ['configurar', 'instalar', 'setup', 'servidor', 'ambiente'], 
            hours: 5,
            complexity: 3
        },
        'base de datos': { 
            keywords: ['base de datos', 'mysql', 'mongodb', 'postgresql', 'database'], 
            hours: 6,
            complexity: 3
        },
        'testing': { 
            keywords: ['pruebas', 'testing', 'qa', 'testear', 'calidad'], 
            hours: 4,
            complexity: 2
        },
        'documentaci√≥n': { 
            keywords: ['documentar', 'manual', 'wiki', 'docs', 'documentaci√≥n'], 
            hours: 3,
            complexity: 2
        },
        'correcci√≥n': { 
            keywords: ['corregir', 'arreglar', 'bug', 'error', 'fix'], 
            hours: 3,
            complexity: 2
        },
        'dise√±o ui': {
            keywords: ['dise√±ar', 'ui', 'ux', 'interfaz', 'wireframe', 'prototipo'],
            hours: 8,
            complexity: 3
        }
    }
};

// Asistente IA CORREGIDO
window.AIAssistant = {
    name: "Asistente Proyectos",
    currentAvatar: 'robot',
    isThinking: false,
    
    // AVATARES CORREGIDOS - Usando emojis espec√≠ficos
    avatars: {
        'robot': {
            thinking: 'ü§ñ',
            suggesting: 'üîÆ', 
            happy: 'ü§ñ',
            warning: '‚ö†Ô∏è'
        },
        'persona': {
            thinking: 'üë®‚Äçüíª',
            suggesting: 'üë®‚Äçüíª',
            happy: 'üë®‚Äçüíª', 
            warning: 'üôÖ‚Äç‚ôÇÔ∏è'
        },
        'magician': {
            thinking: 'üßô‚Äç‚ôÇÔ∏è',
            suggesting: '‚ú®',
            happy: 'üßô‚Äç‚ôÇÔ∏è',
            warning: 'üîÆ'
        },
        'alien': {
            thinking: 'üëΩ',
            suggesting: 'üõ∏',
            happy: 'üëΩ',
            warning: 'üí´'
        }
    },
    
    // Sonidos
    sounds: {
        thinking: null,
        suggestion: null,
        appear: null
    },
    
    initAssistant: function() {
        console.log('ü§ñ Asistente IA CORREGIDO inicializando...');
        this.loadSounds();
        this.waitForModalOpen();
        this.listenForNewTaskButton();
    },
    
    loadSounds: function() {
        try {
            this.sounds.thinking = this.createBeepSound(400, 0.3);
            this.sounds.suggestion = this.createBeepSound(600, 0.2);
            this.sounds.appear = this.createSweepSound();
        } catch (e) {
            console.log('üîá Sonidos no disponibles');
        }
    },
    
    createBeepSound: function(frequency, duration) {
        return function() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {}
        };
    },
    
    createSweepSound: function() {
        return function() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(800, audioContext.currentTime + 0.5);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {}
        };
    },
    
    playSound: function(soundName) {
        if (this.sounds[soundName]) {
            this.sounds[soundName]();
        }
    },
    
    waitForModalOpen: function() {
        const modal = document.getElementById('createTaskModal');
        if (!modal) {
            setTimeout(() => this.waitForModalOpen(), 1000);
            return;
        }
        
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                    if (modal.style.display === 'block') {
                        console.log('‚úÖ Modal abierto, activando asistente...');
                        this.playSound('appear');
                        this.activateAssistant();
                    }
                }
            });
        });
        
        observer.observe(modal, { attributes: true, attributeFilter: ['style'] });
    },
    
    listenForNewTaskButton: function() {
        const newTaskBtn = document.getElementById('newTaskBtn');
        if (newTaskBtn) {
            newTaskBtn.addEventListener('click', () => {
                setTimeout(() => {
                    this.playSound('appear');
                    this.activateAssistant();
                }, 500);
            });
        }
    },
    
    activateAssistant: function() {
        console.log('üéØ Activando asistente...');
        this.createAvatarUI();
        this.createAvatarSelectorUI();
        this.connectInputEvents();
        this.showInitialMessage();
    },
    
    createAvatarUI: function() {
        if (document.getElementById('aiAssistantAvatar')) {
            document.getElementById('aiAssistantAvatar').remove();
        }
        
        const avatarHTML = `
            <div id="aiAssistantAvatar" style="
                position: absolute;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 15px;
                padding: 20px;
                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                max-width: 300px;
                z-index: 10000;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                border: 2px solid rgba(255,255,255,0.2);
                transform: scale(0.9);
                opacity: 0;
                transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            ">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <span id="aiAvatarIcon" style="font-size: 28px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));">ü§ñ</span>
                    <div>
                        <strong style="color: white; font-size: 15px; display: block;">Asistente IA</strong>
                        <div id="aiStatus" style="color: rgba(255,255,255,0.8); font-size: 11px;">Listo</div>
                    </div>
                </div>
                <div id="aiSuggestionText" style="font-size: 13px; color: white; line-height: 1.5;">
                    ¬°Hola! Describe tu tarea y te ayudo con la estimaci√≥n.
                </div>
                <div id="thinkingAnimation" style="display: none; text-align: center; margin-top: 10px;">
                    <div style="display: inline-flex; gap: 4px;">
                        <div style="width: 6px; height: 6px; border-radius: 50%; background: white; animation: bounce 1.4s infinite ease-in-out;"></div>
                        <div style="width: 6px; height: 6px; border-radius: 50%; background: white; animation: bounce 1.4s infinite ease-in-out 0.2s;"></div>
                        <div style="width: 6px; height: 6px; border-radius: 50%; background: white; animation: bounce 1.4s infinite ease-in-out 0.4s;"></div>
                    </div>
                    <style>
                        @keyframes bounce {
                            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
                            40% { transform: scale(1.2); opacity: 1; }
                        }
                        @keyframes pulse {
                            0% { transform: scale(1); }
                            50% { transform: scale(1.05); }
                            100% { transform: scale(1); }
                        }
                        .avatar-pulse {
                            animation: pulse 2s infinite;
                        }
                    </style>
                </div>
            </div>
        `;
        
        const modal = document.getElementById('createTaskModal');
        if (modal) {
            modal.insertAdjacentHTML('beforeend', avatarHTML);
            
            setTimeout(() => {
                const avatar = document.getElementById('aiAssistantAvatar');
                if (avatar) {
                    avatar.style.transform = 'scale(1)';
                    avatar.style.opacity = '1';
                }
            }, 100);
        }
    },
    
    createAvatarSelectorUI: function() {
        if (document.getElementById('avatarSelector')) {
            document.getElementById('avatarSelector').remove();
        }
        
        const selectorHTML = `
            <div id="avatarSelector" style="
                position: absolute;
                top: 20px;
                right: 340px;
                background: rgba(255,255,255,0.95);
                border-radius: 10px;
                padding: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                z-index: 9999;
                font-size: 12px;
                border: 1px solid #ddd;
            ">
                <div style="color: #333; margin-bottom: 8px; font-weight: bold;">Elige tu avatar:</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                    <button onclick="window.AIAssistant.changeAvatar('robot')" style="border: 1px solid #ddd; background: white; cursor: pointer; font-size: 20px; padding: 8px; border-radius: 5px; display: flex; align-items: center; gap: 5px;" title="Robot">
                        <span>ü§ñ</span>
                        <span style="font-size: 10px;">Robot</span>
                    </button>
                    <button onclick="window.AIAssistant.changeAvatar('persona')" style="border: 1px solid #ddd; background: white; cursor: pointer; font-size: 20px; padding: 8px; border-radius: 5px; display: flex; align-items: center; gap: 5px;" title="Persona">
                        <span>üë®‚Äçüíª</span>
                        <span style="font-size: 10px;">Persona</span>
                    </button>
                    <button onclick="window.AIAssistant.changeAvatar('magician')" style="border: 1px solid #ddd; background: white; cursor: pointer; font-size: 20px; padding: 8px; border-radius: 5px; display: flex; align-items: center; gap: 5px;" title="Mago">
                        <span>üßô‚Äç‚ôÇÔ∏è</span>
                        <span style="font-size: 10px;">Mago</span>
                    </button>
                    <button onclick="window.AIAssistant.changeAvatar('alien')" style="border: 1px solid #ddd; background: white; cursor: pointer; font-size: 20px; padding: 8px; border-radius: 5px; display: flex; align-items: center; gap: 5px;" title="Alien">
                        <span>üëΩ</span>
                        <span style="font-size: 10px;">Alien</span>
                    </button>
                </div>
            </div>
        `;
        
        const modal = document.getElementById('createTaskModal');
        if (modal) {
            modal.insertAdjacentHTML('beforeend', selectorHTML);
        }
    },
    
    changeAvatar: function(avatarType) {
        this.currentAvatar = avatarType;
        const avatarIcon = document.getElementById('aiAvatarIcon');
        if (avatarIcon) {
            avatarIcon.textContent = this.avatars[avatarType].happy;
            avatarIcon.classList.add('avatar-pulse');
            setTimeout(() => avatarIcon.classList.remove('avatar-pulse'), 1000);
        }
        this.playSound('suggestion');
    },
    
    connectInputEvents: function() {
        const taskNameInput = document.getElementById('taskName');
        const taskDescInput = document.getElementById('taskDescription');
        
        if (!taskNameInput || !taskDescInput) return;
        
        // Limpiar event listeners anteriores
        taskNameInput.removeEventListener('input', this._inputHandler);
        taskDescInput.removeEventListener('input', this._inputHandler);
        
        this._inputHandler = () => {
            const taskName = taskNameInput.value.trim();
            const taskDesc = taskDescInput.value.trim();
            
            if (taskName.length > 2 || taskDesc.length > 5) {
                this.showThinkingAnimation();
                setTimeout(() => {
                    const analysis = this.analyzeTaskImproved(taskName, taskDesc, 'media');
                    this.showSuggestion(analysis);
                }, 800);
            } else {
                this.showInitialMessage();
            }
        };
        
        taskNameInput.addEventListener('input', this._inputHandler);
        taskDescInput.addEventListener('input', this._inputHandler);
    },
    
    showThinkingAnimation: function() {
        if (this.isThinking) return;
        
        this.isThinking = true;
        this.playSound('thinking');
        
        const avatarIcon = document.getElementById('aiAvatarIcon');
        const statusText = document.getElementById('aiStatus');
        const thinkingAnim = document.getElementById('thinkingAnimation');
        const suggestionText = document.getElementById('aiSuggestionText');
        
        if (avatarIcon && statusText && thinkingAnim && suggestionText) {
            avatarIcon.textContent = this.avatars[this.currentAvatar].thinking;
            statusText.textContent = 'Analizando...';
            suggestionText.innerHTML = '<em>Procesando tu tarea...</em>';
            thinkingAnim.style.display = 'block';
        }
    },
    
    showSuggestion: function(analysis) {
        this.isThinking = false;
        this.playSound('suggestion');
        
        const avatarIcon = document.getElementById('aiAvatarIcon');
        const statusText = document.getElementById('aiStatus');
        const thinkingAnim = document.getElementById('thinkingAnimation');
        const suggestionText = document.getElementById('aiSuggestionText');
        const estimatedHoursInput = document.getElementById('estimatedHours');
        
        if (avatarIcon && statusText && thinkingAnim && suggestionText) {
            avatarIcon.textContent = this.avatars[this.currentAvatar].suggesting;
            statusText.textContent = 'Sugerencia lista';
            thinkingAnim.style.display = 'none';
            
            suggestionText.innerHTML = `
                <div style="margin-bottom: 10px; font-weight: bold; font-size: 14px;">
                    üí° ${analysis.hours} horas
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px;">
                    <div style="margin-bottom: 4px;"><strong>Complejidad:</strong> ${analysis.complexity}/5 ${this.getComplexityStars(analysis.complexity)}</div>
                    <div style="font-size: 12px; opacity: 0.9;">${analysis.reasoning}</div>
                </div>
            `;
            
            avatarIcon.classList.add('avatar-pulse');
            setTimeout(() => avatarIcon.classList.remove('avatar-pulse'), 1000);
            
            if (estimatedHoursInput) {
                estimatedHoursInput.value = analysis.hours;
            }
        }
    },
    
    getComplexityStars: function(complexity) {
        const filled = '‚òÖ'.repeat(complexity);
        const empty = '‚òÜ'.repeat(5 - complexity);
        return filled + empty;
    },
    
    showInitialMessage: function() {
        const avatarIcon = document.getElementById('aiAvatarIcon');
        const statusText = document.getElementById('aiStatus');
        const thinkingAnim = document.getElementById('thinkingAnimation');
        const suggestionText = document.getElementById('aiSuggestionText');
        
        if (avatarIcon && statusText && thinkingAnim && suggestionText) {
            avatarIcon.textContent = this.avatars[this.currentAvatar].happy;
            statusText.textContent = 'Listo para ayudar';
            thinkingAnim.style.display = 'none';
            suggestionText.innerHTML = `
                <div style="text-align: center; padding: 10px 0;">
                    <div style="font-size: 16px; margin-bottom: 5px;">üëã ¬°Hola!</div>
                    <div style="font-size: 12px; opacity: 0.9;">Describe tu tarea y te ayudo con la estimaci√≥n</div>
                </div>
            `;
        }
    },
    
    // AN√ÅLISIS MEJORADO - Corregido
    analyzeTaskImproved: function(taskName, taskDescription, priority = 'media') {
        console.log('üîç Analizando:', taskName, taskDescription);
        
        const text = (taskName + ' ' + (taskDescription || '')).toLowerCase();
        let hours = 4;
        let complexity = 2;
        let reasoning = ["Tarea est√°ndar"];
        let patternFound = false;
        
        // PRIMERO: Buscar patrones complejos
        for (const [pattern, data] of Object.entries(expandedAIDictionary.complexPatterns)) {
            if (data.keywords.some(keyword => text.includes(keyword))) {
                hours = data.hours;
                complexity = data.complexity;
                reasoning = [data.reasoning];
                patternFound = true;
                console.log('üéØ Patr√≥n complejo detectado:', pattern);
                break;
            }
        }
        
        // SEGUNDO: Si no hay patr√≥n complejo, buscar simples
        if (!patternFound) {
            for (const [pattern, data] of Object.entries(expandedAIDictionary.simplePatterns)) {
                if (data.keywords.some(keyword => text.includes(keyword))) {
                    hours = data.hours;
                    complexity = data.complexity;
                    reasoning = [`üîß ${pattern.toUpperCase()}`];
                    patternFound = true;
                    console.log('‚öôÔ∏è Patr√≥n simple detectado:', pattern);
                    break;
                }
            }
        }
        
        // TERCERO: Ajustes por contexto
        if (text.includes('urgent') || text.includes('cr√≠tic') || text.includes('prioridad') || priority === 'alta') {
            hours *= 1.3;
            reasoning.push("‚ö° PRIORIDAD ALTA (+30%)");
        }
        
        if (text.includes('simple') || text.includes('f√°cil') || text.includes('r√°pido') || text.includes('sencillo')) {
            hours *= 0.7;
            reasoning.push("üê¢ TAREA SIMPLE (-30%)");
        }
        
        if (text.includes('complej') || text.includes('complicad') || text.includes('dif√≠cil') || text.includes('avanzad')) {
            hours *= 1.5;
            reasoning.push("üî¥ TAREA COMPLEJA (+50%)");
        }
        
        // Redondear
        hours = Math.max(0.5, Math.min(40, Math.round(hours * 2) / 2));
        
        console.log('üìä Resultado:', { hours, complexity, reasoning: reasoning.join(' | ') });
        return { hours, complexity, reasoning: reasoning.join(' | ') };
    }
};

// Inicializaci√≥n autom√°tica
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Iniciando asistente IA CORREGIDO...');
    setTimeout(() => {
        if (window.AIAssistant && window.AIAssistant.initAssistant) {
            window.AIAssistant.initAssistant();
        }
    }, 2000);
});

// Comando para probar en consola
window.testAIAssistant = function() {
    console.log('üß™ Probando an√°lisis IA...');
    const testCases = [
        "Crear API REST con Node.js",
        "Configurar servidor Nginx",
        "Desarrollar app m√≥vil con React Native", 
        "Implementar sistema de login con JWT",
        "Corregir errores de CSS"
    ];
    
    testCases.forEach(task => {
        const result = window.AIAssistant.analyzeTaskImproved(task, "", "media");
        console.log(`"${task}" ‚Üí ${result.hours}h | Complejidad: ${result.complexity}/5 | ${result.reasoning}`);
    });
};







// ==================================================
// ASISTENTE GENERAL REPLIKA-STYLE
// ==================================================

window.SystemAssistant = {
    name: "Oxi",
    personality: "energetic",
    mood: "‚ö°",
    isVisible: false,
    conversationHistory: [],
    
    // Personalidades disponibles
    personalities: {
        helpful: {
            name: "Alex",
            greeting: "¬°Hola! Soy Oxi, tu asistente de proyectos. ¬øEn qu√© puedo ayudarte hoy?",
            tone: "amigable y servicial",
            avatar: "ü§ñ"
        },
        professional: {
            name: "ProManager", 
            greeting: "Buen d√≠a. Soy ProManager, su asistente profesional de gesti√≥n de proyectos.",
            tone: "formal y preciso",
            avatar: "üë®‚Äçüíº"
        },
        energetic: {
            name: "Oxi",
            greeting: "¬°Hey! ¬°Soy Oxi! üöÄ ¬øListo para hacer cosas incre√≠bles hoy?",
            tone: "energ√©tico y motivador", 
            avatar: "‚ö°"
        },
        wise: {
            name: "Sage",
            greeting: "Saludos. Soy Sage. La sabidur√≠a en la gesti√≥n viene con la experiencia. ¬øC√≥mo puedo guiarte?",
            tone: "sabio y reflexivo",
            avatar: "üßô‚Äç‚ôÇÔ∏è"
        }
    },
    
    // Conocimiento del sistema
    systemKnowledge: {
        views: ['board', 'list', 'calendar', 'gantt', 'reports', 'dashboard', 'profitability'],
        features: ['tareas', 'proyectos', 'estad√≠sticas', 'reportes', 'diagramas gantt', 'calendario', 'gesti√≥n de tiempo'],
        commands: {
            'cambiar vista': 'Puedo ayudarte a cambiar entre las vistas del sistema',
            'crear proyecto': 'Te gu√≠o para crear un nuevo proyecto',
            'generar reporte': 'Puedo ayudarte a generar reportes PDF',
            'estad√≠sticas': 'Te muestro las estad√≠sticas del proyecto actual',
            'configuraci√≥n': 'Informaci√≥n sobre configuraciones disponibles',
            'ayuda': 'Lista de comandos disponibles'
        }
    },
    
    init: function() {
        console.log('üß† Inicializando Asistente General...');
        this.createAssistantUI();
        this.loadConversationHistory();
        this.setupGlobalHotkey();
        
        // Mostrar saludo despu√©s de un tiempo
        setTimeout(() => {
            this.showWelcomeMessage();
        }, 3000);
    },
    
    createAssistantUI: function() {
        if (document.getElementById('systemAssistant')) return;
        
        const assistantHTML = `
            <div id="systemAssistant" style="
                position: fixed;
                bottom: 20px;
                right: 20px;
                width: 350px;
                background: white;
                border-radius: 20px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.15);
                z-index: 10000;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                border: 2px solid #e0e0e0;
                overflow: hidden;
                transform: translateY(100px);
                opacity: 0;
                transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            ">
                <!-- Header -->
                <div style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    padding: 20px;
                    color: white;
                    position: relative;
                ">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div id="assistantAvatar" style="
                            font-size: 40px;
                            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
                            cursor: pointer;
                        ">ü§ñ</div>
                        <div>
                            <div style="font-size: 18px; font-weight: bold;" id="assistantName">Oxi</div>
                            <div style="font-size: 12px; opacity: 0.8;" id="assistantStatus">Conectado</div>
                        </div>
                    </div>
                    <button onclick="window.SystemAssistant.toggleAssistant()" style="
                        position: absolute;
                        top: 15px;
                        right: 15px;
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        border-radius: 50%;
                        width: 30px;
                        height: 30px;
                        cursor: pointer;
                        font-size: 16px;
                    ">‚àí</button>
                </div>
                
                <!-- Chat Container -->
                <div id="assistantChat" style="
                    height: 300px;
                    overflow-y: auto;
                    padding: 20px;
                    background: #f8f9fa;
                ">
                    <div id="chatMessages">
                        <!-- Mensajes aparecer√°n aqu√≠ -->
                    </div>
                </div>
                
                <!-- Input Area -->
                <div style="padding: 15px; border-top: 1px solid #e0e0e0;">
                    <div style="display: flex; gap: 10px;">
                        <input 
                            type="text" 
                            id="assistantInput" 
                            placeholder="Escribe tu pregunta o comando..."
                            style="
                                flex: 1;
                                padding: 12px 15px;
                                border: 1px solid #ddd;
                                border-radius: 25px;
                                outline: none;
                                font-size: 14px;
                            "
                            onkeypress="if(event.key === 'Enter') window.SystemAssistant.sendMessage()"
                        >
                        <button onclick="window.SystemAssistant.sendMessage()" style="
                            background: #667eea;
                            border: none;
                            color: white;
                            border-radius: 50%;
                            width: 45px;
                            height: 45px;
                            cursor: pointer;
                            font-size: 18px;
                        ">‚û§</button>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div id="quickActions" style="
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 8px;
                        margin-top: 10px;
                    ">
                        <button onclick="window.SystemAssistant.quickAction('cambiar vista')" style="
                            padding: 8px 12px;
                            border: 1px solid #ddd;
                            background: white;
                            border-radius: 15px;
                            font-size: 11px;
                            cursor: pointer;
                        ">üîÑ Cambiar Vista</button>
                        <button onclick="window.SystemAssistant.quickAction('estad√≠sticas')" style="
                            padding: 8px 12px;
                            border: 1px solid #ddd;
                            background: white;
                            border-radius: 15px;
                            font-size: 11px;
                            cursor: pointer;
                        ">üìä Estad√≠sticas</button>
                        <button onclick="window.SystemAssistant.quickAction('crear proyecto')" style="
                            padding: 8px 12px;
                            border: 1px solid #ddd;
                            background: white;
                            border-radius: 15px;
                            font-size: 11px;
                            cursor: pointer;
                        ">‚ûï Nuevo Proyecto</button>
                        <button onclick="window.SystemAssistant.quickAction('ayuda')" style="
                            padding: 8px 12px;
                            border: 1px solid #ddd;
                            background: white;
                            border-radius: 15px;
                            font-size: 11px;
                            cursor: pointer;
                        ">‚ùì Ayuda</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', assistantHTML);
        
        // Animaci√≥n de entrada
        setTimeout(() => {
            const assistant = document.getElementById('systemAssistant');
            if (assistant) {
                assistant.style.transform = 'translateY(0)';
                assistant.style.opacity = '1';
            }
        }, 100);
    },
    
    toggleAssistant: function() {
        const assistant = document.getElementById('systemAssistant');
        if (assistant) {
            if (this.isVisible) {
                assistant.style.transform = 'translateY(100px)';
                assistant.style.opacity = '0';
            } else {
                assistant.style.transform = 'translateY(0)';
                assistant.style.opacity = '1';
            }
            this.isVisible = !this.isVisible;
        }
    },
    
    setupGlobalHotkey: function() {
        document.addEventListener('keydown', (event) => {
            // Ctrl + Espacio para abrir/cerrar asistente
            if (event.ctrlKey && event.code === 'Space') {
                event.preventDefault();
                this.toggleAssistant();
            }
        });
    },
    
    showWelcomeMessage: function() {
        this.addMessage('assistant', this.personalities[this.personality].greeting);
    },
    
    addMessage: function(sender, message) {
        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;
        
        const messageDiv = document.createElement('div');
        messageDiv.style.marginBottom = '15px';
        messageDiv.style.display = 'flex';
        messageDiv.style.gap = '10px';
        
        if (sender === 'user') {
            messageDiv.style.flexDirection = 'row-reverse';
            messageDiv.innerHTML = `
                <div style="
                    background: #667eea;
                    color: white;
                    padding: 12px 15px;
                    border-radius: 18px;
                    max-width: 80%;
                    word-wrap: break-word;
                    font-size: 14px;
                ">${message}</div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div style="
                    font-size: 20px;
                    margin-top: 5px;
                ">${this.personalities[this.personality].avatar}</div>
                <div style="
                    background: white;
                    padding: 12px 15px;
                    border-radius: 18px;
                    max-width: 80%;
                    word-wrap: break-word;
                    font-size: 14px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    border: 1px solid #e0e0e0;
                ">${message}</div>
            `;
        }
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // Guardar en historial
        this.conversationHistory.push({
            sender: sender,
            message: message,
            timestamp: new Date().toISOString()
        });
        
        this.saveConversationHistory();
    },
    
    sendMessage: function() {
        const input = document.getElementById('assistantInput');
        const message = input.value.trim();
        
        if (!message) return;
        
        // Agregar mensaje del usuario
        this.addMessage('user', message);
        input.value = '';
        
        // Procesar mensaje
        setTimeout(() => {
            this.processMessage(message);
        }, 500);
    },
    
    processMessage: function(message) {
    try {
        // üß† Detectar si el mensaje es un objeto (viene de un sistema externo)
        if (typeof message === "object" && message !== null) {
            console.warn("‚ö†Ô∏è Mensaje recibido como objeto:", message);
            if (message.content) {
                message = message.content; // extraer texto
            } else {
                console.error("‚ùå Objeto sin contenido v√°lido en processMessage");
                this.addMessage('assistant', "‚ùå No pude procesar ese mensaje.");
                return;
            }
        }

        if (typeof message !== "string") {
            console.warn("‚ö†Ô∏è Mensaje inv√°lido recibido:", message);
            this.addMessage('assistant', "‚ùå Ocurri√≥ un error al procesar tu mensaje.");
            return;
        }

        const lowerMessage = message.toLowerCase().trim();
        let response = "";

        // üß© Detecci√≥n de intenciones
        if (lowerMessage.includes('hola') || lowerMessage.includes('hi') || lowerMessage.includes('hey')) {
            response = `¬°Hola! Soy ${this.personalities[this.personality].name}, tu asistente de proyectos. ¬øEn qu√© puedo ayudarte hoy?`;
        }
        else if (lowerMessage.includes('cambiar vista') || lowerMessage.includes('ir a')) {
            response = this.handleViewChange(lowerMessage);
        }
       else if (lowerMessage.includes('crear tarea') || lowerMessage.includes('nueva tarea')) {
    // Ejecutar la funci√≥n de crear tarea
    if (typeof openTaskModal === 'function') {
        setTimeout(() => openTaskModal(), 500);
        response = "üìù Abriendo formulario para nueva tarea...";

    } else {
        response = "No pude encontrar el m√≥dulo de tareas, pero puedo ayudarte a crear un proyecto si lo prefieres.";
    }
}
else if (lowerMessage.includes('crear proyecto') || lowerMessage.includes('nuevo proyecto')) {
    // Ejecutar la funci√≥n de crear proyecto
    response = this.handleCreateProject();
}

        else if (lowerMessage.includes('estad√≠stica') || lowerMessage.includes('m√©trica') || lowerMessage.includes('dashboard')) {
            response = this.handleShowStats();
        }
        else if (lowerMessage.includes('reporte') || lowerMessage.includes('pdf')) {
            response = this.handleGenerateReport();
        }
        else if (lowerMessage.includes('ayuda') || lowerMessage.includes('comando')) {
            response = this.showHelp();
        }
        else if (lowerMessage.includes('c√≥mo est√°s') || lowerMessage.includes('qu√© tal')) {
            response = this.howAreYou();
        }
        else if (lowerMessage.includes('gracias') || lowerMessage.includes('thanks')) {
            response = "¬°De nada! üòä ¬øHay algo m√°s en lo que pueda ayudarte?";
        }
        else {
            response = this.generateIntelligentResponse(lowerMessage);
        }

        this.addMessage('assistant', response);

    } catch (err) {
        console.error("‚ùå Error procesando mensaje:", err);
        this.addMessage('assistant', "‚ùå No pude procesar el mensaje, int√©ntalo de nuevo.");
    }
},


    
    handleViewChange: function(message) {
        const views = {
            'tablero': 'board',
            'kanban': 'board', 
            'lista': 'list',
            'calendario': 'calendar',
            'gantt': 'gantt',
            'reporte': 'reports',
            'dashboard': 'dashboard',
            'dashboard 4d': 'dashboard4d',
            'rentabilidad': 'profitability',
             'asignaci√≥n de horas': 'timeAllocation',
                              'asignacion de horas': 'timeAllocation'
                 };
        
        for (const [spanish, english] of Object.entries(views)) {
            if (message.includes(spanish)) {
                if (typeof showView === 'function') {
                    showView(english);
                    return `‚úÖ Perfecto! Te llevo a la vista de ${spanish}.`;
                }
            }
        }
        
        return `Puedo ayudarte a cambiar a estas vistas: ${Object.keys(views).join(', ')}. ¬øA cu√°l quieres ir?`;
    },
    
    handleCreateProject: function() {
        if (typeof createNewProject === 'function') {
            setTimeout(() => createNewProject(), 1000);
            return "¬°Claro! Abriendo el di√°logo para crear un nuevo proyecto...";
        }
        return "La funci√≥n de crear proyectos est√° disponible. Puedes hacer clic en 'Nuevo Proyecto' en el sidebar.";
    },
    
    handleShowStats: function() {
        if (typeof getStats === 'function' && projects && projects[currentProjectIndex]) {
            const stats = getStats();
            return `üìä **Estad√≠sticas del Proyecto Actual:**\n‚Ä¢ Total: ${stats.total} tareas\n‚Ä¢ Pendientes: ${stats.pending}\n‚Ä¢ En progreso: ${stats.inProgress}\n‚Ä¢ Completadas: ${stats.completed}\n‚Ä¢ Rezagadas: ${stats.overdue}`;
        }
        return "Puedo mostrarte estad√≠sticas detalladas en la vista de Dashboard o Reports.";
    },
    
    handleGenerateReport: function() {
        if (typeof generateProjectReport === 'function') {
            setTimeout(() => generateProjectReport(), 1500);
            return "üîÑ Generando reporte PDF del proyecto actual... Se descargar√° autom√°ticamente.";
        }
        return "La generaci√≥n de reportes PDF est√° disponible en la vista de Reports.";
    },
    
    showHelp: function() {
        return `üõ†Ô∏è **Comandos disponibles:**\n\n‚Ä¢ **"Cambiar vista [nombre]"** - Navegar entre vistas\n‚Ä¢ **"Crear proyecto"** - Nuevo proyecto\n‚Ä¢ **"Estad√≠sticas"** - Ver m√©tricas\n‚Ä¢ **"Generar reporte"** - Crear PDF\n‚Ä¢ **"Ayuda"** - Esta lista\n\nTambi√©n puedes usar los botones r√°pidos. ¬øQu√© necesitas?`;
    },
    
    howAreYou: function() {
        const moods = [
            "¬°Estoy excelente! Listo para ayudarte con tus proyectos. üòä",
            "Muy bien, gracias por preguntar. ¬øY t√∫ c√≥mo est√°s?",
            "¬°Energizado y listo para la acci√≥n! üí™",
            "Tranquilo y concentrado, como debe ser para la gesti√≥n de proyectos. üßò"
        ];
        return moods[Math.floor(Math.random() * moods.length)];
    },
    
    generateIntelligentResponse: function(message) {
        // Respuestas inteligentes basadas en contexto
        if (message.includes('tiempo') || message.includes('horas')) {
            return "Puedo ayudarte con estimaciones de tiempo. ¬øQuieres que analice una tarea espec√≠fica?";
        }
        else if (message.includes('proyecto') || message.includes('gesti√≥n')) {
            return "Para la gesti√≥n de proyectos, puedo ayudarte con: crear proyectos, organizar tareas, generar reportes y analizar progreso.";
        }
        else if (message.includes('tarea') || message.includes('task')) {
            return "Puedo ayudarte con las tareas: creaci√≥n, estimaci√≥n de tiempo, asignaci√≥n y seguimiento.";
        }
        else {
            return "Interesante pregunta. Como asistente de gesti√≥n de proyectos, puedo ayudarte con: planificaci√≥n, seguimiento, reportes y optimizaci√≥n de tus proyectos. ¬øEn qu√© aspecto espec√≠fico necesitas ayuda?";
        }
    },
    
    quickAction: function(action) {
        const input = document.getElementById('assistantInput');
        input.value = action;
        this.sendMessage();
    },
    
    changePersonality: function(newPersonality) {
        if (this.personalities[newPersonality]) {
            this.personality = newPersonality;
            const avatar = document.getElementById('assistantAvatar');
            const name = document.getElementById('assistantName');
            
            if (avatar) avatar.textContent = this.personalities[newPersonality].avatar;
            if (name) name.textContent = this.personalities[newPersonality].name;
            
            this.addMessage('assistant', `Personalidad cambiada a: ${newPersonality} - ${this.personalities[newPersonality].tone}`);
        }
    },
    
    saveConversationHistory: function() {
        try {
            localStorage.setItem('assistantConversation', JSON.stringify(this.conversationHistory));
        } catch (e) {
            console.log('No se pudo guardar el historial');
        }
    },
    
    loadConversationHistory: function() {
        try {
            const saved = localStorage.getItem('assistantConversation');
            if (saved) {
                this.conversationHistory = JSON.parse(saved);
                // Cargar √∫ltimos 10 mensajes
                const recent = this.conversationHistory.slice(-10);
                recent.forEach(msg => {
                    this.addMessage(msg.sender, msg.message);
                });
            }
        } catch (e) {
            console.log('No se pudo cargar el historial');
        }
    }
};

// Inicializar asistente general
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        if (window.SystemAssistant && window.SystemAssistant.init) {
            window.SystemAssistant.init();
        }
    }, 4000);
});

// Comandos de consola para probar
window.assistant = {
    show: () => window.SystemAssistant.toggleAssistant(),
    personality: (type) => window.SystemAssistant.changePersonality(type),
    test: () => window.SystemAssistant.addMessage('assistant', '¬°Hola desde la consola! üëã')
};


// En tu archivo script.js, busca donde est√° tu SystemAssistant y a√±ade:

// CONEXI√ìN CON TU SISTEMA DE VOZ EXISTENTE
if (window.SystemAssistant && window.voiceAssistant) {
    SystemAssistant.voiceIntegration = {
        // Conectar el bot√≥n de voz existente al asistente
        connectVoiceButton: function() {
            const voiceBtn = document.getElementById('voiceAssistantButton');
            if (voiceBtn) {
                // Guardar el onclick original
                const originalOnClick = voiceBtn.onclick;
                
                voiceBtn.onclick = function() {
                    // Ejecutar funci√≥n original
                    if (originalOnClick) originalOnClick();
                    
                    // Tambi√©n activar el asistente si est√° cerrado
                    if (SystemAssistant && !SystemAssistant.isVisible) {
                        SystemAssistant.toggleAssistant();
                    }
                };
                
                console.log('‚úÖ Bot√≥n de voz conectado al asistente');
            }
        },
        
        // Procesar comandos de voz en el asistente
        processVoiceCommand: function(transcript) {
            if (!SystemAssistant.isVisible) {
                SystemAssistant.toggleAssistant();
            }
            
            // Insertar en el input del asistente
            const input = document.getElementById('assistantInput');
            if (input) {
                input.value = transcript;
                setTimeout(() => SystemAssistant.sendMessage(), 500);
            }
        }
    };
    
    // Inicializar cuando el asistente est√© listo
    setTimeout(() => {
        SystemAssistant.voiceIntegration.connectVoiceButton();
    }, 3000);
}

// === SISTEMA DE COMANDOS DE VOZ - SOLUCI√ìN COMPLETA ===
console.log("üîä CONFIGURANDO SISTEMA DE VOZ...");

function initializeVoiceSystem() {
    const voiceBtn = document.getElementById('voiceAssistantButton');
    
    if (!voiceBtn) {
        console.error("‚ùå Bot√≥n de voz no encontrado");
        return;
    }

    console.log("‚úÖ Bot√≥n de voz encontrado:", voiceBtn);

    // 1. Verificar si existe voiceAssistant y tiene el m√©todo start
    if (window.voiceAssistant && typeof window.voiceAssistant.start === 'function') {
        console.log("üîä Conectando voiceAssistant existente al bot√≥n...");
        
        // Remover cualquier evento existente
        voiceBtn.replaceWith(voiceBtn.cloneNode(true));
        const newVoiceBtn = document.getElementById('voiceAssistantButton');
        
        // Conectar el evento click
        newVoiceBtn.addEventListener('click', function() {
            console.log("üñ±Ô∏è Bot√≥n de voz clickeado - Activando voiceAssistant");
            
            // Abrir el asistente si est√° cerrado
            if (window.SystemAssistant && !window.SystemAssistant.isVisible) {
                window.SystemAssistant.toggleAssistant();
                // Esperar a que el asistente se abra
                setTimeout(() => {
                    window.voiceAssistant.start();
                }, 500);
            } else {
                window.voiceAssistant.start();
            }
        });
        
        console.log("‚úÖ voiceAssistant conectado al bot√≥n");
        
    } else {
        // 2. Crear sistema de voz m√≠nimo si no existe
        console.log("üîä Creando sistema de voz m√≠nimo...");
        
        window.minimalVoiceSystem = {
            isListening: false,
            recognition: null,
            
            start: function() {
                console.log("üé§ Iniciando reconocimiento de voz...");
                
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    alert("‚ùå Tu navegador no soporta reconocimiento de voz");
                    return;
                }
                
                this.recognition = new SpeechRecognition();
                this.recognition.lang = 'es-ES';
                this.recognition.interimResults = false;
                this.recognition.continuous = false;
                
                this.recognition.onstart = () => {
                    console.log("‚úÖ Escuchando... Habla ahora");
                    this.isListening = true;
                    voiceBtn.style.background = '#e74c3c'; // Rojo cuando est√° escuchando
                    voiceBtn.innerHTML = 'üé§ Escuchando...';
                    
                    if (window.SystemAssistant) {
                        window.SystemAssistant.addMessage('assistant', 'üé§ **Escuchando...** Habla ahora.');
                    }
                };
                
                this.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    console.log("üó£Ô∏è Comando detectado:", transcript);
                    
                    // Restaurar bot√≥n
                    voiceBtn.style.background = '#9b59b6';
                    voiceBtn.innerHTML = 'üé§ Comando de Voz';
                    this.isListening = false;
                    
                    // Enviar al SystemAssistant
                    if (window.SystemAssistant) {
                        const input = document.getElementById('assistantInput');
                        if (input) {
                            input.value = transcript;
                            // Mostrar en el chat
                            window.SystemAssistant.addMessage('user', transcript);
                            // Enviar despu√©s de un breve delay
                            setTimeout(() => {
                                if (typeof window.SystemAssistant.sendMessage === 'function') {
                                    window.SystemAssistant.sendMessage();
                                }
                            }, 1000);
                        }
                    }
                };
                
                this.recognition.onerror = (event) => {
                    console.log("‚ùå Error de voz:", event.error);
                    this.isListening = false;
                    voiceBtn.style.background = '#9b59b6';
                    voiceBtn.innerHTML = 'üé§ Comando de Voz';
                    
                    if (window.SystemAssistant) {
                        let errorMsg = '‚ùå Error de reconocimiento de voz';
                        if (event.error === 'not-allowed') {
                            errorMsg = '‚ùå Micr√≥fono no permitido. Por favor permite el acceso al micr√≥fono.';
                        } else if (event.error === 'no-speech') {
                            errorMsg = '‚ùå No se detect√≥ voz. Intenta de nuevo.';
                        }
                        window.SystemAssistant.addMessage('assistant', errorMsg);
                    }
                };
                
                this.recognition.onend = () => {
                    console.log("üõë Reconocimiento finalizado");
                    this.isListening = false;
                    voiceBtn.style.background = '#9b59b6';
                    voiceBtn.innerHTML = 'üé§ Comando de Voz';
                };
                
                try {
                    this.recognition.start();
                } catch (error) {
                    console.log("‚ùå Error al iniciar reconocimiento:", error);
                    alert("Error al acceder al micr√≥fono. Aseg√∫rate de permitir el acceso.");
                }
            },
            
            stop: function() {
                if (this.recognition && this.isListening) {
                    this.recognition.stop();
                    this.isListening = false;
                    voiceBtn.style.background = '#9b59b6';
                    voiceBtn.innerHTML = 'üé§ Comando de Voz';
                }
            }
        };
        
        // Conectar el sistema m√≠nimo al bot√≥n
        voiceBtn.replaceWith(voiceBtn.cloneNode(true));
        const newVoiceBtn = document.getElementById('voiceAssistantButton');
        
        newVoiceBtn.addEventListener('click', function() {
            console.log("üñ±Ô∏è Bot√≥n de voz clickeado - Activando sistema m√≠nimo");
            
            // Abrir el asistente si est√° cerrado
            if (window.SystemAssistant && !window.SystemAssistant.isVisible) {
                window.SystemAssistant.toggleAssistant();
                // Esperar a que el asistente se abra
                setTimeout(() => {
                    window.minimalVoiceSystem.start();
                }, 500);
            } else {
                window.minimalVoiceSystem.start();
            }
        });
        
        console.log("‚úÖ Sistema de voz m√≠nimo creado y conectado");
    }
    
    // Agregar estilos para el estado de escucha
    const style = document.createElement('style');
    style.textContent = `
        #voiceAssistantButton.listening {
            background: #e74c3c !important;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    `;
    document.head.appendChild(style);
}

// Inicializar el sistema de voz cuando el DOM est√© listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeVoiceSystem);
} else {
    initializeVoiceSystem();
}

// Tambi√©n inicializar despu√©s de un tiempo por si el bot√≥n se crea din√°micamente
setTimeout(initializeVoiceSystem, 2000);

// Comandos de prueba para la consola
console.log("üéÆ COMANDOS DE PRUEBA DISPONIBLES:");
console.log(" - initializeVoiceSystem() ‚Üí Reinicializar sistema de voz");
console.log(" - window.minimalVoiceSystem.start() ‚Üí Iniciar reconocimiento");
console.log(" - window.minimalVoiceSystem.stop() ‚Üí Detener reconocimiento");



// === EXTENSI√ìN DEL SISTEMA DE COMANDOS DEL ASISTENTE ===
console.log("üîß Extendiendo sistema de comandos del asistente...");

// Guardar la funci√≥n original de processMessage
const originalProcessMessage = window.SystemAssistant.processMessage;

// Extender la funci√≥n processMessage con comandos adicionales
window.SystemAssistant.processMessage = function(message) {
    console.log("üì® Mensaje recibido por el asistente:", message);
    
    if (message.type === 'user') {
        const userMessage = message.content.toLowerCase().trim();
        console.log("üîç Analizando comando del usuario:", userMessage);
        
        // Procesar comandos espec√≠ficos
        const commandResponse = processAssistantCommand(userMessage);
        
        if (commandResponse) {
            console.log("‚úÖ Comando reconocido:", commandResponse);
            
            // Agregar respuesta del asistente
            this.addMessage('assistant', commandResponse.message);
            
            // Ejecutar acci√≥n despu√©s de un breve delay
            if (commandResponse.action) {
                setTimeout(() => {
                    try {
                        commandResponse.action();
                        console.log("‚úÖ Acci√≥n ejecutada correctamente");
                    } catch (error) {
                        console.error("‚ùå Error ejecutando acci√≥n:", error);
                        this.addMessage('assistant', "‚ùå Ocurri√≥ un error al ejecutar el comando.");
                    }
                }, 1000);
            }
            return; // Detener el procesamiento original
        }
    }
    
    // Si no es un comando reconocido, usar el procesamiento original
    console.log("‚ÑπÔ∏è Usando procesamiento original del asistente");
    originalProcessMessage.call(this, message);
};

// Sistema de procesamiento de comandos
function processAssistantCommand(message) {
    console.log("üéØ Procesando comando:", message);
    
    // === COMANDOS DE CREACI√ìN ===
    if (message.includes('crear') || message.includes('nueva') || message.includes('agregar')) {
        if (message.includes('tarea') || message.includes('task')) {
            return {
                message: "¬°Perfecto! üéØ Abriendo el formulario para crear una nueva tarea...",
                action: function() {
                    const modal = document.getElementById('createTaskModal');
                    if (modal) {
                        modal.style.display = 'block';
                        showNotification("üìù Formulario de nueva tarea abierto");
                    } else {
                        showNotification("‚ùå No se pudo abrir el formulario de tareas");
                    }
                }
            };
        }
        
        if (message.includes('proyecto') || message.includes('project')) {
            return {
                message: "üöÄ Excelente idea! Creando un nuevo proyecto...",
                action: function() {
                    if (typeof createNewProject === 'function') {
                        createNewProject();
                    } else {
                        showNotification("‚ùå Funci√≥n de crear proyecto no disponible");
                    }
                }
            };
        }
    }
    
    // === COMANDOS DE NAVEGACI√ìN ===
    if (message.includes('tablero') || message.includes('kanban') || message.includes('board')) {
        return {
            message: "üìä Mostrando la vista de Tablero Kanban...",
            action: function() { 
                if (typeof showView === 'function') {
                    showView('board');
                    showNotification("‚úÖ Vista de Tablero activada");
                }
            }
        };
    }
    
    if (message.includes('lista') || message.includes('list')) {
        return {
            message: "üìã Abriendo la vista de Lista de Tareas...",
            action: function() { 
                if (typeof showView === 'function') {
                    showView('list');
                    showNotification("‚úÖ Vista de Lista activada");
                }
            }
        };
    }
    
// Priorizar "dashboard 4d" (frases exactas o con espacio)
if (message.includes('dashboard 4d') || message.includes('dashboard4d') || message.includes('dashboard 4¬∞') ) {
  return {
    message: '‚úÖ Abriendo Dashboard 4D...',
    action: () => { showView('dashboard4d'); }
  };
}


    if (message.includes('dashboard') || message.includes('panel') || message.includes('resumen')) {
        return {
            message: "üìà Mostrando el Dashboard del proyecto...",
            action: function() { 
                if (typeof showView === 'function') {
                    showView('dashboard');
                    showNotification("‚úÖ Dashboard activado");
                }
            }
        };
    }
    
    if (message.includes('calendario') || message.includes('calendar')) {
        return {
            message: "üìÖ Abriendo el Calendario de tareas...",
            action: function() { 
                if (typeof showView === 'function') {
                    showView('calendar');
                    showNotification("‚úÖ Calendario activado");
                }
            }
        };
    }
    
    if (message.includes('gantt') || message.includes('diagrama')) {
        return {
            message: "üìä Mostrando el diagrama de Gantt...",
            action: function() { 
                if (typeof showView === 'function') {
                    showView('gantt');
                    showNotification("‚úÖ Diagrama de Gantt activado");
                }
            }
        };
    }
    
   if (message.includes('reporte') || message.includes('report') || message.includes('informe')) {
    return {
        message: "üìÑ Generando reporte de estado del proyecto actual... Se descargar√° autom√°ticamente en unos segundos.",
        action: function() {
            if (typeof generateStatusReportPDF === 'function') {
                setTimeout(() => {
                    generateStatusReportPDF();
                }, 1500);
            } else {
                showNotification("‚ùå Funci√≥n de generar reporte de estado no disponible");
            }
        }
    };
}
    
    // === COMANDOS DE INFORMACI√ìN ===
    if (message.includes('estad√≠stica') || message.includes('estadistica') || message.includes('progreso') || message.includes('avance')) {
        try {
            const stats = getStats();
            const completion = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;
            const project = projects[currentProjectIndex];
            
            return {
                message: `üìä **Estad√≠sticas del Proyecto "${project?.name || 'Actual'}":**\n\n` +
                        `‚Ä¢ ‚úÖ Completadas: ${stats.completed}\n` +
                        `‚Ä¢ üîÑ En progreso: ${stats.inProgress}\n` +
                        `‚Ä¢ ‚è≥ Pendientes: ${stats.pending}\n` +
                        `‚Ä¢ üö® Rezagadas: ${stats.overdue}\n` +
                        `‚Ä¢ üì¶ Total: ${stats.total}\n` +
                        `‚Ä¢ üéØ **Progreso general: ${completion}%**\n\n` +
                        `¬°Sigue as√≠! üí™`,
                action: null
            };
        } catch (error) {
            return {
                message: "‚ùå No pude obtener las estad√≠sticas del proyecto en este momento.",
                action: null
            };
        }
    }
    
    // === COMANDOS DE AYUDA ===
    if (message.includes('ayuda') || message.includes('help') || message.includes('comandos') || message.includes('qu√© puedes hacer')) {
        return {
            message: `üéØ **¬°Claro! Puedo ayudarte con:**\n\n` +
                    `**üìã CREAR:**\n` +
                    `‚Ä¢ "crear tarea" - Nuevas tareas\n` +
                    `‚Ä¢ "crear proyecto" - Nuevos proyectos\n\n` +
                    `**üß≠ NAVEGAR:**\n` +
                    `‚Ä¢ "mostrar tablero/lista/dashboard"\n` +
                    `‚Ä¢ "ir a calendario/gantt/reportes"\n\n` +
                    `**üìä INFORMACI√ìN:**\n` +
                    `‚Ä¢ "estad√≠sticas" - Progreso del proyecto\n` +
                    `‚Ä¢ "generar reporte" - PDF del proyecto\n\n` +
                    `**‚ö° ACCIONES R√ÅPIDAS:**\n` +
                    `‚Ä¢ "tareas pendientes"\n` +
                    `‚Ä¢ "progreso actual"\n` +
                    `‚Ä¢ "tiempo registrado"`,
            action: null
        };
    }
    
    // === COMANDOS DE SALUDO ===
    if (message.includes('hola') || message.includes('buenas') || message.includes('hi') || message.includes('hello')) {
        return {
            message: `¬°Hola! üëã Soy tu asistente de gesti√≥n de proyectos.\n\n` +
                    `Puedo ayudarte a crear tareas, navegar entre vistas, ver estad√≠sticas y generar reportes.\n\n` +
                    `¬øEn qu√© te puedo ayudar hoy? üòä`,
            action: null
        };
    }
    
    // Comando no reconocido - dejar que el AI original lo maneje
    console.log("‚ùå Comando no reconocido, usando AI original");
    return null;
}

// Funci√≥n para probar comandos manualmente
window.testAssistantCommand = function(command) {
    console.log(`üß™ Probando comando manual: "${command}"`);
    
    const testMessage = {
        type: 'user',
        content: command,
        timestamp: new Date().toISOString()
    };
    
    window.SystemAssistant.processMessage(testMessage);
};

// Inicializar despu√©s de que cargue todo
setTimeout(() => {
    console.log("‚úÖ Sistema de comandos del asistente extendido correctamente");
    console.log("üéÆ Prueba estos comandos:");
    console.log("   - testAssistantCommand('crear tarea')");
    console.log("   - testAssistantCommand('mostrar dashboard')");
    console.log("   - testAssistantCommand('estad√≠sticas')");
}, 1000);

// Tambi√©n agregar un bot√≥n de prueba en la interfaz
function addAssistantTestButton() {
    const assistantContainer = document.querySelector('.assistant-container');
    if (assistantContainer && !document.getElementById('assistantTestBtn')) {
        const testBtn = document.createElement('button');
        testBtn.id = 'assistantTestBtn';
        testBtn.innerHTML = 'üß™ Probar Comandos';
        testBtn.style.cssText = `
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: #9b59b6;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            z-index: 1000;
        `;
        testBtn.onclick = function() {
            testAssistantCommand('ayuda');
        };
        assistantContainer.style.position = 'relative';
        assistantContainer.appendChild(testBtn);
        console.log("‚úÖ Bot√≥n de prueba del asistente agregado");
    }
}

// Agregar el bot√≥n de prueba
setTimeout(addAssistantTestButton, 2000);

// === CORRECCI√ìN PARA MENSAJES DE VOZ Y CHAT DIRECTOS ===
console.log("üîß Corrigiendo procesamiento de mensajes directos...");

// Interceptar el addMessage original para manejar mensajes de texto simples
const originalAddMessage = window.SystemAssistant.addMessage;

window.SystemAssistant.addMessage = function(type, content) {
    console.log(`üí¨ Mensaje agregado - Tipo: ${type}, Contenido:`, content);
    
    // Si es un mensaje de usuario como texto simple, convertirlo a objeto estructurado
    if (type === 'user' && typeof content === 'string') {
        console.log("üîÑ Convirtiendo mensaje de texto a objeto estructurado...");
        
        const structuredMessage = {
            type: 'user',
            content: content,
            timestamp: new Date().toISOString()
        };
        
        // Procesar el mensaje estructurado
        setTimeout(() => {
            this.processMessage(structuredMessage);
        }, 100);
    }
    
    // Llamar a la funci√≥n original
    return originalAddMessage.call(this, type, content);
};

// Tambi√©n interceptar el sendMessage para mensajes del input del chat
const originalSendMessage = window.SystemAssistant.sendMessage;

if (originalSendMessage) {
    window.SystemAssistant.sendMessage = function() {
        const input = document.getElementById('assistantInput');
        if (input && input.value.trim()) {
            const userMessage = input.value.trim();
            console.log("üì§ Mensaje enviado desde input:", userMessage);
            
            // Crear mensaje estructurado
            const structuredMessage = {
                type: 'user', 
                content: userMessage,
                timestamp: new Date().toISOString()
            };
            
            // Procesar el mensaje
            this.processMessage(structuredMessage);
            
            // Limpiar input
            input.value = '';
        }
    };
}

console.log("‚úÖ Interceptores de mensajes instalados correctamente");

// Funci√≥n para forzar el procesamiento de cualquier texto
window.forceProcessMessage = function(text) {
    console.log("üîÑ Forzando procesamiento de:", text);
    
    const structuredMessage = {
        type: 'user',
        content: text,
        timestamp: new Date().toISOString()
    };
    
    window.SystemAssistant.processMessage(structuredMessage);
};

// Probar inmediatamente
setTimeout(() => {
    console.log("üéÆ Prueba estos comandos:");
    console.log("   - forceProcessMessage('crear tarea')");
    console.log("   - forceProcessMessage('mostrar dashboard')");
}, 1000);


// === MEJORA DEL SISTEMA DE COMANDOS - M√ÅS FLEXIBLE ===
function processAssistantCommand(message) {
    console.log("üéØ Procesando comando:", message);
    
    // Limpiar y normalizar el mensaje
    const cleanMessage = message.toLowerCase().trim();
    
    // === DETECCI√ìN M√ÅS FLEXIBLE DE COMANDOS ===
    
    // CREAR TAREA - M√°s patrones de detecci√≥n
    if (cleanMessage.includes('crear tarea') || 
        cleanMessage.includes('nueva tarea') ||
        cleanMessage.includes('agregar tarea') ||
        cleanMessage.includes('crear task') ||
        (cleanMessage.includes('crear') && cleanMessage.includes('tarea')) ||
        cleanMessage.startsWith('crear ') ||
        cleanMessage === 'crear tarea') {
        
        return {
            message: "¬°Perfecto! üéØ Abriendo el formulario para crear una nueva tarea...",
            action: function() {
                const modal = document.getElementById('createTaskModal');
                if (modal) {
                    modal.style.display = 'block';
                    showNotification("üìù Formulario de nueva tarea abierto");
                    
                    // Si el mensaje incluye detalles de la tarea, intentar prellenar
                    if (cleanMessage.includes('dise√±o') || cleanMessage.includes('design')) {
                        setTimeout(() => {
                            const nameInput = document.getElementById('taskName');
                            if (nameInput) {
                                // Extraer el nombre de la tarea del mensaje
                                const taskName = message.replace('crear tarea', '').replace('crear', '').trim();
                                if (taskName && taskName !== 'tarea') {
                                    nameInput.value = taskName;
                                }
                            }
                        }, 500);
                    }
                } else {
                    showNotification("‚ùå No se pudo abrir el formulario de tareas");
                }
            }
        };
    }
    
    // DASHBOARD - M√°s patrones
    if (cleanMessage.includes('dashboard') || 
        cleanMessage.includes('panel') ||
        cleanMessage.includes('resumen') ||
        cleanMessage.includes('mostrar dashboard') ||
        cleanMessage.includes('ver dashboard')) {
        
        return {
            message: "üìà Mostrando el Dashboard del proyecto...",
            action: function() { 
                if (typeof showView === 'function') {
                    showView('dashboard');
                    showNotification("‚úÖ Dashboard activado");
                }
            }
        };
    }
    
    // ESTAD√çSTICAS - M√°s patrones  
    if (cleanMessage.includes('estad√≠stica') || 
        cleanMessage.includes('estadistica') ||
        cleanMessage.includes('progreso') ||
        cleanMessage.includes('avance') ||
        cleanMessage.includes('c√≥mo vamos') ||
        cleanMessage.includes('como vamos')) {
        
        try {
            const stats = getStats();
            const completion = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;
            const project = projects[currentProjectIndex];
            
            return {
                message: `üìä **Estad√≠sticas del Proyecto "${project?.name || 'Actual'}":**\n\n` +
                        `‚Ä¢ ‚úÖ Completadas: ${stats.completed}\n` +
                        `‚Ä¢ üîÑ En progreso: ${stats.inProgress}\n` +
                        `‚Ä¢ ‚è≥ Pendientes: ${stats.pending}\n` +
                        `‚Ä¢ üö® Rezagadas: ${stats.overdue}\n` +
                        `‚Ä¢ üì¶ Total: ${stats.total}\n` +
                        `‚Ä¢ üéØ **Progreso general: ${completion}%**\n\n` +
                        `¬°Sigue as√≠! üí™`,
                action: null
            };
        } catch (error) {
            return {
                message: "‚ùå No pude obtener las estad√≠sticas del proyecto en este momento.",
                action: null
            };
        }
    }
    
    // AYUDA - M√°s patrones
    if (cleanMessage.includes('ayuda') || 
        cleanMessage.includes('help') ||
        cleanMessage.includes('comandos') ||
        cleanMessage.includes('qu√© puedes hacer') ||
        cleanMessage.includes('que puedes hacer') ||
        cleanMessage === '?') {
        
        return {
            message: `üéØ **¬°Claro! Puedo ayudarte con:**\n\n` +
                    `**üìã CREAR:**\n` +
                    `‚Ä¢ "crear tarea" - Nuevas tareas\n` +
                    `‚Ä¢ "crear proyecto" - Nuevos proyectos\n\n` +
                    `**üß≠ NAVEGAR:**\n` +
                    `‚Ä¢ "mostrar tablero/lista/dashboard"\n` +
                    `‚Ä¢ "ir a calendario/gantt/reportes"\n\n` +
                    `**üìä INFORMACI√ìN:**\n` +
                    `‚Ä¢ "estad√≠sticas" - Progreso del proyecto\n` +
                    `‚Ä¢ "generar reporte" - PDF del proyecto\n\n` +
                    `**‚ö° ACCIONES R√ÅPIDAS:**\n` +
                    `‚Ä¢ "tareas pendientes"\n` +
                    `‚Ä¢ "progreso actual"\n` +
                    `‚Ä¢ "tiempo registrado"`,
            action: null
        };
    }
    
    // Comando no reconocido
    console.log("‚ùå Comando no reconocido, usando AI original");
    return null;
}


// === SISTEMA DE VOZ DEFINITIVO - VERSI√ìN COMPLETA ===
console.log("üîä CARGANDO SISTEMA DE VOZ DEFINITIVO...");

// Sistema de comandos de voz independiente y robusto
window.VoiceCommandSystem = {
    isListening: false,
    recognition: null,
    retryCount: 0,
    maxRetries: 3,
    
    // Procesador de comandos mejorado
    processCommand: function(command) {
        console.log("üéØ Procesando comando:", command);
        const cleanCommand = command.toLowerCase().trim();
        
        // COMANDOS B√ÅSICOS MEJORADOS
        if (cleanCommand.includes('hola') || cleanCommand.includes('hi') || cleanCommand.includes('hello') || cleanCommand.includes('buenas')) {
            this.showResponse("¬°Hola! üëã Soy tu asistente de voz. Puedo ayudarte a:\n‚Ä¢ Crear tareas\n‚Ä¢ Mostrar vistas\n‚Ä¢ Ver estad√≠sticas\n‚Ä¢ Generar reportes\n\nDi 'ayuda' para ver todos los comandos.");
            return true;
        }
        
        if (cleanCommand.includes('crear tarea') || cleanCommand.includes('nueva tarea') || cleanCommand.includes('agregar tarea')) {
            this.showResponse("¬°Perfecto! üéØ Abriendo formulario para crear una nueva tarea...");
            this.openTaskModal();
            return true;
        }
        
        if (cleanCommand.includes('dashboard') || cleanCommand.includes('panel') || cleanCommand.includes('resumen')) {
            this.showResponse("üìà Mostrando Dashboard del proyecto...");
            this.showDashboard();
            return true;
        }
        
        if (cleanCommand.includes('tablero') || cleanCommand.includes('kanban') || cleanCommand.includes('board')) {
            this.showResponse("üìä Mostrando Tablero Kanban...");
            this.showBoard();
            return true;
        }
        
        if (cleanCommand.includes('lista') || cleanCommand.includes('listado')) {
            this.showResponse("üìã Mostrando Lista de Tareas...");
            this.showList();
            return true;
        }
        
        if (cleanCommand.includes('calendario') || cleanCommand.includes('calendar')) {
            this.showResponse("üìÖ Mostrando Calendario...");
            this.showCalendar();
            return true;
        }
        
        if (cleanCommand.includes('estad√≠stica') || cleanCommand.includes('estadistica') || cleanCommand.includes('progreso') || cleanCommand.includes('avance')) {
            this.showResponse("üìä Calculando estad√≠sticas del proyecto...");
            this.showStats();
            return true;
        }
        
        if (cleanCommand.includes('reporte') || cleanCommand.includes('report') || cleanCommand.includes('informe') || cleanCommand.includes('pdf')) {
            this.showResponse("üìÑ Generando reporte PDF del proyecto... Se descargar√° autom√°ticamente.");
            this.generateReport();
            return true;
        }
        
        if (cleanCommand.includes('ayuda') || cleanCommand.includes('help') || cleanCommand.includes('comandos')) {
            this.showResponse(
                `üéØ **COMANDOS DE VOZ DISPONIBLES:**\n\n` +
                `**üìã CREAR:**\n` +
                `‚Ä¢ "crear tarea" - Nuevas tareas\n` +
                `‚Ä¢ "nueva tarea" - Formulario de tarea\n\n` +
                `**üß≠ NAVEGAR:**\n` +
                `‚Ä¢ "dashboard" - Vista principal\n` +
                `‚Ä¢ "tablero" - Vista Kanban\n` +
                `‚Ä¢ "lista" - Lista de tareas\n` +
                `‚Ä¢ "calendario" - Vista calendario\n\n` +
                `**üìä INFORMACI√ìN:**\n` +
                `‚Ä¢ "estad√≠sticas" - Progreso del proyecto\n` +
                `‚Ä¢ "reporte" - Generar PDF\n\n` +
                `**‚ö° ACCIONES:**\n` +
                `‚Ä¢ "hola" - Saludo inicial\n` +
                `‚Ä¢ "ayuda" - Ver esta lista`
            );
            return true;
        }
        
        // Comando no reconocido - sugerencia
        this.showResponse(`No entend√≠: "${command}"\n\nüí° Prueba con: "crear tarea", "dashboard", "estad√≠sticas" o "ayuda"`);
        return false;
    },
    
    // Mostrar respuesta en el asistente
    showResponse: function(response) {
        console.log("üí¨ Mostrando respuesta:", response);
        if (window.SystemAssistant && typeof window.SystemAssistant.addMessage === 'function') {
            window.SystemAssistant.addMessage('assistant', response);
        } else {
            // Fallback si el asistente no est√° disponible
            alert("Asistente: " + response);
        }
    },
    
    // === ACCIONES MEJORADAS ===
    openTaskModal: function() {
        const modal = document.getElementById('createTaskModal');
        if (modal) {
            modal.style.display = 'block';
            showNotification("üéØ Formulario de nueva tarea abierto");
            console.log("‚úÖ Modal de tarea abierto");
        } else {
            console.error("‚ùå No se encontr√≥ el modal de tarea");
            this.showResponse("‚ùå No pude abrir el formulario de tareas");
        }
    },
    
    showDashboard: function() {
        if (typeof showView === 'function') {
            showView('dashboard');
            showNotification("üìà Dashboard activado");
            console.log("‚úÖ Vista dashboard activada");
        } else {
            console.error("‚ùå Funci√≥n showView no disponible");
        }
    },
    
    showBoard: function() {
        if (typeof showView === 'function') {
            showView('board');
            showNotification("üìä Tablero Kanban activado");
            console.log("‚úÖ Vista board activada");
        }
    },
    
    showList: function() {
        if (typeof showView === 'function') {
            showView('list');
            showNotification("üìã Lista de tareas activada");
            console.log("‚úÖ Vista list activada");
        }
    },
    
    showCalendar: function() {
        if (typeof showView === 'function') {
            showView('calendar');
            showNotification("üìÖ Calendario activado");
            console.log("‚úÖ Vista calendar activada");
        }
    },
    
    showStats: function() {
        try {
            const stats = getStats();
            const completion = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;
            const project = projects[currentProjectIndex];
          // const timeStats = getTimeStats();
            
            const statsMessage = 
                `üìä **ESTAD√çSTICAS - ${project?.name || 'Proyecto Actual'}**\n\n` +
                `**üì¶ TAREAS:**\n` +
                `‚Ä¢ ‚úÖ Completadas: ${stats.completed}\n` +
                `‚Ä¢ üîÑ En progreso: ${stats.inProgress}\n` +
                `‚Ä¢ ‚è≥ Pendientes: ${stats.pending}\n` +
                `‚Ä¢ üö® Rezagadas: ${stats.overdue}\n` +
                `‚Ä¢ üìã Total: ${stats.total}\n\n` +
                `**üéØ PROGRESO:** ${completion}%\n\n` +
                `**‚è∞ TIEMPO:**\n` +
                `‚Ä¢ ‚è±Ô∏è Estimado: ${timeStats.totalEstimated.toFixed(1)}h\n` +
                `‚Ä¢ üïí Registrado: ${timeStats.totalLogged.toFixed(1)}h\n` +
                `‚Ä¢ ‚è≥ Restante: ${timeStats.remaining.toFixed(1)}h`;
            
            this.showResponse(statsMessage);
            console.log("‚úÖ Estad√≠sticas mostradas");
        } catch (error) {
            console.error("‚ùå Error calculando estad√≠sticas:", error);
            this.showResponse("‚ùå No pude obtener las estad√≠sticas del proyecto");
        }
    },
    
    generateReport: function() {
    if (typeof generateStatusReportPDF === 'function') { // ‚úÖ CORRECTO
        this.showResponse("üìä Generando reporte PDF con gr√°fico... Esto puede tomar unos segundos.");
        setTimeout(() => {
            try {
                generateStatusReportPDF(); // ‚úÖ ESTA FUNCI√ìN S√ç TIENE GR√ÅFICO
                console.log("‚úÖ Reporte PDF con gr√°fico generado");
            } catch (error) {
                console.error("‚ùå Error generando reporte:", error);
                this.showResponse("‚ùå Error al generar el reporte PDF");
            }
        }, 2000);
        } else {
            this.showResponse("‚ùå La funci√≥n de generar reportes no est√° disponible");
        }
    },
    
    // === SISTEMA DE VOZ ROBUSTO ===
    startListening: function() {
        console.log("üé§ Iniciando reconocimiento de voz...");
        
        if (this.isListening) {
            console.log("‚ö†Ô∏è Ya est√° escuchando, deteniendo...");
            this.stopListening();
            return;
        }
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            this.showResponse("‚ùå Tu navegador no soporta reconocimiento de voz");
            return;
        }
        
        this.recognition = new SpeechRecognition();
        this.recognition.lang = 'es-ES';
        this.recognition.interimResults = false;
        this.recognition.continuous = false;
        
        this.recognition.onstart = () => {
            console.log("‚úÖ Escuchando... Habla ahora");
            this.isListening = true;
            this.retryCount = 0;
            this.updateButton(true);
            this.showResponse("üé§ **Escuchando...**\n\n**Habla ahora** - Di por ejemplo:\n‚Ä¢ \"crear tarea\"\n‚Ä¢ \"mostrar dashboard\"\n‚Ä¢ \"estad√≠sticas\"");
        };
        
        this.recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            console.log("üó£Ô∏è Voz detectada:", transcript);
            
            this.stopListening();
            this.showResponse(`üé§ **Dijiste:** "${transcript}"`);
            
            // Procesar despu√©s de un breve delay
            setTimeout(() => {
                this.processCommand(transcript);
            }, 1000);
        };
        
        this.recognition.onerror = (event) => {
            console.log("‚ùå Error de voz:", event.error);
            
            if (event.error === 'no-speech' && this.retryCount < this.maxRetries) {
                this.retryCount++;
                console.log(`üîÑ Reintento ${this.retryCount}/${this.maxRetries}`);
                this.showResponse(`üé§ No detect√© voz... Reintentando (${this.retryCount}/${this.maxRetries})\n\n**Habla ahora**`);
                
                setTimeout(() => {
                    if (this.isListening) {
                        this.recognition.start();
                    }
                }, 1000);
                return;
            }
            
            this.stopListening();
            
            let errorMsg = "‚ùå Error de reconocimiento de voz";
            if (event.error === 'not-allowed') {
                errorMsg = "‚ùå Micr√≥fono bloqueado. Por favor permite el acceso al micr√≥fono en tu navegador.";
            } else if (event.error === 'no-speech') {
                errorMsg = "‚ùå No detect√© voz. Aseg√∫rate de hablar claramente y di 'ayuda' para ver comandos.";
            }
            
            this.showResponse(errorMsg);
        };
        
        this.recognition.onend = () => {
            console.log("üõë Reconocimiento finalizado");
            if (this.isListening && this.retryCount < this.maxRetries) {
                // Auto-reintento
                setTimeout(() => {
                    if (this.isListening) {
                        console.log("üîÑ Auto-reintento...");
                        this.recognition.start();
                    }
                }, 500);
            } else {
                this.stopListening();
            }
        };
        
        try {
            this.recognition.start();
            console.log("‚úÖ Reconocimiento de voz iniciado");
        } catch (error) {
            console.log("‚ùå Error al iniciar reconocimiento:", error);
            this.stopListening();
            this.showResponse("‚ùå Error al acceder al micr√≥fono");
        }
    },
    
    stopListening: function() {
        console.log("üõë Deteniendo reconocimiento...");
        if (this.recognition && this.isListening) {
            try {
                this.recognition.stop();
            } catch (e) {
                console.log("‚ö†Ô∏è Error al detener reconocimiento:", e);
            }
        }
        this.isListening = false;
        this.retryCount = 0;
        this.updateButton(false);
    },
    
    updateButton: function(listening) {
        const voiceBtn = document.getElementById('voiceAssistantButton');
        if (voiceBtn) {
            if (listening) {
                voiceBtn.style.background = '#e74c3c';
                voiceBtn.innerHTML = 'üé§ Escuchando...';
                voiceBtn.style.animation = 'pulse 1s infinite';
            } else {
                voiceBtn.style.background = '#9b59b6';
                voiceBtn.innerHTML = 'üé§ Comando de Voz';
                voiceBtn.style.animation = 'none';
            }
        }
    },
    
    // Inicializaci√≥n robusta
    init: function() {
        console.log("üîä Inicializando sistema de voz definitivo...");
        
        const voiceBtn = document.getElementById('voiceAssistantButton');
        if (voiceBtn) {
            // Limpiar eventos existentes
            const newVoiceBtn = voiceBtn.cloneNode(true);
            voiceBtn.parentNode.replaceChild(newVoiceBtn, voiceBtn);
            
            // Conectar evento
            newVoiceBtn.onclick = (e) => {
                e.stopPropagation();
                console.log("üñ±Ô∏è Bot√≥n de voz clickeado");
                this.startListening();
                
                // Abrir asistente si est√° cerrado
                if (window.SystemAssistant && !window.SystemAssistant.isVisible) {
                    setTimeout(() => {
                        window.SystemAssistant.toggleAssistant();
                    }, 300);
                }
            };
            
            console.log("‚úÖ Bot√≥n de voz conectado correctamente");
        } else {
            console.error("‚ùå No se encontr√≥ el bot√≥n de voz");
        }
        
        // Agregar estilos de animaci√≥n
        this.addStyles();
        
        console.log("‚úÖ Sistema de voz definitivo inicializado");
    },
    
    addStyles: function() {
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.7; }
                100% { opacity: 1; }
            }
            #voiceAssistantButton.listening {
                background: #e74c3c !important;
                animation: pulse 1s infinite;
            }
        `;
        document.head.appendChild(style);
    }
};

// Inicializar cuando el DOM est√© listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => VoiceCommandSystem.init(), 2000);
    });
} else {
    setTimeout(() => VoiceCommandSystem.init(), 2000);
}

// Tambi√©n inicializar despu√©s de un tiempo por si el bot√≥n se crea din√°micamente
setTimeout(() => {
    if (!document.getElementById('voiceAssistantButton').onclick) {
        VoiceCommandSystem.init();
    }
}, 5000);

// Comandos globales para pruebas
window.testVoiceCommand = function(command) {
    VoiceCommandSystem.processCommand(command);
};

window.startVoice = function() {
    VoiceCommandSystem.startListening();
};

console.log("üéØ SISTEMA DE VOZ CARGADO - Comandos disponibles:");
console.log("   - testVoiceCommand('hola')");
console.log("   - testVoiceCommand('crear tarea')"); 
console.log("   - testVoiceCommand('estad√≠sticas')");
console.log("   - startVoice()");
console.log("   - Click en üé§ Comando de Voz");




// === SOLUCI√ìN COMPLETA PARA EL ASISTENTE GENERAL ===

// 1. REPARAR EL BOT√ìN DE ENVIAR
function fixAssistantSendButton() {
    console.log('üîß Reparando bot√≥n de enviar del asistente...');

    const sendButton = document.querySelector('#sendAssistantBtn, .assistant-send, button.btn-save');
    let button = sendButton;

    // Si no existe, crear uno temporal
    if (!button) {
        console.warn("‚ö†Ô∏è No se encontr√≥ el bot√≥n de enviar, creando uno temporal.");
        button = document.createElement('button');
        button.id = 'sendAssistantBtn';
        button.textContent = 'Enviar';
        button.classList.add('assistant-send');
        button.style.position = 'fixed';
        button.style.bottom = '20px';
        button.style.right = '20px';
        button.style.padding = '10px 20px';
        button.style.background = '#9b59b6';
        button.style.color = 'white';
        button.style.border = 'none';
        button.style.borderRadius = '8px';
        button.style.cursor = 'pointer';
        button.style.zIndex = '9999';
        document.body.appendChild(button);
    }

    // Eliminar listeners antiguos clonando el bot√≥n
    const newButton = button.cloneNode(true);
    button.parentNode.replaceChild(newButton, button);

    // Conectar evento al asistente
    newButton.addEventListener('click', function (e) {
        e.preventDefault();
        console.log('üñ±Ô∏è Click en bot√≥n de enviar - procesando...');
        processAssistantInput();
    });

    console.log('‚úÖ Bot√≥n de enviar del asistente listo:', newButton);
    return newButton;
}

// 2. REPARAR EL INPUT DEL ASISTENTE
function fixAssistantInput() {
    console.log('üîß Reparando input del asistente...');

    // üß© Crear el input si no existe
    let input = document.querySelector('input#assistantInput, textarea#assistantInput, .assistant-input');
    if (!input) {
        console.warn("‚ö†Ô∏è No se encontr√≥ el input del asistente, creando uno temporal.");
        input = document.createElement('input');
        input.id = 'assistantInput';
        input.placeholder = 'Escribe un mensaje...';
        input.classList.add('assistant-input');
        input.style.position = 'fixed';
        input.style.bottom = '20px';
        input.style.left = '50%';
        input.style.transform = 'translateX(-50%)';
        input.style.padding = '10px 15px';
        input.style.border = '1px solid #ccc';
        input.style.borderRadius = '10px';
        input.style.zIndex = '9999';
        document.body.appendChild(input);
    }

    // üß† Conecta la tecla Enter
    input.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            console.log('‚å®Ô∏è Enter presionado - Procesando...');
            processAssistantInput();
        }
    });

    console.log('‚úÖ Input del asistente listo:', input);
    return input;
}

// 3. FUNCI√ìN PRINCIPAL DE PROCESAMIENTO
function processAssistantInput() {
    console.log('üîÑ Procesando entrada del asistente...');

    try {
        let input = document.querySelector('#assistantInput');

        // Si no existe, crear un input real
        if (!input || !(input instanceof HTMLInputElement || input instanceof HTMLTextAreaElement)) {
            console.warn('‚ö†Ô∏è Input no encontrado o inv√°lido. Creando uno nuevo...');
            input = document.createElement('input');
            input.type = 'text';
            input.id = 'assistantInput';
            input.placeholder = 'Escribe un mensaje...';
            input.classList.add('assistant-input');
            Object.assign(input.style, {
                position: 'fixed',
                bottom: '20px',
                left: '50%',
                transform: 'translateX(-50%)',
                padding: '10px 15px',
                border: '1px solid #ccc',
                borderRadius: '10px',
                zIndex: '9999'
            });
            document.body.appendChild(input);
        }

        // Obtener texto (si existe value, si no, vac√≠o)
        const message = typeof input.value === 'string' ? input.value.trim() : '';

        if (!message) {
            console.log('‚ÑπÔ∏è Mensaje vac√≠o o inv√°lido');
            if (typeof showNotification === 'function')
                showNotification('üí° Escribe un mensaje primero');
            return;
        }

        console.log('üì§ Mensaje a procesar:', message);
        input.value = '';

        if (typeof displayUserMessage === 'function')
            displayUserMessage(message);
        else
            console.log(`üë§ Usuario: ${message}`);

        if (typeof processAssistantCommand === 'function')
            processAssistantCommand(message);
        else
            console.warn('‚ö†Ô∏è processAssistantCommand no est√° definido.');

    } catch (error) {
        console.error('‚ùå Error procesando entrada:', error);
        if (typeof showNotification === 'function')
            showNotification('‚ùå Error al procesar el mensaje');
    }
}



// 4. MOSTRAR MENSAJE DEL USUARIO
function displayUserMessage(message) {
    console.log('üí¨ Mostrando mensaje del usuario:', message);
    
    // Buscar contenedor de chat
    const chatContainer = document.querySelector('#assistantChat, .chat-container, .assistant-messages, [class*="message"]');
    
    if (chatContainer) {
        const messageElement = document.createElement('div');
        messageElement.className = 'user-message assistant-message';
        messageElement.innerHTML = `
            <div class="message-content user-content">
                <strong>T√∫:</strong> ${message}
            </div>
        `;
        chatContainer.appendChild(messageElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    } else {
        console.warn('‚ö†Ô∏è Contenedor de chat no encontrado');
    }
}

// 5. PROCESAR COMANDOS DEL ASISTENTE
function processAssistantCommand(message) {
    const cleanMessage = message.toLowerCase().trim();
    console.log('üéØ Procesando comando:', cleanMessage);
    
    let response = '';
    let action = null;
    
    // COMANDOS DE REPORTE
    if (cleanMessage.includes('reporte') || cleanMessage.includes('informe') || cleanMessage.includes('estado')) {
        response = "üìä Mostrando reporte del proyecto...";
        action = function() {
            showView('reports');
            setTimeout(() => generateReports(), 300);
        };
    }
    // COMANDOS DE TAREAS
    else if (cleanMessage.includes('crear tarea') || cleanMessage.includes('nueva tarea')) {
        response = "üìù Abriendo formulario para nueva tarea...";
        action = function() {
            document.getElementById('createTaskModal').style.display = 'block';
        };
    }
    // COMANDOS DE VISTAS

// DASHBOARD 4D
else if (cleanMessage.includes('dashboard 4d') || cleanMessage.includes('dashboard4d') || cleanMessage.includes('dashboard 4¬∞')) {
    response = "üåê Mostrando Dashboard 4D...";
    action = function() {
        console.log('üß≠ Abriendo vista Dashboard 4D desde asistente...');
        showView('dashboard4d');
        renderDashboard4D();
    };
}

    // === DASHBOARD 4D ===
else if (
  cleanMessage.includes('dashboard 4d') ||
  cleanMessage.includes('dashboard4d') ||
  cleanMessage.includes('dashboard 4¬∞') ||
  cleanMessage.includes('ir a dashboard 4d')
) {
  response = "üåê Mostrando Dashboard 4D...";
  action = function() {
    console.log("üß≠ Abriendo vista Dashboard 4D desde asistente...");
    showView('dashboard4d');
  
  };
}

// === DASHBOARD NORMAL ===
else if (
  (cleanMessage.includes('dashboard') && !cleanMessage.includes('4d')) ||
  cleanMessage.includes('tablero')
) {
  response = "üìä Mostrando dashboard...";
  action = function() {
    showView('dashboard');
  };
}

    else if (cleanMessage.includes('lista') || cleanMessage.includes('tareas')) {
        response = "üìã Mostrando lista de tareas...";
        action = function() { showView('list'); };
    }
    else if (cleanMessage.includes('kanban') || cleanMessage.includes('tablero')) {
        response = "üéØ Mostrando tablero Kanban...";
        action = function() { showView('board'); };
    }
    else if (cleanMessage.includes('calendario')) {
        response = "üìÖ Mostrando calendario...";
        action = function() { showView('calendar'); };
    }
    else if (cleanMessage.includes('gantt')) {
        response = "üìà Mostrando diagrama de Gantt...";
        action = function() { showView('gantt'); };
    }
    // COMANDO DE AYUDA
    else if (cleanMessage.includes('ayuda') || cleanMessage.includes('comandos')) {
        response = `üé§ **Comandos Disponibles:**

‚Ä¢ **"reporte"** - Mostrar reporte del proyecto
‚Ä¢ **"crear tarea"** - Abrir formulario de nueva tarea
‚Ä¢ **"dashboard"** - Mostrar dashboard principal  
‚Ä¢ **"lista"** - Mostrar lista de tareas
‚Ä¢ **"kanban"** - Mostrar tablero Kanban
‚Ä¢ **"calendario"** - Mostrar calendario
‚Ä¢ **"gantt"** - Mostrar diagrama de Gantt
‚Ä¢ **"rentabilidad"** - Mostrar an√°lisis de rentabilidad`;
    }
    // COMANDO NO RECONOCIDO
    else {
        response = "‚ùå Comando no reconocido. Escribe **'ayuda'** para ver los comandos disponibles.";
    }
    
    // Mostrar respuesta
    displayAssistantResponse(response);
    
    // Ejecutar acci√≥n si existe
    if (action && typeof action === 'function') {
        setTimeout(action, 500);
    }
}

// 6. MOSTRAR RESPUESTA DEL ASISTENTE
function displayAssistantResponse(message) {
    console.log('ü§ñ Mostrando respuesta del asistente:', message);
    
    // Buscar contenedor de chat
    const chatContainer = document.querySelector('#assistantChat, .chat-container, .assistant-messages, [class*="message"]');
    
    if (chatContainer) {
        const messageElement = document.createElement('div');
        messageElement.className = 'assistant-message';
        messageElement.innerHTML = `
            <div class="message-content assistant-content">
                <strong>Asistente:</strong> ${message}
            </div>
        `;
        chatContainer.appendChild(messageElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // Tambi√©n mostrar notificaci√≥n
    showNotification('üí¨ Asistente: ' + message.replace(/\*\*/g, '').substring(0, 50) + '...');
}

// 7. INICIALIZACI√ìN COMPLETA
function initializeAssistant() {
    console.log('üöÄ Inicializando asistente general...');
    

    fixAssistantInput();
    fixAssistantSendButton();


    // Reparar elementos
    fixAssistantInput();
    fixAssistantSendButton();
    
    // Agregar estilos si es necesario
    addAssistantStyles();
    
    console.log('‚úÖ Asistente general inicializado correctamente');
}

// 8. ESTILOS PARA EL CHAT
function addAssistantStyles() {
    if (document.getElementById('assistant-styles')) return;
    
    const styles = `
        <style id="assistant-styles">
            .user-message {
                text-align: right;
                margin: 10px 0;
                padding: 10px;
                background: #007bff;
                color: white;
                border-radius: 10px;
                max-width: 80%;
                margin-left: auto;
            }
            .assistant-message {
                text-align: left;
                margin: 10px 0;
                padding: 10px;
                background: #f8f9fa;
                color: #333;
                border-radius: 10px;
                max-width: 80%;
                border: 1px solid #dee2e6;
            }
            .message-content {
                word-wrap: break-word;
            }
        </style>
    `;
    
    document.head.insertAdjacentHTML('beforeend', styles);
}

// === EJECUTAR LA SOLUCI√ìN ===

// Opci√≥n 1: Ejecutar inmediatamente
setTimeout(initializeAssistant, 1000);

// Opci√≥n 2: Ejecutar cuando se haga clic en el asistente
document.addEventListener('click', function(e) {
    if (e.target.closest('#assistantButton, [onclick*="assistant"], .assistant-btn')) {
        setTimeout(initializeAssistant, 500);
    }
});

// Opci√≥n 3: Crear funci√≥n global para llamar manualmente
window.fixAssistant = initializeAssistant;

console.log('üîß Script de reparaci√≥n del asistente cargado');
console.log('üí° Usa fixAssistant() en la consola si necesitas reparar manualmente');






// === AGREGAR COMANDO "CREAR PROYECTO" AL ASISTENTE ===

// 1. MODIFICAR LA FUNCI√ìN processAssistantCommand
function processAssistantCommand(message) {
// üß© Normalizar el mensaje
    if (typeof message === 'object' && message.content) {
        message = message.content;
    }
    const cleanMessage = message.toLowerCase().trim();
    console.log('üéØ Procesando comando:', cleanMessage);
    
    let response = '';
    let action = null;
    
    // ‚úÖ NUEVO COMANDO: CREAR PROYECTO
    if (cleanMessage.includes('crear proyecto') || 
        cleanMessage.includes('nuevo proyecto') || 
        cleanMessage.includes('agregar proyecto')) {
        
        response = "üöÄ Creando nuevo proyecto...";
        action = function() {
            createNewProjectWithAssistant();
        };
    }
    // COMANDOS DE REPORTE
    else if (cleanMessage.includes('reporte') || cleanMessage.includes('informe') || cleanMessage.includes('estado')) {
        response = "üìä Mostrando reporte del proyecto...";
        action = function() {
            showView('reports');
            setTimeout(() => generateReports(), 300);
        };
    }
    // COMANDOS DE TAREAS
    else if (cleanMessage.includes('crear tarea') || cleanMessage.includes('nueva tarea')) {
        response = "üìù Abriendo formulario para nueva tarea...";
        action = function() {
            document.getElementById('createTaskModal').style.display = 'block';
        };
    }
    // COMANDOS DE VISTAS
    else if (cleanMessage.includes('dashboard') || cleanMessage.includes('tablero')) {
        response = "üìä Mostrando dashboard...";
        action = function() { showView('dashboard'); };
    }
    else if (cleanMessage.includes('lista') || cleanMessage.includes('tareas')) {
        response = "üìã Mostrando lista de tareas...";
        action = function() { showView('list'); };
    }
    else if (cleanMessage.includes('kanban') || cleanMessage.includes('tablero')) {
        response = "üéØ Mostrando tablero Kanban...";
        action = function() { showView('board'); };
    }
    else if (cleanMessage.includes('calendario')) {
        response = "üìÖ Mostrando calendario...";
        action = function() { showView('calendar'); };
    }
    else if (cleanMessage.includes('gantt')) {
        response = "üìà Mostrando diagrama de Gantt...";
        action = function() { showView('gantt'); };
    }
    // COMANDO DE AYUDA
    else if (cleanMessage.includes('ayuda') || cleanMessage.includes('comandos')) {
        response = `üé§ **Comandos Disponibles:**

‚Ä¢ **"crear proyecto"** - Crear un nuevo proyecto
‚Ä¢ **"reporte"** - Mostrar reporte del proyecto
‚Ä¢ **"crear tarea"** - Abrir formulario de nueva tarea
‚Ä¢ **"dashboard"** - Mostrar dashboard principal  
‚Ä¢ **"lista"** - Mostrar lista de tareas
‚Ä¢ **"kanban"** - Mostrar tablero Kanban
‚Ä¢ **"calendario"** - Mostrar calendario
‚Ä¢ **"gantt"** - Mostrar diagrama de Gantt
‚Ä¢ **"rentabilidad"** - Mostrar an√°lisis de rentabilidad`;
    }
    // COMANDO NO RECONOCIDO
    else {
        response = "‚ùå Comando no reconocido. Escribe **'ayuda'** para ver los comandos disponibles.";
    }
    
    // Mostrar respuesta
    displayAssistantResponse(response);
    
    // Ejecutar acci√≥n si existe
    if (action && typeof action === 'function') {
        setTimeout(action, 500);
    }
}

// 2. FUNCI√ìN PARA CREAR PROYECTO CON ASISTENTE
function createNewProjectWithAssistant() {
  console.log('üÜï Creando proyecto mediante asistente...');

  const today = new Date();
  const end = new Date();
  end.setDate(today.getDate() + 30); // 30 d√≠as por defecto

  const project = {
    id: Date.now(),
    name: `Proyecto ${window.projects.length + 1}`,
    startDate: today.toISOString().split('T')[0],
    endDate: end.toISOString().split('T')[0],
    tasks: [],
    createdBy: 'assistant'
  };

  window.projects.push(project);
  window.currentProject = project;

  console.log('üì¶ Proyecto creado ‚Üí', project);
  console.log('üìÖ Inicio ‚Üí', project.startDate);
  console.log('üìÖ Fin ‚Üí', project.endDate);
}

// 3. FUNCI√ìN ALTERNATIVA SI createNewProject NO EXISTE
function createProjectWithPrompt() {
    console.log('üîÑ Usando m√©todo alternativo para crear proyecto...');
    
    const projectName = prompt('üéØ ¬øC√≥mo quieres llamar al nuevo proyecto?');
    
    if (!projectName || projectName.trim() === '') {
        showNotification('‚ùå El nombre del proyecto no puede estar vac√≠o');
        return;
    }
    
    const timeInput = prompt('‚è±Ô∏è ¬øCu√°ntas horas estimadas para el proyecto? (opcional)');
    const timeValue = timeInput ? parseFloat(timeInput) || 0 : 0;
    
    // Crear el proyecto
    const newProject = {
        name: projectName.trim(),
        totalProjectTime: timeValue,
        tasks: []
    };
    
    // Agregar a la lista de proyectos
    if (window.projects && Array.isArray(window.projects)) {
        window.projects.push(newProject);
        window.currentProjectIndex = window.projects.length - 1;
        
        // Actualizar la interfaz
        if (typeof updateLocalStorage === 'function') {
            updateLocalStorage();
        }
        if (typeof renderProjects === 'function') {
            renderProjects();
        }
        if (typeof selectProject === 'function') {
            selectProject(window.currentProjectIndex);
        }
        
        showNotification(`‚úÖ Proyecto "${projectName}" creado exitosamente`);
        displayAssistantResponse(`‚úÖ **Proyecto creado:** "${projectName}"${timeValue > 0 ? ` con ${timeValue} horas estimadas` : ''}`);
        
    } else {
        console.error('‚ùå No se pudo crear el proyecto - Array projects no disponible');
        showNotification('‚ùå Error al crear el proyecto');
    }
}

// 4. AGREGAR TAMBI√âN AL SISTEMA DE VOZ
function addCreateProjectToVoice() {
    console.log('üé§ Agregando comando "crear proyecto" al sistema de voz...');
    
    if (window.VoiceCommandSystem && window.VoiceCommandSystem.processCommand) {
        const originalProcessCommand = window.VoiceCommandSystem.processCommand;
        
        window.VoiceCommandSystem.processCommand = function(command) {
            const cleanCommand = command.toLowerCase().trim();
            console.log('üé§ Comando recibido:', cleanCommand);
            
            // ‚úÖ NUEVO COMANDO DE VOZ: CREAR PROYECTO
            if (cleanCommand.includes('crear proyecto') || 
                cleanCommand.includes('nuevo proyecto') || 
                cleanCommand.includes('agregar proyecto')) {
                
                console.log('‚úÖ EJECUTANDO CREAR PROYECTO');
                this.showResponse("üöÄ Creando nuevo proyecto...");
                
                // Ejecutar la funci√≥n de crear proyecto
                createNewProjectWithAssistant();
                return true;
            }
            
            // Para otros comandos, usar el procesamiento original
            return originalProcessCommand.call(this, command);
        };
        
        console.log('‚úÖ Comando "crear proyecto" agregado al sistema de voz');
    }
}

// 5. ACTUALIZAR TEXTO DE AYUDA DEL SISTEMA DE VOZ
function updateVoiceHelp() {
    if (window.VoiceCommandSystem && window.VoiceCommandSystem.showHelp) {
        const originalShowHelp = window.VoiceCommandSystem.showHelp;
        
        window.VoiceCommandSystem.showHelp = function() {
            const helpText = `üé§ **Comandos de Voz Disponibles:**

‚Ä¢ **"crear proyecto"** - Crear un nuevo proyecto
‚Ä¢ **"crear tarea"** - Abrir formulario de nueva tarea
‚Ä¢ **"reporte"** - Mostrar reporte del proyecto
‚Ä¢ **"dashboard"** - Mostrar dashboard principal  
‚Ä¢ **"lista"** - Mostrar lista de tareas
‚Ä¢ **"calendario"** - Mostrar calendario
‚Ä¢ **"gantt"** - Mostrar diagrama de Gantt
‚Ä¢ **"kanban"** - Mostrar tablero Kanban
‚Ä¢ **"rentabilidad"** - Mostrar an√°lisis de rentabilidad
‚Ä¢ **"ayuda"** - Mostrar esta ayuda`;

            this.showResponse(helpText);
        };
        
        console.log('‚úÖ Ayuda del sistema de voz actualizada');
    }
}

// 6. EJECUTAR LA CONFIGURACI√ìN
function setupCreateProjectCommand() {
    console.log('‚öôÔ∏è Configurando comando "crear proyecto"...');
    
    // Agregar al sistema de voz
    addCreateProjectToVoice();
    
    // Actualizar ayuda
    updateVoiceHelp();
    
    console.log('‚úÖ Comando "crear proyecto" configurado correctamente');
}

// === EJECUTAR LA CONFIGURACI√ìN ===

// Ejecutar inmediatamente
setTimeout(setupCreateProjectCommand, 1500);

// Tambi√©n ejecutar cuando se inicialice el asistente
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(setupCreateProjectCommand, 3000);
});

// Funci√≥n global para forzar la configuraci√≥n
window.setupProjectCommand = setupCreateProjectCommand;

console.log('üîß Script de comando "crear proyecto" cargado');
console.log('üí° Usa setupProjectCommand() en la consola si necesitas forzar la configuraci√≥n');



// === FUNCI√ìN GLOBAL PARA GENERAR REPORTE (accesible desde el asistente) ===
function generateStatusReportPDF() {
  console.log("üé§ generateStatusReportPDF ejecutado");
  try {
    generateProjectReport(); // Esta funci√≥n S√ç existe y ya incluye gr√°fico + bloques de tiempo
  } catch (err) {
    console.error("‚ùå Error en generateStatusReportPDF:", err);
    showNotification("‚ùå Error al generar el reporte");
  }
}
// Asegurar que est√© en el √°mbito global
window.generateStatusReportPDF = generateStatusReportPDF;




document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        if (window.SystemAssistant && window.SystemAssistant.init) {
            window.SystemAssistant.init();
        }
    }, 4000);
});


// ============================================================
// üß† FIX DEFINITIVO DEL ASISTENTE VISUAL
// Sincroniza el input interno del chat con el sistema funcional
// ============================================================
setTimeout(() => {
  console.log("üß© Iniciando reparaci√≥n avanzada del asistente visual...");

  // 1Ô∏è‚É£ Eliminar input flotante duplicado si existe
  const externalInput = document.querySelector('body > input.assistant-input');
  const externalButton = document.querySelector('body > button.assistant-send');
  if (externalInput || externalButton) {
    console.log("üßπ Eliminando input externo duplicado...");
    externalInput?.remove();
    externalButton?.remove();
  }

  // 2Ô∏è‚É£ Detectar el input y bot√≥n internos del chat flotante
  function connectInternalAssistant() {
    const internalInput = document.querySelector('#systemAssistant input#assistantInput');
    const internalButton = document.querySelector('#systemAssistant button:not([onclick*="toggleAssistant"])');

    if (!internalInput || !internalButton) {
      console.warn("‚è≥ A√∫n no se encontr√≥ el input/bot√≥n interno, reintentando...");
      return false;
    }

    console.log("‚úÖ Asistente interno detectado correctamente.");

    // 3Ô∏è‚É£ Conectar tecla Enter al input
    internalInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const text = internalInput.value.trim();
        if (!text) return;
        console.log("üí¨ Enviando desde input interno:", text);
        internalInput.value = '';
        processAssistantInput(text);
      }
    });

    // 4Ô∏è‚É£ Conectar click al bot√≥n ‚û§
    internalButton.addEventListener('click', (e) => {
      e.preventDefault();
      const text = internalInput.value.trim();
      if (!text) return;
      console.log("üí¨ Enviando desde bot√≥n interno:", text);
      internalInput.value = '';
      processAssistantInput(text);
    });

    console.log("üöÄ Asistente visual completamente operativo ‚úÖ");
    return true;
  }

  // 5Ô∏è‚É£ Intentar conexi√≥n varias veces (por si el asistente se renderiza tarde)
  let tries = 0;
  const maxTries = 10;
  const interval = setInterval(() => {
    if (connectInternalAssistant()) {
      clearInterval(interval);
    } else if (++tries >= maxTries) {
      clearInterval(interval);
      console.error("‚ùå No se pudo conectar el asistente interno tras varios intentos.");
    }
  }, 1000);
}, 4000);


// ============================================================
// üïí Renderizador de la vista "Asignaci√≥n de Horas"
// ============================================================
function renderTimeAllocationView() {
    console.log('üïí Mostrando vista de asignaci√≥n de horas...');

    // ‚úîÔ∏è filtros (solo la primera vez, gracias al cambio 1)
    populateTimeAllocationFilters();

    // ‚úîÔ∏è datos (SIEMPRE)
    loadTimeAllocationData();
}




// === CREAR NUEVA TAREA CON PREDICCI√ìN AI + ML ===
async function createTaskWithPrediction(taskData) {
  try {
    const task = {
      id: Date.now(),
      name: taskData.name?.trim() || 'Nueva tarea',
      description: taskData.description || '',
      priority: taskData.priority || 'media',
      subtasks: taskData.subtasks || [],
      dependencies: taskData.dependencies || [],
      startDate: taskData.startDate || new Date().toISOString(),
      deadline: taskData.deadline || null,
      status: 'pendiente',
      assignee: taskData.assignee || '',
      estimatedTime: 0,
      predictedBy: ''
    };

    // üîç Predicci√≥n IA y ML
    let aiEstimate = 0;
    if (typeof AIAssistant !== 'undefined' && typeof AIAssistant.estimateTime === 'function') {
      aiEstimate = Number(AIAssistant.estimateTime(task)) || 0;
    }

    let mlEstimate = null;
    if (typeof predictTaskDuration === 'function' && window.durationModel) {
      mlEstimate = await predictTaskDuration(task);
    }

    if (mlEstimate && !isNaN(mlEstimate)) {
      task.estimatedTime = (aiEstimate > 0)
        ? (aiEstimate * 0.4 + mlEstimate * 0.6)
        : mlEstimate;
      task.predictedBy = 'ML (modelo aprendido)';
    } else if (aiEstimate > 0) {
      task.estimatedTime = aiEstimate;
      task.predictedBy = 'AI Assistant (heur√≠stico)';
    } else {
      task.estimatedTime = 1;
      task.predictedBy = 'default';
    }

    // üîÑ Guardar y renderizar usando el proyecto activo
    if (!projects[currentProjectIndex]) {
      console.warn('‚ö†Ô∏è No hay proyecto activo, creando uno temporal...');
      projects[currentProjectIndex] = { tasks: [] };
    }

    projects[currentProjectIndex].tasks.push(task);

    // Guardar cambios
    if (typeof saveProject === 'function') {
      saveProject();
    }

    // Actualizar el Gantt
    if (typeof renderGanttChart === 'function') {
      renderGanttChart(projects[currentProjectIndex]);
    }

    // üí¨ Notificaci√≥n visual
    if (window.showNotification) {
      window.showNotification(
        `‚ú® Estimaci√≥n autom√°tica para "${task.name}": ${task.estimatedTime} h (${task.predictedBy})`
      );
    }
    console.log(`Predicci√≥n para "${task.name}": ${task.estimatedTime}h (${task.predictedBy})`);
  } catch (err) {
    console.error('Error creando tarea con predicci√≥n:', err);
  }
}


// === IA B√ÅSICA DE ESTIMACI√ìN DE TIEMPO ===
window.AIAssistant = {
  estimateTime(task) {
    const text = (task.name + ' ' + (task.description || '')).toLowerCase();
    let hours = 1;
    if (text.includes('api')) hours += 4;
    if (text.includes('dashboard')) hours += 3;
    if (text.includes('dise√±o')) hours += 2;
    if (text.includes('integrar')) hours += 2;
    if (text.includes('backend')) hours += 3;
    if (task.priority === 'alta') hours += 1;
    return hours;
  }
};

// === M√ìDULO DE MACHINE LEARNING SIMPLE ===
window.predictTaskDuration = async function (task) {
  if (!window.durationModel) {
    console.warn('‚ö†Ô∏è Modelo ML no entrenado, usando heur√≠stica');
    return 0;
  }
  const input = tf.tensor2d([
    [task.name.length / 10, (task.description || '').length / 50, task.priority === 'alta' ? 1 : 0]
  ]);
  const output = window.durationModel.predict(input);
  const value = (await output.data())[0];
  input.dispose(); output.dispose();
  return Math.max(1, Math.round(value));
};

// Entrenador b√°sico (usa TensorFlow.js)
window.trainDurationModel = async function () {
  console.log('üöÄ Entrenando modelo ML con datos simulados...');
  const xs = tf.tensor2d([[1, 0, 0], [5, 2, 1], [3, 1, 0], [4, 3, 1]]);
  const ys = tf.tensor2d([[2], [6], [3], [7]]);
  const model = tf.sequential();
  model.add(tf.layers.dense({ units: 8, activation: 'relu', inputShape: [3] }));
  model.add(tf.layers.dense({ units: 1 }));
  model.compile({ optimizer: 'adam', loss: 'meanSquaredError' });
  await model.fit(xs, ys, { epochs: 50 });
  window.durationModel = model;
  console.log('‚úÖ Modelo ML entrenado');
};


// === AUTO-APRENDIZAJE BASADO EN DATOS REALES ===

// Guardar hist√≥rico de tareas con duraci√≥n real
window.taskHistory = JSON.parse(localStorage.getItem('taskHistory') || '[]');

// Registrar tarea completada para reentrenar
window.logCompletedTask = function (task) {
  if (!task || !task.name) return;
  const duration = Number(task.actualDuration || task.estimatedTime || 1);
  window.taskHistory.push({
    nameLength: task.name.length / 10,
    descLength: (task.description || '').length / 50,
    priorityNum: task.priority === 'alta' ? 1 : 0,
    duration: duration
  });
  localStorage.setItem('taskHistory', JSON.stringify(window.taskHistory));
  console.log(`üß© Tarea registrada para autoaprendizaje (${window.taskHistory.length} ejemplos)`);
};

// Reentrenar el modelo ML con tu hist√≥rico real
window.retrainDurationModel = async function () {
  if (!window.taskHistory || window.taskHistory.length < 4) {
    console.warn('‚ö†Ô∏è No hay suficientes datos reales para reentrenar todav√≠a.');
    return;
  }

  console.log('üîÅ Reentrenando modelo ML con datos reales...');
  const xs = tf.tensor2d(window.taskHistory.map(t => [t.nameLength, t.descLength, t.priorityNum]));
  const ys = tf.tensor2d(window.taskHistory.map(t => [t.duration]));
  
  const model = tf.sequential();
  model.add(tf.layers.dense({ units: 8, activation: 'relu', inputShape: [3] }));
  model.add(tf.layers.dense({ units: 1 }));
  model.compile({ optimizer: 'adam', loss: 'meanSquaredError' });
  
  await model.fit(xs, ys, { epochs: 100 });
  window.durationModel = model;
  xs.dispose(); ys.dispose();

  console.log('‚úÖ Modelo ML reentrenado con datos reales');
if (window.showNotification) {
  window.showNotification('üß† Modelo actualizado con tus datos reales');
}

};

// Auto-reentrenamiento autom√°tico cada 5 tareas nuevas
window.checkAutoRetrain = function () {
  const count = window.taskHistory.length;
  if (count > 0 && count % 5 === 0) {
    console.log('ü§ñ Entradas suficientes, auto-reentrenando...');
    retrainDurationModel();
  }
};

// === PANEL DE INTELIGENCIA (IA DASHBOARD v6: modo colapsado con icono animado) ===
// === PANEL DE INTELIGENCIA (IA DASHBOARD v6: modo colapsado con icono animado) ===
function calcularPrecisionModelo() {
  const history = window.taskHistory || [];
  if (history.length === 0) return 0;

  let totalPrecision = 0;
  history.forEach(t => {
    const estimado = Number(t.estimatedTime || 1);
    const real = Number(t.actualDuration || estimado);
    if (real > 0) {
      const error = Math.abs(real - estimado);
      const precision = Math.max(0, 1 - error / real);
      totalPrecision += precision;
    }
  });
  return Math.round((totalPrecision / history.length) * 100);
}

function renderIADashboard() {
  let panel = document.getElementById('ia-dashboard');
  let badge = document.getElementById('ia-badge');

  if (!panel) {
    // === Panel principal oculto ===
    panel = document.createElement('div');
    panel.id = 'ia-dashboard';
    panel.style.position = 'fixed';
    panel.style.bottom = '-220px';
    panel.style.left = '50%';
    panel.style.transform = 'translateX(-50%)';
    panel.style.padding = '14px 20px';
    panel.style.color = 'white';
    panel.style.fontFamily = 'system-ui, sans-serif';
    panel.style.fontSize = '13px';
    panel.style.borderRadius = '14px 14px 0 0';
    panel.style.boxShadow = '0 0 15px rgba(0,0,0,0.4)';
    panel.style.zIndex = '9999';
    panel.style.textAlign = 'center';
    panel.style.minWidth = '280px';
    panel.style.background = 'rgba(0,0,0,0.85)';
    panel.style.transition = 'bottom 0.6s ease, opacity 0.4s ease';
    panel.style.opacity = '0';
    document.body.appendChild(panel);

    // === Badge IA minimalista ===
    badge = document.createElement('div');
    badge.id = 'ia-badge';
    badge.innerHTML = 'üß†';
    badge.title = 'Mostrar IA Dashboard';
    badge.style.position = 'fixed';
    badge.style.bottom = '10px';
    badge.style.left = '50%';
    badge.style.transform = 'translateX(-50%)';
    badge.style.width = '42px';
    badge.style.height = '42px';
    badge.style.borderRadius = '50%';
    badge.style.background = 'linear-gradient(145deg, #0f2027, #203a43, #2c5364)';
    badge.style.color = 'white';
    badge.style.display = 'flex';
    badge.style.alignItems = 'center';
    badge.style.justifyContent = 'center';
    badge.style.fontSize = '20px';
    badge.style.boxShadow = '0 0 10px rgba(0,0,0,0.4)';
    badge.style.cursor = 'pointer';
    badge.style.transition = 'all 0.3s ease';
    badge.style.zIndex = '9999';
    document.body.appendChild(badge);

    // === Animaci√≥n sutil del icono ===
    badge.animate(
      [
        { transform: 'translateX(-50%) scale(1)' },
        { transform: 'translateX(-50%) scale(1.15)' },
        { transform: 'translateX(-50%) scale(1)' }
      ],
      { duration: 3000, iterations: Infinity }
    );

    // === Mostrar / ocultar panel con hover ===
    badge.addEventListener('mouseenter', () => {
      panel.style.bottom = '0px';
      panel.style.opacity = '1';
      badge.style.opacity = '0';
    });
    panel.addEventListener('mouseleave', () => {
      panel.style.bottom = '-200px';
      panel.style.opacity = '0';
      badge.style.opacity = '1';
    });
  }

  // === Datos del modelo ===
  const examples = window.taskHistory?.length || 0;
  const lastRetrain = localStorage.getItem('lastRetrainDate') || 'Nunca';
  const modelStatus = window.durationModel ? 'üß† ML activo' : '‚öôÔ∏è Heur√≠stico';
  const precision = calcularPrecisionModelo();

  // === Color de la barra ===
  let barColor = '#ff3b3b';
  if (precision >= 85) barColor = '#4caf50';
  else if (precision >= 65) barColor = '#ffb300';

  // === Contenido HTML del panel ===
  panel.innerHTML = `
    <div style="font-weight:bold;font-size:14px;margin-bottom:6px;">IA Dashboard</div>
    <div>üìö Ejemplos aprendidos: <b>${examples}</b></div>
    <div>üéØ Precisi√≥n actual: <b>${precision}%</b></div>
    <div style="width:100%;background:rgba(255,255,255,0.1);height:8px;border-radius:6px;margin:6px 0;overflow:hidden;position:relative;">
      <div id="ia-bar" style="
        width:${precision}%;
        height:8px;
        background:${barColor};
        border-radius:6px;
        position:relative;
        transition:width 0.5s ease, background 0.5s ease;
        overflow:hidden;
      ">
        <div style="
          position:absolute;
          top:0;
          left:-40%;
          width:40%;
          height:100%;
          background:linear-gradient(90deg, transparent, rgba(255,255,255,0.7), transparent);
          animation: iaShine 1.8s linear infinite;
        "></div>
      </div>
    </div>
    <div>‚è∞ √öltimo reentrenamiento: <b>${lastRetrain}</b></div>
    <div>ü§ñ Modelo actual: <b>${modelStatus}</b></div>
  `;

  // === Agregar animaci√≥n global si no existe ===
  if (!document.getElementById('ia-style')) {
    const style = document.createElement('style');
    style.id = 'ia-style';
    style.innerHTML = `
      @keyframes iaShine {
        0% { left: -40%; }
        100% { left: 100%; }
      }
    `;
    document.head.appendChild(style);
  }
}

// === Refrescar cada 5 segundos ===
setInterval(renderIADashboard, 5000);

// === Hook de reentrenamiento ===
const oldRetrain = window.retrainDurationModel;
window.retrainDurationModel = async function() {
  await oldRetrain();
  const date = new Date().toLocaleString('es-ES');
  localStorage.setItem('lastRetrainDate', date);
  renderIADashboard();
  if (window.showNotification) {
    window.showNotification(`üß† Modelo actualizado con tus datos reales (${date})`);
  }
};


// === üîß Reparaci√≥n de botones principales ===
window.addEventListener('load', () => {
  console.log('üß© Reforzando botones cr√≠ticos...');

  // 1Ô∏è‚É£ Bot√≥n de men√∫ (toggleSidebar)
  const menuBtn = document.querySelector('#toggleSidebarBtn');
  if (menuBtn) {
    menuBtn.addEventListener('click', e => {
      e.preventDefault();
      const sidebar = document.querySelector('aside');
      if (sidebar) {
        sidebar.classList.toggle('hidden');
        console.log('üìÇ Men√∫ lateral alternado manualmente');
      }
    });
  } else {
    console.warn('‚ö†Ô∏è No se encontr√≥ bot√≥n de men√∫ (#toggleSidebarBtn)');
  }

  // 2Ô∏è‚É£ Bot√≥n Guardar
  const saveBtn = document.querySelector('button.btn-save');
  if (saveBtn) {
    saveBtn.addEventListener('click', e => {
      e.preventDefault();
      e.stopPropagation();
      console.log('üíæ Click en Guardar tarea detectado');

      try {
        if (typeof createNewTask === 'function') {
          createNewTask(e); // pasa el evento
        } else if (typeof saveTaskChanges === 'function') {
          saveTaskChanges(e);
        } else {
          console.warn('‚ö†Ô∏è Ninguna funci√≥n de guardado encontrada');
        }
      } catch (err) {
        console.error('‚ùå Error al intentar guardar tarea:', err);
      }
    });
  } else {
    console.warn('‚ö†Ô∏è No se encontr√≥ bot√≥n Guardar (.btn-save)');
  }

  // 3Ô∏è‚É£ Bot√≥n Cancelar
  const cancelBtn = document.querySelector('#cancelTaskBtn');
  if (cancelBtn) {
    cancelBtn.addEventListener('click', e => {
      e.preventDefault();
      e.stopPropagation();
      const form = document.querySelector('#newTaskForm, .task-form');
      if (form) form.style.display = 'none';
      console.log('‚ùå Formulario de nueva tarea cerrado');
    });
  } else {
    console.warn('‚ö†Ô∏è No se encontr√≥ bot√≥n Cancelar (#cancelTaskBtn)');
  }

  // 4Ô∏è‚É£ Drag & Drop ‚Äî reactivar si est√° deshabilitado
  if (typeof initDragAndDrop === 'function') {
    initDragAndDrop();
    console.log('üéØ Drag & Drop reactivado manualmente');
  }
});




// === üß© REPARACI√ìN SUAVE DE BOTONES Y DRAG&DROP ===
setTimeout(() => {
  console.log('üß© Reenganchando botones de tarea y drag & drop (modo seguro)...');

  // 1Ô∏è‚É£ BOT√ìN GUARDAR TAREA
  const saveBtn = document.querySelector('.btn-save, #saveTaskButton');
  if (saveBtn) {
    saveBtn.addEventListener('click', e => {
      e.preventDefault();
      console.log('üíæ Guardar tarea clic detectado');
      if (typeof createNewTask === 'function') {
        try {
          createNewTask(e);
          console.log('‚úÖ createNewTask ejecutado correctamente');
        } catch (err) {
          console.error('‚ùå Error en createNewTask:', err);
        }
      } else {
        console.warn('‚ö†Ô∏è Funci√≥n createNewTask no encontrada');
      }
    });
    console.log('‚úÖ Bot√≥n Guardar reenganchado');
  } else {
    console.warn('‚ö†Ô∏è Bot√≥n Guardar no encontrado');
  }

  // 2Ô∏è‚É£ BOT√ìN CANCELAR TAREA
  const cancelBtn = document.querySelector('#cancelTaskBtn, .cancel-btn');
  if (cancelBtn) {
    cancelBtn.addEventListener('click', e => {
      e.preventDefault();
      console.log('‚ùå Cancelar tarea clic detectado');
      const form = document.querySelector('#taskForm') || cancelBtn.closest('form');
      if (form) form.reset();
      else console.warn('‚ö†Ô∏è No se encontr√≥ formulario de tarea');
    });
    console.log('‚úÖ Bot√≥n Cancelar reenganchado');
  } else {
    console.warn('‚ö†Ô∏è Bot√≥n Cancelar no encontrado');
  }

  // 3Ô∏è‚É£ DRAG & DROP
  if (typeof initDragAndDrop === 'function') {
    try {
      initDragAndDrop();
      console.log('üéØ Drag & Drop restaurado correctamente');
    } catch (err) {
      console.error('‚ùå Error al restaurar Drag & Drop:', err);
    }
  } else {
    console.warn('‚ö†Ô∏è Funci√≥n initDragAndDrop no encontrada');
  }

  // 4Ô∏è‚É£ MENSAJE DE √âXITO
  const msg = document.createElement('div');
  msg.textContent = '‚úÖ Eventos restaurados (modo seguro)';
  Object.assign(msg.style, {
    position: 'fixed',
    bottom: '20px',
    left: '50%',
    transform: 'translateX(-50%)',
    background: '#27ae60',
    color: '#fff',
    padding: '10px 20px',
    borderRadius: '10px',
    fontWeight: 'bold',
    zIndex: 9999,
    boxShadow: '0 2px 6px rgba(0,0,0,0.3)',
  });
  document.body.appendChild(msg);
  setTimeout(() => msg.remove(), 3000);

}, 2500);


// === üß© PARCHE DE KANBAN INTELIGENTE ===
setTimeout(() => {
  console.log('üß© Parcheando renderKanbanTasks para adaptarlo a tus IDs...');

  // Guarda la funci√≥n original si existe
  if (typeof renderKanbanTasks === 'function' && !window._kanbanPatched) {
    const originalRenderKanban = renderKanbanTasks;

    window.renderKanbanTasks = function (tasks) {
      try {
        // Verificar que los contenedores existan
        const todo = document.querySelector('#todo, #pendingTasks, #pendientes');
        const inProgress = document.querySelector('#in-progress, #inProgressTasks, #enProgreso, #inProgressList');
        const done = document.querySelector('#done, #completedTasks, #completadas');

        // Si alguno falta, crearlo din√°micamente sin romper dise√±o
        const board = document.querySelector('#boardView, .kanban-board, main') || document.body;

        if (!todo) {
          const col = document.createElement('div');
          col.id = 'todo';
          col.className = 'kanban-column';
          col.innerHTML = `<h3>Pendientes</h3>`;
          board.appendChild(col);
          console.warn('‚ö†Ô∏è Columna "todo" creada din√°micamente');
        }

        if (!inProgress) {
          const col = document.createElement('div');
          col.id = 'in-progress';
          col.className = 'kanban-column';
          col.innerHTML = `<h3>En progreso</h3>`;
          board.appendChild(col);
          console.warn('‚ö†Ô∏è Columna "in-progress" creada din√°micamente');
        }

        if (!done) {
          const col = document.createElement('div');
          col.id = 'done';
          col.className = 'kanban-column';
          col.innerHTML = `<h3>Completadas</h3>`;
          board.appendChild(col);
          console.warn('‚ö†Ô∏è Columna "done" creada din√°micamente');
        }

        // Llamar a la funci√≥n original con seguridad
        console.log('‚úÖ Ejecutando renderKanbanTasks corregido...');
        return originalRenderKanban(tasks);

      } catch (err) {
        console.error('‚ùå Error en renderKanbanTasks parcheado:', err);
      }
    };

    window._kanbanPatched = true;
    console.log('‚úÖ Parche aplicado con √©xito');
  } else {
    console.warn('‚ö†Ô∏è renderKanbanTasks no encontrado o ya parcheado');
  }

}, 1500);




// === SISTEMA DE RESPALDO PERMANENTE ===

function downloadBackup() {
    console.log('üíæ Iniciando descarga de respaldo...');
    
    const backupData = {
        projects: projects,
        currentProjectIndex: currentProjectIndex,
        timestamp: new Date().toISOString(),
        version: '1.0'
    };
    
    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `respaldo-proyectos-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    console.log('‚úÖ Respaldo descargado correctamente');
    showNotification('‚úÖ Respaldo descargado correctamente');
}

function uploadBackup() {
    console.log('üì§ Solicitando archivo de respaldo...');
    
    // Usar el fileInput SEPARADO para respaldos
    const backupInput = document.getElementById('backupUpload');
    if (backupInput) {
        // Configurar el listener para respaldos
        backupInput.onchange = function(event) {
            const file = event.target.files[0];
            if (!file) {
                console.log('‚ùå No se seleccion√≥ archivo de respaldo');
                return;
            }
            
            console.log('üìÇ Procesando respaldo:', file.name);
            handleBackupFile(file);
            
            // Limpiar el input para permitir seleccionar el mismo archivo otra vez
            event.target.value = '';
        };
        
        // Abrir el selector de archivos
        backupInput.click();
    } else {
        console.error('‚ùå Input de respaldo no encontrado');
        showNotification('‚ùå Error: Elemento de carga de respaldo no encontrado');
    }
}

function handleBackupFile(fileOrEvent) {
    // Manejar tanto event como file directamente
    const file = fileOrEvent.target ? fileOrEvent.target.files[0] : fileOrEvent;
    
    if (!file) {
        console.log('‚ùå No se seleccion√≥ archivo');
        return;
    }

    console.log('üîÑ handleBackupFile ejecut√°ndose con:', file.name);
    
    // SOLO procesar si es un archivo JSON de respaldo
    if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
        console.log('üìé Archivo ignorado por handleBackupFile (no es JSON):', file.name);
        showNotification('‚ÑπÔ∏è Para adjuntar archivos a tareas, use el formulario de nueva tarea');
        return;
    }
    
    // Solo procesar archivos JSON (respaldos)
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            console.log('üìñ Leyendo archivo de respaldo JSON...');
            const backupData = JSON.parse(e.target.result);
            console.log('‚úÖ Respaldo cargado correctamente');
            
            // Aqu√≠ va el c√≥digo para procesar respaldos
            if (backupData.projects && Array.isArray(backupData.projects)) {
                projects = backupData.projects;
                currentProjectIndex = backupData.currentProjectIndex || 0;
                updateLocalStorage();
                renderProjects();
                selectProject(currentProjectIndex);
                showNotification('‚úÖ Respaldo restaurado exitosamente');
            } else {
                showNotification('‚ùå El archivo no contiene datos de respaldo v√°lidos');
            }
            
        } catch (error) {
            console.error('‚ùå Error cargando respaldo:', error);
            showNotification('‚ùå El archivo seleccionado no es un respaldo v√°lido');
        }
    };
    
    reader.onerror = function(error) {
        console.error('‚ùå Error leyendo archivo:', error);
        showNotification('‚ùå Error al leer el archivo');
    };
    
    reader.readAsText(file);
}
// === CONEXI√ìN AUTOM√ÅTICA AL CARGAR LA P√ÅGINA ===
document.addEventListener('DOMContentLoaded', function() {
    // Esperar a que los elementos est√©n disponibles
    setTimeout(() => {
        const downloadBtn = document.getElementById('backupToLocal');
        const uploadBtn = document.getElementById('restoreFromLocal');
        const fileInput = document.getElementById('fileUpload');
        
        if (downloadBtn) downloadBtn.onclick = downloadBackup;
        if (uploadBtn) uploadBtn.onclick = uploadBackup;
        if (fileInput) fileInput.onchange = handleBackupFile;
        
        console.log('üîß Sistema de respaldo conectado autom√°ticamente');
    }, 1000);
});



// === SOLUCI√ìN DEFINITIVA BOT√ìN MEN√ö - PEGAR AL FINAL DEL ARCHIVO ===
function replaceMenuButtonCode() {
    console.group('üéØ REEMPLAZANDO C√ìDIGO DEL BOT√ìN MEN√ö');
    
    // Buscar y eliminar cualquier c√≥digo existente del bot√≥n men√∫
    const menuBtn = document.getElementById('toggleSidebarBtn');
    if (!menuBtn) {
        console.error('‚ùå Bot√≥n men√∫ no encontrado');
        return;
    }
    
    // Reemplazar completamente el bot√≥n
    const newMenuBtn = document.createElement('button');
    newMenuBtn.id = 'toggleSidebarBtn';
    newMenuBtn.className = 'blue-btn';
    newMenuBtn.innerHTML = '‚ò∞ Men√∫';
    newMenuBtn.title = 'Mostrar/Ocultar men√∫ lateral';
    
    // Reemplazar en el DOM
    menuBtn.parentNode.replaceChild(newMenuBtn, menuBtn);
    
    // CONEXI√ìN INDESTRUCTIBLE
    const finalMenuBtn = document.getElementById('toggleSidebarBtn');
    const sidebar = document.querySelector('aside');
    
    // Listener principal con m√∫ltiples protecciones
    finalMenuBtn.addEventListener('click', function menuClickHandler() {
        console.log('üéØ Bot√≥n men√∫ clickeado - Versi√≥n indestructible');
        
        if (!sidebar) {
            console.error('‚ùå Sidebar no encontrado');
            return;
        }
        
        // 1. Alternar visibilidad
        const isHidden = sidebar.classList.contains('hidden');
        sidebar.classList.toggle('hidden');
        console.log(`üìã Sidebar ${isHidden ? 'mostrado' : 'ocultado'}`);
        
        // 2. Sincronizar elementos dependientes
        setTimeout(() => {
            // Sincronizar l√≠neas
            if (typeof syncLinesWithSidebar === 'function') {
                syncLinesWithSidebar();
            }
            
            // Re-renderizar Gantt si es necesario
            if (!ganttView.classList.contains('hidden') && typeof renderGanttChart === 'function') {
                const ganttTasks = projects[currentProjectIndex]?.tasks || [];
                renderGanttChart(ganttTasks);
            }
            
            // Forzar reflow para asegurar actualizaci√≥n
            sidebar.offsetHeight;
        }, 150);
        
       // 3. Protecci√≥n simple - siempre funciona
setTimeout(() => {
    // Esta versi√≥n no necesita getEventListeners
    // El listener ya est√° conectado permanentemente
    console.log('‚úÖ Bot√≥n men√∫ verificado - funcionando correctamente');
}, 500);
    });
    
    // PROTECCI√ìN EXTRA - Reconexi√≥n autom√°tica
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                // Si el bot√≥n cambia, reconectar
                setTimeout(() => {
                    if (!getEventListeners(finalMenuBtn)?.click?.length) {
                        console.log('üîÑ Reconectando bot√≥n men√∫ despu√©s de cambio...');
                        finalMenuBtn.addEventListener('click', menuClickHandler);
                    }
                }, 100);
            }
        });
    });
    
    observer.observe(finalMenuBtn, { attributes: true });
    
    console.log('‚úÖ Bot√≥n men√∫ reemplazado con protecci√≥n m√°xima');
    console.log('   - Listener principal conectado');
    console.log('   - Observer de cambios activado');
    console.log('   - Autoreparaci√≥n configurada');
    console.groupEnd();
}

// === EJECUCI√ìN AUTOM√ÅTICA AL CARGAR ===
document.addEventListener('DOMContentLoaded', function() {
    // Esperar a que todo cargue y luego activar el bot√≥n men√∫
    setTimeout(() => {
        console.log('üöÄ Activando bot√≥n men√∫ indestructible...');
        replaceMenuButtonCode();
    }, 2000);
});

// === TAMBI√âN ACTIVAR DESPU√âS DE CIERTOS EVENTOS ===
// Activar despu√©s de cambios importantes en la interfaz
['load', 'resize', 'popstate'].forEach(event => {
    window.addEventListener(event, function() {
        setTimeout(replaceMenuButtonCode, 1000);
    });
});



// Funci√≥n global para reactivar manualmente si es necesario
window.fixMenuButton = function() {
    console.log('üîß Reactivando bot√≥n men√∫ manualmente...');
    replaceMenuButtonCode();
};

// Tambi√©n puedes llamarlo desde consola en cualquier momento: fixMenuButton()





/*******************************************************
 * üî• SISTEMA DE SINCRONIZACI√ìN MEJORADO - VERSI√ìN COMPACTA
 *******************************************************/

// Sistema de sincronizaci√≥n entre pesta√±as
function initSyncSystem() {
    console.log('üîÑ Iniciando sistema de sincronizaci√≥n...');
    
    // Escuchar cambios en el localStorage entre pesta√±as
    window.addEventListener('storage', function(e) {
        if (e.key === 'projects' && e.newValue) {
            console.log('üì• Cambio detectado en otra pesta√±a, sincronizando...');
            try {
                const newProjects = JSON.parse(e.newValue);
                if (Array.isArray(newProjects) && newProjects.length > 0) {
                    projects = newProjects;
                    renderKanbanTasks();
                    updateStatistics();
                    showNotification('‚úÖ Datos actualizados desde otra pesta√±a');
                }
            } catch (error) {
                console.error('Error sincronizando datos:', error);
            }
        }
    });
    
    // Sincronizaci√≥n autom√°tica cada 5 segundos
    setInterval(() => {
        localStorage.setItem('projects', JSON.stringify(projects));
        localStorage.setItem('lastSync', Date.now().toString());
    }, 5000);
    
    console.log('‚úÖ Sistema de sincronizaci√≥n activado');
}

// WebSockets mejorados
function initWebSocketEnhanced() {
    try {
        console.log('üöÄ Iniciando WebSocket mejorado...');
        
        if (window.authMode !== 'backend') {
            console.log('üîí Modo local - Sin WebSockets');
            return;
        }
        
        if (typeof io === 'undefined') {
            console.log('üìö Cargando Socket.io...');
            const script = document.createElement('script');
            script.src = 'https://cdn.socket.io/4.5.0/socket.io.min.js';
            script.onload = () => {
                console.log('‚úÖ Socket.io cargado');
                connectWebSocket();
            };
            document.head.appendChild(script);
        } else {
            connectWebSocket();
        }
        
        function connectWebSocket() {
            if (window.tiempoRealSocket) {
                window.tiempoRealSocket.disconnect();
            }
            
            window.tiempoRealSocket = io('https://mi-sistema-proyectos-backend-4.onrender.com', {
                transports: ['websocket', 'polling']
            });
            
            window.tiempoRealSocket.on('connect', function() {
                console.log('‚úÖ WebSocket conectado');
            });
            
            window.tiempoRealSocket.on('task-updated', function(data) {
                console.log('üîÑ Evento recibido:', data);
                if (typeof refreshCurrentView === 'function') {
                    refreshCurrentView();
                }
            });
            
            window.tiempoRealSocket.on('disconnect', function() {
                console.log('üîå WebSocket desconectado');
            });
        }
        
    } catch (error) {
        console.error('‚ùå Error en WebSocket:', error);
    }
}


// Sincronizaci√≥n manual
function forceSync() {
    console.log('üîß Forzando sincronizaci√≥n...');
    localStorage.setItem('projects', JSON.stringify(projects));
    if (typeof renderKanbanTasks === 'function') renderKanbanTasks();
    if (typeof updateStatistics === 'function') updateStatistics();
    showNotification('‚úÖ Sincronizaci√≥n manual completada');
}

// Inicializar despu√©s de que todo est√© listo
setTimeout(() => {
    initSyncSystem();
    
    // Iniciar WebSockets si est√° en modo backend
    if (window.authMode === 'backend') {
        setTimeout(initWebSocketEnhanced, 2000);
    }
}, 3000);

// Comandos de consola
window.forceSync = forceSync;
window.restartWebSockets = initWebSocketEnhanced;

console.log('üéØ Sistema de sincronizaci√≥n cargado - Usa forceSync() en consola');





// =============================================
// BARRA DE PROGRESO DE SUBTAREAS - OBSERVER
// =============================================

function initializeProgressBarsObserver() {
  
    
    // Observar cambios en las columnas del Kanban
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                // Verificar si se agregaron task-cards
                let hasTaskCards = false;
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1 && node.classList && node.classList.contains('task-card')) {
                        hasTaskCards = true;
                    }
                });
                
                if (hasTaskCards) {
                    console.log('üîÑ Se detectaron nuevas task-cards, agregando barras de progreso...');
                    setTimeout(addProgressBarsToAllTasks, 100);
                }
            }
        });
    });
    
    // Configurar observer para las columnas
    const pendingCol = document.getElementById('pendingList');
    const inProgressCol = document.getElementById('inProgressList');
    const completedCol = document.getElementById('completedList');
    const overdueCol = document.getElementById('overdueList');
    
    if (pendingCol && inProgressCol && completedCol && overdueCol) {
        const config = { childList: true, subtree: false };
        observer.observe(pendingCol, config);
        observer.observe(inProgressCol, config);
        observer.observe(completedCol, config);
        observer.observe(overdueCol, config);
        console.log('‚úÖ Observers configurados en todas las columnas');
        
        // Ejecutar una vez inicialmente
        setTimeout(addProgressBarsToAllTasks, 500);
    } else {
        console.log('‚è≥ Columnas no disponibles, reintentando...');
        setTimeout(initializeProgressBarsObserver, 1000);
    }
}

function addProgressBarsToAllTasks() {
    console.log('üìä BUSCANDO TAREAS CON SUBTAREAS...');
    
    if (typeof projects === 'undefined' || typeof currentProjectIndex === 'undefined') {
        console.log('‚ùå No hay proyectos disponibles');
        return;
    }
    
    const project = projects[currentProjectIndex];
    if (!project || !project.tasks) {
        console.log('‚ùå No hay tareas en el proyecto');
        return;
    }
    
    // Contador de barras agregadas
    let barsAdded = 0;
    
    project.tasks.forEach(task => {
        if (task.subtasks && task.subtasks.length > 0) {
            if (addProgressToTask(task.name)) {
                barsAdded++;
            }
        }
    });
    
    console.log(`‚úÖ Se agregaron ${barsAdded} barras de progreso`);
}

function addProgressToTask(taskName) {
    const taskCards = document.querySelectorAll('.task-card');
    let taskFound = false;
    
    taskCards.forEach((card) => {
        const titleElement = card.querySelector('.task-title');
        if (titleElement && titleElement.textContent.includes(taskName)) {
            taskFound = true;
            
            // Verificar si ya tiene barra de progreso
            if (card.querySelector('.subtasks-progress-container')) {
                return false;
            }
            
            const cardBody = card.querySelector('.task-card-body');
            if (cardBody) {
                const project = projects[currentProjectIndex];
                const task = project.tasks.find(t => t.name === taskName);
                
                if (task && task.subtasks && task.subtasks.length > 0) {
                    const completedSubtasks = task.subtasks.filter(subtask => 
                        subtask.completed || subtask.status === 'completed'
                    ).length;
                    const totalSubtasks = task.subtasks.length;
                    const progressPercentage = Math.round((completedSubtasks / totalSubtasks) * 100);
                    
                    // Crear barra de progreso CON ORDEN CORRECTO
                    const progressHTML = `
                        <div class="subtasks-progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                            </div>
                            <div class="progress-info">
                                <span class="progress-text">${completedSubtasks}/${totalSubtasks} subtareas</span>
                                <span class="progress-percentage">${progressPercentage}%</span>
                            </div>
                        </div>
                    `;
                    
                    // Insertar ANTES de los badges (posici√≥n correcta)
                    const badgesContainer = cardBody.querySelector('.badges-container');
                    if (badgesContainer) {
                        badgesContainer.insertAdjacentHTML('beforebegin', progressHTML);
                    } else {
                        // Si no hay badges, insertar despu√©s del asignado o al final
                        const assigneeElement = cardBody.querySelector('.task-assignee');
                        if (assigneeElement) {
                            assigneeElement.insertAdjacentHTML('afterend', progressHTML);
                        } else {
                            cardBody.insertAdjacentHTML('beforeend', progressHTML);
                        }
                    }
                    
                    console.log(`‚úÖ Barra agregada a: "${taskName}" (${progressPercentage}%)`);
                    return true;
                }
            }
        }
    });
    
    return taskFound;
}
// Iniciar cuando la p√°gina est√© lista
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initializeProgressBarsObserver, 1000);
    });
} else {
    setTimeout(initializeProgressBarsObserver, 1000);
}

console.log('üöÄ M√ìDULO DE BARRAS DE PROGRESO CARGADO');



// =============================================
// SOLUCI√ìN CORREGIDA PARA MOVIMIENTO DE TAREAS
// =============================================

function initializeMoveButtonsCompleteSolution() {
    console.log('üéØ INICIANDO SOLUCI√ìN COMPLETA PARA MOVIMIENTO...');
    
    // Reemplazar completamente las funciones de movimiento
    window.moveTaskUp = function(taskId, status) {
        console.log(`‚¨ÜÔ∏è Moviendo tarea ${taskId} hacia arriba en ${status}...`);
        return moveTaskInArray(taskId, status, -1);
    };
    
    window.moveTaskDown = function(taskId, status) {
        console.log(`‚¨áÔ∏è Moviendo tarea ${taskId} hacia abajo en ${status}...`);
        return moveTaskInArray(taskId, status, 1);
    };
    
    console.log('‚úÖ FUNCIONES DE MOVIMIENTO RECONSTRUIDAS');
}

function moveTaskInArray(taskId, status, direction) {
    try {
        const project = projects[currentProjectIndex];
        if (!project || !project.tasks) {
            console.log('‚ùå No hay proyecto o tareas');
            return false;
        }
        
        // Obtener √≠ndices de todas las tareas del mismo status
        const statusIndices = [];
        project.tasks.forEach((task, index) => {
            if (task.status === status) {
                statusIndices.push(index);
            }
        });
        
        // Encontrar la posici√≥n de la tarea en el array de √≠ndices
        const taskIndexInProject = project.tasks.findIndex(task => task.id == taskId);
        const currentPositionInStatus = statusIndices.indexOf(taskIndexInProject);
        
        if (currentPositionInStatus === -1) {
            console.log('‚ùå Tarea no encontrada en el status:', status);
            return false;
        }
        
        // Calcular nueva posici√≥n
        const newPositionInStatus = currentPositionInStatus + direction;
        
        // Verificar l√≠mites de manera m√°s precisa
        if (direction === -1 && currentPositionInStatus === 0) {
            console.log('‚ö†Ô∏è No se puede mover arriba - ya est√° en la primera posici√≥n');
            return false;
        }
        
        if (direction === 1 && currentPositionInStatus === statusIndices.length - 1) {
            console.log('‚ö†Ô∏è No se puede mover abajo - ya est√° en la √∫ltima posici√≥n');
            return false;
        }
        
        console.log(`üìä Moviendo de posici√≥n ${currentPositionInStatus} a ${newPositionInStatus} en status ${status}`);
        
        // Reordenar las tareas
        const success = reorderProjectTasksCorrected(project, statusIndices, currentPositionInStatus, newPositionInStatus);
        
        if (success) {
            // Guardar cambios usando la funci√≥n correcta
            if (typeof saveProjects === 'function') {
                saveProjects();
            } else if (typeof saveData === 'function') {
                saveData();
            } else {
                console.log('‚ö†Ô∏è No se encontr√≥ funci√≥n de guardado, pero los cambios est√°n en memoria');
            }
            
            // Actualizar vista
            setTimeout(() => {
                if (typeof renderKanbanTasks === 'function') {
                    renderKanbanTasks();
                }
            }, 100);
            
            return true;
        }
        
        return false;
        
    } catch (error) {
        console.error('‚ùå Error en moveTaskInArray:', error);
        return false;
    }
}

function reorderProjectTasksCorrected(project, statusIndices, fromIndex, toIndex) {
    try {
        // Obtener los √≠ndices reales en el array project.tasks
        const fromRealIndex = statusIndices[fromIndex];
        const toRealIndex = statusIndices[toIndex];
        
        console.log(`üîÑ Moviendo de √≠ndice real ${fromRealIndex} a ${toRealIndex}`);
        
        // Remover la tarea de su posici√≥n actual
        const [movedTask] = project.tasks.splice(fromRealIndex, 1);
        
        // Insertar en la nueva posici√≥n
        project.tasks.splice(toRealIndex, 0, movedTask);
        
        console.log('‚úÖ Orden actualizado en proyecto');
        console.log('Nuevo orden:', project.tasks.filter(t => t.status === movedTask.status).map(t => t.name));
        
        return true;
        
    } catch (error) {
        console.error('‚ùå Error en reorderProjectTasksCorrected:', error);
        return false;
    }
}

// Funci√≥n para diagnosticar el estado actual
function diagnoseMovement() {
    const project = projects[currentProjectIndex];
    console.log('üîç DIAGN√ìSTICO DE MOVIMIENTO:');
    
    ['pending', 'inProgress', 'completed', 'overdue'].forEach(status => {
        const tasks = project.tasks.filter(t => t.status === status);
        if (tasks.length > 0) {
            console.log(`üìã ${status} (${tasks.length} tareas):`, tasks.map((t, i) => `${i}: ${t.name}`));
        }
    });
}

// Inicializar la soluci√≥n
setTimeout(() => {
    initializeMoveButtonsCompleteSolution();
    console.log('üí° Usa diagnoseMovement() para ver el orden actual');
}, 1000);



// ‚úÖ INICIALIZACI√ìN SEGURA DEL BOT√ìN GANTT PRO - VERSI√ìN CORREGIDA
function initializeGanttProButton() {
    const ganttButton = document.getElementById('showGanttView');
    if (ganttButton) {
        // Clonar y reemplazar para limpiar event listeners
        const newButton = ganttButton.cloneNode(true);
        ganttButton.parentNode.replaceChild(newButton, ganttButton);
        
        // Event listener DIRECTO y SIMPLE
        newButton.onclick = function(e) {
            e.preventDefault();
            console.log("üéØ Bot√≥n Gantt Pro - showView('ganttPro')");
            showView('ganttPro');
            return false;
        };
        
        console.log("‚úÖ Bot√≥n Gantt Pro inicializado correctamente");
    }
}

// Ejecutar cuando el DOM est√© listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeGanttProButton);
} else {
    initializeGanttProButton();
}






// Funci√≥n de diagn√≥stico
function debugDataLoad() {
  console.group('üîç DIAGN√ìSTICO DE CARGA DE DATOS');
  console.log('üîê Token:', window.authToken ? window.authToken.substring(0, 30) + '...' : 'NO HAY');
  console.log('üåê API_URL:', API_URL);
  console.log('üì¶ localStorage projects:', localStorage.getItem('projects') ? 'PRESENTE' : 'AUSENTE');
  console.log('üìä projects array:', projects.length, 'proyectos');
  console.log('üìç currentProjectIndex:', currentProjectIndex);
  
  // Verificar conexi√≥n al backend
  fetch(`${API_URL}/api/health`)
    .then(res => console.log('üîÑ Backend status:', res.ok ? '‚úÖ ONLINE' : '‚ùå OFFLINE'))
    .catch(err => console.log('üîÑ Backend status:', '‚ùå ERROR:', err.message));
  
  console.groupEnd();
}

// Ejecutar diagn√≥stico en consola llamando: debugDataLoad()







function populateTaskDependenciesSelect(excludeTaskId = null) {
  console.log('üîß populateTaskDependenciesSelect - VERSI√ìN FINAL');
  
  const container = document.getElementById('taskDependenciesContainer');
  const selectedDiv = document.getElementById('taskDependenciesSelected');
  const itemsDiv = document.getElementById('taskDependenciesItems');
  
  if (!container) {
    console.error('‚ùå No se encontr√≥ taskDependenciesContainer');
    return;
  }

  // Limpiar
  itemsDiv.innerHTML = '';
  selectedDiv.innerHTML = '-- Seleccione tareas predecesoras --';
  itemsDiv.style.display = 'none';

  // ‚úÖ Usar projects (tu array REAL con 5 proyectos)
  const project = projects[currentProjectIndex];
  if (!project || !project.tasks) {
    console.warn('‚ö†Ô∏è No hay proyecto o tareas disponibles');
    return;
  }

  console.log(`üìã Proyecto: "${project.name}", Tareas: ${project.tasks.length}`);

  // Mostrar opciones
  let addedCount = 0;
  project.tasks.forEach(task => {
    if (task.id === excludeTaskId) {
      console.log(`‚Ü© Saltando tarea actual: "${task.name}" (ID: ${task.id})`);
      return;
    }

    const option = document.createElement('div');
    // NO usar clase 'dependency-option', solo data-id
    option.textContent = task.name;
    option.dataset.id = task.id;
    option.title = `ID: ${task.id} | Estado: ${task.status || 'No definido'}`;
    
    option.addEventListener('click', function(e) {
      e.stopPropagation();
      this.classList.toggle('selected');
      updateSelectedDependenciesView();
    });
    
    itemsDiv.appendChild(option);
    addedCount++;
  });

  console.log(`‚úÖ ${addedCount} opciones agregadas`);

  // Alternar men√∫
  selectedDiv.onclick = function(e) {
    e.stopPropagation();
    itemsDiv.style.display = itemsDiv.style.display === 'block' ? 'none' : 'block';
  };

  // Cerrar men√∫ al hacer clic fuera
  document.addEventListener('click', function closeDropdown(e) {
    if (!container.contains(e.target)) {
      itemsDiv.style.display = 'none';
    }
  }, { once: true });
}




// REEMPLAZA la funci√≥n restoreDependencySelection con esta versi√≥n corregida:
function restoreDependencySelection(dependencyIds = []) {
  console.log('üîß Restaurando selecci√≥n de dependencias:', dependencyIds);
  
  const itemsDiv = document.getElementById('taskDependenciesItems');
  if (!itemsDiv) {
    console.error('‚ùå itemsDiv no encontrado');
    return;
  }
  
  // Limpiar selecciones previas
  itemsDiv.querySelectorAll('div[data-id]').forEach(option => {
    option.classList.remove('selected');
  });
  
  // Marcar como seleccionadas las dependencias existentes
  if (Array.isArray(dependencyIds) && dependencyIds.length > 0) {
    console.log(`Buscando ${dependencyIds.length} dependencias en ${itemsDiv.children.length} opciones...`);
    
    dependencyIds.forEach(depId => {
      // ‚úÖ CORRECCI√ìN: Convertir depId a string para la b√∫squeda
      const depIdStr = String(depId);
      
      // Buscar por atributo data-id
      const option = itemsDiv.querySelector(`div[data-id="${depIdStr}"]`);
      
      if (option) {
        option.classList.add('selected');
        console.log(`‚úÖ Dependencia restaurada: ID ${depId} - "${option.textContent}"`);
      } else {
        console.warn(`‚ö†Ô∏è No se encontr√≥ opci√≥n para dependencia ID ${depId}`);
        
        // Depuraci√≥n: mostrar todos los data-id disponibles
        console.log('   Opciones disponibles:');
        Array.from(itemsDiv.children).forEach((child, i) => {
          console.log(`   ${i}. data-id="${child.dataset.id}" - "${child.textContent}"`);
        });
      }
    });
    
    // Actualizar la vista
    updateSelectedDependenciesView();
  }
}



function setupDependenciesForTask(task) {
  console.log('üîß Configurando dependencias para tarea:', task.name);
  
  // Buscar elementos del DOM (si existen)
  const depsContainer = document.querySelector('.dependencies-container');
  if (!depsContainer) {
    console.log('‚ÑπÔ∏è No hay contenedor de dependencias en el modal');
    return;
  }
  
  // Inicializar currentDependencies con las dependencias actuales de la tarea
  window.currentDependencies = task.dependencies || [];
  console.log('üìã Dependencias iniciales:', window.currentDependencies);
  
  // Si hay un selector de dependencias en el modal, configurarlo
  const depsSelect = document.getElementById('taskDependenciesSelect');
  if (depsSelect) {
    console.log('‚úÖ Selector de dependencias encontrado');
    
    // Limpiar opciones
    depsSelect.innerHTML = '<option value="">Seleccionar dependencia...</option>';
    
    // Obtener todas las tareas del proyecto actual
    const project = window.projects[window.currentProjectIndex];
    if (!project || !project.tasks) return;
    
    // Filtrar tarea actual
    const availableTasks = project.tasks.filter(t => t.id !== task.id);
    
    // Agregar opciones
    availableTasks.forEach(depTask => {
      const option = document.createElement('option');
      option.value = depTask.id;
      option.textContent = depTask.name || 'Sin t√≠tulo';
      
      // Marcar como seleccionada si ya es dependencia
      if (window.currentDependencies.includes(depTask.id)) {
        option.selected = true;
      }
      
      depsSelect.appendChild(option);
    });
    
    // Evento para agregar dependencia
    depsSelect.addEventListener('change', function() {
      const selectedId = parseInt(this.value);
      if (selectedId && !window.currentDependencies.includes(selectedId)) {
        window.currentDependencies.push(selectedId);
        console.log('‚ûï Dependencia agregada:', selectedId);
        updateDependenciesView();
      }
      this.value = ''; // Resetear selecci√≥n
    });
  }
  
  // Funci√≥n para actualizar la vista de dependencias
  function updateDependenciesView() {
    console.log('üîÑ Actualizando vista de dependencias:', window.currentDependencies);
    
    // Actualizar badges o lista visual si existe
    const depsBadgesContainer = document.querySelector('.dependencies-badges');
    if (depsBadgesContainer) {
      depsBadgesContainer.innerHTML = '';
      
      window.currentDependencies.forEach(depId => {
        // Buscar la tarea dependiente
        const project = window.projects[window.currentProjectIndex];
        if (project && project.tasks) {
          const depTask = project.tasks.find(t => t.id === depId);
          if (depTask) {
            const badge = document.createElement('span');
            badge.className = 'dependency-badge';
            badge.innerHTML = `
              ${depTask.name || 'Sin t√≠tulo'}
              <span class="remove-dep" data-id="${depId}">√ó</span>
            `;
            badge.style.cssText = `
              display: inline-block;
              background: #4CAF50;
              color: white;
              padding: 4px 10px;
              border-radius: 15px;
              margin: 3px;
              font-size: 12px;
            `;
            
            // Evento para eliminar dependencia
            badge.querySelector('.remove-dep').addEventListener('click', function(e) {
              e.stopPropagation();
              const idToRemove = parseInt(this.dataset.id);
              window.currentDependencies = window.currentDependencies.filter(id => id !== idToRemove);
              console.log('‚ûñ Dependencia removida:', idToRemove);
              updateDependenciesView();
            });
            
            depsBadgesContainer.appendChild(badge);
          }
        }
      });
      
      // Si no hay dependencias, mostrar mensaje
      if (window.currentDependencies.length === 0) {
        depsBadgesContainer.innerHTML = '<span style="color: #666; font-style: italic;">Sin dependencias</span>';
      }
    }
  }
  
  // Inicializar vista
  updateDependenciesView();
  console.log('‚úÖ Dependencias configuradas');
}


// ============================================
// MANEJO CORRECTO DE DEPENDENCIAS
// ============================================

// Funci√≥n para inicializar dependencias SIN perderlas
function initializeTaskDependencies(task) {
    console.log('üîß INICIALIZANDO DEPENDENCIAS - VERSI√ìN DEFINITIVA');
    console.log('   Tarea:', task.name, 'ID:', task.id);
    console.log('   task.dependencies:', task.dependencies);
    console.log('   window.currentDependencies antes:', window.currentDependencies);
    
    // Si no existe la variable global, crearla
    if (!window.currentDependencies) {
        window.currentDependencies = [];
        console.log('   ‚ö†Ô∏è currentDependencies no exist√≠a, creado array vac√≠o');
    }
    
    // Si la tarea tiene dependencias, cargarlas correctamente
    if (task.dependencies && Array.isArray(task.dependencies) && task.dependencies.length > 0) {
        console.log('   ‚úÖ Tarea tiene dependencias, cargando...');
        
        const depsArray = task.dependencies.map(dep => {
            const num = Number(dep);
            return isNaN(num) ? dep : num;  
        }).filter(dep => dep != null);

        // L√çNEA CORRECTA ‚Äî COPIA SEGURA, NO REFERENCIA
        window.currentDependencies = [...depsArray];

        console.log('   üìã Dependencias cargadas correctamente:', window.currentDependencies);
    } 
    else {
        // La tarea actual no tiene dependencias ‚Äî solo limpiar su propio estado
        console.log('   üì≠ Esta tarea no tiene dependencias propias');
        window.currentDependencies = [];
    }
    
    // Verificaci√≥n final
    console.log('   üîç VERIFICACI√ìN FINAL:');
    console.log('      - currentDependencies:', window.currentDependencies);
    console.log('      - Tipo:', typeof window.currentDependencies);
    console.log('      - ¬øEs array?', Array.isArray(window.currentDependencies));
    console.log('      - Longitud:', window.currentDependencies.length);
}
// Funci√≥n para actualizar la vista de dependencias en el modal
function updateDependenciesView() {
    console.log('üîÑ Actualizando vista de dependencias...');
    console.log('   - currentDependencies:', window.currentDependencies);
    
    const depsBadgesContainer = document.querySelector('.dependencies-badges');
    if (!depsBadgesContainer) {
        console.log('‚ö†Ô∏è No hay contenedor de dependencias en el modal');
        return;
    }
    
    // Limpiar contenedor
    depsBadgesContainer.innerHTML = '';
    
    if (!window.currentDependencies || window.currentDependencies.length === 0) {
        depsBadgesContainer.innerHTML = '<span style="color: #666; font-style: italic;">Sin dependencias</span>';
        console.log('üì≠ Vista actualizada: Sin dependencias');
        return;
    }
    
    // Obtener proyecto actual para buscar nombres de tareas
    const project = window.projects[window.currentProjectIndex];
    if (!project || !project.tasks) {
        console.error('‚ùå No se pudo obtener proyecto para mostrar dependencias');
        return;
    }
    
    // Crear badges para cada dependencia
    window.currentDependencies.forEach(depId => {
        const depTask = project.tasks.find(t => t.id === depId);
        if (depTask) {
            const badge = document.createElement('span');
            badge.className = 'dependency-badge';
            badge.innerHTML = `
                ${depTask.name || 'Sin t√≠tulo'}
                <span class="remove-dep" data-id="${depId}" style="
                    margin-left: 8px;
                    cursor: pointer;
                    background: rgba(255,255,255,0.3);
                    border-radius: 50%;
                    width: 16px;
                    height: 16px;
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                ">√ó</span>
            `;
            badge.style.cssText = `
                display: inline-block;
                background: #4CAF50;
                color: white;
                padding: 6px 12px;
                border-radius: 16px;
                margin: 4px;
                font-size: 13px;
                transition: all 0.2s;
            `;
            
            // Evento para eliminar dependencia
            badge.querySelector('.remove-dep').addEventListener('click', function(e) {
                e.stopPropagation();
                const idToRemove = Number(this.dataset.id);
                console.log(`üóëÔ∏è Eliminando dependencia: ${idToRemove}`);
                
                // Filtrar sin modificar el array original directamente
                window.currentDependencies = window.currentDependencies.filter(id => id !== idToRemove);
                console.log('‚úÖ Dependencias despu√©s de eliminar:', window.currentDependencies);
                
                // Actualizar vista
                updateDependenciesView();
            });
            
            depsBadgesContainer.appendChild(badge);
        } else {
            console.warn(`‚ö†Ô∏è Tarea dependiente no encontrada: ${depId}`);
        }
    });
    
    console.log(`‚úÖ Vista actualizada con ${window.currentDependencies.length} dependencia(s)`);
}






// üîß Stub invisible para evitar "Elemento totalProjectTimeStatus no encontrado"
(function ensureTotalProjectTimeStatusStub() {
  try {
    if (!document.getElementById('totalProjectTimeStatus')) {
      const stub = document.createElement('div');
      stub.id = 'totalProjectTimeStatus';
      stub.style.display = 'none';
      // propiedades m√≠nimas seguras que podr√≠an usar generateReports
      stub.innerText = '';
      stub.textContent = '';
      document.body.appendChild(stub);
      console.log('üîß Stub creado: #totalProjectTimeStatus (oculto)');
    } else {
      // existe: nada que hacer
    }
  } catch (e) {
    console.error('‚ùå Error creando stub totalProjectTimeStatus:', e);
  }
})();





// üîß Protege selectProject para evitar √≠ndice inv√°lido
(function guardSelectProject() {
  const original = window.selectProject;
  if (typeof original !== 'function') {
    console.warn('‚ö†Ô∏è selectProject no est√° definida todav√≠a. Se parchear√° cuando exista.');
    // intentaremos parchear m√°s tarde cuando exista
    const timer = setInterval(() => {
      if (typeof window.selectProject === 'function') {
        clearInterval(timer);
        // re-invocamos el parche recursivamente
        guardSelectProject();
      }
    }, 200);
    return;
  }

  window.selectProject = function(projectIndex, ...rest) {
    try {
      const idx = parseInt(projectIndex);
      const projectsFromWindow = Array.isArray(window.projects) ? window.projects : null;
      const projectsFromStorage = JSON.parse(localStorage.getItem('projects') || '[]');
      const projects = projectsFromWindow || projectsFromStorage || [];
      if (isNaN(idx) || idx < 0 || idx >= projects.length) {
        console.warn('‚ö†Ô∏è selectProject: √≠ndice inv√°lido, evitando cambio ‚Üí', projectIndex);
        // Puedes forzar a 0 o al √∫ltimo v√°lido si prefieres:
        // const safeIdx = Math.max(0, Math.min(projects.length - 1, idx || 0));
        // return original.call(this, safeIdx, ...rest);
        return;
      }
      return original.call(this, projectIndex, ...rest);
    } catch (err) {
      console.error('‚ùå Error en guardSelectProject:', err);
    }
  };

  console.log('üîí selectProject parchada (protecci√≥n de √≠ndice inv√°lido)');

})();


function formatFileSize(bytes) {
    if (!bytes || bytes === 0) return '0 Bytes';
    
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}


function loadFileFromStorage(fileKey) {
    try {
        const fileData = JSON.parse(localStorage.getItem(fileKey));
        if (!fileData) {
            console.error('‚ùå Archivo no encontrado:', fileKey);
            return null;
        }
        return fileData;
    } catch (error) {
        console.error('‚ùå Error cargando archivo:', error);
        return null;
    }
}





// ================================================
// FUNCIONES PARA CERRAR MODALES
// ================================================

function closeCriticalModal() {
  console.log('üîí Cerrando modal de Ruta Cr√≠tica...');
  
  // Buscar por varios posibles IDs
  const modalIds = ['criticalPathModal', 'criticalModal', 'modalCriticalPath'];
  let modal = null;
  
  for (const id of modalIds) {
    modal = document.getElementById(id);
    if (modal) break;
  }
  
  // Tambi√©n buscar por clase
  if (!modal) {
    modal = document.querySelector('.modal.critical-path-modal, [class*="critical"]');
  }
  
  if (modal) {
    modal.style.display = 'none';
    modal.classList.remove('show');
    
    // Remover backdrop
    const backdrop = document.querySelector('.modal-backdrop');
    if (backdrop) backdrop.remove();
    
    // Habilitar scroll
    document.body.style.overflow = 'auto';
    
    console.log('‚úÖ Modal de Ruta Cr√≠tica cerrado');
  } else {
    console.warn('‚ö†Ô∏è Modal de Ruta Cr√≠tica no encontrado, buscando todos los modales...');
    
    // Cerrar todos los modales como fallback
    const allModals = document.querySelectorAll('.modal[style*="block"]');
    allModals.forEach(m => {
      m.style.display = 'none';
      m.classList.remove('show');
    });
    
    const backdrops = document.querySelectorAll('.modal-backdrop');
    backdrops.forEach(b => b.remove());
    
    document.body.style.overflow = 'auto';
  }
}
// 2. Funci√≥n para cerrar el creador de dependencias
function closeDependencyCreator() {
  console.log('üîí Cerrando creador de dependencias...');
  
  const modal = document.getElementById('dependencyCreatorModal');
  if (modal) {
    modal.style.display = 'none';
    modal.classList.remove('show');
    
    // Limpiar selecciones
    const selectedElements = document.querySelectorAll('[data-selected="true"]');
    selectedElements.forEach(el => {
      el.removeAttribute('data-selected');
      el.style.border = '';
    });
    

    // Limpiar formulario
    const form = document.getElementById('dependencyForm');
    if (form) {
      form.reset();
    }
    
    console.log('‚úÖ Creador de dependencias cerrado');
  } else {
    console.warn('‚ö†Ô∏è Creador de dependencias no encontrado');
  }
}

// 3. Funci√≥n para cerrar TODOS los modales
function closeAllModals() {
  console.log('üîí Cerrando todos los modales...');
  
  const modals = document.querySelectorAll('.modal');
  modals.forEach(modal => {
    modal.style.display = 'none';
    modal.classList.remove('show');
  });
  
  // Tambi√©n cerrar cualquier backdrop
  const backdrops = document.querySelectorAll('.modal-backdrop');
  backdrops.forEach(backdrop => {
    backdrop.remove();
  });
  
  // Habilitar scroll del body
  document.body.style.overflow = 'auto';
  
  console.log('‚úÖ Todos los modales cerrados');
}

// 4. Configurar cierre con Escape y clic fuera
document.addEventListener('DOMContentLoaded', function() {
  // Cerrar con tecla Escape
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeAllModals();
    }
  });
  
  // Cerrar haciendo clic fuera del modal
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal')) {
      closeAllModals();
    }
  });
  
  console.log('‚úÖ Sistema de cierre de modales configurado');
});



// ================================================
// FUNCIONES CR√çTICAS FALTANTES
// ================================================

// 1. Funci√≥n para guardar la ruta cr√≠tica
function saveCriticalPath() {
  console.log('=== SAVE CRITICAL PATH ===');
  
  // Buscar el modal de manera robusta
  const overlay = document.querySelector('.dependency-overlay');
  const modal = overlay ? overlay.nextElementSibling : document.querySelector('.dependency-modal');
  
  if (!modal) {
    console.error('‚ùå Modal de ruta cr√≠tica no encontrado');
    return;
  }

  const projectIndex = parseInt(modal.dataset.projectIndex) || currentProjectIndex;
  if (projectIndex >= projects.length || projectIndex < 0) {
    alert('‚ùå √çndice de proyecto inv√°lido');
    return;
  }

  const currentProject = projects[projectIndex];
  if (!currentProject || !currentProject.tasks) {
    alert('‚ùå Proyecto o tareas no disponibles');
    return;
  }

  // Resetear todas las prioridades a "media"
  currentProject.tasks.forEach(task => {
    task.priority = 'media';
  });

  // Aplicar prioridad "alta" a tareas seleccionadas
  const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked');
  let cambios = 0;

  checkboxes.forEach(cb => {
    const taskId = cb.id.replace('critical_', '');
    const task = currentProject.tasks.find(t => t.id?.toString() === taskId);
    if (task) {
      task.priority = 'alta';
      cambios++;
      console.log(`‚úÖ Tarea "${task.name}" marcada como cr√≠tica`);
    }
  });

  // Fallback: usar dataset si no hay checkboxes
  if (cambios === 0 && modal.dataset.criticalStatus) {
    console.log('üîÑ Usando datos del dataset como fallback...');
    const criticalStatus = JSON.parse(modal.dataset.criticalStatus || '[]');
    criticalStatus.forEach(taskStatus => {
      const task = currentProject.tasks.find(t => t.id?.toString() === taskStatus.id.toString());
      if (task) {
        task.priority = taskStatus.isCritical ? 'alta' : 'media';
        if (taskStatus.isCritical) cambios++;
      }
    });
  }

  if (cambios === 0) {
    alert('‚ö†Ô∏è No se realizaron cambios');
    closeCriticalModal();
    return;
  }

  console.log(`üìà Total de cambios: ${cambios}`);

  // Guardar cambios
  safeSave().then((success) => {
    if (success) {
      console.log('‚úÖ Ruta cr√≠tica guardada para proyecto:', currentProject.name);
      closeCriticalModal();

      // ‚úÖ USAR refreshGanttView (sin eliminar el contenedor)
      setTimeout(() => {
        if (typeof refreshGanttView === 'function') {
          refreshGanttView();
        } else {
          // Fallback seguro: reutilizar contenedor existente
          const ganttContainer = document.getElementById('premiumExecutiveGantt');
          if (ganttContainer) {
            createCompleteGanttForCurrentProject(ganttContainer);
          }
        }
      }, 100);

      showNotification(`‚úÖ ${cambios} tareas marcadas como cr√≠ticas`);
    } else {
      console.error('‚ùå safeSave devolvi√≥ false');
      alert('Error al guardar los cambios');
    }
  }).catch(error => {
    console.error('‚ùå Error guardando ruta cr√≠tica:', error);
    showNotification('‚ùå Error al guardar la ruta cr√≠tica');
  });
}
// 2. Funci√≥n para guardar dependencias
function saveDependency() {
  console.log('üíæ Guardando dependencia...');
  
  try {
    const sourceTask = document.getElementById('sourceTask').value;
    const targetTask = document.getElementById('targetTask').value;
    const dependencyType = document.getElementById('dependencyType').value;
    
    if (!sourceTask || !targetTask) {
      alert('‚ö†Ô∏è Por favor selecciona ambas tareas.');
      return;
    }
    
    if (sourceTask === targetTask) {
      alert('‚ö†Ô∏è No puedes crear una dependencia de una tarea consigo misma.');
      return;
    }
    
    console.log(`üîó Creando dependencia: ${sourceTask} ‚Üí ${targetTask} (${dependencyType})`);
    
    // Aqu√≠ va tu l√≥gica para guardar en el backend
    const dependencyData = {
      source: sourceTask,
      target: targetTask,
      type: dependencyType,
      projectId: window.currentProjectId || getCurrentProjectId()
    };
    
    // Simulaci√≥n de guardado
    console.log('‚úÖ Dependencia creada:', dependencyData);
    
    // Actualizar visualizaci√≥n
    updateDependencyVisualization(sourceTask, targetTask, dependencyType);
    
    // Cerrar el modal
    closeDependencyCreator();
    
    // Actualizar vista
    if (typeof refreshGanttView === 'function') {
      refreshGanttView();
    }
    
    // Mostrar mensaje de √©xito
    showNotification('‚úÖ Dependencia creada exitosamente', 'success');
    
    // Limpiar formulario
    document.getElementById('dependencyForm').reset();
    
  } catch (error) {
    console.error('‚ùå Error al guardar dependencia:', error);
    showNotification('‚ùå Error al crear dependencia', 'error');
  }
}

// 3. Funci√≥n para actualizar vista Gantt (si no existe)
if (typeof refreshGanttView === 'undefined') {
  window.refreshGanttView = function() {
    console.log('üìä Actualizando vista Gantt...');
    
    // Aqu√≠ va tu l√≥gica para actualizar el gr√°fico Gantt
    const ganttContainer = document.getElementById('ganttChart');
    if (ganttContainer) {
      console.log('‚úÖ Contenedor Gantt encontrado, actualizando...');
      // Tu c√≥digo para actualizar el gr√°fico
    } else {
      console.log('‚ÑπÔ∏è No hay contenedor Gantt para actualizar');
    }
  };
}

// 4. Funci√≥n auxiliar para notificaciones
function showNotification(message, type = 'info') {
  console.log(`üì¢ Notificaci√≥n [${type}]: ${message}`);
  
  const colors = {
    success: '#10b981',
    error: '#ef4444',
    warning: '#f59e0b',
    info: '#3b82f6'
  };
  
  // Crear notificaci√≥n
  const notification = document.createElement('div');
  notification.textContent = message;
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 25px;
    background: ${colors[type] || colors.info};
    color: white;
    border-radius: 8px;
    z-index: 999999;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    animation: slideIn 0.3s ease;
  `;
  
  // Agregar animaci√≥n CSS si no existe
  if (!document.querySelector('#notification-styles')) {
    const style = document.createElement('style');
    style.id = 'notification-styles';
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  }
  
  document.body.appendChild(notification);
  
  // Auto-eliminar despu√©s de 5 segundos
  setTimeout(() => {
    notification.style.animation = 'fadeOut 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, 5000);
}

// 5. Funci√≥n para actualizar visualizaci√≥n de dependencias
function updateDependencyVisualization(sourceId, targetId, type) {
  console.log(`üé® Actualizando visualizaci√≥n: ${sourceId} ‚Üí ${targetId}`);
  
  // Encontrar elementos de las tareas
  const sourceElement = document.querySelector(`[data-task-id="${sourceId}"]`);
  const targetElement = document.querySelector(`[data-task-id="${targetId}"]`);
  
  if (sourceElement && targetElement) {
    // Agregar clases para estilizaci√≥n
    sourceElement.classList.add('has-dependency');
    targetElement.classList.add('has-dependency');
    
    // Crear l√≠nea visual (ejemplo simple)
    const container = sourceElement.closest('.tasks-container') || document.body;
    const line = document.createElement('div');
    line.className = 'dependency-line';
    line.dataset.source = sourceId;
    line.dataset.target = targetId;
    line.dataset.type = type;
    
    // Posicionar la l√≠nea (esto es un ejemplo b√°sico)
    const sourceRect = sourceElement.getBoundingClientRect();
    const targetRect = targetElement.getBoundingClientRect();
    
    line.style.cssText = `
      position: absolute;
      top: ${sourceRect.top + sourceRect.height/2}px;
      left: ${sourceRect.right}px;
      width: ${targetRect.left - sourceRect.right}px;
      height: 2px;
      background: #3498db;
      z-index: 1000;
      pointer-events: none;
    `;
    
    container.appendChild(line);
    
    console.log('‚úÖ Visualizaci√≥n de dependencia actualizada');
  }
}


// ========== FUNCI√ìN PARA CERRAR EL MODAL DE MIEMBROS ==========
window.closeTeamMembersModal = function() {
  console.log('üîí Cerrando modal de miembros del equipo...');
  
  // M√©todo 1: Buscar y eliminar overlay por ID
  const overlay = document.getElementById('teamOverlay');
  if (overlay) {
    overlay.remove();
    console.log('‚úÖ Overlay eliminado por ID');
    return;
  }
  
  // M√©todo 2: Buscar overlay por estilo
  const overlays = document.querySelectorAll('div[style*="position: fixed"]');
  overlays.forEach(div => {
    const style = div.getAttribute('style') || '';
    if (style.includes('rgba(0,0,0,0.85)') || style.includes('background: rgba(0,0,0,0.85)')) {
      div.remove();
      console.log('‚úÖ Overlay eliminado por estilo');
    }
  });
  
  // M√©todo 3: Buscar por contenido espec√≠fico
  document.querySelectorAll('div').forEach(div => {
    if (div.innerHTML && div.innerHTML.includes('Distribuci√≥n Completa del Equipo')) {
      // Buscar el overlay padre
      let parent = div;
      while (parent) {
        const parentStyle = parent.getAttribute('style') || '';
        if (parentStyle.includes('position: fixed') && parentStyle.includes('background:')) {
          parent.remove();
          console.log('‚úÖ Overlay eliminado por contenido');
          break;
        }
        parent = parent.parentElement;
      }
    }
  });
  
  // M√©todo 4: Eliminar todos los overlays de equipo
  document.querySelectorAll('.team-members-overlay').forEach(el => el.remove());
};

















// ========== AGREGAR GANTT AL MEN√ö LATERAL ==========
function addGanttToSidebarMenu() {
  console.log('üîç Buscando men√∫ lateral para agregar Gantt...');
  
  // Buscar men√∫s laterales comunes
  const sidebarSelectors = [
    '#sidebar', '.sidebar', '.side-menu', '.left-menu',
    '.menu-lateral', '.nav-sidebar', '.sidenav',
    '[class*="sidebar"]', '[class*="side-menu"]',
    'aside', 'nav ul', '.main-nav'
  ];
  
  let sidebarFound = false;
  
  sidebarSelectors.forEach(selector => {
    const sidebar = document.querySelector(selector);
    if (sidebar && !sidebarFound) {
      console.log(`‚úÖ Men√∫ lateral encontrado: ${selector}`);
      
      // Crear elemento del men√∫ para Gantt
      const menuItem = document.createElement('li');
      menuItem.style.cssText = `
        margin: 10px 0;
        list-style: none;
      `;
      
      const menuLink = document.createElement('a');
      menuLink.href = '#';
      menuLink.innerHTML = `
        <div style="
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 12px 15px;
          color: white;
          text-decoration: none;
          border-radius: 8px;
          transition: all 0.3s ease;
          background: rgba(52, 152, 219, 0.1);
          border-left: 4px solid #3498db;
        ">
          <div style="
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #3498db;
          ">
            üìä
          </div>
          <div>
            <div style="font-weight: 600; font-size: 15px;">Gantt Ejecutivo</div>
            <div style="font-size: 11px; color: #95a5a6; margin-top: 2px;">
              Vista completa de proyectos
            </div>
          </div>
        </div>
      `;
      
      // Evento click para abrir el Gantt
      menuLink.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üöÄ Abriendo Gantt Ejecutivo desde men√∫ lateral...');
        
        // Cerrar Gantt existente si est√° abierto
        const existingGantt = document.getElementById('premiumExecutiveGantt');
        if (existingGantt) {
          existingGantt.remove();
        }
        
        // Abrir el Gantt completo
        createPremiumGanttWithYourData();
        
        // Efecto visual de confirmaci√≥n
        menuLink.style.background = 'rgba(46, 204, 113, 0.2)';
        menuLink.style.borderLeftColor = '#2ecc71';
        setTimeout(() => {
          menuLink.style.background = 'rgba(52, 152, 219, 0.1)';
          menuLink.style.borderLeftColor = '#3498db';
        }, 1000);
      });
      
      // Efectos hover
      menuLink.addEventListener('mouseenter', function() {
        this.style.background = 'rgba(52, 152, 219, 0.25)';
        this.style.transform = 'translateX(5px)';
      });
      
      menuLink.addEventListener('mouseleave', function() {
        this.style.background = 'rgba(52, 152, 219, 0.1)';
        this.style.transform = 'translateX(0)';
      });
      
      menuItem.appendChild(menuLink);
      
      // Intentar insertar en una posici√≥n visible (despu√©s de elementos principales)
      const firstItems = sidebar.querySelectorAll('li, .menu-item, .nav-item');
      if (firstItems.length > 0) {
        // Insertar despu√©s del primer elemento o en una posici√≥n espec√≠fica
        firstItems[0].parentNode.insertBefore(menuItem, firstItems[1] || firstItems[0].nextSibling);
      } else {
        // Si no hay elementos, agregar al principio
        sidebar.prepend(menuItem);
      }
      
      sidebarFound = true;
      console.log('‚úÖ Opci√≥n de Gantt agregada al men√∫ lateral');
    }
  });
  
  // Si no se encontr√≥ men√∫ lateral, crear uno simple
  if (!sidebarFound) {
    console.log('‚ö†Ô∏è No se encontr√≥ men√∫ lateral, creando uno simple...');
    createSimpleGanttMenu();
  }
}

// ========== CREAR MEN√ö SIMPLE SI NO EXISTE ==========
function createSimpleGanttMenu() {
  console.log('üõ†Ô∏è Creando men√∫ simple para Gantt...');
  
  // Crear contenedor del men√∫
  const menuContainer = document.createElement('div');
  menuContainer.id = 'simpleGanttMenu';
  menuContainer.style.cssText = `
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 9990;
    background: rgba(10, 10, 26, 0.9);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(52, 152, 219, 0.3);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    min-width: 250px;
  `;
  
  menuContainer.innerHTML = `
    <div style="
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    ">
      <div style="
        width: 36px;
        height: 36px;
        background: linear-gradient(45deg, #3498db, #2ecc71);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
      ">
        üìä
      </div>
      <div>
        <div style="color: white; font-weight: 600; font-size: 16px;">Gantt Ejecutivo</div>
        <div style="color: #95a5a6; font-size: 12px;">Gesti√≥n visual de proyectos</div>
      </div>
    </div>
    
    <div style="display: flex; flex-direction: column; gap: 8px;">
      <button onclick="openGanttFromSimpleMenu()" style="
        width: 100%;
        background: linear-gradient(45deg, #3498db, #2980b9);
        border: none;
        color: white;
        padding: 12px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s;
      " onmouseover="this.style.transform='translateX(5px)';"
         onmouseout="this.style.transform='translateX(0)';">
        <span style="font-size: 18px;">üìã</span>
        <span>Abrir Gantt Completo</span>
      </button>
      
      <button onclick="openBurndownFromMenu()" style="
        width: 100%;
        background: rgba(243, 156, 18, 0.1);
        border: 1px solid #f39c12;
        color: #f39c12;
        padding: 10px;
        border-radius: 6px;
        cursor: pointer;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s;
      " onmouseover="this.style.background='rgba(243, 156, 18, 0.2)';">
        <span>üìâ</span>
        <span>Burndown Chart</span>
      </button>
      
      <button onclick="openEVMFromMenu()" style="
        width: 100%;
        background: rgba(139, 92, 246, 0.1);
        border: 1px solid #8b5cf6;
        color: #8b5cf6;
        padding: 10px;
        border-radius: 6px;
        cursor: pointer;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s;
      " onmouseover="this.style.background='rgba(139, 92, 246, 0.2)';">
        <span>üìà</span>
        <span>Valor Ganado</span>
      </button>
      
      <button onclick="closeSimpleMenu()" style="
        width: 100%;
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        color: #95a5a6;
        padding: 8px;
        border-radius: 6px;
        cursor: pointer;
        text-align: center;
        margin-top: 10px;
        font-size: 12px;
      ">
        ‚úï Cerrar men√∫
      </button>
    </div>
    
    <div style="
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(255,255,255,0.1);
      font-size: 11px;
      color: #7f8c8d;
      text-align: center;
    ">
      Sistema de Gesti√≥n de Proyectos
    </div>
  `;
  
  document.body.appendChild(menuContainer);
  
  // Funciones para los botones
  window.openGanttFromSimpleMenu = function() {
    console.log('üöÄ Abriendo Gantt desde men√∫ simple...');
    createPremiumGanttWithYourData();
  };
  
  window.openBurndownFromMenu = function() {
    console.log('üìâ Abriendo Burndown desde men√∫...');
    if (typeof showBurnDownChartPremium === 'function') {
      showBurnDownChartPremium();
    }
  };
  
  window.openEVMFromMenu = function() {
    console.log('üìà Abriendo EVM desde men√∫...');
    if (typeof crearDashboardEVMCompleto === 'function') {
      crearDashboardEVMCompleto();
    }
  };
  
  window.closeSimpleMenu = function() {
    const menu = document.getElementById('simpleGanttMenu');
    if (menu) menu.remove();
  };
  
  console.log('‚úÖ Men√∫ simple creado en la esquina superior izquierda');
}

// ========== BUSCAR TAMBI√âN EN BARRA DE NAVEGACI√ìN SUPERIOR ==========
function addGanttToTopNav() {
  console.log('üîç Buscando barra de navegaci√≥n superior...');
  
  const navSelectors = [
    'header', '.header', '.top-bar', '.navbar',
    '.main-nav', '.nav', '.navigation',
    '[role="navigation"]', 'nav'
  ];
  
  navSelectors.forEach(selector => {
    const nav = document.querySelector(selector);
    if (nav && nav !== document.querySelector('#simpleGanttMenu')) {
      console.log(`‚úÖ Barra de navegaci√≥n encontrada: ${selector}`);
      
      // Crear bot√≥n para Gantt
      const ganttButton = document.createElement('button');
      ganttButton.id = 'topNavGanttButton';
      ganttButton.innerHTML = `
        <span style="display: flex; align-items: center; gap: 8px;">
          <span>üìä</span>
          <span>Gantt</span>
        </span>
      `;
      
      ganttButton.style.cssText = `
        background: linear-gradient(45deg, #3498db, #2ecc71);
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        margin-left: 10px;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
      `;
      
      ganttButton.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-2px)';
        this.style.boxShadow = '0 5px 15px rgba(52, 152, 219, 0.4)';
      });
      
      ganttButton.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = 'none';
      });
      
      ganttButton.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('üöÄ Abriendo Gantt desde barra superior...');
        createPremiumGanttWithYourData();
      });
      
      // Insertar en la barra de navegaci√≥n
      nav.appendChild(ganttButton);
      console.log('‚úÖ Bot√≥n de Gantt agregado a la barra superior');
      
      return;
    }
  });
}

// ========== INICIALIZAR CUANDO EL SISTEMA EST√â LISTO ==========
function initializeGanttMenuIntegration() {
  console.log('üîÑ Inicializando integraci√≥n del men√∫ Gantt...');
  
  // Esperar a que la interfaz est√© cargada
  setTimeout(() => {
    // 1. Intentar agregar al men√∫ lateral
    addGanttToSidebarMenu();
    
    // 2. Intentar agregar a la barra superior
    addGanttToTopNav();
    
    // 3. Si despu√©s de 3 segundos no se encontr√≥ nada, crear men√∫ simple
    setTimeout(() => {
      if (!document.querySelector('#simpleGanttMenu') && 
          !document.querySelector('#topNavGanttButton') &&
          !document.querySelector('[href*="gantt"], [onclick*="Gantt"]')) {
        createSimpleGanttMenu();
      }
    }, 3000);
    
    console.log('‚úÖ Integraci√≥n del men√∫ Gantt completada');
  }, 2000); // Esperar 2 segundos para que cargue la interfaz
}

// ========== EJECUTAR AUTOM√ÅTICAMENTE ==========
// Ejecutar cuando el DOM est√© listo
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeGanttMenuIntegration);
} else {
  initializeGanttMenuIntegration();
}

// ========== FUNCI√ìN PARA PROBAR DESDE CONSOLA ==========
window.addGanttMenu = function() {
  console.log('üõ†Ô∏è Forzando creaci√≥n de men√∫ Gantt...');
  addGanttToSidebarMenu();
  addGanttToTopNav();
  return '‚úÖ Men√∫ Gantt agregado';
};

console.log('‚úÖ M√≥dulo de men√∫ Gantt cargado');
console.log('üí° Usa addGanttMenu() en consola para forzar la creaci√≥n del men√∫');









// ============================================================================
// üìâ BURNDOWN REAL DESDE HISTORIA (WRAPPER FINAL)
// ============================================================================

window.calculateBurndownFromHistory = function (tasks) {
  const daily = buildBurndownFromDailyBurn(tasks);
  if (!daily) return null;

  const total = daily.totalPoints;
  const remaining = daily.trabajoReal[daily.trabajoReal.length - 1];
  const completed = total - remaining;

  return {
    semanas: daily.trabajoReal.map((_, i) => i),
    trabajoIdeal: daily.trabajoIdeal,
    trabajoReal: daily.trabajoReal,

    totalStoryPoints: total,
    completedStoryPoints: completed,
    remainingPoints: remaining,

    burnRateIdeal:
      daily.trabajoIdeal.length > 1
        ? (total / (daily.trabajoIdeal.length - 1)).toFixed(1)
        : '0',

    burnRateActual:
      daily.trabajoReal.length > 1
        ? (completed / (daily.trabajoReal.length - 1)).toFixed(1)
        : '0',

    efficiency: '‚Äî',
    weeksElapsed: daily.trabajoReal.length
  };
};




function showProjectHealthPanel() {
  // Evitar duplicados
  if (document.querySelector('.project-health-box')) return;

  const project = projects[currentProjectIndex];
  if (!project) return;

  const health = calculateProjectHealth(project.tasks, project);

  // üé® Colores SOLO para estado (NO fondo)
  const statusColors = {
    green: '#22c55e',
    yellow: '#facc15',
    red: '#ef4444'
  };

  const color = statusColors[health.status] || '#facc15';

  const box = document.createElement('div');
  box.className = 'project-health-box';

  // üì¶ Caja base (IGUAL A LA ORIGINAL)
  box.style.position = 'absolute';
  box.style.right = '40px';
  box.style.top = '50%';
  box.style.transform = 'translateY(-50%)';
  box.style.width = '260px';
  box.style.background = '#020617';
  box.style.border = `1px solid ${color}`;
  box.style.borderRadius = '12px';
  box.style.padding = '16px 20px';
  box.style.zIndex = '10000';
  box.style.color = '#e5e7eb';
  box.style.boxShadow = '0 10px 30px rgba(0,0,0,0.5)';
  box.style.display = 'flex';
  box.style.flexDirection = 'column';
  box.style.gap = '10px';

  box.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <strong style="color:${color}; font-size:15px;">
        üß† ${health.label}
      </strong>
      <button id="hideProjectHealth"
        style="
          background:none;
          border:none;
          color:#94a3b8;
          cursor:pointer;
          font-size:14px;
        ">
        ‚Üí
      </button>
    </div>

    <ul style="padding-left:18px; margin:0; font-size:13px;">
      ${health.reasons.map(r => `<li>${r}</li>`).join('')}
    </ul>
  `;

  const overlay = document.querySelector('.executive-overlay');
  if (!overlay) return;

  overlay.appendChild(box);

  // üîí Ocultar handle
  const handle = document.getElementById('project-health-handle');
  if (handle) handle.style.display = 'none';

  // ‚ùå Cerrar panel
  box.querySelector('#hideProjectHealth').onclick = () => {
    box.remove();
    ensureProjectHealthHandle();
  };
}

window.showProjectHealthPanel = showProjectHealthPanel;



// üß† SALUD EJECUTIVA DEL PROYECTO
function calculateProjectHealth(tasks, project) {
  if (!tasks || !tasks.length) {
    return {
      status: 'gray',
      label: 'Sin datos',
      reasons: ['No hay tareas']
    };
  }

  // 1Ô∏è‚É£ M√©tricas base
  const totalTasks = tasks.length;
  const completedTasks = tasks.filter(t => t.status === 'completed').length;

  const completionRate = completedTasks / totalTasks;

  // 2Ô∏è‚É£ Regresiones (completed ‚Üí inProgress / pending)
  let regressions = 0;
  tasks.forEach(t => {
    (t.history || []).forEach(h => {
      if (h.from === 'completed' && h.to !== 'completed') {
        regressions++;
      }
    });
  });

  // 3Ô∏è‚É£ Fecha
  const today = new Date();
  const endDate = project?.endDate
    ? new Date(project.endDate)
    : null;

  const isLate = endDate && today > endDate;

  // üßÆ DECISI√ìN EJECUTIVA
  if (isLate && completionRate < 0.9) {
    return {
      status: 'red',
      label: 'Cr√≠tico',
      reasons: ['Proyecto fuera de fecha', 'Avance insuficiente']
    };
  }

  if (regressions > 0 || completionRate < 0.6) {
    return {
      status: 'yellow',
      label: 'En riesgo',
      reasons: [
        regressions > 0 ? 'Retrabajo detectado' : null,
        completionRate < 0.6 ? 'Avance lento' : null
      ].filter(Boolean)
    };
  }

  return {
    status: 'green',
    label: 'En control',
    reasons: ['Avance consistente', 'Sin regresiones']
  };
}

// üîì Exponer solo para pruebas
window.calculateProjectHealth = calculateProjectHealth;




// üïí Render del Timeline del Proyecto (auditor√≠a real)
function renderProjectTimeline(tasks) {
  const container = document.querySelector('.executive-overlay #projectTimeline');
  if (!container) {
    console.warn('‚ö†Ô∏è Contenedor de timeline no encontrado');
    return;
  }

  const events = buildProjectTimeline(tasks)
    .sort((a, b) => a.date - b.date);

  if (!events.length) {
    container.innerHTML = '<p style="opacity:.6">Sin actividad registrada</p>';
    return;
  }

  container.innerHTML = events.map(e => `
    <div class="timeline-item">
      <div class="timeline-date">${e.date.toLocaleString()}</div>
      <div class="timeline-task">${e.taskName}</div>
      <div class="timeline-change">${e.from} ‚Üí ${e.to}</div>
    </div>
  `).join('');
}

// üîì solo para pruebas por consola
window.renderProjectTimeline = renderProjectTimeline;




function renderProjectHealth(tasks, project) {
  const overlay = document.querySelector('.executive-overlay');
  if (!overlay) return;

  // Evitar duplicados
  if (document.querySelector('.project-health-box')) return;

  const health = calculateProjectHealth(tasks, project);

  const box = document.createElement('div');
  box.className = 'project-health-box';
  box.style.cssText = `
    position: fixed;
    right: 40px;
    top: 50%;
    transform: translateY(-50%);
    background: #020617;
    border: 1px solid #1e293b;
    border-radius: 12px;
    padding: 16px 20px;
    width: 260px;
    z-index: 9999;
    color: #e5e7eb;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  `;

  const color =
    health.status === 'green' ? '#22c55e' :
    health.status === 'yellow' ? '#facc15' :
    health.status === 'red' ? '#ef4444' :
    '#94a3b8';

  box.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <strong style="color:${color}; font-size:15px;">
        üß† ${health.label}
      </strong>
      <button id="hideProjectHealth" style="
        background:none;
        border:none;
        color:#94a3b8;
        cursor:pointer;
        font-size:14px;
      ">‚Üí</button>
    </div>
    <ul style="padding-left:18px; margin:0; font-size:13px;">
      ${health.reasons.map(r => `<li>${r}</li>`).join('')}
    </ul>
  `;
// üîí OCULTAR EL HANDLE üß† AL MOSTRAR LA CAJA
const handle = document.getElementById('project-health-handle');
if (handle) handle.style.display = 'none';
  overlay.appendChild(box);

  // Interacci√≥n ocultar
  box.querySelector('#hideProjectHealth').onclick = () => {
  box.remove();
 ensureProjectHealthHandle();
  if (handle) handle.style.display = 'block';
};

}


const healthHandle = document.getElementById('project-health-handle');
if (healthHandle) {
  healthHandle.onclick = () => {
    healthHandle.style.display = 'none';

    const project = projects[currentProjectIndex];
    if (!project) return;

    renderProjectHealth(project.tasks, project);
  };
}

// ===============================
// üß† Evaluaci√≥n inteligente Burndown
// ===============================
function evaluarEstadoBurndown(data) {
  const remaining = Number(data.remainingPoints);
  const burned = Number(data.burnedStoryPoints);
  const weeksElapsed = Math.max(1, data.trabajoReal.length - 1);

  if (remaining <= 0) {
    return {
      status: 'success',
      icon: 'üéâ',
      message: 'Sprint completado'
    };
  }

  const velocity = burned / weeksElapsed;

  if (velocity <= 0) {
    return {
      status: 'danger',
      icon: 'X',
      message: 'Sin progreso detectado'
    };
  }

  const weeksNormal = remaining / velocity;
  const weeksOptimistic = remaining / (velocity * 1.25);
  const weeksPessimistic = remaining / (velocity * 0.75);

  if (weeksPessimistic <= 1) {
    return {
      status: 'success',
      icon: 'üî•',
      message: 'Excelente ritmo, podr√≠as terminar antes'
    };
  }

  if (weeksNormal <= 1.2) {
    return {
      status: 'ok',
      icon: '‚úÖ',
      message: 'Sprint en rango saludable'
    };
  }

  if (weeksOptimistic <= 1) {
    return {
      status: 'warning',
      icon: '‚ö†Ô∏è',
      message: 'Riesgo moderado de retraso'
    };
  }

  return {
    status: 'danger',
    icon: 'X',
    message: 'Alta probabilidad de no cumplir el sprint'
  };
}






// ===============================
// üß† EVALUADOR INTELIGENTE BURNDOWN
// ===============================
function evaluarEstadoBurndown(data) {
  const remaining = Number(data.remainingPoints);
  const burned = Number(data.burnedStoryPoints);
  const total = remaining + burned;

  if (total === 0) {
    return {
      status: 'neutral',
      icon: '‚ÑπÔ∏è',
      message: 'A√∫n no hay trabajo registrado en el sprint'
    };
  }

  const progreso = burned / total;

  if (progreso >= 0.75) {
    return {
      status: 'success',
      icon: 'üü¢',
      message: 'Sprint en control, buen ritmo de trabajo'
    };
  }

  if (progreso >= 0.5) {
    return {
      status: 'warning',
      icon: 'üü°',
      message: 'Progreso moderado, vigilar desviaciones'
    };
  }

  return {
    status: 'danger',
    icon: '‚ùå',
    message: 'Alta probabilidad de no cumplir el sprint'
  };
}





// =======================================
// üìà CONSTRUIR SERIES EVM REALES (HORAS)
// =======================================
function buildEVMSeriesFromTasks(tasks) {
  console.log('üìà Construyendo series EVM reales...');

  if (!tasks || tasks.length === 0) {
    console.warn('‚ö†Ô∏è Sin tareas para construir series EVM');
    return null;
  }

  // Obtener fechas √∫nicas relevantes
  const datesSet = new Set();

  tasks.forEach(task => {
    if (task.startDate) datesSet.add(task.startDate);
    if (task.deadline) datesSet.add(task.deadline);
  });

  const dates = Array.from(datesSet)
    .map(d => new Date(d))
    .filter(d => !isNaN(d))
    .sort((a, b) => a - b)
    .map(d => d.toISOString().slice(0, 10));

  let PV = [];
  let EV = [];
  let AC = [];

  let cumulativePV = 0;
  let cumulativeEV = 0;
  let cumulativeAC = 0;

  dates.forEach(dateStr => {
    const currentDate = new Date(dateStr);

    tasks.forEach(task => {
      const estimated = Number(task.estimatedTime) || 0;
      const actual = Number(task.timeLogged) || 0;

      const start = task.startDate ? new Date(task.startDate) : null;
      const end = task.deadline ? new Date(task.deadline) : null;

      // ===== PV (planificado proporcional)
      if (start && end && currentDate >= start && currentDate <= end) {
        const duration = end - start;
        const elapsed = currentDate - start;
        const ratio = duration > 0 ? elapsed / duration : 0;
        cumulativePV += estimated * ratio;
      }

      // ===== EV (seg√∫n estado)
      if (task.status === 'completed' && end && currentDate >= end) {
        cumulativeEV += estimated;
      } else if (task.status === 'inProgress' && start && currentDate >= start) {
        cumulativeEV += estimated * 0.5;
      }

      // ===== AC (horas reales ya registradas)
      if (start && currentDate >= start) {
        cumulativeAC += actual;
      }
    });

    PV.push(Number(cumulativePV.toFixed(2)));
    EV.push(Number(cumulativeEV.toFixed(2)));
    AC.push(Number(cumulativeAC.toFixed(2)));
  });

  const series = { dates, PV, EV, AC };
  console.table(series);

  return series;
}








function generateEVMRecommendations(evm) {
  if (!evm) return '<p>No hay datos suficientes para generar recomendaciones.</p>';

  let html = '<ul style="margin: 0; padding-left: 20px;">';

  // =========================
  // üü¢ PROYECTO SALUDABLE
  // =========================
  if (evm.CPI >= 1 && evm.SPI >= 1) {
    html += `
      <li style="margin-bottom: 12px;">
        üéØ <strong>Proyecto saludable</strong>
      </li>
      <li style="margin-bottom: 12px;">
        El equipo ha completado <strong>m√°s trabajo del planeado</strong> utilizando 
        <strong>menos horas de las estimadas</strong>.
      </li>
      <li style="margin-bottom: 12px;">
        Se recomienda <strong>mantener el ritmo actual</strong> y validar si las
        estimaciones iniciales fueron conservadoras.
      </li>
    `;
  }

  // =========================
  // üü° COSTOS BAJO OBSERVACI√ìN
  // =========================
  if (evm.CPI < 1 && evm.CPI >= 0.9) {
    html += `
      <li style="margin-bottom: 12px;">
        üü° <strong>Costos bajo observaci√≥n</strong>
      </li>
      <li style="margin-bottom: 12px;">
        El consumo de horas es ligeramente mayor al valor ganado.
      </li>
      <li style="margin-bottom: 12px;">
        Se recomienda reforzar el seguimiento semanal de esfuerzo.
      </li>
    `;
  }

  // =========================
  // üî¥ SOBRECOSTOS
  // =========================
  if (evm.CPI < 0.9) {
    html += `
      <li style="margin-bottom: 12px;">
        üî¥ <strong>Riesgo de sobrecostos</strong>
      </li>
      <li style="margin-bottom: 12px;">
        El proyecto est√° consumiendo m√°s horas de las que genera en valor.
      </li>
      <li style="margin-bottom: 12px;">
        Se recomienda revisar asignaci√≥n de recursos y alcance.
      </li>
    `;
  }

  // =========================
  // üî¥ RETRASO EN CRONOGRAMA
  // =========================
  if (evm.SPI < 0.9) {
    html += `
      <li style="margin-bottom: 12px;">
        üî¥ <strong>Retraso en el cronograma</strong>
      </li>
      <li style="margin-bottom: 12px;">
        El avance real est√° por debajo del plan esperado.
      </li>
      <li style="margin-bottom: 12px;">
        Se recomienda evaluar re-priorizaci√≥n o refuerzo del equipo.
      </li>
    `;
  }

  // =========================
  // üü¢ ADELANTO EN CRONOGRAMA
  // =========================
  if (evm.SPI >= 1.1) {
    html += `
      <li style="margin-bottom: 12px;">
        üöÄ <strong>Proyecto adelantado</strong>
      </li>
      <li style="margin-bottom: 12px;">
        El equipo est√° ejecutando el trabajo a un ritmo superior al plan.
      </li>
      <li style="margin-bottom: 12px;">
        Se recomienda validar dependencias futuras para mantener el desempe√±o.
      </li>
    `;
  }

  html += '</ul>';
  return html;
}








function renderEVMSemaphore(evm) {
  const banner = document.getElementById('evmStatusBanner');
  if (!banner || !evm) return;

  let color = '';
  let bg = '';
  let text = '';

  // üü¢ PROYECTO SALUDABLE
  if (evm.CPI >= 1 && evm.SPI >= 1) {
    color = '#22c55e';
    bg = 'rgba(34,197,94,0.15)';
    text = 'üü¢ PROYECTO SALUDABLE ¬∑ Costos y cronograma bajo control';
  }

  // üü° ADVERTENCIA
  else if (
    (evm.CPI >= 0.9 && evm.CPI < 1) ||
    (evm.SPI >= 0.9 && evm.SPI < 1)
  ) {
    color = '#facc15';
    bg = 'rgba(250,204,21,0.18)';
    text = 'üü° ATENCI√ìN ¬∑ Riesgo moderado en costos o cronograma';
  }

  // üî¥ PROYECTO EN RIESGO
  else {
    color = '#ef4444';
    bg = 'rgba(239,68,68,0.18)';
    text = 'üî¥ PROYECTO EN RIESGO ¬∑ Requiere acci√≥n inmediata';
  }

  banner.style.border = `2px solid ${color}`;
  banner.style.background = bg;
  banner.style.color = color;
  banner.textContent = text;
}



// üîÆ PRON√ìSTICO EVM EN COSTOS
function calcularPronosticoCostos(evm) {
  const EAC = evm.CPI > 0 ? evm.BAC / evm.CPI : evm.BAC;
  const ETC = EAC - evm.AC;
  const VAC = evm.BAC - EAC;

  return {
    EAC,
    ETC,
    VAC
  };
}


function renderEVMForecast(evm) {
  const forecast = calcularPronosticoCostos(evm);

  const eacEl = document.getElementById('eacValue');
  const etcEl = document.getElementById('etcValue');
  const vacEl = document.getElementById('vacValue');
  const narrative = document.getElementById('forecastNarrative');

  if (!eacEl || !etcEl || !vacEl || !narrative) return;

  eacEl.textContent = `$${forecast.EAC.toFixed(2)}`;
  etcEl.textContent = `$${forecast.ETC.toFixed(2)}`;
  vacEl.textContent =
    (forecast.VAC >= 0 ? '+' : '') + `$${forecast.VAC.toFixed(2)}`;

  if (forecast.VAC > 0) {
    narrative.textContent =
      'El proyecto finalizar√° por debajo del presupuesto estimado. ' +
      'Se observa una gesti√≥n eficiente de los costos.';
  } else if (forecast.VAC < 0) {
    narrative.textContent =
      'El proyecto presenta riesgo de sobrecosto. ' +
      'Se recomienda revisar gastos y asignaci√≥n de recursos.';
  } else {
    narrative.textContent =
      'El proyecto finalizar√° conforme al presupuesto aprobado.';
  }
}





window.showEVMForecast = function (retry = 0) {
  console.log('üìà Ejecutando showEVMForecast');

  const eacEl = document.getElementById('eacValue');
  const etcEl = document.getElementById('etcValue');
  const vacEl = document.getElementById('vacValue');
  const narrativeEl = document.getElementById('forecastNarrative');

  // ‚è≥ Esperar a que el DOM exista
  if (!eacEl || !etcEl || !vacEl || !narrativeEl) {
    if (retry < 10) {
      setTimeout(() => showEVMForecast(retry + 1), 300);
      return;
    }
    console.error('‚ùå Pron√≥stico no encontrado en el DOM');
    return;
  }

  /* ======================================================
     üí∞ MODO COSTOS
  ====================================================== */
  if (window.__EVM_MODE__ === 'costs') {
    const evm = window.lastEVMPreviewData;

    if (!evm || !evm.CPI) {
      console.warn('‚ö†Ô∏è EVM de costos no disponible');
      return;
    }

    const EAC = evm.BAC / evm.CPI;
    const ETC = EAC - evm.AC;
    const VAC = evm.BAC - EAC;

    console.log('üìä FORECAST COSTOS:', { EAC, ETC, VAC });

    eacEl.textContent = `$${EAC.toFixed(2)}`;
    etcEl.textContent = `$${ETC.toFixed(2)}`;
    vacEl.textContent =
      `${VAC >= 0 ? '+' : '-'}$${Math.abs(VAC).toFixed(2)}`;

    narrativeEl.textContent =
      VAC < 0
        ? 'El proyecto presenta riesgo de sobrecosto. Se recomienda controlar gastos.'
        : 'El proyecto finalizar√° dentro o por debajo del presupuesto.';

    return;
  }

  /* ======================================================
     ‚è±Ô∏è MODO HORAS (EVM REAL)
  ====================================================== */
  const proyecto = projects?.[currentProjectIndex];
  if (!proyecto || !Array.isArray(proyecto.tasks)) return;

  const evm = calculateEVMRealFromTasks(proyecto.tasks);
  if (!evm || !evm.CPI) return;

  const BAC = proyecto.tasks.reduce(
    (sum, t) => sum + (Number(t.estimatedTime) || 0),
    0
  );

  const EAC = BAC / evm.CPI;
  const ETC = EAC - (evm.AC || 0);
  const VAC = BAC - EAC;

  console.log('üìä FORECAST HORAS:', { EAC, ETC, VAC });

  eacEl.textContent = `${EAC.toFixed(2)} h`;
  etcEl.textContent = `${ETC.toFixed(2)} h`;
  vacEl.textContent =
    `${VAC >= 0 ? '+' : ''}${VAC.toFixed(2)} h`;

  narrativeEl.textContent =
    VAC < 0
      ? 'El proyecto presenta riesgo de sobreconsumo de horas.'
      : 'El proyecto se mantiene dentro del plan de horas.';
};



// ================= FUNCI√ìN PARA ACTUALIZAR COLORES DE INDICADORES =================
function actualizarColoresIndicadores() {
    // Obtener valores actuales
    const cpiElement = document.getElementById('cpiValue');
    const spiElement = document.getElementById('spiValue');
    
    if (!cpiElement || !spiElement) {
        console.log('‚ùå No se encontraron elementos CPI/SPI');
        return;
    }
    
    const cpiValue = parseFloat(cpiElement.textContent);
    const spiValue = parseFloat(spiElement.textContent);
    
    if (isNaN(cpiValue) || isNaN(spiValue)) {
        return;
    }
    
    // Encontrar los contenedores de CPI y SPI
    const cpiContainer = cpiElement.closest('div[style*="border-left: 5px solid"]');
    const spiContainer = spiElement.closest('div[style*="border-left: 5px solid"]');
    
    if (!cpiContainer || !spiContainer) {
        return;
    }
    
    // Colores seg√∫n interpretaci√≥n
    const colorCPI = cpiValue >= 1.0 ? '#10b981' : '#ef4444';
    const colorSPI = spiValue >= 1.0 ? '#3b82f6' : '#f59e0b';
    
    // Aplicar colores al borde izquierdo
    cpiContainer.style.borderLeft = `5px solid ${colorCPI}`;
    spiContainer.style.borderLeft = `5px solid ${colorSPI}`;
    
    // Tambi√©n cambiar color de fondo sutilmente
    cpiContainer.style.background = cpiValue >= 1.0 
        ? 'rgba(16, 185, 129, 0.1)' 
        : 'rgba(239, 68, 68, 0.1)';
    
    spiContainer.style.background = spiValue >= 1.0 
        ? 'rgba(59, 130, 246, 0.1)' 
        : 'rgba(245, 158, 11, 0.1)';
}

// ================= OBSERVADOR PARA CAMBIOS AUTOM√ÅTICOS =================
function crearObservadorIndicadores() {
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.target.id === 'cpiValue' || mutation.target.id === 'spiValue') {
                setTimeout(actualizarColoresIndicadores, 100);
            }
        });
    });
    
    const cpiElement = document.getElementById('cpiValue');
    const spiElement = document.getElementById('spiValue');
    
    if (cpiElement) {
        observer.observe(cpiElement, { childList: true, characterData: true, subtree: true });
    }
    
    if (spiElement) {
        observer.observe(spiElement, { childList: true, characterData: true, subtree: true });
    }
}

// ================= INICIALIZAR AL CARGAR EL DASHBOARD =================
// Agrega esta llamada donde se inicializa el dashboard EVM
// crearObservadorIndicadores();







// ===================================================================
// üéØ FILTROS EJECUTIVOS PARA GANTT PREMIUM - C√ìDIGO COMPLETO
// ===================================================================

// ========== FUNCI√ìN DE NOTIFICACI√ìN 100% INDEPENDIENTE ==========
function notificacionFiltro(message) {
  console.log(`üì¢ ${message}`);
  
  // Crear notificaci√≥n completamente independiente
  const notification = document.createElement('div');
  notification.className = 'filtro-notificacion-' + Date.now();
  notification.textContent = message;
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #2ecc71;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    z-index: 1000000;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    font-size: 14px;
    font-weight: 500;
    animation: filtroNotifIn 0.3s ease;
    max-width: 300px;
    word-break: break-word;
  `;
  
  // Agregar estilos de animaci√≥n solo para nuestras notificaciones
  if (!document.getElementById('filtro-notif-styles')) {
    const style = document.createElement('style');
    style.id = 'filtro-notif-styles';
    style.textContent = `
      @keyframes filtroNotifIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes filtroNotifOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);
  }
  
  document.body.appendChild(notification);
  
  // Remover despu√©s de 3 segundos
  setTimeout(() => {
    notification.style.animation = 'filtroNotifOut 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// ========== FUNCIONES DE FILTRADO ==========

// 1. Filtrar tareas cr√≠ticas
window.filterCriticalTasksPremium = function() {
  console.log('üî¥ Filtrando tareas cr√≠ticas...');
  
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) {
    notificacionFiltro('‚ùå No hay Gantt Ejecutivo abierto');
    return;
  }
  
  const tasks = JSON.parse(ganttContainer.dataset.tasks || '[]');
  console.log('üìã Total tareas:', tasks.length);
  
  const criticalTasks = tasks.filter(t => t.critical);
  console.log('üî• Tareas cr√≠ticas encontradas:', criticalTasks.length);
  
  // Ocultar todas las tareas primero
  document.querySelectorAll('.premium-task').forEach(task => {
    task.style.display = 'none';
  });
  
  // Mostrar solo tareas cr√≠ticas
  criticalTasks.forEach(task => {
    const taskElement = document.querySelector(`.premium-task[data-task-id="${task.id}"]`);
    if (taskElement) {
      taskElement.style.display = 'flex';
      taskElement.style.background = 'rgba(231, 76, 60, 0.2)';
      taskElement.style.border = '2px solid #e74c3c';
    }
  });
  
  notificacionFiltro(`‚úÖ Mostrando ${criticalTasks.length} tareas cr√≠ticas`);
};

// 2. Filtrar tareas atrasadas - VERSI√ìN MEJORADA
window.filterDelayedTasksPremium = function() {
  console.log('‚ö° Filtrando tareas atrasadas...');
  
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) {
    notificacionFiltro('‚ùå No hay Gantt Ejecutivo abierto');
    return;
  }
  
  const tasks = JSON.parse(ganttContainer.dataset.tasks || '[]');
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  // Tareas atrasadas seg√∫n m√∫ltiples criterios
  const delayedTasks = tasks.filter(t => {
    // CRITERIO 1: Estado 'overdue' o 'rezagada' o similar
    const esEstadoAtrasado = 
      t.status === 'overdue' || 
      t.status === 'rezagada' || 
      t.status === 'rezagado' ||
      t.status === 'atrasada' ||
      t.status === 'atrasado' ||
      (t.status && t.status.toLowerCase().includes('rezag')) ||
      (t.status && t.status.toLowerCase().includes('atras'));
    
    if (esEstadoAtrasado) {
      console.log(`‚úÖ "${t.name}" detectada por estado: ${t.status}`);
      return true;
    }
    
    // CRITERIO 2: Tareas pendientes o en progreso que ya deber√≠an haber empezado
    if (t.startDay !== undefined) {
      const taskStart = new Date();
      taskStart.setDate(today.getDate() + (t.startDay || 0));
      taskStart.setHours(0, 0, 0, 0);
      
      const deberiaHaberEmpezado = 
        (t.status === 'pending' || t.status === 'inProgress') &&
        taskStart < today;
      
      if (deberiaHaberEmpezado) {
        console.log(`‚úÖ "${t.name}" detectada por fecha de inicio`);
        return true;
      }
    }
    
    // CRITERIO 3: Tareas con deadline pasado
    if (t.deadline) {
      try {
        const deadlineDate = new Date(t.deadline);
        deadlineDate.setHours(0, 0, 0, 0);
        
        const deadlinePasado = 
          (t.status === 'pending' || t.status === 'inProgress') &&
          deadlineDate < today;
        
        if (deadlinePasado) {
          console.log(`‚úÖ "${t.name}" detectada por deadline pasado`);
          return true;
        }
      } catch (e) {
        console.log(`‚ö†Ô∏è Error parseando deadline de "${t.name}":`, e.message);
      }
    }
    
    return false;
  });
  
  console.log('‚è∞ Tareas atrasadas encontradas:', delayedTasks.length);
  
  // Ocultar todas las tareas primero
  document.querySelectorAll('.premium-task').forEach(task => {
    task.style.display = 'none';
  });
  
  // Mostrar solo tareas atrasadas
  delayedTasks.forEach(task => {
    const taskElement = document.querySelector(`.premium-task[data-task-id="${task.id}"]`);
    if (taskElement) {
      taskElement.style.display = 'flex';
      taskElement.style.background = 'rgba(243, 156, 18, 0.2)';
      taskElement.style.border = '2px solid #f39c12';
      
      // Agregar indicador visual extra
      const existingBadge = taskElement.querySelector('.atrasada-badge');
      if (!existingBadge) {
        const badge = document.createElement('span');
        badge.className = 'atrasada-badge';
        badge.textContent = '‚ö†Ô∏è ATRASADA';
        badge.style.cssText = `
          position: absolute;
          top: 5px;
          right: 60px;
          background: #e74c3c;
          color: white;
          padding: 2px 8px;
          border-radius: 10px;
          font-size: 10px;
          font-weight: bold;
          z-index: 10;
        `;
        taskElement.style.position = 'relative';
        taskElement.appendChild(badge);
      }
    }
  });
  
  const mensaje = delayedTasks.length === 0 
    ? '‚úÖ No hay tareas atrasadas' 
    : `‚ö†Ô∏è Mostrando ${delayedTasks.length} tarea(s) atrasada(s)`;
  
  notificacionFiltro(mensaje);
};

// 3. Filtrar por equipo
window.filterByTeamPremium = function() {
  console.log('üë• Filtrando por equipo...');
  
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) {
    notificacionFiltro('‚ùå No hay Gantt Ejecutivo abierto');
    return;
  }
  
  const tasks = JSON.parse(ganttContainer.dataset.tasks || '[]');
  
  // Crear lista de miembros √∫nicos
  const teamMembers = new Set();
  tasks.forEach(task => {
    if (task.team && task.team.length > 0) {
      task.team.forEach(member => {
        if (member && member !== 'Sin asignar') {
          teamMembers.add(member);
        }
      });
    }
  });
  
  const membersArray = Array.from(teamMembers);
  console.log('üë• Miembros del equipo:', membersArray);
  
  if (membersArray.length === 0) {
    notificacionFiltro('‚ÑπÔ∏è No hay miembros asignados en las tareas');
    return;
  }
  
  // Eliminar selector anterior si existe
  document.querySelectorAll('#teamFilterSelector').forEach(el => el.remove());
  
  // Crear selector de miembros
  const selector = document.createElement('div');
  selector.id = 'teamFilterSelector';
  selector.innerHTML = `
    <div style="
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1a1a2e;
      border: 2px solid #3498db;
      border-radius: 12px;
      padding: 20px;
      z-index: 1000001;
      color: white;
      min-width: 300px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.7);
    ">
      <h3 style="margin: 0 0 15px 0; color: #3498db; display: flex; align-items: center; gap: 8px;">
        <span>üë•</span> Seleccionar miembro
      </h3>
      <div style="display: flex; flex-direction: column; gap: 10px; max-height: 300px; overflow-y: auto; padding-right: 5px;">
        ${membersArray.map(member => `
          <button onclick="filterByTeamMember('${member}')" style="
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid #3498db;
            color: #3498db;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
          " onmouseover="this.style.background='rgba(52, 152, 219, 0.2)'; this.style.transform='translateY(-2px)'"
             onmouseout="this.style.background='rgba(52, 152, 219, 0.1)'; this.style.transform='translateY(0)'">
            <span>üë§</span>
            <span style="flex: 1;">${member}</span>
          </button>
        `).join('')}
      </div>
      <button onclick="document.getElementById('teamFilterSelector').remove()" style="
        background: rgba(231, 76, 60, 0.2);
        border: 1px solid #e74c3c;
        color: #e74c3c;
        padding: 10px 15px;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 15px;
        width: 100%;
        font-weight: bold;
        transition: all 0.2s;
      " onmouseover="this.style.background='rgba(231, 76, 60, 0.3)'">
        Cancelar
      </button>
    </div>
  `;
  
  document.body.appendChild(selector);
  
  // Cerrar al hacer clic fuera
  selector.addEventListener('click', (e) => {
    if (e.target === selector) {
      selector.remove();
    }
  });
};

// Funci√≥n auxiliar para filtrar por miembro espec√≠fico
window.filterByTeamMember = function(memberName) {
  console.log(`üë• Filtrando tareas de: ${memberName}`);
  
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;
  
  const tasks = JSON.parse(ganttContainer.dataset.tasks || '[]');
  
  // Filtrar tareas asignadas a este miembro
  const memberTasks = tasks.filter(t => 
    t.team && t.team.some(member => member === memberName)
  );
  
  console.log(`üìã Tareas de ${memberName}:`, memberTasks.length);
  
  // Ocultar todas las tareas primero
  document.querySelectorAll('.premium-task').forEach(task => {
    task.style.display = 'none';
  });
  
  // Mostrar solo tareas del miembro
  memberTasks.forEach(task => {
    const taskElement = document.querySelector(`.premium-task[data-task-id="${task.id}"]`);
    if (taskElement) {
      taskElement.style.display = 'flex';
      taskElement.style.background = 'rgba(155, 89, 182, 0.2)';
      taskElement.style.border = '2px solid #9b59b6';
    }
  });
  
  // Eliminar selector
  const selector = document.getElementById('teamFilterSelector');
  if (selector) selector.remove();
  
  notificacionFiltro(`üë§ Mostrando ${memberTasks.length} tareas de ${memberName}`);
};

// 4. Filtrar por presupuesto
window.filterByBudgetPremium = function() {
  console.log('üí∞ Filtrando por presupuesto...');
  
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) {
    notificacionFiltro('‚ùå No hay Gantt Ejecutivo abierto');
    return;
  }
  
  const tasks = JSON.parse(ganttContainer.dataset.tasks || '[]');
  
  // Agrupar tareas por rango de presupuesto
  const budgetGroups = {
    alto: tasks.filter(t => t.estimatedTime > 40),
    medio: tasks.filter(t => t.estimatedTime >= 20 && t.estimatedTime <= 40),
    bajo: tasks.filter(t => t.estimatedTime < 20 && t.estimatedTime > 0),
    noEstimado: tasks.filter(t => !t.estimatedTime || t.estimatedTime === 0)
  };
  
  console.log('üí∞ Grupos de presupuesto:', budgetGroups);
  
  // Eliminar selector anterior si existe
  document.querySelectorAll('#budgetFilterSelector').forEach(el => el.remove());
  
  // Crear selector de rangos de presupuesto
  const selector = document.createElement('div');
  selector.id = 'budgetFilterSelector';
  selector.innerHTML = `
    <div style="
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1a1a2e;
      border: 2px solid #2ecc71;
      border-radius: 12px;
      padding: 20px;
      z-index: 1000001;
      color: white;
      min-width: 350px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.7);
    ">
      <h3 style="margin: 0 0 15px 0; color: #2ecc71; display: flex; align-items: center; gap: 8px;">
        <span>üí∞</span> Seleccionar rango de presupuesto
      </h3>
      <div style="display: flex; flex-direction: column; gap: 10px;">
        <button onclick="filterByBudgetRange('alto')" style="
          background: rgba(231, 76, 60, 0.1);
          border: 1px solid #e74c3c;
          color: #e74c3c;
          padding: 12px 15px;
          border-radius: 8px;
          cursor: pointer;
          text-align: left;
          transition: all 0.2s;
          display: flex;
          justify-content: space-between;
          align-items: center;
        " onmouseover="this.style.background='rgba(231, 76, 60, 0.2)'; this.style.transform='translateY(-2px)'"
           onmouseout="this.style.background='rgba(231, 76, 60, 0.1)'; this.style.transform='translateY(0)'">
          <span>üî¥ Alto (> 40 horas)</span>
          <span style="background: #e74c3c; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
            ${budgetGroups.alto.length}
          </span>
        </button>
        <button onclick="filterByBudgetRange('medio')" style="
          background: rgba(243, 156, 18, 0.1);
          border: 1px solid #f39c12;
          color: #f39c12;
          padding: 12px 15px;
          border-radius: 8px;
          cursor: pointer;
          text-align: left;
          transition: all 0.2s;
          display: flex;
          justify-content: space-between;
          align-items: center;
        " onmouseover="this.style.background='rgba(243, 156, 18, 0.2)'; this.style.transform='translateY(-2px)'"
           onmouseout="this.style.background='rgba(243, 156, 18, 0.1)'; this.style.transform='translateY(0)'">
          <span>üü° Medio (20-40 horas)</span>
          <span style="background: #f39c12; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
            ${budgetGroups.medio.length}
          </span>
        </button>
        <button onclick="filterByBudgetRange('bajo')" style="
          background: rgba(46, 204, 113, 0.1);
          border: 1px solid #2ecc71;
          color: #2ecc71;
          padding: 12px 15px;
          border-radius: 8px;
          cursor: pointer;
          text-align: left;
          transition: all 0.2s;
          display: flex;
          justify-content: space-between;
          align-items: center;
        " onmouseover="this.style.background='rgba(46, 204, 113, 0.2)'; this.style.transform='translateY(-2px)'"
           onmouseout="this.style.background='rgba(46, 204, 113, 0.1)'; this.style.transform='translateY(0)'">
          <span>üü¢ Bajo (< 20 horas)</span>
          <span style="background: #2ecc71; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
            ${budgetGroups.bajo.length}
          </span>
        </button>
        <button onclick="filterByBudgetRange('noEstimado')" style="
          background: rgba(149, 165, 166, 0.1);
          border: 1px solid #95a5a6;
          color: #95a5a6;
          padding: 12px 15px;
          border-radius: 8px;
          cursor: pointer;
          text-align: left;
          transition: all 0.2s;
          display: flex;
          justify-content: space-between;
          align-items: center;
        " onmouseover="this.style.background='rgba(149, 165, 166, 0.2)'; this.style.transform='translateY(-2px)'"
           onmouseout="this.style.background='rgba(149, 165, 166, 0.1)'; this.style.transform='translateY(0)'">
          <span>‚ö™ No estimado</span>
          <span style="background: #95a5a6; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
            ${budgetGroups.noEstimado.length}
          </span>
        </button>
      </div>
      <button onclick="document.getElementById('budgetFilterSelector').remove()" style="
        background: rgba(231, 76, 60, 0.2);
        border: 1px solid #e74c3c;
        color: #e74c3c;
        padding: 10px 15px;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 15px;
        width: 100%;
        font-weight: bold;
        transition: all 0.2s;
      " onmouseover="this.style.background='rgba(231, 76, 60, 0.3)'">
        Cancelar
      </button>
    </div>
  `;
  
  document.body.appendChild(selector);
  
  // Cerrar al hacer clic fuera
  selector.addEventListener('click', (e) => {
    if (e.target === selector) {
      selector.remove();
    }
  });
};

// Funci√≥n auxiliar para filtrar por rango de presupuesto
window.filterByBudgetRange = function(range) {
  console.log(`üí∞ Filtrando por rango: ${range}`);
  
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;
  
  const tasks = JSON.parse(ganttContainer.dataset.tasks || '[]');
  
  let filteredTasks = [];
  const colors = {
    alto: { emoji: 'üî¥' },
    medio: { emoji: 'üü°' },
    bajo: { emoji: 'üü¢' },
    noEstimado: { emoji: '‚ö™' }
  };
  
  switch(range) {
    case 'alto':
      filteredTasks = tasks.filter(t => t.estimatedTime > 40);
      break;
    case 'medio':
      filteredTasks = tasks.filter(t => t.estimatedTime >= 20 && t.estimatedTime <= 40);
      break;
    case 'bajo':
      filteredTasks = tasks.filter(t => t.estimatedTime < 20 && t.estimatedTime > 0);
      break;
    case 'noEstimado':
      filteredTasks = tasks.filter(t => !t.estimatedTime || t.estimatedTime === 0);
      break;
  }
  
  // Ocultar todas las tareas primero
  document.querySelectorAll('.premium-task').forEach(task => {
    task.style.display = 'none';
  });
  
  // Mostrar solo tareas del rango seleccionado
  filteredTasks.forEach(task => {
    const taskElement = document.querySelector(`.premium-task[data-task-id="${task.id}"]`);
    if (taskElement) {
      taskElement.style.display = 'flex';
      taskElement.style.background = range === 'alto' ? 'rgba(231, 76, 60, 0.2)' : 
                                   range === 'medio' ? 'rgba(243, 156, 18, 0.2)' : 
                                   range === 'bajo' ? 'rgba(46, 204, 113, 0.2)' : 
                                   'rgba(149, 165, 166, 0.2)';
      taskElement.style.border = range === 'alto' ? '2px solid #e74c3c' : 
                                range === 'medio' ? '2px solid #f39c12' : 
                                range === 'bajo' ? '2px solid #2ecc71' : 
                                '2px solid #95a5a6';
    }
  });
  
  // Eliminar selector
  const selector = document.getElementById('budgetFilterSelector');
  if (selector) selector.remove();
  
  notificacionFiltro(`${colors[range].emoji} Mostrando ${filteredTasks.length} tareas con presupuesto ${range}`);
};

// 5. Mostrar todas las tareas
window.showAllTasksPremium = function() {
  console.log('üìã Mostrando todas las tareas...');
  
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) {
    notificacionFiltro('‚ùå No hay Gantt Ejecutivo abierto');
    return;
  }
  
  // Remover todos los badges de atrasadas
  document.querySelectorAll('.atrasada-badge').forEach(badge => badge.remove());
  
  // Mostrar todas las tareas y restaurar estilos
  document.querySelectorAll('.premium-task').forEach(task => {
    task.style.display = 'flex';
    task.style.background = '';
    task.style.border = '';
    task.style.position = '';
  });
  
  notificacionFiltro('‚úÖ Mostrando todas las tareas');
};

// ===================================================================
// üéØ FIN DEL C√ìDIGO DE FILTROS EJECUTIVOS
// ===================================================================







// ========== FUNCI√ìN PARA MOSTRAR TODAS LAS DEPENDENCIAS ==========
window.showAllDependencies = function() {
  console.log('üîó Mostrando todas las dependencias...');
  
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) {
    notificacionFiltro('‚ùå No hay Gantt Ejecutivo abierto');
    return;
  }
  
  const tasks = JSON.parse(ganttContainer.dataset.tasks || '[]');
  
  // Recolectar todas las dependencias
  const allDependencies = [];
  
  tasks.forEach(task => {
    if (task.dependencies && task.dependencies.length > 0) {
      task.dependencies.forEach(depId => {
        const depTask = tasks.find(t => t.id.toString() === depId.toString());
        if (depTask) {
          allDependencies.push({
            fromTask: depTask,
            toTask: task,
            fromId: depTask.id,
            toId: task.id,
            fromName: depTask.name,
            toName: task.name
          });
        }
      });
    }
  });
  
  console.log('üìä Total dependencias encontradas:', allDependencies.length);
  
  if (allDependencies.length === 0) {
    notificacionFiltro('‚ÑπÔ∏è No hay dependencias definidas en el proyecto');
    return;
  }
  
  // Crear modal para mostrar todas las dependencias
  const overlay = document.createElement('div');
  overlay.id = 'allDependenciesOverlay';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    z-index: 1000000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  `;
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
    border-radius: 20px;
    border: 2px solid rgba(155, 89, 182, 0.4);
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 30px 60px rgba(0,0,0,0.7);
    display: flex;
    flex-direction: column;
  `;
  
  // Crear contenido del modal
  modal.innerHTML = `
    <div style="
      padding: 25px;
      background: linear-gradient(90deg, #0a0a1a, #1a1a3a);
      border-bottom: 1px solid rgba(155, 89, 182, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    ">
      <div>
        <h2 style="margin: 0 0 8px 0; color: white; font-size: 24px; display: flex; align-items: center; gap: 10px;">
          <span style="color: #9b59b6;">üîó</span> 
          <span>Todas las Dependencias</span>
        </h2>
        <p style="margin: 0; color: #95a5a6; font-size: 14px;">
          ${allDependencies.length} dependencia(s) definida(s) en el proyecto
        </p>
      </div>
      <button onclick="document.getElementById('allDependenciesOverlay').remove()" style="
        background: rgba(231, 76, 60, 0.2);
        border: 1px solid #e74c3c;
        color: #e74c3c;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
      ">
        √ó Cerrar
      </button>
    </div>
    
    <div style="flex: 1; overflow-y: auto; padding: 20px;">
      <div style="
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
        max-height: 60vh;
        overflow-y: auto;
        padding-right: 10px;
      ">
        ${allDependencies.map((dep, index) => `
          <div style="
            background: rgba(155, 89, 182, 0.1);
            border: 1px solid rgba(155, 89, 182, 0.3);
            border-radius: 12px;
            padding: 18px;
            transition: all 0.3s ease;
            position: relative;
          " onmouseover="this.style.transform='translateY(-3px)'; this.style.background='rgba(155, 89, 182, 0.15)'"
             onmouseout="this.style.transform='translateY(0)'; this.style.background='rgba(155, 89, 182, 0.1)'">
            
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
              <div style="
                width: 32px;
                height: 32px;
                background: rgba(155, 89, 182, 0.3);
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #9b59b6;
                font-weight: bold;
                font-size: 14px;
                flex-shrink: 0;
              ">
                ${index + 1}
              </div>
              <div style="flex: 1;">
                <div style="color: white; font-weight: bold; font-size: 16px; margin-bottom: 4px;">
                  Dependencia #${index + 1}
                </div>
                <div style="color: #95a5a6; font-size: 12px;">
                  ID: ${dep.fromId} ‚Üí ${dep.toId}
                </div>
              </div>
              <div style="
                background: rgba(155, 89, 182, 0.2);
                color: #9b59b6;
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: bold;
                display: flex;
                align-items: center;
                gap: 6px;
              ">
                <span>üîó</span>
                <span>DEPENDENCIA</span>
              </div>
            </div>
            
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px;">
              <div style="text-align: center; flex: 1;">
                <div style="color: #3498db; font-size: 14px; font-weight: bold; margin-bottom: 5px;">
                  TAREA ORIGEN
                </div>
                <div style="color: white; font-size: 15px; font-weight: 500;">
                  ${dep.fromName}
                </div>
                <div style="color: #95a5a6; font-size: 12px; margin-top: 5px;">
                  ID: ${dep.fromId}
                </div>
              </div>
              
              <div style="padding: 0 20px;">
                <div style="
                  width: 60px;
                  height: 60px;
                  background: rgba(155, 89, 182, 0.3);
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  color: #9b59b6;
                  font-size: 24px;
                  animation: pulse 2s infinite;
                ">
                  ‚û°
                </div>
              </div>
              
              <div style="text-align: center; flex: 1;">
                <div style="color: #e74c3c; font-size: 14px; font-weight: bold; margin-bottom: 5px;">
                  TAREA DESTINO
                </div>
                <div style="color: white; font-size: 15px; font-weight: 500;">
                  ${dep.toName}
                </div>
                <div style="color: #95a5a6; font-size: 12px; margin-top: 5px;">
                  ID: ${dep.toId}
                </div>
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 15px;">
              <div style="
                padding: 12px;
                background: rgba(52, 152, 219, 0.1);
                border-radius: 8px;
                border: 1px solid rgba(52, 152, 219, 0.2);
              ">
                <div style="color: #3498db; font-size: 12px; margin-bottom: 5px;">ESTADO ORIGEN</div>
                <div style="color: white; font-size: 14px; font-weight: bold;">
                  ${dep.fromTask.status || 'No definido'}
                </div>
              </div>
              
              <div style="
                padding: 12px;
                background: rgba(231, 76, 60, 0.1);
                border-radius: 8px;
                border: 1px solid rgba(231, 76, 60, 0.2);
              ">
                <div style="color: #e74c3c; font-size: 12px; margin-bottom: 5px;">ESTADO DESTINO</div>
                <div style="color: white; font-size: 14px; font-weight: bold;">
                  ${dep.toTask.status || 'No definido'}
                </div>
              </div>
            </div>
            
            <div style="
              margin-top: 15px;
              padding-top: 15px;
              border-top: 1px solid rgba(255,255,255,0.1);
              display: flex;
              justify-content: space-between;
              align-items: center;
            ">
              <div style="display: flex; gap: 10px;">
                <button onclick="zoomToDependency(${dep.fromId}, ${dep.toId})" style="
                  background: rgba(52, 152, 219, 0.2);
                  border: 1px solid #3498db;
                  color: #3498db;
                  padding: 8px 15px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 12px;
                  display: flex;
                  align-items: center;
                  gap: 6px;
                  transition: all 0.2s;
                " onmouseover="this.style.background='rgba(52, 152, 219, 0.3)'"
                   onmouseout="this.style.background='rgba(52, 152, 219, 0.2)'">
                  üîç Zoom
                </button>
                <button onclick="highlightDependency(${dep.fromId}, ${dep.toId})" style="
                  background: rgba(46, 204, 113, 0.2);
                  border: 1px solid #2ecc71;
                  color: #2ecc71;
                  padding: 8px 15px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 12px;
                  display: flex;
                  align-items: center;
                  gap: 6px;
                  transition: all 0.2s;
                " onmouseover="this.style.background='rgba(46, 204, 113, 0.3)'"
                   onmouseout="this.style.background='rgba(46, 204, 113, 0.2)'">
                  ‚ú® Resaltar
                </button>
              </div>
              
              <div style="color: #95a5a6; font-size: 11px; font-style: italic;">
                Hacer clic en una tarea para ver detalles
              </div>
            </div>
          </div>
        `).join('')}
      </div>
      
      ${allDependencies.length === 0 ? `
        <div style="
          text-align: center;
          padding: 60px 20px;
          color: #95a5a6;
        ">
          <div style="font-size: 48px; margin-bottom: 20px;">üîó</div>
          <h3 style="color: #f39c12; margin: 0 0 10px 0;">Sin dependencias</h3>
          <p>No hay dependencias definidas entre tareas.</p>
          <p style="font-size: 12px; margin-top: 20px;">
            Usa el bot√≥n "Crear Dependencias" para definir relaciones entre tareas
          </p>
        </div>
      ` : ''}
    </div>
    
    <div style="
      padding: 15px 25px;
      background: rgba(255,255,255,0.03);
      border-top: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #95a5a6;
      font-size: 13px;
    ">
      <div>
        <span>üìä ${allDependencies.length} dependencia(s) ‚Ä¢ Sistema de Gesti√≥n de Dependencias</span>
      </div>
      <div style="display: flex; gap: 12px;">
        <button onclick="exportDependenciesList()" style="
          background: rgba(155, 89, 182, 0.2);
          border: 1px solid #9b59b6;
          color: #9b59b6;
          padding: 8px 15px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 12px;
        ">
          üì• Exportar Lista
        </button>
        <button onclick="openDependencyCreator()" style="
          background: rgba(46, 204, 113, 0.2);
          border: 1px solid #2ecc71;
          color: #2ecc71;
          padding: 8px 15px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 12px;
        ">
          ‚ûï Crear Nueva
        </button>
      </div>
    </div>
  `;
  
  // Agregar animaci√≥n CSS
  if (!document.getElementById('dependency-animations')) {
    const style = document.createElement('style');
    style.id = 'dependency-animations';
    style.textContent = `
      @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
      }
      
      #allDependenciesOverlay {
        animation: fadeIn 0.3s ease-out;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
    `;
    document.head.appendChild(style);
  }
  
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  
  // Cerrar al hacer clic fuera del modal
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      overlay.remove();
    }
  });
  
  notificacionFiltro(`üîó Mostrando ${allDependencies.length} dependencias`);
};

// ========== FUNCIONES AUXILIARES PARA EL MODAL ==========

// Funci√≥n para hacer zoom a una dependencia espec√≠fica
window.zoomToDependency = function(fromId, toId) {
  console.log(`üîç Zoom a dependencia: ${fromId} ‚Üí ${toId}`);
  
  // Ocultar todas las tareas
  document.querySelectorAll('.premium-task').forEach(task => {
    task.style.display = 'none';
  });
  
  // Mostrar solo las tareas de esta dependencia
  const fromTask = document.querySelector(`.premium-task[data-task-id="${fromId}"]`);
  const toTask = document.querySelector(`.premium-task[data-task-id="${toId}"]`);
  
  if (fromTask) {
    fromTask.style.display = 'flex';
    fromTask.style.background = 'rgba(52, 152, 219, 0.2)';
    fromTask.style.border = '2px solid #3498db';
    fromTask.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
  
  if (toTask) {
    toTask.style.display = 'flex';
    toTask.style.background = 'rgba(231, 76, 60, 0.2)';
    toTask.style.border = '2px solid #e74c3c';
  }
  
  notificacionFiltro(`üîç Zoom a dependencia entre tareas ${fromId} ‚Üí ${toId}`);
};

// Funci√≥n para resaltar una dependencia
window.highlightDependency = function(fromId, toId) {
  console.log(`‚ú® Resaltando dependencia: ${fromId} ‚Üí ${toId}`);
  
  // Quitar resaltado anterior
  document.querySelectorAll('.premium-task').forEach(task => {
    task.style.boxShadow = '';
    task.style.transform = '';
  });
  
  // Resaltar las tareas de esta dependencia
  const fromTask = document.querySelector(`.premium-task[data-task-id="${fromId}"]`);
  const toTask = document.querySelector(`.premium-task[data-task-id="${toId}"]`);
  
  if (fromTask) {
    fromTask.style.boxShadow = '0 0 0 3px rgba(52, 152, 219, 0.5), 0 10px 30px rgba(52, 152, 219, 0.3)';
    fromTask.style.transform = 'translateY(-5px)';
    fromTask.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
  
  if (toTask) {
    toTask.style.boxShadow = '0 0 0 3px rgba(231, 76, 60, 0.5), 0 10px 30px rgba(231, 76, 60, 0.3)';
    toTask.style.transform = 'translateY(-5px)';
  }
  
  // Quitar resaltado despu√©s de 5 segundos
  setTimeout(() => {
    if (fromTask) {
      fromTask.style.boxShadow = '';
      fromTask.style.transform = '';
    }
    if (toTask) {
      toTask.style.boxShadow = '';
      toTask.style.transform = '';
    }
  }, 5000);
  
  notificacionFiltro(`‚ú® Dependencia resaltada: ${fromId} ‚Üí ${toId}`);
};

// Funci√≥n para exportar lista de dependencias
window.exportDependenciesList = function() {
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;
  
  const tasks = JSON.parse(ganttContainer.dataset.tasks || '[]');
  const allDependencies = [];
  
  tasks.forEach(task => {
    if (task.dependencies && task.dependencies.length > 0) {
      task.dependencies.forEach(depId => {
        const depTask = tasks.find(t => t.id.toString() === depId.toString());
        if (depTask) {
          allDependencies.push({
            'ID Origen': depTask.id,
            'Tarea Origen': depTask.name,
            'ID Destino': task.id,
            'Tarea Destino': task.name,
            'Estado Origen': depTask.status || 'No definido',
            'Estado Destino': task.status || 'No definido',
            'Cr√≠tica Origen': depTask.critical ? 'S√≠' : 'No',
            'Cr√≠tica Destino': task.critical ? 'S√≠' : 'No'
          });
        }
      });
    }
  });
  
  if (allDependencies.length === 0) {
    notificacionFiltro('‚ÑπÔ∏è No hay dependencias para exportar');
    return;
  }
  
  // Crear contenido CSV
  const headers = Object.keys(allDependencies[0]).join(',');
  const rows = allDependencies.map(dep => 
    Object.values(dep).map(val => `"${val}"`).join(',')
  );
  const csvContent = [headers, ...rows].join('\n');
  
  // Crear y descargar archivo
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  
  link.setAttribute('href', url);
  link.setAttribute('download', `dependencias_${new Date().toISOString().slice(0,10)}.csv`);
  link.style.visibility = 'hidden';
  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  notificacionFiltro(`üì• Exportadas ${allDependencies.length} dependencias a CSV`);
};

// Funci√≥n para abrir creador de dependencias (placeholder)
window.openDependencyCreator = function() {
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;
  
  // OBTENER EL PROYECTO ACTUAL CORRECTAMENTE
  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  
  // Verificar que el proyecto existe
  if (projectIndex >= projects.length || projectIndex < 0) {
    alert('Error: Proyecto no v√°lido.');
    return;
  }
  
  const currentProject = projects[projectIndex];
  const currentTasks = currentProject.tasks || [];
  
  console.log('üîç Abriendo creador de dependencias para proyecto:', currentProject.name);
  console.log('üìã Tareas del proyecto actual:', currentTasks.length);
  
  if (currentTasks.length === 0) {
    alert('No hay tareas disponibles para crear dependencias.');
    return;
  }
  
  // Crear overlay
  const overlay = document.createElement('div');
  overlay.className = 'dependency-overlay';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(5px);
    z-index: 1000000;
  `;
  overlay.onclick = closeDependencyCreator;
  
  // Crear modal
  const modal = document.createElement('div');
  modal.className = 'dependency-modal';
  modal.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 600px;
    background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
    border-radius: 20px;
    padding: 30px;
    z-index: 1000001;
    box-shadow: 0 30px 60px rgba(0,0,0,0.8);
    border: 2px solid rgba(155, 89, 182, 0.4);
    color: white;
  `;
  
  // Transformar tareas para mostrar (igual que en el Gantt)
  const transformedTasks = currentTasks.map((task, index) => {
    const statusColors = {
      'pending': '#f1c40f',
      'inProgress': '#3498db', 
      'completed': '#2ecc71',
      'overdue': '#e74c3c'
    };
    
    const isCritical = task.priority === 'alta' || task.status === 'overdue';
    
    return {
      id: task.id || Date.now() + index,
      name: task.name || `Tarea ${index + 1}`,
      color: statusColors[task.status] || '#95a5a6',
      critical: isCritical,
      dependencies: task.dependencies || [],
      status: task.status || 'pending',
      priority: task.priority || 'media',
      originalTask: task
    };
  });
  
// CORRECCI√ìN: Construcci√≥n correcta de dependencias existentes
const existingDependencies = [];

currentTasks.forEach(task => {
  const toId = task.id;
  const deps = Array.isArray(task.dependencies) ? task.dependencies : [];

  deps.forEach(fromId => {
    const fromTask = transformedTasks.find(t => t.id.toString() === fromId.toString());
    const toTask = transformedTasks.find(t => t.id.toString() === toId.toString());

    if (fromTask && toTask) {
      existingDependencies.push({
        from: fromTask,
        to: toTask,
        fromId,
        toId
      });
    }
  });
});



// SINCRONIZAR TODAS LAS DEPENDENCIAS AL ESTADO GLOBAL
window.currentDependencies = existingDependencies.map(dep => ({
    fromId: dep.fromId,
    toId: dep.toId
}));
console.log("üåê currentDependencies cargadas:", window.currentDependencies);




  modal.innerHTML = `
    <h3 style="color: #9b59b6; margin-top: 0; margin-bottom: 20px; text-align: center;">
      üîó Gestor de Dependencias - ${currentProject.name}
    </h3>
    
    <div style="margin-bottom: 15px; color: #95a5a6; text-align: center;">
      Proyecto actual: <strong style="color: #2ecc71;">${currentProject.name}</strong>
      <br>Tareas disponibles: <strong>${transformedTasks.length}</strong>
    </div>
    
    <div style="display: flex; gap: 15px; margin-bottom: 25px; align-items: center;">
      <select id="fromTaskSelect" style="
        flex: 1;
        padding: 12px;
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(155, 89, 182, 0.3);
        border-radius: 8px;
        color: white;
        font-size: 14px;
      ">
        <option value="">Seleccionar tarea origen</option>
        ${transformedTasks.map((task, index) => `
          <option value="${task.id}">${index + 1}. ${task.name}</option>
        `).join('')}
      </select>
      
      <div style="color: #9b59b6; font-size: 18px; margin: 0 10px;">‚û°</div>
      
      <select id="toTaskSelect" style="
        flex: 1;
        padding: 12px;
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(155, 89, 182, 0.3);
        border-radius: 8px;
        color: white;
        font-size: 14px;
      ">
        <option value="">Seleccionar tarea destino</option>
        ${transformedTasks.map((task, index) => `
          <option value="${task.id}">${index + 1}. ${task.name}</option>
        `).join('')}
      </select>
      
      <button onclick="addNewDependency()" style="
        background: linear-gradient(45deg, #9b59b6, #8e44ad);
        border: none;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 8px;
      ">
        ‚ûï Agregar
      </button>
    </div>
    
    <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; margin-bottom: 25px; border: 1px solid rgba(155, 89, 182, 0.2);">
      <h4 style="color: #9b59b6; margin-top: 0; margin-bottom: 15px;">Dependencias Actuales</h4>
      <div id="dependenciesList">
        ${existingDependencies.length > 0 ? 
          existingDependencies.map(dep => `
           <div class="dependency-item"
     data-from-id="${dep.fromId}"
     data-to-id="${dep.toId}"
     style="
       display: flex;
       align-items: center;
       justify-content: space-between;
       padding: 10px 15px;
       background: rgba(155, 89, 182, 0.1);
       border-radius: 8px;
       margin-bottom: 10px;
     ">

              <div style="display: flex; align-items: center; gap: 10px;">
                <div style="
                  width: 24px;
                  height: 24px;
                  background: ${dep.from.color || '#9b59b6'};
                  border-radius: 6px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  color: white;
                  font-size: 12px;
                  font-weight: bold;
                ">
                  ${transformedTasks.findIndex(t => t.id.toString() === dep.fromId.toString()) + 1}
                </div>
                <span style="font-weight: bold; color: white;">${dep.from.name}</span>
                <span style="color: #9b59b6; font-size: 18px; margin: 0 10px;">‚û°</span>
                <div style="
                  width: 24px;
                  height: 24px;
                  background: ${dep.to.color || '#3498db'};
                  border-radius: 6px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  color: white;
                  font-size: 12px;
                  font-weight: bold;
                ">
                  ${transformedTasks.findIndex(t => t.id.toString() === dep.toId.toString()) + 1}
                </div>
                <span style="color: white;">${dep.to.name}</span>
              </div>
              <div style="display: flex; gap: 8px;">
                <button onclick="removeExistingDependency('${dep.fromId}', '${dep.toId}', ${projectIndex})" style="
                  width: 30px;
                  height: 30px;
                  border-radius: 6px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  cursor: pointer;
                  border: none;
                  font-size: 14px;
                  background: rgba(231, 76, 60, 0.2);
                  color: #e74c3c;
                " title="Eliminar">
                  üóëÔ∏è
                </button>
              </div>
            </div>
          `).join('') : 
          '<div style="color: #95a5a6; text-align: center; padding: 20px; font-style: italic;">No hay dependencias definidas</div>'
        }
      </div>
    </div>
    
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div style="color: #95a5a6; font-size: 13px;">
        ${existingDependencies.length} dependencia(s) definida(s)
      </div>
      <div style="display: flex; gap: 10px;">
        <button onclick="closeDependencyCreator()" style="
          background: rgba(255,255,255,0.1);
          border: 1px solid rgba(255,255,255,0.3);
          color: white;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
        ">
          Cancelar
        </button>
        <button onclick="saveDependencies(${projectIndex})" style="
          background: linear-gradient(45deg, #2ecc71, #27ae60);
          border: none;
          color: white;
          padding: 10px 30px;
          border-radius: 8px;
          cursor: pointer;
          font-weight: bold;
        ">
          üíæ Guardar Cambios
        </button>
      </div>
    </div>
  `;
  
  // Guardar datos en el modal para uso posterior
  modal.dataset.projectIndex = projectIndex;
  modal.dataset.tasks = JSON.stringify(transformedTasks);
  modal.dataset.originalTasks = JSON.stringify(currentTasks);
  
  document.body.appendChild(overlay);
  document.body.appendChild(modal);
};

// ========== FUNCIONES PARA EL MODAL DE DEPENDENCIAS ==========

// Funci√≥n para cerrar el modal de dependencias
window.closeDependencyCreator = function() {
  console.log('üîí Cerrando creador de dependencias...');
  const overlay = document.querySelector('.dependency-overlay');
  const modal = document.querySelector('.dependency-modal');
  
  if (overlay) overlay.remove();
  if (modal) modal.remove();
  
  console.log('‚úÖ Modal de dependencias cerrado');
};

// Funci√≥n para verificar dependencias c√≠clicas
function checkCyclicDependency(tasks, fromId, toId) {
  console.log(`üîç Verificando ciclo: ${fromId} -> ${toId}`);
  
  const visited = new Set();
  
  function hasPath(currentId, targetId) {
    if (currentId.toString() === targetId.toString()) return true;
    if (visited.has(currentId)) return false;
    
    visited.add(currentId);
    
    const currentTask = tasks.find(t => t.id.toString() === currentId.toString());
    if (!currentTask || !currentTask.dependencies) return false;
    
    for (const depId of currentTask.dependencies) {
      if (hasPath(depId, targetId)) return true;
    }
    
    return false;
  }
  
  return hasPath(toId, fromId);
}

// Funci√≥n para eliminar dependencias existentes
window.removeExistingDependency = function(fromId, toId, projectIndex) {
  console.log(`üóëÔ∏è Eliminando dependencia: ${fromId} -> ${toId}`);
  
  if (projectIndex >= projects.length || projectIndex < 0) {
    console.error('√çndice de proyecto inv√°lido');
    return;
  }
  
  const currentProject = projects[projectIndex];
  const task = currentProject.tasks.find(t => t.id.toString() === toId.toString());
  
  if (task && task.dependencies) {
    const index = task.dependencies.findIndex(dep => dep.toString() === fromId.toString());
    if (index !== -1) {
      task.dependencies.splice(index, 1);
      console.log(`‚úÖ Dependencia eliminada de "${task.name}"`);
      
      // Actualizar lista visual
      const dependencyItem = document.querySelector(`.dependency-item[data-from-id="${fromId}"][data-to-id="${toId}"]`);
      if (dependencyItem) {
        dependencyItem.remove();
      }
      
      // Si no quedan dependencias, mostrar mensaje
      const dependenciesList = document.getElementById('dependenciesList');
      if (dependenciesList && dependenciesList.children.length === 0) {
        dependenciesList.innerHTML = '<div style="color: #95a5a6; text-align: center; padding: 20px; font-style: italic;">No hay dependencias definidas</div>';
      }
    }
  }
};

// Funci√≥n para eliminar dependencias nuevas (a√∫n no guardadas)
window.removeNewDependency = function(button) {
  console.log('üóëÔ∏è Eliminando dependencia nueva...');
  const dependencyItem = button.closest('.dependency-item');
  if (dependencyItem) {
    dependencyItem.remove();
    
    // Si no quedan dependencias, mostrar mensaje
    const dependenciesList = document.getElementById('dependenciesList');
    if (dependenciesList && dependenciesList.children.length === 0) {
      dependenciesList.innerHTML = '<div style="color: #95a5a6; text-align: center; padding: 20px; font-style: italic;">No hay dependencias definidas</div>';
    }
  }
};

// Funci√≥n para refrescar la vista Gantt
function refreshGanttView() {
  console.log('üîÑ Refrescando Gantt SIN flash (modo enterprise)...');

  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) {
    console.log('‚ÑπÔ∏è No hay Gantt activo para refrescar');
    return;
  }

  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  currentProjectIndex = projectIndex;

  // ‚úÖ Mostrar loader elegante (evita flash visual)
  ganttContainer.innerHTML = `
    <div style="
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(10, 10, 26, 0.94);
      backdrop-filter: blur(4px);
      display: flex; align-items: center; justify-content: center;
      color: #a78bfa; font-size: 16px; z-index: 999999;
      font-family: sans-serif;
    ">üîÑ Actualizando diagrama...</div>
  `;

  // ‚úÖ Reconstruir contenido DENTRO del mismo contenedor (sin eliminarlo)
  setTimeout(() => {
    try {
      // Limpiar loader
      ganttContainer.innerHTML = '';

      // Forzar estilos de vista completa
      ganttContainer.style.position = 'fixed';
      ganttContainer.style.top = '0';
      ganttContainer.style.left = '0';
      ganttContainer.style.width = '100vw';
      ganttContainer.style.height = '100vh';
      ganttContainer.style.zIndex = '999998';

      // Crear contenido del Gantt DENTRO del contenedor existente
      createCompleteGanttForCurrentProject();

      console.log('‚úÖ Gantt refrescado sin flash');
    } catch (error) {
      console.error('‚ùå Error al refrescar Gantt:', error);
      ganttContainer.innerHTML = '<div style="padding:20px;color:#ef4444;">Error al cargar el Gantt. Recargue la p√°gina.</div>';
    }
  }, 120);
}




// ========== FUNCI√ìN PARA AGREGAR NUEVA DEPENDENCIA - CORREGIDA ==========
window.addNewDependency = function() {
  const modal = document.querySelector('.dependency-modal');
  if (!modal) return;
  
  const fromSelect = document.getElementById('fromTaskSelect');
  const toSelect = document.getElementById('toTaskSelect');
  
  const fromId = fromSelect.value;
  const toId = toSelect.value;
  
  console.log('‚ûï Intentando agregar dependencia:', { fromId, toId });
  
  if (!fromId || !toId) {
    alert('Por favor selecciona ambas tareas.');
    return;
  }
  
  if (fromId === toId) {
    alert('Una tarea no puede depender de s√≠ misma.');
    return;
  }
  
  // Obtener tareas del modal
  const tasks = JSON.parse(modal.dataset.tasks || '[]');
  
  // Encontrar las tareas
  const fromTask = tasks.find(t => t.id.toString() === fromId.toString());
  const toTask = tasks.find(t => t.id.toString() === toId.toString());
  
  console.log('üîç Tareas encontradas:', { fromTask, toTask });
  
  if (!fromTask || !toTask) {
    alert('Error: No se encontraron las tareas seleccionadas.');
    return;
  }
  
  // Verificar si la dependencia ya existe
  if (toTask.dependencies && toTask.dependencies.includes(fromId)) {
    alert('Esta dependencia ya existe.');
    return;
  }
  
  // Verificar dependencias c√≠clicas
  if (checkCyclicDependency(tasks, toId, fromId)) {
    alert('No se puede crear esta dependencia porque crear√≠a un ciclo.');
    return;
  }
  
  const fromIndex = tasks.findIndex(t => t.id.toString() === fromId.toString()) + 1;
  const toIndex = tasks.findIndex(t => t.id.toString() === toId.toString()) + 1;
  
  const dependencyItem = document.createElement('div');
  dependencyItem.className = 'dependency-item';
  dependencyItem.style.cssText = `
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 15px;
    background: rgba(155, 89, 182, 0.1);
    border-radius: 8px;
    margin-bottom: 10px;
  `;
  dependencyItem.innerHTML = `
    <div style="display: flex; align-items: center; gap: 10px;">
      <div style="
        width: 24px;
        height: 24px;
        background: ${fromTask.color || '#9b59b6'};
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: bold;
      ">
        ${fromIndex}
      </div>
      <span style="font-weight: bold; color: white;">${fromTask.name}</span>
      <span style="color: #9b59b6; font-size: 18px; margin: 0 10px;">‚û°</span>
      <div style="
        width: 24px;
        height: 24px;
        background: ${toTask.color || '#3498db'};
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: bold;
      ">
        ${toIndex}
      </div>
      <span style="color: white;">${toTask.name}</span>
    </div>
    <div style="display: flex; gap: 8px;">
      <button onclick="removeNewDependency(this)" style="
        width: 30px;
        height: 30px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: none;
        font-size: 14px;
        background: rgba(231, 76, 60, 0.2);
        color: #e74c3c;
      " title="Eliminar">
        üóëÔ∏è
      </button>
    </div>
  `;
  
  dependencyItem.dataset.fromId = fromId;
  dependencyItem.dataset.toId = toId;
  
  const dependenciesList = document.getElementById('dependenciesList');
  
  // Si no hay dependencias, limpiar el mensaje
  if (dependenciesList.firstChild && 
      dependenciesList.firstChild.style && 
      dependenciesList.firstChild.style.color === 'rgb(149, 165, 166)') {
    dependenciesList.innerHTML = '';
  }
  
  dependenciesList.appendChild(dependencyItem);
  
  console.log('‚úÖ Dependencia agregada visualmente');
  

// üî• Actualizar el estado global de dependencias
window.currentDependencies.push({ 
    fromId: fromId, 
    toId: toId 
});
console.log("üåê Estado actualizado:", window.currentDependencies);




  // Limpiar selecciones
  fromSelect.value = '';
  toSelect.value = '';
};

// ========== FUNCI√ìN PARA GUARDAR DEPENDENCIAS - CORREGIDA ==========
// ========== FUNCI√ìN PARA GUARDAR DEPENDENCIAS - VERSI√ìN CORREGIDA ==========
window.saveDependencies = function(projectIndex) {
  console.log('üíæ GUARDANDO DEPENDENCIAS...');
  console.log('Project index:', projectIndex);
  
  const modal = document.querySelector('.dependency-modal');
  if (!modal) {
    console.error('‚ùå No hay modal abierto');
    return;
  }
  
  if (projectIndex >= projects.length || projectIndex < 0) {
    alert('Error: Proyecto no v√°lido.');
    return;
  }
  
  const currentProject = projects[projectIndex];
  const currentTasks = currentProject.tasks || [];
  
  console.log(`üìä Proyecto: ${currentProject.name}`);
  console.log(`üìã Tareas totales: ${currentTasks.length}`);
  
  // 1. LIMPIAR TODAS LAS DEPENDENCIAS EXISTENTES
  console.log('üßπ Limpiando dependencias existentes...');
  currentTasks.forEach(task => {
    if (task.dependencies && task.dependencies.length > 0) {
      console.log(`  Limpiando ${task.dependencies.length} dependencias de "${task.name}"`);
      task.dependencies = [];
    }
  });
  
  // 2. OBTENER NUEVAS DEPENDENCIAS DEL MODAL
  const dependenciesList = document.getElementById('dependenciesList');
  const newDependencies = [];
  
  if (dependenciesList) {
    dependenciesList.querySelectorAll('.dependency-item').forEach(item => {
      const fromId = item.dataset.fromId;
      const toId = item.dataset.toId;
      
      if (fromId && toId) {
        newDependencies.push({ fromId, toId });
        console.log(`üìù Nueva dependencia: ${fromId} -> ${toId}`);
      }
    });
  }
  
  console.log(`üì¶ Total de nuevas dependencias: ${newDependencies.length}`);
  
  // 3. APLICAR NUEVAS DEPENDENCIAS
  if (newDependencies.length > 0) {
    newDependencies.forEach(dep => {
      const fromId = dep.fromId.toString();
      const toId = dep.toId.toString();
      
      // Buscar la tara DESTINO (la que depende de la otra)
      const toTask = currentTasks.find(t => t.id && t.id.toString() === toId);
      
      if (toTask) {
        // Inicializar array si no existe
        if (!Array.isArray(toTask.dependencies)) {
          toTask.dependencies = [];
        }
        
        // Evitar duplicados
        if (!toTask.dependencies.includes(fromId)) {
          toTask.dependencies.push(fromId);
          console.log(`‚úÖ A√±adida dependencia a "${toTask.name}": depende de ${fromId}`);
        }
      } else {
        console.warn(`‚ö†Ô∏è No se encontr√≥ tarea destino con ID: ${toId}`);
      }
    });
  }
  
  // 4. MOSTRAR RESULTADO FINAL
  console.log('=== DEPENDENCIAS FINALES ===');
  currentTasks.forEach(task => {
    if (task.dependencies && task.dependencies.length > 0) {
      console.log(`üìå "${task.name}" (ID: ${task.id}) depende de:`, task.dependencies);
    }
  });
  
  // 5. GUARDAR CAMBIOS
  safeSave().then((success) => {
    if (success !== false) {
      console.log('‚úÖ Dependencias guardadas correctamente');
      
      // Cerrar modal
      closeDependencyCreator();
      
      // Actualizar vista Gantt
      setTimeout(() => {
        refreshGanttView();
      }, 300);
      
      showNotification(`‚úÖ ${newDependencies.length} dependencias guardadas`);
      
    } else {
      console.error('‚ùå Error al guardar en safeSave');
      alert('Error al guardar los cambios');
    }
  }).catch(error => {
    console.error('üí• Error cr√≠tico en safeSave:', error);
    alert('Error cr√≠tico: ' + error.message);
  });
};



// ========== FUNCI√ìN PARA LIMPIAR TODAS LAS DEPENDENCIAS ==========
window.clearAllDependencies = function() {
  console.log('üóëÔ∏è Limpiando todas las dependencias...');
  
  if (!confirm('¬øEst√°s seguro de eliminar TODAS las dependencias de este proyecto?\n\nEsta acci√≥n no se puede deshacer.')) {
    console.log('‚ùå Operaci√≥n cancelada por el usuario');
    return;
  }
  
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) {
    alert('‚ùå No hay Gantt activo');
    return;
  }
  
  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  
  if (projectIndex >= projects.length || projectIndex < 0) {
    alert('Error: Proyecto no v√°lido.');
    return;
  }
  
  const currentProject = projects[projectIndex];
  let dependenciasEliminadas = 0;
  
  // Eliminar dependencias de todas las tareas
  currentProject.tasks.forEach(task => {
    if (task.dependencies && task.dependencies.length > 0) {
      dependenciasEliminadas += task.dependencies.length;
      task.dependencies = [];
      console.log(`üóëÔ∏è Limpiadas dependencias de "${task.name}"`);
    }
  });
  
  if (dependenciasEliminadas > 0) {
    // Guardar cambios
    safeSave().then(() => {
      console.log(`‚úÖ ${dependenciasEliminadas} dependencias eliminadas`);
      
      // Actualizar vista Gantt
      if (typeof refreshGanttView === 'function') {
        refreshGanttView();
      } else {
        // Recargar Gantt manualmente
        const ganttContainer = document.getElementById('premiumExecutiveGantt');
        if (ganttContainer) {
          ganttContainer.remove();
          setTimeout(() => createCompleteGanttForCurrentProject(), 300);
        }
      }
      
      showNotification(`‚úÖ ${dependenciasEliminadas} dependencias eliminadas`);
      
    }).catch(error => {
      console.error('‚ùå Error al guardar:', error);
      alert('Error al eliminar dependencias');
    });
  } else {
    alert('‚ö†Ô∏è No hay dependencias para eliminar');
  }
};








// ========== IA PREDICTOR - PANEL COMPLETO (VERSI√ìN CORREGIDA) ==========
window.showAIPredictorPremium = function() {
  console.log('ü§ñ ABRIENDO PANEL DE IA PREDICTOR...');
  
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) {
    alert('‚ùå Por favor, abre el Gantt Ejecutivo primero');
    return;
  }
  
  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  const project = projects[projectIndex];
  const tasks = project?.tasks || [];
  
  console.log('üìã Tareas para an√°lisis:', tasks);
  console.log('üîç Buscando tareas cr√≠ticas...');
  
  // DEBUG: Mostrar todas las tareas y sus propiedades
  tasks.forEach((task, index) => {
    console.log(`Tarea ${index}: ${task.name}`, {
      critical: task.critical,
      priority: task.priority,
      status: task.status,
      storyPoints: task.storyPoints,
      progress: task.progress
    });
  });
  
  if (tasks.length === 0) {
    showNotification('‚ö†Ô∏è No hay tareas para analizar');
    return;
  }
  
  // Crear overlay DENTRO del contenedor del Gantt
  const overlay = document.createElement('div');
  overlay.className = 'executive-overlay';
  overlay.style.cssText = `
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    z-index: 1000000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  `;
  
  // Ejecutar an√°lisis predictivo (VERSI√ìN MEJORADA)
  const analysis = performPredictiveAnalysisEnhanced(tasks);
  
  // Crear modal premium de IA
  const modal = document.createElement('div');
  modal.className = 'executive-modal';
  modal.style.cssText = `
    width: 90vw;
    max-width: 1000px;
    height: 85vh;
    background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
    border-radius: 24px;
    box-shadow: 0 40px 80px rgba(0,0,0,0.8);
    border: 2px solid rgba(52, 152, 219, 0.3);
    overflow: hidden;
    display: flex;
    flex-direction: column;
  `;
  
  modal.innerHTML = `
    <div style="
      padding: 25px 35px;
      background: linear-gradient(90deg, #0a0a1a, #1a1a3a);
      border-bottom: 1px solid rgba(52, 152, 219, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    ">
      <div>
        <h2 style="margin: 0 0 8px 0; color: white; font-size: 28px;">
          <span style="color: #3498db;">ü§ñ</span> IA Predictor - An√°lisis Inteligente
        </h2>
        <p style="margin: 0; color: #95a5a6; font-size: 14px;">
          ${project.name} ‚Ä¢ ${tasks.length} tareas analizadas ‚Ä¢ ${new Date().toLocaleTimeString()}
        </p>
      </div>
      <button onclick="closeAIPredictorModal()" style="
        background: rgba(231, 76, 60, 0.2);
        border: 1px solid #e74c3c;
        color: #e74c3c;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
      ">
        √ó Cerrar
      </button>
    </div>
    
    <div style="flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 30px;">
      
      <!-- Resumen ejecutivo -->
      <div style="
        background: rgba(255,255,255,0.05);
        border-radius: 16px;
        padding: 25px;
        border: 1px solid rgba(52, 152, 219, 0.2);
      ">
        <h3 style="color: white; margin: 0 0 20px 0; font-size: 20px; display: flex; align-items: center; gap: 10px;">
          <span style="color: #3498db;">üìã</span> Resumen Ejecutivo del Proyecto
        </h3>
        
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px;">
          <div style="text-align: center;">
            <div style="color: #3498db; font-size: 32px; font-weight: bold;">${analysis.metrics.totalTasks}</div>
            <div style="color: #95a5a6; font-size: 12px;">TOTAL TAREAS</div>
          </div>
          <div style="text-align: center;">
            <div style="color: #2ecc71; font-size: 32px; font-weight: bold;">${analysis.metrics.completedTasks}</div>
            <div style="color: #95a5a6; font-size: 12px;">COMPLETADAS</div>
          </div>
          <div style="text-align: center;">
            <div style="color: #f39c12; font-size: 32px; font-weight: bold;">${analysis.metrics.criticalTasks}</div>
            <div style="color: #95a5a6; font-size: 12px;">CR√çTICAS</div>
          </div>
          <div style="text-align: center;">
            <div style="color: #9b59b6; font-size: 32px; font-weight: bold;">${analysis.metrics.accuracyScore}%</div>
            <div style="color: #95a5a6; font-size: 12px;">CONFIANZA IA</div>
          </div>
        </div>
        
        <!-- Barra de progreso con riesgo -->
        <div style="margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span style="color: white; font-weight: bold;">Progreso del Proyecto</span>
            <span style="color: ${analysis.metrics.riskColor}; font-weight: bold;">
              ${analysis.metrics.riskLevel}
            </span>
          </div>
          <div style="height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; overflow: hidden;">
            <div style="
              width: ${analysis.metrics.progressRate}%;
              height: 100%;
              background: linear-gradient(90deg, #3498db, #2ecc71);
              border-radius: 5px;
            "></div>
          </div>
          <div style="display: flex; justify-content: space-between; margin-top: 8px;">
            <span style="color: #95a5a6; font-size: 12px;">0%</span>
            <span style="color: #95a5a6; font-size: 12px;">${Math.round(analysis.metrics.progressRate)}%</span>
            <span style="color: #95a5a6; font-size: 12px;">100%</span>
          </div>
        </div>
      </div>
      
      <!-- Predicciones de finalizaci√≥n -->
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
        <!-- Predicci√≥n optimista -->
        <div style="
          background: rgba(46, 204, 113, 0.1);
          border: 2px solid rgba(46, 204, 113, 0.3);
          border-radius: 16px;
          padding: 25px;
          text-align: center;
        ">
          <div style="color: #2ecc71; font-size: 20px; margin-bottom: 15px;">üéØ Optimista</div>
          <div style="color: white; font-size: 24px; font-weight: bold; margin-bottom: 10px;">
            ${analysis.predictedEnd.optimistic}
          </div>
          <div style="color: #95a5a6; font-size: 12px;">
            Si todo va perfecto
          </div>
        </div>
        
        <!-- Predicci√≥n probable -->
        <div style="
          background: rgba(52, 152, 219, 0.1);
          border: 2px solid rgba(52, 152, 219, 0.3);
          border-radius: 16px;
          padding: 25px;
          text-align: center;
        ">
          <div style="color: #3498db; font-size: 20px; margin-bottom: 15px;">üìÖ Probable</div>
          <div style="color: white; font-size: 28px; font-weight: bold; margin-bottom: 10px;">
            ${analysis.predictedEnd.probable}
          </div>
          <div style="color: #95a5a6; font-size: 12px;">
            ${analysis.predictedEnd.weeksRemaining} semanas restantes
          </div>
        </div>
        
        <!-- Predicci√≥n pesimista -->
        <div style="
          background: rgba(231, 76, 60, 0.1);
          border: 2px solid rgba(231, 76, 60, 0.3);
          border-radius: 16px;
          padding: 25px;
          text-align: center;
        ">
          <div style="color: #e74c3c; font-size: 20px; margin-bottom: 15px;">‚ö†Ô∏è Pesimista</div>
          <div style="color: white; font-size: 24px; font-weight: bold; margin-bottom: 10px;">
            ${analysis.predictedEnd.pessimistic}
          </div>
          <div style="color: #95a5a6; font-size: 12px;">
            En caso de contratiempos
          </div>
        </div>
      </div>
      
      <!-- An√°lisis de riesgos y recomendaciones -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
        <!-- Riesgos identificados -->
        <div style="
          background: rgba(231, 76, 60, 0.05);
          border-radius: 16px;
          padding: 25px;
          border: 1px solid rgba(231, 76, 60, 0.2);
        ">
          <h3 style="color: #e74c3c; margin: 0 0 20px 0; font-size: 18px; display: flex; align-items: center; gap: 10px;">
            ‚ö†Ô∏è Riesgos Identificados (${analysis.risks.length})
          </h3>
          
          <div style="display: flex; flex-direction: column; gap: 15px;">
            ${analysis.risks.length > 0 ? 
              analysis.risks.map((risk, index) => `
                <div style="
                  background: rgba(231, 76, 60, 0.1);
                  border-radius: 10px;
                  padding: 15px;
                  display: flex;
                  align-items: flex-start;
                  gap: 12px;
                ">
                  <div style="
                    width: 24px;
                    height: 24px;
                    background: #e74c3c;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 12px;
                    font-weight: bold;
                    flex-shrink: 0;
                  ">
                    ${index + 1}
                  </div>
                  <div style="color: white; font-size: 14px; line-height: 1.5;">${risk}</div>
                </div>
              `).join('') : 
              `<div style="text-align: center; padding: 20px; color: #95a5a6; font-style: italic;">
                ‚úÖ No se identificaron riesgos cr√≠ticos
              </div>`
            }
          </div>
        </div>
        
        <!-- Recomendaciones IA -->
        <div style="
          background: rgba(46, 204, 113, 0.05);
          border-radius: 16px;
          padding: 25px;
          border: 1px solid rgba(46, 204, 113, 0.2);
        ">
          <h3 style="color: #2ecc71; margin: 0 0 20px 0; font-size: 18px; display: flex; align-items: center; gap: 10px;">
            üí° Recomendaciones IA (${analysis.recommendations.length})
          </h3>
          
          <div style="display: flex; flex-direction: column; gap: 15px;">
            ${analysis.recommendations.map((rec, index) => `
              <div style="
                background: rgba(46, 204, 113, 0.1);
                border-radius: 10px;
                padding: 15px;
                display: flex;
                align-items: flex-start;
                gap: 12px;
              ">
                <div style="
                  width: 24px;
                  height: 24px;
                  background: #2ecc71;
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  color: white;
                  font-size: 12px;
                  font-weight: bold;
                  flex-shrink: 0;
                ">
                  ${index + 1}
                </div>
                <div style="color: white; font-size: 14px; line-height: 1.5;">${rec}</div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
      
      <!-- Tareas cr√≠ticas - VERSI√ìN MEJORADA -->
      <div style="
        background: rgba(243, 156, 18, 0.05);
        border-radius: 16px;
        padding: 25px;
        border: 1px solid rgba(243, 156, 18, 0.2);
      ">
        <h3 style="color: #f39c12; margin: 0 0 20px 0; font-size: 18px; display: flex; align-items: center; gap: 10px;">
          üî• Tareas Cr√≠ticas (${analysis.criticalTasksList.length})
        </h3>
        
        <div id="criticalTasksList" style="max-height: 300px; overflow-y: auto;">
          <!-- Se llenar√° din√°micamente -->
        </div>
      </div>
    </div>
    
    <!-- Footer con acciones -->
    <div style="
      background: rgba(255,255,255,0.03);
      border-top: 1px solid rgba(255,255,255,0.1);
      padding: 20px 35px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    ">
      <div style="color: #95a5a6; font-size: 13px;">
        <span>ü§ñ An√°lisis generado autom√°ticamente por IA ‚Ä¢ ${new Date().toLocaleString()}</span>
      </div>
      
      <div style="display: flex; gap: 15px;">
        <button onclick="exportAIAnalysisPDF()" style="
          background: rgba(52, 152, 219, 0.2);
          border: 1px solid #3498db;
          color: #3498db;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
          font-weight: bold;
          font-size: 13px;
          display: flex;
          align-items: center;
          gap: 8px;
        ">
          üì• Exportar PDF
        </button>
        <button onclick="saveAIAnalysis()" style="
          background: linear-gradient(45deg, #2ecc71, #27ae60);
          border: none;
          color: white;
          padding: 10px 25px;
          border-radius: 8px;
          cursor: pointer;
          font-weight: bold;
          font-size: 13px;
          display: flex;
          align-items: center;
          gap: 8px;
        ">
          üíæ Guardar An√°lisis
        </button>
        <button onclick="runDeepAnalysisEnhanced()" style="
          background: linear-gradient(45deg, #9b59b6, #8e44ad);
          border: none;
          color: white;
          padding: 10px 25px;
          border-radius: 8px;
          cursor: pointer;
          font-weight: bold;
          font-size: 13px;
          display: flex;
          align-items: center;
          gap: 8px;
        ">
          üîÑ An√°lisis Profundo
        </button>
      </div>
    </div>
  `;
  
  overlay.appendChild(modal);
  // Agregar al contenedor del Gantt
  ganttContainer.appendChild(overlay);
  
  // Llenar la lista de tareas cr√≠ticas din√°micamente
  setTimeout(() => {
    renderCriticalTasksList(tasks, analysis.criticalTasksList);
  }, 100);
  
  // Funci√≥n para cerrar el modal
  window.closeAIPredictorModal = function() {
    const overlay = document.querySelector('.executive-overlay');
    if (overlay) overlay.remove();
  };
  
  console.log('‚úÖ Panel de IA Predictor abierto exitosamente');
};

// ========== FUNCI√ìN MEJORADA PARA DETECTAR TAREAS CR√çTICAS ==========
function performPredictiveAnalysisEnhanced(tasks) {
  console.log('üîç Ejecutando an√°lisis predictivo IA MEJORADO...');
  
  const totalTasks = tasks.length;
  const completedTasks = tasks.filter(t => t.status === 'completed').length;
  const inProgressTasks = tasks.filter(t => t.status === 'inProgress').length;
  const pendingTasks = tasks.filter(t => t.status === 'pending').length;
  
  // DETECCI√ìN MEJORADA DE TAREAS CR√çTICAS
  const criticalTasksList = tasks.filter(task => {
    // Verificar m√∫ltiples formas de determinar si es cr√≠tica
    if (task.critical === true) return true;
    if (task.priority === 'alta' || task.priority === 'high') return true;
    if (task.status === 'overdue') return true;
    
    // Verificar si tiene dependencias que la hacen cr√≠tica
    if (task.dependencies && task.dependencies.length > 2) return true;
    
    // Verificar por tiempo (si est√° cerca del deadline)
    if (task.deadline) {
      const deadline = new Date(task.deadline);
      const today = new Date();
      const daysDiff = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
      if (daysDiff <= 3 && task.status !== 'completed') return true;
    }
    
    // Verificar por alta prioridad en otros campos
    if (task.importance === 'high' || task.severity === 'high') return true;
    
    return false;
  });
  
  const criticalTasks = criticalTasksList.length;
  
  console.log(`‚úÖ Tareas cr√≠ticas detectadas: ${criticalTasks} de ${totalTasks}`);
  console.log('üìã Lista de tareas cr√≠ticas:', criticalTasksList.map(t => t.name));
  
  // Calcular m√©tricas base
  const completionRate = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
  const progressRate = totalTasks > 0 ? ((completedTasks + (inProgressTasks * 0.5)) / totalTasks) * 100 : 0;
  
  // Predicci√≥n de finalizaci√≥n
  const predictedEnd = calculatePredictedEndDateEnhanced(tasks);
  
  // Identificar riesgos
  const risks = [];
  
  if (criticalTasks > 0 && pendingTasks > 0) {
    risks.push(`Existen ${criticalTasks} tareas cr√≠ticas pendientes que podr√≠an retrasar el proyecto`);
  }
  
  if (completionRate < 30 && inProgressTasks > pendingTasks) {
    risks.push('Baja tasa de finalizaci√≥n - el equipo puede estar sobrecargado');
  }
  
  if (tasks.some(t => t.dependencies && t.dependencies.length > 3)) {
    risks.push('Alta complejidad de dependencias detectada');
  }
  
  // Generar recomendaciones
  const recommendations = [];
  
  if (criticalTasks > 0) {
    recommendations.push(`Priorizar las ${criticalTasks} tareas cr√≠ticas pendientes`);
    recommendations.push(`Asignar recursos adicionales a las tareas cr√≠ticas`);
  }
  
  if (completionRate < 50) {
    recommendations.push('Considerar revisar asignaciones de recursos');
    recommendations.push('Evaluar posibilidad de extender plazos');
  }
  
  if (inProgressTasks > totalTasks * 0.6) {
    recommendations.push('El equipo est√° trabajando en demasiadas tareas simult√°neamente - considerar enfoque');
  }
  
  if (recommendations.length === 0) {
    recommendations.push('El proyecto sigue un buen ritmo - mantener el enfoque actual');
  }
  
  // Calcular puntuaci√≥n de confianza
  const dataQuality = calculateDataQualityScoreEnhanced(tasks);
  const velocityStability = calculateVelocityStabilityEnhanced(tasks);
  const accuracyScore = Math.min(95, Math.round((dataQuality * 0.4 + velocityStability * 0.6) * 100));
  
  // Determinar nivel de riesgo
  let riskLevel = 'BAJO';
  let riskColor = '#2ecc71';
  
  if (completionRate < 40 || criticalTasks > totalTasks * 0.3) {
    riskLevel = 'ALTO';
    riskColor = '#e74c3c';
  } else if (completionRate < 60 || criticalTasks > 0) {
    riskLevel = 'MEDIO';
    riskColor = '#f39c12';
  }
  
  return {
    predictedEnd: {
      probable: predictedEnd.probableDate,
      optimistic: predictedEnd.optimisticDate,
      pessimistic: predictedEnd.pessimisticDate,
      weeksRemaining: predictedEnd.weeksRemaining
    },
    risks,
    recommendations,
    criticalTasksList: criticalTasksList,
    metrics: {
      totalTasks,
      completedTasks,
      inProgressTasks,
      pendingTasks,
      criticalTasks,
      completionRate: Math.round(completionRate),
      progressRate: Math.round(progressRate),
      accuracyScore,
      riskLevel,
      riskColor
    },
    timestamp: new Date().toISOString()
  };
}

// ========== FUNCI√ìN PARA RENDERIZAR TAREAS CR√çTICAS ==========
function renderCriticalTasksList(allTasks, criticalTasks) {
  const container = document.getElementById('criticalTasksList');
  if (!container) return;
  
  console.log('üé® Renderizando tareas cr√≠ticas:', criticalTasks.length);
  
  if (criticalTasks.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #95a5a6; font-style: italic;">
        <div style="font-size: 48px; margin-bottom: 20px;">‚úÖ</div>
        <h4 style="color: #2ecc71; margin: 0 0 10px 0;">No hay tareas cr√≠ticas</h4>
        <p>Todas las tareas est√°n bajo control o no se han marcado como cr√≠ticas.</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = criticalTasks.map((task, index) => `
    <div style="
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: rgba(243, 156, 18, 0.1);
      border-radius: 10px;
      margin-bottom: 12px;
      border-left: 4px solid #f39c12;
      transition: all 0.3s;
    " onmouseover="this.style.background='rgba(243, 156, 18, 0.15)'; this.style.transform='translateX(5px)'"
       onmouseout="this.style.background='rgba(243, 156, 18, 0.1)'; this.style.transform='translateX(0)'">
      
      <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
        <div style="
          width: 32px;
          height: 32px;
          background: #f39c12;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: bold;
          font-size: 14px;
          flex-shrink: 0;
        ">
          ${index + 1}
        </div>
        
        <div style="flex: 1;">
          <div style="color: white; font-weight: 600; margin-bottom: 5px; font-size: 15px;">
            ${task.name || 'Tarea sin nombre'}
          </div>
          
          <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <span style="color: #95a5a6; font-size: 12px; display: flex; align-items: center; gap: 4px;">
              üë§ ${task.assignee || 'Sin asignar'}
            </span>
            <span style="color: #95a5a6; font-size: 12px; display: flex; align-items: center; gap: 4px;">
              üìä ${task.progress || 0}%
            </span>
            <span style="color: #95a5a6; font-size: 12px; display: flex; align-items: center; gap: 4px;">
              ‚è±Ô∏è ${task.estimatedTime || 0}h
            </span>
            <span style="color: #95a5a6; font-size: 12px; display: flex; align-items: center; gap: 4px;">
              üìÖ ${task.deadline ? new Date(task.deadline).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }) : 'Sin fecha'}
            </span>
          </div>
          
          <!-- Raz√≥n por la que es cr√≠tica -->
          <div style="margin-top: 8px;">
            ${getCriticalReason(task)}
          </div>
        </div>
      </div>
      
      <div style="display: flex; gap: 8px; flex-shrink: 0;">
        <button onclick="focusCriticalTask('${task.id}')" style="
          background: rgba(243, 156, 18, 0.2);
          border: 1px solid #f39c12;
          color: #f39c12;
          padding: 8px 15px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 12px;
          font-weight: bold;
          transition: all 0.3s;
          display: flex;
          align-items: center;
          gap: 5px;
        " onmouseover="this.style.background='rgba(243, 156, 18, 0.3)'"
           onmouseout="this.style.background='rgba(243, 156, 18, 0.2)'">
          üîç Enfocar
        </button>
        
        <button onclick="markTaskAsCompleted('${task.id}')" style="
          background: rgba(46, 204, 113, 0.2);
          border: 1px solid #2ecc71;
          color: #2ecc71;
          padding: 8px 15px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 12px;
          font-weight: bold;
          transition: all 0.3s;
          display: flex;
          align-items: center;
          gap: 5px;
        " onmouseover="this.style.background='rgba(46, 204, 113, 0.3)'"
           onmouseout="this.style.background='rgba(46, 204, 113, 0.2)'">
          ‚úÖ Completar
        </button>
      </div>
    </div>
  `).join('');
}

// ========== FUNCI√ìN PARA OBTENER LA RAZ√ìN DE CR√çTICA ==========
function getCriticalReason(task) {
  const reasons = [];
  
  if (task.critical === true) reasons.push('Marcada como cr√≠tica expl√≠citamente');
  if (task.priority === 'alta' || task.priority === 'high') reasons.push('Prioridad alta');
  if (task.status === 'overdue') reasons.push('Tarea vencida');
  if (task.dependencies && task.dependencies.length > 2) reasons.push('M√∫ltiples dependencias');
  
  if (task.deadline) {
    const deadline = new Date(task.deadline);
    const today = new Date();
    const daysDiff = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
    if (daysDiff <= 3 && task.status !== 'completed') {
      reasons.push(`Vence en ${daysDiff} d√≠a${daysDiff !== 1 ? 's' : ''}`);
    }
  }
  
  if (reasons.length === 0) reasons.push('Importancia estrat√©gica');
  
  return `
    <div style="
      display: inline-block;
      background: rgba(243, 156, 18, 0.2);
      color: #f39c12;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      margin-top: 5px;
    ">
      üö® ${reasons[0]}
    </div>
  `;
}

// ========== FUNCIONES AUXILIARES MEJORADAS ==========
function calculatePredictedEndDateEnhanced(tasks) {
  const totalSP = tasks.reduce((sum, t) => sum + (Number(t.storyPoints) || 1), 0);
  const burnedSP = tasks.reduce((sum, t) => {
    if (t.status === 'completed') return sum + (Number(t.storyPoints) || 1);
    if (t.status === 'inProgress') return sum + ((Number(t.storyPoints) || 1) * 0.5);
    return sum;
  }, 0);
  
  const remainingSP = totalSP - burnedSP;
  const weeksElapsed = Math.max(1, 4); // Usar semanas reales si est√°n disponibles
  
  if (remainingSP <= 0) {
    return {
      probableDate: 'PROYECTO COMPLETADO üéâ',
      optimisticDate: 'PROYECTO COMPLETADO üéâ',
      pessimisticDate: 'PROYECTO COMPLETADO üéâ',
      weeksRemaining: 0
    };
  }
  
  const velocity = burnedSP / weeksElapsed;
  
  if (velocity <= 0) {
    const today = new Date();
    const defaultEnd = new Date(today);
    defaultEnd.setDate(today.getDate() + 30);
    
    return {
      probableDate: defaultEnd.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' }),
      optimisticDate: defaultEnd.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' }),
      pessimisticDate: defaultEnd.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' }),
      weeksRemaining: 4
    };
  }
  
  const weeksRemaining = Math.ceil(remainingSP / velocity);
  const today = new Date();
  
  // Fecha probable
  const probableDate = new Date(today);
  probableDate.setDate(today.getDate() + (weeksRemaining * 7));
  
  // Fecha optimista (+25% m√°s r√°pido)
  const optimisticWeeks = Math.ceil(remainingSP / (velocity * 1.25));
  const optimisticDate = new Date(today);
  optimisticDate.setDate(today.getDate() + (optimisticWeeks * 7));
  
  // Fecha pesimista (-25% m√°s lento)
  const pessimisticWeeks = Math.ceil(remainingSP / (velocity * 0.75));
  const pessimisticDate = new Date(today);
  pessimisticDate.setDate(today.getDate() + (pessimisticWeeks * 7));
  
  return {
    probableDate: probableDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' }),
    optimisticDate: optimisticDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' }),
    pessimisticDate: pessimisticDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' }),
    weeksRemaining
  };
}

function calculateDataQualityScoreEnhanced(tasks) {
  if (tasks.length === 0) return 0.5;
  
  let score = 0;
  
  const tasksWithSP = tasks.filter(t => Number(t.storyPoints) > 0).length;
  score += (tasksWithSP / tasks.length) * 0.3;
  
  const tasksWithAssignee = tasks.filter(t => t.assignee && t.assignee !== 'Sin asignar').length;
  score += (tasksWithAssignee / tasks.length) * 0.2;
  
  const tasksWithHistory = tasks.filter(t => t.history && t.history.length > 0).length;
  score += (tasksWithHistory / tasks.length) * 0.3;
  
  const tasksWithDates = tasks.filter(t => t.startDate && t.deadline).length;
  score += (tasksWithDates / tasks.length) * 0.2;
  
  return Math.min(1, score);
}

function calculateVelocityStabilityEnhanced(tasks) {
  const completedTasks = tasks.filter(t => t.status === 'completed').length;
  const totalTasks = tasks.length;
  
  if (totalTasks === 0) return 0.5;
  
  const completionRate = completedTasks / totalTasks;
  
  // Considerar tambi√©n la consistencia en las fechas de completado
  const completedDates = tasks
    .filter(t => t.status === 'completed' && t.history)
    .map(t => {
      const completion = t.history.find(h => h.to === 'completed');
      return completion ? new Date(completion.date) : null;
    })
    .filter(d => d !== null);
  
  let dateConsistency = 0.5;
  if (completedDates.length > 1) {
    const dateDifferences = [];
    for (let i = 1; i < completedDates.length; i++) {
      const diff = Math.abs(completedDates[i] - completedDates[i-1]);
      dateDifferences.push(diff);
    }
    
    const avgDiff = dateDifferences.reduce((a, b) => a + b, 0) / dateDifferences.length;
    const consistency = avgDiff < (7 * 24 * 60 * 60 * 1000) ? 0.8 : 0.6;
    dateConsistency = consistency;
  }
  
  if (completionRate >= 0.3 && completionRate <= 0.7) {
    return (0.8 + dateConsistency) / 2;
  } else if (completionRate > 0.7) {
    return (0.9 + dateConsistency) / 2;
  } else {
    return (0.6 + dateConsistency) / 2;
  }
}

// ========== FUNCIONES PARA LOS BOTONES (MEJORADAS) ==========
window.exportAIAnalysisPDF = function() {
  console.log('üì§ Generando PDF del an√°lisis IA...');
  
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;
  
  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  const project = projects[projectIndex];
  const tasks = project?.tasks || [];
  
  const analysis = performPredictiveAnalysisEnhanced(tasks);
  
  // Crear contenido HTML para el PDF
  const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>An√°lisis IA - ${project.name}</title>
      <style>
        body {
          font-family: Arial, sans-serif;
          padding: 40px;
          color: #333;
          line-height: 1.6;
        }
        .header {
          text-align: center;
          margin-bottom: 40px;
          border-bottom: 3px solid #3498db;
          padding-bottom: 20px;
        }
        .header h1 {
          color: #2c3e50;
          margin-bottom: 10px;
        }
        .metrics {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 20px;
          margin-bottom: 30px;
        }
        .metric-card {
          background: #f8f9fa;
          border: 1px solid #dee2e6;
          border-radius: 10px;
          padding: 20px;
          text-align: center;
        }
        .metric-value {
          font-size: 28px;
          font-weight: bold;
          color: #3498db;
          margin: 10px 0;
        }
        .metric-label {
          color: #6c757d;
          font-size: 14px;
        }
        .section {
          margin-bottom: 30px;
          page-break-inside: avoid;
        }
        .section-title {
          color: #2c3e50;
          border-left: 4px solid #3498db;
          padding-left: 15px;
          margin-bottom: 20px;
        }
        .prediction-cards {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 20px;
          margin-bottom: 30px;
        }
        .prediction-card {
          border-radius: 10px;
          padding: 20px;
          text-align: center;
          color: white;
        }
        .optimistic { background: #2ecc71; }
        .probable { background: #3498db; }
        .pessimistic { background: #e74c3c; }
        .risk-item, .recommendation-item {
          background: #f8f9fa;
          border-left: 4px solid #e74c3c;
          padding: 15px;
          margin-bottom: 10px;
          border-radius: 5px;
        }
        .recommendation-item {
          border-left-color: #2ecc71;
        }
        .critical-task {
          background: #fff3cd;
          border: 1px solid #ffeaa7;
          border-radius: 8px;
          padding: 15px;
          margin-bottom: 10px;
        }
        .footer {
          text-align: center;
          margin-top: 40px;
          color: #6c757d;
          font-size: 12px;
          border-top: 1px solid #dee2e6;
          padding-top: 20px;
        }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>ü§ñ An√°lisis IA Predictor</h1>
        <h2>${project.name}</h2>
        <p>Generado: ${new Date().toLocaleString()}</p>
      </div>
      
      <div class="metrics">
        <div class="metric-card">
          <div class="metric-value">${analysis.metrics.totalTasks}</div>
          <div class="metric-label">Total Tareas</div>
        </div>
        <div class="metric-card">
          <div class="metric-value">${analysis.metrics.completedTasks}</div>
          <div class="metric-label">Completadas</div>
        </div>
        <div class="metric-card">
          <div class="metric-value">${analysis.metrics.criticalTasks}</div>
          <div class="metric-label">Cr√≠ticas</div>
        </div>
        <div class="metric-card">
          <div class="metric-value">${analysis.metrics.accuracyScore}%</div>
          <div class="metric-label">Confianza IA</div>
        </div>
      </div>
      
      <div class="section">
        <h3 class="section-title">üìÖ Predicciones de Finalizaci√≥n</h3>
        <div class="prediction-cards">
          <div class="prediction-card optimistic">
            <h4>Optimista</h4>
            <div style="font-size: 24px; margin: 15px 0;">${analysis.predictedEnd.optimistic}</div>
            <small>Si todo va perfecto</small>
          </div>
          <div class="prediction-card probable">
            <h4>Probable</h4>
            <div style="font-size: 28px; margin: 15px 0;">${analysis.predictedEnd.probable}</div>
            <small>${analysis.predictedEnd.weeksRemaining} semanas restantes</small>
          </div>
          <div class="prediction-card pessimistic">
            <h4>Pesimista</h4>
            <div style="font-size: 24px; margin: 15px 0;">${analysis.predictedEnd.pessimistic}</div>
            <small>En caso de contratiempos</small>
          </div>
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
        <div class="section">
          <h3 class="section-title">‚ö†Ô∏è Riesgos Identificados</h3>
          ${analysis.risks.length > 0 ? 
            analysis.risks.map(risk => `
              <div class="risk-item">
                <strong>üö®</strong> ${risk}
              </div>
            `).join('') : 
            '<p>‚úÖ No se identificaron riesgos cr√≠ticos</p>'
          }
        </div>
        
        <div class="section">
          <h3 class="section-title">üí° Recomendaciones IA</h3>
          ${analysis.recommendations.map(rec => `
            <div class="recommendation-item">
              <strong>‚úÖ</strong> ${rec}
            </div>
          `).join('')}
        </div>
      </div>
      
      <div class="section">
        <h3 class="section-title">üî• Tareas Cr√≠ticas (${analysis.criticalTasksList.length})</h3>
        ${analysis.criticalTasksList.length > 0 ? 
          analysis.criticalTasksList.map((task, index) => `
            <div class="critical-task">
              <h4>${index + 1}. ${task.name}</h4>
              <p><strong>Responsable:</strong> ${task.assignee || 'Sin asignar'}</p>
              <p><strong>Progreso:</strong> ${task.progress || 0}%</p>
              <p><strong>Tiempo estimado:</strong> ${task.estimatedTime || 0} horas</p>
            </div>
          `).join('') : 
          '<p>‚úÖ No hay tareas marcadas como cr√≠ticas</p>'
        }
      </div>
      
      <div class="footer">
        <p>An√°lisis generado autom√°ticamente por el sistema IA Predictor</p>
        <p>Confianza del an√°lisis: ${analysis.metrics.accuracyScore}% ‚Ä¢ Nivel de riesgo: ${analysis.metrics.riskLevel}</p>
      </div>
    </body>
    </html>
  `;
  
  // Abrir en nueva ventana para imprimir/guardar como PDF
  const win = window.open('', '_blank');
  win.document.write(htmlContent);
  win.document.close();
  
  // Dar tiempo a cargar y luego mostrar opci√≥n de impresi√≥n
  setTimeout(() => {
    win.print();
    showNotification('üì§ PDF listo para imprimir/guardar');
  }, 500);
};

window.runDeepAnalysisEnhanced = function() {
  console.log('üîç INICIANDO AN√ÅLISIS PROFUNDO MEJORADO...');
  
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;
  
  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  const project = projects[projectIndex];
  const tasks = project?.tasks || [];
  
  if (tasks.length === 0) {
    showNotification('‚ö†Ô∏è No hay tareas para analizar');
    return;
  }
  
  // Mostrar indicador de carga
  const loadingMessage = document.createElement('div');
  loadingMessage.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 20px 30px;
    border-radius: 12px;
    z-index: 1000001;
    display: flex;
    align-items: center;
    gap: 15px;
    font-weight: bold;
  `;
  loadingMessage.innerHTML = `
    <div style="font-size: 24px;">ü§ñ</div>
    <div>
      <div>Ejecutando an√°lisis profundo...</div>
      <div style="font-size: 12px; color: #95a5a6; margin-top: 5px;">Analizando ${tasks.length} tareas</div>
    </div>
  `;
  document.body.appendChild(loadingMessage);
  
  // Simular an√°lisis profundo con resultados reales
  setTimeout(() => {
    // Realizar an√°lisis profundo
    const deepAnalysis = performDeepAnalysis(tasks);
    
    // Remover mensaje de carga
    loadingMessage.remove();
    
    // Mostrar resultados en un modal
    showDeepAnalysisResults(deepAnalysis, project.name);
    
    showNotification('‚úÖ An√°lisis profundo completado');
    
  }, 2500); // 2.5 segundos de simulaci√≥n
};

// ========== AN√ÅLISIS PROFUNDO REAL ==========
function performDeepAnalysis(tasks) {
  console.log('üß† Realizando an√°lisis profundo...');
  
  // An√°lisis de dependencias
  const dependencyAnalysis = analyzeDependencies(tasks);
  
  // An√°lisis de recursos
  const resourceAnalysis = analyzeResources(tasks);
  
  // An√°lisis de tiempo
  const timeAnalysis = analyzeTime(tasks);
  
  // Detecci√≥n de patrones
  const patterns = detectPatterns(tasks);
  
  // An√°lisis de riesgo avanzado
  const riskAnalysis = analyzeAdvancedRisks(tasks);
  
  return {
    dependencyAnalysis,
    resourceAnalysis,
    timeAnalysis,
    patterns,
    riskAnalysis,
    summary: generateDeepAnalysisSummary(tasks, {
      dependencyAnalysis,
      resourceAnalysis,
      timeAnalysis,
      patterns,
      riskAnalysis
    })
  };
}

function analyzeDependencies(tasks) {
  const totalDependencies = tasks.reduce((sum, task) => sum + (task.dependencies?.length || 0), 0);
  const tasksWithDeps = tasks.filter(t => t.dependencies && t.dependencies.length > 0).length;
  const avgDependenciesPerTask = tasksWithDeps > 0 ? totalDependencies / tasksWithDeps : 0;
  
  // Encontrar el nodo m√°s cr√≠tico (m√°s dependencias)
  let maxDependencies = 0;
  let criticalNode = null;
  
  tasks.forEach(task => {
    const deps = task.dependencies?.length || 0;
    if (deps > maxDependencies) {
      maxDependencies = deps;
      criticalNode = task;
    }
  });
  
  return {
    totalDependencies,
    tasksWithDependencies: tasksWithDeps,
    avgDependenciesPerTask: avgDependenciesPerTask.toFixed(2),
    maxDependencies,
    criticalNode: criticalNode ? {
      name: criticalNode.name,
      dependencies: criticalNode.dependencies?.length || 0
    } : null,
    dependencyDensity: (totalDependencies / tasks.length).toFixed(2)
  };
}

function analyzeResources(tasks) {
  const resources = {};
  let totalEstimatedTime = 0;
  let totalLoggedTime = 0;
  
  tasks.forEach(task => {
    // Contar recursos
    if (task.assignee && task.assignee !== 'Sin asignar') {
      resources[task.assignee] = (resources[task.assignee] || 0) + 1;
    }
    
    // Sumar tiempos
    totalEstimatedTime += task.estimatedTime || 0;
    totalLoggedTime += task.timeLogged || 0;
  });
  
  const resourceCount = Object.keys(resources).length;
  const avgTasksPerResource = resourceCount > 0 ? tasks.length / resourceCount : 0;
  
  // Encontrar recursos sobrecargados
  const overloadedResources = Object.entries(resources)
    .filter(([_, count]) => count > avgTasksPerResource * 1.5)
    .map(([name, count]) => ({ name, count }));
  
  return {
    totalResources: resourceCount,
    resourceDistribution: resources,
    avgTasksPerResource: avgTasksPerResource.toFixed(1),
    overloadedResources,
    totalEstimatedTime,
    totalLoggedTime,
    timeEfficiency: totalEstimatedTime > 0 ? 
      (totalLoggedTime / totalEstimatedTime * 100).toFixed(1) + '%' : '0%'
  };
}

function analyzeTime(tasks) {
  const today = new Date();
  const overdueTasks = tasks.filter(task => {
    if (!task.deadline || task.status === 'completed') return false;
    const deadline = new Date(task.deadline);
    return deadline < today;
  });
  
  const upcomingDeadlines = tasks.filter(task => {
    if (!task.deadline || task.status === 'completed') return false;
    const deadline = new Date(task.deadline);
    const daysDiff = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
    return daysDiff <= 7 && daysDiff > 0;
  });
  
  // Calcular tiempo promedio de completado
  const completedTasks = tasks.filter(t => t.status === 'completed');
  let totalCompletionTime = 0;
  let completedWithTime = 0;
  
  completedTasks.forEach(task => {
    if (task.startDate && task.deadline && task.history) {
      const start = new Date(task.startDate);
      const completionEvent = task.history.find(h => h.to === 'completed');
      if (completionEvent) {
        const completion = new Date(completionEvent.date);
        const days = Math.ceil((completion - start) / (1000 * 60 * 60 * 24));
        totalCompletionTime += days;
        completedWithTime++;
      }
    }
  });
  
  const avgCompletionTime = completedWithTime > 0 ? 
    (totalCompletionTime / completedWithTime).toFixed(1) : 0;
  
  return {
    overdueTasks: overdueTasks.length,
    upcomingDeadlines: upcomingDeadlines.length,
    avgCompletionTime: avgCompletionTime + ' d√≠as',
    timePressureScore: calculateTimePressureScore(tasks)
  };
}

function detectPatterns(tasks) {
  const patterns = [];
  
  // Patr√≥n: Muchas tareas en progreso simult√°neo
  const inProgressCount = tasks.filter(t => t.status === 'inProgress').length;
  if (inProgressCount > tasks.length * 0.6) {
    patterns.push({
      type: 'MULTITASKING_EXCESS',
      description: 'El equipo est√° trabajando en demasiadas tareas simult√°neamente',
      severity: 'MEDIA',
      recommendation: 'Considerar limitar el trabajo en progreso (WIP)'
    });
  }
  
  // Patr√≥n: Tareas bloqueadas por dependencias
  const blockedTasks = tasks.filter(t => 
    t.status === 'pending' && 
    t.dependencies && 
    t.dependencies.length > 0
  );
  
  if (blockedTasks.length > tasks.length * 0.3) {
    patterns.push({
      type: 'DEPENDENCY_BLOCK',
      description: 'Alto porcentaje de tareas bloqueadas por dependencias',
      severity: 'ALTA',
      recommendation: 'Revisar y simplificar la estructura de dependencias'
    });
  }
  
  // Patr√≥n: Estimaciones inconsistentes
  const tasksWithEstimation = tasks.filter(t => t.estimatedTime && t.estimatedTime > 0);
  if (tasksWithEstimation.length > 5) {
    const times = tasksWithEstimation.map(t => t.estimatedTime);
    const avg = times.reduce((a, b) => a + b) / times.length;
    const variance = times.reduce((sum, time) => sum + Math.pow(time - avg, 2), 0) / times.length;
    
    if (variance > avg * 2) {
      patterns.push({
        type: 'INCONSISTENT_ESTIMATIONS',
        description: 'Grandes variaciones en las estimaciones de tiempo',
        severity: 'MEDIA',
        recommendation: 'Estandarizar el proceso de estimaci√≥n'
      });
    }
  }
  
  return patterns;
}

function analyzeAdvancedRisks(tasks) {
  const risks = [];
  
  // Riesgo: Falta de balance en asignaciones
  const resourceAnalysis = analyzeResources(tasks);
  if (resourceAnalysis.overloadedResources.length > 0) {
    risks.push({
      type: 'RESOURCE_OVERLOAD',
      description: `${resourceAnalysis.overloadedResources.length} recursos est√°n sobrecargados`,
      affectedResources: resourceAnalysis.overloadedResources.map(r => r.name),
      severity: 'ALTA'
    });
  }
  
  // Riesgo: Cuello de botella en dependencias
  const depAnalysis = analyzeDependencies(tasks);
  if (depAnalysis.criticalNode && depAnalysis.maxDependencies > 3) {
    risks.push({
      type: 'DEPENDENCY_BOTTLENECK',
      description: `La tarea "${depAnalysis.criticalNode.name}" es un cuello de botella con ${depAnalysis.maxDependencies} dependencias`,
      severity: 'ALTA'
    });
  }
  
  // Riesgo: Tiempo insuficiente
  const timeAnalysis = analyzeTime(tasks);
  if (timeAnalysis.overdueTasks > 0) {
    risks.push({
      type: 'SCHEDULE_OVERDUE',
      description: `${timeAnalysis.overdueTasks} tareas vencidas`,
      severity: 'ALTA'
    });
  }
  
  return risks;
}

function calculateTimePressureScore(tasks) {
  const today = new Date();
  let pressureScore = 0;
  let weightedTasks = 0;
  
  tasks.forEach(task => {
    if (task.deadline && task.status !== 'completed') {
      const deadline = new Date(task.deadline);
      const daysLeft = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
      
      let taskPressure = 0;
      if (daysLeft <= 0) {
        taskPressure = 1.0; // Vencida
      } else if (daysLeft <= 3) {
        taskPressure = 0.8; // Muy pr√≥xima
      } else if (daysLeft <= 7) {
        taskPressure = 0.5; // Pr√≥xima
      } else if (daysLeft <= 14) {
        taskPressure = 0.2; // En horizonte cercano
      }
      
      // Ponderar por importancia
      const importance = task.critical ? 1.5 : (task.priority === 'alta' ? 1.2 : 1.0);
      
      pressureScore += taskPressure * importance;
      weightedTasks += importance;
    }
  });
  
  const finalScore = weightedTasks > 0 ? (pressureScore / weightedTasks) * 100 : 0;
  return Math.min(100, Math.round(finalScore));
}

function generateDeepAnalysisSummary(tasks, analyses) {
  const totalScore = 100;
  let deduction = 0;
  const issues = [];
  
  // Penalizar por recursos sobrecargados
  if (analyses.resourceAnalysis.overloadedResources.length > 0) {
    deduction += 15;
    issues.push(`${analyses.resourceAnalysis.overloadedResources.length} recursos sobrecargados`);
  }
  
  // Penalizar por dependencias complejas
  if (analyses.dependencyAnalysis.dependencyDensity > 1.5) {
    deduction += 10;
    issues.push('Estructura de dependencias muy compleja');
  }
  
  // Penalizar por tareas vencidas
  if (analyses.timeAnalysis.overdueTasks > 0) {
    deduction += 20;
    issues.push(`${analyses.timeAnalysis.overdueTasks} tareas vencidas`);
  }
  
  // Penalizar por patrones problem√°ticos
  const criticalPatterns = analyses.patterns.filter(p => p.severity === 'ALTA');
  if (criticalPatterns.length > 0) {
    deduction += criticalPatterns.length * 5;
    issues.push(`${criticalPatterns.length} patrones problem√°ticos detectados`);
  }
  
  const finalScore = Math.max(0, totalScore - deduction);
  
  let healthStatus = 'EXCELENTE';
  let healthColor = '#2ecc71';
  
  if (finalScore < 60) {
    healthStatus = 'CR√çTICO';
    healthColor = '#e74c3c';
  } else if (finalScore < 80) {
    healthStatus = 'RIESGO';
    healthColor = '#f39c12';
  } else if (finalScore < 90) {
    healthStatus = 'ACEPTABLE';
    healthColor = '#3498db';
  }
  
  return {
    score: finalScore,
    healthStatus,
    healthColor,
    issues,
    recommendations: generateDeepRecommendations(analyses)
  };
}

function generateDeepRecommendations(analyses) {
  const recommendations = [];
  
  if (analyses.resourceAnalysis.overloadedResources.length > 0) {
    recommendations.push('Redistribuir carga de trabajo entre recursos');
  }
  
  if (analyses.dependencyAnalysis.maxDependencies > 3) {
    recommendations.push('Simplificar dependencias cr√≠ticas');
  }
  
  if (analyses.timeAnalysis.overdueTasks > 0) {
    recommendations.push('Revisar y actualizar fechas de vencimiento');
  }
  
  if (analyses.patterns.some(p => p.type === 'MULTITASKING_EXCESS')) {
    recommendations.push('Implementar l√≠mites de trabajo en progreso');
  }
  
  if (recommendations.length === 0) {
    recommendations.push('Mantener las pr√°cticas actuales - buen trabajo');
  }
  
  return recommendations;
}

// ========== MOSTRAR RESULTADOS DEL AN√ÅLISIS PROFUNDO ==========
function showDeepAnalysisResults(analysis, projectName) {
  const overlay = document.createElement('div');
  overlay.className = 'executive-overlay';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(10px);
    z-index: 1000000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  `;
  
  const modal = document.createElement('div');
  modal.className = 'executive-modal';
  modal.style.cssText = `
    width: 800px;
    max-width: 90vw;
    max-height: 90vh;
    background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
    border-radius: 24px;
    padding: 30px;
    border: 2px solid rgba(52, 152, 219, 0.3);
    box-shadow: 0 40px 80px rgba(0,0,0,0.8);
    overflow-y: auto;
  `;
  
  modal.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
      <div>
        <h2 style="color: white; margin: 0 0 10px 0; display: flex; align-items: center; gap: 10px;">
          <span style="color: #9b59b6;">üß†</span> An√°lisis Profundo Completo
        </h2>
        <p style="color: #95a5a6; margin: 0; font-size: 14px;">
          ${projectName} ‚Ä¢ ${new Date().toLocaleString()}
        </p>
      </div>
      <button onclick="this.closest('.executive-overlay').remove()" style="
        background: rgba(231, 76, 60, 0.2);
        border: 1px solid #e74c3c;
        color: #e74c3c;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
      ">
        ‚úï Cerrar
      </button>
    </div>
    
    <!-- Puntuaci√≥n de salud -->
    <div style="
      background: ${analysis.summary.healthColor}20;
      border: 2px solid ${analysis.summary.healthColor};
      border-radius: 16px;
      padding: 25px;
      text-align: center;
      margin-bottom: 30px;
    ">
      <div style="color: ${analysis.summary.healthColor}; font-size: 14px; margin-bottom: 10px;">
        SALUD DEL PROYECTO
      </div>
      <div style="color: white; font-size: 48px; font-weight: bold; margin-bottom: 10px;">
        ${analysis.summary.score}/100
      </div>
      <div style="color: ${analysis.summary.healthColor}; font-size: 20px; font-weight: bold;">
        ${analysis.summary.healthStatus}
      </div>
    </div>
    
    <!-- Hallazgos clave -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px;">
      <!-- An√°lisis de dependencias -->
      <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px;">
        <h3 style="color: #9b59b6; margin: 0 0 15px 0; font-size: 16px;">üîó Dependencias</h3>
        <div style="color: white; font-size: 28px; font-weight: bold; margin-bottom: 5px;">
          ${analysis.dependencyAnalysis.totalDependencies}
        </div>
        <div style="color: #95a5a6; font-size: 12px;">Total de dependencias</div>
        <div style="margin-top: 15px; color: #95a5a6; font-size: 13px;">
          <div>‚Ä¢ ${analysis.dependencyAnalysis.tasksWithDependencies} tareas con dependencias</div>
          <div>‚Ä¢ Densidad: ${analysis.dependencyAnalysis.dependencyDensity}</div>
          ${analysis.dependencyAnalysis.criticalNode ? 
            `<div>‚Ä¢ Nodo cr√≠tico: ${analysis.dependencyAnalysis.criticalNode.name} (${analysis.dependencyAnalysis.criticalNode.dependencies} deps)</div>` : ''
          }
        </div>
      </div>
      
      <!-- An√°lisis de recursos -->
      <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px;">
        <h3 style="color: #3498db; margin: 0 0 15px 0; font-size: 16px;">üë• Recursos</h3>
        <div style="color: white; font-size: 28px; font-weight: bold; margin-bottom: 5px;">
          ${analysis.resourceAnalysis.totalResources}
        </div>
        <div style="color: #95a5a6; font-size: 12px;">Recursos asignados</div>
        <div style="margin-top: 15px; color: #95a5a6; font-size: 13px;">
          <div>‚Ä¢ ${analysis.resourceAnalysis.overloadedResources.length} recursos sobrecargados</div>
          <div>‚Ä¢ Eficiencia de tiempo: ${analysis.resourceAnalysis.timeEfficiency}</div>
          <div>‚Ä¢ ${analysis.resourceAnalysis.avgTasksPerResource} tareas/recurso en promedio</div>
        </div>
      </div>
    </div>
    
    <!-- Problemas identificados -->
    <div style="background: rgba(231, 76, 60, 0.1); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
      <h3 style="color: #e74c3c; margin: 0 0 15px 0; font-size: 16px;">‚ö†Ô∏è Problemas Identificados</h3>
      <div style="color: #95a5a6; font-size: 14px;">
        ${analysis.summary.issues.length > 0 ? 
          `<ul style="margin: 0; padding-left: 20px;">
            ${analysis.summary.issues.map(issue => `<li style="margin-bottom: 8px;">${issue}</li>`).join('')}
          </ul>` : 
          '<p style="text-align: center; font-style: italic;">‚úÖ No se identificaron problemas cr√≠ticos</p>'
        }
      </div>
    </div>
    
    <!-- Recomendaciones espec√≠ficas -->
    <div style="background: rgba(46, 204, 113, 0.1); border-radius: 12px; padding: 20px;">
      <h3 style="color: #2ecc71; margin: 0 0 15px 0; font-size: 16px;">üí° Recomendaciones Espec√≠ficas</h3>
      <div style="color: #95a5a6; font-size: 14px;">
        <ul style="margin: 0; padding-left: 20px;">
          ${analysis.summary.recommendations.map(rec => `<li style="margin-bottom: 8px;">${rec}</li>`).join('')}
        </ul>
      </div>
    </div>
    
    <div style="margin-top: 30px; text-align: center;">
      <button onclick="saveDeepAnalysis()" style="
        background: linear-gradient(45deg, #9b59b6, #8e44ad);
        border: none;
        color: white;
        padding: 12px 30px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
      ">
        üíæ Guardar An√°lisis Profundo
      </button>
    </div>
  `;
  
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  
  // Funci√≥n para guardar el an√°lisis profundo
  window.saveDeepAnalysis = function() {
    const analysisData = {
      type: 'deep_analysis',
      projectName: projectName,
      analysis: analysis,
      timestamp: new Date().toISOString()
    };
    
    const savedAnalyses = JSON.parse(localStorage.getItem('deepAnalyses') || '[]');
    savedAnalyses.push(analysisData);
    localStorage.setItem('deepAnalyses', JSON.stringify(savedAnalyses));
    
    showNotification('‚úÖ An√°lisis profundo guardado correctamente');
    
    const overlay = document.querySelector('.executive-overlay');
    if (overlay) overlay.remove();
  };
}

// ========== FUNCIONES ADICIONALES ==========
window.focusCriticalTask = function(taskId) {
  console.log(`üîç Enfocando tarea cr√≠tica: ${taskId}`);
  
  // Cerrar el modal de IA
  const overlay = document.querySelector('.executive-overlay');
  if (overlay) overlay.remove();
  
  // Resaltar la tarea en el Gantt
  const taskElement = document.querySelector(`.premium-task[data-task-id="${taskId}"]`);
  if (taskElement) {
    // Animaci√≥n de resaltado
    taskElement.style.boxShadow = '0 0 0 3px rgba(231, 76, 60, 0.5)';
    taskElement.style.transform = 'scale(1.02)';
    taskElement.style.zIndex = '100';
    
    // Scroll a la tarea
    taskElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    // Quitar resaltado despu√©s de 3 segundos
    setTimeout(() => {
      taskElement.style.boxShadow = '';
      taskElement.style.transform = '';
      taskElement.style.zIndex = '';
    }, 3000);
    
    showNotification(`‚úÖ Tarea cr√≠tica enfocada en el Gantt`);
  } else {
    showNotification('‚ö†Ô∏è No se pudo encontrar la tarea en el Gantt');
  }
};

window.markTaskAsCompleted = function(taskId) {
  console.log(`‚úÖ Marcando tarea como completada: ${taskId}`);
  
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;
  
  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  const project = projects[projectIndex];
  const task = project.tasks.find(t => t.id == taskId);
  
  if (task) {
    task.status = 'completed';
    task.progress = 100;
    
    // Agregar al historial
    task.history = task.history || [];
    task.history.push({
      from: task.status,
      to: 'completed',
      date: new Date().toISOString()
    });
    
    // Guardar cambios
    safeSave();
    
    showNotification(`‚úÖ Tarea "${task.name}" marcada como completada`);
    
    // Actualizar UI si es necesario
    setTimeout(() => {
      if (typeof updateTaskUI === 'function') {
        updateTaskUI(taskId);
      }
      
      // Actualizar el panel de IA si est√° abierto
      const aiOverlay = document.querySelector('.executive-overlay');
      if (aiOverlay) {
        // Cerrar y volver a abrir para refrescar datos
        aiOverlay.remove();
        setTimeout(() => showAIPredictorPremium(), 500);
      }
    }, 100);
  }
};

window.saveAIAnalysis = function() {
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;
  
  const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
  const project = projects[projectIndex];
  const tasks = project?.tasks || [];
  
  const analysis = performPredictiveAnalysisEnhanced(tasks);
  
  const analysisData = {
    type: 'ai_predictor_analysis',
    projectId: projectIndex,
    projectName: project.name,
    analysis: analysis,
    timestamp: new Date().toISOString()
  };
  
  // Guardar en localStorage
  const savedAnalyses = JSON.parse(localStorage.getItem('aiPredictorAnalyses') || '[]');
  savedAnalyses.push(analysisData);
  localStorage.setItem('aiPredictorAnalyses', JSON.stringify(savedAnalyses));
  
  showNotification('‚úÖ An√°lisis IA guardado correctamente');
  
  // Cerrar el modal
  const overlay = document.querySelector('.executive-overlay');
  if (overlay) overlay.remove();
};

// ========== PRUEBA INMEDIATA ==========
console.log('ü§ñ IA Predictor MEJORADO - Sistema activado');
console.log('Para probar:');
console.log('1. Abre el Gantt Ejecutivo');
console.log('2. Haz clic en el bot√≥n "IA Predictor" en el header');
console.log('3. Se detectar√°n autom√°ticamente las tareas cr√≠ticas');
console.log('4. El bot√≥n "Exportar PDF" ahora genera un PDF imprimible');
console.log('5. El bot√≥n "An√°lisis Profundo" hace un an√°lisis real con datos');




// ========== MODO MOBILE - VISTA RESPONSIVE ==========
window.toggleMobileViewPremium = function() {
  console.log('üì± ACTIVANDO/VISTA MOBILE...');
  
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) {
    showNotification('‚ö†Ô∏è Abre el Gantt Ejecutivo primero');
    return;
  }
  
  // Verificar si ya est√° en modo mobile
  const isMobileMode = ganttContainer.classList.contains('mobile-mode');
  
  if (isMobileMode) {
    // Volver a modo escritorio
    disableMobileView();
    showNotification('üñ•Ô∏è Cambiando a vista de escritorio');
  } else {
    // Activar modo mobile
    enableMobileView();
    showNotification('üì± Activando vista mobile optimizada');
  }
};

function enableMobileView() {
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;
  
  console.log('üì± Activando vista mobile...');
  
  // Agregar clase para modo mobile
  ganttContainer.classList.add('mobile-mode');
  
  // Aplicar estilos mobile
  ganttContainer.style.cssText = `
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    border-radius: 0 !important;
    transform: none !important;
    z-index: 1000000 !important;
  `;
  
  // Ocultar sidebar en mobile
  const sidebar = ganttContainer.querySelector('div[style*="width: 320px"]');
  if (sidebar) {
    sidebar.style.display = 'none';
  }
  
  // Ajustar header
  const header = ganttContainer.querySelector('div[style*="background: linear-gradient(90deg, #0a0a1a"]');
  if (header) {
    header.style.flexDirection = 'column';
    header.style.padding = '15px';
  }
  
  // Ajustar botones del header
  const headerButtons = header ? header.querySelectorAll('button') : [];
  headerButtons.forEach(btn => {
    btn.style.padding = '8px 12px';
    btn.style.fontSize = '12px';
    btn.style.margin = '2px';
  });
  
  // Ajustar timeline para mobile
  const timelineHeader = ganttContainer.querySelector('div[style*="display: flex; background: rgba(255, 255, 255, 0.05)"]');
  if (timelineHeader) {
    timelineHeader.style.paddingLeft = '20px';
    timelineHeader.style.overflowX = 'auto';
    
    // Mostrar solo 7 d√≠as en mobile
    const dateCells = timelineHeader.querySelectorAll('div[style*="flex: 0 0 45px"]');
    dateCells.forEach((cell, index) => {
      if (index > 6) {
        cell.style.display = 'none';
      } else {
        cell.style.flex = '0 0 60px';
        cell.style.minWidth = '60px';
      }
    });
  }
  
  // Ajustar columnas de tareas
  const taskFixedColumns = ganttContainer.querySelectorAll('div[style*="width: 320px; padding: 0 20px; position: absolute"]');
  taskFixedColumns.forEach(col => {
    col.style.width = '150px';
    col.style.padding = '0 10px';
    
    // Ajustar contenido
    const taskInfo = col.querySelector('div[style*="display: flex; align-items: center; gap: 12px"]');
    if (taskInfo) {
      taskInfo.style.gap = '8px';
    }
    
    const taskNumber = col.querySelector('div[style*="width: 36px; height: 36px"]');
    if (taskNumber) {
      taskNumber.style.width = '28px';
      taskNumber.style.height = '28px';
      taskNumber.style.fontSize = '12px';
    }
    
    const taskName = col.querySelector('div[style*="color: white; font-weight: bold; font-size: 15px"]');
    if (taskName) {
      taskName.style.fontSize = '12px';
    }
    
    const taskDetails = col.querySelector('div[style*="color: #95a5a6; font-size: 12px; display: flex; gap: 15px"]');
    if (taskDetails) {
      taskDetails.style.fontSize = '10px';
      taskDetails.style.gap = '8px';
      taskDetails.style.flexWrap = 'wrap';
    }
  });
  
  // Ajustar √°rea de barras Gantt
  const taskBars = ganttContainer.querySelectorAll('div[style*="flex: 1; height: 40px; position: relative"]');
  taskBars.forEach(bar => {
    bar.style.minWidth = '500px'; // Scroll horizontal en mobile
    
    const mainBar = bar.querySelector('div[style*="position: absolute; left:"]');
    if (mainBar) {
      const currentLeft = mainBar.style.left;
      if (currentLeft.includes('px')) {
        const pixels = parseInt(currentLeft);
        mainBar.style.left = (pixels * 0.5) + 'px'; // Escalar para mobile
      }
    }
  });
  
  // A√±adir bot√≥n flotante para mostrar/ocultar sidebar
  createMobileSidebarToggle();
  
  console.log('‚úÖ Vista mobile activada');
}

function disableMobileView() {
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  if (!ganttContainer) return;
  
  console.log('üñ•Ô∏è Desactivando vista mobile...');
  
  // Remover clase mobile
  ganttContainer.classList.remove('mobile-mode');
  
  // Restaurar estilos originales
  ganttContainer.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 95vw;
    height: 90vh;
    background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
    border-radius: 24px;
    box-shadow: 0 30px 60px rgba(0,0,0,0.6);
    border: 1px solid rgba(52, 152, 219, 0.4);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    z-index: 999999;
  `;
  
  // Mostrar sidebar
  const sidebar = ganttContainer.querySelector('div[style*="width: 320px"]');
  if (sidebar) {
    sidebar.style.display = 'flex';
  }
  
  // Restaurar header
  const header = ganttContainer.querySelector('div[style*="background: linear-gradient(90deg, #0a0a1a"]');
  if (header) {
    header.style.flexDirection = 'row';
    header.style.padding = '25px 35px';
  }
  
  // Restaurar botones
  const headerButtons = header ? header.querySelectorAll('button') : [];
  headerButtons.forEach(btn => {
    btn.style.padding = '12px 20px';
    btn.style.fontSize = '14px';
    btn.style.margin = '0';
  });
  
  // Restaurar timeline
  const timelineHeader = ganttContainer.querySelector('div[style*="display: flex; background: rgba(255, 255, 255, 0.05)"]');
  if (timelineHeader) {
    timelineHeader.style.paddingLeft = '320px';
    
    // Mostrar todas las fechas
    const dateCells = timelineHeader.querySelectorAll('div[style*="flex: 0 0 45px"]');
    dateCells.forEach(cell => {
      cell.style.display = 'block';
      cell.style.flex = '0 0 45px';
      cell.style.minWidth = '45px';
    });
  }
  
  // Restaurar columnas de tareas
  const taskFixedColumns = ganttContainer.querySelectorAll('div[style*="width: 320px; padding: 0 20px; position: absolute"]');
  taskFixedColumns.forEach(col => {
    col.style.width = '320px';
    col.style.padding = '0 20px';
    
    const taskInfo = col.querySelector('div[style*="display: flex; align-items: center; gap: 12px"]');
    if (taskInfo) {
      taskInfo.style.gap = '12px';
    }
    
    const taskNumber = col.querySelector('div[style*="width: 36px; height: 36px"]');
    if (taskNumber) {
      taskNumber.style.width = '36px';
      taskNumber.style.height = '36px';
      taskNumber.style.fontSize = 'inherit';
    }
    
    const taskName = col.querySelector('div[style*="color: white; font-weight: bold; font-size: 15px"]');
    if (taskName) {
      taskName.style.fontSize = '15px';
    }
    
    const taskDetails = col.querySelector('div[style*="color: #95a5a6; font-size: 12px; display: flex; gap: 15px"]');
    if (taskDetails) {
      taskDetails.style.fontSize = '12px';
      taskDetails.style.gap = '15px';
      taskDetails.style.flexWrap = 'nowrap';
    }
  });
  
  // Remover bot√≥n flotante mobile
  const mobileToggle = document.getElementById('mobileSidebarToggle');
  if (mobileToggle) {
    mobileToggle.remove();
  }
  
  console.log('‚úÖ Vista escritorio restaurada');
}

function createMobileSidebarToggle() {
  // Remover si ya existe
  const existingToggle = document.getElementById('mobileSidebarToggle');
  if (existingToggle) existingToggle.remove();
  
  const toggleBtn = document.createElement('button');
  toggleBtn.id = 'mobileSidebarToggle';
  toggleBtn.innerHTML = 'üìä';
  toggleBtn.title = 'Mostrar/Ocultar Panel';
  
  toggleBtn.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 56px;
    height: 56px;
    background: linear-gradient(45deg, #9b59b6, #8e44ad);
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 24px;
    cursor: pointer;
    z-index: 1000001;
    box-shadow: 0 6px 20px rgba(155, 89, 182, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
  `;
  
  toggleBtn.onclick = function() {
    const ganttContainer = document.getElementById('premiumExecutiveGantt');
    if (!ganttContainer) return;
    
    const sidebar = ganttContainer.querySelector('div[style*="width: 320px"]');
    if (sidebar) {
      const isVisible = sidebar.style.display !== 'none';
      sidebar.style.display = isVisible ? 'none' : 'flex';
      toggleBtn.innerHTML = isVisible ? 'üìä' : 'üì±';
      showNotification(isVisible ? 'üì± Panel oculto' : 'üìä Panel visible');
    }
  };
  
  document.body.appendChild(toggleBtn);
}

// ========== DETECCI√ìN AUTOM√ÅTICA DE DISPOSITIVO ==========
function detectDeviceAndAdjust() {
  const isMobileDevice = window.innerWidth <= 768;
  const ganttContainer = document.getElementById('premiumExecutiveGantt');
  
  if (ganttContainer && isMobileDevice) {
    console.log('üì± Dispositivo mobile detectado, ajustando interfaz...');
    
    // Ajustar autom√°ticamente si est√° en pantallas peque√±as
    if (!ganttContainer.classList.contains('mobile-mode')) {
      setTimeout(() => {
        enableMobileView();
        showNotification('üì± Interfaj ajustada para mobile');
      }, 1000);
    }
  }
}

// Escuchar cambios de tama√±o de ventana
window.addEventListener('resize', detectDeviceAndAdjust);

// Ejecutar detecci√≥n al cargar
setTimeout(detectDeviceAndAdjust, 2000);























window.exportGanttData = function () {
  const project = projects?.[currentProjectIndex];
  if (!project) {
    alert('No hay proyecto activo');
    return;
  }

  const tasks = project.tasks || [];

  // ‚úÖ CALCULAR EVM CORRECTO usando la funci√≥n que ya tienes
  const evmData = calculateEVMRealFromTasks(tasks);
  if (!evmData) {
    alert('Error al calcular m√©tricas EVM');
    return;
  }

  const { PV, EV, AC, BAC, CPI, SPI, CV, SV, EAC, ETC, VAC } = evmData;
  
  // ===============================
  // CORRECCI√ìN: Asegurar que usamos las m√©tricas del c√°lculo EVM
  // ===============================
  
  // Ya vienen del c√°lculo, pero por si acaso recalculamos usando las f√≥rmulas est√°ndar
  const correctedEAC = CPI > 0 ? BAC / CPI : BAC;
  const correctedETC = correctedEAC - AC;
  const correctedVAC = BAC - correctedEAC;
  
  const unit = "h";

  // ===============================
  // PREPARAR DATOS PARA GR√ÅFICOS (CORREGIDOS)
  // ===============================
  
  // 1. DISTRIBUCI√ìN DE ESTADOS (CORREGIDO para incluir todos los estados)
  const statusData = {
    completed: tasks.filter(t => t.status === 'completed').length,
    inProgress: tasks.filter(t => t.status === 'inProgress').length,
    pending: tasks.filter(t => t.status === 'pending').length,
    overdue: tasks.filter(t => t.status === 'overdue').length,
    rezagado: tasks.filter(t => t.status === 'rezagado').length
  };

  // 2. DATOS BURNDOWN SIMPLIFICADO (CORREGIDO con datos reales)
  const burndownLabels = ['Inicio', '25%', '50%', '75%', 'Actual', 'Fin'];
  
  // L√≠nea ideal: decremento lineal
  const burndownIdeal = [BAC, BAC * 0.75, BAC * 0.5, BAC * 0.25, 0, 0];
  
  // L√≠nea real: basada en el EV real
  const progressPercentage = BAC > 0 ? (EV / BAC) : 0;
  const burndownActual = [
    BAC,
    BAC * 0.75,
    BAC * 0.5,
    BAC * 0.25,
    BAC - EV,  // CORRECCI√ìN: Esto es lo que realmente falta
    0
  ];

  // ===============================
  // CALCULAR VALOR GANADO POR TAREA INDIVIDUALMENTE (CORRECTO)
  // ===============================
  const taskEarnedValues = tasks.map(task => {
    const estimated = Number(task.estimatedTime) || 0;
    const logged = Number(task.timeLogged) || 0;
    const status = task.status || 'pending';
    
    let progress = 0;
    let earned = 0;
    
    // USAR LA MISMA L√ìGICA QUE calculateEVMRealFromTasks
    if (status === 'completed') {
      progress = 1.0;
    } else if (logged > 0 && estimated > 0 && status !== 'pending') {
      progress = Math.min(0.99, logged / estimated);
    } else if (task.progress !== undefined && task.progress !== null) {
      progress = Math.min(0.99, Number(task.progress) / 100);
    } else {
      // Estado por defecto (igual que en calculateEVMRealFromTasks)
      if (status.includes('progress') || status === 'inProgress') {
        progress = 0.5;
      } else if (status.includes('overdue') || status.includes('delayed') || status.includes('atrasado') || status.includes('rezagado')) {
        progress = 0.5;
      } else if (status.includes('pending')) {
        progress = 0;
      } else {
        progress = 0.3;
      }
    }
    
    earned = estimated * progress;
    
    return {
      name: task.name,
      estimated,
      logged,
      status,
      progress: progress * 100,
      earned
    };
  });

  // ===============================
  // CREAR CONTENIDO CON PAGINACI√ìN CONTROLADA
  // ===============================
  const root = document.createElement("div");
  root.id = "reporteContainer";
  root.style.cssText = `
    width: 210mm;
    min-height: 297mm;
    margin: 0 auto;
    padding: 20mm;
    background: white;
    font-family: 'Segoe UI', Arial, sans-serif;
    color: #333;
    box-sizing: border-box;
    page-break-inside: avoid;
    break-inside: avoid;
  `;

  root.innerHTML = `
    <!-- PORTADA -->
    <div style="page-break-after: always; break-after: page;">
      <div style="text-align: center; margin-top: 60mm;">
        <h1 style="font-size: 36px; color: #2c3e50; margin-bottom: 20px;">
          Reporte Ejecutivo EVM
        </h1>
        <h2 style="font-size: 24px; color: #3498db; margin-bottom: 10px;">
          ${project.name}
        </h2>
        <div style="margin: 20px auto; width: 100px; height: 4px; background: linear-gradient(to right, #3498db, #2ecc71);"></div>
        <p style="font-size: 16px; color: #7f8c8d;">
          Generado el ${new Date().toLocaleDateString('es-ES', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          })}
        </p>
        <p style="font-size: 14px; color: #95a5a6; margin-top: 20px;">
          An√°lisis de Valor Ganado (EVM) - Gesti√≥n de Proyectos
        </p>
      </div>
    </div>

    <!-- RESUMEN EJECUTIVO -->
    <div style="page-break-after: always; break-after: page;">
      <h2 style="color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; margin-bottom: 25px;">
        üìä Resumen Ejecutivo EVM
      </h2>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
        <!-- CARD SPI -->
        <div style="background: ${SPI >= 1 ? '#e8f6f3' : SPI >= 0.8 ? '#fef9e7' : '#fdebd0'}; 
                    border: 2px solid ${SPI >= 1 ? '#2ecc71' : SPI >= 0.8 ? '#f39c12' : '#e74c3c'};
                    border-radius: 12px; padding: 20px; text-align: center;">
          <div style="font-size: 18px; font-weight: bold; color: #2c3e50; margin-bottom: 10px;">
            √çNDICE DE CRONOGRAMA (SPI)
          </div>
          <div style="font-size: 48px; font-weight: bold; 
                      color: ${SPI >= 1 ? '#2ecc71' : SPI >= 0.8 ? '#f39c12' : '#e74c3c'};">
            ${SPI.toFixed(2)}
          </div>
          <div style="font-size: 14px; color: #7f8c8d; margin-top: 10px;">
            ${SPI >= 1 ? '‚úÖ Adelantado/En tiempo' : 
              SPI >= 0.8 ? '‚ö†Ô∏è En riesgo moderado' : 'üî¥ Retrasado significativo'}
          </div>
          <div style="font-size: 12px; color: #95a5a6; margin-top: 10px;">
            SPI = EV / PV = ${EV.toFixed(2)} / ${PV.toFixed(2)}
          </div>
        </div>
        
        <!-- CARD CPI -->
        <div style="background: ${CPI >= 1 ? '#e8f6f3' : CPI >= 0.9 ? '#fef9e7' : '#fdebd0'}; 
                    border: 2px solid ${CPI >= 1 ? '#2ecc71' : CPI >= 0.9 ? '#f39c12' : '#e74c3c'};
                    border-radius: 12px; padding: 20px; text-align: center;">
          <div style="font-size: 18px; font-weight: bold; color: #2c3e50; margin-bottom: 10px;">
            √çNDICE DE COSTO (CPI)
          </div>
          <div style="font-size: 48px; font-weight: bold; 
                      color: ${CPI >= 1 ? '#2ecc71' : CPI >= 0.9 ? '#f39c12' : '#e74c3c'};">
            ${CPI.toFixed(2)}
          </div>
          <div style="font-size: 14px; color: #7f8c8d; margin-top: 10px;">
            ${CPI >= 1 ? '‚úÖ En/bajo presupuesto' : 
              CPI >= 0.9 ? '‚ö†Ô∏è Ligeramente sobre costo' : 'üî¥ Sobre costo significativo'}
          </div>
          <div style="font-size: 12px; color: #95a5a6; margin-top: 10px;">
            CPI = EV / AC = ${EV.toFixed(2)} / ${AC.toFixed(2)}
          </div>
        </div>
      </div>

      <!-- M√âTRICAS PRINCIPALES -->
      <h3 style="color: #2c3e50; margin: 30px 0 15px;">M√©tricas Clave EVM</h3>
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
        <div style="background: #e3f2fd; border-radius: 8px; padding: 15px; text-align: center; border-left: 4px solid #3498db;">
          <div style="font-size: 12px; color: #1976d2; margin-bottom: 5px; font-weight: bold;">BAC</div>
          <div style="font-size: 20px; font-weight: bold;">${BAC.toFixed(2)} ${unit}</div>
          <div style="font-size: 11px; color: #5c6bc0;">Presupuesto Total</div>
        </div>
        <div style="background: #e8f5e9; border-radius: 8px; padding: 15px; text-align: center; border-left: 4px solid #2ecc71;">
          <div style="font-size: 12px; color: #2e7d32; margin-bottom: 5px; font-weight: bold;">EV</div>
          <div style="font-size: 20px; font-weight: bold;">${EV.toFixed(2)} ${unit}</div>
          <div style="font-size: 11px; color: #388e3c;">Valor Ganado</div>
        </div>
        <div style="background: #fff3e0; border-radius: 8px; padding: 15px; text-align: center; border-left: 4px solid #ff9800;">
          <div style="font-size: 12px; color: #ef6c00; margin-bottom: 5px; font-weight: bold;">PV</div>
          <div style="font-size: 20px; font-weight: bold;">${PV.toFixed(2)} ${unit}</div>
          <div style="font-size: 11px; color: #f57c00;">Valor Planificado</div>
        </div>
        <div style="background: #ffebee; border-radius: 8px; padding: 15px; text-align: center; border-left: 4px solid #f44336;">
          <div style="font-size: 12px; color: #c62828; margin-bottom: 5px; font-weight: bold;">AC</div>
          <div style="font-size: 20px; font-weight: bold;">${AC.toFixed(2)} ${unit}</div>
          <div style="font-size: 11px; color: #d32f2f;">Costo Real</div>
        </div>
      </div>
      
      <!-- VARIANZAS -->
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;">
        <div style="background: ${CV >= 0 ? '#e8f5e9' : '#ffebee'}; border-radius: 8px; padding: 15px; text-align: center;">
          <div style="font-size: 14px; color: ${CV >= 0 ? '#2e7d32' : '#c62828'}; margin-bottom: 5px;">
            ${CV >= 0 ? '‚úÖ VARIANZA DE COSTO (CV)' : 'üî¥ VARIANZA DE COSTO (CV)'}
          </div>
          <div style="font-size: 24px; font-weight: bold; color: ${CV >= 0 ? '#2e7d32' : '#c62828'}">
            ${CV >= 0 ? '+' : ''}${CV.toFixed(2)} ${unit}
          </div>
          <div style="font-size: 12px; color: #666;">
            CV = EV - AC = ${EV.toFixed(2)} - ${AC.toFixed(2)}
          </div>
        </div>
        <div style="background: ${SV >= 0 ? '#e8f5e9' : '#ffebee'}; border-radius: 8px; padding: 15px; text-align: center;">
          <div style="font-size: 14px; color: ${SV >= 0 ? '#2e7d32' : '#c62828'}; margin-bottom: 5px;">
            ${SV >= 0 ? '‚úÖ VARIANZA DE TIEMPO (SV)' : 'üî¥ VARIANZA DE TIEMPO (SV)'}
          </div>
          <div style="font-size: 24px; font-weight: bold; color: ${SV >= 0 ? '#2e7d32' : '#c62828'}">
            ${SV >= 0 ? '+' : ''}${SV.toFixed(2)} ${unit}
          </div>
          <div style="font-size: 12px; color: #666;">
            SV = EV - PV = ${EV.toFixed(2)} - ${PV.toFixed(2)}
          </div>
        </div>
      </div>
    </div>

    <!-- GR√ÅFICOS -->
    <div style="page-break-after: always; break-after: page;">
      <h2 style="color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; margin-bottom: 25px;">
        üìà An√°lisis Gr√°fico EVM
      </h2>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; margin-bottom: 30px;">
        <!-- GR√ÅFICO 1: DISTRIBUCI√ìN DE TAREAS -->
        <div style="border: 1px solid #e0e0e0; border-radius: 10px; padding: 20px;">
          <h3 style="margin: 0 0 15px 0; font-size: 16px; text-align: center;">
            Distribuci√≥n de Tareas por Estado
          </h3>
          <canvas id="chartEstadoTareas" width="300" height="300" style="width: 100%; height: auto;"></canvas>
          <!-- LEYENDA CON CANTIDADES -->
          <div style="margin-top: 10px; font-size: 11px; text-align: center; color: #666;">
            <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 10px;">
              <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 10px; height: 10px; background: #2ecc71; border-radius: 50%;"></div>
                <span>Completadas: ${statusData.completed}</span>
              </div>
              <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 10px; height: 10px; background: #008090; border-radius: 50%;"></div>
                <span>En Progreso: ${statusData.inProgress}</span>
              </div>
              <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 10px; height: 10px; background: #f39c12; border-radius: 50%;"></div>
                <span>Pendientes: ${statusData.pending}</span>
              </div>
              <div style="display: flex; align-items: center; gap: 5px;">
                <div style="width: 10px; height: 10px; background: #e74c3c; border-radius: 50%;"></div>
                <span>Rezagadas: ${statusData.overdue + statusData.rezagado}</span>
              </div>
            </div>
            <div style="margin-top: 5px; font-weight: bold;">
              Total: ${tasks.length} tareas
            </div>
          </div>
        </div>
        
        <!-- GR√ÅFICO 2: EVM (CORREGIDO) -->
        <div style="border: 1px solid #e0e0e0; border-radius: 10px; padding: 20px;">
          <h3 style="margin: 0 0 15px 0; font-size: 16px; text-align: center;">
            Comparaci√≥n PV vs EV vs AC
          </h3>
          <canvas id="chartEVM" width="300" height="300" style="width: 100%; height: auto;"></canvas>
          <div style="margin-top: 15px; font-size: 12px; text-align: center; color: #666;">
            <div>üîµ PV: ${PV.toFixed(2)}h üü¢ EV: ${EV.toFixed(2)}h üî¥ AC: ${AC.toFixed(2)}h</div>
            <div>${EV >= PV ? '‚úÖ EV ‚â• PV' : '‚ö†Ô∏è EV < PV'} | ${AC <= EV ? '‚úÖ AC ‚â§ EV' : '‚ö†Ô∏è AC > EV'}</div>
          </div>
        </div>
      </div>
      
      <!-- GR√ÅFICO 3: BURNDOWN (ANCHO COMPLETO) -->
      <div style="border: 1px solid #e0e0e0; border-radius: 10px; padding: 20px; margin-top: 20px;">
        <h3 style="margin: 0 0 15px 0; font-size: 16px; text-align: center;">
          Gr√°fico Burndown del Proyecto
        </h3>
        <canvas id="chartBurndown" width="600" height="300" style="width: 100%; height: auto;"></canvas>
        <div style="margin-top: 15px; font-size: 12px; text-align: center; color: #666;">
          <span style="color: #3498db;">üîµ L√≠nea Ideal</span> | 
          <span style="color: ${EV >= PV ? '#2ecc71' : '#e74c3c'}">${EV >= PV ? 'üü¢' : 'üî¥'} Progreso Real (${progressPercentage.toFixed(1)}%)</span>
        </div>
      </div>
    </div>


    <!-- TABLA DETALLADA DE TAREAS CON VALOR GANADO (CORREGIDA) -->
    <div style="page-break-after: always; break-after: page;">
      <h2 style="color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; margin-bottom: 25px;">
        üìã Detalle de Tareas con Valor Ganado
      </h2>
      
      <table width="100%" cellspacing="0" style="border-collapse: collapse; font-size: 11px;">
        <thead>
          <tr style="background: linear-gradient(to right, #f8f9fa, #e3f2fd); border-bottom: 2px solid #3498db;">
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">#</th>
            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Tarea</th>
            <th style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd;">Estado</th>
            <th style="padding: 10px; text-align: right; border-bottom: 1px solid #ddd;">Plan (h)</th>
            <th style="padding: 10px; text-align: right; border-bottom: 1px solid #ddd;">Real (h)</th>
            <th style="padding: 10px; text-align: center; border-bottom: 1px solid #ddd;">Progreso</th>
            <th style="padding: 10px; text-align: right; border-bottom: 1px solid #ddd; background: #e8f5e9;">Valor Ganado</th>
            <th style="padding: 10px; text-align: right; border-bottom: 1px solid #ddd;">Contribuci√≥n</th>
          </tr>
        </thead>
        <tbody>
          ${taskEarnedValues.map((task, index) => {
            const status = task.status || 'pending';
            let statusColor = '#95a5a6';
            let statusText = status;
            
            if (status === "completed" || status === "completado") {
              statusColor = '#2ecc71';
              statusText = 'Completado';
            } else if (status === "inProgress" || status.includes('progress')) {
              statusColor = '#008090';
              statusText = 'En Progreso';
            } else if (status === "overdue" || status === "rezagado" || status.includes('atrasado')) {
              statusColor = '#e74c3c';
              statusText = 'Rezagado';
            } else if (status === "pending") {
              statusColor = '#f39c12';
              statusText = 'Pendiente';
            }
            
            const rowStyle = index % 2 === 0 ? 'background: #f9f9f9;' : 'background: white;';
            const contribution = BAC > 0 ? ((task.earned / EV) * 100).toFixed(1) : 0;
            
            return `
              <tr style="${rowStyle}">
                <td style="padding: 8px; border-bottom: 1px solid #eee; font-weight: bold;">${index + 1}</td>
                <td style="padding: 8px; border-bottom: 1px solid #eee;">${task.name}</td>
                <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center;">
                  <span style="background: ${statusColor}; color: white; padding: 3px 8px; border-radius: 10px; font-size: 10px; display: inline-block; min-width: 70px;">
                    ${statusText}
                  </span>
                </td>
                <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold;">${task.estimated.toFixed(1)}</td>
                <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">${task.logged.toFixed(1)}</td>
                <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center;">
                  <div style="position: relative;">
                    <div style="background: #ecf0f1; border-radius: 3px; height: 8px; width: 100%; margin-bottom: 4px;">
                      <div style="background: ${statusColor}; height: 100%; width: ${task.progress}%; border-radius: 3px;"></div>
                    </div>
                    <div style="font-size: 9px; color: #666; position: absolute; right: 0; top: -2px;">
                      ${task.progress.toFixed(0)}%
                    </div>
                  </div>
                </td>
                <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold; background: #f1f8e9;">
                  ${task.earned.toFixed(2)} ${unit}
                </td>
                <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">
                  <div style="color: #3498db; font-size: 10px;">
                    ${contribution}%
                  </div>
                </td>
              </tr>
            `;
          }).join('')}
          
          <!-- FILA DE TOTALES -->
          <tr style="background: linear-gradient(to right, #e3f2fd, #bbdefb); border-top: 2px solid #1976d2;">
            <td colspan="3" style="padding: 10px; text-align: left; font-weight: bold;">TOTALES</td>
            <td style="padding: 10px; text-align: right; font-weight: bold; border-left: 1px solid #90caf9;">
              ${taskEarnedValues.reduce((sum, t) => sum + t.estimated, 0).toFixed(2)}
            </td>
            <td style="padding: 10px; text-align: right; font-weight: bold;">
              ${taskEarnedValues.reduce((sum, t) => sum + t.logged, 0).toFixed(2)}
            </td>
            <td style="padding: 10px; text-align: center; font-weight: bold;">
  ${BAC > 0 ? Math.round((EV / BAC) * 100) : 0}%
</td>
            <td style="padding: 10px; text-align: right; font-weight: bold; background: #c8e6c9;">
              ${EV.toFixed(2)} ${unit}
            </td>
            <td style="padding: 10px; text-align: right; font-weight: bold;">
              100%
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- CONCLUSI√ìN Y PRON√ìSTICOS (CORREGIDOS) -->
    <div>
      <h2 style="color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; margin-bottom: 25px;">
        üéØ Pron√≥sticos y Recomendaciones
      </h2>
      
      <!-- PRON√ìSTICOS -->
      <div style="background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); 
                  color: white; border-radius: 12px; padding: 25px; margin-bottom: 30px;">
        <h3 style="margin: 0 0 20px 0; font-size: 20px; text-align: center;">üîÆ Pron√≥sticos EVM</h3>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; text-align: center;">
          <div>
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">EAC</div>
            <div style="font-size: 28px; font-weight: bold;">${EAC.toFixed(2)} ${unit}</div>
            <div style="font-size: 12px; opacity: 0.8;">Estimado al Finalizar</div>
            <div style="font-size: 10px; opacity: 0.7;">BAC / CPI</div>
          </div>
          <div>
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ETC</div>
            <div style="font-size: 28px; font-weight: bold;">${ETC.toFixed(2)} ${unit}</div>
            <div style="font-size: 12px; opacity: 0.8;">Horas Restantes</div>
            <div style="font-size: 10px; opacity: 0.7;">EAC - AC</div>
          </div>
          <div>
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">VAC</div>
            <div style="font-size: 28px; font-weight: bold; color: ${VAC >= 0 ? '#a5d6a7' : '#ef9a9a'}">
              ${VAC >= 0 ? '+' : ''}${VAC.toFixed(2)} ${unit}
            </div>
            <div style="font-size: 12px; opacity: 0.8;">
              ${VAC >= 0 ? 'Ahorro Estimado' : 'Sobrecosto Estimado'}
            </div>
            <div style="font-size: 10px; opacity: 0.7;">BAC - EAC</div>
          </div>
          <div>
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">TCPI</div>
            <div style="font-size: 28px; font-weight: bold;">
              ${(BAC > AC && (BAC - EV) > 0 ? ((BAC - EV) / (BAC - AC)).toFixed(2) : 'N/A')}
            </div>
            <div style="font-size: 12px; opacity: 0.8;">√çndice para Completar</div>
            <div style="font-size: 10px; opacity: 0.7;">(BAC - EV) / (BAC - AC)</div>
          </div>
        </div>
      </div>
      
      <!-- CONCLUSI√ìN -->
      <div style="background: #f8f9fa; border-left: 4px solid ${SPI >= 0.8 ? (CPI >= 1 ? '#2ecc71' : '#f39c12') : '#e74c3c'}; 
                  padding: 25px; border-radius: 0 8px 8px 0; margin-bottom: 30px;">
        <h3 style="margin: 0 0 15px 0; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
          ${SPI >= 0.8 && CPI >= 1 ? '‚úÖ ' : SPI >= 0.7 && CPI >= 0.9 ? '‚ö†Ô∏è ' : 'üî¥ '}
          An√°lisis Final del Proyecto
        </h3>
        <p style="margin: 0 0 15px 0; line-height: 1.6; font-size: 14px;">
          <strong>${project.name}</strong> presenta un desempe√±o 
          <strong>${SPI >= 1 ? '√≥ptimo' : SPI >= 0.8 ? 'moderado' : 'cr√≠tico'}</strong> 
          en cronograma (SPI: ${SPI.toFixed(2)}) y un manejo de costos 
          <strong>${CPI >= 1 ? 'eficiente' : CPI >= 0.9 ? 'aceptable' : 'problem√°tico'}</strong> 
          (CPI: ${CPI.toFixed(2)}).
        </p>
        <p style="margin: 0 0 15px 0; line-height: 1.6; font-size: 14px;">
         <strong>Estado actual:</strong> ${Math.round((EV / BAC) * 100)}% del valor ganado 
          (${EV.toFixed(2)}h de ${BAC.toFixed(2)}h planificadas), con ${tasks.length} tareas 
          (${statusData.completed} completadas, ${statusData.inProgress} en progreso).
        </p>
        
        <!-- RECOMENDACIONES ESPEC√çFICAS -->
        <div style="background: ${SPI >= 0.8 && CPI >= 1 ? '#e8f6f3' : '#fff3e0'}; 
                    padding: 15px; border-radius: 6px; margin-top: 15px;">
          <h4 style="margin: 0 0 10px 0; color: ${SPI >= 0.8 && CPI >= 1 ? '#2c3e50' : '#e65100'};">
            ${SPI >= 0.8 && CPI >= 1 ? '‚úÖ RECOMENDACIONES:' : '‚ö†Ô∏è RECOMENDACIONES:'}
          </h4>
          <ul style="margin: 0; padding-left: 20px; font-size: 13px;">
            ${(() => {
              const recommendations = [];
              
              if (SPI < 0.8) {
                recommendations.push(`<li><strong>Acelerar cronograma:</strong> SPI de ${SPI.toFixed(2)} indica retraso. Revisar tareas cr√≠ticas y dependencias.</li>`);
              }
              
              if (CPI < 0.9) {
                recommendations.push(`<li><strong>Controlar costos:</strong> CPI de ${CPI.toFixed(2)} muestra sobrecosto. Revisar asignaci√≥n de recursos.</li>`);
              }
              
              if (SV < 0) {
                recommendations.push(`<li><strong>Recuperar tiempo:</strong> Varianza de tiempo (SV) negativa: ${SV.toFixed(2)}h. Priorizar actividades en ruta cr√≠tica.</li>`);
              }
              
              if (CV < 0) {
                recommendations.push(`<li><strong>Optimizar recursos:</strong> Varianza de costo (CV) negativa: ${CV.toFixed(2)}h. Revisar eficiencia del equipo.</li>`);
              }
              
              if (statusData.overdue > 0 || statusData.rezagado > 0) {
                recommendations.push(`<li><strong>Atender tareas rezagadas:</strong> ${statusData.overdue + statusData.rezagado} tareas requieren atenci√≥n inmediata.</li>`);
              }
              
              if (recommendations.length === 0) {
                recommendations.push(`<li><strong>Mantener curso actual:</strong> Proyecto en buen estado. Continuar con monitoreo y mantener comunicaci√≥n del equipo.</li>`);
              }
              
              // Recomendaci√≥n general basada en EV
              if (EV / BAC < 0.5) {
                recommendations.push(`<li><strong>Aumentar productividad:</strong> Solo ${((EV / BAC) * 100).toFixed(1)}% del valor ganado. Revisar bloqueos y dependencias.</li>`);
              }
              
              return recommendations.join('');
            })()}
          </ul>
        </div>
      </div>
      
      <!-- PIE DE P√ÅGINA -->
      <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #eee; 
                  text-align: center; font-size: 11px; color: #95a5a6;">
        <div style="margin-bottom: 5px;">üìä Reporte EVM generado autom√°ticamente ‚Ä¢ Sistema de Gesti√≥n de Proyectos</div>
        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 10px;">
          <span>üìÖ ${new Date().toLocaleString()}</span>
          <span>üìã ${tasks.length} tareas analizadas</span>
          <span>‚è±Ô∏è ${BAC.toFixed(2)} horas planificadas</span>
          <span>üí∞ ${EV.toFixed(2)} horas de valor ganado</span>
        </div>
        <div style="margin-top: 10px; font-size: 10px; color: #bdc3c7;">
          M√©tricas EVM: BAC=${BAC.toFixed(2)}, PV=${PV.toFixed(2)}, EV=${EV.toFixed(2)}, AC=${AC.toFixed(2)}, CPI=${CPI.toFixed(2)}, SPI=${SPI.toFixed(2)}
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(root);

  // ===============================
  // CREAR GR√ÅFICOS DESPU√âS DE QUE EL DOM EST√â LISTO
  // ===============================
  setTimeout(() => {
    try {
      // 1. GR√ÅFICO DE DISTRIBUCI√ìN
      const ctxEstado = document.getElementById('chartEstadoTareas');
      if (ctxEstado) {
        new Chart(ctxEstado.getContext('2d'), {
          type: 'doughnut',
          data: {
            labels: ['Completadas', 'En Progreso', 'Pendientes', 'Rezagadas'],
            datasets: [{
              data: [statusData.completed, statusData.inProgress, statusData.pending, statusData.overdue + statusData.rezagado],
              backgroundColor: ['#2ecc71', '#008090', '#f39c12', '#e74c3c'],
              borderWidth: 1,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: false,
            plugins: {
              legend: { 
                position: 'bottom',
                labels: {
                  padding: 20,
                  usePointStyle: true
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.raw || 0;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                    return `${label}: ${value} tareas (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
      }

      // 2. GR√ÅFICO EVM
      const ctxEVM = document.getElementById('chartEVM');
      if (ctxEVM) {
        new Chart(ctxEVM.getContext('2d'), {
          type: 'bar',
          data: {
            labels: ['PV', 'EV', 'AC'],
            datasets: [{
              label: 'Horas',
              data: [PV, EV, AC],
              backgroundColor: [
                '#3498db',  // PV - azul
                '#2ecc71',  // EV - verde
                AC <= EV ? '#f39c12' : '#e74c3c'  // AC - naranja si OK, rojo si mal
              ],
              borderColor: [
                '#2980b9',
                '#27ae60',
                AC <= EV ? '#d35400' : '#c0392b'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: `Horas (${unit})`
                }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.dataset.label || '';
                    const value = context.raw || 0;
                    return `${label}: ${value} ${unit}`;
                  }
                }
              }
            }
          }
        });
      }

      // 3. GR√ÅFICO BURNDOWN
      const ctxBurndown = document.getElementById('chartBurndown');
      if (ctxBurndown) {
        new Chart(ctxBurndown.getContext('2d'), {
          type: 'line',
          data: {
            labels: burndownLabels,
            datasets: [
              {
                label: 'L√≠nea Ideal',
                data: burndownIdeal,
                borderColor: '#3498db',
                borderDash: [5, 5],
                borderWidth: 2,
                fill: false,
                pointRadius: 0
              },
              {
                label: 'Progreso Real',
                data: burndownActual,
                borderColor: EV >= PV ? '#2ecc71' : '#e74c3c',
                backgroundColor: EV >= PV ? 'rgba(46, 204, 113, 0.1)' : 'rgba(231, 76, 60, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.2,
                pointRadius: 4,
                pointBackgroundColor: EV >= PV ? '#2ecc71' : '#e74c3c'
              }
            ]
          },
          options: {
            responsive: false,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: `Horas Restantes (${unit})`
                },
                ticks: {
                  callback: function(value) {
                    return value + ' ' + unit;
                  }
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'Progreso del Proyecto'
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const datasetLabel = context.dataset.label || '';
                    const value = context.raw || 0;
                    return `${datasetLabel}: ${value} ${unit}`;
                  }
                }
              }
            }
          }
        });
      }

      // ===============================
      // GENERAR PDF
      // ===============================
      setTimeout(() => {
        if (typeof html2pdf !== 'undefined') {
          const opt = {
            margin: [10, 10, 10, 10],
            filename: `Reporte_EVM_${project.name.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0,10)}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { 
              scale: 2,
              useCORS: true,
              logging: false,
              letterRendering: true,
              backgroundColor: '#ffffff'
            },
            jsPDF: { 
              unit: 'mm', 
              format: 'a4', 
              orientation: 'portrait',
              compress: true
            },
            pagebreak: { 
              mode: ['avoid-all', 'css', 'legacy'],
              before: '.page-break'
            }
          };

          html2pdf().set(opt).from(root).save().then(() => {
            // Peque√±o delay para asegurar que se guarde antes de remover
            setTimeout(() => {
              if (root.parentNode) {
                root.remove();
              }
            }, 1000);
          }).catch(err => {
            console.error('Error generando PDF:', err);
            alert('Error al generar PDF. Intentando abrir para imprimir...');
            // Fallback a impresi√≥n
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
              <!DOCTYPE html>
              <html>
                <head>
                  <title>Reporte EVM - ${project.name}</title>
                  <style>
                    @media print {
                      body { margin: 0; padding: 0; }
                      .page-break { page-break-after: always; }
                      @page { margin: 15mm; }
                    }
                    body { 
                      font-family: 'Segoe UI', Arial, sans-serif; 
                      margin: 0;
                      padding: 0;
                      color: #333;
                    }
                    #reporteContainer {
                      width: 100%;
                      padding: 0;
                    }
                  </style>
                </head>
                <body>${root.innerHTML}</body>
              </html>
            `);
            printWindow.document.close();
            setTimeout(() => {
              printWindow.print();
              setTimeout(() => {
                printWindow.close();
                if (root.parentNode) {
                  root.remove();
                }
              }, 500);
            }, 500);
          });
        } else {
          console.warn('html2pdf no est√° disponible, usando fallback de impresi√≥n');
          // Fallback: Abrir ventana para imprimir
          const printWindow = window.open('', '_blank');
          printWindow.document.write(`
            <!DOCTYPE html>
            <html>
              <head>
                <title>Reporte EVM - ${project.name}</title>
                <style>
                  @media print {
                    body { margin: 0; padding: 0; }
                    .page-break { page-break-after: always; }
                    @page { margin: 15mm; }
                  }
                  body { 
                    font-family: 'Segoe UI', Arial, sans-serif; 
                    margin: 0;
                    padding: 0;
                    color: #333;
                  }
                  #reporteContainer {
                    width: 100%;
                    padding: 0;
                  }
                </style>
              </head>
              <body>${root.innerHTML}</body>
            </html>
          `);
          printWindow.document.close();
          setTimeout(() => {
            printWindow.print();
            setTimeout(() => {
              printWindow.close();
              if (root.parentNode) {
                root.remove();
              }
            }, 500);
          }, 500);
        }
      }, 1500); // M√°s tiempo para que los gr√°ficos se rendericen
    } catch (error) {
      console.error('Error creando gr√°ficos:', error);
      alert('Error al generar gr√°ficos, pero el reporte continuar√°...');
      // Continuar con la generaci√≥n del PDF incluso si hay error en gr√°ficos
      setTimeout(() => {
        // L√≥gica de generaci√≥n de PDF aqu√≠ (similar a la de arriba)
      }, 500);
    }
  }, 300);
};




window.openEVMDashboardCosts = function () {
  console.log('üí∞ Abriendo Dashboard EVM de COSTOS');

  // Forzar modo costos
  window.__EVM_MODE__ = 'costs';

  // üîí CERRAR PREVISUALIZACI√ìN EVM (s√≠ existe)
  const preview = document.getElementById('evmPreviewOverlay');
  if (preview) {
    console.log('üîí Cerrando previsualizaci√≥n EVM');
    preview.remove();
  }

  // üîí CERRAR CONFIGURACI√ìN DE COSTOS EVM (REAL)
const costModal = [...document.querySelectorAll('div')]
  .find(el =>
    el.innerText &&
    el.innerText.includes('CONFIGURACI√ìN') &&
    el.innerText.includes('Costos')
  );

if (costModal) {
  console.log('üîí Cerrando modal de configuraci√≥n de costos EVM');
  costModal.remove();
}


  // ‚è±Ô∏è Esperar a que el DOM quede limpio
  setTimeout(() => {
    if (typeof window.crearDashboardEVMCompleto === 'function') {
      console.log('üöÄ Creando Dashboard EVM de COSTOS');
      window.crearDashboardEVMCompleto();
    } else {
      console.error('‚ùå crearDashboardEVMCompleto no existe');
    }
  }, 100);
};



function renderEVMRecommendations(evm) {
  const container = document.getElementById('evmRecommendations');

  if (!container) {
    console.warn('‚ùå Contenedor evmRecommendations no encontrado');
    return;
  }

  container.innerHTML = generateEVMRecommendations(evm);
  console.log('‚úÖ Recomendaciones EVM renderizadas');
}




function renderEVMKPIs(evm) {
  const waitForDOM = setInterval(() => {
    const pvEl = document.getElementById('pvValue');
    if (!pvEl) return;

    clearInterval(waitForDOM);

    // KPIs existentes
    pvEl.textContent  = evm.PV.toLocaleString();
    document.getElementById('evValue').textContent  = evm.EV.toLocaleString();
    document.getElementById('acValue').textContent  = evm.AC.toLocaleString();
    document.getElementById('bacValue').textContent = evm.BAC.toLocaleString();

    document.getElementById('cpiValue').textContent = evm.CPI.toFixed(2);
    document.getElementById('spiValue').textContent = evm.SPI.toFixed(2);

    // ===============================
    // ‚ûï VARIANZAS EVM (AQU√ç)
    // ===============================
  const cvEl = document.getElementById('cvValue');
const svEl = document.getElementById('svValue');

    if (cvEl) {
      cvEl.textContent =
        typeof evm.CV === 'number'
          ? evm.CV.toLocaleString()
          : '‚Äî';
    }

    if (svEl) {
      svEl.textContent =
        typeof evm.SV === 'number'
          ? evm.SV.toLocaleString()
          : '‚Äî';
    }

    console.log('‚úÖ KPIs EVM renderizados correctamente');
  }, 50);
}



function renderEVMForecast(evm) {
  const eacEl = document.getElementById('evmEAC');
  const etcEl = document.getElementById('evmETC');
  const vacEl = document.getElementById('evmVAC');
  const textEl = document.getElementById('evmForecastText');

  if (!eacEl || !etcEl || !vacEl || !textEl || !evm) return;

  const mode = window.__EVM_MODE__ || 'hours';

  let EAC, ETC, VAC, unit;

  if (mode === 'costs') {
    const forecast = calcularPronosticoCostos(evm);
    EAC = forecast.EAC;
    ETC = forecast.ETC;
    VAC = forecast.VAC;
    unit = '$';
  } else {
    EAC = evm.EAC;
    ETC = evm.ETC;
    VAC = evm.VAC;
    unit = 'h';
  }

  eacEl.textContent = `${unit}${EAC.toFixed(2)}`;
  etcEl.textContent = `${unit}${ETC.toFixed(2)}`;
  vacEl.textContent = `${unit}${VAC.toFixed(2)}`;

  textEl.textContent =
    VAC < 0
      ? mode === 'costs'
        ? 'El proyecto presenta riesgo de sobrecosto. Se recomienda controlar gastos.'
        : 'El proyecto presenta riesgo de sobreconsumo de horas.'
      : 'El proyecto se mantiene dentro del plan.';

  console.log('üîÆ Pron√≥stico EVM renderizado correctamente');
}




(function () {
  const original = window.showEVMForecast;

  window.showEVMForecast = function () {
    console.log('üìà Ejecutando showEVMForecast');

    // ==========================
    // üî• MODO COSTOS
    // ==========================
    if (window.__EVM_MODE__ === 'costs') {
      const evm = window.lastEVMPreviewData;
      if (!evm || !evm.CPI || !evm.BAC) {
        console.warn('‚ö†Ô∏è EVM de COSTOS no disponible');
        return;
      }

      const EAC = evm.BAC / evm.CPI;
      const ETC = EAC - evm.AC;
      const VAC = evm.BAC - EAC;

      document.getElementById('eacValue').textContent = `$${EAC.toFixed(2)}`;
      document.getElementById('etcValue').textContent = `$${ETC.toFixed(2)}`;
      document.getElementById('vacValue').textContent =
        `${VAC >= 0 ? '+' : '-'}$${Math.abs(VAC).toFixed(2)}`;

      document.getElementById('forecastNarrative').textContent =
        VAC < 0
          ? 'El proyecto presenta riesgo de sobrecosto.'
          : 'El proyecto se mantiene dentro del presupuesto.';

      console.log('‚úÖ Pron√≥stico EVM de COSTOS renderizado');
      return;
    }

    // ==========================
    // ‚è±Ô∏è MODO HORAS (REAL)
    // ==========================
    return original?.apply(this, arguments);
  };
})();




// üîÅ Exponer funci√≥n para el bot√≥n HTML
window.openEVMDashboard = function () {
  console.log('üß≠ openEVMDashboard llamado');

  // üîÑ FORZAR MODO REAL (HORAS)
  window.__EVM_MODE__ = 'real';

  console.log('üìå Modo EVM forzado a:', window.__EVM_MODE__);

  if (typeof window.crearDashboardEVMCompleto === 'function') {
    console.log('‚è±Ô∏è Abriendo Dashboard EVM REAL (horas)');
    return window.crearDashboardEVMCompleto();
  }

  console.error('‚ùå crearDashboardEVMCompleto no existe');
};



// üîÅ REPARAR BOT√ìN "VALOR GANADO / EVM DASHBOARD"
window.openEVMDashboard = function () {
  console.log('üß≠ openEVMDashboard llamado ‚Üí FORZANDO HORAS');

  // ‚úÖ FORZAR SIEMPRE MODO HORAS
  window.__EVM_MODE__ = 'hours';

  if (typeof window.crearDashboardEVMCompleto === 'function') {
    console.log('‚è±Ô∏è Abriendo Dashboard EVM REAL (horas)');
    return window.crearDashboardEVMCompleto();
  }

  console.error('‚ùå No se encontr√≥ funci√≥n v√°lida para abrir Dashboard EVM');
};




window.forceCloseAllEVMModals = function () {
  console.log('üßπ Forzando cierre total de modales EVM');

  // 1Ô∏è‚É£ Cerrar modal EVM si existe
  if (typeof window.closeEVMModal === 'function') {
    window.closeEVMModal();
  }

  // 2Ô∏è‚É£ Ocultar cualquier modal visible relacionado a EVM / Costos
  document.querySelectorAll(
    '.modal, .evm-modal, .cost-modal, .overlay, .modal-backdrop'
  ).forEach(el => {
    el.style.display = 'none';
    el.classList.remove('show', 'active');
  });

  // 3Ô∏è‚É£ Eliminar backdrops hu√©rfanos
  document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());

  // 4Ô∏è‚É£ Restaurar el body
  document.body.classList.remove('modal-open');
  document.body.style.overflow = 'auto';
  document.body.style.paddingRight = '';

  console.log('‚úÖ Limpieza de modales EVM completada');
};



function ensureEVMDashboardOnTop() {
  const dashboard = document.getElementById('evmDashboard');
  if (!dashboard) return;

  if (dashboard.parentElement !== document.body) {
    console.warn('üß± Moviendo Dashboard EVM fuera del modal');
    document.body.appendChild(dashboard);
  }

  dashboard.style.position = 'relative';
  dashboard.style.zIndex = '9999';
}




window.closeEVMPreviewOverlay = function () {
  const preview = document.getElementById('evmPreviewOverlay');

  if (!preview) {
    console.log('‚ÑπÔ∏è No hay previsualizaci√≥n EVM activa');
    return;
  }

  console.log('üîí Cerrando previsualizaci√≥n EVM');
  preview.remove();

  document.body.classList.remove('modal-open');
  document.body.style.overflow = 'auto';
};



window.closeAllEVMOverlays = function () {
  console.log('üßπ Cerrando overlays EVM (preview + costos)');

  // üîπ 1. Previsualizaci√≥n EVM
  const preview = document.getElementById('evmPreviewOverlay');
  if (preview) {
    console.log('üîí Cerrando previsualizaci√≥n EVM');
    preview.remove();
  }

  // üîπ 2. Configuraci√≥n de costos EVM
  document.querySelectorAll(
    '#costConfigurationModal, .cost-modal, .cost-config-modal'
  ).forEach(modal => {
    console.log('üîí Cerrando configuraci√≥n de costos EVM');
    modal.style.display = 'none';
    modal.classList.remove('show', 'active');
  });

  // üîπ 3. Backdrops hu√©rfanos
  document.querySelectorAll('.modal-backdrop, .overlay').forEach(el => el.remove());

  // üîπ 4. Restaurar body
  document.body.classList.remove('modal-open');
  document.body.style.overflow = 'auto';
  document.body.style.paddingRight = '';

  console.log('‚úÖ Overlays EVM cerrados correctamente');
};



window.closeCostConfigurationPanel = function () {
  console.log('üîí Cerrando panel de CONFIGURACI√ìN DE COSTOS EVM');

  const panel = document.querySelector(
    '[style*="rgba(239, 68, 68"]'
  );

  if (panel) {
    panel.style.display = 'none';
  }

  document.body.classList.remove('modal-open');
  document.body.style.overflow = 'auto';
};



// ==================== BOT√ìN VISTA AMPLIADA ====================
// Agregar despu√©s de todas tus funciones existentes

function addViewToggleButton() {
    // Solo ejecutar si el Gantt est√° abierto
    const gantt = document.getElementById('premiumExecutiveGantt');
    if (!gantt) return;
    
    // Buscar contenedor de botones en el header
    const headerButtons = gantt.querySelector('div[style*="background: linear-gradient(90deg"]')?.lastElementChild;
    if (!headerButtons) return;
    
    // Evitar duplicados
    if (document.getElementById('viewToggleBtn')) return;
    
    const toggleBtn = document.createElement('button');
    toggleBtn.id = 'viewToggleBtn';
    toggleBtn.innerHTML = 'üîç Vista Ampliada';
    toggleBtn.style.cssText = `
        background: linear-gradient(45deg, #1abc9c, #16a085);
        border: none;
        color: white;
        padding: 10px 18px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
        margin-left: 10px;
    `;
    
    let isExpanded = false;
    const originalState = {};
    
    toggleBtn.onclick = function(e) {
        e.stopPropagation();
        
        const gantt = document.getElementById('premiumExecutiveGantt');
        if (!gantt) return;
        
        if (!isExpanded) {
            // Guardar estado original
            originalState.width = gantt.style.width;
            originalState.height = gantt.style.height;
            originalState.top = gantt.style.top;
            originalState.left = gantt.style.left;
            originalState.transform = gantt.style.transform;
            originalState.borderRadius = gantt.style.borderRadius;
            
            // Expandir
            gantt.style.width = '98vw';
            gantt.style.height = '96vh';
            gantt.style.top = '10px';
            gantt.style.left = '10px';
            gantt.style.transform = 'none';
            gantt.style.borderRadius = '12px';
            
            toggleBtn.innerHTML = 'üì± Vista Normal';
            toggleBtn.style.background = 'linear-gradient(45deg, #f39c12, #d35400)';
            
            isExpanded = true;
        } else {
            // Restaurar
            gantt.style.width = originalState.width || '95vw';
            gantt.style.height = originalState.height || '90vh';
            gantt.style.top = originalState.top || '50%';
            gantt.style.left = originalState.left || '50%';
            gantt.style.transform = originalState.transform || 'translate(-50%, -50%)';
            gantt.style.borderRadius = originalState.borderRadius || '24px';
            
            toggleBtn.innerHTML = 'üîç Vista Ampliada';
            toggleBtn.style.background = 'linear-gradient(45deg, #1abc9c, #16a085)';
            
            isExpanded = false;
        }
        
        // Redimensionar gr√°ficos
        setTimeout(() => {
            if (window.burndownChartInstance) window.burndownChartInstance.resize();
            if (window.evmChartInstance) window.evmChartInstance.resize();
        }, 50);
    };
    
    // Agregar al header
    headerButtons.appendChild(toggleBtn);
}

// Ejecutar cuando se crea el Gantt
// Busca en tu c√≥digo donde se llama a createCompleteGanttForCurrentProject()
// y despu√©s de esa llamada, agrega: setTimeout(addViewToggleButton, 500);









// ========== FUNCI√ìN PARA VOLVER AL DASHBOARD ==========
window.goBackToDashboard = function() {
    console.log('üîô Volviendo al dashboard...');
    
    // 1. Eliminar el Gantt ejecutivo si existe
    const gantt = document.getElementById('premiumExecutiveGantt');
    if (gantt) {
        gantt.remove();
        console.log('‚úÖ Gantt ejecutivo removido');
    }
    
    // 2. Eliminar cualquier overlay/backdrop
    const overlay = document.querySelector('.executive-overlay');
    if (overlay) {
        overlay.remove();
        console.log('‚úÖ Overlay removido');
    }
    
    // 3. Mostrar la vista principal (dashboard o Kanban)
    const mainView = document.getElementById('dashboardView') || 
                     document.getElementById('kanbanView') ||
                     document.querySelector('.main-container');
    
    if (mainView) {
        mainView.style.display = 'block';
        console.log('‚úÖ Vista principal mostrada');
    }
    
    // 4. Si tienes funci√≥n espec√≠fica para mostrar dashboard, ejecutarla
    if (typeof showDashboard === 'function') {
        showDashboard();
    } else if (typeof showKanbanView === 'function') {
        showKanbanView();
    } else if (typeof renderKanbanTasks === 'function') {
        renderKanbanTasks();
    }
    
    // 5. Forzar scroll al inicio
    window.scrollTo(0, 0);
};






/***************************************************************
 * GANTT VISTA COMPLETA - VERSI√ìN CONFIRMADA FUNCIONAL
 ***************************************************************/

// 1. REEMPLAZAR showExecutiveGantt con timing correcto
if (window.showExecutiveGantt) {
    const originalGanttFunction = window.showExecutiveGantt;
    
    window.showExecutiveGantt = function() {
        console.log('üé¨ [VISTA COMPLETA] Iniciando Gantt...');
        
        // Ocultar boardView inmediatamente
        const boardView = document.getElementById('boardView');
        if (boardView) {
            boardView.style.display = 'none';
            console.log('‚úÖ boardView ocultado');
        }
        
        // Ocultar otras vistas
        ['listView', 'calendarView', 'dashboardView', 'tasksView'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
        });
        
        // Limpiar Gantt anterior
        const oldGantt = document.getElementById('premiumExecutiveGantt');
        if (oldGantt) oldGantt.remove();
        
        // Ejecutar funci√≥n original
        originalGanttFunction();
        
        // üî•üî•üî• ESTA ES LA CLAVE: Esperar a que el Gantt est√© COMPLETAMENTE creado
        setTimeout(applyFullViewStyles, 300); // 300ms para asegurar
    };
}

// üö¶ Bandera global para evitar bucles durante refrescos
let isRefreshingGantt = false;

// 2. FUNCI√ìN QUE APLICA LOS ESTILOS CORRECTOS (versi√≥n segura)
function applyFullViewStyles() {
    // üîí Si estamos en medio de un refresh, NO hacer nada
    if (isRefreshingGantt) {
        return;
    }

    console.log('üé® Aplicando estilos de vista completa al Gantt...');
    
    const gantt = document.getElementById('premiumExecutiveGantt');
    if (!gantt) {
        console.warn('‚ö†Ô∏è Gantt no encontrado, reintentando una vez...');
        // ‚úÖ Solo un reintento controlado, NO bucle infinito
        setTimeout(() => {
            const retryGantt = document.getElementById('premiumExecutiveGantt');
            if (retryGantt && !isRefreshingGantt) {
                applyFullViewStyles();
            }
        }, 150);
        return;
    }
    
    // ESTILOS PARA VISTA COMPLETA
    gantt.style.position = 'fixed';
    gantt.style.top = '0';
    gantt.style.left = '0';
    gantt.style.width = '100vw';
    gantt.style.height = '100vh';
    gantt.style.margin = '0';
    gantt.style.padding = '0';
    gantt.style.borderRadius = '0';
    gantt.style.transform = 'none';
    gantt.style.zIndex = '99999';
    gantt.style.boxShadow = 'none';
    
    // Ocultar scroll del body
    document.body.style.overflow = 'hidden';
    document.documentElement.style.overflow = 'hidden';
    
    // Forzar redibujado
    gantt.offsetHeight;
    
    console.log('‚úÖ‚úÖ‚úÖ GANTT CONFIGURADO COMO VISTA COMPLETA');
}

// üëÅÔ∏è OBSERVER que detecta creaci√≥n del Gantt ‚Äî ¬°solo act√∫a si NO hay refresh en curso!
const ganttObserver = new MutationObserver(function(mutations) {
    if (isRefreshingGantt) return; // üîí ignorar durante refresh

    mutations.forEach(function(mutation) {
        if (mutation.addedNodes) {
            mutation.addedNodes.forEach(function(node) {
                if (node.id === 'premiumExecutiveGantt' || 
                    (node.querySelector && node.querySelector('#premiumExecutiveGantt'))) {
                    
                    console.log('üëÄ Observer detect√≥ creaci√≥n de Gantt');
                    // Aplicar estilos solo si no estamos refrescando
                    if (!isRefreshingGantt) {
                        setTimeout(applyFullViewStyles, 200);
                    }
                }
            });
        }
    });
});

ganttObserver.observe(document.body, { childList: true, subtree: true });


// Iniciar observer
ganttObserver.observe(document.body, { childList: true, subtree: true });



// Observer para bot√≥n del Gantt
const buttonObserver = new MutationObserver(function() {
    if (document.getElementById('premiumExecutiveGantt')) {
        setTimeout(updateGanttCloseButton, 300);
    }
});

buttonObserver.observe(document.body, { childList: true, subtree: true });

console.log('üéØ SISTEMA GANTT-VISTA COMPLETA CARGADO (VERSI√ìN FUNCIONAL)');
console.log('üìå Usa: showView("gantt") para abrir');
console.log('üìå Usa: showView("board") para volver');





// ==================== VENTANA COMPLETA PREMIUM - CON VALORES REALES PRECISOS ====================

// ==================== FUNCIONES DE C√ÅLCULO REAL - PRECISAS ====================
function getEVMMetricsFromSystem(tasks) {
    console.log('üîç Calculando m√©tricas EVM PRECISAS del sistema...');
    
    // M√âTODO SIMPLE Y DIRECTO - CON REGLAS CLARAS
    let totalPV = 0;
    let totalEV = 0; 
    let totalAC = 0;
    
    console.log('üìä C√ÅLCULO EVM CON REGLAS:');
    console.log('‚Ä¢ "pending" ‚Üí progress = 0%, timeLogged = 0h');
    console.log('‚Ä¢ "completed" ‚Üí progress = 100%');
    console.log('‚Ä¢ "inProgress" ‚Üí progress = valor real');
    
    tasks.forEach((task, index) => {
        // 1. PV = estimatedTime (siempre)
        const pv = task.estimatedTime || 0;
        
        // 2. EV = estimatedTime √ó progreso_ajustado
        let progress = task.progress || 0;
        let status = (task.status || '').toLowerCase();
        
        // APLICAR REGLAS
        if (status.includes('pending') || status.includes('pendiente')) {
            progress = 0; // Pendiente SIEMPRE es 0%
        } else if (status.includes('completed') || status.includes('completada') || progress === 100) {
            progress = 100; // Completada SIEMPRE es 100%
        }
        // inProgress mantiene su progress real
        
        const ev = pv * (progress / 100);
        
        // 3. AC = timeLogged_ajustado
        let ac = task.timeLogged || 0;
        if (status.includes('pending') || status.includes('pendiente')) {
            ac = 0; // Pendiente SIEMPRE tiene 0 horas registradas
        }
        
        totalPV += pv;
        totalEV += ev;
        totalAC += ac;
        
        console.log(`Tarea ${index+1}: "${task.name}" (${status})`);
        console.log(`  PV: ${pv}h, Progreso: ${task.progress}% ‚Üí ${progress}%, EV: ${ev.toFixed(2)}h`);
        console.log(`  timeLogged: ${task.timeLogged || 0}h ‚Üí ${ac}h, AC: ${ac}h`);
    });
    
    console.log('üìà TOTALES:');
    console.log(`PV = ${totalPV}h`);
    console.log(`EV = ${totalEV.toFixed(2)}h`);
    console.log(`AC = ${totalAC}h`);
    console.log(`CPI = ${(totalEV/totalAC).toFixed(3)}, SPI = ${(totalEV/totalPV).toFixed(3)}`);
    
    // F√ìRMULAS EVM
    const pv = totalPV;
    const ev = totalEV;
    const ac = totalAC > 0 ? totalAC : ev * 1.08;
    
    const cpi = ac > 0 ? ev / ac : 0;
    const spi = pv > 0 ? ev / pv : 0;
    const bac = totalPV;
    const eac = cpi > 0 ? bac / cpi : bac;
    const etc = eac - ac;
    const vac = bac - eac;
    
    const evmData = {
        pv: parseFloat(pv.toFixed(2)),
        ev: parseFloat(ev.toFixed(2)),
        ac: parseFloat(ac.toFixed(2)),
        bac: parseFloat(bac.toFixed(2)),
        cpi: parseFloat(cpi.toFixed(2)),
        spi: parseFloat(spi.toFixed(2)),
        cv: parseFloat((ev - ac).toFixed(2)),
        sv: parseFloat((ev - pv).toFixed(2)),
        eac: parseFloat(eac.toFixed(2)),
        etc: parseFloat(etc.toFixed(2)),
        vac: parseFloat(vac.toFixed(2))
    };
    
    console.log('‚úÖ EVM CALCULADO:', evmData);
    return evmData;
}

// ==================== BURNDOWN CHART EN HORAS - VERSI√ìN CORREGIDA ====================
function calculateBurndownInHours(tasks) {
    console.log('üìâ Calculando Burndown Chart en HORAS (VERSI√ìN CORREGIDA)...');
    
    // 1. Calcular horas totales estimadas
    const totalHours = tasks.reduce((sum, task) => sum + (task.estimatedTime || 0), 0);
    
    if (totalHours === 0) {
        return {
            semanas: [1, 2, 3, 4],
            trabajoIdeal: [0, 0, 0, 0, 0],
            trabajoReal: [0, 0, 0, 0, 0],
            totalHoras: 0,
            horasCompletadas: 0,
            horasRestantes: 0
        };
    }
    
    // 2. Horas COMPLETADAS (solo tareas 100% terminadas)
    const horasCompletadas = tasks.reduce((sum, task) => {
        const status = (task.status || '').toLowerCase();
        const progress = task.progress || 0;
        const estimatedTime = task.estimatedTime || 0;
        
        if (status.includes('completed') || progress === 100) {
            return sum + estimatedTime;
        }
        return sum;
    }, 0);
    
    const horasRestantes = Math.max(0, totalHours - horasCompletadas);
    
    console.log('üìä DATOS CALCULADOS:');
    console.log(`‚Ä¢ Horas totales: ${totalHours}h`);
    console.log(`‚Ä¢ Horas COMPLETADAS (100%): ${horasCompletadas}h`);
    console.log(`‚Ä¢ Horas RESTANTES: ${horasRestantes}h`);
    
    // 3. Timeline de 4 semanas (5 puntos: Inicio + 4 semanas)
    const semanas = [1, 2, 3, 4];
    const totalSemanas = semanas.length;
    
    // 4. L√≠nea IDEAL (burndown lineal perfecto)
    const trabajoIdeal = [];
    for (let i = 0; i <= totalSemanas; i++) {
        const idealHours = Math.max(0, totalHours - (totalHours / totalSemanas) * i);
        trabajoIdeal.push(idealHours);
    }
    
    // 5. L√≠nea REAL - F√ìRMULA SIMPLE Y CORRECTA
    const trabajoReal = [];
    
    // Punto 0: Inicio del proyecto
    trabajoReal.push(totalHours);
    
    // Si no hay progreso, l√≠nea plana
    if (horasCompletadas === 0) {
        trabajoReal.push(totalHours); // Semana 1
        trabajoReal.push(totalHours); // Semana 2
        trabajoReal.push(totalHours); // Semana 3
    } else {
        // Distribuir progreso de forma PROPORCIONAL
        const porcentajeCompletado = horasCompletadas / totalHours;
        
        // Semana 1: 25% del progreso total
        const progresoSemana1 = porcentajeCompletado * 0.25;
        trabajoReal.push(totalHours - (horasCompletadas * progresoSemana1));
        
        // Semana 2: 50% del progreso total
        const progresoSemana2 = porcentajeCompletado * 0.50;
        trabajoReal.push(totalHours - (horasCompletadas * progresoSemana2));
        
        // Semana 3: 75% del progreso total
        const progresoSemana3 = porcentajeCompletado * 0.75;
        trabajoReal.push(totalHours - (horasCompletadas * progresoSemana3));
    }
    
    // Punto final: Semana 4 (horas realmente restantes)
    trabajoReal.push(horasRestantes);
    
    // 6. Validar que NUNCA haya ceros (excepto si todo est√° completado)
    for (let i = 0; i < trabajoReal.length; i++) {
        if (trabajoReal[i] < 0.1 && horasRestantes > 0) {
            console.warn(`‚ö†Ô∏è Ajustando valor inv√°lido en punto ${i}: ${trabajoReal[i]} ‚Üí 0.1`);
            trabajoReal[i] = 0.1;
        }
    }
    
    console.log('üìà L√çNEA REAL CALCULADA:');
    console.log(`‚Ä¢ 5 puntos: ${trabajoReal.map(h => h.toFixed(1) + 'h').join(' ‚Üí ')}`);
    console.log(`‚Ä¢ Etiquetas: Inicio, Semana 1, Semana 2, Semana 3, Semana 4`);
    
    return {
        semanas: semanas,
        trabajoIdeal: trabajoIdeal,
        trabajoReal: trabajoReal,
        totalHoras: totalHours,
        horasCompletadas: horasCompletadas,
        horasRestantes: horasRestantes
    };
}

function calculateRealTaskDistribution(tasks) {
    console.log('üîç Analizando distribuci√≥n PRECISA de tareas...');
    
    const distribution = {
        completadas: 0,
        enProgreso: 0,
        pendientes: 0,
        atrasadas: 0
    };
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    tasks.forEach((task, index) => {
        const status = task.status || 'pending';
        const progress = task.progress || 0;
        
        // VERIFICAR SI EST√Å ATRASADA
        let isOverdue = false;
        if (task.deadline) {
            try {
                const deadline = new Date(task.deadline);
                deadline.setHours(0, 0, 0, 0);
                if (deadline < today && status !== 'completed') {
                    isOverdue = true;
                }
            } catch (e) {
                console.warn(`‚ö†Ô∏è Error parseando deadline de tarea ${index + 1}:`, e);
            }
        }
        
        // CLASIFICACI√ìN PRECISA - CON L√ìGICA MEJORADA
        if (status === 'completed' || progress === 100) {
            distribution.completadas++;
            console.log(`  ‚úÖ Tarea ${index + 1}: "${task.name}" - COMPLETADA (status: ${status}, progress: ${progress}%)`);
        } 
        else if (isOverdue || status === 'overdue') {
            distribution.atrasadas++;
            console.log(`  ‚ö†Ô∏è Tarea ${index + 1}: "${task.name}" - ATRASADA`);
        }
        else if (status === 'inProgress' || status === 'en progreso' || (progress > 0 && progress < 100)) {
            distribution.enProgreso++;
            console.log(`  üîÑ Tarea ${index + 1}: "${task.name}" - EN PROGRESO (${progress}%)`);
        }
        else if (status === 'pending' || status === 'Pendiente' || progress === 0) {
            distribution.pendientes++;
            console.log(`  ‚è≥ Tarea ${index + 1}: "${task.name}" - PENDIENTE (progress: ${progress}%)`);
        }
        else {
            // Status desconocido
            if (progress > 0 && progress < 100) {
                distribution.enProgreso++;
                console.log(`  üîÑ Tarea ${index + 1}: "${task.name}" - EN PROGRESO (status desconocido: ${status}, progress: ${progress}%)`);
            } else {
                distribution.pendientes++;
                console.log(`  ‚è≥ Tarea ${index + 1}: "${task.name}" - PENDIENTE (status desconocido: ${status})`);
            }
        }
    });
    
    console.log('üìà Distribuci√≥n PRECISA calculada:', distribution);
    
    // Validaci√≥n
    const total = Object.values(distribution).reduce((a, b) => a + b, 0);
    if (total !== tasks.length) {
        console.warn(`‚ö†Ô∏è Discrepancia: distribuci√≥n ${total} vs tareas ${tasks.length}`);
        // Ajustar autom√°ticamente
        const diff = tasks.length - total;
        if (diff > 0) {
            distribution.pendientes += diff;
            console.log(`  üîß Ajustado: +${diff} tareas a pendientes`);
        }
    }
    
    return distribution;
}

// ==================== FUNCI√ìN CORREGIDA - PROGRESO PONDERADO POR HORAS ====================
function calculateAverageProgress(tasks) {
    if (!tasks || tasks.length === 0) return 0;
    
    // M√©todo CORRECTO: Progreso ponderado por horas estimadas
    let totalWeightedProgress = 0;
    let totalEstimatedHours = 0;
    
    tasks.forEach(task => {
        const estimatedTime = task.estimatedTime || 0;
        let progress = task.progress || 0;
        const status = (task.status || '').toLowerCase();
        
        // Aplicar las mismas reglas que en getEVMMetricsFromSystem
        if (status.includes('pending') || status.includes('pendiente')) {
            progress = 0;
        } else if (status.includes('completed') || status.includes('completada') || progress === 100) {
            progress = 100;
        }
        
        totalWeightedProgress += estimatedTime * (progress / 100);
        totalEstimatedHours += estimatedTime;
    });
    
    if (totalEstimatedHours === 0) return 0;
    
    const averageProgress = Math.round((totalWeightedProgress / totalEstimatedHours) * 100);
    console.log(`üìä Progreso ponderado calculado: ${averageProgress}% (${totalWeightedProgress.toFixed(2)}h / ${totalEstimatedHours}h)`);
    
    return averageProgress;
}

function calculateTotalEstimatedTime(tasks) {
    return tasks.reduce((total, task) => total + (task.estimatedTime || 0), 0);
}

function calculateTotalTimeLogged(tasks) {
    return tasks.reduce((total, task) => total + (task.timeLogged || 0), 0);
}

// ==================== BOT√ìN VENTANA PREMIUM ====================
function addPremiumFullscreenButton() {
    const gantt = document.getElementById('premiumExecutiveGantt');
    if (!gantt) {
        console.log('‚è≥ Gantt no encontrado');
        return false;
    }
    
    const headerButtons = gantt.querySelector('div[style*="background: linear-gradient(90deg"]')?.lastElementChild;
    if (!headerButtons) {
        console.error('‚ùå No se encontr√≥ contenedor de botones');
        return false;
    }
    
    if (document.getElementById('premiumFullscreenBtn')) {
        return true;
    }
    
    console.log('üéØ Agregando bot√≥n de Vista Premium...');
    
    const premiumBtn = document.createElement('button');
    premiumBtn.id = 'premiumFullscreenBtn';
    premiumBtn.innerHTML = 'üöÄ Vista Premium';
    premiumBtn.style.cssText = `
        background: linear-gradient(45deg, #8b5cf6, #6d28d9);
        border: none;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
        margin-left: 10px;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    `;
    
    premiumBtn.onmouseover = function() {
        this.style.transform = 'translateY(-2px)';
        this.style.boxShadow = '0 8px 20px rgba(139, 92, 246, 0.4)';
    };
    
    premiumBtn.onmouseout = function() {
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = '0 4px 12px rgba(139, 92, 246, 0.3)';
    };
    
    premiumBtn.onclick = function(e) {
        e.stopPropagation();
        
        console.log('üöÄ PREPARANDO VISTA PREMIUM CON DATOS PRECISOS...');
        
        const gantt = document.getElementById('premiumExecutiveGantt');
        const projectName = gantt.dataset.projectName || 'Proyecto';
        const projectIndex = parseInt(gantt.dataset.projectIndex) || 0;
        const tasksData = gantt.dataset.tasks || '[]';
        
        let tasks = JSON.parse(tasksData);
        
        if (tasks.length === 0) {
            alert('‚ö†Ô∏è No hay tareas en este proyecto');
            return;
        }
        
        console.log(`üìã Proyecto: ${projectName}, Tareas: ${tasks.length}`);
        
        // 1. BURNDOWN EN HORAS (VERSI√ìN CORREGIDA)
        let burndownData = calculateBurndownInHours(tasks);
        
        // 2. EVM PRECISO
        const evmData = getEVMMetricsFromSystem(tasks);
        
        // 3. DISTRIBUCI√ìN PRECISA
        const taskDistribution = calculateRealTaskDistribution(tasks);
        
        // 4. KPIs PRECISOS CON PROGRESO PONDERADO CORRECTO
        const totalTasks = tasks.length;
        const completedTasks = taskDistribution.completadas;
        const averageProgress = calculateAverageProgress(tasks); // ¬°CORREGIDO!
        const lateTasks = taskDistribution.atrasadas;
        const totalEstimatedTime = calculateTotalEstimatedTime(tasks);
        const totalTimeLogged = calculateTotalTimeLogged(tasks);
        
        const kpis = {
            totalTasks,
            completedTasks,
            averageProgress,
            lateTasks,
            totalEstimatedTime,
            totalTimeLogged
        };
        
        console.log('üìä RESUMEN FINAL:', {
            proyecto: projectName,
            tareas: totalTasks,
            horasTotales: totalEstimatedTime,
            horasRegistradas: totalTimeLogged,
            progresoPonderado: averageProgress + '%',
            distribucion: taskDistribution,
            evm: evmData,
            burndown: burndownData,
            kpis: kpis
        });
        
        // 5. GENERAR HTML
        const htmlContent = generatePremiumDashboardHTML(
            projectName, 
            projectIndex, 
            tasks,
            burndownData,
            evmData,
            taskDistribution,
            kpis
        );
        
        openPremiumWindow(htmlContent, projectName);
    };
    
    const closeBtn = Array.from(headerButtons.children).find(btn => 
        btn.textContent.includes('Cerrar') || btn.textContent.includes('√ó')
    );
    
    if (closeBtn) {
        headerButtons.insertBefore(premiumBtn, closeBtn);
    } else {
        headerButtons.appendChild(premiumBtn);
    }
    
    console.log('‚úÖ Bot√≥n premium agregado');
    return true;
}

// ==================== SISTEMA DE ACTUALIZACI√ìN AUTOM√ÅTICA ====================
let autoRefreshInterval = null;
let currentPremiumWindow = null;
let lastTaskData = null;
let refreshCount = 0;

// Nueva funci√≥n para configurar comunicaci√≥n entre ventanas
function setupWindowCommunication() {
    console.log('üîó Configurando comunicaci√≥n entre ventanas...');
    
    // Escuchar mensajes de la ventana premium
    window.addEventListener('message', function(event) {
        console.log('üì® Mensaje recibido:', event.data);
        
        if (event.data.type === 'PREMIUM_WINDOW_READY') {
            console.log('‚úÖ Ventana premium lista para comunicaci√≥n');
            currentPremiumWindow = event.source;
            
            // Enviar datos iniciales
            sendDataToPremiumWindow();
            
            // Configurar actualizaci√≥n autom√°tica si est√° habilitada
            if (window.autoRefreshEnabled) {
                startAutoRefresh();
            }
        }
        
        if (event.data.type === 'PREMIUM_WINDOW_CLOSED') {
            console.log('üö™ Ventana premium cerrada');
            currentPremiumWindow = null;
            stopAutoRefresh();
        }
        
        if (event.data.type === 'PREMIUM_REFRESH_REQUEST') {
            console.log('üîÑ Solicitud de actualizaci√≥n desde ventana premium');
            sendDataToPremiumWindow();
        }
        
        if (event.data.type === 'PREMIUM_TOGGLE_AUTO_REFRESH') {
            const enabled = event.data.enabled;
            window.autoRefreshEnabled = enabled;
            console.log(`üîÑ Actualizaci√≥n autom√°tica ${enabled ? 'activada' : 'desactivada'}`);
            
            if (enabled) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        }
    });
}

// Funci√≥n para enviar datos actualizados a la ventana premium
function sendDataToPremiumWindow() {
    if (!currentPremiumWindow) {
        console.log('‚ùå No hay ventana premium activa');
        return;
    }
    
    try {
        const gantt = document.getElementById('premiumExecutiveGantt');
        if (!gantt) {
            console.error('‚ùå Gantt no encontrado');
            return;
        }
        
        const projectName = gantt.dataset.projectName || 'Proyecto';
        const projectIndex = parseInt(gantt.dataset.projectIndex) || 0;
        const tasksData = gantt.dataset.tasks || '[]';
        const tasks = JSON.parse(tasksData);
        
        // Verificar si los datos han cambiado
        const currentTaskData = JSON.stringify(tasks);
        if (currentTaskData === lastTaskData) {
            console.log('üìä Datos sin cambios, omitiendo actualizaci√≥n');
            return;
        }
        
        lastTaskData = currentTaskData;
        refreshCount++;
        
        console.log(`üîÑ Actualizando ventana premium (#${refreshCount})...`);
        
        // Calcular datos actualizados
        const burndownData = calculateBurndownInHours(tasks);
        const evmData = getEVMMetricsFromSystem(tasks);
        const taskDistribution = calculateRealTaskDistribution(tasks);
        
        const totalTasks = tasks.length;
        const averageProgress = calculateAverageProgress(tasks); // ¬°CORREGIDO!
        const totalEstimatedTime = calculateTotalEstimatedTime(tasks);
        const totalTimeLogged = calculateTotalTimeLogged(tasks);
        
        const kpis = {
            totalTasks,
            completedTasks: taskDistribution.completadas,
            averageProgress,
            lateTasks: taskDistribution.atrasadas,
            totalEstimatedTime,
            totalTimeLogged
        };
        
        // Preparar datos para enviar
        const updateData = {
            type: 'DATA_UPDATE',
            data: {
                projectName,
                projectIndex,
                tasks,
                burndown: burndownData,
                evm: evmData,
                distribution: taskDistribution,
                kpis,
                timestamp: new Date().toISOString(),
                refreshCount: refreshCount
            }
        };
        
        // Enviar datos a la ventana premium
        currentPremiumWindow.postMessage(updateData, '*');
        console.log('‚úÖ Datos actualizados enviados a ventana premium');
        
    } catch (error) {
        console.error('‚ùå Error actualizando ventana premium:', error);
    }
}

// Funci√≥n para iniciar actualizaci√≥n autom√°tica
function startAutoRefresh(interval = 30000) { // 30 segundos por defecto
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    
    console.log(`‚è±Ô∏è Iniciando actualizaci√≥n autom√°tica cada ${interval/1000} segundos`);
    autoRefreshInterval = setInterval(sendDataToPremiumWindow, interval);
    
    // Notificar a la ventana premium
    if (currentPremiumWindow) {
        currentPremiumWindow.postMessage({
            type: 'AUTO_REFRESH_STATUS',
            enabled: true,
            interval: interval
        }, '*');
    }
}

// Funci√≥n para detener actualizaci√≥n autom√°tica
function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        console.log('‚èπÔ∏è Actualizaci√≥n autom√°tica detenida');
        
        // Notificar a la ventana premium
        if (currentPremiumWindow) {
            currentPremiumWindow.postMessage({
                type: 'AUTO_REFRESH_STATUS',
                enabled: false
            }, '*');
            }
        }
    }

// ==================== GENERAR HTML CON ACTUALIZACI√ìN AUTOM√ÅTICA ====================
function generatePremiumDashboardHTML(projectName, projectIndex, tasks, burndownData, evmData, taskDistribution, kpis) {
    // Calcular porcentajes
    const totalDist = taskDistribution.completadas + taskDistribution.enProgreso + 
                     taskDistribution.pendientes + taskDistribution.atrasadas;
    
    const percCompletadas = totalDist > 0 ? Math.round((taskDistribution.completadas / totalDist) * 100) : 0;
    const percEnProgreso = totalDist > 0 ? Math.round((taskDistribution.enProgreso / totalDist) * 100) : 0;
    const percPendientes = totalDist > 0 ? Math.round((taskDistribution.pendientes / totalDist) * 100) : 0;
    const percAtrasadas = totalDist > 0 ? Math.round((taskDistribution.atrasadas / totalDist) * 100) : 0;
    
    // Generar recomendaciones
    const recommendations = generateRealRecommendations(evmData, taskDistribution, kpis);
    
    // Preparar datos JSON
    const tasksJSON = JSON.stringify(tasks || []).replace(/"/g, '\\"');
    const burndownJSON = JSON.stringify(burndownData || {}).replace(/"/g, '\\"');
    const evmJSON = JSON.stringify(evmData || {}).replace(/"/g, '\\"');
    const distributionJSON = JSON.stringify(taskDistribution || {}).replace(/"/g, '\\"');
    const kpisJSON = JSON.stringify(kpis || {}).replace(/"/g, '\\"');
    
    return `<!DOCTYPE html>
<html>
<head>
    <title>üöÄ ${projectName} - Vista Premium</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #0a0a1a;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            overflow: hidden;
            color: white;
        }
        .app-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
            overflow: hidden;
            z-index: 999999;
            display: flex;
            flex-direction: column;
        }
        .app-header {
            background: linear-gradient(90deg, #0a0a1a, #1a1a3a);
            padding: 20px 30px;
            border-bottom: 2px solid rgba(139, 92, 246, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .app-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .app-logo {
            background: linear-gradient(45deg, #8b5cf6, #6d28d9);
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }
        .app-controls {
            display: flex;
            gap: 12px;
        }
        .app-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        .app-btn:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-2px);
        }
        .app-btn-primary {
            background: linear-gradient(45deg, #10b981, #059669);
            border: none;
        }
        .app-btn-danger {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            border: none;
        }
        .app-btn-warning {
            background: linear-gradient(45deg, #f59e0b, #d97706);
            border: none;
        }
        .app-main {
            flex: 1;
            display: flex;
            overflow: hidden;
            padding: 20px;
            gap: 20px;
        }
        .app-sidebar {
            width: 350px;
            background: rgba(26, 31, 60, 0.8);
            border-radius: 16px;
            padding: 25px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
        }
        .sidebar-section {
            margin-bottom: 30px;
        }
        .section-title {
            color: white;
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .dashboard-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 20px;
            overflow-y: auto;
            padding-right: 10px;
        }
        .dashboard-card {
            background: rgba(26, 31, 60, 0.8);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
        }
        .card-large {
            grid-column: span 2;
        }
        .card-title {
            color: white;
            font-size: 18px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chart-container {
            flex: 1;
            position: relative;
        }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        .kpi-card {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .kpi-value {
            color: white;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .kpi-label {
            color: #94a3b8;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .task-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .task-item {
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid;
        }
        .evm-metrics {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .evm-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
        }
        .evm-label {
            color: #94a3b8;
            font-size: 13px;
        }
        .evm-value {
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        .evm-good { color: #10b981 !important; }
        .evm-warning { color: #f59e0b !important; }
        .evm-danger { color: #ef4444 !important; }
        .color-completed { border-left-color: #10b981; }
        .color-inprogress { border-left-color: #3b82f6; }
        .color-pending { border-left-color: #f59e0b; }
        .color-overdue { border-left-color: #ef4444; }
        
        /* Indicador de actualizaci√≥n */
        .refresh-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(139, 92, 246, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .last-update {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(255,255,255,0.05);
            color: #94a3b8;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 11px;
            z-index: 1000000;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.5);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(139, 92, 246, 0.7);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div id="refreshIndicator" class="refresh-indicator" style="display: none;">
            <span class="refresh-emoji">üîÑ</span>
            <span class="refresh-text">Actualizando...</span>
        </div>
        
        <header class="app-header">
            <div class="app-title">
                <div class="app-logo">üöÄ</div>
                <div>
                    <h1 style="margin: 0; color: white; font-size: 24px;">${projectName} - Vista Premium</h1>
                    <p style="margin: 5px 0 0 0; color: #94a3b8; font-size: 14px;">Dashboard ejecutivo ‚Ä¢ Actualizaci√≥n autom√°tica ‚Ä¢ ${new Date().toLocaleString()}</p>
                </div>
            </div>
            <div class="app-controls">
                <button class="app-btn" onclick="refreshDashboard()">üîÑ Actualizar</button>
                <button class="app-btn app-btn-warning" id="autoRefreshToggle" onclick="toggleAutoRefresh()">‚è±Ô∏è Auto: OFF</button>
                <button class="app-btn app-btn-primary" onclick="exportDashboard()">üì• Exportar</button>
                <button class="app-btn app-btn-danger" onclick="closeWindow()">‚úï Cerrar</button>
            </div>
        </header>
        
        <main class="app-main">
            <aside class="app-sidebar">
                <div class="sidebar-section">
                    <h3 class="section-title">üìä KPIs del Proyecto</h3>
                    <div class="kpi-grid">
                        <div class="kpi-card"><div class="kpi-value">${kpis.totalTasks}</div><div class="kpi-label">Tareas</div></div>
                        <div class="kpi-card"><div class="kpi-value">${taskDistribution.completadas}</div><div class="kpi-label">Completadas</div></div>
                        <div class="kpi-card"><div class="kpi-value">${kpis.averageProgress}%</div><div class="kpi-label">Progreso</div></div>
                        <div class="kpi-card"><div class="kpi-value">${taskDistribution.atrasadas}</div><div class="kpi-label">Atrasadas</div></div>
                    </div>
                    <div style="margin-top: 15px; color: #94a3b8; font-size: 11px; text-align: center;">
                        √öltima actualizaci√≥n: <span id="lastUpdateTime">${new Date().toLocaleTimeString()}</span>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h3 class="section-title">üí∞ EVM - VALOR GANADO</h3>
                    <div class="evm-metrics">
                        <div class="evm-metric"><span class="evm-label">PV (Planificado):</span><span class="evm-value ${evmData.pv >= evmData.ev ? 'evm-good' : 'evm-warning'}">${evmData.pv.toFixed(2)}h</span></div>
                        <div class="evm-metric"><span class="evm-label">EV (Ganado):</span><span class="evm-value ${evmData.ev >= evmData.pv ? 'evm-good' : 'evm-warning'}">${evmData.ev.toFixed(2)}h</span></div>
                        <div class="evm-metric"><span class="evm-label">AC (Real):</span><span class="evm-value ${evmData.ac <= evmData.ev ? 'evm-good' : 'evm-danger'}">${evmData.ac.toFixed(2)}h</span></div>
                        <div class="evm-metric"><span class="evm-label">CPI (Costo):</span><span class="evm-value ${evmData.cpi >= 1 ? 'evm-good' : evmData.cpi >= 0.9 ? 'evm-warning' : 'evm-danger'}">${evmData.cpi.toFixed(2)}</span></div>
                        <div class="evm-metric"><span class="evm-label">SPI (Tiempo):</span><span class="evm-value ${evmData.spi >= 1 ? 'evm-good' : evmData.spi >= 0.9 ? 'evm-warning' : 'evm-danger'}">${evmData.spi.toFixed(2)}</span></div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h3 class="section-title">üìà PRON√ìSTICOS</h3>
                    <div class="evm-metrics">
                        <div class="evm-metric"><span class="evm-label">BAC (Presupuesto):</span><span class="evm-value">${evmData.bac.toFixed(2)}h</span></div>
                        <div class="evm-metric"><span class="evm-label">EAC (Estimado):</span><span class="evm-value ${evmData.eac <= evmData.bac ? 'evm-good' : 'evm-danger'}">${evmData.eac.toFixed(2)}h</span></div>
                        <div class="evm-metric"><span class="evm-label">ETC (Faltante):</span><span class="evm-value">${evmData.etc.toFixed(2)}h</span></div>
                        <div class="evm-metric"><span class="evm-label">VAC (Variaci√≥n):</span><span class="evm-value ${evmData.vac >= 0 ? 'evm-good' : 'evm-danger'}">${evmData.vac.toFixed(2)}h</span></div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h3 class="section-title">üìä Distribuci√≥n</h3>
                    <div class="evm-metrics">
                        <div class="evm-metric"><span class="evm-label">Completadas:</span><span class="evm-value evm-good">${taskDistribution.completadas} (${percCompletadas}%)</span></div>
                        <div class="evm-metric"><span class="evm-label">En Progreso:</span><span class="evm-value evm-warning">${taskDistribution.enProgreso} (${percEnProgreso}%)</span></div>
                        <div class="evm-metric"><span class="evm-label">Pendientes:</span><span class="evm-value">${taskDistribution.pendientes} (${percPendientes}%)</span></div>
                        <div class="evm-metric"><span class="evm-label">Atrasadas:</span><span class="evm-value evm-danger">${taskDistribution.atrasadas} (${percAtrasadas}%)</span></div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h3 class="section-title">‚ö° Acciones</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="app-btn" onclick="showBurndownChart()">üìâ Burndown</button>
                        <button class="app-btn" onclick="showEVMAnalysis()">üìà An√°lisis EVM</button>
                        <button class="app-btn" onclick="showTaskDetails()">üìã Detalle Tareas</button>
                        <button class="app-btn" onclick="showRiskAnalysis()">üö® Riesgos</button>
                    </div>
                </div>
            </aside>
            
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3 class="card-title"><span style="color: #f59e0b;">üìâ</span> Burndown Chart (HORAS)</h3>
                    <div class="chart-container"><canvas id="burndownChart"></canvas></div>
                    <div style="margin-top: 10px; color: #94a3b8; font-size: 12px; text-align: center;">
                        Total: ${burndownData.totalHoras.toFixed(1)}h | Completadas: ${burndownData.horasCompletadas.toFixed(1)}h | Restantes: ${burndownData.horasRestantes.toFixed(1)}h
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <h3 class="card-title"><span style="color: #10b981;">üìà</span> Valor Ganado (EVM)</h3>
                    <div class="chart-container"><canvas id="evmChart"></canvas></div>
                </div>
                
                <div class="dashboard-card card-large">
                    <h3 class="card-title"><span style="color: #8b5cf6;">üìä</span> Distribuci√≥n de Tareas</h3>
                    <div style="display: flex; gap: 30px; height: 100%;">
                        <div style="flex: 1;"><div class="chart-container"><canvas id="taskDistributionChart"></canvas></div></div>
                        <div style="width: 300px; overflow-y: auto;">
                            <h4 style="color: white; margin-bottom: 15px; font-size: 14px;">üìã Tareas (${kpis.totalTasks})</h4>
                            <div class="task-list" id="taskList"></div>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-card card-large">
    <h3 class="card-title"><span style="color: #3b82f6;">üè•</span> Salud del Proyecto</h3>
    <div style="display: flex; gap: 20px; height: 100%;">
        <div style="flex: 1.7; min-width: 0;">
            <div class="chart-container" style="min-height: 280px;">
                <canvas id="healthChart"></canvas>
            </div>
        </div>
        <div style="width: 250px; min-width: 250px;">
            <h4 style="color: white; margin-bottom: 15px; font-size: 14px;">üìå An√°lisis</h4>
            <div id="recommendations" style="color: #94a3b8; font-size: 13px; line-height: 1.5; max-height: 260px; overflow-y: auto;">${recommendations}</div>
        </div>
    </div>
</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <div id="lastUpdate" class="last-update">Actualizaciones: <span id="updateCount">0</span></div>
    </div>
    
    <script>
        // DATOS PRECISOS DEL SISTEMA
        let projectData = {
            name: "${projectName}",
            index: ${projectIndex},
            tasks: JSON.parse('${tasksJSON}'),
            burndown: JSON.parse('${burndownJSON}'),
            evm: JSON.parse('${evmJSON}'),
            distribution: JSON.parse('${distributionJSON}'),
            kpis: JSON.parse('${kpisJSON}')
        };
        
        console.log('üì¶ Datos PRECISOS cargados:', projectData);
        
        let chartInstances = { burndown: null, evm: null, taskDistribution: null, health: null };
        let autoRefreshEnabled = false;
        let autoRefreshInterval = null;
        let updateCount = 0;
        
        // Funci√≥n para notificar a la ventana principal que estamos listos
        function notifyParentWindow() {
            try {
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'PREMIUM_WINDOW_READY'
                    }, '*');
                    console.log('üì® Notificado a ventana principal');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è No se pudo notificar a la ventana principal:', error);
            }
        }
        
        // Escuchar mensajes de la ventana principal
        window.addEventListener('message', function(event) {
            console.log('üì® Mensaje recibido de ventana principal:', event.data.type);
            
            if (event.data.type === 'DATA_UPDATE') {
                console.log('üîÑ Recibiendo datos actualizados...');
                showRefreshIndicator();
                
                // Actualizar datos
                projectData = event.data.data;
                updateCount = projectData.refreshCount || updateCount + 1;
                
                // Actualizar UI
                updateDashboard();
                
                // Actualizar contador
                document.getElementById('updateCount').textContent = updateCount;
                document.getElementById('lastUpdateTime').textContent = new Date().toLocaleTimeString();
                
                // Ocultar indicador despu√©s de 2 segundos
                setTimeout(hideRefreshIndicator, 2000);
            }
            
            if (event.data.type === 'AUTO_REFRESH_STATUS') {
                autoRefreshEnabled = event.data.enabled;
                updateAutoRefreshButton();
                
                if (autoRefreshEnabled) {
                    console.log('‚úÖ Actualizaci√≥n autom√°tica activada');
                    showNotification('Actualizaci√≥n autom√°tica activada');
                } else {
                    console.log('‚èπÔ∏è Actualizaci√≥n autom√°tica desactivada');
                    showNotification('Actualizaci√≥n autom√°tica desactivada');
                }
            }
        });
        
        function initDashboard() {
            console.log('üöÄ Iniciando dashboard con actualizaci√≥n autom√°tica...');
            try {
                initBurndownChart();
                initEVMChart();
                initTaskDistributionChart();
                initHealthChart();
                loadTaskList();
                notifyParentWindow();
                
                // Solicitar actualizaci√≥n inicial
                requestRefresh();
                
                console.log('‚úÖ Dashboard listo');
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error: ' + error.message);
            }
        }
        
        function updateDashboard() {
            console.log('üìä Actualizando dashboard con nuevos datos...');
            try {
                // Destruir gr√°ficos existentes
                for (let chart in chartInstances) {
                    if (chartInstances[chart]) {
                        chartInstances[chart].destroy();
                    }
                }
                
                // Recrear gr√°ficos con nuevos datos
                initBurndownChart();
                initEVMChart();
                initTaskDistributionChart();
                initHealthChart();
                loadTaskList();
                
                console.log('‚úÖ Dashboard actualizado');
            } catch (error) {
                console.error('‚ùå Error actualizando dashboard:', error);
            }
        }
        
        function requestRefresh() {
            try {
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'PREMIUM_REFRESH_REQUEST'
                    }, '*');
                    console.log('üì® Solicitando actualizaci√≥n...');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è No se pudo solicitar actualizaci√≥n:', error);
            }
        }
        
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            updateAutoRefreshButton();
            
            try {
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'PREMIUM_TOGGLE_AUTO_REFRESH',
                        enabled: autoRefreshEnabled
                    }, '*');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è No se pudo cambiar auto-refresh:', error);
            }
        }
        
        function updateAutoRefreshButton() {
            const btn = document.getElementById('autoRefreshToggle');
            if (autoRefreshEnabled) {
                btn.innerHTML = '‚è±Ô∏è Auto: ON';
                btn.className = 'app-btn app-btn-primary';
            } else {
                btn.innerHTML = '‚è±Ô∏è Auto: OFF';
                btn.className = 'app-btn app-btn-warning';
            }
        }
        
        function showRefreshIndicator() {
            const indicator = document.getElementById('refreshIndicator');
            indicator.style.display = 'flex';
            
            // Animar el emoji
            const emoji = indicator.querySelector('.refresh-emoji');
            emoji.style.animation = 'spin 1s linear infinite';
            
            // Actualizar texto
            const text = indicator.querySelector('.refresh-text');
            text.textContent = 'Actualizando datos...';
        }
        
        function hideRefreshIndicator() {
            const indicator = document.getElementById('refreshIndicator');
            indicator.style.display = 'none';
        }
        
        function showNotification(message) {
            // Crear notificaci√≥n temporal
            const notification = document.createElement('div');
            notification.className = 'refresh-indicator';
            notification.innerHTML = \`üì¢ \${message}\`;
            document.body.appendChild(notification);
            
            // Remover despu√©s de 3 segundos
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Funciones de gr√°ficos (sin cambios en la l√≥gica, solo nombres)
        function initBurndownChart() {
            try {
                const ctx = document.getElementById('burndownChart').getContext('2d');
                const burndown = projectData.burndown;
                
                if (chartInstances.burndown) chartInstances.burndown.destroy();
                
                chartInstances.burndown = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Inicio', ...burndown.semanas.map(s => 'Sem ' + s)],
                        datasets: [
                            {
                                label: 'L√≠nea Ideal (Burndown)',
                                data: burndown.trabajoIdeal,
                                borderColor: '#10b981',
                                backgroundColor: 'transparent',
                                borderWidth: 3,
                                borderDash: [5, 5],
                                tension: 0.1,
                                pointRadius: 0
                            },
                            {
                                label: 'Progreso Real',
                                data: burndown.trabajoReal,
                                borderColor: '#f59e0b',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.2,
                                pointRadius: 4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'top', 
                                labels: { 
                                    color: '#e2e8f0', 
                                    font: { size: 12 } 
                                } 
                            },
                            tooltip: { 
                                callbacks: { 
                                    label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(1) + ' horas' 
                                } 
                            }
                        },
                        scales: {
                            x: { 
                                grid: { color: 'rgba(255,255,255,0.1)' }, 
                                ticks: { color: '#cbd5e1' } 
                            },
                            y: { 
                                beginAtZero: true,
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                ticks: { 
                                    color: '#cbd5e1', 
                                    callback: v => v.toFixed(0) + 'h' 
                                },
                                title: {
                                    display: true,
                                    text: 'Horas Restantes',
                                    color: '#cbd5e1'
                                }
                            }
                        }
                    }
                });
            } catch (error) { 
                console.error('‚ùå Error Burndown:', error); 
            }
        }
        
        function initEVMChart() {
            try {
                const ctx = document.getElementById('evmChart').getContext('2d');
                const evm = projectData.evm;
                
                if (chartInstances.evm) chartInstances.evm.destroy();
                
                chartInstances.evm = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['PV', 'EV', 'AC'],
                        datasets: [{
                            label: 'M√©tricas EVM (horas)',
                            data: [evm.pv, evm.ev, evm.ac],
                            backgroundColor: [
                                '#1d4ed8',
                                '#059669',
                                evm.ac > evm.ev ? '#dc2626' : 
                                evm.ac < evm.ev ? '#10b981' : 
                                '#f59e0b'
                            ],
                            borderColor: [
                                '#1e40af',
                                '#047857',
                                evm.ac > evm.ev ? '#b91c1c' : 
                                evm.ac < evm.ev ? '#047857' : 
                                '#d97706'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: ctx => {
                                        const labels = { 'PV': 'Valor Planificado', 'EV': 'Valor Ganado', 'AC': 'Costo Real' };
                                        return labels[ctx.label] + ': ' + ctx.parsed.y.toFixed(2) + 'h';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#cbd5e1' } },
                            y: {
                                beginAtZero: true,
                                max: Math.max(evm.pv, evm.ev, evm.ac) * 1.2,
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                ticks: { color: '#cbd5e1', callback: v => v + 'h' },
                                title: {
                                    display: true,
                                    text: 'Horas',
                                    color: '#cbd5e1'
                                }
                            }
                        }
                    }
                });
            } catch (error) { console.error('‚ùå Error EVM:', error); }
        }
        
        function initTaskDistributionChart() {
            try {
                const ctx = document.getElementById('taskDistributionChart').getContext('2d');
                const dist = projectData.distribution;
                const total = dist.completadas + dist.enProgreso + dist.pendientes + dist.atrasadas;
                
                if (chartInstances.taskDistribution) chartInstances.taskDistribution.destroy();
                
                chartInstances.taskDistribution = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Completadas', 'En progreso', 'Pendientes', 'Atrasadas'],
                        datasets: [{
                            data: [dist.completadas, dist.enProgreso, dist.pendientes, dist.atrasadas],
                            backgroundColor: ['#10b981', '#008090', '#f59e0b', '#ef4444'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#e2e8f0', padding: 20, font: { size: 11 } }
                            },
                            tooltip: {
                                callbacks: {
                                    label: ctx => {
                                        const value = ctx.raw || 0;
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return ctx.label + ': ' + value + ' tareas (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) { console.error('‚ùå Error Distribuci√≥n:', error); }
        }
        
        function initHealthChart() {
 console.log('üî• initHealthChart EJECUTADA üî•', new Date().toISOString());
            try {

                const ctx = document.getElementById('healthChart').getContext('2d');
                const evm = projectData.evm;
                const dist = projectData.distribution;
                const kpis = projectData.kpis;
                
                const financialHealth = Math.min(100, Math.max(0, evm.cpi * 100));
                const scheduleHealth = Math.min(100, Math.max(0, evm.spi * 100));
                let costHealth = 100;
                if (evm.bac > 0) {
                    const vacPercentage = Math.abs(evm.vac) / evm.bac * 100;
                    costHealth = Math.max(0, 100 - vacPercentage);
                }
               const progressHealth =
    evm.bac > 0
        ? Number(((evm.ev / evm.bac) * 100).toFixed(1))
        : 0;

                const completionHealth = projectData.tasks.length > 0 ? (dist.completadas / projectData.tasks.length) * 100 : 0;
                
                if (chartInstances.health) chartInstances.health.destroy();
                
                chartInstances.health = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ['Financiera', 'Cronograma', 'Costos', 'Progreso', 'Cumplimiento'],
                        datasets: [{
                            label: 'Salud del Proyecto (%)',
                            data: [financialHealth, scheduleHealth, costHealth, progressHealth, completionHealth],
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            pointBackgroundColor: '#3b82f6',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100,
                                ticks: { color: '#cbd5e1', backdropColor: 'transparent', stepSize: 20 },
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                angleLines: { color: 'rgba(255,255,255,0.1)' },
                                pointLabels: { color: '#e2e8f0', font: { size: 12 } }
                            }
                        },
                        plugins: { legend: { labels: { color: '#e2e8f0' } } }
                    }
                });
            } catch (error) { console.error('‚ùå Error Salud:', error); }
        }
        
        function loadTaskList() {
            try {
                const taskList = document.getElementById('taskList');
                const tasks = projectData.tasks;
                
                if (tasks.length === 0) {
                    taskList.innerHTML = '<div style="color: #94a3b8; text-align: center; padding: 20px;">No hay tareas</div>';
                    return;
                }
                
                taskList.innerHTML = tasks.map((task, index) => {
                    const taskName = task.name || 'Tarea ' + (index + 1);
                    const progress = task.progress || 0;
                    const status = task.status || 'pending';
                    const estimatedTime = task.estimatedTime || 0;
                    const timeLogged = task.timeLogged || 0;
                    
                    let color = '#f59e0b', statusText = 'Pendiente', emoji = '‚è≥';
                    if (progress === 100 || status.includes('completed') || status.includes('completada')) {
                        color = '#10b981'; statusText = 'Completada'; emoji = '‚úÖ';
                    } else if (status.includes('overdue') || status.includes('rezagada') || status.includes('atrasada')) {
                        color = '#ef4444'; statusText = 'Atrasada'; emoji = '‚ö†Ô∏è';
                    } else if (status.includes('inProgress') || status.includes('en progreso') || (progress > 0 && progress < 100)) {
                        color = '#008090'; statusText = 'En progreso'; emoji = 'üîÑ';
                    } else if (status.includes('pending') || status.includes('pendiente') || progress === 0) {
                        color = '#f59e0b'; statusText = 'Pendiente'; emoji = '‚è≥';
                    }
                    
                    return '<div class="task-item" style="border-left-color: ' + color + ';">' +
                        '<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">' +
                            '<div style="flex: 1; min-width: 0;">' +
                                '<strong style="color: white; font-size: 13px; display: block; overflow: hidden; text-overflow: ellipsis;">' +
                                    (index + 1) + '. ' + taskName +
                                '</strong>' +
                                '<div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">' +
                                    '<span style="color: #94a3b8; font-size: 11px;">' + emoji + ' ' + statusText + ' | Est: ' + estimatedTime + 'h | Real: ' + timeLogged + 'h | Prog: ' + progress + '%</span>' +
                                '</div>' +
                            '</div>' +
                            '<div style="display: flex; align-items: center;">' +
                                '<span style="color: ' + color + '; font-size: 14px; font-weight: bold; min-width: 40px; text-align: right;">' +
                                    progress + '%' +
                                '</span>' +
                            '</div>' +
                        '</div>' +
                        '<div style="height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 8px;">' +
                            '<div style="width: ' + progress + '%; height: 100%; background: ' + color + '; border-radius: 2px;"></div>' +
                        '</div>' +
                    '</div>';
                }).join('');
            } catch (error) {
                console.error('‚ùå Error cargando tareas:', error);
            }
        }
        
        function refreshDashboard() {
            console.log('üîÑ Actualizando dashboard manualmente...');
            requestRefresh();
            showNotification('Solicitando datos actualizados...');
        }
        
        function closeWindow() {
            // Notificar a la ventana principal que nos vamos a cerrar
            try {
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'PREMIUM_WINDOW_CLOSED'
                    }, '*');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è No se pudo notificar cierre:', error);
            }
            
            window.close();
        }
        
        // Funciones auxiliares (sin cambios)
        function showBurndownChart() {
            const burndown = projectData.burndown;
            alert('üìä BURNDOWN CHART (HORAS):\\n\\n' +
                  '‚Ä¢ Horas totales: ' + burndown.totalHoras.toFixed(1) + 'h\\n' +
                  '‚Ä¢ Horas COMPLETADAS (100%): ' + burndown.horasCompletadas.toFixed(1) + 'h\\n' +
                  '‚Ä¢ Horas RESTANTES: ' + burndown.horasRestantes.toFixed(1) + 'h');
        }
        
        function showEVMAnalysis() {
            const evm = projectData.evm;
            alert('üí∞ AN√ÅLISIS EVM:\\n\\n' +
                  '‚Ä¢ PV (Planificado): ' + evm.pv.toFixed(2) + 'h\\n' +
                  '‚Ä¢ EV (Ganado): ' + evm.ev.toFixed(2) + 'h\\n' + 
                  '‚Ä¢ AC (Real): ' + evm.ac.toFixed(2) + 'h\\n\\n' +
                  'üìä √çNDICES:\\n' +
                  '‚Ä¢ CPI (Costo): ' + evm.cpi.toFixed(2) + (evm.cpi >= 1 ? ' ‚úÖ (Bajo presupuesto)' : ' ‚ùå (Sobre presupuesto)') + '\\n' +
                  '‚Ä¢ SPI (Tiempo): ' + evm.spi.toFixed(2) + (evm.spi >= 1 ? ' ‚úÖ (Adelantado)' : ' ‚ùå (Atrasado)'));
        }
        
        function showTaskDetails() {
            alert('üìã Mostrando detalles de ' + projectData.tasks.length + ' tareas...');
        }
        
        function showRiskAnalysis() {
            const risks = [];
            const evm = projectData.evm;
            const dist = projectData.distribution;
            
            if (evm.cpi < 1) risks.push('‚Ä¢ üìâ Riesgo de sobrecostos (CPI < 1)');
            if (evm.spi < 1) risks.push('‚Ä¢ ‚è±Ô∏è Riesgo de retrasos (SPI < 1)');
            if (dist.atrasadas > 0) risks.push('‚Ä¢ ‚ö†Ô∏è ' + dist.atrasadas + ' tareas atrasadas');
            if (projectData.kpis.averageProgress < 50) risks.push('‚Ä¢ üêå Progreso general bajo');
            
            if (risks.length === 0) risks.push('‚Ä¢ ‚úÖ Proyecto en buen estado');
            
            alert('üö® AN√ÅLISIS DE RIESGOS:\\n\\n' + risks.join('\\n'));
        }
        
        function exportDashboard() {
            const dataStr = JSON.stringify({
                proyecto: projectData.name,
                fecha: new Date().toISOString(),
                datos: projectData,
                actualizaciones: updateCount,
                resumen: "Dashboard generado con datos PRECISOS del sistema principal - Actualizaci√≥n autom√°tica habilitada"
            }, null, 2);
            
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileName = projectData.name + '_Dashboard_' + new Date().toISOString().split('T')[0] + '.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileName);
            linkElement.click();
            
            showNotification('Datos exportados: ' + exportFileName);
        }
        
        // Inicializar dashboard
        document.addEventListener('DOMContentLoaded', initDashboard);
        if (document.readyState === 'complete') initDashboard();
        
        // Agregar animaci√≥n CSS para el spinner
        const style = document.createElement('style');
        style.textContent = \`
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        \`;
        document.head.appendChild(style);
        
        // Notificar cierre de ventana
        window.addEventListener('beforeunload', function() {
            try {
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'PREMIUM_WINDOW_CLOSED'
                    }, '*');
                }
            } catch (error) {
                // Silenciar error
            }
        });
    </script>
</body>
</html>`;
}

// ==================== FUNCI√ìN PARA GENERAR RECOMENDACIONES PRECISAS ====================
function generateRealRecommendations(evmData, taskDistribution, kpis) {
    const recommendations = [];
    
    // AN√ÅLISIS EVM PRECISO
    if (evmData.cpi < 1) {
        const overCost = ((1 - evmData.cpi) * 100).toFixed(1);
        recommendations.push('‚Ä¢ üìä <strong>CPI: ' + evmData.cpi.toFixed(2) + '</strong> - Sobrecosto del ' + overCost + '%');
        recommendations.push('‚Ä¢ üí° <strong>Recomendaci√≥n:</strong> Controlar horas extras y revisar recursos.');
    } else {
        const underCost = ((evmData.cpi - 1) * 100).toFixed(1);
        recommendations.push('‚Ä¢ üìä <strong>CPI: ' + evmData.cpi.toFixed(2) + '</strong> - Bajo presupuesto en ' + underCost + '%');
        recommendations.push('‚Ä¢ üí° <strong>Recomendaci√≥n:</strong> Mantener la eficiencia actual.');
    }
    
    if (evmData.spi < 1) {
        const delay = ((1 - evmData.spi) * 100).toFixed(1);
        recommendations.push('‚Ä¢ ‚è±Ô∏è <strong>SPI: ' + evmData.spi.toFixed(2) + '</strong> - Retraso del ' + delay + '%');
        recommendations.push('‚Ä¢ üí° <strong>Recomendaci√≥n:</strong> Priorizar tareas cr√≠ticas y revisar dependencias.');
    } else {
        const ahead = ((evmData.spi - 1) * 100).toFixed(1);
        recommendations.push('‚Ä¢ ‚è±Ô∏è <strong>SPI: ' + evmData.spi.toFixed(2) + '</strong> - Adelantado ' + ahead + '%');
        recommendations.push('‚Ä¢ üí° <strong>Recomendaci√≥n:</strong> Excelente progreso, mantener ritmo.');
    }
    
    // AN√ÅLISIS DISTRIBUCI√ìN PRECISO
    recommendations.push('‚Ä¢ üìã <strong>Distribuci√≥n:</strong> ' + 
        taskDistribution.completadas + ' completadas, ' +
        taskDistribution.enProgreso + ' en progreso, ' +
        taskDistribution.pendientes + ' pendientes, ' +
        taskDistribution.atrasadas + ' atrasadas');
    
    if (taskDistribution.atrasadas > 0) {
        recommendations.push('‚Ä¢ ‚ö†Ô∏è <strong>Atenci√≥n:</strong> ' + taskDistribution.atrasadas + ' tareas atrasadas requieren acci√≥n inmediata');
    }
    
    if (taskDistribution.completadas === kpis.totalTasks) {
        recommendations.push('‚Ä¢ üéâ <strong>¬°Proyecto completado!</strong> Todas las tareas finalizadas');
    } else if (taskDistribution.completadas / kpis.totalTasks >= 0.8) {
        recommendations.push('‚Ä¢ üëç <strong>Excelente avance:</strong> M√°s del 80% completado');
    }
    
    // AN√ÅLISIS PROGRESO
    if (kpis.averageProgress < 30) {
        recommendations.push('‚Ä¢ üêå <strong>Progreso lento:</strong> Solo ' + kpis.averageProgress + '% de avance');
        recommendations.push('‚Ä¢ üí° <strong>Recomendaci√≥n:</strong> Identificar bloqueos y asignar m√°s recursos');
    } else if (kpis.averageProgress > 70) {
        recommendations.push('‚Ä¢ üöÄ <strong>Excelente ritmo:</strong> ' + kpis.averageProgress + '% de progreso');
    }
    
    // AN√ÅLISIS EVM ADICIONAL
    if (evmData.vac < 0) {
        recommendations.push('‚Ä¢ üí∞ <strong>Variaci√≥n final (VAC):</strong> Proyecci√≥n de ' + Math.abs(evmData.vac).toFixed(2) + 'h sobre presupuesto');
        recommendations.push('‚Ä¢ üí° <strong>Recomendaci√≥n:</strong> Revisar estimaciones y controlar costos.');
    } else {
        recommendations.push('‚Ä¢ üí∞ <strong>Variaci√≥n final (VAC):</strong> Proyecci√≥n de ' + evmData.vac.toFixed(2) + 'h bajo presupuesto');
        recommendations.push('‚Ä¢ üí° <strong>Recomendaci√≥n:</strong> Excelente gesti√≥n de presupuesto.');
    }
    
    // AN√ÅLISIS BURNDOWN
    recommendations.push('‚Ä¢ üìâ <strong>Burndown:</strong> Gr√°fico muestra horas restantes vs tiempo');
    if (evmData.spi < 0.8) {
        recommendations.push('‚Ä¢ ‚ö†Ô∏è <strong>Atenci√≥n Burndown:</strong> L√≠nea real por encima de la ideal - revisar cronograma');
    }
    
    return recommendations.join('<br><br>');
}

// ==================== ABRIR VENTANA PREMIUM ====================
function openPremiumWindow(htmlContent, projectName) {
    const width = Math.min(1400, screen.width * 0.95);
    const height = Math.min(900, screen.height * 0.95);
    const left = (screen.width - width) / 2;
    const top = (screen.height - height) / 2;
    
    const windowFeatures = 'width=' + width + ',height=' + height + ',left=' + left + ',top=' + top + ',menubar=no,toolbar=no,location=no,status=no,scrollbars=yes,resizable=yes';
    
    try {
        const newWindow = window.open('', '_blank', windowFeatures);
        if (newWindow) {
            // Configurar comunicaci√≥n con la nueva ventana
            currentPremiumWindow = newWindow;
            lastTaskData = null;
            refreshCount = 0;
            
            newWindow.onbeforeunload = function() {
                // Notificar que la ventana se cerr√≥
                window.postMessage({
                    type: 'PREMIUM_WINDOW_CLOSED'
                }, '*');
                currentPremiumWindow = null;
                stopAutoRefresh();
                return "¬øCerrar la vista premium?";
            };
            
            newWindow.document.write(htmlContent);
            newWindow.document.close();
            newWindow.focus();
            
            console.log('üöÄ Ventana premium abierta:', projectName);
            return true;
        } else {
            alert('‚ö†Ô∏è Permite ventanas emergentes para esta funci√≥n');
            return false;
        }
    } catch (error) {
        console.error('‚ùå Error:', error);
        alert('Error: ' + error.message);
        return false;
    }
}

// ==================== INYECCI√ìN AUTOM√ÅTICA ====================
function autoInjectPremiumButton() {
    if (addPremiumFullscreenButton()) {
        console.log('‚úÖ Bot√≥n premium inyectado');
        return;
    }
    
    console.log('‚è≥ Esperando Gantt...');
    
    let attempts = 0;
    const maxAttempts = 10;
    
    const interval = setInterval(() => {
        attempts++;
        
        if (addPremiumFullscreenButton()) {
            clearInterval(interval);
            console.log('‚úÖ Bot√≥n inyectado en intento ' + attempts);
        } else if (attempts >= maxAttempts) {
            clearInterval(interval);
            console.warn('‚ö†Ô∏è No se pudo inyectar despu√©s de ' + maxAttempts + ' intentos');
        }
    }, 500);
}

// ==================== INICIALIZACI√ìN ====================
// Configurar comunicaci√≥n entre ventanas al cargar
if (document.readyState === 'complete') {
    setTimeout(() => {
        setupWindowCommunication();
        autoInjectPremiumButton();
    }, 1000);
} else {
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            setupWindowCommunication();
            autoInjectPremiumButton();
        }, 1000);
    });
}

window.inyectarBotonPremium = autoInjectPremiumButton;
window.abrirVistaPremium = function() {
    const gantt = document.getElementById('premiumExecutiveGantt');
    if (gantt) {
        document.getElementById('premiumFullscreenBtn')?.click();
    } else {
        alert('Abre el Gantt Ejecutivo primero');
    }
};

// Exportar funciones para control manual
window.toggleAutoRefresh = function(enable) {
    if (enable !== undefined) {
        window.autoRefreshEnabled = enable;
    } else {
        window.autoRefreshEnabled = !window.autoRefreshEnabled;
    }
    
    if (window.autoRefreshEnabled) {
        startAutoRefresh();
    } else {
        stopAutoRefresh();
    }
};

window.forceRefreshPremiumWindow = function() {
    if (currentPremiumWindow) {
        sendDataToPremiumWindow();
    } else {
        console.log('‚ùå No hay ventana premium activa');
    }
};

console.log('üéØ Sistema de Vista Premium PRECISO cargado');
console.log('‚úÖ Actualizaci√≥n autom√°tica configurada');
console.log('‚úÖ Burndown Chart en HORAS (VERSI√ìN CORREGIDA)');
console.log('‚úÖ Dashboard ejecutivo completo con auto-refresh');


// ========== AN√ÅLISIS PREDICTIVO IA (PARA EL BOT√ìN DEL MEN√ö LATERAL) ==========
window.runAIAnalysisPremium = function() {
    console.log('ü§ñ Ejecutando an√°lisis predictivo IA...');
    
    const ganttContainer = document.getElementById('premiumExecutiveGantt');
    if (!ganttContainer) {
        showNotification('‚ö†Ô∏è Primero abre el Gantt Ejecutivo', 'warning');
        return;
    }
    
    const projectIndex = parseInt(ganttContainer.dataset.projectIndex) || currentProjectIndex;
    const currentProject = projects[projectIndex];
    const tasks = currentProject.tasks || [];
    
    if (tasks.length === 0) {
        showNotification('üì≠ No hay tareas para analizar', 'warning');
        return;
    }
    
    // Calcular m√©tricas del proyecto
    const totalTasks = tasks.length;
    const completedTasks = tasks.filter(t => t.status === 'completed').length;
    const inProgressTasks = tasks.filter(t => t.status === 'inProgress').length;
    const pendingTasks = tasks.filter(t => t.status === 'pending').length;
    const criticalTasks = tasks.filter(t => t.critical).length;
    
    // Calcular porcentajes
    const completionRate = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
    const progressRate = totalTasks > 0 ? ((completedTasks + (inProgressTasks * 0.5)) / totalTasks) * 100 : 0;
    
    // An√°lisis de riesgos
    let riskLevel = 'BAJO';
    let riskColor = '#2ecc71';
    let riskReasons = [];
    
    if (criticalTasks > totalTasks * 0.3) {
        riskLevel = 'ALTO';
        riskColor = '#e74c3c';
        riskReasons.push(`üî¥ ${criticalTasks} tareas cr√≠ticas (${Math.round((criticalTasks/totalTasks)*100)}%)`);
    }
    
    if (pendingTasks > totalTasks * 0.5) {
        riskLevel = riskLevel === 'BAJO' ? 'MEDIO' : riskLevel;
        riskColor = riskLevel === 'MEDIO' ? '#f39c12' : riskColor;
        riskReasons.push(`üü° ${pendingTasks} tareas pendientes (${Math.round((pendingTasks/totalTasks)*100)}%)`);
    }
    
    if (completionRate < 30) {
        riskLevel = riskLevel === 'BAJO' ? 'MEDIO' : riskLevel;
        riskColor = riskLevel === 'MEDIO' ? '#f39c12' : riskColor;
        riskReasons.push(`üü° Baja tasa de completado: ${completionRate.toFixed(1)}%`);
    }
    
    if (riskReasons.length === 0) {
        riskReasons.push('‚úÖ Proyecto en buen estado');
    }
    
    // Predicci√≥n de fecha de finalizaci√≥n
    const today = new Date();
    let predictedEndDate = new Date(today);
    
    if (progressRate > 0) {
        const remainingProgress = 100 - progressRate;
        const daysToComplete = Math.ceil((remainingProgress / progressRate) * 30); // Estimaci√≥n simple
        predictedEndDate.setDate(today.getDate() + daysToComplete);
    } else {
        predictedEndDate.setDate(today.getDate() + 60); // Estimaci√≥n por defecto
    }
    
    const formattedDate = predictedEndDate.toLocaleDateString('es-ES', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    // Crear modal de resultados
    const overlay = document.createElement('div');
    overlay.className = 'executive-overlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(10px);
        z-index: 1000000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    `;
    
    const modal = document.createElement('div');
    modal.style.cssText = `
        background: linear-gradient(135deg, #0a0a1a 0%, #121230 100%);
        border-radius: 24px;
        padding: 30px;
        width: 500px;
        max-width: 90vw;
        max-height: 80vh;
        overflow-y: auto;
        border: 2px solid ${riskColor}40;
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        color: white;
    `;
    
    modal.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <div>
                <h2 style="margin: 0 0 10px 0; color: white; display: flex; align-items: center; gap: 10px;">
                    <span style="color: ${riskColor};">ü§ñ</span> 
                    An√°lisis Predictivo IA
                </h2>
                <p style="color: #95a5a6; margin: 0; font-size: 14px;">
                    ${currentProject.name}
                </p>
            </div>
            <button onclick="this.closest('.executive-overlay').remove()" style="
                background: rgba(231, 76, 60, 0.2);
                border: 1px solid #e74c3c;
                color: #e74c3c;
                padding: 8px 16px;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
                font-size: 14px;
            ">
                ‚úï Cerrar
            </button>
        </div>
        
        <!-- Indicador de Riesgo -->
        <div style="
            background: ${riskColor}15;
            border: 2px solid ${riskColor}30;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        ">
            <div style="font-size: 14px; color: #95a5a6; margin-bottom: 8px;">NIVEL DE RIESGO</div>
            <div style="font-size: 32px; font-weight: bold; color: ${riskColor}; margin-bottom: 10px;">
                ${riskLevel}
            </div>
            <div style="font-size: 12px; color: #95a5a6;">
                ${riskReasons.join(' ‚Ä¢ ')}
            </div>
        </div>
        
        <!-- M√©tricas Principales -->
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="
                background: rgba(46, 204, 113, 0.1);
                border: 1px solid rgba(46, 204, 113, 0.3);
                border-radius: 10px;
                padding: 15px;
                text-align: center;
            ">
                <div style="color: #2ecc71; font-size: 24px; font-weight: bold;">${completedTasks}</div>
                <div style="color: #95a5a6; font-size: 12px;">Completadas</div>
            </div>
            
            <div style="
                background: rgba(243, 156, 18, 0.1);
                border: 1px solid rgba(243, 156, 18, 0.3);
                border-radius: 10px;
                padding: 15px;
                text-align: center;
            ">
                <div style="color: #f39c12; font-size: 24px; font-weight: bold;">${inProgressTasks}</div>
                <div style="color: #008090; font-size: 12px;">En Progreso</div>
            </div>
            
            <div style="
                background: rgba(52, 152, 219, 0.1);
                border: 1px solid rgba(52, 152, 219, 0.3);
                border-radius: 10px;
                padding: 15px;
                text-align: center;
            ">
                <div style="color: #3498db; font-size: 24px; font-weight: bold;">${pendingTasks}</div>
                <div style="color: #95a5a6; font-size: 12px;">Pendientes</div>
            </div>
            
            <div style="
                background: rgba(231, 76, 60, 0.1);
                border: 1px solid rgba(231, 76, 60, 0.3);
                border-radius: 10px;
                padding: 15px;
                text-align: center;
            ">
                <div style="color: #e74c3c; font-size: 24px; font-weight: bold;">${criticalTasks}</div>
                <div style="color: #95a5a6; font-size: 12px;">Cr√≠ticas</div>
            </div>
        </div>
        
        <!-- Predicci√≥n de Finalizaci√≥n -->
        <div style="
            background: rgba(155, 89, 182, 0.1);
            border: 1px solid rgba(155, 89, 182, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        ">
            <div style="color: #9b59b6; font-size: 14px; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                <span>üìÖ</span> Predicci√≥n de Finalizaci√≥n
            </div>
            <div style="color: white; font-size: 18px; font-weight: bold; text-align: center; margin-bottom: 10px;">
                ${formattedDate}
            </div>
            <div style="color: #95a5a6; font-size: 12px; text-align: center;">
                Basado en la velocidad actual: ${progressRate.toFixed(1)}% de progreso
            </div>
        </div>
        
        <!-- Recomendaciones -->
        <div style="
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.3);
            border-radius: 12px;
            padding: 20px;
        ">
            <div style="color: #3498db; font-size: 14px; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <span>üí°</span> Recomendaciones IA
            </div>
            <div style="color: #95a5a6; font-size: 13px; line-height: 1.6;">
                ${getAIRecommendations(tasks, riskLevel, completionRate, criticalTasks)}
            </div>
        </div>
        
        <!-- Pie del modal -->
        <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); color: #95a5a6; font-size: 12px; text-align: center;">
            An√°lisis generado el ${new Date().toLocaleString()}
        </div>
    `;
    
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    
    // Funci√≥n para generar recomendaciones
    function getAIRecommendations(tasks, riskLevel, completionRate, criticalTasks) {
        let recommendations = [];
        
        if (completionRate < 30) {
            recommendations.push('üéØ <strong>Priorizar completado:</strong> Enf√≥cate en terminar tareas pendientes para aumentar la tasa de completado.');
        }
        
        if (criticalTasks > 0) {
            recommendations.push(`üî• <strong>Atenci√≥n a tareas cr√≠ticas:</strong> ${criticalTasks} tareas marcadas como cr√≠ticas requieren revisi√≥n inmediata.`);
        }
        
        const tasksWithoutDeps = tasks.filter(t => !t.dependencies || t.dependencies.length === 0);
        if (tasksWithoutDeps.length > tasks.length * 0.7) {
            recommendations.push('üîó <strong>Definir dependencias:</strong> Establece relaciones entre tareas para mejorar la planificaci√≥n.');
        }
        
        const overdueTasks = tasks.filter(t => {
            if (!t.deadline) return false;
            const deadline = new Date(t.deadline);
            return deadline < new Date() && t.status !== 'completed';
        }).length;
        
        if (overdueTasks > 0) {
            recommendations.push(`‚è∞ <strong>Tareas atrasadas:</strong> ${overdueTasks} tareas han superado su fecha l√≠mite.`);
        }
        
        if (recommendations.length === 0) {
            recommendations.push('‚úÖ <strong>Mantener el ritmo:</strong> El proyecto est√° progresando adecuadamente seg√∫n los indicadores actuales.');
        }
        
        return recommendations.map(rec => `<div style="margin-bottom: 8px;">${rec}</div>`).join('');
    }
    
    console.log('‚úÖ An√°lisis predictivo IA completado');
};


// Funci√≥n para mostrar notificaciones (si no existe)
function showNotification(message, type = 'info') {
    const colors = {
        info: '#3498db',
        success: '#2ecc71',
        warning: '#f39c12',
        error: '#e74c3c'
    };
    
    const color = colors[type] || colors.info;
    
    // Eliminar notificaciones anteriores
    const oldNotification = document.getElementById('temp-notification');
    if (oldNotification) oldNotification.remove();
    
    // Crear nueva notificaci√≥n
    const notification = document.createElement('div');
    notification.id = 'temp-notification';
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${color};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        z-index: 999999;
        font-weight: 500;
        animation: slideIn 0.3s ease-out;
    `;
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Remover despu√©s de 3 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
        }
    }, 3000);
}

// Agregar estilos de animaci√≥n si no existen
if (!document.getElementById('notification-styles')) {
    const style = document.createElement('style');
    style.id = 'notification-styles';
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
}






// ============================================
// üöÄ INICIALIZACI√ìN AUTOM√ÅTICA
// ============================================

// Inicializar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(() => {
    // Inicializar sistema de actualizaci√≥n
    if (window.sistemaActualizacionGlobal) {
      window.sistemaActualizacionGlobal.inicializar();
    }
    
    // Establecer observador de cambios
    // window.establecerObservadorCambiosTareas();
    
    console.log('‚úÖ Sistema de actualizaci√≥n autom√°tica configurado');
  }, 3000);
});

// ============================================
// üõ†Ô∏è FUNCIONES DE UTILIDAD PARA DESARROLLADORES
// ============================================

// Mostrar estado del sistema
window.mostrarEstadoActualizacion = function() {
  console.log('üìä ESTADO DEL SISTEMA DE ACTUALIZACI√ìN:');
  console.log('- Vistas registradas:', Object.keys(window.sistemaActualizacionGlobal.vistasActivas));
  console.log('- √öltima verificaci√≥n:', window.sistemaActualizacionGlobal.ultimoEstado ? 
    new Date(window.sistemaActualizacionGlobal.ultimoEstado.timestamp).toLocaleTimeString() : 'Nunca');
  console.log('- Intervalo activo:', window.sistemaActualizacionGlobal.intervalo ? '‚úÖ S√≠' : '‚ùå No');
  
  // Mostrar cada vista registrada
  Object.keys(window.sistemaActualizacionGlobal.vistasActivas).forEach(vista => {
    const info = window.sistemaActualizacionGlobal.vistasActivas[vista];
    console.log(`  üìå ${vista}:`);
    console.log(`    - √öltima actualizaci√≥n: ${new Date(info.ultimaActualizacion).toLocaleTimeString()}`);
    console.log(`    - Visible: ${window.sistemaActualizacionGlobal.vistaEstaVisible(vista) ? '‚úÖ' : '‚ùå'}`);
  });
};

// Forzar actualizaci√≥n manual desde consola
window.actualizarTodoAhora = function() {
  console.log('üöÄ FORZANDO ACTUALIZACI√ìN COMPLETA DEL SISTEMA');
  
  if (window.sistemaActualizacionGlobal) {
    window.sistemaActualizacionGlobal.forzarActualizacionTodasVistas();
  } else {
    console.log('‚ùå Sistema de actualizaci√≥n no inicializado');
  }
};

// Activar/desactivar sistema
window.toggleActualizacionAutomatica = function(activar = true) {
  if (activar) {
    if (window.sistemaActualizacionGlobal) {
      window.sistemaActualizacionGlobal.inicializar();
      console.log('‚úÖ Actualizaci√≥n autom√°tica ACTIVADA');
    }
  } else {
    if (window.sistemaActualizacionGlobal) {
      window.sistemaActualizacionGlobal.detener();
      console.log('üõë Actualizaci√≥n autom√°tica DESACTIVADA');
    }
  }
};







/*************************************************
 * AUTO-UPDATE DEFINITIVO DE FILTROS (ARQUITECTURA)
 *************************************************/
(function enableUltimateFilterAutoUpdate() {
  console.log('üéõÔ∏è Auto-update DEFINITIVO de filtros activado');

  document.addEventListener('change', event => {
    const el = event.target;

    // Solo reaccionar a filtros reales
    if (
      el.tagName !== 'SELECT' &&
      !(el.tagName === 'INPUT' && el.type !== 'checkbox')
    ) return;

    // Detectar vista activa REAL (la que usa showView)
    let activeView = null;

    if (document.querySelector('#boardView')?.classList.contains('active')) {
      activeView = 'board';
    } else if (document.querySelector('#listView')?.classList.contains('active')) {
      activeView = 'list';
    } else if (document.querySelector('#calendarView')?.classList.contains('active')) {
      activeView = 'calendar';
    } else if (document.querySelector('#reportsView')?.classList.contains('active')) {
      activeView = 'reports';
    } else if (document.querySelector('#timeAllocationView')?.classList.contains('active')) {
      activeView = 'timeAllocation';
    }

    console.log('üîÑ Filtro cambiado:', el.id || el.name);
    console.log('üìç Vista activa:', activeView);

    if (!activeView || typeof showView !== 'function') {
      console.warn('‚ö†Ô∏è No se pudo refrescar la vista');
      return;
    }

    // üî• FORZAR RE-RENDER COMPLETO
    requestAnimationFrame(() => {
      showView(activeView);
    });
  });
})();









// PEGA ESTO AL FINAL DE TU SCRIPT.JS (antes del cierre si hay alguno)
window.debugMyEVMIssue = function() {
  const project = projects[currentProjectIndex];
  const tasks = project.tasks || [];
  
  console.log('üîç DEBUG EVM - ¬øPOR QU√â DA 20h EN LUGAR DE 18h?');
  console.log('==============================================');
  
  // 1. Mostrar todas las tareas con sus datos EXACTOS
  console.log('\nüìã TODAS LAS TAREAS EN TU SISTEMA:');
  let totalEV = 0;
  
  tasks.forEach((task, i) => {
    const estimated = Number(task.estimatedTime) || 0;
    const logged = Number(task.timeLogged) || 0;
    const actual = Number(task.actualTime) || 0;
    const status = task.status || 'pending';
    
    // Calcular progreso como lo hace tu funci√≥n
    let progress = 0;
    
    if (status === 'completed') {
      progress = 1.0;
    } else if (logged > 0 && estimated > 0) {
      progress = Math.min(0.99, logged / estimated);
    } else if (task.progress !== undefined) {
      progress = Math.min(0.99, Number(task.progress) / 100);
    } else {
      // Estado por defecto
      if (status.includes('progress') || status === 'inProgress') {
        progress = 0.5;
      } else if (status.includes('rezagado') || status.includes('delayed')) {
        progress = 0.5;
      } else if (status.includes('pending')) {
        progress = 0;
      } else {
        progress = 0.3;
      }
    }
    
    const taskEV = estimated * progress;
    totalEV += taskEV;
    
    console.log(`${i+1}. "${task.name}":`);
    console.log(`   üìä Estado: ${status}`);
    console.log(`   ‚è±Ô∏è  Estimado: ${estimated}h`);
    console.log(`   üìù Registrado: ${logged}h (timeLogged)`);
    console.log(`   üí∞ Real: ${actual}h (actualTime)`);
    console.log(`   üìà Progreso: ${(progress * 100).toFixed(0)}%`);
    console.log(`   üßÆ EV contribuci√≥n: ${taskEV.toFixed(2)}h`);
    console.log(`   ---`);
  });
  
  // 2. Calcular m√©tricas totales
  let totalEstimated = 0;
  let totalLogged = 0;
  let totalActual = 0;
  
  tasks.forEach(task => {
    totalEstimated += Number(task.estimatedTime) || 0;
    totalLogged += Number(task.timeLogged) || 0;
    totalActual += Number(task.actualTime) || 0;
  });
  
  console.log('\nüìä TOTALES:');
  console.log(`   ‚è±Ô∏è  Horas estimadas (BAC): ${totalEstimated}h`);
  console.log(`   üìù Horas registradas (timeLogged): ${totalLogged}h`);
  console.log(`   üí∞ Horas reales (actualTime): ${totalActual}h`);
  console.log(`   üßÆ Valor Ganado (EV): ${totalEV.toFixed(2)}h`);
  
  // 3. Identificar discrepancias
  console.log('\nüîé DIAGN√ìSTICO:');
  console.log(`   Tu sistema dice EV = 20h`);
  console.log(`   Este c√°lculo da EV = ${totalEV.toFixed(2)}h`);
  
  if (Math.abs(totalEV - 20) > 0.1) {
    console.log(`   ‚ö†Ô∏è  ¬°HAY UNA DIFERENCIA! Revisa si hay otra funci√≥n calculando EV.`);
  }
  
  // 4. Mostrar SPI que deber√≠a dar
  const PV = totalEstimated; // PV = BAC (corregido)
  const SPI = PV > 0 ? totalEV / PV : 0;
  
  console.log('\nüéØ SPI DEBER√çA SER:');
  console.log(`   PV = ${PV}h`);
  console.log(`   EV = ${totalEV.toFixed(2)}h`);
  console.log(`   SPI = EV/PV = ${SPI.toFixed(2)}`);
  console.log(`   SPI esperado: 0.62`);
  
  if (Math.abs(SPI - 0.62) > 0.05) {
    console.log(`   ‚ùå SPI incorrecto. Revisa los datos de las tareas.`);
  } else {
    console.log(`   ‚úÖ SPI correcto. El problema est√° en otra parte.`);
  }
};











// ===========================================================
// ‚úÖ CORRECCI√ìN DEFINITIVA: FILTROS DE ASIGNACI√ìN DE HORAS
// ‚úÖ Funciona incluso si la vista se carga din√°micamente
// ===========================================================
(function fixTimeAllocationFilters() {
  // 1. Corregir pointer-events en toda la vista (soluci√≥n de emergencia visual)
  const fixPointerEvents = () => {
    const view = document.getElementById('timeAllocationView');
    if (!view) return;
    // Asegurar que los controles sean interactivos
    const controls = view.querySelectorAll('select, button, input');
    controls.forEach(el => {
      el.style.pointerEvents = 'auto';
      el.style.opacity = '1';
    });
  };

  // 2. Funci√≥n para recargar datos (tu l√≥gica aqu√≠ o llama a la existente)
  const reloadTimeAllocationData = () => {
    console.log('üîÑ Recargando datos de Asignaci√≥n de Horas...');

    // --- TU L√ìGICA DE CARGA DE DATOS AQU√ç ---
    // Si ya tienes una funci√≥n llamada `loadTimeAllocationData`, usa esta:
    if (typeof window.loadTimeAllocationData === 'function') {
      window.loadTimeAllocationData();
    } else {
      // Si no, aqu√≠ va una versi√≥n m√≠nima funcional (reempl√°zala con tu implementaci√≥n real)
      const tableBody = document.querySelector('#timeAllocationTable tbody');
      if (tableBody) tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center">‚úÖ Filtros aplicados (implementa tu l√≥gica de datos)</td></tr>';
    }
  };

  // 3. Poblar filtros (solo si existen los elementos)
  const populateFilters = () => {
    const yearSel = document.getElementById('filterTimeAllocationYear');
    const monthSel = document.getElementById('filterTimeAllocationMonth');
    const projSel = document.getElementById('filterTimeAllocationProject');
    const assigSel = document.getElementById('filterTimeAllocationAssignee');

    if (!yearSel || !monthSel || !projSel || !assigSel) return;

    // Limpiar
    [yearSel, monthSel, projSel, assigSel].forEach(sel => {
      if (sel.children.length <= 1) sel.innerHTML = '<option value="all">Todos</option>';
    });

    // Solo llenar si est√°n vac√≠os (evita duplicados)
    if (yearSel.children.length <= 1) {
      const years = new Set();
      if (Array.isArray(window.projects)) {
        window.projects.forEach(p => {
          if (Array.isArray(p.tasks)) {
            p.tasks.forEach(t => {
              if (Array.isArray(t.timeHistory)) {
                t.timeHistory.forEach(h => {
                  const y = new Date(h.date).getFullYear();
                  if (!isNaN(y)) years.add(y);
                });
              }
            });
          }
        });
      }
      [...years].sort((a, b) => b - a).forEach(y => {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        yearSel.appendChild(opt);
      });
    }
    // Meses (est√°ticos)
    if (monthSel.children.length <= 1) {
      const months = [
        { v: '01', n: 'Enero' }, { v: '02', n: 'Febrero' }, { v: '03', n: 'Marzo' },
        { v: '04', n: 'Abril' }, { v: '05', n: 'Mayo' }, { v: '06', n: 'Junio' },
        { v: '07', n: 'Julio' }, { v: '08', n: 'Agosto' }, { v: '09', n: 'Septiembre' },
        { v: '10', n: 'Octubre' }, { v: '11', n: 'Noviembre' }, { v: '12', n: 'Diciembre' }
      ];
      months.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.v;
        opt.textContent = m.n;
        monthSel.appendChild(opt);
      });
    }
    console.log('‚úÖ Filtros de Asignaci√≥n de Horas poblados (si hab√≠a datos)');
  };

  // 4. Activar funcionalidad cuando la vista se muestre
  const activateWhenVisible = () => {
    const view = document.getElementById('timeAllocationView');
    if (!view || !view.classList.contains('active') && !view.offsetParent) {
      // Reintentar en 500ms si no est√° lista
      setTimeout(activateWhenVisible, 500);
      return;
    }

    console.log('‚úÖ Vista de Asignaci√≥n de Horas detectada y activa');
    fixPointerEvents();
    populateFilters();

    // Event delegation para el bot√≥n "Aplicar"
    const applyBtn = document.getElementById('applyTimeAllocationFilters');
    if (applyBtn && !applyBtn.dataset.fixed) {
      applyBtn.dataset.fixed = 'true';
      applyBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        reloadTimeAllocationData();
      });
    }

    // Opcional: permitir cambios autom√°ticos (descomenta si lo deseas)
   
    ['Year', 'Month', 'Project', 'Assignee'].forEach(name => {
  const el = document.getElementById(`filterTimeAllocation${name}`);
  if (el && !el.dataset.hasListener) {
    el.dataset.hasListener = 'true';
    el.addEventListener('change', reloadTimeAllocationData);
      }
    });
 
  };

  // 5. Iniciar cuando el DOM est√© listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', activateWhenVisible);
  } else {
    activateWhenVisible();
  }

 
})();




function resizeCalendar() {
    if (!window.calendarInstance) return;

    const calendar = window.calendarInstance;

    try {
        // 1Ô∏è‚É£ Resize b√°sico
        calendar.updateSize();
    } catch (e) {}

    // 2Ô∏è‚É£ Forzar re-render interno de columnas
    setTimeout(() => {
        try {
            const currentView = calendar.view.type;

            // üî• Truco clave: cambiar y volver a la misma vista
            calendar.changeView(currentView);
            calendar.updateSize();

            console.log('üìÖ Calendario forzado a recalcular columnas');
        } catch (error) {
            console.warn('‚ö†Ô∏è Error al forzar render del calendario:', error);
        }
    }, 450);
}

function setupCalendarResizeObserver() {
    const sidebar = document.querySelector('aside');

    if (!sidebar) {
        console.log('‚è≥ Sidebar no encontrado, reintentando...');
        setTimeout(setupCalendarResizeObserver, 1000);
        return;
    }

    const observer = new MutationObserver(mutations => {
        mutations.forEach(mutation => {
            if (mutation.attributeName === 'class') {
                console.log('üîç Sidebar cambi√≥ - redimensionando calendario');
                resizeCalendar();
            }
        });
    });

    observer.observe(sidebar, {
        attributes: true,
        attributeFilter: ['class']
    });

    console.log('‚úÖ Observer configurado para redimensionar calendario autom√°ticamente');
}


document.addEventListener('DOMContentLoaded', () => {
    setupCalendarResizeObserver();
});





function forceRefreshCalendarSafe() {
    if (!document.getElementById('calendarView')?.classList.contains('active')) return;
    if (!window.calendarInstance) return;
    console.log('üîÑ Actualizando calendario tras cambio de tarea...');
    try {
        window.calendarInstance.removeAllEvents();
        window.calendarInstance.addEventSource(getFilteredCalendarTasks());
        window.calendarInstance.updateSize();
    } catch (e) {
        console.error('‚ùå Error en forceRefreshCalendarSafe:', e);
    }
}








window.calculateCostVariances = function (evmData) {
  if (!evmData) return null;

  const { EV, AC, PV } = evmData;

  if (
    typeof EV !== 'number' ||
    typeof AC !== 'number' ||
    typeof PV !== 'number'
  ) {
    return null;
  }

  return {
    CV: EV - AC,
    SV: EV - PV
  };
};



// ü©π Parche de seguridad: evita crash del dashboard
if (typeof window.updateGanttCloseButton !== 'function') {
  window.updateGanttCloseButton = function () {
    console.warn('‚ö†Ô∏è updateGanttCloseButton no implementada (parche activo)');
  };
}





// === FUNCI√ìN MEJORADA PARA DESCARGAR ARCHIVOS ===
function downloadTaskFile(taskId) {
    console.log("üì• downloadTaskFile llamada para taskId:", taskId);
    
    // 1. Validaciones b√°sicas
    if (!projects || currentProjectIndex === null || currentProjectIndex === undefined) {
        showNotification('‚ùå No hay proyecto seleccionado');
        return;
    }
    
    const project = projects[currentProjectIndex];
    if (!project || !project.tasks) {
        showNotification('‚ùå Proyecto no v√°lido');
        return;
    }
    
    // 2. Buscar la tarea
    const task = project.tasks.find(t => t.id == taskId);
    if (!task || !task.file) {
        showNotification('No hay archivo adjunto para descargar');
        return;
    }
    
    console.log("üì• Buscando archivo:", task.file.name, "para tarea ID:", taskId);
    
    // 3. Buscar en el √≠ndice
    const fileIndex = JSON.parse(localStorage.getItem('task_files_index') || '[]');
    console.log("üìä √çndice actual:", fileIndex);
    
    let fileEntry = null;
    
    // Primero: buscar por taskId exacto
    fileEntry = fileIndex.find(entry => entry.taskId == taskId);
    
    // Segundo: si no encuentra, buscar por nombre y fecha
    if (!fileEntry) {
        fileEntry = fileIndex.find(entry => {
            const sameName = entry.fileName === task.file.name;
            const dateDiff = Math.abs(
                new Date(entry.uploadDate) - new Date(task.file.uploadDate)
            );
            const similarDate = dateDiff < 30000; // 30 segundos
            
            return sameName && similarDate;
        });
    }
    
    // Tercero: buscar solo por nombre
    if (!fileEntry) {
        fileEntry = fileIndex.find(entry => entry.fileName === task.file.name);
    }
    
    // 4. Si encontramos una entrada
    if (fileEntry) {
        console.log("‚úÖ Archivo encontrado en √≠ndice:", fileEntry);
        
        // Intentar cargar el archivo
        const fileData = loadFileFromStorage(fileEntry.key);
        
        if (fileData && fileData.data && fileData.data.startsWith('data:')) {
            // √âXITO: Crear y hacer clic en el enlace
            const link = document.createElement('a');
            link.href = fileData.data;
            link.download = task.file.name;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            
            try {
                link.click();
                showNotification(`üì• Descargando: ${task.file.name}`);
                console.log("‚úÖ Descarga iniciada");
            } catch (error) {
                console.error("‚ùå Error al hacer clic:", error);
                showNotification('Error al descargar el archivo');
            } finally {
                setTimeout(() => {
                    document.body.removeChild(link);
                }, 100);
            }
            
            return;
        } else {
            console.error("‚ùå Archivo no v√°lido en localStorage");
            showNotification('Error: Archivo corrupto o no encontrado');
        }
    }
    
    // 5. B√∫squeda de emergencia en localStorage
    console.log("üîç Realizando b√∫squeda de emergencia en localStorage...");
    
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('task_file_')) {
            try {
                const data = JSON.parse(localStorage.getItem(key));
                if (data && data.info && data.info.name === task.file.name) {
                    console.log("‚úÖ Encontrado en b√∫squeda directa:", key);
                    
                    if (data.data && data.data.startsWith('data:')) {
                        const link = document.createElement('a');
                        link.href = data.data;
                        link.download = task.file.name;
                        link.style.display = 'none';
                        
                        document.body.appendChild(link);
                        link.click();
                        
                        setTimeout(() => {
                            document.body.removeChild(link);
                        }, 100);
                        
                        showNotification(`üì• Descargando: ${task.file.name}`);
                        
                        // Actualizar el √≠ndice para futuras b√∫squedas
                        fileIndex.push({
                            key: key,
                            fileName: task.file.name,
                            uploadDate: task.file.uploadDate,
                            taskId: taskId
                        });
                        localStorage.setItem('task_files_index', JSON.stringify(fileIndex));
                        
                        return;
                    }
                }
            } catch (e) {
                // Continuar con la siguiente key
            }
        }
    }
    
    // 6. Si llegamos aqu√≠, no se encontr√≥
    console.error("‚ùå Archivo no encontrado en ning√∫n lugar");
    showNotification(`‚ùå No se pudo encontrar el archivo "${task.file.name}"`);
    
    // Mostrar informaci√≥n para debug
    console.log("üìã Informaci√≥n de la tarea:", {
        taskId: taskId,
        fileName: task.file.name,
        uploadDate: task.file.uploadDate,
        hasKey: !!task.file.key
    });
    
    console.log("üìä √çndice completo:", fileIndex);
}

















// === CARGAR DATOS DE LA FILA 3 CON FORMATO UNIFORME ===
function loadDashboardProjectData() {
    const projectId = currentProjectIndex;
    if (projectId === null || projectId < 0) return;

    // ---------- RIESGOS ----------
    const risksContainer = document.getElementById('risksContainer');
    if (risksContainer) {
        // Asegurar que sea un div con estilos
        risksContainer.style.background = 'rgb(248, 250, 252)';
        risksContainer.style.borderLeft = '1px solid rgb(226, 232, 240)';
        risksContainer.style.borderRadius = '8px';
        risksContainer.style.padding = '10px';
        risksContainer.style.minHeight = '120px';

        // Cargar riesgos
        const risks = JSON.parse(localStorage.getItem(`risks_${projectId}`) || '[]');
        risksContainer.innerHTML = '';
        if (risks.length === 0) {
      
        } else {
            risks.forEach(r => {
                const el = document.createElement('div');
                el.className = 'risk-item';
                el.innerHTML = r.html || 'Riesgo sin datos';
                risksContainer.appendChild(el);
            });
        }
    }

    // ---------- ACCIONES ----------
    const actionsContainer = document.getElementById('requiredActions');
    if (actionsContainer) {
        // Convertir a div si es ul
        if (actionsContainer.tagName === 'UL') {
            const newDiv = document.createElement('div');
            newDiv.id = 'requiredActions';
            newDiv.style.background = 'rgb(248, 250, 252)';
            newDiv.style.borderLeft = '1px solid rgb(226, 232, 240)';
            newDiv.style.borderRadius = '8px';
            newDiv.style.padding = '10px';
            newDiv.style.minHeight = '120px';
            // Mover hijos
            while (actionsContainer.firstChild) {
                newDiv.appendChild(actionsContainer.firstChild);
            }
            actionsContainer.parentElement.replaceChild(newDiv, actionsContainer);
            // Actualizar referencia
            actionsContainer = newDiv;
        } else {
            actionsContainer.style.background = 'rgb(248, 250, 252)';
            actionsContainer.style.borderLeft = '1px solid rgb(226, 232, 240)';
            actionsContainer.style.borderRadius = '8px';
            actionsContainer.style.padding = '10px';
            actionsContainer.style.minHeight = '120px';
        }

        // Cargar acciones
        const actions = JSON.parse(localStorage.getItem(`actions_${projectId}`) || '[]');
        actionsContainer.innerHTML = '';
        if (actions.length === 0) {
       
        } else {
            actions.forEach(a => {
                const el = document.createElement('div');
                el.className = 'action-item';
                el.innerHTML = a.html || 'Acci√≥n sin datos';
                actionsContainer.appendChild(el);
            });
        }
    }

    // ---------- HITOS ----------
    const milestonesContainer = document.getElementById('milestonesList');
    if (milestonesContainer) {
        milestonesContainer.style.background = 'rgb(248, 250, 252)';
        milestonesContainer.style.borderLeft = '1px solid rgb(226, 232, 240)';
        milestonesContainer.style.borderRadius = '8px';
        milestonesContainer.style.padding = '10px';
        milestonesContainer.style.minHeight = '120px';

        // Cargar hitos
        const milestones = JSON.parse(localStorage.getItem(`milestones_${projectId}`) || '[]');
        milestonesContainer.innerHTML = '';
        if (milestones.length === 0) {
         
        } else {
            milestones.forEach(m => {
                const el = document.createElement('div');
                el.className = 'milestone-item';
                el.innerHTML = m.html || 'Hito sin datos';
                milestonesContainer.appendChild(el);
            });
        }
    }
}




// === ALINEAR LAS TRES SECCIONES DE LA FILA 3 ===
function alignDashboardRow3Cards() {
    const riskCard = Array.from(document.querySelectorAll('.dashboard-card'))
        .find(card => card.querySelector('h3')?.textContent.trim() === 'Riesgos y Problemas');

    if (!riskCard) return;

    // Clonar para Acciones Requeridas
    const actionsCard = Array.from(document.querySelectorAll('.dashboard-card'))
        .find(card => card.querySelector('h3')?.textContent.trim() === 'Acciones Requeridas');
    if (actionsCard) {
        const newCard = riskCard.cloneNode(true);
        newCard.querySelector('h3').textContent = 'Acciones Requeridas';
        const container = newCard.querySelector('#risksContainer');
        if (container) container.id = 'requiredActions';
        const btn = newCard.querySelector('.add-risk-btn');
        if (btn) {
            btn.className = 'add-action-btn';
            btn.textContent = '+ Agregar';
        }
        actionsCard.parentElement.replaceChild(newCard, actionsCard);
    }

    // Clonar para Pr√≥ximos Hitos
    const milestonesCard = Array.from(document.querySelectorAll('.dashboard-card'))
        .find(card => card.querySelector('h3')?.textContent.trim() === 'Pr√≥ximos Hitos');
    if (milestonesCard) {
        const newCard = riskCard.cloneNode(true);
        newCard.querySelector('h3').textContent = 'Pr√≥ximos Hitos';
        const container = newCard.querySelector('#risksContainer');
        if (container) container.id = 'milestonesList';
        const btn = newCard.querySelector('.add-risk-btn');
        if (btn) {
            btn.className = 'add-milestone-btn';
            btn.textContent = '+ Agregar';
        }
        milestonesCard.parentElement.replaceChild(newCard, milestonesCard);
    }
}





// === BOT√ìN: Mostrar avance por tareas completadas (solo lectura) ===
document.getElementById('btnAvancePorTareas')?.addEventListener('click', function() {
  const tasks = projects[currentProjectIndex]?.tasks || [];
  const total = tasks.length;
  const completadas = tasks.filter(t => t.status === 'completed').length;
  const porcentaje = total > 0 ? Math.round((completadas / total) * 100) : 0;
  
  // Opci√≥n 1: Alerta simple (recomendado para comit√©s)
  alert(`üìä Avance por tareas completadas: ${porcentaje}%\n\n‚Üí ${completadas} de ${total} tareas terminadas.`);
  
  // Opci√≥n 2: Solo en consola (si prefieres no molestar al usuario)
  // console.log(`üìä Avance por tareas completadas: ${porcentaje}% (${completadas}/${total})`);
});



// === BOT√ìN: Mostrar estado del cronograma ===
document.getElementById('btnEstadoCronograma')?.addEventListener('click', function() {
  const tasks = projects[currentProjectIndex]?.tasks || [];
  const hasOverdue = tasks.some(t => 
    ['overdue', 'rezagado', 'atrasado'].includes(t.status?.toLowerCase())
  );
  
  if (hasOverdue) {
    alert(`üö® RIESGO DE RETRASO\n\nUna o m√°s tareas est√°n fuera de tiempo.\nSe recomienda revisar su planificaci√≥n.`);
  } else {
    alert(`‚úÖ CRONOGRAMA EN TIEMPO\n\nTodas las tareas est√°n dentro de su planificaci√≥n.`);
  }
});






// Proteger la funci√≥n real del Gantt si se llama directamente
const originalGanttFunction = window.createCompleteGanttForCurrentProject;
window.createCompleteGanttForCurrentProject = function() {
  if (!window.licenseManager.canAccess('premiumExecutiveGantt')) {
    showNotification('üîí El Gantt Ejecutivo est√° disponible en los planes Profesional o Premium.');
    return;
  }
  return originalGanttFunction.apply(this, arguments);
};




/*******************************
 * FUNCIONES DE CONTROL DE VISTAS
 *******************************/
function showView(view) {

  console.log("üß≠ Navegando a vista:", view);



  // üîí PROTECCI√ìN POR LICENCIA
  const premiumViews = ['reports', 'profitability', 'dashboard4d'];
  if (premiumViews.includes(view)) {
      }

  // üß≠ PROTECCI√ìN POR MODO DE TRABAJO
  const currentMode = window.methodologyManager?.getCurrentMode();
  const allowedViews = {
    agile: ["board", "calendar", "list", "dashboard", "timeAllocation"],
    traditional: ["list", "reports", "dashboard", "profitability", "timeAllocation"],
    hybrid: ["board", "calendar", "list", "reports", "dashboard", "profitability", "timeAllocation", "dashboard4d"]
  };

  if (currentMode && !allowedViews[currentMode]?.includes(view)) {
    showNotification(`üí° En modo ${currentMode} esta vista no est√° recomendada.`);
    return;
  }

  // üî• LIMPIEZA GLOBAL
  document.body.classList.remove(
    'loading',
    'overlay-active',
    'debug-mode',
    'view-transition',
    'dark-overlay',
    'modal-open'
  );

  // =========================
  // üü£ GANTT PRO (AISLADO)
  // =========================
  if (view === "ganttPro") {

    document.querySelectorAll('.view-content')
      .forEach(v => v.classList.remove('active'));

    const ganttProView = document.getElementById('ganttProView');
    if (!ganttProView) return;

    ganttProView.style.display = 'block';

    renderGanttPro?.();

    Object.entries(viewButtons || {}).forEach(([key, btn]) => {
      if (btn) btn.classList.toggle("active", key === view);
    });

    return;
  }

  // =========================
  // üîµ VISTAS NORMALES
  // =========================

  // Ocultar Gantt Pro
  const ganttProView = document.getElementById('ganttProView');
  if (ganttProView) ganttProView.style.display = 'none';

  // Ocultar TODAS las vistas
  document.querySelectorAll('.view-content')
    .forEach(v => v.classList.remove('active'));

  // Mostrar vista destino
  const targetView = document.getElementById(view + 'View');
  if (!targetView) {
    console.warn('‚ùå Vista no encontrada:', view + 'View');
    return;
  }

  targetView.classList.add('active');

  // Botones del men√∫
  Object.entries(viewButtons || {}).forEach(([key, btn]) => {
    if (btn) btn.classList.toggle("active", key === view);
  });

  // =========================
  // üîß L√ìGICA POR VISTA
  // =========================
  

switch (view) {

    case "list":
      renderListTasks?.();
      break;

    case "calendar":
      addCalendarStyles?.();
      setTimeout(renderCalendar, 50);
      break;

    case "reports":
      setTimeout(() => {
        generateReports?.();
        generatePieChart?.(getStats?.());
      }, 50);
      break;

    case "profitability":
      renderProfitabilityView?.();
      break;

    case "dashboard":
      renderDashboard?.();
      break;

    case "timeAllocation":
      renderTimeAllocationView?.();
      break;

    case "dashboard4d":
      // ‚ùó IMPORTANTE:
      // NO se llama renderDashboard4D()
      // Esta vista es 100% HTML fija
      console.log("‚úÖ Dashboard 4D como vista fija");
      break;
   
  }
}

// Exponer globalmente
window.showView = showView;


















// ===== SOBRESCRITURA FINAL =====
// Esto se ejecuta al final y sobrescribe cualquier funci√≥n vieja

// 1. Asegurar API_URL correcta
if (!window.API_URL || window.API_URL.includes('proyectos-backend-lx0a')) {
  window.API_URL = "https://mi-sistema-proyectos-backend-4.onrender.com";
}

// 2. Sobrescribir login completamente
const originalLogin = window.login;
window.login = async function() {
  const email = document.getElementById('loginEmail')?.value;
  const password = document.getElementById('loginPassword')?.value;
  
  if (!email || !password) {
    const errorEl = document.getElementById('loginError');
    if (errorEl) errorEl.textContent = 'Completa campos';
    return;
  }
  
  try {
    const res = await fetch(`${window.API_URL}/api/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    
    const data = await res.json();
    
    if (res.ok) {
      localStorage.setItem('authToken', data.token);
      localStorage.setItem('user', JSON.stringify(data.user));
      location.reload();
    }
  } catch(err) {
    console.error('‚ùå Error:', err);
  }
};

console.log('‚úÖ Login corregido al final del script');
// ===== FIN SOBRESCRITURA =====








// Verificar licencia al cargar la p√°gina
document.addEventListener('DOMContentLoaded', async () => {
  const user = firebase.auth().currentUser;
  
  if (user) {
    try {
      const response = await fetch(`https://mi-sistema-proyectos-backend-4.onrender.com/api/license/check/${user.uid}`);
      const licenseData = await response.json();
      
      if (licenseData.valid && (licenseData.plan === 'professional' || licenseData.plan === 'premium')) {
        // Mostrar botones de funciones premium
        const ganttBtn = document.getElementById('ganttBtn');
        const dashboard4dBtn = document.getElementById('dashboard4dBtn');
        
        if (ganttBtn) ganttBtn.style.display = 'block';
        if (dashboard4dBtn) dashboard4dBtn.style.display = 'block';
      }
    } catch (error) {
      console.error('Error verificando licencia:', error);
    }
  }
});

































// ======== FIX PARA DASHBOARD 4D - VERSI√ìN ESTABLE =========
window.showDashboard4DView = function () {
    // ‚õî Si ya existe, eliminarlo para evitar duplicados
    const existingContainer = document.getElementById('mainAppContainer');
    if (existingContainer) {
        existingContainer.remove();
        console.log('‚úÖ Container anterior eliminado');
    }

    // üîí Verificar licencia y modo
    if (!window.licenseManager?.canAccess('premiumExecutiveGantt')) {
        showNotification('üîí El Dashboard 4D requiere el plan Profesional o Premium.');
        return;
    }
    const currentMode = window.methodologyManager?.getCurrentMode() || 'hybrid';
    if (currentMode !== 'hybrid') {
        showNotification(`üí° El Dashboard 4D solo est√° disponible en modo H√≠brido.`);
        return;
    }

    // ‚úÖ Crear nuevo contenedor
    const container = document.createElement('div');
    container.id = 'mainAppContainer';
    container.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: #0a0a1a;
        z-index: 999999;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    `;
    document.body.appendChild(container);

    // üö´ Asegurar que otras vistas est√©n ocultas
    document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
    document.querySelector('#dashboardView')?.classList.add('active');

    // üí° Generar contenido HTML del dashboard
    const content = generateDashboard4DHTML();
    container.innerHTML = content;

    // üìä Inicializar gr√°ficos despu√©s de que el DOM est√© listo
    setTimeout(() => {
        initDashboard4DCharts();
    }, 500);
};

function generateDashboard4DHTML() {
    // Aqu√≠ va el HTML limpio y funcional
    return `
        <!-- HEADER -->
        <div style="background: linear-gradient(90deg, #0a0a1a, #1a1a3a); padding: 20px 30px; border-bottom: 1px solid rgba(155, 89, 182, 0.3); display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="background: linear-gradient(45deg, #9b59b6, #8e44ad); width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 8px 20px rgba(155, 89, 182, 0.4);">üåê</div>
                <div>
                    <h2 style="margin: 0; color: white; font-size: 28px; font-weight: 300;"><span style="font-weight: 700; color: #9b59b6;">Dashboard 4D Ejecutivo</span><span style="color: #95a5a6; font-size: 20px; margin-left: 10px;">‚Ä¢ Todos los Proyectos</span></h2>
                    <p style="margin: 5px 0 0 0; color: #95a5a6; font-size: 14px;"><span style="color: #3498db;">üìÖ ${new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span> ‚Ä¢ üìÇ ${projects.length} proyectos ‚Ä¢ üî• ${getCriticalTasksCount()} cr√≠ticas ‚Ä¢ ‚úÖ ${getOverallProgress()}% progreso promedio</p>
                </div>
            </div>
            <div style="display: flex; gap: 12px;">
                <button onclick="refreshDashboard4D()" style="background: linear-gradient(45deg, #3498db, #2980b9); border: none; color: white; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; font-size: 14px;">üîÑ Actualizar</button>
                <button onclick="exportDashboard4DReport()" style="background: linear-gradient(45deg, #2ecc71, #27ae60); border: none; color: white; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; font-size: 14px;">üì• Exportar PDF</button>
                <button onclick="closeDashboard4D()" style="background: rgba(231, 76, 60, 0.2); border: 1px solid #e74c3c; color: #e74c3c; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px;">‚úï Volver al Sistema</button>
            </div>
        </div>

        <!-- CONTENIDO PRINCIPAL -->
        <div style="flex: 1; display: flex; overflow: hidden; background: linear-gradient(180deg, rgba(10,10,26,0.95), rgba(18,18,48,1));">
            <!-- SIDEBAR -->
            <div style="width: 280px; background: linear-gradient(180deg, #0a0a1a, #121230); border-right: 1px solid rgba(255,255,255,0.1); padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 25px; flex-shrink: 0;">
                <!-- KPIs Globales -->
                <div>
                    <h3 style="color: white; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;"><span style="color: #3498db; font-size: 20px;">üìä</span> KPIs Globales</h3>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                        <div style="background: rgba(155,89,182,0.15); border: 1px solid rgba(155,89,182,0.3); border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="color: white; font-size: 32px; font-weight: bold;">${projects.length}</div>
                            <div style="color: #d8b4fe; font-size: 14px; margin-top: 8px;">PROYECTOS</div>
                        </div>
                        <div style="background: rgba(52,152,219,0.15); border: 1px solid rgba(52,152,219,0.3); border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="color: white; font-size: 32px; font-weight: bold;">${getTotalTasks()}</div>
                            <div style="color: #93c5fd; font-size: 14px; margin-top: 8px;">TAREAS TOTALES</div>
                        </div>
                        <div style="background: rgba(46,204,113,0.15); border: 1px solid rgba(46,204,113,0.3); border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="color: white; font-size: 32px; font-weight: bold;">${getCompletedTasks()}</div>
                            <div style="color: #a7f3d0; font-size: 14px; margin-top: 8px;">COMPLETADAS</div>
                        </div>
                        <div style="background: rgba(231,76,60,0.15); border: 1px solid rgba(231,76,60,0.3); border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="color: white; font-size: 32px; font-weight: bold;">${getOverdueTasks()}</div>
                            <div style="color: #fecaca; font-size: 14px; margin-top: 8px;">ATRASADAS</div>
                        </div>
                    </div>
                </div>
                <!-- Estado General -->
                <div>
                    <h3 style="color: white; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;"><span style="color: #f39c12; font-size: 20px;">‚ö†Ô∏è</span> Estado General</h3>
                    <div style="color: #95a5a6; font-size: 14px;">
                        <p>üéØ <strong>Progreso promedio:</strong> ${getOverallProgress()}%</p>
                        <p>üö® <strong>Riesgo:</strong> ${getRiskLevel()}</p>
                        <p>‚ö° <strong>Eficiencia:</strong> ${getEfficiency()}%</p>
                    </div>
                </div>
            </div>
            <!-- √ÅREA PRINCIPAL -->
            <div style="flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 25px;">
                <!-- FILA 1: Gr√°ficos -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                    <!-- Progreso Acumulado -->
                    <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.25); border-radius: 15px; padding: 20px;">
                        <h3 style="color: white; margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center; gap: 10px;"><span style="color: #9b59b6;">üìà</span> Progreso Acumulado</h3>
                        <div style="height: 180px; position: relative;"><canvas id="progressChart" style="width: 100%; height: 100%;"></canvas></div>
                    </div>
                    <!-- Estado de Tareas -->
                    <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.25); border-radius: 15px; padding: 20px;">
                        <h3 style="color: white; margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center; gap: 10px;"><span style="color: #3498db;">üìä</span> Estado de Tareas</h3>
                        <div style="height: 180px; position: relative;"><canvas id="statusChart" style="width: 100%; height: 100%;"></canvas></div>
                    </div>
                    <!-- Burndown Chart -->
                    <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.25); border-radius: 15px; padding: 20px;">
                        <h3 style="color: white; margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center; gap: 10px;"><span style="color: #e74c3c;">üìä</span> Burndown Chart<div style="display: flex; align-items: center; gap: 5px; font-size: 11px; background: rgba(231,76,60,0.1); padding: 2px 8px; border-radius: 10px; margin-left: auto;"><span style="color: #e74c3c;">üî•</span><span style="color: #e74c3c;">Tareas Cr√≠ticas: ${getCriticalTasksCount()}</span>
</div></h3>
                        <div style="height: 180px; position: relative;"><canvas id="criticalChart" style="width: 100%; height: 100%;"></canvas></div>
                    </div>
                </div>
                <!-- FILA 2: Proyectos y Atrasadas -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.25); border-radius: 15px; padding: 20px;">
                        <h3 style="color: white; margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center; gap: 10px;"><span style="color: #2ecc71;">üìÇ</span> Proyectos Activos</h3>
                        <div style="max-height: 250px; overflow-y: auto;">${getProjectsListHTML()}</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.25); border-radius: 15px; padding: 20px;">
                        <h3 style="color: white; margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center; gap: 10px;"><span style="color: #f39c12;">‚è±Ô∏è</span> Tareas Atrasadas<span style="background: rgba(243,156,18,0.2); color: #f39c12; padding: 2px 10px; border-radius: 20px; font-size: 12px;">${getOverdueTasks()}</span></h3>
                        <div style="max-height: 250px; overflow-y: auto;">${getOverdueTasksHTML()}</div>
                    </div>
                </div>
                <!-- FILA 3: Alertas -->
                <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(148,163,184,0.25); border-radius: 15px; padding: 25px;">
                    <h3 style="color: white; margin: 0 0 20px 0; font-size: 18px; display: flex; align-items: center; gap: 10px;"><span style="color: #f39c12;">üö®</span> Alertas del Sistema<span style="background: rgba(243,156,18,0.2); color: #f39c12; padding: 4px 12px; border-radius: 20px; font-size: 14px;">${getAlertCount()} alertas</span></h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">${getAlertCardsHTML()}</div>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <div style="background: rgba(255,255,255,0.05); border-top: 1px solid rgba(255,255,255,0.1); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; color: #95a5a6; font-size: 13px; flex-shrink: 0;">
            <div>üåê Dashboard 4D Ejecutivo ‚Äì Sistema de Gesti√≥n de Proyectos</div>
            <div id="dashboardTimestamp">üïê Actualizado: ${new Date().toLocaleTimeString()}</div>
        </div>
    `;
}

function initDashboard4DCharts() {
    // Destruir instancias anteriores si existen
    ['progressChart', 'statusChart', 'criticalChart'].forEach(id => {
        const canvas = document.getElementById(id);
        if (canvas && window.Chart) {
            const chart = Chart.getChart(canvas);
            if (chart) chart.destroy();
        }
    });

    // Datos generales
    const allTasks = getAllTasks();
    const totalTasks = allTasks.length;
    const completed = allTasks.filter(t => t.status === 'completed').length;
    const inProgress = allTasks.filter(t => t.status === 'inProgress').length;
    const pending = allTasks.filter(t => t.status === 'pending').length;
    const overdue = allTasks.filter(t => t.status === 'overdue').length;

   // 1. Gr√°fico de Progreso Acumulado (CON DATOS REALES CORREGIDO)
const progressCtx = document.getElementById('progressChart').getContext('2d');

// Calcular progreso hist√≥rico basado en tareas - VERSI√ìN CORREGIDA
function calculateHistoricalProgress() {
    const allTasks = getAllTasks();
    const completedTasks = allTasks.filter(t => t.status === 'completed').length;
    const totalTasks = allTasks.length;
    const progressPct = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
    
    // Mostrar progreso gradual HACIA el progreso actual
    const last7Days = [];
    
    for (let i = 6; i >= 0; i--) {
        // Calcular qu√© porcentaje del progreso total deber√≠a haberse alcanzado
        // Asumiendo progreso lineal a lo largo del tiempo
        const dayRatio = (7 - i) / 7; // D√≠a 1: 1/7, D√≠a 7: 7/7 = 1
        
        // Si el progreso actual es mayor a 0, mostrar progreso gradual
        let dayProgress;
        if (progressPct > 0) {
            // Mostrar progreso que aumenta gradualmente hasta el actual
            dayProgress = Math.min(progressPct * dayRatio, progressPct);
        } else {
            // Si no hay progreso, mostrar 0
            dayProgress = 0;
        }
        
        // Asegurarse de que nunca sea mayor al progreso actual
        dayProgress = Math.min(dayProgress, progressPct);
        
        // Redondear para evitar decimales
        last7Days.push(Math.round(dayProgress));
    }
    
    return last7Days;
}

// Obtener nombres de los √∫ltimos 7 d√≠as
function getLast7Days() {
    const days = [];
    const today = new Date();
    const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
    
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(today.getDate() - i);
        days.push(dayNames[date.getDay()]);
    }
    return days;
}

// Crear gr√°fico con datos reales
new Chart(progressCtx, {
    type: 'line',
    data: {
        labels: getLast7Days(),
        datasets: [{
            label: 'Progreso Acumulado Real',
            data: calculateHistoricalProgress(),
            borderColor: '#9b59b6',
            backgroundColor: 'rgba(155, 89, 182, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#9b59b6',
            pointRadius: 5,
            pointHoverRadius: 8
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false },
            tooltip: {
                callbacks: {
                    title: ctx => `D√≠a: ${ctx[0].label}`,
                    label: ctx => `Progreso: ${ctx.parsed.y}%`
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: { callback: value => value + '%' }
            }
        }
    }
});

   // 2. Gr√°fico de Estado de Tareas CON LEYENDA HORIZONTAL
// ===============================
// ESTADO DE TAREAS ‚Äì DONUT AJUSTADO FINAL
// ===============================

const allTasksLocal = getAllTasks();

const total = allTasksLocal.length;
const pendingCount = allTasksLocal.filter(t => t.status === 'pending').length;
const progressCount = allTasksLocal.filter(t => t.status === 'inProgress').length;
const completedCount = allTasksLocal.filter(t => t.status === 'completed').length;
const overdueCount = allTasksLocal.filter(
    t => t.status === 'overdue' || t.status === 'retrasado' || t.status === 'rezagado'
).length;

const statusCtx = document.getElementById('statusChart').getContext('2d');

new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: ['Pendientes', 'En Progreso', 'Completadas', 'Retrasadas'],
        datasets: [{
            data: [
                pendingCount,
                progressCount,
                completedCount,
                overdueCount
            ],
            backgroundColor: [
                '#f1c40f',
                '#3498db',
                '#2ecc71',
                '#e74c3c'
            ],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '78%',
        layout: {
            padding: {
                bottom: 8
            }
        },
        plugins: {
            legend: {
                display: true,
                position: 'bottom',
                align: 'center',
                fullSize: true,
                labels: {
                    color: '#ffffff',
                    font: {
                        size: 9,          // üî• M√ÅS PEQUE√ëAS
                        weight: '400'
                    },
                    padding: 8,
                    boxWidth: 6,        // üî• C√çRCULOS M√ÅS CHICOS
                    boxHeight: 6,
                    usePointStyle: true,
                    pointStyle: 'circle'
                }
            },
            tooltip: {
                enabled: true,
                callbacks: {
                    label: ctx => {
                        const pct = total
                            ? Math.round((ctx.raw / total) * 100)
                            : 0;
                        return `${ctx.label}: ${ctx.raw} (${pct}%)`;
                    }
                }
            }
        }
    },
    plugins: [{
        id: 'centerNumber',
        afterDraw(chart) {
            const { ctx, chartArea } = chart;
            ctx.save();
            ctx.font = '700 30px Segoe UI'; // üî• N√öMERO M√ÅS GRANDE
            ctx.fillStyle = '#ffffff';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(
                total,
                (chartArea.left + chartArea.right) / 2,
                (chartArea.top + chartArea.bottom) / 2
            );
            ctx.restore();
        }
    }]
});

  // 3. Gr√°fico de Burndown (Cr√≠ticas)

// ===== DATOS REALES DE TAREAS CR√çTICAS =====
const criticalTasks = getAllTasks().filter(
    t => t.critical === true || t.priority === 'alta'
);

const totalCritical = criticalTasks.length;

// Agrupar por semanas (4 semanas)
const weeks = ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'];
const completedByWeek = [0, 0, 0, 0];

criticalTasks.forEach(task => {
    if (task.status === 'completed' && task.deadline) {
        const weekIndex = Math.min(
            Math.floor((new Date(task.deadline).getDate() - 1) / 7),
            3
        );
        completedByWeek[weekIndex]++;
    }
});

// Burndown real
let remaining = totalCritical;
const realBurndown = completedByWeek.map(done => {
    remaining -= done;
    return remaining < 0 ? 0 : remaining;
});

// L√≠nea ideal
const idealBurndown = weeks.map((_, i) =>
    Math.round(totalCritical - (totalCritical / (weeks.length - 1)) * i)
);

const criticalCtx = document
    .getElementById('criticalChart')
    .getContext('2d');

new Chart(criticalCtx, {
    type: 'line',
    data: {
        labels: weeks,
        datasets: [
            {
                label: 'Plan Ideal',
                data: idealBurndown,
                borderColor: 'rgba(255,255,255,0.3)',
                borderDash: [5, 5],
                borderWidth: 1,
                fill: false,
                pointRadius: 0
            },
            {
                label: 'Cr√≠ticas Reales',
                data: realBurndown,
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231,76,60,0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.3,
                pointRadius: 4
            }
        ]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: true },
            tooltip: {
                callbacks: {
                    label: ctx => `${ctx.parsed.y} tareas cr√≠ticas`
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: v => v + ' tareas'
                }
            }
        }
    }
});

// DEBUG (hover opcional)
console.log('Cr√≠ticas:', totalCritical);
console.log('Cr√≠ticas reales:', criticalTasks);
}


// Funciones auxiliares
function getCriticalTasksCount() {
    let count = 0;
    projects.forEach(p => {
        p.tasks.forEach(t => {
            if (t.critical || t.priority === 'alta') count++;
        });
    });
    return count;
}

function getTotalTasks() {
    let count = 0;
    projects.forEach(p => {
        count += p.tasks.length;
    });
    return count;
}

function getCompletedTasks() {
    let count = 0;
    projects.forEach(p => {
        p.tasks.forEach(t => {
            if (t.status === 'completed') count++;
        });
    });
    return count;
}

function getOverdueTasks() {
    let count = 0;
    projects.forEach(p => {
        p.tasks.forEach(t => {
            if (t.status === 'overdue') count++;
        });
    });
    return count;
}

function getOverallProgress() {
    let total = 0;
    let completed = 0;
    projects.forEach(p => {
        p.tasks.forEach(t => {
            total++;
            if (t.status === 'completed') completed++;
        });
    });
    return total > 0 ? Math.round((completed / total) * 100) : 0;
}

function getRiskLevel() {
    const total = getTotalTasks();
    const overdue = getOverdueTasks();
    const critical = getCriticalTasksCount();
    if (overdue === 0 && critical === 0) return '<span style="color:#2ecc71">BAJO</span>';
    if (overdue > total * 0.1 || critical > total * 0.2) return '<span style="color:#e74c3c">ALTO</span>';
    return '<span style="color:#f39c12">MEDIO</span>';
}

function getEfficiency() {
    const total = getTotalTasks();
    const completed = getCompletedTasks();
    return total > 0 ? Math.round((completed / total) * 100) : 0;
}

function getProjectsListHTML() {
    const sortedProjects = [...projects].sort((a, b) => {
        const aComp = a.tasks.filter(t => t.status === 'completed').length;
        const bComp = b.tasks.filter(t => t.status === 'completed').length;
        const aTotal = a.tasks.length;
        const bTotal = b.tasks.length;
        const aPct = aTotal ? (aComp / aTotal) * 100 : 0;
        const bPct = bTotal ? (bComp / bTotal) * 100 : 0;
        return bPct - aPct;
    });
    return `
        <div style="color:#3498db;font-size:12px;margin-bottom:10px;padding:0 5px;display:flex;justify-content:space-between;">
            <span>üìä Total: ${projects.length} proyectos</span>
        </div>
        <div style="max-height: 220px; overflow-y: auto; padding-right: 5px;">
        ${sortedProjects.slice(0, 8).map(p => {
            const tasks = p.tasks || [];
            const completed = tasks.filter(t => t.status === 'completed').length;
            const total = tasks.length;
            const progress = total ? Math.round((completed / total) * 100) : 0;
            const color = progress >= 75 ? '#2ecc71' : progress >= 50 ? '#f39c12' : '#e74c3c';
            const overdueTasks = tasks.filter(t => t.deadline && t.status !== 'completed' && new Date(t.deadline) < new Date()).length;
            return `
                <div style="background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;border-left:4px solid ${color};">
                    <div style="flex:1;">
                        <div style="color:white;font-weight:500;font-size:14px;margin-bottom:4px;">
                            ${p.name.substring(0,25)}${p.name.length > 25 ? '...' : ''}
                        </div>
                        <div style="display:flex;gap:15px;font-size:11px;">
                            <span style="color:#95a5a6;">üìù ${total} tareas</span>
                            <span style="color:#${overdueTasks > 0 ? 'e74c3c' : '95a5a6'};">‚è±Ô∏è ${overdueTasks} atrasadas</span>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div style="color:${color};font-weight:bold;font-size:16px;">${progress}%</div>
                        <div style="width:60px;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;margin-top:4px;">
                            <div style="width:${progress}%;height:100%;background:${color};border-radius:2px;"></div>
                        </div>
                    </div>
                </div>
            `;
        }).join('')}
        </div>
    `;
}

function getOverdueTasksHTML() {
    const overdueTasks = getAllTasks().filter(t => {
        if (!t.deadline || t.status === 'completed') return false;
        return new Date(t.deadline) < new Date();
    });
    const totalOverdue = overdueTasks.length;
    if (totalOverdue === 0) {
        return `<div style="text-align:center;color:#2ecc71;padding:20px;">‚úÖ Sin tareas atrasadas</div>`;
    }
    return `
        <div style="color:#f39c12;font-size:12px;margin-bottom:10px;padding:0 5px;">
            <span>üìã Total: ${totalOverdue} tareas</span>
        </div>
        <div style="max-height: 220px; overflow-y: auto; padding-right: 5px;">
        ${overdueTasks.slice(0, 10).map(t => `
            <div style="background:rgba(243,156,18,0.1);padding:10px;border-radius:6px;margin-bottom:8px;font-size:13px;border-left:3px solid #f39c12;">
                <div style="color:white;font-weight:bold;margin-bottom:5px;">
                    ${t.name.substring(0,40)}${t.name.length > 40 ? '...' : ''}
                </div>
                <div style="color:#f39c12;display:flex;justify-content:space-between;font-size:12px;">
                    <span>üìÇ ${t.projectName.substring(0,20)}${t.projectName.length > 20 ? '...' : ''}</span>
                    <span style="background:rgba(243,156,18,0.3);padding:2px 6px;border-radius:4px;font-size:11px;">
                        ${new Date(t.deadline).toLocaleDateString('es-ES', { day: '2-digit', month: 'short' })}
                    </span>
                </div>
                ${t.assignee ? `
                    <div style="color:#95a5a6;font-size:11px;margin-top:5px;">
                        üë§ ${t.assignee}
                    </div>
                ` : ''}
            </div>
        `).join('')}
        </div>
    `;
}

function getAlertCount() {
    let count = 0;
    if (projects.length === 0) count++;
    if (getAllTasks().some(t => !t.assignee || t.assignee === 'Sin asignar')) count++;
    if (getAllTasks().some(t => t.deadline && t.status !== 'completed' && new Date(t.deadline) < new Date())) count++;
    return count;
}

function getAlertCardsHTML() {
    const alerts = [];
    if (projects.length === 0) {
        alerts.push(`<div style="background:rgba(231,76,60,0.1);border:1px solid rgba(231,76,60,0.3);border-radius:12px;padding:20px;">
            <div style="display:flex;align-items:center;gap:15px;margin-bottom:15px;">
                <div style="width:50px;height:50px;background:rgba(231,76,60,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#e74c3c;">üìÇ</div>
                <div><div style="color:white;font-weight:bold;font-size:16px;">Sin proyectos</div></div>
            </div>
        </div>`);
    }
    const unassigned = getAllTasks().filter(t => !t.assignee || t.assignee === 'Sin asignar').length;
    if (unassigned > 0) {
        alerts.push(`<div style="background:rgba(243,156,18,0.1);border:1px solid rgba(243,156,18,0.3);border-radius:12px;padding:20px;">
            <div style="display:flex;align-items:center;gap:15px;margin-bottom:15px;">
                <div style="width:50px;height:50px;background:rgba(243,156,18,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#f39c12;">üë§</div>
                <div><div style="color:white;font-weight:bold;font-size:16px;">Tareas sin asignar</div><div style="color:#f39c12;font-size:32px;font-weight:bold;">${unassigned}</div></div>
            </div>
        </div>`);
    }
    if (getOverdueTasks() > 0) {
        alerts.push(`<div style="background:rgba(231,76,60,0.1);border:1px solid rgba(231,76,60,0.3);border-radius:12px;padding:20px;">
            <div style="display:flex;align-items:center;gap:15px;margin-bottom:15px;">
                <div style="width:50px;height:50px;background:rgba(231,76,60,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#e74c3c;">‚è±Ô∏è</div>
                <div><div style="color:white;font-weight:bold;font-size:16px;">Tareas atrasadas</div><div style="color:#e74c3c;font-size:32px;font-weight:bold;">${getOverdueTasks()}</div></div>
            </div>
        </div>`);
    }
    if (alerts.length === 0) {
        alerts.push(`<div style="background:rgba(46,204,113,0.1);border:1px solid rgba(46,204,113,0.3);border-radius:12px;padding:40px;text-align:center;grid-column:1/-1;">
            <div style="font-size:48px;color:#2ecc71;margin-bottom:20px;">‚úÖ</div>
            <h3 style="color:white;margin:0 0 15px 0;font-size:22px;">Sistema en estado √≥ptimo</h3>
            <p style="color:#95a5a6;font-size:16px;max-width:600px;margin:0 auto;">
                Todos los proyectos est√°n bajo control. ¬°Excelente trabajo!
            </p>
        </div>`);
    }
    return alerts.join('');
}

function getAllTasks() {
    const allTasks = [];
    projects.forEach(project => {
        const tasks = project.tasks || [];
        tasks.forEach(task => {
            allTasks.push({
                ...task,
                projectName: project.name || 'Proyecto'
            });
        });
    });
    return allTasks;
}

// Funciones de utilidad
window.refreshDashboard4D = function () {
    document.getElementById('dashboardTimestamp').innerHTML = 'üîÑ Actualizando...';
    setTimeout(() => {
        createGlobalDashboard4D();
    }, 500);
};

window.exportDashboard4DReport = function() {
    console.log('üì§ Exportando PDF ejecutivo...');
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Reporte Ejecutivo Dashboard 4D</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .header { text-align: center; margin-bottom: 40px; border-bottom: 3px solid #9b59b6; padding-bottom: 20px; }
                .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 30px 0; }
                .kpi-card { border: 1px solid #ddd; padding: 20px; border-radius: 10px; text-align: center; }
                .section { margin: 30px 0; padding: 20px; background: #f9f9f9; border-radius: 10px; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
                th { background: #9b59b6; color: white; }
                .footer { margin-top: 50px; text-align: center; color: #666; font-size: 12px; }
                @media print {
                    .no-print { display: none; }
                    body { margin: 20px; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1 style="color: #9b59b6;">Reporte Ejecutivo Dashboard 4D</h1>
                <p>Fecha: ${new Date().toLocaleDateString('es-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                })}</p>
                <p>Generado autom√°ticamente por el sistema de gesti√≥n</p>
            </div>
            <div class="kpi-grid">
                <div class="kpi-card">
                    <h3>${projects.length}</h3>
                    <p>Proyectos Activos</p>
                </div>
                <div class="kpi-card">
                    <h3>${getTotalTasks()}</h3>
                    <p>Tareas Totales</p>
                </div>
                <div class="kpi-card">
                    <h3>${getOverallProgress()}%</h3>
                    <p>Progreso Global</p>
                </div>
                <div class="kpi-card">
                    <h3>${getOverdueTasks()}</h3>
                    <p>Tareas Atrasadas</p>
                </div>
            </div>
            <div class="section">
                <h2>üìä Estado de Tareas</h2>
                <table>
                    <tr>
                        <th>Estado</th>
                        <th>Cantidad</th>
                        <th>Porcentaje</th>
                    </tr>
                    <tr>
                        <td>‚úÖ Completadas</td>
                        <td>${getCompletedTasks()}</td>
                        <td>${getTotalTasks() > 0 ? Math.round((getCompletedTasks()/getTotalTasks())*100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>üîÑ En Progreso</td>
                        <td>${getAllTasks().filter(t => t.status === 'inProgress').length}</td>
                        <td>${getTotalTasks() > 0 ? Math.round((getAllTasks().filter(t => t.status === 'inProgress').length/getTotalTasks())*100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>‚è≥ Pendientes</td>
                        <td>${getAllTasks().filter(t => t.status === 'pending').length}</td>
                        <td>${getTotalTasks() > 0 ? Math.round((getAllTasks().filter(t => t.status === 'pending').length/getTotalTasks())*100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>‚ö†Ô∏è Atrasadas</td>
                        <td>${getOverdueTasks()}</td>
                        <td>${getTotalTasks() > 0 ? Math.round((getOverdueTasks()/getTotalTasks())*100) : 0}%</td>
                    </tr>
                </table>
            </div>
            <div class="section">
                <h2>üìã Resumen Ejecutivo</h2>
                <p>El sistema actual presenta un progreso global del <strong>${getOverallProgress()}%</strong>.</p>
                <p>${getOverdueTasks() > 0 ?
                    `‚ö†Ô∏è Se requiere atenci√≥n en ${getOverdueTasks()} tareas atrasadas.` :
                    '‚úÖ Todas las tareas est√°n al d√≠a.'}</p>
                <p>${getOverallProgress() >= 80 ?
                    'üéØ Excelente rendimiento, se superan los objetivos establecidos.' :
                    getOverallProgress() >= 60 ?
                    'üìä Rendimiento aceptable, se recomienda seguimiento continuo.' :
                    'üî¥ Se requiere revisi√≥n estrat√©gica para mejorar el progreso.'}</p>
            </div>
            <div class="footer">
                <p>Reporte generado por Dashboard 4D Ejecutivo</p>
                <p>Documento para uso interno - ${new Date().getFullYear()}</p>
            </div>
            <div class="no-print" style="margin-top: 30px; text-align: center;">
                <button onclick="window.print()" style="
                    background: #9b59b6;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 16px;
                ">
                    üñ®Ô∏è Imprimir Reporte
                </button>
                <button onclick="window.close()" style="
                    background: #95a5a6;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 16px;
                    margin-left: 10px;
                ">
                    ‚úï Cerrar
                </button>
            </div>
            <script>
                // Abrir di√°logo de impresi√≥n autom√°ticamente
                setTimeout(() => {
                    window.print();
                }, 500);
            </script>
        </body>
        </html>
    `;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
};

window.closeDashboard4D = function () {
    const container = document.getElementById('mainAppContainer');
    if (container) {
        container.remove();
        console.log('‚úÖ Dashboard eliminado');
    }
    // Restaurar la vista de proyectos
    if (typeof renderProjects === 'function') {
        setTimeout(() => {
            renderProjects();
        }, 100);
    }
};

function createGlobalDashboard4D() {
    window.showDashboard4DView();
}

// Alias para compatibilidad
function showDashboard4DView() {
    window.showDashboard4DView();
}
